<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>é£˜é€¸å³°çš„åšå®¢</title>
  
  <subtitle>Spring--Javaç¨‹åºå‘˜çš„æ˜¥å¤©</subtitle>
  <link href="https://blog.hanqunfeng.com/atom.xml" rel="self"/>
  
  <link href="https://blog.hanqunfeng.com/"/>
  <updated>2025-06-12T03:19:18.357Z</updated>
  <id>https://blog.hanqunfeng.com/</id>
  
  <author>
    <name>é£˜é€¸å³°</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Docker Swarm ä¹‹ Config ä¸  Secret</title>
    <link href="https://blog.hanqunfeng.com/2025/06/12/docker-swarm-config-secret/"/>
    <id>https://blog.hanqunfeng.com/2025/06/12/docker-swarm-config-secret/</id>
    <published>2025-06-12T14:30:05.000Z</published>
    <updated>2025-06-12T03:19:18.357Z</updated>
    
    <content type="html"><![CDATA[<!-- **åŠ ç²—** *æ–œä½“* ***åŠ ç²—å¹¶æ–œä½“*** ~~åˆ é™¤çº¿~~ ==çªå‡ºæ˜¾ç¤º== `çªå‡ºæ˜¾ç¤º(æ¨è)` ++ä¸‹åˆ’çº¿++ ~ä¸‹æ ‡~ ^ä¸Šæ ‡^ è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference. å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **ç‚¹å‡»æŠ˜å ** è¿™æ˜¯è¢«éšè—çš„å†…å®¹ +++::: tips success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹:::% note info % success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹% endnote %å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{} å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ --><h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2"><p>æœ¬æ–‡ä»‹ç» Docker Swarm ä¸­çš„ Config ä¸  Secret</p></li><li class="lvl-2"><p><a href="https://docs.docker.com">Dockerå®˜æ–¹æ–‡æ¡£</a></p></li><li class="lvl-2"><p><a href="https://docs.docker.com/engine/swarm/">Docker Swarm å®˜æ–¹æ–‡æ¡£</a></p></li><li class="lvl-2"><p><a href="https://docs.docker.com/reference/compose-file/">Compose file reference</a></p></li></ul><span id="more"></span><h2 id="Config-ç®€ä»‹">Config ç®€ä»‹</h2><ul class="lvl-0"><li class="lvl-2"><p>åœ¨ Docker Swarm ä¸­ï¼ŒConfig æ˜¯ä¸€ç§ç”¨äºç®¡ç†é…ç½®èµ„æºçš„æœºåˆ¶ï¼Œå…è®¸ä½ å°†é…ç½®æ–‡ä»¶ä¸å®¹å™¨åˆ†ç¦»ï¼Œä¾¿äºåœ¨ä¸åŒç¯å¢ƒä¸­é‡ç”¨å’Œå…±äº«é…ç½®ã€‚</p></li><li class="lvl-2"><p>Config å’Œ Volume éƒ½æ˜¯ Docker ä¸­ç”¨äºç®¡ç†æ•°æ®çš„æœºåˆ¶ï¼Œä½†å®ƒä»¬çš„è®¾è®¡ç›®çš„å’Œä½¿ç”¨åœºæ™¯æœ‰æ˜¾è‘—ä¸åŒï¼š</p></li></ul><table><thead><tr><th>ç‰¹æ€§</th><th>Config</th><th>Volume</th></tr></thead><tbody><tr><td>ç”¨é€”</td><td>åªèƒ½æ˜¯æ–‡ä»¶ï¼Œç”¨äºå­˜å‚¨é…ç½®æ–‡ä»¶ã€åªè¯»æ•°æ®</td><td>æ–‡ä»¶ç›®å½•å‡å¯ï¼Œå­˜å‚¨åº”ç”¨æ•°æ®ã€å¯è¯»å†™æ•°æ®</td></tr><tr><td>å¯å˜æ€§</td><td>é€šå¸¸ä¸å¯å˜ï¼ˆåªè¯»ï¼‰</td><td>å¯å˜ï¼ˆè¯»å†™ï¼‰</td></tr><tr><td>ç”Ÿå‘½å‘¨æœŸ</td><td>éšæœåŠ¡éƒ¨ç½²æ›´æ–°</td><td>ç‹¬ç«‹äºå®¹å™¨ç”Ÿå‘½å‘¨æœŸ</td></tr><tr><td>å­˜å‚¨ä½ç½®</td><td>å­˜å‚¨åœ¨Dockerç®¡ç†çš„å†…å­˜/æ–‡ä»¶ç³»ç»Ÿ</td><td>å­˜å‚¨åœ¨ä¸»æœºæ–‡ä»¶ç³»ç»Ÿæˆ–ç½‘ç»œå­˜å‚¨</td></tr><tr><td>Swarmæ”¯æŒ</td><td>åŸç”ŸSwarmåŠŸèƒ½</td><td>é€šç”¨åŠŸèƒ½</td></tr><tr><td>æ›´æ–°æœºåˆ¶</td><td>æ›´æ–°éœ€è¦é‡æ–°éƒ¨ç½²æœåŠ¡</td><td>å¯åŠ¨æ€æ›´æ–°</td></tr><tr><td>å…¸å‹ç”¨ä¾‹</td><td>é…ç½®æ–‡ä»¶ã€ç¯å¢ƒå˜é‡</td><td>æ•°æ®åº“æ–‡ä»¶ã€æ—¥å¿—ã€ç”¨æˆ·ä¸Šä¼ å†…å®¹</td></tr></tbody></table><h3 id="Config-å‘½ä»¤">Config å‘½ä»¤</h3><table><thead><tr><th>å‘½ä»¤</th><th>ä¸­æ–‡è¯´æ˜</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td><code>create</code></td><td>ä»æ–‡ä»¶æˆ–æ ‡å‡†è¾“å…¥åˆ›å»ºä¸€ä¸ª config</td><td><code>docker config create my_config config.txt</code></td></tr><tr><td><code>inspect</code></td><td>æ˜¾ç¤ºä¸€ä¸ªæˆ–å¤šä¸ª config çš„è¯¦ç»†ä¿¡æ¯</td><td><code>docker config inspect my_config</code></td></tr><tr><td><code>ls</code></td><td>åˆ—å‡ºæ‰€æœ‰ configs</td><td><code>docker config ls</code></td></tr><tr><td><code>rm</code></td><td>åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ª config</td><td><code>docker config rm my_config</code></td></tr></tbody></table><h4 id="docker-config-create-åˆ›å»ºä¸€ä¸ª-config"><code>docker config create</code>:  åˆ›å»ºä¸€ä¸ª config</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»æ–‡ä»¶ä¸­åˆ›å»º</span></span><br><span class="line">docker config create my_config my_config.json</span><br><span class="line"><span class="comment"># ä»æ ‡å‡†è¾“å…¥åˆ›å»º</span></span><br><span class="line"><span class="built_in">cat</span> my_config.json | docker config create my_config -</span><br></pre></td></tr></table></figure><h4 id="docker-config-inspect-æŸ¥çœ‹-config-çš„ä¿¡æ¯"><code>docker config inspect</code>:  æŸ¥çœ‹ config çš„ä¿¡æ¯</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">docker config inspect my_config</span><br><span class="line"><span class="comment">## è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ° Data å­—æ®µï¼Œç”¨ base64 è§£ç åï¼Œå°±æ˜¯ config çš„åŸå§‹å†…å®¹</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;ID&quot;</span>: <span class="string">&quot;q4257t5c2wq6uvvkm4g3hssae&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Version&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Index&quot;</span>: 3145</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;CreatedAt&quot;</span>: <span class="string">&quot;2025-06-10T06:09:25.712614071Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;UpdatedAt&quot;</span>: <span class="string">&quot;2025-06-10T06:09:25.712614071Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Spec&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;my_config&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Labels&quot;</span>: &#123;&#125;,</span><br><span class="line">            <span class="string">&quot;Data&quot;</span>: <span class="string">&quot;WwogICAgewogICAgICAgICJJRCI6ICJxbGtsc2t2eHRocDYxaTBuYnZ6dnI2d3V3IiwKICAgICAgICAiVmVyc2lvbiI6IHsKICAgICAgICAgICAgIkluZGV4IjogMzE0NAogICAgICAgIH0sCiAgICAgICAgIkNyZWF0ZWRBdCI6ICIyMDI1LTA2LTEwVDA2OjA3OjAzLjQwMzg4OTU2NVoiLAogICAgICAgICJVcGRhdGVkQXQiOiAiMjAyNS0wNi0xMFQwNjowNzowMy40MDM4ODk1NjVaIiwKICAgICAgICAiU3BlYyI6IHsKICAgICAgICAgICAgIk5hbWUiOiAibXlfc2VjcmV0IiwKICAgICAgICAgICAgIkxhYmVscyI6IHt9CiAgICAgICAgfQogICAgfQpdCg==&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"><span class="comment"># è§£ç </span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;WwogICAgewogICAgICAgICJJRCI6ICJxbGtsc2t2eHRocDYxaTBuYnZ6dnI2d3V3IiwKICAgICAgICAiVmVyc2lvbiI6IHsKICAgICAgICAgICAgIkluZGV4IjogMzE0NAogICAgICAgIH0sCiAgICAgICAgIkNyZWF0ZWRBdCI6ICIyMDI1LTA2LTEwVDA2OjA3OjAzLjQwMzg4OTU2NVoiLAogICAgICAgICJVcGRhdGVkQXQiOiAiMjAyNS0wNi0xMFQwNjowNzowMy40MDM4ODk1NjVaIiwKICAgICAgICAiU3BlYyI6IHsKICAgICAgICAgICAgIk5hbWUiOiAibXlfc2VjcmV0IiwKICAgICAgICAgICAgIkxhYmVscyI6IHt9CiAgICAgICAgfQogICAgfQpdCg==&quot;</span> | <span class="built_in">base64</span> -d</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›´æ˜“è¯»</span></span><br><span class="line">docker config inspect --pretty my_config</span><br><span class="line">docker config inspect --format <span class="string">&quot;&#123;&#123;.ID&#125;&#125; &#123;&#123;.Spec.Name&#125;&#125;&quot;</span> my_config</span><br></pre></td></tr></table></figure><h4 id="docker-config-ls-åˆ—å‡ºæ‰€æœ‰-config"><code>docker config ls</code>:  åˆ—å‡ºæ‰€æœ‰ config</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker config <span class="built_in">ls</span></span><br><span class="line"><span class="comment">#  åªæ˜¾ç¤º ID</span></span><br><span class="line">docker config <span class="built_in">ls</span> -q</span><br></pre></td></tr></table></figure><h4 id="docker-config-rm-åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ª-config"><code>docker config rm</code>:  åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ª config</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker config <span class="built_in">rm</span> my_config</span><br><span class="line"><span class="comment"># åˆ é™¤å¤šä¸ª</span></span><br><span class="line">docker config <span class="built_in">rm</span> my_config1 my_config2</span><br><span class="line"><span class="comment"># åˆ é™¤æ‰€æœ‰ ï¼Œæ…é‡ä½¿ç”¨</span></span><br><span class="line">docker config <span class="built_in">rm</span> $(docker config <span class="built_in">ls</span> -q)</span><br></pre></td></tr></table></figure><h3 id="Stackä¸­ä½¿ç”¨Config">Stackä¸­ä½¿ç”¨Config</h3><ul class="lvl-0"><li class="lvl-2"><p><a href="https://docs.docker.com/reference/compose-file/configs/">Configs top-level elements</a></p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">configs:</span> <span class="comment">#  å£°æ˜ config åˆ—è¡¨</span></span><br><span class="line">  <span class="attr">nginx_config:</span>  <span class="comment">#  config åç§°</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">./nginx/nginx.conf</span> <span class="comment">#  config æ–‡ä»¶</span></span><br><span class="line">  <span class="attr">my_config:</span> <span class="comment">#  ä½¿ç”¨å¤–éƒ¨ configï¼Œå³ docker config create åˆ›å»ºçš„</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">    <span class="attr">configs:</span> <span class="comment"># æœåŠ¡ä½¿ç”¨ config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source:</span> <span class="string">nginx_config</span> <span class="comment"># æŒ‡å®š config åç§°</span></span><br><span class="line">        <span class="attr">target:</span> <span class="string">/etc/nginx/nginx.conf</span> <span class="comment"># æŒ‡å®šå®¹å™¨ä¸­é…ç½®æ–‡ä»¶å­˜æ”¾ä½ç½®</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source:</span> <span class="string">my_config</span>  <span class="comment">#  ä½¿ç”¨å¤–éƒ¨ config</span></span><br><span class="line">        <span class="attr">target:</span> <span class="string">/app/config.json</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0444</span> <span class="comment">#  æŒ‡å®šæƒé™</span></span><br><span class="line">        <span class="attr">uid:</span> <span class="string">&quot;1000&quot;</span> <span class="comment"># æŒ‡å®šç”¨æˆ·</span></span><br><span class="line">        <span class="attr">gid:</span> <span class="string">&quot;1000&quot;</span> <span class="comment"># æŒ‡å®šç”¨æˆ·ç»„</span></span><br></pre></td></tr></table></figure><h2 id="Secret-ç®€ä»‹">Secret ç®€ä»‹</h2><ul class="lvl-0"><li class="lvl-2"><p>Secrets æ˜¯ Docker ä¸“é—¨ä¸ºæ•æ„Ÿæ•°æ®è®¾è®¡çš„å®‰å…¨ç®¡ç†æœºåˆ¶ï¼Œç”¨äºå®‰å…¨åœ°å­˜å‚¨å’Œä¼ è¾“å¯†ç ã€APIå¯†é’¥ã€TLSè¯ä¹¦ç­‰æ•æ„Ÿä¿¡æ¯ã€‚</p></li><li class="lvl-2"><p>ä¸ Configs çš„ä¸»è¦åŒºåˆ«</p></li></ul><table><thead><tr><th>ç‰¹æ€§</th><th>Secrets</th><th>Configs</th></tr></thead><tbody><tr><td>ç”¨é€”</td><td>æ•æ„Ÿæ•°æ®ï¼ˆå¯†ç ã€å¯†é’¥ç­‰ï¼‰</td><td>æ™®é€šé…ç½®æ–‡ä»¶</td></tr><tr><td>å­˜å‚¨</td><td>åŠ å¯†å­˜å‚¨</td><td>æ˜æ–‡å­˜å‚¨</td></tr><tr><td>ä¼ è¾“</td><td>åŠ å¯†ä¼ è¾“</td><td>æ˜æ–‡ä¼ è¾“</td></tr><tr><td>è®¿é—®</td><td>æŒ‚è½½ä¸ºå†…å­˜æ–‡ä»¶</td><td>å¸¸è§„æ–‡ä»¶æŒ‚è½½</td></tr><tr><td>æƒé™</td><td>é»˜è®¤ä»… root å¯è¯»ï¼ˆ0440ï¼‰</td><td>å¯è‡ªå®šä¹‰æƒé™</td></tr></tbody></table><h3 id="Secret-å‘½ä»¤">Secret å‘½ä»¤</h3><table><thead><tr><th>å‘½ä»¤</th><th>ä¸­æ–‡è¯´æ˜</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td><code>create</code></td><td>ä»æ–‡ä»¶æˆ–æ ‡å‡†è¾“å…¥åˆ›å»ºä¸€ä¸ª secret</td><td><code>docker secret create my_secret secret.txt</code></td></tr><tr><td><code>inspect</code></td><td>æ˜¾ç¤ºä¸€ä¸ªæˆ–å¤šä¸ª secret çš„è¯¦ç»†ä¿¡æ¯</td><td><code>docker secret inspect my_secret</code></td></tr><tr><td><code>ls</code></td><td>åˆ—å‡ºæ‰€æœ‰ secrets</td><td><code>docker secret ls</code></td></tr><tr><td><code>rm</code></td><td>åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ª secret</td><td><code>docker secret rm my_secret</code></td></tr></tbody></table><h4 id="docker-secret-create-åˆ›å»ºä¸€ä¸ª-secret"><code>docker secret create</code>:  åˆ›å»ºä¸€ä¸ª secret</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»æ–‡ä»¶ä¸­åˆ›å»º</span></span><br><span class="line">docker secret create my_secret my_secret.txt</span><br><span class="line"><span class="comment"># ä»æ ‡å‡†è¾“å…¥åˆ›å»º</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;my_secret&quot;</span> | docker secret create my_secret -</span><br></pre></td></tr></table></figure><h4 id="docker-secret-inspect-æŸ¥çœ‹-secret-çš„ä¿¡æ¯"><code>docker secret inspect</code>:  æŸ¥çœ‹ secret çš„ä¿¡æ¯</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">docker secret inspect my_secret</span><br><span class="line"><span class="comment">## è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ° æ²¡æœ‰ data å­—æ®µï¼Œæ‰€ä»¥æ— æ³•æŸ¥çœ‹åŸå§‹çš„å†…å®¹</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;ID&quot;</span>: <span class="string">&quot;qlklskvxthp61i0nbvzvr6wuw&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Version&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Index&quot;</span>: 3144</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;CreatedAt&quot;</span>: <span class="string">&quot;2025-06-10T06:07:03.403889565Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;UpdatedAt&quot;</span>: <span class="string">&quot;2025-06-10T06:07:03.403889565Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Spec&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;my_secret&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Labels&quot;</span>: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"><span class="comment"># è¾“å‡ºæ›´æ˜“è¯»</span></span><br><span class="line">docker secret inspect --pretty my_secret</span><br><span class="line">docker secret inspect --format <span class="string">&quot;&#123;&#123;.ID&#125;&#125; &#123;&#123;.Spec.Name&#125;&#125;&quot;</span> my_secret</span><br></pre></td></tr></table></figure><h4 id="docker-secret-ls-åˆ—å‡ºæ‰€æœ‰çš„-secret"><code>docker secret ls</code>:  åˆ—å‡ºæ‰€æœ‰çš„ secret</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker secret <span class="built_in">ls</span></span><br><span class="line"><span class="comment"># åˆ—å‡ºæ‰€æœ‰çš„ secret çš„ ID</span></span><br><span class="line">docker secret <span class="built_in">ls</span> -q</span><br><span class="line">docker secret <span class="built_in">ls</span> --filter name=my_secret</span><br></pre></td></tr></table></figure><h4 id="docker-secret-rm-åˆ é™¤-secret"><code>docker secret rm</code>:  åˆ é™¤ secret</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker secret <span class="built_in">rm</span> my_secret</span><br><span class="line"><span class="comment"># åˆ é™¤æ‰€æœ‰ï¼Œæ…é‡ä½¿ç”¨</span></span><br><span class="line">docker secret <span class="built_in">rm</span> $(docker secret <span class="built_in">ls</span> -q)</span><br></pre></td></tr></table></figure><h3 id="Stackä¸­ä½¿ç”¨Secret">Stackä¸­ä½¿ç”¨Secret</h3><ul class="lvl-0"><li class="lvl-2"><p><a href="https://docs.docker.com/reference/compose-file/secrets/">Secrets top-level elements</a></p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:8.0</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD_FILE:</span> <span class="string">/run/secrets/db_root_password</span></span><br><span class="line">    <span class="attr">secrets:</span> <span class="comment"># å…³è”secretï¼Œå®¹å™¨å†…å…³è”è·¯å¾„ä¸º /run/secrets/&lt;secret_name&gt;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db_root_password</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">my_secret</span></span><br><span class="line"></span><br><span class="line"><span class="attr">secrets:</span> <span class="comment"># å£°æ˜ secret åˆ—è¡¨</span></span><br><span class="line">  <span class="attr">db_root_password:</span> <span class="comment">#  secret åç§°</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">./mysql_root_password.txt</span> <span class="comment">#  secret æ–‡ä»¶</span></span><br><span class="line">  <span class="attr">my_secret:</span> <span class="comment"># ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨é¢„åˆ›å»ºçš„secret</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span>  <span class="comment"># å¼•ç”¨é¢„å…ˆåˆ›å»ºçš„secret</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ä¼˜åŒ–: ä½¿ç”¨érootç”¨æˆ·ï¼Œå¹¶éšè— secret æ–‡ä»¶</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:8.0</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">&quot;mysql:mysql&quot;</span>  <span class="comment"># å…³é”®ç‚¹1ï¼šä½¿ç”¨érootç”¨æˆ·</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD_FILE:</span> <span class="string">/run/secrets/.db_root_password</span>  <span class="comment"># å…³é”®ç‚¹2ï¼šéšè—æ–‡ä»¶</span></span><br><span class="line">    <span class="attr">secrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source:</span> <span class="string">db_root_password</span></span><br><span class="line">        <span class="attr">target:</span> <span class="string">.db_root_password</span>  <span class="comment"># éšè—æ–‡ä»¶å</span></span><br><span class="line">        <span class="attr">uid:</span> <span class="string">&quot;999&quot;</span>  <span class="comment"># mysqlç”¨æˆ·ID</span></span><br><span class="line">        <span class="attr">gid:</span> <span class="string">&quot;999&quot;</span>  <span class="comment"># mysqlç»„ID</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0400</span>  <span class="comment"># ä»…æ‹¥æœ‰è€…å¯è¯»</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source:</span> <span class="string">my_secret</span></span><br><span class="line">        <span class="attr">target:</span> <span class="string">.my_secret</span></span><br><span class="line">        <span class="attr">uid:</span> <span class="string">&quot;999&quot;</span></span><br><span class="line">        <span class="attr">gid:</span> <span class="string">&quot;999&quot;</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0400</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">secrets:</span></span><br><span class="line">  <span class="attr">db_root_password:</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">./mysql_root_password.txt</span></span><br><span class="line">  <span class="attr">my_secret:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **åŠ ç²—**
 *æ–œä½“*
 ***åŠ ç²—å¹¶æ–œä½“***
 ~~åˆ é™¤çº¿~~
 ==çªå‡ºæ˜¾ç¤º==
 `çªå‡ºæ˜¾ç¤º(æ¨è)`
 ++ä¸‹åˆ’çº¿++
 ~ä¸‹æ ‡~
 ^ä¸Šæ ‡^
 è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.
 å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **ç‚¹å‡»æŠ˜å **
 è¿™æ˜¯è¢«éšè—çš„å†…å®¹
 +++

::: tips success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
:::

% note info % success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
% endnote %

å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}
 å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ
 --&gt;
&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;æœ¬æ–‡ä»‹ç» Docker Swarm ä¸­çš„ Config ä¸  Secret&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com&quot;&gt;Dockerå®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com/engine/swarm/&quot;&gt;Docker Swarm å®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com/reference/compose-file/&quot;&gt;Compose file reference&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/docker/"/>
    
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>Docker Swarm ä¹‹ æ ˆ(Stack)</title>
    <link href="https://blog.hanqunfeng.com/2025/06/11/docker-swarm-stack/"/>
    <id>https://blog.hanqunfeng.com/2025/06/11/docker-swarm-stack/</id>
    <published>2025-06-11T14:30:05.000Z</published>
    <updated>2025-06-12T07:25:38.731Z</updated>
    
    <content type="html"><![CDATA[<!-- **åŠ ç²—** *æ–œä½“* ***åŠ ç²—å¹¶æ–œä½“*** ~~åˆ é™¤çº¿~~ ==çªå‡ºæ˜¾ç¤º== `çªå‡ºæ˜¾ç¤º(æ¨è)` ++ä¸‹åˆ’çº¿++ ~ä¸‹æ ‡~ ^ä¸Šæ ‡^ è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference. å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **ç‚¹å‡»æŠ˜å ** è¿™æ˜¯è¢«éšè—çš„å†…å®¹ +++::: tips success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹:::% note info % success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹% endnote %å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{} å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ --><h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2"><p>æœ¬æ–‡ä»‹ç» Docker Swarm çš„ æ ˆç®¡ç†</p></li><li class="lvl-2"><p><a href="https://docs.docker.com">Dockerå®˜æ–¹æ–‡æ¡£</a></p></li><li class="lvl-2"><p><a href="https://docs.docker.com/engine/swarm/">Docker Swarm å®˜æ–¹æ–‡æ¡£</a></p></li><li class="lvl-2"><p><a href="https://docs.docker.com/reference/compose-file/">Compose file reference</a></p></li></ul><span id="more"></span><h2 id="Stackç®€ä»‹">Stackç®€ä»‹</h2><ul class="lvl-0"><li class="lvl-2"><p>å‰é¢æˆ‘ä»¬åœ¨Swarmä¸­åˆ›å»ºæœåŠ¡éƒ½æ˜¯é€šè¿‡Serviceï¼Œæ¯æ¬¡åˆ›å»ºä¸€ä¸ªï¼Œæœ‰æ²¡æœ‰ç±»ä¼¼<code>docker compose</code>çš„æ–¹å¼æ¥åˆ›å»ºå¤šä¸ªæœåŠ¡å‘¢ï¼ŸDocker Swarmä¸ºæˆ‘ä»¬æä¾›äº†Stack</p></li><li class="lvl-2"><p>åœ¨ Docker Swarm ä¸­ï¼ŒStackï¼ˆæ ˆï¼‰ æ˜¯ç”¨æ¥å®šä¹‰å’Œéƒ¨ç½²ä¸€ç»„ç›¸å…³æœåŠ¡çš„é›†åˆã€‚ä½ å¯ä»¥æŠŠå®ƒçœ‹æˆæ˜¯ä¸€ä¸ªåº”ç”¨çš„æ•´ä½“ï¼Œç”±å¤šä¸ªæœåŠ¡ï¼ˆserviceï¼‰ã€ç½‘ç»œï¼ˆnetworkï¼‰ã€å·ï¼ˆvolumeï¼‰ç­‰ç»„æˆã€‚</p></li></ul><h2 id="Stack-é€šå¸¸ç”¨-Docker-Compose-æ–‡ä»¶ï¼ˆYAML-æ ¼å¼ï¼‰-æè¿°">Stack é€šå¸¸ç”¨ Docker Compose æ–‡ä»¶ï¼ˆYAML æ ¼å¼ï¼‰ æè¿°</h2><ul class="lvl-0"><li class="lvl-2"><p>Stack å®Œå…¨å…¼å®¹ Docker Compose æ–‡ä»¶ï¼Œå¹¶å¯ä»¥åœ¨ compose æ–‡ä»¶ä¸­å£°æ˜å‰¯æœ¬é›†ç­‰ä¸Serviceç›¸å…³çš„é…ç½®é¡¹ã€‚</p></li><li class="lvl-2"><p>æˆ‘ç”¨è¡¨æ ¼æ€»ç»“ä¸€ä¸‹äºŒè€…çš„å·®å¼‚ï¼Œé‡ç‚¹æ”¾åœ¨ã€ŒStack æ”¯æŒçš„é…ç½®ã€ä¸Šï¼š</p></li></ul><table><thead><tr><th>é…ç½®é¡¹</th><th>Docker Compose (æœ¬åœ°)</th><th>Docker Stack (Swarm é›†ç¾¤)</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>name</code></td><td>âœ…</td><td>âŒ</td><td>Stack ä¸æ”¯æŒ name  å±æ€§</td></tr><tr><td><code>build</code></td><td>âœ…</td><td>âŒ</td><td>Stack ä¸æ”¯æŒ build å±æ€§ï¼Œåªèƒ½ä½¿ç”¨image</td></tr><tr><td><code>deploy</code></td><td>âŒï¼ˆéƒ¨åˆ†æ”¯æŒï¼Œé€šå¸¸è¢«å¿½ç•¥ï¼‰</td><td>âœ…ï¼ˆæ ¸å¿ƒæ”¯æŒï¼‰</td><td>Stack æ”¯æŒç”¨ <code>deploy</code> å®šä¹‰å‰¯æœ¬æ•°ã€èµ„æºé™åˆ¶ã€æ›´æ–°ç­–ç•¥ç­‰</td></tr><tr><td><code>deploy.replicas</code></td><td>âŒ</td><td>âœ…</td><td>å®šä¹‰æœåŠ¡å‰¯æœ¬æ•°</td></tr><tr><td><code>deploy.resources</code></td><td>âŒ</td><td>âœ…</td><td>å®šä¹‰ CPUã€å†…å­˜é™åˆ¶</td></tr><tr><td><code>deploy.placement</code></td><td>âŒ</td><td>âœ…</td><td>å®šä¹‰æœåŠ¡è°ƒåº¦ç­–ç•¥ï¼ˆåœ¨å“ªäº›èŠ‚ç‚¹ä¸Šè¿è¡Œï¼‰</td></tr><tr><td><code>deploy.update_config</code></td><td>âŒ</td><td>âœ…</td><td>å®šä¹‰æ»šåŠ¨æ›´æ–°çš„å‚æ•°</td></tr><tr><td><code>deploy.restart_policy</code></td><td>âŒ</td><td>âœ…</td><td>å®šä¹‰é‡å¯ç­–ç•¥</td></tr><tr><td><code>deploy.mode</code></td><td>âŒ</td><td>âœ…</td><td><code>replicated</code> æˆ– <code>global</code></td></tr><tr><td><code>depends_on</code></td><td>âœ…</td><td>ğŸš«ï¼ˆè¢«å¿½ç•¥ï¼‰</td><td>Stack ä¸æ”¯æŒå®¹å™¨å¯åŠ¨é¡ºåºæ§åˆ¶</td></tr><tr><td><code>build</code></td><td>âœ…</td><td>ğŸš«ï¼ˆè¢«å¿½ç•¥ï¼‰</td><td>Stack ä¸æ”¯æŒç›´æ¥æ„å»ºé•œåƒï¼Œåªèƒ½ç”¨å·²å­˜åœ¨çš„é•œåƒ</td></tr><tr><td><code>network.external</code></td><td>âœ…</td><td>âœ…</td><td>éƒ½æ”¯æŒå¤–éƒ¨ç½‘ç»œ</td></tr><tr><td><code>volumes.external</code></td><td>âœ…</td><td>âœ…</td><td>éƒ½æ”¯æŒå¤–éƒ¨å·</td></tr><tr><td><code>configs</code></td><td>ğŸš«</td><td>âœ…</td><td>Stack æ”¯æŒ Config å¯¹è±¡ï¼Œé€‚åˆé…ç½®æ–‡ä»¶ç®¡ç†</td></tr><tr><td><code>secrets</code></td><td>ğŸš«</td><td>âœ…</td><td>Stack æ”¯æŒ Secretsï¼Œç”¨äºå®‰å…¨å­˜å‚¨æ•æ„Ÿä¿¡æ¯</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>ä»¥<a href="https://docs.portainer.io/">Portainer:Dockerå¯è§†åŒ–ç®¡ç†å·¥å…·</a>çš„stacké…ç½®æ–‡ä»¶ä¸ºä¾‹</p></li></ul><blockquote><p>Portainer ç¤¾åŒºç‰ˆ ï¼ˆCEï¼‰å¯è®©æ‚¨åœ¨ Dockerã€Docker Swarmã€Kubernetes å’Œ Azure ACI ä¸­è½»æ¾æ„å»ºå’Œç®¡ç†å®¹å™¨ã€‚</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://downloads.portainer.io/ce-lts/portainer-agent-stack.yml -o portainer-agent-stack.yml</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.2&quot;</span> <span class="comment">#  docker-composeç‰ˆæœ¬ï¼Œæ–°ç‰ˆçš„dockerå·²ç»ä¸éœ€è¦é…ç½®ç‰ˆæœ¬å·äº†</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">agent:</span>  <span class="comment"># agentæœåŠ¡</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">portainer/agent:lts</span> <span class="comment"># é•œåƒï¼Œä¸èƒ½ä½¿ç”¨ Dockerfile</span></span><br><span class="line">    <span class="attr">volumes:</span>  <span class="comment"># æŒ‚è½½å·</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/var/run/docker.sock:/var/run/docker.sock</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/var/lib/docker/volumes:/var/lib/docker/volumes</span></span><br><span class="line">    <span class="attr">networks:</span> <span class="comment"># æŒ‚è½½ç½‘ç»œï¼Œå¿…é¡»æ˜¯ overlay</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">agent_network</span></span><br><span class="line">    <span class="attr">deploy:</span>   <span class="comment"># éƒ¨ç½²ç­–ç•¥ï¼Œservice ç‰¹æœ‰å±æ€§</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">global</span> <span class="comment"># å…¨å±€æ¨¡å¼</span></span><br><span class="line">      <span class="attr">placement:</span> <span class="comment"># éƒ¨ç½²æ¡ä»¶</span></span><br><span class="line">        <span class="attr">constraints:</span> [<span class="string">node.platform.os</span> <span class="string">==</span> <span class="string">linux</span>] <span class="comment">#  è¿è¡Œåœ¨linuxèŠ‚ç‚¹</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">portainer:</span> <span class="comment">#  portaineræœåŠ¡</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">portainer/portainer-ce:lts</span> <span class="comment">#  é•œåƒ</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">-H</span> <span class="string">tcp://tasks.agent:9001</span> <span class="string">--tlsskipverify</span> <span class="comment">#  å¯åŠ¨å‚æ•°</span></span><br><span class="line">    <span class="attr">ports:</span> <span class="comment"># ç«¯å£æ˜ å°„</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9443:9443&quot;</span>  <span class="comment"># æµè§ˆå™¨è®¿é—® https://localhost:9443</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9000:9000&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8000:8000&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span> <span class="comment">#  æŒ‚è½½å·</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">portainer_data:/data</span></span><br><span class="line">    <span class="attr">networks:</span> <span class="comment"># æŒ‚è½½ç½‘ç»œï¼Œä¸agentæœåŠ¡ç½‘ç»œä¸€è‡´</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">agent_network</span></span><br><span class="line">    <span class="attr">deploy:</span> <span class="comment">#  éƒ¨ç½²é…ç½®</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">replicated</span> <span class="comment"># å‰¯æœ¬æ¨¡å¼</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">1</span> <span class="comment">#  å‰¯æœ¬æ•°é‡</span></span><br><span class="line">      <span class="attr">placement:</span> <span class="comment">#  éƒ¨ç½²æ¡ä»¶</span></span><br><span class="line">        <span class="attr">constraints:</span> [<span class="string">node.role</span> <span class="string">==</span> <span class="string">manager</span>] <span class="comment">#  èŠ‚ç‚¹è§’è‰²ä¸ºmanager</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span> <span class="comment">#  ç½‘ç»œå£°æ˜</span></span><br><span class="line">  <span class="attr">agent_network:</span> <span class="comment">#  ç½‘ç»œåç§°</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">overlay</span> <span class="comment">#  ç½‘ç»œé©±åŠ¨</span></span><br><span class="line">    <span class="attr">attachable:</span> <span class="literal">true</span> <span class="comment"># å…è®¸å®¹å™¨åŠ å…¥</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span> <span class="comment">#  æŒ‚è½½å·å£°æ˜</span></span><br><span class="line">  <span class="attr">portainer_data:</span> <span class="comment">#  æŒ‚è½½å·åç§°</span></span><br></pre></td></tr></table></figure><h2 id="Stack-å‘½ä»¤">Stack å‘½ä»¤</h2><table><thead><tr><th>å­å‘½ä»¤</th><th>ä¸­æ–‡è¯´æ˜</th><th>ç¤ºä¾‹å‘½ä»¤</th></tr></thead><tbody><tr><td><code>config</code></td><td>è¾“å‡ºæœ€ç»ˆçš„é…ç½®æ–‡ä»¶ï¼ˆç»è¿‡åˆå¹¶ä¸å˜é‡æ›¿æ¢åï¼‰</td><td><code>docker stack config -c docker-compose.yml</code></td></tr><tr><td><code>deploy</code></td><td>éƒ¨ç½²æ–° stack æˆ–æ›´æ–°å·²æœ‰ stack</td><td><code>docker stack deploy -c docker-compose.yml mystack</code></td></tr><tr><td><code>ls</code></td><td>åˆ—å‡ºæ‰€æœ‰å·²éƒ¨ç½²çš„ stack</td><td><code>docker stack ls</code></td></tr><tr><td><code>ps</code></td><td>æŸ¥çœ‹ stack ä¸­çš„æ‰€æœ‰ä»»åŠ¡ï¼ˆå³å„ä¸ªå®¹å™¨å®ä¾‹ï¼‰</td><td><code>docker stack ps mystack</code></td></tr><tr><td><code>rm</code></td><td>åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ª stack</td><td><code>docker stack rm mystack</code></td></tr><tr><td><code>services</code></td><td>åˆ—å‡ºæŸä¸ª stack ä¸­çš„æ‰€æœ‰æœåŠ¡</td><td><code>docker stack services mystack</code></td></tr></tbody></table><h3 id="docker-stack-config-è¾“å‡ºæœ€ç»ˆçš„é…ç½®æ–‡ä»¶"><code>docker stack config</code>: è¾“å‡ºæœ€ç»ˆçš„é…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ­¤å‘½ä»¤ä¹Ÿå¯ä»¥ç”¨æ¥éªŒè¯composeæ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œåªä¿è¯æ ¼å¼æ­£ç¡®ï¼Œä¸ä¿è¯é€»è¾‘æ­£ç¡®</span></span><br><span class="line">docker stack config -c portainer-agent-stack.yml</span><br></pre></td></tr></table></figure><h3 id="docker-stack-deploy-éƒ¨ç½²-stack"><code>docker stack deploy</code>: éƒ¨ç½² stack</h3><ul class="lvl-0"><li class="lvl-3"><p><code>docker stack deploy</code> == <code>docker stack up</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker stack deploy -c portainer-agent-stack.yml portainer</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">Creating network portainer_agent_network</span><br><span class="line">Creating service portainer_agent</span><br><span class="line">Creating service portainer_portainer</span><br></pre></td></tr></table></figure><h3 id="docker-stack-ls-åˆ—å‡ºæ‰€æœ‰-stack"><code>docker stack ls</code>: åˆ—å‡ºæ‰€æœ‰ stack</h3><ul class="lvl-0"><li class="lvl-2"><p><code>docker stack ls</code> == <code>docker stack list</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker stack <span class="built_in">ls</span></span><br><span class="line"><span class="comment">## è¾“å‡ºï¼Œstackåç§°ä¸ºportainerï¼Œå…¶å†…éƒ¨æœ‰ä¸¤ä¸ªæœåŠ¡ï¼Œagentå’Œportainer</span></span><br><span class="line">NAME        SERVICES</span><br><span class="line">portainer   2</span><br></pre></td></tr></table></figure><h3 id="docker-stack-services-æŸ¥çœ‹æœåŠ¡"><code>docker stack services</code>:  æŸ¥çœ‹æœåŠ¡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">docker stack services portainer</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">ID             NAME                  MODE         REPLICAS   IMAGE                        PORTS</span><br><span class="line">h5foyujr6jq9   portainer_agent       global       5/5        portainer/agent:lts</span><br><span class="line">zcek2jtloe09   portainer_portainer   replicated   1/1        portainer/portainer-ce:lts   *:8000-&gt;8000/tcp, *:9000-&gt;9000/tcp, *:9443-&gt;9443/tcp</span><br><span class="line"></span><br><span class="line"><span class="comment">## ç­‰æ•ˆ</span></span><br><span class="line">docker service <span class="built_in">ls</span></span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">ID             NAME                  MODE         REPLICAS   IMAGE                        PORTS</span><br><span class="line">h5foyujr6jq9   portainer_agent       global       5/5        portainer/agent:lts</span><br><span class="line">zcek2jtloe09   portainer_portainer   replicated   1/1        portainer/portainer-ce:lts   *:8000-&gt;8000/tcp, *:9000-&gt;9000/tcp, *:9443-&gt;9443/tcp</span><br></pre></td></tr></table></figure><h3 id="docker-stack-ps-åˆ—å‡º-stack-ä¸‹çš„æ‰€æœ‰æœåŠ¡å®ä¾‹"><code>docker stack ps</code>: åˆ—å‡º stack ä¸‹çš„æ‰€æœ‰æœåŠ¡å®ä¾‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">docker stack ps portainer</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">ID             NAME                                        IMAGE                        NODE       DESIRED STATE   CURRENT STATE            ERROR     PORTS</span><br><span class="line">wshk9s6gyxh1   portainer_agent.hvzkh3ip5ef8gx973z1ywahbu   portainer/agent:lts          worker2    Running         Running 30 seconds ago</span><br><span class="line">n3jjzmr2fcv9   portainer_agent.kp2zerd28xgz5mmglnje0jp22   portainer/agent:lts          manager1   Running         Running 59 seconds ago</span><br><span class="line">24yy1ew3tiya   portainer_agent.oymi74epagdqeprah7s81tsa2   portainer/agent:lts          manager2   Running         Running 3 minutes ago</span><br><span class="line">kpo4hhdvwcwd   portainer_agent.r7388xl84nczjtnf53pwh7hla   portainer/agent:lts          manager3   Running         Running 35 seconds ago</span><br><span class="line">t8xjbotfuas0   portainer_agent.xkww4853bbdgv7bv8771xibob   portainer/agent:lts          worker1    Running         Running 48 seconds ago</span><br><span class="line">qox3kqypon69   portainer_portainer.1                       portainer/portainer-ce:lts   manager2   Running         Running 2 minutes ago</span><br><span class="line"></span><br><span class="line"><span class="comment">## ç­‰æ•ˆ</span></span><br><span class="line">docker service ps portainer_agent portainer_portainer</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">ID             NAME                                        IMAGE                        NODE       DESIRED STATE   CURRENT STATE            ERROR     PORTS</span><br><span class="line">wshk9s6gyxh1   portainer_agent.hvzkh3ip5ef8gx973z1ywahbu   portainer/agent:lts          worker2    Running         Running 7 minutes ago</span><br><span class="line">n3jjzmr2fcv9   portainer_agent.kp2zerd28xgz5mmglnje0jp22   portainer/agent:lts          manager1   Running         Running 8 minutes ago</span><br><span class="line">24yy1ew3tiya   portainer_agent.oymi74epagdqeprah7s81tsa2   portainer/agent:lts          manager2   Running         Running 10 minutes ago</span><br><span class="line">kpo4hhdvwcwd   portainer_agent.r7388xl84nczjtnf53pwh7hla   portainer/agent:lts          manager3   Running         Running 7 minutes ago</span><br><span class="line">t8xjbotfuas0   portainer_agent.xkww4853bbdgv7bv8771xibob   portainer/agent:lts          worker1    Running         Running 7 minutes ago</span><br><span class="line">qox3kqypon69   portainer_portainer.1                       portainer/portainer-ce:lts   manager2   Running         Running 10 minutes ago</span><br></pre></td></tr></table></figure><h3 id="docker-stack-rm-åœæ­¢å¹¶åˆ é™¤-stack"><code>docker stack rm</code>: åœæ­¢å¹¶åˆ é™¤ stack</h3><ul class="lvl-0"><li class="lvl-2"><p><code>docker stack rm</code> == <code>docker stack remove</code> == <code>docker stack down</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stack <span class="built_in">rm</span> portainer</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **åŠ ç²—**
 *æ–œä½“*
 ***åŠ ç²—å¹¶æ–œä½“***
 ~~åˆ é™¤çº¿~~
 ==çªå‡ºæ˜¾ç¤º==
 `çªå‡ºæ˜¾ç¤º(æ¨è)`
 ++ä¸‹åˆ’çº¿++
 ~ä¸‹æ ‡~
 ^ä¸Šæ ‡^
 è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.
 å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **ç‚¹å‡»æŠ˜å **
 è¿™æ˜¯è¢«éšè—çš„å†…å®¹
 +++

::: tips success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
:::

% note info % success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
% endnote %

å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}
 å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ
 --&gt;
&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;æœ¬æ–‡ä»‹ç» Docker Swarm çš„ æ ˆç®¡ç†&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com&quot;&gt;Dockerå®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com/engine/swarm/&quot;&gt;Docker Swarm å®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com/reference/compose-file/&quot;&gt;Compose file reference&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/docker/"/>
    
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>Docker Swarm ä¹‹ ç½‘ç»œ(Overlay)</title>
    <link href="https://blog.hanqunfeng.com/2025/06/11/docker-swarm-overlay/"/>
    <id>https://blog.hanqunfeng.com/2025/06/11/docker-swarm-overlay/</id>
    <published>2025-06-11T13:30:05.000Z</published>
    <updated>2025-06-11T08:04:58.671Z</updated>
    
    <content type="html"><![CDATA[<!-- **åŠ ç²—** *æ–œä½“* ***åŠ ç²—å¹¶æ–œä½“*** ~~åˆ é™¤çº¿~~ ==çªå‡ºæ˜¾ç¤º== `çªå‡ºæ˜¾ç¤º(æ¨è)` ++ä¸‹åˆ’çº¿++ ~ä¸‹æ ‡~ ^ä¸Šæ ‡^ è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference. å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **ç‚¹å‡»æŠ˜å ** è¿™æ˜¯è¢«éšè—çš„å†…å®¹ +++::: tips success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹:::% note info % success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹% endnote %å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{} å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ --><h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2"><p>æœ¬æ–‡ä»‹ç» Docker Swarm çš„ ç½‘ç»œ(Overlay)</p></li><li class="lvl-2"><p><a href="https://docs.docker.com">Dockerå®˜æ–¹æ–‡æ¡£</a></p></li><li class="lvl-2"><p><a href="https://docs.docker.com/engine/swarm/">Docker Swarm å®˜æ–¹æ–‡æ¡£</a></p></li></ul><span id="more"></span><h2 id="Overlay-ç®€ä»‹">Overlay ç®€ä»‹</h2><ul class="lvl-0"><li class="lvl-2"><p>åœ¨ Docker Swarm ä¸­ï¼Œoverlay ç½‘ç»œ æ˜¯ä¸€ç§åˆ†å¸ƒå¼ç½‘ç»œé©±åŠ¨ï¼Œç”¨äºå°†é›†ç¾¤ä¸­ä¸åŒä¸»æœºä¸Šçš„å®¹å™¨è¿æ¥åˆ°åŒä¸€ä¸ªé€»è¾‘ç½‘ç»œä¸­ï¼Œå°±åƒå®ƒä»¬åœ¨åŒä¸€å°ä¸»æœºä¸Šä¸€æ ·ã€‚</p></li><li class="lvl-2"><p>å½“ä½ ä½¿ç”¨ Docker Swarm éƒ¨ç½²æœåŠ¡æ—¶ï¼ŒSwarm ä¼šè‡ªåŠ¨ä½¿ç”¨ overlay ç½‘ç»œæ¥è¿æ¥ä¸åŒèŠ‚ç‚¹ä¸Šçš„å®¹å™¨ï¼Œå®ç°æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ï¼Œä¿è¯å®¹å™¨é—´çš„é€šä¿¡å®‰å…¨ï¼ˆé€šè¿‡åŠ å¯†ï¼‰ã€‚</p></li><li class="lvl-2"><p>overlay ç½‘ç»œç‰¹ç‚¹</p><ul class="lvl-2"><li class="lvl-4">è·¨ä¸»æœºé€šä¿¡ï¼šå®¹å™¨æ— è®ºåœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Šï¼Œéƒ½å¯ä»¥ä½¿ç”¨ overlay ç½‘ç»œè¿›è¡Œé€šä¿¡ã€‚</li><li class="lvl-4">å†…ç½®æœåŠ¡å‘ç°ï¼šå®¹å™¨ä¹‹é—´å¯ä»¥é€šè¿‡æœåŠ¡åç§°ç›´æ¥é€šä¿¡ã€‚</li><li class="lvl-4">æ”¯æŒåŠ å¯†ï¼šSwarm çš„ overlay ç½‘ç»œæ”¯æŒæ•°æ®åŠ å¯†ï¼Œæé«˜å®‰å…¨æ€§ã€‚</li><li class="lvl-4">è‡ªåŠ¨é…ç½®ï¼šSwarm ä¼šè‡ªåŠ¨ä¸º overlay ç½‘ç»œåˆ†é…å­ç½‘ã€ç®¡ç† IP ç­‰ã€‚</li></ul></li></ul><h2 id="Swarm-ä¸­çš„-overlay-ç½‘ç»œ">Swarm ä¸­çš„ overlay ç½‘ç»œ</h2><ul class="lvl-0"><li class="lvl-2"><p>å½“æˆ‘ä»¬åˆå§‹åŒ–Swarm æ—¶ï¼ŒSwarm ä¼šè‡ªåŠ¨åˆ›å»ºä¸¤ä¸ªnetworkï¼Œä¸€ä¸ªæ˜¯ bridge networkï¼š<code>docker_gwbridge</code> ï¼Œä¸€ä¸ªæ˜¯ overlay networkï¼š<code>ingress</code>ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker network <span class="built_in">ls</span></span><br><span class="line">NETWORK ID     NAME              DRIVER    SCOPE</span><br><span class="line">6b7aadbbd180   bridge            bridge    <span class="built_in">local</span></span><br><span class="line">5ddadf5d0608   docker_gwbridge   bridge    <span class="built_in">local</span></span><br><span class="line">21c6f5b1bedd   host              host      <span class="built_in">local</span></span><br><span class="line">idx465x3jg68   ingress           overlay   swarm</span><br><span class="line">a770c5ad4b13   none              null      <span class="built_in">local</span></span><br></pre></td></tr></table></figure><h3 id="docker-gwbridge"><code>docker_gwbridge</code></h3><ul class="lvl-0"><li class="lvl-2"><p>æŸ¥çœ‹ <code>docker_gwbridge</code> è¯¦æƒ…ï¼Œå…¶ç½‘æ®µä¸º <code>172.18.0.0/16</code>ï¼Œç½‘å…³ä¸º <code>172.18.0.1</code>ï¼Œå†…éƒ¨æœ‰ä¸€ä¸ªå®¹å™¨ <code>ingress-sbox</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">docker inspect docker_gwbridge</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;docker_gwbridge&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: <span class="string">&quot;5ddadf5d06086fcdad5890b8d59edcca4b1293bde23a26f1968fd6114fcaec93&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2025-06-08T07:29:52.119033035-04:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;bridge&quot;</span>,</span><br><span class="line">        <span class="string">&quot;EnableIPv6&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;IPAM&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Options&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;Config&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;Subnet&quot;</span>: <span class="string">&quot;172.18.0.0/16&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;172.18.0.1&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Internal&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Attachable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Ingress&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;ConfigFrom&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Network&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;ConfigOnly&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Containers&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;ingress-sbox&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;gateway_ingress-sbox&quot;</span>,</span><br><span class="line">                <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;4764160a1b048da6d325a2f14165a981a446892ea3b4ebb12e20ee689fdac397&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:12:00:02&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv4Address&quot;</span>: <span class="string">&quot;172.18.0.2/16&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv6Address&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.enable_icc&quot;</span>: <span class="string">&quot;false&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.enable_ip_masquerade&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.name&quot;</span>: <span class="string">&quot;docker_gwbridge&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å…ˆæ¥çœ‹è¿™ä¸ªç½‘æ®µ <code>172.18.0.0/16</code>ï¼Œæˆ‘ä»¬æŸ¥çœ‹ä¸»æœºçš„ç½‘ç»œå’Œè·¯ç”±è¡¨ï¼Œå¯ä»¥çœ‹åˆ° <code>261: docker_gwbridge</code>ï¼Œå…¶IPåœ°å€ä¸º <code>172.18.0.1</code>ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“ <code>docker_gwbridge</code> å°±æ˜¯è¿æ¥åˆ°<code>261: docker_gwbridge</code>è¿™å—ç½‘å¡ä¸Šçš„ï¼Œå¦å¤–å½“å‰è¿˜æœ‰ä¸€ä¸ª<code>263: veth3176100@if262</code>è™šæ‹Ÿç½‘ç»œæ¥å£ä¹Ÿè¿æ¥åˆ°<code>261: docker_gwbridge</code>ä¸Šï¼Œé€šè¿‡è·¯ç”±è¡¨æˆ‘ä»¬å¾—çŸ¥å…¶æœ€ç»ˆè¿æ¥åˆ°<code>2: enp0s5</code>ä¸Šï¼Œä¹Ÿå°±æ˜¯è¿™å°ä¸»æœºçš„ç½‘å¡ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">ip a</span><br><span class="line"><span class="comment">## è¾“å‡ºç»“æœ</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: enp0s5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 00:1c:42:49:12:82 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.211.55.10/24 brd 10.211.55.255 scope global noprefixroute enp0s5</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fdb2:2c26:f4e4:0:21c:42ff:fe49:1282/64 scope global dynamic noprefixroute</span><br><span class="line">       valid_lft 2591886sec preferred_lft 604686sec</span><br><span class="line">    inet6 fe80::21c:42ff:fe49:1282/64 scope <span class="built_in">link</span> noprefixroute</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default</span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:5c:31:<span class="built_in">cd</span>:30 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:5cff:fe31:cd30/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">261: docker_gwbridge: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:fe:e3:ca:f7 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.18.0.1/16 brd 172.18.255.255 scope global docker_gwbridge</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:feff:fee3:caf7/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">263: veth3176100@if262: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker_gwbridge state UP group default</span><br><span class="line">    <span class="built_in">link</span>/ether 96:4b:c1:d9:83:c5 brd ff:ff:ff:ff:ff:ff link-netnsid 1</span><br><span class="line">    inet6 fe80::944b:c1ff:fed9:83c5/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹è·¯ç”±è¡¨</span></span><br><span class="line">route -n</span><br><span class="line"><span class="comment">## è¾“å‡ºç»“æœï¼Œå…¶ç›®çš„åœ°å€æœ€ç»ˆéƒ½ä¼šè½¬åˆ°ç½‘å…³ 10.211.55.1 ä¸Š</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         10.211.55.1     0.0.0.0         UG    100    0        0 enp0s5</span><br><span class="line">10.211.55.0     0.0.0.0         255.255.255.0   U     100    0        0 enp0s5</span><br><span class="line">172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0</span><br><span class="line">172.18.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker_gwbridge</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹docker_gwbridgeç½‘æ¡¥è®¾å¤‡ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°å…¶æŒ‚è½½äº†ä¸€ä¸ªè™šæ‹Ÿç½‘å¡ veth3176100</span></span><br><span class="line">brctl show docker_gwbridge</span><br><span class="line">bridge name     bridge <span class="built_in">id</span>               STP enabled     interfaces</span><br><span class="line">docker_gwbridge         8000.0242fee3caf7       no              veth3176100</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æŒ‰ç†è¯´<code>263: veth3176100@if262</code>è™šæ‹Ÿç½‘ç»œæ¥å£åº”è¯¥å¯¹åº”åˆ°ä¸€ä¸ªå®¹å™¨ä¸Šï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±çœ‹ä¸€çœ‹è¿™ä¸ªå®¹å™¨ <code>ingress-sbox</code>ï¼Œå½“å‰dockerä¸­å¹¶æ²¡æœ‰è¿™ä¸ªå®¹å™¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå®¹å™¨åœ¨å“ªé‡Œå‘¢ï¼Ÿdockeråˆ›å»ºçš„å®¹å™¨éƒ½ä¼šæœ‰ä¸€ä¸ªç½‘ç»œå‘½åç©ºé—´ï¼Œå…¶ä¿å­˜åœ¨å®¿ä¸»æœºçš„<code>/var/run/docker/netns/</code>ä¸‹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /var/run/docker/netns/</span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line"><span class="comment">## è¾“å‡ºï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬è¿˜çœŸçš„å‘ç°äº†ä¸è¿™ä¸ªå®¹å™¨åç§°ç±»ä¼¼çš„ç½‘ç»œå‘½åç©ºé—´ï¼Œå®¹å™¨åç§°æ˜¯ä¸­åˆ’çº¿ï¼Œç½‘ç»œå‘½åç©ºé—´åç§°æ˜¯ä¸‹åˆ’çº¿</span></span><br><span class="line">1-idx465x3jg  ingress_sbox</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>è¿›å…¥è¿™ä¸ªç½‘ç»œï¼Œæˆ‘ä»¬å°±æ‰¾åˆ°ä¸å®¿ä¸»æœºä¸Šçš„è™šæ‹Ÿç½‘ç»œæ¥å£å¯¹åº”çš„å®¹å™¨ç½‘ç»œæ¥å£äº†ï¼š<code>262: eth1@if263</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">nsenter --net=ingress_sbox ip a</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">259: eth0@if260: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP group default</span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:0a:00:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet 10.0.0.2/24 brd 10.0.0.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">262: eth1@if263: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:ac:12:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 1</span><br><span class="line">    inet 172.18.0.2/16 brd 172.18.255.255 scope global eth1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªç½‘ç»œæ¥å£ <code>259: eth0@if260</code>ï¼Œå®ƒåˆæ˜¯ä¸è°å¯¹æ¥çš„å‘¢ï¼Ÿåˆ«ç€æ€¥ï¼Œæˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹ã€‚</p></li></ul><h3 id="ingress"><code>ingress</code></h3><ul class="lvl-0"><li class="lvl-2"><p>æŸ¥çœ‹ <code>ingress</code> è¯¦æƒ…ï¼Œå…¶ç½‘æ®µä¸º <code>10.0.0.0/24</code>ï¼Œç½‘å…³ä¸º <code>10.0.0.1</code>ï¼Œå†…éƒ¨æœ‰ä¸€ä¸ªå®¹å™¨ <code>ingress-sbox</code>ï¼Œå¦å¤–å…¶æœ‰ä¸€ä¸ª<code>Peers</code>å±æ€§ï¼Œå†…éƒ¨åŒ…å«äº†é›†ç¾¤ä¸­æ‰€æœ‰çš„èŠ‚ç‚¹IPï¼Œæ‰€ä»¥ä»è¿™é‡Œä¹Ÿèƒ½å¤§æ¦‚çŒœå‡ºè¿™ä¸ªç½‘ç»œæ˜¯è´Ÿè´£èŠ‚ç‚¹é—´é€šä¿¡çš„ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">docker network inspect ingress</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;ingress&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: <span class="string">&quot;idx465x3jg682fmceumsio297&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2025-06-08T07:29:51.734714967-04:00&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;swarm&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;overlay&quot;</span>,</span><br><span class="line">        <span class="string">&quot;EnableIPv6&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;IPAM&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Options&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;Config&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;Subnet&quot;</span>: <span class="string">&quot;10.0.0.0/24&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;10.0.0.1&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Internal&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Attachable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Ingress&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;ConfigFrom&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Network&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;ConfigOnly&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Containers&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;ingress-sbox&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;ingress-endpoint&quot;</span>,</span><br><span class="line">                <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;fd05086c5104e28c75dbed3e3b308236aaa0e87b698dad6186c23c81755bb009&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:0a:00:00:02&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv4Address&quot;</span>: <span class="string">&quot;10.0.0.2/24&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv6Address&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;com.docker.network.driver.overlay.vxlanid_list&quot;</span>: <span class="string">&quot;4096&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&quot;Peers&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;4969a4611607&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IP&quot;</span>: <span class="string">&quot;10.211.55.10&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;ae3756658a26&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IP&quot;</span>: <span class="string">&quot;10.211.55.14&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;f12309731131&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IP&quot;</span>: <span class="string">&quot;10.211.55.13&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;de5000b11067&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IP&quot;</span>: <span class="string">&quot;10.211.55.12&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;377001904d63&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IP&quot;</span>: <span class="string">&quot;10.211.55.11&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æˆ‘ä»¬è¿˜æ˜¯å…ˆæ¥çœ‹è¿™ä¸ªç½‘å…³<code>10.0.0.1</code>ï¼Œåœ¨å“ªå‘¢ï¼Ÿå®¿ä¸»æœºçš„ç½‘ç»œè®¾å¤‡ä¸­å¹¶æ²¡æœ‰ï¼Œæ‰€ä»¥å®ƒåº”è¯¥æ˜¯dockeråˆ›å»ºçš„ï¼Œæˆ‘ä»¬è¿˜æ˜¯è¦ä»<code>/var/run/docker/netns</code>ä¸­æŸ¥çœ‹ä¸€ä¸‹ï¼Œè¿™é‡Œè¿˜æœ‰ä¸€ä¸ªåç§°ä¸º <code>1-idx465x3jg</code> çš„ç½‘ç»œå‘½åç©ºé—´ï¼Œæˆ‘ä»¬è¿›å»çœ‹çœ‹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">nsenter --net=/var/run/docker/netns/1-idx465x3jg ip a</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">258: vxlan0@if258: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue master br0 state UNKNOWN group default</span><br><span class="line">    <span class="built_in">link</span>/ether 32:c9:a4:01:8a:19 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">2: br0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP group default</span><br><span class="line">    <span class="built_in">link</span>/ether 32:c9:a4:01:8a:19 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.0.0.1/24 brd 10.0.0.255 scope global br0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">260: veth0@if259: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue master br0 state UP group default</span><br><span class="line">    <span class="built_in">link</span>/ether 8a:d3:52:ac:7d:<span class="built_in">cd</span> brd ff:ff:ff:ff:ff:ff link-netnsid 1</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åœ¨è¿™é‡Œæˆ‘ä»¬æ‰¾åˆ°äº†<code>2: br0</code>ï¼Œå…¶IPåœ°å€ä¸º<code>10.0.0.1</code>ï¼Œæ‰€ä»¥å®ƒå°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„ç½‘å…³ã€‚å…¶ä¸Šé¢è¿˜æŒ‚è½½äº†ä¸¤ä¸ªç½‘ç»œè®¾å¤‡ï¼Œä¸€ä¸ªæ˜¯ <code>260: veth0@if259</code>ï¼Œè¿™ä¸ªå°±æ˜¯ä¸<code>ingress_sbox</code> ä¸­<code>259: eth0@if260</code>å¯¹åº”çš„ç½‘ç»œæ¥å£ ï¼Œå¦ä¸€ä¸ªæ˜¯ <code>258: vxlan0@if258</code>ï¼Œå…¶åŸºäº<code>vxlan</code>åè®®ï¼Œè´Ÿè´£é›†ç¾¤è·¨ä¸»æœºé€šä¿¡ã€‚</p></li></ul><h3 id="overlayæ€»ç»“">overlayæ€»ç»“</h3><ul class="lvl-0"><li class="lvl-2"><p><code>docker_gwbridge</code>ä¸­çš„å®¹å™¨<code>ingress-sbox</code>ï¼Œå…¶æœ‰ä¸¤å—ç½‘å¡ï¼Œä¸€å—å¯¹æ¥å®¿ä¸»æœºä¸Šçš„ <code>261: docker_gwbridge</code>ï¼Œå¦ä¸€å—å¯¹æ¥<code>/var/run/docker/netns/1-idx465x3jg</code>ä¸­çš„ <code>2: br0</code>ã€‚</p></li><li class="lvl-2"><p>å®é™…ä¸ŠSwarmä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½æœ‰ä¸¤ä¸ªç½‘å¡ï¼Œä¸€å—å¯¹æ¥å®¿ä¸»æœºä¸Šçš„ <code>261: docker_gwbridge</code>ï¼Œå¦ä¸€å—å¯¹æ¥<code>/var/run/docker/netns/1-idx465x3jg</code>ä¸­çš„ <code>2: br0</code>ã€‚</p></li><li class="lvl-2"><p>å½“è¯·æ±‚åˆ°è¾¾å®¿ä¸»æœºæ—¶ï¼Œä¼šé€šè¿‡<code>enp0s5</code>è½¬å‘åˆ°<code>docker_gwbridge</code>ï¼Œç„¶åå…ˆè¢«è½¬åˆ°<code>ingress-sbox</code>å®¹å™¨ï¼Œç„¶åå†ç»è¿‡å…¶è½¬å‘åˆ°<code>br0</code>ç½‘å…³ï¼Œå†ç”±å®ƒè´Ÿè´£æŸ¥æ‰¾ç›®æ ‡å®¹å™¨ã€‚å¦‚æœç›®æ ‡å®¹å™¨ä¸åœ¨æœ¬èŠ‚ç‚¹ï¼Œåˆ™é€šè¿‡<code>vxlan0</code>ç½‘ç»œæ¥å£è½¬å‘åˆ°å…¶å®ƒèŠ‚ç‚¹è¿›è¡ŒæŸ¥æ‰¾ï¼Œä¸­é—´ç»è¿‡ä¸€ç³»åˆ—çš„ç½‘ç»œåœ°å€è½¬æ¢ã€‚</p></li></ul><p><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/9UVZzm.png" alt=""></p><ul class="lvl-0"><li class="lvl-2"><p>å½“ä½ é€šè¿‡<code>docker network create --driver overlay my-network</code>åˆ›å»ºä¸€ä¸ªoverlayç½‘ç»œæ—¶ï¼ŒDockerä¼šåˆ›å»ºä¸€ä¸ªç±»ä¼¼â€œingressâ€çš„ç½‘ç»œç»“æ„(æ–°çš„<code>br0</code>)ï¼Œå¦‚æœä¸æŒ‡å®šipæ®µï¼Œå…¶ipæ®µä¼šä»<code>10.0.1.0/24</code>å¼€å§‹ï¼Œä¾æ¬¡é€’å¢ä¸€ä¸ªç½‘æ®µã€‚ä½†ä¼šå…±ç”¨<code>docker_gwbridge</code>ã€‚</p></li></ul><h2 id="æŸ¥çœ‹overlayç½‘ç»œä¸­çš„è´Ÿè½½å‡è¡¡">æŸ¥çœ‹overlayç½‘ç»œä¸­çš„è´Ÿè½½å‡è¡¡</h2><ul class="lvl-0"><li class="lvl-2"><p>å¯åŠ¨ä¸€ä¸ªservice</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service create --name my-nginx --replicas 5 --publish 80:80 nginx</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æŸ¥çœ‹<code>ingress_sbox</code>çš„<code>iptables</code>æ•°æ®é“¾ä¸­çš„ mangle è¡¨</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">nsenter --net=/var/run/docker/netns/ingress_sbox iptables -nvL -t mangle</span><br><span class="line"><span class="comment">## è¾“å‡ºç»“æœï¼Œè¿™é‡Œçœ‹åˆ° PREROUTING é“¾ä¸­æœ‰ä¸€æ¡ç›‘å¬80ç«¯å£çš„è§„åˆ™ï¼Œå…¶è¢«æ‰“äº†Markæ ‡è®°: 0x105ï¼Œæ¢ç®—ä¸º10è¿›åˆ¶ï¼š261</span></span><br><span class="line">Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination</span><br><span class="line">    0     0 MARK       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80 MARK <span class="built_in">set</span> 0x105</span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination</span><br><span class="line">    0     0 MARK       all  --  *      *       0.0.0.0/0            10.0.0.33            MARK <span class="built_in">set</span> 0x105</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination</span><br><span class="line"></span><br><span class="line">Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>é€šè¿‡<code>ipvsadm</code>æŸ¥çœ‹è´Ÿè½½å‡è¡¡ä¿¡æ¯</p></li></ul><blockquote><p>ipvsadm æ˜¯ Linux ä¸‹ç®¡ç† IPVSï¼ˆIP Virtual Serverï¼‰è´Ÿè½½å‡è¡¡å™¨çš„å‘½ä»¤ä¹‹ä¸€</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¦‚æœæ²¡æœ‰ipvsadmï¼Œåˆ™å®‰è£…</span></span><br><span class="line">dnf install ipvsadm -y</span><br><span class="line"><span class="comment"># æŸ¥çœ‹ipvsä¿¡æ¯</span></span><br><span class="line">nsenter --net=/var/run/docker/netns/ingress_sbox ipvsadm -Ln</span><br><span class="line"><span class="comment"># -Lï¼šè¡¨ç¤ºåˆ—å‡ºå½“å‰ IPVS çš„è§„åˆ™å’ŒçŠ¶æ€ï¼ˆListï¼‰ã€‚</span></span><br><span class="line"><span class="comment"># -nï¼šè¡¨ç¤ºä»¥æ•°å­—æ–¹å¼æ˜¾ç¤ºåœ°å€å’Œç«¯å£ï¼Œè€Œä¸è¿›è¡Œ DNS è§£ææˆ–ç«¯å£åè§£æï¼ˆå³ï¼šIP å’Œç«¯å£å·ä»¥æ•°å­—æ˜¾ç¤ºï¼Œæ›´ç›´è§‚ï¼Œä¹Ÿæ›´å¿«ï¼‰ã€‚</span></span><br><span class="line"><span class="comment">## è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ° FWM 261 rrï¼Œè¿™é‡Œrrè¡¨ç¤ºè½®è¯¢</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">FWM  261 rr</span><br><span class="line">  -&gt; 10.0.0.34:0                  Masq    1      0          0</span><br><span class="line">  -&gt; 10.0.0.35:0                  Masq    1      0          0</span><br><span class="line">  -&gt; 10.0.0.36:0                  Masq    1      0          0</span><br><span class="line">  -&gt; 10.0.0.37:0                  Masq    1      0          0</span><br><span class="line">  -&gt; 10.0.0.38:0                  Masq    1      0          0</span><br><span class="line"><span class="comment">## è¾“å‡ºè§£é‡Š</span></span><br><span class="line"><span class="comment"># Prot: åè®®ï¼ˆTCP/UDPï¼‰,è¿™é‡Œæ˜¯ FWMï¼Œè¡¨ç¤ºFirewall Markï¼ˆé˜²ç«å¢™æ ‡è®°ï¼‰æ¨¡å¼</span></span><br><span class="line"><span class="comment"># LocalAddress:Port: æœ¬åœ°åœ°å€å’Œç«¯å£å·ï¼Œè¿™é‡Œæ˜¯ 261 ï¼Œè¿™æ˜¯é˜²ç«å¢™æ ‡è®°å€¼ï¼ˆmark å€¼ï¼‰,å°±æ˜¯ä¸Šé¢çœ‹åˆ°çš„é‚£ä¸ª16è¿›åˆ¶ 0x105</span></span><br><span class="line"><span class="comment"># Scheduler: è°ƒåº¦ç®—æ³•ï¼Œè¿™é‡Œæ˜¯ rrï¼Œè¡¨ç¤ºè½®è¯¢(round-robin)ï¼Œè°ƒåº¦ç®—æ³•è¿˜æœ‰ wrrï¼ˆåŠ æƒè½®è¯¢ï¼‰ã€lcï¼ˆæœ€å°‘è¿æ¥ï¼‰ç­‰</span></span><br><span class="line"><span class="comment"># RemoteAddress:Port: è¿œç¨‹åœ°å€å’Œç«¯å£å·ï¼Œè¿™é‡Œæ˜¯ 10.0.0.34:0ï¼Œè¡¨ç¤ºè´Ÿè½½å‡è¡¡åˆ°çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåé¢åŒç†</span></span><br><span class="line"><span class="comment"># Forward: è½¬å‘ç­–ç•¥ï¼Œè¿™é‡Œæ˜¯ Masqï¼Œè¡¨ç¤ºå°†è´Ÿè½½å‡è¡¡åˆ°çš„èŠ‚ç‚¹çš„IPåœ°å€è½¬æ¢æˆå®¿ä¸»æœºçš„IPåœ°å€ï¼Œå³ Masqueradeï¼ˆä¼ªè£…ï¼‰ã€‚è½¬å‘æ–¹å¼ï¼ˆå¦‚ï¼šMasqã€Tunnelã€Direct Routeï¼‰</span></span><br><span class="line"><span class="comment"># Weight: æƒé‡ï¼Œè¿™é‡Œæ˜¯ 1ï¼Œè¡¨ç¤ºè´Ÿè½½å‡è¡¡åˆ°çš„èŠ‚ç‚¹çš„æƒé‡ï¼Œé»˜è®¤ä¸º 1</span></span><br><span class="line"><span class="comment"># ActiveConn: å½“å‰æ´»åŠ¨è¿æ¥æ•°ï¼Œè¿™é‡Œæ˜¯ 0</span></span><br><span class="line"><span class="comment"># InActConn: å½“å‰ä¸æ´»åŠ¨è¿æ¥æ•°ï¼ˆç­‰å¾…å…³é—­çš„è¿æ¥ï¼‰ï¼Œè¿™é‡Œæ˜¯ 0</span></span><br></pre></td></tr></table></figure><h2 id="VXLANæ˜¯ä»€ä¹ˆï¼Ÿ">VXLANæ˜¯ä»€ä¹ˆï¼Ÿ</h2><ul class="lvl-0"><li class="lvl-2"><p>VXLANï¼ˆVirtual Extensible LANï¼‰æ˜¯ Cisco å…¬å¸å¼€å‘çš„ä¸€ç§è™šæ‹Ÿå±€åŸŸç½‘ï¼ˆVLANï¼‰æŠ€æœ¯ï¼Œå®ƒå¯ä»¥å°†å¤šä¸ª VLAN é€»è¾‘åˆ†ç»„ï¼Œå¹¶ä½¿ç”¨å•ä¸ªç‰©ç†ç½‘ç»œè¿›è¡Œç®¡ç†ã€‚VXLAN çš„ä¸»è¦ä½œç”¨æ˜¯æé«˜ç½‘ç»œæ€§èƒ½å’Œæ‰©å±•æ€§ã€‚</p></li><li class="lvl-2"><p>å®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ç§ ç½‘ç»œå°è£…åè®®ï¼ˆoverlay protocolï¼‰ï¼Œç”¨æ¥åœ¨å·²æœ‰çš„ IP ç½‘ç»œä¹‹ä¸Šï¼Œæ„å»ºäºŒå±‚ï¼ˆL2ï¼‰è™šæ‹Ÿç½‘ç»œã€‚</p></li></ul><h3 id="ä¸ºä»€ä¹ˆéœ€è¦-VXLANï¼Ÿ">ä¸ºä»€ä¹ˆéœ€è¦ VXLANï¼Ÿ</h3><ul class="lvl-0"><li class="lvl-2"><p>åœ¨ä¼ ç»Ÿæ•°æ®ä¸­å¿ƒæˆ–äº‘è®¡ç®—ä¸­ï¼Œç»å¸¸æœ‰è¿™æ ·çš„éœ€æ±‚ï¼š</p><ul class="lvl-2"><li class="lvl-6">è·¨ä¸åŒç‰©ç†ç½‘ç»œæˆ–å­ç½‘ï¼Œéƒ¨ç½²åœ¨ä¸åŒæœåŠ¡å™¨ä¸Šçš„è™šæ‹Ÿæœºæˆ–å®¹å™¨ï¼Œè¦èƒ½åƒåœ¨åŒä¸€ä¸ªäºŒå±‚ç½‘ç»œé‡Œä¸€æ ·ç›´æ¥é€šä¿¡ã€‚</li><li class="lvl-6">VLANï¼ˆ802.1Qï¼‰æä¾›çš„äºŒå±‚éš”ç¦»èƒ½åŠ›åªæœ‰ 12 bit VLAN IDï¼ˆæœ€å¤š 4096 ä¸ª VLANï¼‰ï¼Œåœ¨å¤§å‹æ•°æ®ä¸­å¿ƒè¿œè¿œä¸å¤Ÿç”¨ã€‚</li></ul></li><li class="lvl-2"><p>æ•°æ®ä¸­å¿ƒæƒ³è¦æ›´å¥½çš„å¼¹æ€§ã€è·¨åŒºåŸŸéƒ¨ç½²ã€å®¹å™¨ç¼–æ’ã€å¤§è§„æ¨¡ç§Ÿæˆ·éš”ç¦»ã€‚</p></li></ul><h3 id="VXLAN-æ ¸å¿ƒåŸç†">VXLAN æ ¸å¿ƒåŸç†</h3><ul class="lvl-0"><li class="lvl-2"><p>VXLAN é€šè¿‡å°è£…çš„æ–¹å¼ï¼ŒæŠŠäºŒå±‚ä»¥å¤ªç½‘å¸§åŒ…åœ¨ UDP æ•°æ®æŠ¥é‡Œï¼Œåœ¨ä¸‰å±‚ IP ç½‘ç»œä¸­ä¼ é€’ã€‚</p></li><li class="lvl-2"><p>å°è£…æ ¼å¼å¤§è‡´æ˜¯ï¼š</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+-------------------------+</span><br><span class="line">| å¤–å±‚IPå¤´ (IP Header)    |</span><br><span class="line">+-------------------------+</span><br><span class="line">| å¤–å±‚UDPå¤´ (UDP Header)  |</span><br><span class="line">+-------------------------+</span><br><span class="line">| VXLANå¤´ (VXLAN Header)  |</span><br><span class="line">+-------------------------+</span><br><span class="line">| å†…å±‚äºŒå±‚å¸§ (Ethernet)   |</span><br><span class="line">+-------------------------+</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å¤–å±‚ IP/UDP ç”¨äºä¸‰å±‚ä¼ è¾“</p></li><li class="lvl-2"><p>å†…å±‚ä¿ç•™åŸæœ¬çš„äºŒå±‚ä»¥å¤ªç½‘å¸§ï¼ˆå¦‚ MAC åœ°å€ï¼‰</p></li><li class="lvl-2"><p>VXLAN å¤´éƒ¨é‡Œé¢åŒ…å«äº†ä¸€ä¸ª VNI (VXLAN Network Identifier)ï¼š24 bitï¼Œå¯æ”¯æŒ 1600ä¸‡ä¸ªè™šæ‹Ÿç½‘ç»œ</p></li><li class="lvl-2"><p>ç®€å•ç¤ºæ„å›¾</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">VM1 (10.1.1.1) â€”â€”&gt; VTEP1 â€”â€”&gt; Underlay IPç½‘ç»œ â€”â€”&gt; VTEP2 â€”â€”&gt; VM2 (10.1.1.2)</span><br><span class="line"></span><br><span class="line">VTEP1 å°è£…ï¼š</span><br><span class="line">  å†…å±‚ä»¥å¤ªç½‘å¸§  + VXLANå¤´ (VNI) + UDP + IP</span><br><span class="line"></span><br><span class="line">VTEP2 è§£å°è£…ï¼š</span><br><span class="line">  å»æ‰å¤–å±‚å¤´éƒ¨ï¼Œè¿˜åŸåŸå§‹äºŒå±‚å¸§</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **åŠ ç²—**
 *æ–œä½“*
 ***åŠ ç²—å¹¶æ–œä½“***
 ~~åˆ é™¤çº¿~~
 ==çªå‡ºæ˜¾ç¤º==
 `çªå‡ºæ˜¾ç¤º(æ¨è)`
 ++ä¸‹åˆ’çº¿++
 ~ä¸‹æ ‡~
 ^ä¸Šæ ‡^
 è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.
 å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **ç‚¹å‡»æŠ˜å **
 è¿™æ˜¯è¢«éšè—çš„å†…å®¹
 +++

::: tips success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
:::

% note info % success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
% endnote %

å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}
 å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ
 --&gt;
&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;æœ¬æ–‡ä»‹ç» Docker Swarm çš„ ç½‘ç»œ(Overlay)&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com&quot;&gt;Dockerå®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com/engine/swarm/&quot;&gt;Docker Swarm å®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/docker/"/>
    
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>Docker Swarm ä¹‹ æœåŠ¡(Service)</title>
    <link href="https://blog.hanqunfeng.com/2025/06/10/docker-swarm-service/"/>
    <id>https://blog.hanqunfeng.com/2025/06/10/docker-swarm-service/</id>
    <published>2025-06-10T13:30:05.000Z</published>
    <updated>2025-06-11T07:40:57.589Z</updated>
    
    <content type="html"><![CDATA[<!-- **åŠ ç²—** *æ–œä½“* ***åŠ ç²—å¹¶æ–œä½“*** ~~åˆ é™¤çº¿~~ ==çªå‡ºæ˜¾ç¤º== `çªå‡ºæ˜¾ç¤º(æ¨è)` ++ä¸‹åˆ’çº¿++ ~ä¸‹æ ‡~ ^ä¸Šæ ‡^ è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference. å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **ç‚¹å‡»æŠ˜å ** è¿™æ˜¯è¢«éšè—çš„å†…å®¹ +++::: tips success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹:::% note info % success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹% endnote %å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{} å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ --><h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2"><p>æœ¬æ–‡ä»‹ç» Docker Swarm çš„ æœåŠ¡ç®¡ç†</p></li><li class="lvl-2"><p><a href="https://docs.docker.com">Dockerå®˜æ–¹æ–‡æ¡£</a></p></li><li class="lvl-2"><p><a href="https://docs.docker.com/engine/swarm/">Docker Swarm å®˜æ–¹æ–‡æ¡£</a></p></li></ul><span id="more"></span><h2 id="Service-ä¸-Task">Service ä¸ Task</h2><h3 id="ä»€ä¹ˆæ˜¯-Serviceï¼Ÿ">ä»€ä¹ˆæ˜¯ Serviceï¼Ÿ</h3><ul class="lvl-0"><li class="lvl-2"><p>Service æ˜¯ç”¨æˆ·å®šä¹‰çš„æœåŠ¡æŠ½è±¡ï¼Œä¸€ä¸ª Service è¡¨ç¤ºä½ å¸Œæœ›åœ¨ Swarm é›†ç¾¤ä¸­è¿è¡Œçš„æŸä¸ªâ€œåº”ç”¨â€ã€‚</p></li><li class="lvl-2"><p>å®ƒå®šä¹‰äº†ä½ è¦è¿è¡Œçš„å®¹å™¨é•œåƒã€å¯åŠ¨å‘½ä»¤ã€å‰¯æœ¬æ•°é‡ã€ç½‘ç»œé…ç½®ã€ç¯å¢ƒå˜é‡ã€ç«¯å£æ˜ å°„ç­‰ä¿¡æ¯ã€‚</p></li><li class="lvl-2"><p>å¯ä»¥ç±»æ¯”æˆ Kubernetes ä¸­çš„ Deploymentï¼Œä»£è¡¨çš„æ˜¯â€œæœŸæœ›çŠ¶æ€â€ã€‚</p></li></ul><h3 id="ä»€ä¹ˆæ˜¯-Taskï¼Ÿ">ä»€ä¹ˆæ˜¯ Taskï¼Ÿ</h3><ul class="lvl-0"><li class="lvl-2"><p>Task æ˜¯ Service çš„å®é™…æ‰§è¡Œå®ä¾‹ï¼ŒSwarm ä¼šæ ¹æ® Service çš„é…ç½®ç”Ÿæˆ Taskã€‚</p></li><li class="lvl-2"><p>Serviceä¸­çš„æ¯ä¸ªå‰¯æœ¬å¯¹åº”ä¸€ä¸ª Taskï¼Œæ¯ä¸€ä¸ª Task ä»£è¡¨ä¸€ä¸ªè¦åœ¨æŸä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œçš„å®¹å™¨ã€‚</p></li><li class="lvl-2"><p>Task çš„çŠ¶æ€ç”± Swarm ç®¡ç†ï¼Œå®ƒè´Ÿè´£å¯åŠ¨ã€è°ƒåº¦ã€é‡å¯ç­‰ç”Ÿå‘½å‘¨æœŸæ“ä½œã€‚</p></li><li class="lvl-2"><p>å½“æŸä¸ª Task å´©æºƒï¼ŒSwarm ä¼šè‡ªåŠ¨é‡æ–°è°ƒåº¦ä¸€ä¸ªæ–°çš„ Task æ¥æ›¿ä»£å®ƒã€‚</p></li><li class="lvl-2"><p>Task æ˜¯ä¸å¯å˜çš„ï¼Œä¸€æ—¦åˆ›å»ºä¸èƒ½ä¿®æ”¹ï¼Œæ›´æ–° Service ä¼šåˆ›å»ºæ–°çš„ Taskã€‚</p></li></ul><h3 id="ç¤ºä¾‹">ç¤ºä¾‹</h3><ul class="lvl-0"><li class="lvl-2"><p>åˆ›å»ºä¸€ä¸ªåä¸º nginx çš„ Serviceï¼Œå¹¶æŒ‡å®šé•œåƒä¸º nginx:latestï¼Œå¹¶è®¾ç½®å‰¯æœ¬æ•°ä¸º 3ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service create --name nginx --replicas 3 nginx:latest</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªåä¸º nginx çš„ Serviceï¼Œå¹¶è®¾ç½®äº†å‰¯æœ¬æ•°ä¸º 3ï¼Œå³Swarmä¼šåˆ›å»º3ä¸ªTaskæ¥å®Œæˆè¿™ä¸ªä»»åŠ¡ï¼Œæ¯ä¸ª Task æœ€ç»ˆä¼šå¯¹åº”ä¸€ä¸ªå…·ä½“çš„nginxå®¹å™¨ã€‚</p></li></ul><table><thead><tr><th>é¡¹ç›®</th><th>Service</th><th>Task</th></tr></thead><tbody><tr><td>å®šä¹‰</td><td>ç”¨æˆ·å®šä¹‰çš„æœåŠ¡é…ç½®</td><td>æœåŠ¡é…ç½®ç”Ÿæˆçš„æ‰§è¡Œå•å…ƒ</td></tr><tr><td>æ•°é‡å…³ç³»</td><td>ä¸€ä¸ª Service åŒ…å«å¤šä¸ª Task</td><td>ä¸€ä¸ª Task å±äºä¸€ä¸ª Service</td></tr><tr><td>çŠ¶æ€</td><td>æè¿°â€œæœŸæœ›çŠ¶æ€â€</td><td>ä»£è¡¨â€œå®é™…çŠ¶æ€â€</td></tr><tr><td>ç”Ÿå‘½å‘¨æœŸ</td><td>å¯ä»¥æ›´æ–°</td><td>ä¸å¯å˜ï¼Œæ›´æ–°æ„å‘³ç€é‡æ–°åˆ›å»º</td></tr><tr><td>ç®¡ç†è€…</td><td>ç”±ç”¨æˆ·ç®¡ç†</td><td>å®Œå…¨ç”± Swarm è°ƒåº¦å’Œç®¡ç†</td></tr></tbody></table><h2 id="Service-ç›¸å…³å‘½ä»¤">Service ç›¸å…³å‘½ä»¤</h2><table><thead><tr><th>å‘½ä»¤</th><th>ä¸­æ–‡è¯´æ˜</th></tr></thead><tbody><tr><td>create</td><td>åˆ›å»ºä¸€ä¸ªæ–°çš„æœåŠ¡</td></tr><tr><td>inspect</td><td>æ˜¾ç¤ºä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡çš„è¯¦ç»†ä¿¡æ¯</td></tr><tr><td>logs</td><td>è·å–æœåŠ¡æˆ–ä»»åŠ¡çš„æ—¥å¿—</td></tr><tr><td>ls</td><td>åˆ—å‡ºæ‰€æœ‰æœåŠ¡</td></tr><tr><td>ps</td><td>åˆ—å‡ºä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡çš„ä»»åŠ¡ï¼ˆTaskï¼‰</td></tr><tr><td>rm</td><td>åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªæœåŠ¡</td></tr><tr><td>rollback</td><td>å›æ»šæœåŠ¡çš„é…ç½®æ›´æ”¹</td></tr><tr><td>scale</td><td>æ‰©ç¼©ä¸€ä¸ªæˆ–å¤šä¸ªå¯å¤åˆ¶æœåŠ¡çš„å‰¯æœ¬æ•°é‡</td></tr><tr><td>update</td><td>æ›´æ–°æœåŠ¡é…ç½®</td></tr></tbody></table><h3 id="docker-service-create-åˆ›å»ºæœåŠ¡"><code>docker service create</code>:  åˆ›å»ºæœåŠ¡</h3><ul class="lvl-0"><li class="lvl-2"><p>å¸¸ç”¨å‚æ•°è¯´æ˜</p></li></ul><table><thead><tr><th>å‚æ•°</th><th>è¯´æ˜</th><th>ç¤ºä¾‹å‘½ä»¤ï¼ˆå«è¯´æ˜ï¼‰</th></tr></thead><tbody><tr><td><code>--name</code></td><td>æŒ‡å®šæœåŠ¡åç§°</td><td><code>docker service create --name my-web nginx</code><br>â†’ åˆ›å»ºä¸€ä¸ªåä¸º <code>my-web</code> çš„ nginx æœåŠ¡</td></tr><tr><td><code>--replicas</code></td><td>è®¾ç½®å‰¯æœ¬æ•°é‡ï¼ˆä»…é€‚ç”¨äº replicated æ¨¡å¼ï¼‰</td><td><code>docker service create --replicas 3 nginx</code><br>â†’ å¯åŠ¨ 3 ä¸ª nginx å‰¯æœ¬</td></tr><tr><td><code>--publish</code> æˆ– <code>-p</code></td><td>æ˜ å°„ç«¯å£ï¼ˆæ ¼å¼å¦‚ <code>80:80</code>ï¼‰</td><td><code>docker service create -p 8080:80 nginx</code><br>â†’ å°†å®¹å™¨çš„ 80 ç«¯å£æ˜ å°„åˆ°ä¸»æœº 8080</td></tr><tr><td><code>--env</code> æˆ– <code>-e</code></td><td>è®¾ç½®ç¯å¢ƒå˜é‡</td><td><code>docker service create -e ENV=prod nginx</code><br>â†’ è®¾ç½®ç¯å¢ƒå˜é‡ <code>ENV=prod</code></td></tr><tr><td><code>--mount</code></td><td>è®¾ç½®æ•°æ®å·æŒ‚è½½</td><td><code>docker service create --mount type=bind,src=/data,target=/app nginx</code><br>â†’ å°†ä¸»æœºçš„ <code>/data</code> ç›®å½•æŒ‚è½½åˆ°å®¹å™¨å†… <code>/app</code></td></tr><tr><td><code>--constraint</code></td><td>è®¾ç½®éƒ¨ç½²çº¦æŸï¼ˆå¦‚æŒ‡å®šèŠ‚ç‚¹ï¼‰</td><td><code>docker service create --constraint 'node.labels.type == web' nginx</code><br>â†’ ä»…éƒ¨ç½²åœ¨å¸¦æ ‡ç­¾ <code>type=web</code> çš„èŠ‚ç‚¹ä¸Š</td></tr><tr><td><code>--network</code></td><td>æŒ‡å®šæœåŠ¡æ‰€å±çš„ç½‘ç»œï¼ˆé€šå¸¸ä½¿ç”¨ overlay ç½‘ç»œï¼‰</td><td><code>docker service create --network my-net nginx</code><br>â†’ å°†æœåŠ¡è¿æ¥åˆ°è‡ªå®šä¹‰ç½‘ç»œ <code>my-net</code></td></tr><tr><td><code>--detach</code> æˆ– <code>-d</code></td><td>åå°è¿è¡ŒæœåŠ¡ï¼ˆé»˜è®¤è¡Œä¸ºï¼‰</td><td><code>docker service create -d nginx</code><br>â†’ åå°åˆ›å»ºæœåŠ¡ï¼Œä¸é˜»å¡ç»ˆç«¯ï¼Œå› ä¸ºæ˜¯é»˜è®¤è¡Œä¸ºï¼Œæ‰€ä»¥ä¸åŠ  -d ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œserviceä¸æ”¯æŒåƒ docker run é‚£æ ·æ”¯æŒå‰å°è¿è¡Œ</td></tr><tr><td><code>--limit-cpu</code> / <code>--limit-memory</code></td><td>è®¾ç½®èµ„æºé™åˆ¶</td><td><code>docker service create --limit-cpu 0.5 --limit-memory 256M nginx</code><br>â†’ æ¯ä¸ªä»»åŠ¡æœ€å¤šä½¿ç”¨ 0.5 ä¸ª CPU å’Œ 256MB å†…å­˜</td></tr><tr><td><code>--restart-condition</code></td><td>è®¾ç½®é‡å¯ç­–ç•¥ï¼ˆå¦‚ on-failureã€anyã€noneï¼‰</td><td><code>docker service create --restart-condition on-failure nginx</code><br>â†’ ä»…å½“å®¹å™¨å¤±è´¥æ—¶è‡ªåŠ¨é‡å¯</td></tr><tr><td><code>--mode</code></td><td>æŒ‡å®šæœåŠ¡è¿è¡Œæ¨¡å¼ï¼Œæ”¯æŒï¼š<code>replicated</code>ã€<code>global</code>ã€<code>replicated-job</code>ã€<code>global-job</code></td><td><code>docker service create --mode global nginx</code><br>â†’ åœ¨é›†ç¾¤æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ª nginx å®ä¾‹</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>æœåŠ¡è¿è¡Œæ¨¡å¼ï¼ˆâ€“modeï¼‰è¯¦è§£</p></li></ul><table><thead><tr><th>æ¨¡å¼åç§°</th><th>è¯´æ˜</th><th>ä½¿ç”¨åœºæ™¯ç¤ºä¾‹</th></tr></thead><tbody><tr><td><code>replicated</code></td><td>é»˜è®¤æ¨¡å¼ã€‚ç”¨æˆ·æŒ‡å®šéœ€è¦è¿è¡Œå¤šå°‘ä¸ªå‰¯æœ¬ï¼ŒSwarm åœ¨åˆé€‚çš„èŠ‚ç‚¹ä¸Šè°ƒåº¦è¿™äº›å‰¯æœ¬ã€‚</td><td>å…¸å‹çš„ Web æœåŠ¡ï¼Œå¦‚ nginxã€Node.jsã€Java åº”ç”¨ç­‰</td></tr><tr><td><code>global</code></td><td>æ¯ä¸ªå¯ç”¨èŠ‚ç‚¹åªéƒ¨ç½²ä¸€ä¸ªä»»åŠ¡å®ä¾‹ï¼Œä¸éœ€è¦ç”¨æˆ·æŒ‡å®šå‰¯æœ¬æ•°ã€‚</td><td>ç³»ç»Ÿçº§æœåŠ¡ï¼Œå¦‚æ—¥å¿—æ”¶é›†å™¨ï¼ˆFluentdï¼‰ã€ç›‘æ§ä»£ç†ï¼ˆPrometheus node exporterï¼‰</td></tr><tr><td><code>replicated-job</code></td><td>åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Š<strong>æŒ‰å‰¯æœ¬æ•°</strong>è¿è¡Œä¸€æ¬¡æ€§ä»»åŠ¡ï¼Œä»»åŠ¡å®Œæˆåå³é€€å‡ºã€‚</td><td>æ•°æ®å¤„ç†ã€æ‰¹å¤„ç†ä»»åŠ¡ï¼Œå¦‚è½¬æ¢æ–‡ä»¶æˆ–è·‘ ETL</td></tr><tr><td><code>global-job</code></td><td>åœ¨<strong>æ‰€æœ‰èŠ‚ç‚¹ä¸Šå„è¿è¡Œä¸€æ¬¡</strong>çš„çŸ­æš‚ä»»åŠ¡ï¼Œæ‰§è¡Œå®Œæ¯•å³é€€å‡ºã€‚</td><td>åˆå§‹åŒ–è„šæœ¬ã€æ¯å°æœºå™¨ä¸Šè¿è¡Œä¸€æ¬¡çš„æ•°æ®æ¸…æ´—ã€åˆå§‹åŒ–ç¯å¢ƒä»»åŠ¡ç­‰</td></tr></tbody></table><blockquote><p>job æ¨¡å¼é€šå¸¸é…åˆé•œåƒä¸­è®¾å®šçš„å…¥å£å‘½ä»¤ä½¿ç”¨ï¼Œä¸é€‚ç”¨äºé•¿æœŸè¿è¡Œçš„æœåŠ¡ã€‚<br>replicated å’Œ global æ¨¡å¼é€‚ç”¨äºæŒç»­è¿è¡Œçš„æœåŠ¡ï¼ŒSwarm ä¼šè‡ªåŠ¨é‡å¯å¤±è´¥çš„ä»»åŠ¡ã€‚</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>æœåŠ¡é‡å¯ç­–ç•¥ï¼ˆâ€“restart-conditionï¼‰è¯¦è§£</p></li></ul><table><thead><tr><th>å€¼</th><th>å«ä¹‰è¯´æ˜</th></tr></thead><tbody><tr><td><code>none</code></td><td>ä¸é‡å¯ä»»åŠ¡ã€‚å³ä½¿ä»»åŠ¡å¤±è´¥ï¼Œä¹Ÿä¸ä¼šå°è¯•æ¢å¤ã€‚é€‚ç”¨äºçŸ­ç”Ÿå‘½å‘¨æœŸçš„ä»»åŠ¡æˆ–æµ‹è¯•æœåŠ¡ã€‚</td></tr><tr><td><code>on-failure</code></td><td><strong>ä»…åœ¨ä»»åŠ¡å¼‚å¸¸å¤±è´¥æ—¶</strong>ï¼ˆexit code é 0ï¼‰è‡ªåŠ¨é‡å¯ã€‚å¸¸ç”¨äºå¯èƒ½å¶å‘å¤±è´¥çš„æœåŠ¡ã€‚</td></tr><tr><td><code>any</code>ï¼ˆé»˜è®¤ï¼‰</td><td><strong>æ— è®ºä»»åŠ¡å¦‚ä½•é€€å‡º</strong>ï¼ˆåŒ…æ‹¬æ­£å¸¸é€€å‡ºæˆ–å¤±è´¥ï¼‰ï¼Œéƒ½ä¼šå°è¯•é‡å¯ã€‚é€‚ç”¨äºæŒç»­è¿è¡ŒæœåŠ¡ã€‚</td></tr></tbody></table><blockquote><p>æƒ…æ™¯æ€»ç»“</p></blockquote><table><thead><tr><th>æƒ…æ™¯</th><th><code>none</code></th><th><code>on-failure</code></th><th><code>any</code></th></tr></thead><tbody><tr><td>æœåŠ¡è¿è¡Œæ—¶å´©æºƒï¼ˆexit code â‰  0ï¼‰</td><td>âŒ ä¸é‡å¯</td><td>âœ… è‡ªåŠ¨é‡å¯</td><td>âœ… è‡ªåŠ¨é‡å¯</td></tr><tr><td>æœåŠ¡æ­£å¸¸ç»“æŸï¼ˆexit code = 0ï¼‰</td><td>âŒ ä¸é‡å¯</td><td>âŒ ä¸é‡å¯</td><td>âœ… è‡ªåŠ¨é‡å¯</td></tr><tr><td>æŒç»­è¿è¡Œå‹æœåŠ¡ï¼ˆå¦‚ nginxï¼‰</td><td>âŒ ä¸æ¨è</td><td>å¯ç”¨</td><td>âœ… æ¨è</td></tr><tr><td>ä¸€æ¬¡æ€§ä»»åŠ¡ï¼ˆå¦‚æ‰¹å¤„ç†ã€æ•°æ®åˆå§‹åŒ–ï¼‰</td><td>âœ… æ¨è</td><td>å¯ç”¨</td><td>âŒ ä¸æ¨è</td></tr></tbody></table><h4 id="docker-service-create-ä½¿ç”¨ç¤ºä¾‹"><code>docker service create</code> ä½¿ç”¨ç¤ºä¾‹</h4><ul class="lvl-0"><li class="lvl-2"><p>åˆ›å»ºä¸€ä¸ªåä¸º my-nginx çš„æœåŠ¡ï¼Œå¹¶æŒ‡å®š 3 ä¸ªå‰¯æœ¬ï¼Œå°† 80 ç«¯å£æ˜ å°„åˆ°ä¸»æœºçš„ 80 ç«¯å£ï¼Œå¹¶ä½¿ç”¨ nginx é•œåƒ</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ­¤æ—¶åœ¨æµè§ˆå™¨ä¸­è¾“å…¥Swarmä¸­ä»»æ„èŠ‚ç‚¹çš„IPåœ°å€ï¼Œå³å¯è®¿é—®åˆ°NginxæœåŠ¡ï¼Œå³ä½¿ä»»åŠ¡æ²¡æœ‰è¢«åˆ†é…åˆ°è¿™ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿèƒ½è®¿é—®åˆ°NginxæœåŠ¡ï¼Œè¿™å°±æ˜¯Swarmçš„è´Ÿè½½å‡è¡¡åŠŸèƒ½</span></span><br><span class="line">docker service create \</span><br><span class="line">  --name my-nginx \</span><br><span class="line">  --replicas 3 \</span><br><span class="line">  --publish 80:80 \</span><br><span class="line">  nginx</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åˆ›å»ºä¸€ä¸ªåä¸º log-agent çš„å…¨å±€æœåŠ¡ï¼Œå¹¶ä½¿ç”¨ fluentd é•œåƒï¼Œå³æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šè¿è¡Œä¸€ä¸ª fluentd å®¹å™¨</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># global</span></span><br><span class="line">docker service create --name log-agent --mode global fluentd</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åˆ›å»ºä¸€ä¸ªåç§°ä¸º web-app çš„æœåŠ¡ï¼Œå¹¶è®¾ç½®ç¯å¢ƒå˜é‡ NODE_ENV=production ï¼ŒæŒ‚è½½ /data ç›®å½•åˆ°å®¹å™¨çš„ /app/data ç›®å½•ï¼Œå¹¶è®¾ç½® 2 ä¸ªå‰¯æœ¬ï¼Œå¹¶ä¸”æŒ‡å®šå¯åŠ¨å®¹å™¨çš„å‘½ä»¤ä¸º node server.js</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker service create \</span><br><span class="line">  --name web-app \</span><br><span class="line">  --<span class="built_in">env</span> NODE_ENV=production \</span><br><span class="line">  --mount <span class="built_in">type</span>=<span class="built_in">bind</span>,src=/data,target=/app/data \</span><br><span class="line">  --replicas 2 \</span><br><span class="line">  node:18 node server.js</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åˆ›å»ºä¸€ä¸ªåç§°ä¸º db çš„æœåŠ¡ï¼Œå¹¶æŒ‡å®šè¿è¡Œåœ¨å…·æœ‰ role=db æ ‡ç­¾çš„èŠ‚ç‚¹ä¸Šï¼Œå¹¶ä¸”ä½¿ç”¨åä¸º db-data çš„å·æŒ‚è½½æ•°æ®</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºæ•°æ®å·</span></span><br><span class="line">docker volume create db-data</span><br><span class="line"><span class="comment"># åˆ›å»ºæœåŠ¡</span></span><br><span class="line">docker service create \</span><br><span class="line">  --name db \</span><br><span class="line">  --constraint <span class="string">&#x27;node.labels.role == db&#x27;</span> \</span><br><span class="line">  --mount <span class="built_in">type</span>=volume,<span class="built_in">source</span>=db-data,target=/var/lib/mysql \</span><br><span class="line">  mysql:8</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ä½¿ç”¨ on-failure ç­–ç•¥ï¼Œä»…åœ¨å¤±è´¥æ—¶è‡ªåŠ¨é‡å¯</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker service create \</span><br><span class="line">  --name unstable-worker \</span><br><span class="line">  --restart-condition on-failure \</span><br><span class="line">  my-worker-image</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æŒ‡å®šç½‘ç»œï¼Œç½‘ç»œé©±åŠ¨ç±»å‹ä¸º overlay</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…ˆåœ¨managerèŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ª overlay ç½‘ç»œï¼ˆé€‚ç”¨äº Swarm æ¨¡å¼ï¼‰</span></span><br><span class="line">docker network create --driver overlay my-overlay-net</span><br><span class="line"><span class="comment"># åˆ›å»ºé©±åŠ¨ç±»å‹ä¸º overlay çš„ç½‘ç»œï¼Œä¼šç«‹å³åŒæ­¥æ‰€æœ‰ manager èŠ‚ç‚¹ï¼Œä½†ä¸ä¼šåŒæ­¥åˆ° worker èŠ‚ç‚¹ï¼Œåªæœ‰å½“ä»»åŠ¡è¢«åˆ†é…åˆ° worker èŠ‚ç‚¹æ—¶ï¼Œè¯¥ç½‘ç»œæ‰ä¼šåŒæ­¥åˆ° worker èŠ‚ç‚¹</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæœåŠ¡å¹¶åŠ å…¥è¯¥ç½‘ç»œ</span></span><br><span class="line">docker service create \</span><br><span class="line">  --name web-service \</span><br><span class="line">  --network my-overlay-net \</span><br><span class="line">  --replicas 5 \</span><br><span class="line">  nginx</span><br><span class="line">  <span class="comment"># --network: æŒ‡å®šæœåŠ¡è¿è¡Œæ—¶è¿æ¥åˆ°è¯¥ç½‘ç»œï¼Œè¿™æ ·åœ¨åŒä¸€ä¸ªç½‘ç»œä¸­çš„æœåŠ¡ä¹‹é—´å¯ä»¥ä½¿ç”¨ æœåŠ¡åäº’ç›¸è®¿é—®ï¼Œå®ç°æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ã€‚</span></span><br></pre></td></tr></table></figure><div class="tips"><p><em><strong>å°è´´å£«</strong></em></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker network <span class="built_in">ls</span></span><br><span class="line">NETWORK ID     NAME              DRIVER    SCOPE</span><br><span class="line">6b7aadbbd180   bridge            bridge    <span class="built_in">local</span></span><br><span class="line">5ddadf5d0608   docker_gwbridge   bridge    <span class="built_in">local</span></span><br><span class="line">21c6f5b1bedd   host              host      <span class="built_in">local</span></span><br><span class="line">idx465x3jg68   ingress           overlay   swarm</span><br><span class="line">a770c5ad4b13   none              null      <span class="built_in">local</span></span><br></pre></td></tr></table></figure><ul class="lvl-1"><li class="lvl-2">åˆå§‹åŒ–Swarmé›†ç¾¤åï¼Œä¼šåˆ›å»ºä¸€ä¸ªé»˜è®¤çš„ overlay ç½‘ç»œ: ingressï¼Œå¦‚æœæˆ‘ä»¬åˆ›å»ºæœåŠ¡æ—¶æ²¡æœ‰æŒ‡å®šç½‘ç»œï¼Œé‚£ä¹ˆæœåŠ¡å°±ä¼šåŠ å…¥ ingress ç½‘ç»œã€‚</li><li class="lvl-2">ä½†æ˜¯è¿™ä¸ªé»˜è®¤çš„ ingress ç½‘ç»œå¹¶ä¸èƒ½ç”¨äºæœåŠ¡ä¹‹é—´é€šè¿‡æœåŠ¡åç§°äº’ç›¸è®¿é—®ï¼Œä½†å¯ä»¥é€šè¿‡IPæˆ–Hostnameè®¿é—®æœåŠ¡ã€‚</li><li class="lvl-2">é»˜è®¤çš„ ingress ç½‘ç»œä»…ç”¨äº ingress è´Ÿè½½å‡è¡¡ï¼ˆå³ -p ç«¯å£æ˜ å°„ï¼‰ï¼Œä¸æ”¯æŒæœåŠ¡å†…éƒ¨é€šä¿¡æˆ– DNS æœåŠ¡å‘ç°ã€‚</li><li class="lvl-2">å¦å¤–ï¼Œåˆå§‹åŒ–Swarmé›†ç¾¤åï¼Œè¿˜ä¼šåˆ›å»ºä¸€ä¸ªé»˜è®¤çš„ bridge ç½‘ç»œ: docker_gwbridgeï¼Œè´Ÿè´£è¿æ¥ Swarm é›†ç¾¤çš„ Overlay ç½‘ç»œä¸å®¿ä¸»æœºç½‘ç»œï¼Œè´Ÿè´£è·¨èŠ‚ç‚¹çš„æµé‡è½¬å‘<ul class="lvl-3"><li class="lvl-4">å½“ä¸€ä¸ªå®¹å™¨åœ¨ Overlay ç½‘ç»œé‡Œè®¿é—®å¤–éƒ¨ IPï¼Œæ¯”å¦‚è®¿é—®å…¬ç½‘ï¼Œæµé‡æœ€ç»ˆé€šè¿‡ docker_gwbridge ç½‘ç»œå‡ºå£å‡ºå»ã€‚</li><li class="lvl-4">èŠ‚ç‚¹é—´ VXLAN éš§é“çš„æµé‡ä¹Ÿä¼šå€ŸåŠ©æ­¤ç½‘ç»œæ¡¥æ¥åˆ°å®¿ä¸»æœºçš„ç‰©ç†ç½‘ç»œæ¥å£ã€‚</li></ul></li></ul></div><h3 id="docker-service-ls-åˆ—å‡ºæ‰€æœ‰æœåŠ¡"><code>docker service ls</code>: åˆ—å‡ºæ‰€æœ‰æœåŠ¡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker service <span class="built_in">ls</span></span><br><span class="line">ID             NAME       MODE         REPLICAS   IMAGE          PORTS</span><br><span class="line">dmnztimv3pb8   my-nginx   replicated   2/2        nginx:latest   *:80-&gt;80/tcp</span><br></pre></td></tr></table></figure><h3 id="docker-service-inspect-æŸ¥çœ‹æœåŠ¡è¯¦æƒ…"><code>docker service inspect</code>: æŸ¥çœ‹æœåŠ¡è¯¦æƒ…</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker service inspect my-nginx</span><br></pre></td></tr></table></figure><h3 id="docker-service-log-æŸ¥çœ‹æœåŠ¡æ—¥å¿—"><code>docker service log</code>: æŸ¥çœ‹æœåŠ¡æ—¥å¿—</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹æŒ‡å®šæœåŠ¡ä¸‹æ‰€æœ‰ä»»åŠ¡çš„æ—¥å¿—</span></span><br><span class="line">docker service logs my-nginx</span><br><span class="line"><span class="comment"># æŸ¥çœ‹æŒ‡å®šä»»åŠ¡çš„æ—¥å¿—ï¼ŒæŒ‡å®šä»»åŠ¡IDï¼Œä¸æ”¯æŒä»»åŠ¡åç§°</span></span><br><span class="line">docker service logs p4tats0f9npk</span><br><span class="line"><span class="comment"># æ»šåŠ¨æŸ¥çœ‹æ—¥å¿—</span></span><br><span class="line">docker service logs -f my-nginx</span><br></pre></td></tr></table></figure><h3 id="docker-service-ps-åˆ—å‡ºæœåŠ¡ä»»åŠ¡"><code>docker service ps</code>: åˆ—å‡ºæœåŠ¡ä»»åŠ¡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker service ps my-nginx</span><br><span class="line">ID             NAME         IMAGE          NODE       DESIRED STATE   CURRENT STATE            ERROR     PORTS</span><br><span class="line">p4tats0f9npk   my-nginx.1   nginx:latest   manager1   Running         Running 13 minutes ago</span><br><span class="line">v7z383xy7dso   my-nginx.2   nginx:latest   manager2   Running         Running 15 minutes ago</span><br></pre></td></tr></table></figure><h3 id="docker-service-scale-æ‰©å®¹-ç¼©å®¹æœåŠ¡"><code>docker service scale</code>: æ‰©å®¹/ç¼©å®¹æœåŠ¡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯åŠ¨ä¸€ä¸ªæœåŠ¡</span></span><br><span class="line">docker service create \</span><br><span class="line">  --name my-nginx \</span><br><span class="line">  --replicas 3 \</span><br><span class="line">  --publish 80:80 \</span><br><span class="line">  nginx</span><br><span class="line"><span class="comment"># æŸ¥çœ‹æœåŠ¡ä»»åŠ¡</span></span><br><span class="line">docker service ps my-nginx</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">ID             NAME         IMAGE          NODE       DESIRED STATE   CURRENT STATE            ERROR     PORTS</span><br><span class="line">p4tats0f9npk   my-nginx.1   nginx:latest   manager1   Running         Running 14 seconds ago</span><br><span class="line">v7z383xy7dso   my-nginx.2   nginx:latest   manager2   Running         Running 2 minutes ago</span><br><span class="line">w0sm5ixvi6eb   my-nginx.3   nginx:latest   worker2    Running         Running 4 seconds ago</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰©å®¹åˆ°5ä¸ªä»»åŠ¡</span></span><br><span class="line">docker service scale my-nginx=5</span><br><span class="line"><span class="comment"># æŸ¥çœ‹æœåŠ¡ä»»åŠ¡</span></span><br><span class="line">docker service ps my-nginx</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">ID             NAME         IMAGE          NODE       DESIRED STATE   CURRENT STATE                    ERROR     PORTS</span><br><span class="line">p4tats0f9npk   my-nginx.1   nginx:latest   manager1   Running         Running about a minute ago</span><br><span class="line">v7z383xy7dso   my-nginx.2   nginx:latest   manager2   Running         Running 3 minutes ago</span><br><span class="line">w0sm5ixvi6eb   my-nginx.3   nginx:latest   worker2    Running         Running about a minute ago</span><br><span class="line">ksbeflwg3mcj   my-nginx.4   nginx:latest   worker1    Running         Running less than a second ago</span><br><span class="line">iw4zlm56n1x8   my-nginx.5   nginx:latest   manager3   Running         Running less than a second ago</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼©å®¹åˆ°2ä¸ªäººä»»åŠ¡</span></span><br><span class="line">docker service scale my-nginx=2</span><br><span class="line"><span class="comment"># æŸ¥çœ‹æœåŠ¡ä»»åŠ¡</span></span><br><span class="line">docker service ps my-nginx</span><br><span class="line">ID             NAME         IMAGE          NODE       DESIRED STATE   CURRENT STATE           ERROR     PORTS</span><br><span class="line">p4tats0f9npk   my-nginx.1   nginx:latest   manager1   Running         Running 2 minutes ago</span><br><span class="line">v7z383xy7dso   my-nginx.2   nginx:latest   manager2   Running         Running 4 minutes ago</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿˜å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œæ‰©ç¼©å®¹</span></span><br><span class="line">docker service update --replicas=5 my-nginx</span><br></pre></td></tr></table></figure><h3 id="docker-service-update-æ›´æ–°æœåŠ¡"><code>docker service update</code>: æ›´æ–°æœåŠ¡</h3><ul class="lvl-0"><li class="lvl-2"><p>æ”¯æŒçš„å‚æ•°</p></li></ul><table><thead><tr><th>å‚æ•°</th><th>è¯´æ˜</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td><code>--image</code></td><td>æ›´æ–°æœåŠ¡ä½¿ç”¨çš„é•œåƒ</td><td><code>--image nginx:1.25</code></td></tr><tr><td><code>--replicas</code></td><td>è®¾ç½®æœåŠ¡çš„å‰¯æœ¬æ•°é‡ï¼ˆä»…é€‚ç”¨äº replicated æ¨¡å¼ï¼‰</td><td><code>--replicas 5</code></td></tr><tr><td><code>--env-add</code></td><td>æ·»åŠ ç¯å¢ƒå˜é‡</td><td><code>--env-add DEBUG=true</code></td></tr><tr><td><code>--env-rm</code></td><td>ç§»é™¤ç¯å¢ƒå˜é‡</td><td><code>--env-rm OLD_VAR</code></td></tr><tr><td><code>--publish-add</code></td><td>æ·»åŠ ç«¯å£æ˜ å°„</td><td><code>--publish-add published=8080,target=80</code></td></tr><tr><td><code>--publish-rm</code></td><td>ç§»é™¤ç«¯å£æ˜ å°„</td><td><code>--publish-rm 80</code></td></tr><tr><td><code>--mount-add</code></td><td>æ·»åŠ æŒ‚è½½</td><td><code>--mount-add type=bind,src=/data,dst=/data</code></td></tr><tr><td><code>--mount-rm</code></td><td>ç§»é™¤æŒ‚è½½</td><td><code>--mount-rm /data</code></td></tr><tr><td><code>--constraint-add</code></td><td>æ·»åŠ éƒ¨ç½²çº¦æŸ</td><td><code>--constraint-add 'node.labels.zone==east'</code></td></tr><tr><td><code>--constraint-rm</code></td><td>ç§»é™¤éƒ¨ç½²çº¦æŸ</td><td><code>--constraint-rm 'node.labels.zone==east'</code></td></tr><tr><td><code>--limit-cpu</code></td><td>è®¾ç½® CPU é™åˆ¶</td><td><code>--limit-cpu 0.5</code></td></tr><tr><td><code>--limit-memory</code></td><td>è®¾ç½®å†…å­˜é™åˆ¶</td><td><code>--limit-memory 256M</code></td></tr><tr><td><code>--restart-condition</code></td><td>è®¾ç½®é‡å¯ç­–ç•¥ï¼ˆnoneã€on-failureã€anyï¼‰</td><td><code>--restart-condition on-failure</code></td></tr><tr><td><code>--update-delay</code></td><td>è®¾ç½®ä»»åŠ¡æ›´æ–°ä¹‹é—´çš„å»¶è¿Ÿ</td><td><code>--update-delay 10s</code></td></tr><tr><td><code>--update-parallelism</code></td><td>è®¾ç½®å¹¶å‘æ›´æ–°ä»»åŠ¡çš„æ•°é‡</td><td><code>--update-parallelism 2</code></td></tr><tr><td><code>--update-order</code></td><td>è®¾ç½®æ›´æ–°é¡ºåºï¼ˆstart-first æˆ– stop-firstï¼‰</td><td><code>--update-order start-first</code></td></tr><tr><td><code>--update-failure-action</code></td><td>æ›´æ–°å¤±è´¥åçš„åŠ¨ä½œï¼ˆpauseã€continueã€rollbackï¼‰</td><td><code>--update-failure-action rollback</code></td></tr><tr><td><code>--rollback</code></td><td>å›æ»šåˆ°ä¸Šä¸€æ¬¡æˆåŠŸé…ç½®</td><td><code>--rollback</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker service update \</span><br><span class="line">  --image nginx:1.25 \</span><br><span class="line">  --replicas 4 \</span><br><span class="line">  --env-add ENV=prod \</span><br><span class="line">  --limit-memory 512M \</span><br><span class="line">  --limit-cpu 1.0 \</span><br><span class="line">  --update-delay 10s \</span><br><span class="line">  --update-parallelism 2 \</span><br><span class="line">  --update-failure-action rollback \</span><br><span class="line">  my-nginx</span><br></pre></td></tr></table></figure><h3 id="docker-service-rollback-å›æ»šæœåŠ¡"><code>docker service rollback</code>: å›æ»šæœåŠ¡</h3><ul class="lvl-0"><li class="lvl-2"><p>ä¼šå°†æœåŠ¡å›æ»šåˆ°ä¸Šä¸€æ¬¡æˆåŠŸéƒ¨ç½²çš„ç‰ˆæœ¬ï¼ŒåŒ…æ‹¬é•œåƒã€ç¯å¢ƒå˜é‡ã€éƒ¨ç½²çº¦æŸç­‰ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker service rollback &lt;service_name&gt;</span></span><br><span class="line">docker service rollback my-nginx</span><br></pre></td></tr></table></figure><h3 id="docker-service-rm-åˆ é™¤æœåŠ¡"><code>docker service rm</code>: åˆ é™¤æœåŠ¡</h3><ul class="lvl-0"><li class="lvl-2"><p>åˆ é™¤æœåŠ¡ä¼šåœæ­¢æœåŠ¡å¹¶åˆ é™¤æœåŠ¡ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker service rm &lt;service_name&gt;</span></span><br><span class="line">docker service <span class="built_in">rm</span> my-nginx</span><br></pre></td></tr></table></figure><h2 id="ç»éªŒæŠ€å·§">ç»éªŒæŠ€å·§</h2><h3 id="å¦‚ä½•è®©ä»»åŠ¡è¿è¡Œåœ¨æŒ‡å®šçš„èŠ‚ç‚¹ä¸Šï¼Ÿ">å¦‚ä½•è®©ä»»åŠ¡è¿è¡Œåœ¨æŒ‡å®šçš„èŠ‚ç‚¹ä¸Šï¼Ÿ</h3><ul class="lvl-0"><li class="lvl-2"><p>åˆ›å»ºæœåŠ¡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ <code>--constraint</code> å‚æ•°æŒ‡å®šèŠ‚ç‚¹çš„æ ‡ç­¾ï¼Œä½¿å…¶è¿è¡Œåœ¨å…·æœ‰æŒ‡å®šæ ‡ç­¾çš„èŠ‚ç‚¹ä¸Šã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç»™ç»“ç‚¹åŠ æ ‡ç­¾</span></span><br><span class="line">docker node update --label-add <span class="built_in">env</span>=prod worker1</span><br><span class="line"></span><br><span class="line"><span class="comment"># node.labels æ˜¯Swarmå†…ç½®å±æ€§ï¼Œè¡¨ç¤ºèŠ‚ç‚¹çš„æ ‡ç­¾ï¼Œè¿™é‡ŒæŒ‡å®šèŠ‚ç‚¹æ ‡ç­¾ä¸º env=prod</span></span><br><span class="line">docker service create \</span><br><span class="line">--name my-nginx \</span><br><span class="line">--replicas 2 \</span><br><span class="line">--constraint <span class="string">&#x27;node.labels.env == prod&#x27;</span> \</span><br><span class="line">nginx:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™é‡Œè¦æ³¨æ„ï¼Œè¿è¡Œä»»åŠ¡åå¦‚æœä¿®æ”¹äº†nodeçš„æ ‡ç­¾ï¼Œé‚£ä¹ˆä»»åŠ¡å°±ä¼šé‡æ–°åˆ†é…ï¼Œåˆ†é…æ˜¯å¦‚æœæ‰¾ä¸åˆ°ç¬¦åˆæ ‡ç­¾çš„èŠ‚ç‚¹ï¼Œå°±ä¼šè¿è¡Œå¤±è´¥ã€‚</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åªèƒ½è¿è¡Œåœ¨ç®¡ç†èŠ‚ç‚¹ä¸Š</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># node.role æ˜¯ Swarm çš„å†…ç½®å±æ€§ï¼Œè¡¨ç¤ºèŠ‚ç‚¹çš„ç±»å‹ï¼Œå€¼ä¸º manager æˆ– workerã€‚</span></span><br><span class="line">docker service create \</span><br><span class="line">  --name manager-only-service \</span><br><span class="line">  --constraint <span class="string">&#x27;node.role == manager&#x27;</span> \</span><br><span class="line">  nginx</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>Swarm å†…ç½®å±æ€§</p></li></ul><table><thead><tr><th>å±æ€§å</th><th>ç¤ºä¾‹å€¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>node.id</code></td><td><code>node.id == abcd1234</code></td><td>èŠ‚ç‚¹çš„å”¯ä¸€ IDï¼ˆå¯ç”¨ <code>docker node ls</code> æŸ¥çœ‹ï¼‰</td></tr><tr><td><code>node.hostname</code></td><td><code>node.hostname == manager-1</code></td><td>èŠ‚ç‚¹ä¸»æœºå</td></tr><tr><td><code>node.role</code></td><td><code>node.role == manager</code> æˆ– <code>node.role == worker</code></td><td>èŠ‚ç‚¹åœ¨ Swarm ä¸­çš„è§’è‰²ï¼ˆç®¡ç†/å·¥ä½œï¼‰</td></tr><tr><td><code>engine.labels.*</code></td><td><code>engine.labels.disk == ssd</code></td><td>Docker å¼•æ“çº§åˆ«çš„æ ‡ç­¾ï¼ˆéœ€æ‰‹åŠ¨è®¾ç½®ï¼‰</td></tr><tr><td><code>node.platform.os</code></td><td><code>node.platform.os == linux</code></td><td>èŠ‚ç‚¹æ“ä½œç³»ç»Ÿç±»å‹</td></tr><tr><td><code>node.platform.arch</code></td><td><code>node.platform.arch == x86_64</code></td><td>èŠ‚ç‚¹æ¶æ„ç±»å‹ï¼ˆå¦‚ <code>arm64</code>, <code>x86_64</code>ï¼‰</td></tr></tbody></table><h3 id="å¦‚ä½•è®¿é—®ServiceæœåŠ¡ï¼Ÿ">å¦‚ä½•è®¿é—®ServiceæœåŠ¡ï¼Ÿ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯åŠ¨ä¸€ä¸ªserviceï¼Œ3ä¸ªå‰¯æœ¬ï¼Œé•œåƒä¸º whoamiï¼Œè¿™ä¸ªé•œåƒä¼šè¿”å›å½“å‰è®¿é—®çš„å®¹å™¨çš„IDï¼Œå³è¿”å›çš„Hostname</span></span><br><span class="line">docker service create --name <span class="built_in">whoami</span> \</span><br><span class="line">  --replicas 3 \</span><br><span class="line">  -p 80:80 \</span><br><span class="line">  traefik/whoami</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹serviceæœåŠ¡è¿è¡Œåœ¨å“ªäº›èŠ‚ç‚¹ä¸Šï¼Œçœ‹åˆ°è¿™é‡Œåªæœ‰ manager1\manager2\worker2 èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œæ³¨æ„è¿™é‡Œçœ‹åˆ°çš„IDæ˜¯Task IDï¼Œå¹¶éå®¹å™¨ID</span></span><br><span class="line">docker service ps <span class="built_in">whoami</span></span><br><span class="line">ID             NAME       IMAGE                   NODE       DESIRED STATE   CURRENT STATE            ERROR     PORTS</span><br><span class="line">u1elzp22hyvm   whoami.1   traefik/whoami:latest   manager2   Running         Running 2 minutes ago</span><br><span class="line">4cent1kfgghb   whoami.2   traefik/whoami:latest   worker2    Running         Running 17 seconds ago</span><br><span class="line">lu6u6j8ji0uq   whoami.3   traefik/whoami:latest   manager1   Running         Running 40 seconds ago</span><br><span class="line"><span class="comment"># å¦‚æœå¸Œæœ›æŸ¥è¯¢æŸä¸ªServiceçš„æ‰€æœ‰å®¹å™¨çš„IDï¼Œå¯ä»¥æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</span></span><br><span class="line">docker service ps <span class="built_in">whoami</span> -q | xargs docker inspect --format <span class="string">&#x27;&#123;&#123;.Status.ContainerStatus.ContainerID&#125;&#125;&#x27;</span> | <span class="built_in">cut</span> -c 1-12</span><br><span class="line">a3fb63bde8e7</span><br><span class="line">a14e30a02987</span><br><span class="line">549610f3a1e9</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ­¤æ—¶æˆ‘ä»¬é€šè¿‡curlè®¿é—® Swarm é›†ç¾¤ä¸­çš„ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹çš„IPï¼Œéƒ½å¯ä»¥è®¿é—®åˆ°è¿™ä¸ªæœåŠ¡ï¼Œæ¯”å¦‚ <code>curl 10.211.55.12</code>ï¼Œè¿™æ˜¯ manager3 èŠ‚ç‚¹çš„ IP åœ°å€ï¼Œè™½ç„¶è¿™ä¸ªæœåŠ¡å¹¶æ²¡æœ‰åœ¨ manager3 èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œä½†æ˜¯æˆ‘ä»¬ä¾æ—§å¯ä»¥è®¿é—®åˆ°è¿™ä¸ªæœåŠ¡ï¼Œä¸ä»…å¦‚æ­¤ï¼Œæ¯æ¬¡è¿è¡Œå‘½ä»¤è¿”å›çš„Hostname(å°±æ˜¯å®¹å™¨ID)éƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå…¶æ•ˆæœå°±æ˜¯åœ¨å„ä¸ªè¿è¡Œçš„å®¹å™¨é—´è½®è¯¢ï¼Œè¿™å°±æ˜¯ Swarm é›†ç¾¤çš„è´Ÿè½½å‡è¡¡æ•ˆæœã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.211.55.12</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">Hostname: a3fb63bde8e7   <span class="comment"># å®¹å™¨ID</span></span><br><span class="line">IP: 127.0.0.1</span><br><span class="line">IP: ::1</span><br><span class="line">IP: 10.0.0.36            <span class="comment"># å®¹å™¨IPï¼Œå¯¹æ¥ br0</span></span><br><span class="line">IP: 172.18.0.4           <span class="comment"># å®¹å™¨IPï¼Œå¯¹æ¥ docker_gwbridge</span></span><br><span class="line">RemoteAddr: 10.0.0.6:52964</span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: 10.211.55.12</span><br><span class="line">User-Agent: curl/7.61.1</span><br><span class="line">Accept: */*</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åœ¨é›†ç¾¤å†…éƒ¨è®¿é—®æœåŠ¡ï¼Œå»ºè®®å°†æ‰€æœ‰æœåŠ¡è¿è¡Œåœ¨ç›¸åŒçš„networkä¸­ï¼Œè¿™æ ·å¯ä»¥ä¸åŒçš„serviceä¹‹é—´å¯ä»¥é€šè¿‡æœåŠ¡åç§°è®¿é—®æœåŠ¡ï¼Œåœ¨é›†ç¾¤å¤–éƒ¨ï¼Œå¯ä»¥é€šè¿‡nginxç­‰ä»£ç†è®¿é—®æœåŠ¡ã€‚</p></li><li class="lvl-2"><p>å¯ä»¥ç¼–å†™ä¸€ä¸ªè„šæœ¬æ–¹ä¾¿æŸ¥çœ‹serviceä¸containerçš„è¿è¡Œå…³ç³»ï¼Œæ¯”å¦‚ï¼šdocker_service_container</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># filename: docker_service_container</span></span><br><span class="line"><span class="comment"># ç”¨æ³•æç¤º</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$1</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;ç”¨æ³•: <span class="variable">$0</span> &lt;SERVICE_NAME&gt;&quot;</span></span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment"># serviceåç§°</span></span><br><span class="line">SERVCIE_NAME=<span class="variable">$1</span></span><br><span class="line"><span class="comment"># æ‰€å±network,é»˜è®¤ ingressï¼Œè¿™é‡Œè¦æ³¨æ„ä¸€ä¸‹ï¼Œå¦‚æœæ˜¯è‡ªå®šä¹‰çš„overlayç½‘ç»œï¼Œåªèƒ½è·å–åˆ°å½“å‰ä¸»æœºä¸Šçš„å®¹å™¨IP</span></span><br><span class="line">NETWORK=<span class="variable">$2</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$2</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  NETWORK=$(docker service inspect <span class="variable">$SERVCIE_NAME</span> --format <span class="string">&#x27;&#123;&#123;json .Endpoint.VirtualIPs&#125;&#125;&#x27;</span> | jq <span class="string">&#x27;.[0].NetworkID&#x27;</span> | sed <span class="string">&#x27;s/&quot;//g&#x27;</span>)</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># NETWORK=$&#123;2:-ingress&#125;</span></span><br><span class="line"></span><br><span class="line">d1=$(<span class="built_in">echo</span> -e <span class="string">&quot;SERVICE-ID TASK-ID CONTAINER-ID NODE-ID&quot;</span> | awk <span class="string">&#x27;&#123;printf &quot;%-12s    %-12s    %-12s    %-12s\n&quot;, substr($1,1,12), substr($2,1,12), substr($3,1,12), substr($4,1,12)&#125;&#x27;</span> ;\</span><br><span class="line">docker service ps <span class="variable">$SERVCIE_NAME</span> --filter <span class="string">&quot;desired-state=running&quot;</span> -q | xargs docker inspect --format <span class="string">&#x27;&#123;&#123;.ServiceID&#125;&#125;    &#123;&#123;.ID&#125;&#125;    &#123;&#123;.Status.ContainerStatus.ContainerID&#125;&#125;    &#123;&#123;.NodeID&#125;&#125;&#x27;</span> \</span><br><span class="line">| awk <span class="string">&#x27;&#123;printf &quot;%-12s    %-12s    %-12s    %-12s\n&quot;, substr($1,1,12), substr($2,1,12), substr($3,1,12), substr($4,1,12)&#125;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#echo &quot;$d1&quot;</span></span><br><span class="line"></span><br><span class="line">d2=$(docker service ps <span class="variable">$SERVCIE_NAME</span> --filter <span class="string">&quot;desired-state=running&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#echo &quot;$d2&quot;</span></span><br><span class="line"></span><br><span class="line">nn1=$(awk <span class="string">&#x27;</span></span><br><span class="line"><span class="string">NR==FNR &amp;&amp; FNR &gt; 1 &#123;</span></span><br><span class="line"><span class="string">  id = $1</span></span><br><span class="line"><span class="string">  name = $2</span></span><br><span class="line"><span class="string">  node = $4</span></span><br><span class="line"><span class="string">  desired = $5</span></span><br><span class="line"><span class="string">  # æ‹¼æ¥ CURRENT STATEï¼ˆä»ç¬¬6åˆ—å¼€å§‹çš„æ‰€æœ‰å­—æ®µï¼‰</span></span><br><span class="line"><span class="string">  current = &quot;&quot;</span></span><br><span class="line"><span class="string">  for (i=6; i&lt;=NF; i++) &#123;</span></span><br><span class="line"><span class="string">    current = current $i &quot; &quot;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  gsub(/ /, &quot;-&quot;, current)</span></span><br><span class="line"><span class="string">  current = substr(current, 1, length(current)-1)  # å»æ‰æœ€åç©ºæ ¼</span></span><br><span class="line"><span class="string">  info[id] = name &quot;\t&quot; node &quot;\t&quot; desired &quot;\t&quot; current</span></span><br><span class="line"><span class="string">  next</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">FNR==1 &#123;</span></span><br><span class="line"><span class="string">  print $0 &quot;\tTASK-NAME\tNODE\tDESIRED_STATE\tCURRENT_STATE&quot;</span></span><br><span class="line"><span class="string">  next</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  print $0 &quot;\t&quot; info[$2]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;</span> &lt;(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$d2</span>&quot;</span>) &lt;(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$d1</span>&quot;</span>) | <span class="built_in">tail</span> -n +2 | column -t)</span><br><span class="line"></span><br><span class="line">nn2=$(<span class="built_in">echo</span> <span class="string">&quot;CONTAINER-ID IP&quot;</span>;docker network inspect <span class="variable">$&#123;NETWORK&#125;</span> -f <span class="string">&#x27;&#123;&#123;range $id, $container := .Containers&#125;&#125;&#123;&#123;slice $id 0 12&#125;&#125; &#123;&#123;$container.Name&#125;&#125; &#123;&#123;$container.IPv4Address&#125;&#125;&#123;&#123;println&#125;&#125;&#123;&#123;end&#125;&#125;&#x27;</span> | grep <span class="variable">$SERVCIE_NAME</span> | awk -F <span class="string">&quot; &quot;</span> <span class="string">&#x27;&#123;print $1&quot; &quot;$3&#125;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">awk <span class="string">&#x27;</span></span><br><span class="line"><span class="string">NR==FNR &#123; ip[$1]=$2; next &#125;</span></span><br><span class="line"><span class="string">&#123; print $0, ip[$3] &#125;</span></span><br><span class="line"><span class="string">&#x27;</span> &lt;(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$nn2</span>&quot;</span>) &lt;(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$nn1</span>&quot;</span>) | column -t</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>è¿è¡Œ</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x /usr/local/bin/docker-swarm-service</span><br><span class="line"><span class="comment"># æ‰§è¡Œè„šæœ¬</span></span><br><span class="line">docker-swarm-service <span class="built_in">whoami</span></span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">SERVICE-ID    TASK-ID       CONTAINER-ID  NODE-ID       TASK-NAME  NODE      DESIRED_STATE  CURRENT_STATE              IP</span><br><span class="line">snuhv0g2dm1q  czisrjrp8k2t  9e4ce349971c  kp2zerd28xgz  whoami.1   manager1  Running        Running-about-an-hour-ago  10.0.0.35/24</span><br><span class="line">snuhv0g2dm1q  tvbkwmnafedw  0d586021260d  kp2zerd28xgz  whoami.2   manager1  Running        Running-about-an-hour-ago  10.0.0.36/24</span><br><span class="line">snuhv0g2dm1q  815qp859a1f4  449d5e1a231d  kp2zerd28xgz  whoami.3   manager1  Running        Running-about-an-hour-ago  10.0.0.15/24</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **åŠ ç²—**
 *æ–œä½“*
 ***åŠ ç²—å¹¶æ–œä½“***
 ~~åˆ é™¤çº¿~~
 ==çªå‡ºæ˜¾ç¤º==
 `çªå‡ºæ˜¾ç¤º(æ¨è)`
 ++ä¸‹åˆ’çº¿++
 ~ä¸‹æ ‡~
 ^ä¸Šæ ‡^
 è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.
 å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **ç‚¹å‡»æŠ˜å **
 è¿™æ˜¯è¢«éšè—çš„å†…å®¹
 +++

::: tips success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
:::

% note info % success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
% endnote %

å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}
 å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ
 --&gt;
&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;æœ¬æ–‡ä»‹ç» Docker Swarm çš„ æœåŠ¡ç®¡ç†&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com&quot;&gt;Dockerå®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com/engine/swarm/&quot;&gt;Docker Swarm å®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/docker/"/>
    
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>Docker Swarm ä¹‹ èŠ‚ç‚¹(Node)</title>
    <link href="https://blog.hanqunfeng.com/2025/06/09/docker-swarm-node/"/>
    <id>https://blog.hanqunfeng.com/2025/06/09/docker-swarm-node/</id>
    <published>2025-06-09T13:30:05.000Z</published>
    <updated>2025-06-10T06:00:11.021Z</updated>
    
    <content type="html"><![CDATA[<!-- **åŠ ç²—** *æ–œä½“* ***åŠ ç²—å¹¶æ–œä½“*** ~~åˆ é™¤çº¿~~ ==çªå‡ºæ˜¾ç¤º== `çªå‡ºæ˜¾ç¤º(æ¨è)` ++ä¸‹åˆ’çº¿++ ~ä¸‹æ ‡~ ^ä¸Šæ ‡^ è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference. å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **ç‚¹å‡»æŠ˜å ** è¿™æ˜¯è¢«éšè—çš„å†…å®¹ +++::: tips success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹:::% note info % success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹% endnote %å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{} å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ --><h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2"><p>æœ¬æ–‡ä»‹ç» Docker Swarm çš„ èŠ‚ç‚¹ç®¡ç†</p></li><li class="lvl-2"><p><a href="https://docs.docker.com">Dockerå®˜æ–¹æ–‡æ¡£</a></p></li><li class="lvl-2"><p><a href="https://docs.docker.com/engine/swarm/">Docker Swarm å®˜æ–¹æ–‡æ¡£</a></p></li></ul><span id="more"></span><h2 id="Docker-Swarm-ç®€ä»‹">Docker Swarm ç®€ä»‹</h2><ul class="lvl-0"><li class="lvl-2"><p>Docker Swarm æ˜¯ Docker å®˜æ–¹æä¾›çš„ä¸€ä¸ªé›†ç¾¤ç®¡ç†å·¥å…·ï¼ŒåŸºäº Docker Swarm å¯ä»¥å¿«é€Ÿå®ç° Docker é›†ç¾¤çš„ç®¡ç†ã€‚</p></li><li class="lvl-2"><p>ä» Docker v1.12 ç‰ˆæœ¬å¼€å§‹ï¼ŒDocker Swarm å·²ç»åŒ…å«åœ¨ Docker Engine ä¸­ï¼Œä¸éœ€è¦å•ç‹¬å®‰è£…ã€‚</p></li><li class="lvl-2"><p>Docker Swarm å…·æœ‰æœåŠ¡ç¼–æ’ã€æœåŠ¡è´Ÿè½½å‡è¡¡ã€æœåŠ¡å‡çº§å’ŒæœåŠ¡å¤±è´¥è¿ç§»ç­‰åŠŸèƒ½ã€‚</p></li><li class="lvl-2"><p>Docker Swarm é›†ç¾¤ä¸­çš„èŠ‚ç‚¹åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼šç®¡ç†èŠ‚ç‚¹(Manager Node)å’Œå·¥ä½œèŠ‚ç‚¹(Worker Node)ï¼Œç®¡ç†èŠ‚ç‚¹è´Ÿè´£é›†ç¾¤çš„ç®¡ç†ï¼Œå·¥ä½œèŠ‚ç‚¹è´Ÿè´£è¿è¡Œå®¹å™¨ã€‚<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/KwTed9.png" alt=""></p></li><li class="lvl-2"><p>ä»¥ä¸‹æ˜¯ Docker Swarm ä¸­ ç®¡ç†èŠ‚ç‚¹ï¼ˆManager Nodeï¼‰ å’Œ å·¥ä½œèŠ‚ç‚¹ï¼ˆWorker Nodeï¼‰ çš„å¯¹æ¯”</p></li></ul><table><thead><tr><th>ç‰¹æ€§/åŠŸèƒ½</th><th>ç®¡ç†èŠ‚ç‚¹ï¼ˆManager Nodeï¼‰</th><th>å·¥ä½œèŠ‚ç‚¹ï¼ˆWorker Nodeï¼‰</th></tr></thead><tbody><tr><td>è§’è‰²</td><td>è´Ÿè´£é›†ç¾¤ç®¡ç†å’Œå†³ç­–</td><td>æ‰§è¡Œåˆ†é…çš„æœåŠ¡ä»»åŠ¡</td></tr><tr><td>æ˜¯å¦å‚ä¸æœåŠ¡è¿è¡Œ</td><td>å¯ä»¥è¿è¡ŒæœåŠ¡ä»»åŠ¡ï¼Œä¹Ÿå¯ä»¥åªåšç®¡ç†ï¼ˆå¯é…ç½®ï¼‰</td><td>ä»…è¿è¡ŒæœåŠ¡ä»»åŠ¡ï¼Œä¸å‚ä¸ç®¡ç†å†³ç­–</td></tr><tr><td>é›†ç¾¤çŠ¶æ€ç»´æŠ¤</td><td>ç»´æŠ¤æ•´ä¸ª Swarm çš„çŠ¶æ€ï¼ˆä½¿ç”¨ Raft åè®®ï¼‰</td><td>ä¸ç»´æŠ¤é›†ç¾¤çŠ¶æ€</td></tr><tr><td>è°ƒåº¦ä»»åŠ¡</td><td>å†³å®šå°†æœåŠ¡ä»»åŠ¡åˆ†é…ç»™å“ªä¸ªèŠ‚ç‚¹</td><td>ä¸è´Ÿè´£è°ƒåº¦ï¼Œåªæ‰§è¡Œæ¥æ”¶åˆ°çš„ä»»åŠ¡</td></tr><tr><td>ç®¡ç†å‘½ä»¤å¤„ç†</td><td>æ¥æ”¶å¹¶å¤„ç† Swarm ç®¡ç†å‘½ä»¤ï¼ˆå¦‚åˆ›å»ºæœåŠ¡ã€æ‰©ç¼©å®¹ç­‰ï¼‰</td><td>ä¸å¤„ç†ç®¡ç†å‘½ä»¤</td></tr><tr><td>æ•°æ®ä¸€è‡´æ€§</td><td>éœ€è¦ä¿æŒä¸€è‡´æ€§ï¼ˆè‡³å°‘ 3 ä¸ªç®¡ç†èŠ‚ç‚¹å½¢æˆé«˜å¯ç”¨ï¼‰</td><td>ä¸æ¶‰åŠä¸€è‡´æ€§</td></tr><tr><td>èµ„æºè¦æ±‚</td><td>ç›¸å¯¹è¾ƒé«˜ï¼Œéœ€è¦æ‰¿æ‹…ç®¡ç†å’Œåè°ƒå¼€é”€</td><td>ç›¸å¯¹è¾ƒä½ï¼Œä¸“æ³¨äºè¿è¡Œå®¹å™¨</td></tr><tr><td>å¯ç”¨æ€§è¦æ±‚</td><td>é€šå¸¸é…ç½®å¥‡æ•°ä¸ªï¼ˆ3ã€5ã€7â€¦ï¼‰ä»¥ä¿éšœé«˜å¯ç”¨</td><td>å¯æ ¹æ®éœ€è¦è‡ªç”±æ‰©å±•æˆ–ç¼©å‡</td></tr><tr><td>èŠ‚ç‚¹åŠ å…¥æ–¹å¼</td><td>é€šè¿‡ manager token åŠ å…¥ Swarm</td><td>é€šè¿‡ worker token åŠ å…¥ Swarm</td></tr><tr><td>æ•…éšœå½±å“</td><td>å¤šä¸ªç®¡ç†èŠ‚ç‚¹æ•…éšœå¯èƒ½å½±å“æ•´ä¸ª Swarm çš„æ§åˆ¶èƒ½åŠ›</td><td>éƒ¨åˆ†å·¥ä½œèŠ‚ç‚¹æ•…éšœé€šå¸¸ä¸ä¼šå½±å“ Swarm çš„ç®¡ç†èƒ½åŠ›</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>manager èŠ‚ç‚¹é€šå¸¸é…ç½®ä¸ºå¥‡æ•°ä¸ªï¼Œé»˜è®¤åˆ›å»ºé›†ç¾¤çš„èŠ‚ç‚¹å°±æ˜¯ manager èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ˜¯ manager èŠ‚ç‚¹ä¸­çš„çš„ Leader èŠ‚ç‚¹ã€‚Leader èŠ‚ç‚¹è´Ÿè´£ç®¡ç†é›†ç¾¤ï¼ŒLeader èŠ‚ç‚¹åœ¨é›†ç¾¤ä¸­åªèƒ½æœ‰ä¸€ä¸ªã€‚å½“ Leader èŠ‚ç‚¹æ•…éšœæ—¶ï¼ŒSwarm ä¼šè‡ªåŠ¨ä»å…¶å®ƒ manager èŠ‚ç‚¹ä¸­é€‰ä¸¾å‡ºä¸€ä¸ªæ–°çš„ Leader èŠ‚ç‚¹ã€‚</p></li><li class="lvl-2"><p>worker èŠ‚ç‚¹æ˜¯è¿è¡Œå®¹å™¨çš„èŠ‚ç‚¹ï¼Œä¸å‚ä¸æœºå™¨çš„ç®¡ç†å’Œè°ƒåº¦ï¼Œä¸æ”¯æŒæ‰§è¡Œä»»ä½•å’Œé›†ç¾¤ç®¡ç†ç›¸å…³çš„æ“ä½œã€‚</p></li><li class="lvl-2"><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œmanager èŠ‚ç‚¹ä¹Ÿä¼šå‚ä¸æ¥æ”¶è¿è¡Œå®¹å™¨çš„ä»»åŠ¡ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡è®¾ç½®æ¥æŒ‡å®š manager èŠ‚ç‚¹ä¸å‚ä¸æ¥æ”¶ä»»åŠ¡ã€‚</p></li><li class="lvl-2"><p>manager èŠ‚ç‚¹å’Œ worker èŠ‚ç‚¹å¯ä»¥é€šè¿‡â€œå‡çº§â€å’Œâ€œé™çº§â€ç›¸äº’è½¬æ¢ã€‚</p></li></ul><h2 id="æ­å»ºSwarmé›†ç¾¤">æ­å»ºSwarmé›†ç¾¤</h2><ul class="lvl-0"><li class="lvl-2"><p>æœ¬æ•™ç¨‹éœ€è¦äº”å°å®‰è£…äº†Dockerä¸”èƒ½å¤Ÿé€šè¿‡ç½‘ç»œé€šä¿¡çš„ Linux ä¸»æœºï¼Œè¿™äº›ä¸»æœºå¯ä»¥æ˜¯ç‰©ç†æœºã€è™šæ‹Ÿæœºã€Amazon EC2 å®ä¾‹ï¼Œä¹Ÿå¯ä»¥ä»¥å…¶ä»–æ–¹å¼æ‰˜ç®¡ã€‚</p></li><li class="lvl-2"><p>å…¶ä¸­ä¸‰å°æœºå™¨æ˜¯ç®¡ç†èŠ‚ç‚¹ï¼ˆç§°ä¸ºmanager1,manager2,manager3ï¼‰ï¼Œå¦å¤–ä¸¤å°æ˜¯å·¥ä½œèŠ‚ç‚¹ï¼ˆworker1å’Œworker2ï¼‰ã€‚</p></li></ul><table><thead><tr><th>IP åœ°å€</th><th>HostName</th><th>è§’è‰²ç±»å‹</th></tr></thead><tbody><tr><td>10.211.55.10</td><td>manager1</td><td>ç®¡ç†èŠ‚ç‚¹</td></tr><tr><td>10.211.55.11</td><td>manager2</td><td>ç®¡ç†èŠ‚ç‚¹</td></tr><tr><td>10.211.55.12</td><td>manager3</td><td>ç®¡ç†èŠ‚ç‚¹</td></tr><tr><td>10.211.55.13</td><td>worker1</td><td>å·¥ä½œèŠ‚ç‚¹</td></tr><tr><td>10.211.55.14</td><td>worker2</td><td>å·¥ä½œèŠ‚ç‚¹</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>æ‰€æœ‰ä¸»æœºä¸Šå¿…é¡»å¼€å¯å¦‚ä¸‹ç«¯å£ï¼Œä»¥ç¡®ä¿Docker Swarm é›†ç¾¤æ­£å¸¸é€šä¿¡ï¼š</p></li></ul><table><thead><tr><th>ç«¯å£å·</th><th>åè®®</th><th>ç”¨é€”è¯´æ˜</th></tr></thead><tbody><tr><td>2377</td><td>TCP</td><td>ç®¡ç†å™¨èŠ‚ç‚¹ä¹‹é—´é€šä¿¡ï¼ˆç®¡ç†æŒ‡ä»¤å’ŒåŠ å…¥é›†ç¾¤ï¼‰</td></tr><tr><td>7946</td><td>TCP/UDP</td><td>èŠ‚ç‚¹å‘ç°å’Œé€šä¿¡ï¼ˆé›†ç¾¤å†…éƒ¨å‘ç°æœºåˆ¶ï¼‰</td></tr><tr><td>4789</td><td>UDP</td><td>è¦†ç›–ç½‘ç»œæµé‡ï¼ˆVXLANï¼Œç”¨äºå®¹å™¨é—´ç½‘ç»œï¼‰</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¼€æ”¾ Swarm ç®¡ç†èŠ‚ç‚¹é€šä¿¡ç«¯å£</span></span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --permanent --add-port=2377/tcp</span><br><span class="line"></span><br><span class="line"><span class="comment"># èŠ‚ç‚¹å‘ç°ï¼ˆcluster communicationï¼‰</span></span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --permanent --add-port=7946/tcp</span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --permanent --add-port=7946/udp</span><br><span class="line"></span><br><span class="line"><span class="comment"># overlay ç½‘ç»œæµé‡ï¼ˆå®¹å™¨é—´é€šä¿¡ï¼‰</span></span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --permanent --add-port=4789/udp</span><br><span class="line"></span><br><span class="line"><span class="comment"># åº”ç”¨æ›´æ”¹</span></span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€</span></span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --list-all</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ‰€æœ‰ä¸»æœºå¿…é¡»æ—¶é—´ä¸€è‡´</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŒæ­¥ç³»ç»Ÿæ—¶é—´</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl restart chronyd</span><br><span class="line">chronyc tracking</span><br><span class="line"><span class="comment"># åŒæ­¥åç³»ç»Ÿæ—¶é—´æ˜¾ç¤ºä¸º UTCï¼Œè€Œä¸æ˜¯ä¸­å›½æ—¶åŒºï¼ˆCST/Asia/Shanghaiï¼‰</span></span><br><span class="line"><span class="comment"># è®¾ç½®æ—¶åŒºä¸ºä¸­å›½ä¸Šæµ·æ—¶é—´ï¼ˆCSTï¼‰</span></span><br><span class="line"><span class="built_in">sudo</span> timedatectl set-timezone Asia/Shanghai</span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ—¶é—´å’Œæ—¶åŒº</span></span><br><span class="line">timedatectl</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºé›†ç¾¤">åˆ›å»ºé›†ç¾¤</h3><ul class="lvl-0"><li class="lvl-2"><p>åœ¨ manager1 èŠ‚ç‚¹ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„swarmé›†ç¾¤</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å½“å‰dockerçš„swarmæ¨¡å¼æ˜¯å¦å¼€å¯</span></span><br><span class="line">docker info | grep <span class="string">&quot;Swarm&quot;</span></span><br><span class="line"><span class="comment">## è¾“å‡ºï¼Œ inactive è¡¨ç¤ºæ²¡æœ‰å¼€å¯swarmé›†ç¾¤</span></span><br><span class="line"> Swarm: inactive</span><br><span class="line"></span><br><span class="line"><span class="comment"># é›†ç¾¤åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment"># docker swarm init --advertise-addr &lt;MANAGER-IP&gt;</span></span><br><span class="line">docker swarm init --advertise-addr 10.211.55.10</span><br><span class="line"><span class="comment">## å‚æ•°è¯´æ˜</span></span><br><span class="line"><span class="comment"># --advertise-addrï¼šæŒ‡å®šå½“å‰èŠ‚ç‚¹çš„IPåœ°å€ï¼Œç”¨äºé›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹å‘ç°å½“å‰èŠ‚ç‚¹ï¼Œç«¯å£é»˜è®¤2377</span></span><br><span class="line"><span class="comment"># è¿™ä¸ªå‚æ•°æ˜¯å¯é€‰çš„ï¼Œå¦‚æœèŠ‚ç‚¹ä¸Šå­˜åœ¨å¤šä¸ªç½‘å¡ï¼Œåˆ™éœ€è¦æŒ‡å®šå½“å‰èŠ‚ç‚¹çš„IPåœ°å€</span></span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line"><span class="comment"># swarm åˆå§‹åŒ–æˆåŠŸï¼Œå½“å‰èŠ‚ç‚¹æˆä¸º manager nodeï¼Œå¹¶è‡ªåŠ¨æˆä¸ºé›†ç¾¤çš„leader</span></span><br><span class="line">Swarm initialized: current node (kp2zerd28xgz5mmglnje0jp22) is now a manager.</span><br><span class="line"><span class="comment"># å°†ä¸€ä¸ªworker nodeåŠ å…¥é›†ç¾¤è¯·è¿è¡Œä¸‹é¢çš„å‘½ä»¤</span></span><br><span class="line">To add a worker to this swarm, run the following <span class="built_in">command</span>:</span><br><span class="line">    <span class="comment"># è¿™ä¸ªtokenä¸éœ€è¦è®°ä½ï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤ `docker swarm join-token worker` è·å–</span></span><br><span class="line">    docker swarm <span class="built_in">join</span> --token SWMTKN-1-256y3fmlkr5u76a5lor7jsboox2eztl954djhnuoj4p2x7dem4-0izbgc1xv73qulz31szmxnk3y 10.211.55.10:2377</span><br><span class="line"><span class="comment"># æ·»åŠ ä¸€ä¸ªmanager nodeéœ€è¦æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤è·å– manager token</span></span><br><span class="line">To add a manager to this swarm, run <span class="string">&#x27;docker swarm join-token manager&#x27;</span> and follow the instructions.</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†æ¬¡æŸ¥çœ‹å½“å‰dockerçš„swarmæ¨¡å¼æ˜¯å¦å¼€å¯</span></span><br><span class="line">docker info | grep Swarm</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line"> Swarm: active</span><br><span class="line"></span><br><span class="line"><span class="comment"># è‹¥è¦æŸ¥çœ‹æ›´ä¸ºè¯¦ç»†çš„ä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥æŸ¥çœ‹ Swarm ä¸­çš„ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ä¸»è¦ä¿¡æ¯ï¼Œæ­¤æ—¶é›†ç¾¤ä¸­åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”æ˜¯managerèŠ‚ç‚¹</span></span><br><span class="line">docker info --format <span class="string">&#x27;&#123;&#123;json .Swarm&#125;&#125;&#x27;</span> | jq <span class="string">&#x27;&#123;LocalNodeState,NodeID,NodeAddr,RemoteManagers,Nodes,Nodes,Managers,ControlAvailable&#125;&#x27;</span> | yq -P</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">LocalNodeState: active         <span class="comment"># èŠ‚ç‚¹çŠ¶æ€</span></span><br><span class="line">NodeID: kp2zerd28xgz5mmglnje0jp22 <span class="comment"># èŠ‚ç‚¹ID</span></span><br><span class="line">NodeAddr: 10.211.55.10           <span class="comment"># èŠ‚ç‚¹IP</span></span><br><span class="line">RemoteManagers: [                <span class="comment"># èŠ‚ç‚¹ç®¡ç†èŠ‚ç‚¹ä¿¡æ¯</span></span><br><span class="line">  - NodeID: kp2zerd28xgz5mmglnje0jp22 <span class="comment"># èŠ‚ç‚¹ç®¡ç†èŠ‚ç‚¹ID</span></span><br><span class="line">    Addr: 10.211.55.10:2377       <span class="comment"># èŠ‚ç‚¹ç®¡ç†èŠ‚ç‚¹åœ°å€</span></span><br><span class="line">Nodes: 1                          <span class="comment"># èŠ‚ç‚¹æ•°é‡</span></span><br><span class="line">Managers: 1                       <span class="comment"># ç®¡ç†èŠ‚ç‚¹æ•°é‡</span></span><br><span class="line">ControlAvailable: <span class="literal">true</span>            <span class="comment"># æ˜¯å¦æœ‰æ§åˆ¶èŠ‚ç‚¹</span></span><br></pre></td></tr></table></figure><div class="tips"><p><em><strong>å®‰è£… yq å·¥å…·</strong></em></p><ul class="lvl-1"><li class="lvl-2">yq æ˜¯ yaml çš„å‘½ä»¤è¡Œå¤„ç†å·¥å…·ï¼Œå…·ä½“å‚è€ƒ<a href="https://github.com/mikefarah/yq">yq</a></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½ yq æœ€æ–°ç‰ˆæœ¬</span></span><br><span class="line">VERSION=v4.45.4</span><br><span class="line">ARCH=amd64</span><br><span class="line">wget https://github.com/mikefarah/yq/releases/download/<span class="variable">$&#123;VERSION&#125;</span>/yq_linux_<span class="variable">$&#123;ARCH&#125;</span> -O /usr/local/bin/yq</span><br><span class="line"><span class="comment"># æ·»åŠ æ‰§è¡Œæƒé™</span></span><br><span class="line"><span class="built_in">chmod</span> +x /usr/local/bin/yq</span><br><span class="line"><span class="comment"># éªŒè¯å®‰è£…</span></span><br><span class="line">yq --version</span><br></pre></td></tr></table></figure></div><h3 id="æ·»åŠ -manager-èŠ‚ç‚¹">æ·»åŠ  manager èŠ‚ç‚¹</h3><ul class="lvl-0"><li class="lvl-2"><p>è·å– manager èŠ‚ç‚¹çš„ token</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨ manager1 ä¸Šè¿è¡Œ</span></span><br><span class="line">docker swarm join-token manager</span><br><span class="line"><span class="comment">## è¾“å‡ºç»“æœ</span></span><br><span class="line">To add a manager to this swarm, run the following <span class="built_in">command</span>:</span><br><span class="line"></span><br><span class="line">    docker swarm <span class="built_in">join</span> --token SWMTKN-1-256y3fmlkr5u76a5lor7jsboox2eztl954djhnuoj4p2x7dem4-byc8ygc6hdoyzna0in1btp9yu 10.211.55.10:2377</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å°† manager2 å’Œ manager3 åŠ å…¥ swarm é›†ç¾¤</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ†åˆ«åœ¨ manager2 å’Œ manager3 ä¸Šè¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œ</span></span><br><span class="line">docker swarm <span class="built_in">join</span> \</span><br><span class="line">--token SWMTKN-1-256y3fmlkr5u76a5lor7jsboox2eztl954djhnuoj4p2x7dem4-byc8ygc6hdoyzna0in1btp9yu \</span><br><span class="line">10.211.55.10:2377</span><br><span class="line"><span class="comment">## å¦‚æœæœºå™¨ä¸Šæœ‰å¤šå—ç½‘å¡ä¹Ÿéœ€è¦æŒ‡å®šip: å¦‚ --advertise-addr 10.211.55.11</span></span><br><span class="line"><span class="comment">## è¿è¡Œç»“æœ</span></span><br><span class="line">This node joined a swarm as a manager.</span><br></pre></td></tr></table></figure><h3 id="æ·»åŠ -worker-èŠ‚ç‚¹">æ·»åŠ  worker èŠ‚ç‚¹</h3><ul class="lvl-0"><li class="lvl-2"><p>è·å– worker èŠ‚ç‚¹çš„ token</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨ manager1 ä¸Šè¿è¡Œ</span></span><br><span class="line">docker swarm join-token worker</span><br><span class="line"><span class="comment">## è¾“å‡ºç»“æœ</span></span><br><span class="line">To add a worker to this swarm, run the following <span class="built_in">command</span>:</span><br><span class="line"></span><br><span class="line">    docker swarm <span class="built_in">join</span> --token SWMTKN-1-256y3fmlkr5u76a5lor7jsboox2eztl954djhnuoj4p2x7dem4-0izbgc1xv73qulz31szmxnk3y 10.211.55.10:2377</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å°† worker1 å’Œ worker2 åŠ å…¥ swarm é›†ç¾¤</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ†åˆ«åœ¨ worker1 å’Œ worker2 ä¸Šè¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œ</span></span><br><span class="line">docker swarm <span class="built_in">join</span> \</span><br><span class="line">--token SWMTKN-1-256y3fmlkr5u76a5lor7jsboox2eztl954djhnuoj4p2x7dem4-0izbgc1xv73qulz31szmxnk3y \</span><br><span class="line">10.211.55.10:2377</span><br><span class="line"><span class="comment">## å¦‚æœæœºå™¨ä¸Šæœ‰å¤šå—ç½‘å¡ä¹Ÿéœ€è¦æŒ‡å®šip: å¦‚ --advertise-addr 10.211.55.13</span></span><br><span class="line"><span class="comment">## è¿è¡Œç»“æœ</span></span><br><span class="line">This node joined a swarm as a worker.</span><br></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹é›†ç¾¤çŠ¶æ€">æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</h3><ul class="lvl-0"><li class="lvl-2"><p>åœ¨ manager1 ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">docker info --format <span class="string">&#x27;&#123;&#123;json .Swarm&#125;&#125;&#x27;</span> | jq <span class="string">&#x27;&#123;LocalNodeState,NodeID,NodeAddr,RemoteManagers,Nodes,Nodes,Managers,ControlAvailable&#125;&#x27;</span> | yq -P</span><br><span class="line"><span class="comment">## ç»“æœ</span></span><br><span class="line">LocalNodeState: active</span><br><span class="line">NodeID: kp2zerd28xgz5mmglnje0jp22</span><br><span class="line">NodeAddr: 10.211.55.10</span><br><span class="line">RemoteManagers:</span><br><span class="line">  - NodeID: oymi74epagdqeprah7s81tsa2</span><br><span class="line">    Addr: 10.211.55.11:2377</span><br><span class="line">  - NodeID: r7388xl84nczjtnf53pwh7hla</span><br><span class="line">    Addr: 10.211.55.12:2377</span><br><span class="line">  - NodeID: kp2zerd28xgz5mmglnje0jp22</span><br><span class="line">    Addr: 10.211.55.10:2377</span><br><span class="line">Nodes: 5</span><br><span class="line">Managers: 3</span><br><span class="line">ControlAvailable: <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹é›†ç¾¤å†…èŠ‚ç‚¹ä¿¡æ¯">æŸ¥çœ‹é›†ç¾¤å†…èŠ‚ç‚¹ä¿¡æ¯</h3><ul class="lvl-0"><li class="lvl-2"><p>åœ¨ ä»»æ„ manager èŠ‚ç‚¹ä¸Šè¿è¡Œå¦‚ä¸‹å‘½ä»¤</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨ manager1 ä¸Šè¿è¡Œï¼Œåˆ—å‡ºæ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯ï¼Œåªæœ‰ manager èŠ‚ç‚¹æ”¯æŒ node ç›¸å…³å‘½ä»¤</span></span><br><span class="line">docker node <span class="built_in">ls</span></span><br><span class="line"><span class="comment">## è¿è¡Œç»“æœ</span></span><br><span class="line">ID                            HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION</span><br><span class="line">kp2zerd28xgz5mmglnje0jp22 *   manager1   Ready     Active         Leader           26.1.3</span><br><span class="line">oymi74epagdqeprah7s81tsa2     manager2   Ready     Active         Reachable        26.1.3</span><br><span class="line">r7388xl84nczjtnf53pwh7hla     manager3   Ready     Active         Reachable        26.1.3</span><br><span class="line">v31visfparkcsr9hswkb6v09u     worker1    Ready     Active                          26.1.3</span><br><span class="line">lsxj50x8ftqw8etvz5y37xc5q     worker2    Ready     Active                          26.1.3</span><br></pre></td></tr></table></figure><table><thead><tr><th>å­—æ®µå</th><th>ç¤ºä¾‹å€¼</th><th>ä¸­æ–‡å«ä¹‰</th></tr></thead><tbody><tr><td><strong>ID</strong></td><td><code>kp2zerd28xgz5mmglnje0jp22</code></td><td>èŠ‚ç‚¹çš„å”¯ä¸€ IDï¼ˆåœ¨ swarm é›†ç¾¤ä¸­è‡ªåŠ¨ç”Ÿæˆçš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼‰</td></tr><tr><td><strong>HOSTNAME</strong></td><td><code>manager1</code></td><td>èŠ‚ç‚¹çš„ä¸»æœºåï¼ˆå³åŠ å…¥ swarm é›†ç¾¤æ—¶è¯¥èŠ‚ç‚¹çš„ <code>hostname</code>ï¼‰</td></tr><tr><td><strong>STATUS</strong></td><td><code>Ready</code></td><td>èŠ‚ç‚¹çš„çŠ¶æ€ï¼š<br>â€¢ <code>Ready</code>ï¼šèŠ‚ç‚¹æ­£å¸¸è¿è¡Œä¸­<br>â€¢ <code>Down</code>ï¼šèŠ‚ç‚¹ç¦»çº¿æˆ–æ— æ³•é€šä¿¡<br>â€¢ <code>Paused</code>ï¼šæš‚åœ<br>â€¢ <code>Drain</code>ï¼šæ’ç©ºï¼Œæ­£åœ¨è¿ç§»ä»»åŠ¡</td></tr><tr><td><strong>AVAILABILITY</strong></td><td><code>Active</code></td><td>èŠ‚ç‚¹çš„å¯ç”¨æ€§è®¾ç½®ï¼š<br>â€¢ <code>Active</code>ï¼šèŠ‚ç‚¹å¯ä»¥è°ƒåº¦ä»»åŠ¡ï¼ˆé»˜è®¤ï¼‰<br>â€¢ <code>Pause</code>ï¼šæš‚åœè°ƒåº¦æ–°ä»»åŠ¡<br>â€¢ <code>Drain</code>ï¼šè¿ç§»ä»»åŠ¡å¹¶ä¸å†è°ƒåº¦</td></tr><tr><td><strong>MANAGER STATUS</strong></td><td><code>Leader</code> / <code>Reachable</code> / ç©º</td><td>ä»…é€‚ç”¨äºç®¡ç†èŠ‚ç‚¹ï¼š<br>â€¢ <code>Leader</code>ï¼šå½“å‰ swarm çš„ä¸»èŠ‚ç‚¹ï¼ˆè´Ÿè´£åè°ƒï¼‰<br>â€¢ <code>Reachable</code>ï¼šé›†ç¾¤ä¸­å¯é€šä¿¡çš„ç®¡ç†èŠ‚ç‚¹<br>â€¢ ç©ºï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹ï¼ˆéç®¡ç†èŠ‚ç‚¹ï¼‰</td></tr><tr><td><strong>ENGINE VERSION</strong></td><td><code>26.1.3</code></td><td>Docker å¼•æ“çš„ç‰ˆæœ¬å·ï¼ˆå³è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ Docker ç‰ˆæœ¬ï¼‰</td></tr></tbody></table><h2 id="docker-swarmé›†ç¾¤ç®¡ç†"><code>docker swarm</code>é›†ç¾¤ç®¡ç†</h2><table><thead><tr><th>å‘½ä»¤</th><th>ä¸­æ–‡å«ä¹‰</th></tr></thead><tbody><tr><td><code>ca</code></td><td>æ˜¾ç¤ºå’Œè½®æ¢ Swarm çš„æ ¹è¯ä¹¦ï¼ˆCAï¼‰</td></tr><tr><td><code>init</code></td><td>åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ Swarm é›†ç¾¤</td></tr><tr><td><code>join</code></td><td>å°†å½“å‰èŠ‚ç‚¹åŠ å…¥åˆ° Swarm ä¸­ï¼Œä½œä¸ºå·¥ä½œèŠ‚ç‚¹æˆ–ç®¡ç†èŠ‚ç‚¹</td></tr><tr><td><code>join-token</code></td><td>ç®¡ç†ç”¨äºåŠ å…¥ Swarm çš„ä»¤ç‰Œï¼ˆæŸ¥çœ‹æˆ–é‡æ–°ç”Ÿæˆï¼‰</td></tr><tr><td><code>leave</code></td><td>å½“å‰èŠ‚ç‚¹ç¦»å¼€ Swarm é›†ç¾¤</td></tr><tr><td><code>unlock</code></td><td>è§£é”è¢«åŠ å¯†çš„ Swarmï¼ˆç”¨äºæ¢å¤ Manager èŠ‚ç‚¹ï¼‰</td></tr><tr><td><code>unlock-key</code></td><td>ç®¡ç† Swarm çš„è§£é”å¯†é’¥ï¼ˆæŸ¥çœ‹ã€å¤‡ä»½ç­‰ï¼‰</td></tr><tr><td><code>update</code></td><td>æ›´æ–° Swarm é›†ç¾¤çš„å…¨å±€é…ç½®ï¼ˆå¦‚åŠ å¯†ã€æ—¥å¿—ç­‰ï¼‰</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p><code>docker swarm init</code>: åˆå§‹åŒ– Swarm é›†ç¾¤ï¼ˆåªåœ¨é¦–æ¬¡åˆ›å»ºæ—¶ä½¿ç”¨ï¼‰</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm init --advertise-addr 10.211.55.10</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>docker swarm join-token</code>:  ç”ŸæˆåŠ å…¥é›†ç¾¤çš„ä»¤ç‰Œ</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”Ÿæˆ worker èŠ‚ç‚¹çš„ä»¤ç‰Œ</span></span><br><span class="line">docker swarm join-token worker</span><br><span class="line"><span class="comment"># ç”Ÿæˆ manager èŠ‚ç‚¹çš„ä»¤ç‰Œ</span></span><br><span class="line">docker swarm join-token manager</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>docker swarm join</code>: åŠ å…¥ Swarm é›†ç¾¤ï¼ˆåœ¨å·²æœ‰ Swarm é›†ç¾¤ä¸­åŠ å…¥èŠ‚ç‚¹æ—¶ä½¿ç”¨ï¼‰</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm <span class="built_in">join</span> --token &lt;token&gt; 10.211.55.10:2377</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>docker swarm leave</code>: ä½¿å½“å‰èŠ‚ç‚¹ç¦»å¼€ Swarm é›†ç¾¤ï¼ˆä» Swarm é›†ç¾¤ä¸­ç§»é™¤èŠ‚ç‚¹æ—¶ä½¿ç”¨ï¼‰</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># worker èŠ‚ç‚¹ç¦»å¼€é›†ç¾¤</span></span><br><span class="line">docker swarm leave</span><br><span class="line"><span class="comment"># manager èŠ‚ç‚¹å¿…é¡»å…ˆé™çº§ä¸º workerèŠ‚ç‚¹ï¼Œæˆ–è€…åŠ ä¸Š --force å¼ºåˆ¶ç¦»å¼€</span></span><br><span class="line">docker swarm leave --force</span><br><span class="line"><span class="comment"># å¦‚æœLeaderèŠ‚ç‚¹ç¦»å¼€é›†ç¾¤ï¼Œé‚£ä¹ˆé›†ç¾¤ä¸­çš„å…¶å®ƒManagerèŠ‚ç‚¹ï¼Œä¼šé‡æ–°é€‰ä¸¾ä¸€ä¸ªæ–°çš„LeaderèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"># é›†ç¾¤ä¸­è‡³å°‘éœ€è¦ä¸€ä¸ªManagerèŠ‚ç‚¹ï¼Œå¦åˆ™æ— æ³•è¿è¡ŒæœåŠ¡</span></span><br><span class="line"><span class="comment"># èŠ‚ç‚¹ç¦»å¼€swarmé›†ç¾¤åï¼Œåœ¨ docker node lsä¸­ä»ç„¶å¯ä»¥çœ‹åˆ°ï¼Œæ¯”å¦‚å°† worker2 èŠ‚ç‚¹ä»é›†ç¾¤ä¸­ç§»é™¤ï¼Œå…¶çŠ¶æ€å˜ä¸º down</span></span><br><span class="line">docker node <span class="built_in">ls</span></span><br><span class="line">ID                            HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION</span><br><span class="line">kp2zerd28xgz5mmglnje0jp22 *   manager1   Ready     Active         Leader           26.1.3</span><br><span class="line">oymi74epagdqeprah7s81tsa2     manager2   Ready     Active         Reachable        26.1.3</span><br><span class="line">r7388xl84nczjtnf53pwh7hla     manager3   Ready     Active         Reachable        26.1.3</span><br><span class="line">v31visfparkcsr9hswkb6v09u     worker1    Ready     Active                          26.1.3</span><br><span class="line">lsxj50x8ftqw8etvz5y37xc5q     worker2    Down      Active                          26.1.3</span><br><span class="line"><span class="comment"># å¦‚éœ€å½»åº•åˆ é™¤éœ€è¦è¿è¡Œ</span></span><br><span class="line">docker node <span class="built_in">rm</span> worker2</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>docker swarm update</code>: æ›´æ–° Swarm é›†ç¾¤é…ç½®</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¼€å¯Swarmé›†ç¾¤é”å®šï¼Œåªé’ˆå¯¹managerèŠ‚ç‚¹ï¼ŒmanagerèŠ‚ç‚¹é‡å¯åéœ€è¦è§£é”æ‰èƒ½æ¢å¤ï¼Œä¸‹é¢çš„å¯†é’¥ä¸éœ€è¦è®°ä½ï¼Œé€šè¿‡`docker swarm unlock-key`å‘½ä»¤æŸ¥çœ‹</span></span><br><span class="line">docker swarm update --autolock=<span class="literal">true</span></span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">Swarm updated.</span><br><span class="line">To unlock a swarm manager after it restarts, run the `docker swarm unlock`</span><br><span class="line"><span class="built_in">command</span> and provide the following key:</span><br><span class="line"></span><br><span class="line">    SWMKEY-1-X74/FGf+SkUkJEWtYok6ZFgCDAdwt3CQpOvLPT5lra4</span><br><span class="line"></span><br><span class="line">Please remember to store this key <span class="keyword">in</span> a password manager, since without it you</span><br><span class="line">will not be able to restart the manager.</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­Swarmé›†ç¾¤é”å®š</span></span><br><span class="line">docker swarm update --autolock=<span class="literal">false</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>docker swarm unlock-key</code>: è·å–Swarmé›†ç¾¤çš„è§£é”å¯†é’¥ï¼Œè¯¥å‘½ä»¤å¯ä»¥åˆ¤æ–­Swarmé›†ç¾¤æ˜¯å¦è¢«é”å®š</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å–Swarmé›†ç¾¤çš„è§£é”å¯†é’¥</span></span><br><span class="line">docker swarm unlock-key</span><br><span class="line"><span class="comment"># è½®æ¢Swarmé›†ç¾¤çš„è§£é”å¯†é’¥</span></span><br><span class="line">docker swarm unlock-key --rotate</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>docker swarm unlock</code>: æ‰‹åŠ¨è§£é”å½“å‰ manager èŠ‚ç‚¹ï¼Œä½¿å…¶åœ¨å¯ç”¨ autolock æ—¶æ¢å¤åŠŸèƒ½</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¦‚æœSwarmé›†ç¾¤è®¾ç½®ä¸ºé”å®šï¼Œåˆ™é‡å¯manager2ä¸Šçš„dockeræœåŠ¡åå°†æ— æ³•è¿è¡Œnodeç®¡ç†å‘½ä»¤</span></span><br><span class="line">systemctl restart docker</span><br><span class="line"><span class="comment"># æŸ¥çœ‹èŠ‚ç‚¹åˆ—è¡¨</span></span><br><span class="line">docker node <span class="built_in">ls</span></span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">Error response from daemon: Swarm is encrypted and needs to be unlocked before it can be used. Please use <span class="string">&quot;docker swarm unlock&quot;</span> to unlock it.</span><br><span class="line"><span class="comment"># éœ€è¦å…ˆè§£é”æ‰å¯ä»¥è¿è¡ŒèŠ‚ç‚¹ç®¡ç†å‘½ä»¤</span></span><br><span class="line">docker swarm unlock</span><br><span class="line"><span class="comment">## ä¼šæç¤ºè¾“å…¥è§£é”å¯†é’¥ï¼Œè§£é”åå°±æ¢å¤æ­£å¸¸äº†</span></span><br><span class="line">Please enter unlock key:</span><br></pre></td></tr></table></figure><h2 id="docker-nodeèŠ‚ç‚¹ç®¡ç†"><code>docker node</code>èŠ‚ç‚¹ç®¡ç†</h2><ul class="lvl-0"><li class="lvl-2"><p>èŠ‚ç‚¹ç®¡ç†ç›¸å…³å‘½ä»¤ï¼Œåªèƒ½åœ¨ ç®¡ç†èŠ‚ç‚¹ ä¸Šæ‰§è¡Œ</p></li></ul><table><thead><tr><th>å‘½ä»¤</th><th>ä¸­æ–‡å«ä¹‰</th></tr></thead><tbody><tr><td><code>demote</code></td><td>å°†ä¸€ä¸ªæˆ–å¤šä¸ªç®¡ç†èŠ‚ç‚¹é™çº§ä¸ºå·¥ä½œèŠ‚ç‚¹</td></tr><tr><td><code>inspect</code></td><td>æ˜¾ç¤ºä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹çš„è¯¦ç»†ä¿¡æ¯</td></tr><tr><td><code>ls</code></td><td>åˆ—å‡º swarm é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹</td></tr><tr><td><code>promote</code></td><td>å°†ä¸€ä¸ªæˆ–å¤šä¸ªå·¥ä½œèŠ‚ç‚¹æå‡ä¸ºç®¡ç†èŠ‚ç‚¹</td></tr><tr><td><code>ps</code></td><td>æŸ¥çœ‹ä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹ä¸Šæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼ˆé»˜è®¤å½“å‰èŠ‚ç‚¹ï¼‰</td></tr><tr><td><code>rm</code></td><td>ä» swarm é›†ç¾¤ä¸­ç§»é™¤ä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹</td></tr><tr><td><code>update</code></td><td>æ›´æ–°èŠ‚ç‚¹çš„å…ƒæ•°æ®ï¼ˆå¦‚æ ‡ç­¾ã€å¯ç”¨æ€§ç­‰ï¼‰</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p><code>docker node ls</code>: åˆ—å‡º swarm é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker node <span class="built_in">ls</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>docker node inspect &lt;node_id&gt;/&lt;hostname&gt;</code>: æŸ¥çœ‹æŒ‡å®šèŠ‚ç‚¹çš„è¯¦ç»†ä¿¡æ¯</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker node inspect --pretty manager1</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>docker node update &lt;options&gt; &lt;node_id&gt;/&lt;hostname&gt;</code>: æ›´æ–°èŠ‚ç‚¹çš„å…ƒæ•°æ®</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®èŠ‚ç‚¹ä¸ºä¸å¯ç”¨</span></span><br><span class="line">docker node update --availability drain manager1</span><br><span class="line"><span class="comment"># æ·»åŠ æ ‡ç­¾</span></span><br><span class="line">docker node update --label-add foo=bar manager1</span><br><span class="line"><span class="comment"># åˆ é™¤æ ‡ç­¾</span></span><br><span class="line">docker node update --label-rm foo manager1</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>docker node demote &lt;node_id&gt;/&lt;hostname&gt;</code>: å°†ç®¡ç†èŠ‚ç‚¹é™çº§ä¸ºå·¥ä½œèŠ‚ç‚¹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker node demote manager1</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>docker note promote &lt;node_id&gt;/&lt;hostname&gt;</code>: å°†å·¥ä½œèŠ‚ç‚¹å‡çº§ä¸ºç®¡ç†èŠ‚ç‚¹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker node promote worker1</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>docker node rm &lt;node_id&gt;/&lt;hostname&gt;</code>: ä» swarm é›†ç¾¤ä¸­ç§»é™¤ä¸€ä¸ªèŠ‚ç‚¹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker node <span class="built_in">rm</span> manager1</span><br></pre></td></tr></table></figure><h2 id="èŠ‚ç‚¹ç®¡ç†å¸¸è§æƒ…å†µ">èŠ‚ç‚¹ç®¡ç†å¸¸è§æƒ…å†µ</h2><h3 id="å¦‚ä½•æ­£ç¡®çš„åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹">å¦‚ä½•æ­£ç¡®çš„åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹</h3><ul class="lvl-0"><li class="lvl-2"><p>1.å¦‚æœæ˜¯ manager èŠ‚ç‚¹ï¼Œå…ˆå°† manager èŠ‚ç‚¹é™çº§ä¸º worker èŠ‚ç‚¹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker node demote manager1</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>2.é€€å‡ºé›†ç¾¤</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨è¦é€€å‡ºé›†ç¾¤çš„èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</span></span><br><span class="line">docker swarm leave</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>3.åˆ é™¤èŠ‚ç‚¹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker node <span class="built_in">rm</span> manager1</span><br></pre></td></tr></table></figure><h3 id="èŠ‚ç‚¹è¢«é€€ç¾¤æˆ–åˆ é™¤åï¼Œå…¶ä¸Šè¿è¡Œçš„serviceä¼šæ€æ ·ï¼Ÿ">èŠ‚ç‚¹è¢«é€€ç¾¤æˆ–åˆ é™¤åï¼Œå…¶ä¸Šè¿è¡Œçš„serviceä¼šæ€æ ·ï¼Ÿ</h3><ul class="lvl-0"><li class="lvl-2"><p>ç”¨ä¸€ä¸ªç¤ºä¾‹æ¥è¯´æ˜ï¼Œå…ˆåœ¨ manager1 èŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ª service</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --replicas 10 è¡¨ç¤ºå¯åŠ¨ 10 ä¸ª nginx å®¹å™¨ï¼Œswarmé›†ç¾¤æœ‰5ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥å¯åŠ¨10ä¸ªnginxå®¹å™¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¼šå¯åŠ¨2ä¸ªnginxå®¹å™¨</span></span><br><span class="line">docker service create \</span><br><span class="line">  --name my-nginx \</span><br><span class="line">  --publish 8080:80 \</span><br><span class="line">  --replicas 10 \</span><br><span class="line">  nginx:latest</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æŸ¥çœ‹serviceçŠ¶æ€</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">docker service ps my-nginx</span><br><span class="line"><span class="comment">## è¾“å‡ºç»“æœï¼Œå¯ä»¥çœ‹åˆ°æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½å¯åŠ¨äº†2ä¸ªnginxå®¹å™¨</span></span><br><span class="line">ID             NAME          IMAGE          NODE       DESIRED STATE   CURRENT STATE                ERROR     PORTS</span><br><span class="line">fciheo523fb3   my-nginx.1    nginx:latest   manager2   Running         Running about a minute ago</span><br><span class="line">t9agioefr316   my-nginx.2    nginx:latest   manager2   Running         Running about a minute ago</span><br><span class="line">moitlj50nunh   my-nginx.3    nginx:latest   manager3   Running         Running 2 minutes ago</span><br><span class="line">x07voc2qth5q   my-nginx.4    nginx:latest   manager1   Running         Running about a minute ago</span><br><span class="line">p8khdhngz0xm   my-nginx.5    nginx:latest   manager3   Running         Running 2 minutes ago</span><br><span class="line">i6mieuodbrtg   my-nginx.6    nginx:latest   worker2    Running         Running about a minute ago</span><br><span class="line">2yohffzzsrrl   my-nginx.7    nginx:latest   worker1    Running         Running 2 minutes ago</span><br><span class="line">f3lusxoflqn2   my-nginx.8    nginx:latest   worker2    Running         Running about a minute ago</span><br><span class="line">xovzfmzsjlet   my-nginx.9    nginx:latest   worker1    Running         Running 2 minutes ago</span><br><span class="line">ndrz827kpu2k   my-nginx.10   nginx:latest   manager1   Running         Running about a minute ago</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>è¿™æ—¶å°† worker2 ä»é›†ç¾¤ä¸­é€€ç¾¤</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨worker2èŠ‚ç‚¹æ‰§è¡Œ</span></span><br><span class="line">docker swarm leave</span><br><span class="line"><span class="comment"># åœ¨managerèŠ‚ç‚¹æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹</span></span><br><span class="line">docker node <span class="built_in">ls</span></span><br><span class="line">ID                            HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION</span><br><span class="line">kp2zerd28xgz5mmglnje0jp22 *   manager1   Ready     Active         Leader           26.1.3</span><br><span class="line">oymi74epagdqeprah7s81tsa2     manager2   Ready     Active         Reachable        26.1.3</span><br><span class="line">r7388xl84nczjtnf53pwh7hla     manager3   Ready     Active         Reachable        26.1.3</span><br><span class="line">v31visfparkcsr9hswkb6v09u     worker1    Ready     Active                          26.1.3</span><br><span class="line">x87lfn4pzorahpr9zehv9ag3f     worker2    Down      Active                          26.1.3</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å†æ¬¡æŸ¥çœ‹serviceçŠ¶æ€</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">docker service ps my-nginx</span><br><span class="line"><span class="comment"># è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°worker2èŠ‚ç‚¹ä¸Šçš„å®¹å™¨å·²ç»è¢«å…³é—­ï¼Œæ–°çš„å®¹å™¨åœ¨å…¶å®ƒèŠ‚ç‚¹ä¸Šå¯åŠ¨äº†ï¼Œä¿è¯äº†serviceä¸­çš„å®¹å™¨æ•°é‡</span></span><br><span class="line">ID             NAME             IMAGE          NODE       DESIRED STATE   CURRENT STATE            ERROR     PORTS</span><br><span class="line">fciheo523fb3   my-nginx.1       nginx:latest   manager2   Running         Running 6 minutes ago</span><br><span class="line">t9agioefr316   my-nginx.2       nginx:latest   manager2   Running         Running 6 minutes ago</span><br><span class="line">moitlj50nunh   my-nginx.3       nginx:latest   manager3   Running         Running 6 minutes ago</span><br><span class="line">x07voc2qth5q   my-nginx.4       nginx:latest   manager1   Running         Running 6 minutes ago</span><br><span class="line">p8khdhngz0xm   my-nginx.5       nginx:latest   manager3   Running         Running 6 minutes ago</span><br><span class="line">uz7wam5ul4aa   my-nginx.6       nginx:latest   manager2   Running         Running 43 seconds ago</span><br><span class="line">i6mieuodbrtg    \_ my-nginx.6   nginx:latest   worker2    Shutdown        Running 6 minutes ago</span><br><span class="line">2yohffzzsrrl   my-nginx.7       nginx:latest   worker1    Running         Running 6 minutes ago</span><br><span class="line">34km8mzg3xat   my-nginx.8       nginx:latest   manager3   Running         Running 43 seconds ago</span><br><span class="line">f3lusxoflqn2    \_ my-nginx.8   nginx:latest   worker2    Shutdown        Running 6 minutes ago</span><br><span class="line">xovzfmzsjlet   my-nginx.9       nginx:latest   worker1    Running         Running 6 minutes ago</span><br><span class="line">ndrz827kpu2k   my-nginx.10      nginx:latest   manager1   Running         Running 6 minutes ago</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å¦‚æœä¸é€€ç¾¤ç›´æ¥åˆ é™¤èŠ‚ç‚¹å‘¢ï¼Ÿè¿™æ¬¡æˆ‘ä»¬ç›´æ¥åˆ é™¤ worker1 èŠ‚ç‚¹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ é™¤ worker1 èŠ‚ç‚¹</span></span><br><span class="line">docker node <span class="built_in">rm</span> worker1</span><br><span class="line"><span class="comment"># è¾“å‡ºï¼Œæç¤º worker1 èŠ‚ç‚¹ä¸æ˜¯ down çŠ¶æ€ï¼Œä¸èƒ½åˆ é™¤</span></span><br><span class="line"><span class="comment"># Error response from daemon: rpc error: code = FailedPrecondition desc = node v31visfparkcsr9hswkb6v09u is not down and can&#x27;t be removed</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¥ç€æˆ‘ä»¬å¼ºåˆ¶åˆ é™¤</span></span><br><span class="line">docker node <span class="built_in">rm</span> -f worker1</span><br><span class="line"><span class="comment"># æŸ¥çœ‹èŠ‚ç‚¹åˆ—è¡¨</span></span><br><span class="line">docker node <span class="built_in">ls</span></span><br><span class="line"><span class="comment"># è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°worker1èŠ‚ç‚¹å·²ç»åˆ é™¤äº†</span></span><br><span class="line">ID                            HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION</span><br><span class="line">kp2zerd28xgz5mmglnje0jp22 *   manager1   Ready     Active         Leader           26.1.3</span><br><span class="line">oymi74epagdqeprah7s81tsa2     manager2   Ready     Active         Reachable        26.1.3</span><br><span class="line">r7388xl84nczjtnf53pwh7hla     manager3   Ready     Active         Reachable        26.1.3</span><br><span class="line">x87lfn4pzorahpr9zehv9ag3f     worker2    Down      Active                          26.1.3</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†æ¬¡æŸ¥çœ‹serviceçŠ¶æ€</span></span><br><span class="line">docker service ps my-nginx</span><br><span class="line"><span class="comment">## è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°worker1(å› ä¸ºworker1èŠ‚ç‚¹å·²ç»è¢«åˆ é™¤ï¼Œæ‰€ä»¥è¿™é‡Œåªä¼šæ˜¾ç¤ºèŠ‚ç‚¹ID:v31visfparkcsr9hswkb6v09u)èŠ‚ç‚¹ä¸Šçš„å®¹å™¨å·²ç»è¢«å…³é—­ï¼Œæ–°çš„å®¹å™¨åœ¨å…¶å®ƒèŠ‚ç‚¹ä¸Šå¯åŠ¨äº†ï¼Œä¿è¯äº†serviceä¸­çš„å®¹å™¨æ•°é‡</span></span><br><span class="line">docker service ps my-nginx</span><br><span class="line">ID             NAME             IMAGE          NODE                        DESIRED STATE   CURRENT STATE                 ERROR     PORTS</span><br><span class="line">fciheo523fb3   my-nginx.1       nginx:latest   manager2                    Running         Running 12 minutes ago</span><br><span class="line">t9agioefr316   my-nginx.2       nginx:latest   manager2                    Running         Running 12 minutes ago</span><br><span class="line">moitlj50nunh   my-nginx.3       nginx:latest   manager3                    Running         Running 12 minutes ago</span><br><span class="line">x07voc2qth5q   my-nginx.4       nginx:latest   manager1                    Running         Running 12 minutes ago</span><br><span class="line">p8khdhngz0xm   my-nginx.5       nginx:latest   manager3                    Running         Running 12 minutes ago</span><br><span class="line">uz7wam5ul4aa   my-nginx.6       nginx:latest   manager2                    Running         Running 6 minutes ago</span><br><span class="line">i6mieuodbrtg    \_ my-nginx.6   nginx:latest   worker2                     Shutdown        Running 12 minutes ago</span><br><span class="line">3t4qvpvrzpg3   my-nginx.7       nginx:latest   manager1                    Running         Running about a minute ago</span><br><span class="line">2yohffzzsrrl    \_ my-nginx.7   nginx:latest   v31visfparkcsr9hswkb6v09u   Shutdown        Orphaned about a minute ago</span><br><span class="line">34km8mzg3xat   my-nginx.8       nginx:latest   manager3                    Running         Running 6 minutes ago</span><br><span class="line">f3lusxoflqn2    \_ my-nginx.8   nginx:latest   worker2                     Shutdown        Running 12 minutes ago</span><br><span class="line">4w5zfpfye3t8   my-nginx.9       nginx:latest   manager1                    Running         Running about a minute ago</span><br><span class="line">xovzfmzsjlet    \_ my-nginx.9   nginx:latest   v31visfparkcsr9hswkb6v09u   Shutdown        Orphaned about a minute ago</span><br><span class="line">ndrz827kpu2k   my-nginx.10      nginx:latest   manager1                    Running         Running 12 minutes ago</span><br></pre></td></tr></table></figure><h3 id="èŠ‚ç‚¹è¢«é€€ç¾¤æˆ–åˆ é™¤åæ˜¯å¦å¯ä»¥é‡æ–°åŠ å…¥é›†ç¾¤">èŠ‚ç‚¹è¢«é€€ç¾¤æˆ–åˆ é™¤åæ˜¯å¦å¯ä»¥é‡æ–°åŠ å…¥é›†ç¾¤</h3><ul class="lvl-0"><li class="lvl-2"><p>èŠ‚ç‚¹è¢«é€€ç¾¤æˆ–åˆ é™¤åï¼Œå¯ä»¥é€šè¿‡ <code>docker swarm join</code> å‘½ä»¤é‡æ–°åŠ å…¥é›†ç¾¤</p></li><li class="lvl-2"><p>è‹¥èŠ‚ç‚¹æ˜¯è¢«å¼ºåˆ¶åˆ é™¤ï¼Œè€Œæ²¡æœ‰é€€ç¾¤ï¼Œåˆ™é‡æ–°åŠ å…¥é›†ç¾¤æ—¶éœ€è¦å…ˆé€šè¿‡ <code>docker swarm leave</code> å‘½ä»¤é€€ç¾¤åå†åŠ å…¥é›†ç¾¤</p></li></ul><h3 id="å¦‚æœSwarmé›†ç¾¤è®¾ç½®ä¸ºé”å®šï¼Œåˆ™é‡å¯managerèŠ‚ç‚¹åæ— æ³•æä¾›é›†ç¾¤æœåŠ¡çš„è§£å†³æ–¹æ³•">å¦‚æœSwarmé›†ç¾¤è®¾ç½®ä¸ºé”å®šï¼Œåˆ™é‡å¯managerèŠ‚ç‚¹åæ— æ³•æä¾›é›†ç¾¤æœåŠ¡çš„è§£å†³æ–¹æ³•</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿™é‡Œé‡å¯ä¸€ä¸ªmanagerèŠ‚ç‚¹çš„dockeræœåŠ¡</span></span><br><span class="line">systemctl restart docker</span><br><span class="line"><span class="comment"># æŸ¥çœ‹èŠ‚ç‚¹åˆ—è¡¨</span></span><br><span class="line">docker node <span class="built_in">ls</span></span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">Error response from daemon: Swarm is encrypted and needs to be unlocked before it can be used. Please use <span class="string">&quot;docker swarm unlock&quot;</span> to unlock it.</span><br><span class="line"><span class="comment"># éœ€è¦å…ˆè§£é”æ‰å¯ä»¥è¿è¡ŒèŠ‚ç‚¹ç®¡ç†å‘½ä»¤</span></span><br><span class="line">docker swarm unlock</span><br><span class="line"><span class="comment">## ä¼šæç¤ºè¾“å…¥è§£é”å¯†é’¥ï¼Œè§£é”åå°±æ¢å¤æ­£å¸¸äº†</span></span><br><span class="line">Please enter unlock key:</span><br><span class="line"><span class="comment">## å¦‚æœå¿˜è®°äº†å¯†é’¥ï¼Œå¯ä»¥åœ¨å…¶å®ƒmanagerèŠ‚ç‚¹é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹</span></span><br><span class="line">docker swarm unlock-key</span><br><span class="line"><span class="comment"># å¦‚æœæ‰€æœ‰managerèŠ‚ç‚¹éƒ½é‡å¯äº†ï¼Œä½ åˆæ²¡æœ‰è®°å½•è§£é”å¯†é’¥ï¼Œé‚£ä¹ˆæ­å–œä½ ï¼Œåªèƒ½é‡æ–°åˆ›å»ºswarmé›†ç¾¤äº†</span></span><br></pre></td></tr></table></figure><h3 id="Swarm-é›†ç¾¤é”å®šåŠŸèƒ½çš„ä½œç”¨åŠä½¿ç”¨åœºæ™¯">Swarm é›†ç¾¤é”å®šåŠŸèƒ½çš„ä½œç”¨åŠä½¿ç”¨åœºæ™¯</h3><ul class="lvl-0"><li class="lvl-2"><p>ä½œç”¨</p></li></ul><table><thead><tr><th>âœ… ä½œç”¨</th><th>ğŸ“‹ è¯´æ˜</th></tr></thead><tbody><tr><td>åŠ å¯†ä¿æŠ¤ç®¡ç†å¯†é’¥</td><td>ç®¡ç†å™¨èŠ‚ç‚¹ä¹‹é—´çš„æ•°æ®ï¼ˆå¦‚ Raft æ—¥å¿—ï¼‰è™½ç„¶é»˜è®¤åŠ å¯†ï¼Œä½†å¯†é’¥ä¿å­˜åœ¨å†…å­˜ä¸­ã€‚å¯ç”¨é”å®šåŠŸèƒ½åï¼Œå¯†é’¥åœ¨èŠ‚ç‚¹é‡å¯æ—¶ä¸ä¼šè‡ªåŠ¨åŠ è½½ï¼Œå¿…é¡»æ‰‹åŠ¨æä¾›è§£é”å¯†é’¥æ‰èƒ½æ¢å¤ã€‚</td></tr><tr><td>é˜²æ­¢èŠ‚ç‚¹è¢«éæ³•é‡å¯ååŠ å…¥é›†ç¾¤</td><td>å¦‚æœæ”»å‡»è€…è·å¾—äº†ç®¡ç†èŠ‚ç‚¹çš„ç‰©ç†è®¿é—®æƒé™ï¼ˆå¦‚é‡å¯ã€ç£ç›˜å…‹éš†ç­‰ï¼‰ï¼Œé”å®šåŠŸèƒ½å¯ä»¥é˜²æ­¢å…¶è‡ªåŠ¨æ§åˆ¶æˆ–é‡æ–°åŠ å…¥ Swarm é›†ç¾¤ã€‚</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>åœºæ™¯</p></li></ul><table><thead><tr><th>åœºæ™¯ç±»å‹</th><th>å…·ä½“æè¿°</th></tr></thead><tbody><tr><td>âœ… é€‚åˆåœºæ™¯</td><td>å¯¹å®‰å…¨æ€§è¦æ±‚é«˜çš„ç”Ÿäº§ç¯å¢ƒ</td></tr><tr><td></td><td>éƒ¨ç½²åœ¨ä¸å¯ä¿¡æˆ–å…±äº«ç‰©ç†ç¯å¢ƒä¸­</td></tr><tr><td></td><td>äº‘æœåŠ¡å™¨ã€æ•°æ®ä¸­å¿ƒæœ‰ä¸“äººè¿ç»´ç®¡ç†è§£é”è¿‡ç¨‹</td></tr><tr><td></td><td>å¸Œæœ›é˜²æ­¢ç‰©ç†/è¿œç¨‹å…¥ä¾µè€…æ¢å¤ç®¡ç†å™¨è§’è‰²çš„å…¬å¸</td></tr><tr><td>âŒ ä¸é€‚åˆåœºæ™¯</td><td>éœ€è¦è‡ªåŠ¨åŒ–éƒ¨ç½²æˆ–é‡å¯çš„ CI/CD ç³»ç»Ÿ</td></tr><tr><td></td><td>æµ‹è¯•ç¯å¢ƒæˆ–å¼€å‘é›†ç¾¤</td></tr><tr><td></td><td>æ— äººå€¼å®ˆã€è¦æ±‚é«˜å¯ç”¨è‡ªåŠ¨æ¢å¤çš„éƒ¨ç½²ç³»ç»Ÿ</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>æ€»ç»“</p></li></ul><table><thead><tr><th>é¡¹ç›®</th><th>æ˜¯å¦æ¨è</th></tr></thead><tbody><tr><td>å®‰å…¨æ€§</td><td>âœ… å¼ºçƒˆæ¨èå¯ç”¨ï¼ˆå°¤å…¶åœ¨ç”Ÿäº§ç¯å¢ƒï¼‰</td></tr><tr><td>è‡ªåŠ¨åŒ–</td><td>âŒ ä¸æ¨èï¼ˆå¢åŠ äººå·¥å¹²é¢„æ­¥éª¤ï¼‰</td></tr><tr><td>è§£é”æ–¹å¼</td><td>è§£é”å‘½ä»¤ + unlock key</td></tr><tr><td>unlock key ä¸¢å¤±åæœ</td><td>å¯èƒ½éœ€è¦é‡å»º Swarmï¼ˆé™¤éæå‰å¤‡ä»½ï¼‰</td></tr></tbody></table><h3 id="docker-swarm-ca-æ˜¯åšä»€ä¹ˆç”¨çš„ï¼Ÿ"><code>docker swarm ca</code> æ˜¯åšä»€ä¹ˆç”¨çš„ï¼Ÿ</h3><ul class="lvl-0"><li class="lvl-2"><p><code>docker swarm ca</code> å‘½ä»¤æ˜¯ç”¨æ¥ <strong>ç®¡ç† Swarm é›†ç¾¤ä¸­çš„æ ¹è¯ä¹¦é¢å‘æœºæ„ï¼ˆCAï¼‰</strong> çš„å·¥å…·ã€‚å…·ä½“åŠŸèƒ½åŒ…æ‹¬ï¼š</p></li></ul><table><thead><tr><th>å­å‘½ä»¤/å‚æ•°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>docker swarm ca</code></td><td>æŸ¥çœ‹å½“å‰ Swarm çš„æ ¹ CA å…¬é’¥ï¼ˆPEM æ ¼å¼ï¼‰</td></tr><tr><td><code>docker swarm ca --rotate</code></td><td>è½®æ¢æ ¹ CAï¼Œç”¨äºå®‰å…¨æ›´æ–°</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>Swarm ä¸­çš„è¯ä¹¦æ˜¯å¹²ä»€ä¹ˆç”¨çš„ï¼Ÿ</p></li></ul><table><thead><tr><th>ç”¨é€”</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>âœ… èŠ‚ç‚¹èº«ä»½éªŒè¯</td><td>æ¯ä¸ªèŠ‚ç‚¹åŠ å…¥é›†ç¾¤æ—¶ï¼Œéƒ½ä¼šæ”¶åˆ°ä¸€ä¸ªç”±æ ¹ CA ç­¾å‘çš„ TLS è¯ä¹¦ï¼Œç”¨äºè¯æ˜å®ƒçš„èº«ä»½ã€‚</td></tr><tr><td>ğŸ” é€šä¿¡åŠ å¯†</td><td>èŠ‚ç‚¹ä¹‹é—´ï¼ˆManager â†” Workerï¼‰çš„é€šä¿¡é€šè¿‡ TLS è¿›è¡ŒåŠ å¯†ã€‚</td></tr><tr><td>ğŸ”„ è‡ªåŠ¨è½®æ¢</td><td>Docker ä¼šè‡ªåŠ¨ä¸ºæ¯ä¸ªèŠ‚ç‚¹ç­¾å‘çŸ­æœŸè¯ä¹¦ï¼ˆé»˜è®¤æœ‰æ•ˆæœŸ 90 å¤©ï¼‰å¹¶å®šæœŸè‡ªåŠ¨è½®æ¢ã€‚</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>Swarm åœ¨åå°è‡ªåŠ¨ç®¡ç†è¯ä¹¦ï¼Œæ‰€ä»¥ä½ ä¸éœ€è¦æ‰‹åŠ¨å¤„ç†å®ƒä»¬ã€‚ä¸è¿‡ï¼Œä½ å¯ä»¥åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šæ‰¾åˆ°å®ƒä»¬çš„ä½ç½®ï¼š</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /var/lib/docker/swarm/certificates</span><br><span class="line">tree</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ swarm-node.crt      <span class="comment"># èŠ‚ç‚¹è¯ä¹¦</span></span><br><span class="line">â”œâ”€â”€ swarm-node.key      <span class="comment"># èŠ‚ç‚¹å¯†é’¥</span></span><br><span class="line">â””â”€â”€ swarm-root-ca.crt   <span class="comment"># æ ¹CAè¯ä¹¦</span></span><br></pre></td></tr></table></figure><h3 id="åªè®©-Manager-åšç®¡ç†ï¼Œä¸è¿è¡ŒæœåŠ¡">åªè®© Manager åšç®¡ç†ï¼Œä¸è¿è¡ŒæœåŠ¡</h3><ul class="lvl-0"><li class="lvl-2"><p>èŠ‚ç‚¹çš„<code>AVAILABILITY</code>æœ‰ä¸‰ç§ï¼š<code>active</code>ã€<code>pause</code>ã€<code>drain</code>ã€‚</p></li></ul><table><thead><tr><th>çŠ¶æ€</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>active</code></td><td>å¯è°ƒåº¦ï¼ŒSwarm å¯ä»¥åœ¨æ­¤èŠ‚ç‚¹ä¸Šè¿è¡ŒæœåŠ¡ä»»åŠ¡ï¼ˆé»˜è®¤ï¼‰</td></tr><tr><td><code>pause</code></td><td>æš‚åœè°ƒåº¦ï¼Œä¸ä¼šåˆ†é…æ–°ä»»åŠ¡ï¼Œä½†ä¿ç•™å·²æœ‰ä»»åŠ¡</td></tr><tr><td><code>drain</code></td><td>æ’ç©ºæ¨¡å¼ï¼Œä¸å¯è°ƒåº¦ï¼ŒSwarm ä¼šå°†è¯¥èŠ‚ç‚¹ä¸Šçš„ä»»åŠ¡è¿ç§»åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œæ–°çš„ä»»åŠ¡å°†ä¸ä¼šåˆ†é…åˆ°æ­¤èŠ‚ç‚¹</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>å¦‚æœä½ å¸Œæœ› Swarm Manager èŠ‚ç‚¹ä»…å‚ä¸ç®¡ç†å·¥ä½œï¼Œè€Œä¸è¿è¡ŒæœåŠ¡ä»»åŠ¡ï¼ˆtaskï¼‰ï¼Œä½ å¯ä»¥é€šè¿‡ è®¾ç½®èŠ‚ç‚¹çš„å¯è°ƒåº¦çŠ¶æ€ä¸ºâ€œä¸å¯è°ƒåº¦â€ æ¥å®ç°è¿™ä¸€ç›®æ ‡ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½® manager1 èŠ‚ç‚¹ä¸ºâ€œä¸å¯è°ƒåº¦â€ï¼Œå³ æ’ç©ºæ¨¡å¼</span></span><br><span class="line">docker node update --availability drain manager1</span><br><span class="line"><span class="comment"># æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€</span></span><br><span class="line">docker node <span class="built_in">ls</span></span><br><span class="line"><span class="comment">## è¾“å‡ºï¼Œmanager1 èŠ‚ç‚¹çŠ¶æ€å˜ä¸º æ’ç©º</span></span><br><span class="line">ID                            HOSTNAME   STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION</span><br><span class="line">kp2zerd28xgz5mmglnje0jp22 *   manager1   Ready     Drain          Reachable        26.1.3</span><br><span class="line">oymi74epagdqeprah7s81tsa2     manager2   Ready     Active         Reachable        26.1.3</span><br><span class="line">r7388xl84nczjtnf53pwh7hla     manager3   Ready     Active         Leader           26.1.3</span><br><span class="line">xkww4853bbdgv7bv8771xibob     worker1    Ready     Active                          26.1.3</span><br><span class="line">hvzkh3ip5ef8gx973z1ywahbu     worker2    Ready     Active                          26.1.3</span><br><span class="line"><span class="comment"># æŸ¥çœ‹æœåŠ¡çŠ¶æ€</span></span><br><span class="line">docker service ps my-nginx</span><br><span class="line"><span class="comment">## è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ° manager1 èŠ‚ç‚¹ä¸Šçš„ä»»åŠ¡å·²ç»å…³é—­ï¼Œå¹¶ä¸”åœ¨å…¶å®ƒèŠ‚ç‚¹ä¸Šè¿è¡Œäº†ä»»åŠ¡ã€‚</span></span><br><span class="line">ID             NAME             IMAGE          NODE       DESIRED STATE   CURRENT STATE                    ERROR     PORTS</span><br><span class="line">23m03nj54mzo   my-nginx.1       nginx:latest   worker2    Running         Running 35 seconds ago</span><br><span class="line">9xi83bnh4fus   my-nginx.2       nginx:latest   worker2    Running         Running 35 seconds ago</span><br><span class="line">wos8tbk449lk   my-nginx.3       nginx:latest   manager2   Running         Running 28 seconds ago</span><br><span class="line">uosmuh6bvwm0    \_ my-nginx.3   nginx:latest   manager1   Shutdown        Shutdown 7 seconds ago</span><br><span class="line">yeqhqc3f735y   my-nginx.4       nginx:latest   manager2   Running         Running about a minute ago</span><br><span class="line">g8rduix7s74v   my-nginx.5       nginx:latest   worker2    Running         Running less than a second ago</span><br><span class="line">wuxilgpv9f50    \_ my-nginx.5   nginx:latest   manager1   Shutdown        Shutdown 7 seconds ago</span><br><span class="line">3bxtn9boit28   my-nginx.6       nginx:latest   manager3   Running         Running 28 seconds ago</span><br><span class="line">57kdggaf8sag   my-nginx.7       nginx:latest   manager2   Running         Running about a minute ago</span><br><span class="line">uugi506p74s8   my-nginx.8       nginx:latest   worker1    Running         Running 28 seconds ago</span><br><span class="line">yifwpqjnts9l   my-nginx.9       nginx:latest   worker1    Running         Running 28 seconds ago</span><br><span class="line">yv4p6su7aom5   my-nginx.10      nginx:latest   manager3   Running         Running 28 seconds ago</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¢å¤è¿è¡Œä»»åŠ¡èƒ½åŠ›</span></span><br><span class="line">docker node update --availability active manager1</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœæ­¢æ¥æ”¶æ–°çš„ä»»åŠ¡ä½†ä¿ç•™è¿è¡Œä¸­çš„ä»»åŠ¡</span></span><br><span class="line">docker node update --availability pause manager1</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **åŠ ç²—**
 *æ–œä½“*
 ***åŠ ç²—å¹¶æ–œä½“***
 ~~åˆ é™¤çº¿~~
 ==çªå‡ºæ˜¾ç¤º==
 `çªå‡ºæ˜¾ç¤º(æ¨è)`
 ++ä¸‹åˆ’çº¿++
 ~ä¸‹æ ‡~
 ^ä¸Šæ ‡^
 è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.
 å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **ç‚¹å‡»æŠ˜å **
 è¿™æ˜¯è¢«éšè—çš„å†…å®¹
 +++

::: tips success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
:::

% note info % success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
% endnote %

å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}
 å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ
 --&gt;
&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;æœ¬æ–‡ä»‹ç» Docker Swarm çš„ èŠ‚ç‚¹ç®¡ç†&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com&quot;&gt;Dockerå®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com/engine/swarm/&quot;&gt;Docker Swarm å®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/docker/"/>
    
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>Docker å‘½ä»¤ ä¹‹ Dockerfile å¤šå¹³å°æ„å»º</title>
    <link href="https://blog.hanqunfeng.com/2025/06/06/docker-dockerfile-multi-platform/"/>
    <id>https://blog.hanqunfeng.com/2025/06/06/docker-dockerfile-multi-platform/</id>
    <published>2025-06-06T13:30:05.000Z</published>
    <updated>2025-06-07T11:32:29.230Z</updated>
    
    <content type="html"><![CDATA[<!-- **åŠ ç²—** *æ–œä½“* ***åŠ ç²—å¹¶æ–œä½“*** ~~åˆ é™¤çº¿~~ ==çªå‡ºæ˜¾ç¤º== `çªå‡ºæ˜¾ç¤º(æ¨è)` ++ä¸‹åˆ’çº¿++ ~ä¸‹æ ‡~ ^ä¸Šæ ‡^ è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference. å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **ç‚¹å‡»æŠ˜å ** è¿™æ˜¯è¢«éšè—çš„å†…å®¹ +++::: tips success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹:::% note info % success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹% endnote %å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{} å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ --><h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2"><p>æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ Dockerfile å¤šå¹³å°æ„å»ºçš„ä½¿ç”¨æ–¹æ³•</p></li><li class="lvl-2"><p><a href="https://docs.docker.com">Dockerå®˜æ–¹æ–‡æ¡£</a></p></li><li class="lvl-2"><p><a href="https://docs.docker.com/engine/reference/builder/">Dockerfileå®˜æ–¹æ–‡æ¡£</a></p></li><li class="lvl-2"><p><a href="https://docs.docker.com/build/building/multi-platform/">Multi-platform builds</a></p></li></ul><span id="more"></span><h2 id="ä»€ä¹ˆæ˜¯Dockerfile-å¤šå¹³å°æ„å»ºï¼Ÿ">ä»€ä¹ˆæ˜¯Dockerfile å¤šå¹³å°æ„å»ºï¼Ÿ</h2><ul class="lvl-0"><li class="lvl-2"><p>Dockerfile å¤šå¹³å°æ„å»ºï¼Œå¯ä»¥æ„å»ºå¤šä¸ªå¹³å°é•œåƒï¼Œæ¯”å¦‚ arm64ã€amd64ã€armã€386 ç­‰ã€‚</p></li><li class="lvl-2"><p>åœ¨æ²¡æœ‰å®‰è£… <code>docker-buildx-plugin</code> çš„æƒ…å†µä¸‹ï¼Œ<code>docker build</code> å‘½ä»¤æ˜¯ä¸æ”¯æŒä½¿ç”¨ <code>--platform</code> æ„å»ºå‡ºè·¨å¹³å°é•œåƒçš„ï¼Œå…¶ä»…èƒ½æ„å»ºä¸æœ¬æœºæ¶æ„å¹³å°ç›¸åŒçš„é•œåƒã€‚</p></li><li class="lvl-2"><p>è¦çœŸæ­£å®ç°è·¨å¹³å°æ„å»ºï¼ˆmulti-platform buildï¼‰ï¼Œæ¯”å¦‚åœ¨ amd64 ä¸Šæ„å»º arm64 çš„é•œåƒï¼Œéœ€è¦ä½¿ç”¨ BuildKit å’Œ buildx æ’ä»¶ã€‚</p></li><li class="lvl-2"><p><code>docker-buildx-plugin</code> æ˜¯åŸºäº BuildKit æ„å»ºçš„ï¼Œä½†å®ƒæœ¬èº«æ˜¯ Buildx çš„ä¸€ä¸ªå®ç°å½¢å¼ï¼Œå®ƒæ‰©å±•äº† <code>docker build</code> çš„èƒ½åŠ›ï¼Œæ”¯æŒå¤šå¹³å°æ„å»ºï¼ˆå¦‚åŒæ—¶æ„å»º Linux/amd64 å’Œ Linux/arm64ç­‰ï¼‰ã€‚</p></li></ul><h2 id="å®‰è£…-docker-buildx-plugin">å®‰è£… docker-buildx-plugin</h2><ul class="lvl-0"><li class="lvl-2"><p>éšdockeræœåŠ¡ä¸€èµ·å®‰è£…</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dnf -y install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å•ç‹¬å®‰è£…</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dnf -y install docker-buildx-plugin</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æŸ¥çœ‹ç‰ˆæœ¬</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker buildx version</span><br></pre></td></tr></table></figure><h2 id="docker-buildx-åŸºæœ¬å‘½ä»¤"><code>docker buildx</code> åŸºæœ¬å‘½ä»¤</h2><ul class="lvl-0"><li class="lvl-2"><p>ä»¥ä¸‹å‘½ä»¤åœ¨åé¢çš„ç¤ºä¾‹ä¸­éƒ½æœ‰ä½¿ç”¨</p></li></ul><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>docker buildx create</code></td><td>åˆ›å»ºä¸€ä¸ªæ–°çš„æ„å»ºå™¨å®ä¾‹</td></tr><tr><td><code>docker buildx use</code></td><td>è®¾ç½®å½“å‰ä½¿ç”¨çš„æ„å»ºå™¨</td></tr><tr><td><code>docker buildx inspect</code></td><td>æŸ¥çœ‹æ„å»ºå™¨çŠ¶æ€å’Œæ”¯æŒçš„å¹³å°</td></tr><tr><td><code>docker buildx build</code></td><td>æ„å»ºé•œåƒï¼ˆå¢å¼ºç‰ˆï¼‰ï¼Œç­‰åŒäº <code>docker build</code></td></tr><tr><td><code>docker buildx ls</code></td><td>åˆ—å‡ºæ‰€æœ‰æ„å»ºå™¨</td></tr><tr><td><code>docker buildx rm</code></td><td>åˆ é™¤æ„å»ºå™¨</td></tr><tr><td><code>docker buildx du</code></td><td>æŸ¥çœ‹æ„å»ºå™¨ä½¿ç”¨çš„ç£ç›˜ç©ºé—´</td></tr><tr><td><code>docker buildx prune</code></td><td>åˆ é™¤æ„å»ºè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ç¼“å­˜</td></tr><tr><td><code>docker buildx version</code></td><td>æŸ¥çœ‹ Docker Buildx çš„ç‰ˆæœ¬ä¿¡æ¯</td></tr></tbody></table><h2 id="è¦è®©Dockeræ”¯æŒå¤šå¹³å°æ„å»ºï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶ï¼š">è¦è®©Dockeræ”¯æŒå¤šå¹³å°æ„å»ºï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªæ¡ä»¶ï¼š</h2><ul class="lvl-0"><li class="lvl-2"><p>Linuxå†…æ ¸å¼€å¯å¤šå¤„ç†å™¨æ¶æ„æ”¯æŒ</p></li><li class="lvl-2"><p>æ„å»ºæ—¶ä½¿ç”¨åŸºäº<code>docker-container</code>é©±åŠ¨çš„Buildxå®ä¾‹</p></li><li class="lvl-2"><p>ä½¿ç”¨<code>docker buildx build</code>å‘½ä»¤æ„å»ºé•œåƒï¼Œæ„å»ºå‘½ä»¤å¿…é¡»æŒ‡å®š<code>â€“platform</code>å‚æ•°</p></li></ul><h2 id="Linuxå†…æ ¸å¼€å¯å¤šå¤„ç†å™¨æ¶æ„æ”¯æŒ">Linuxå†…æ ¸å¼€å¯å¤šå¤„ç†å™¨æ¶æ„æ”¯æŒ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ—å‡ºæ‰€æœ‰æ„å»ºå™¨ï¼Œé»˜è®¤æƒ…å†µä¸‹åªæœ‰ä¸€ä¸ªåç§°ä¸º&quot;default&quot;çš„æ„å»ºå™¨</span></span><br><span class="line">docker buildx <span class="built_in">ls</span></span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">NAME/NODE        DRIVER/ENDPOINT                   STATUS    BUILDKIT   PLATFORMS</span><br><span class="line">default          docker</span><br><span class="line"> \_ default       \_ default                       running   v0.13.2    linux/amd64, linux/amd64/v2, linux/amd64/v3, linux/amd64/v4, linux/386</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å¯å¤šå¤„ç†å™¨æ¶æ„æ”¯æŒ</span></span><br><span class="line">docker run --privileged --<span class="built_in">rm</span> tonistiigi/binfmt --install all</span><br><span class="line"><span class="comment"># è¿™ä¸ªé•œåƒç”¨å®Œå°±å¯ä»¥åˆ é™¤äº†</span></span><br><span class="line">docker rmi tonistiigi/binfmt</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†æ¬¡åˆ—å‡ºæ‰€æœ‰æ„å»ºå™¨</span></span><br><span class="line">docker buildx <span class="built_in">ls</span></span><br><span class="line"><span class="comment">## è¾“å‡ºï¼Œæ­¤æ—¶å¯ä»¥çœ‹åˆ°PLATFORMSä¸­æœ‰å¤šä¸ªå¹³å°</span></span><br><span class="line">NAME/NODE        DRIVER/ENDPOINT                   STATUS    BUILDKIT   PLATFORMS</span><br><span class="line">default*         docker</span><br><span class="line"> \_ default       \_ default                       running   v0.13.2    linux/amd64, linux/amd64/v2, linux/amd64/v3, linux/amd64/v4, linux/386, linux/arm64, linux/riscv64, linux/ppc64le, linux/s390x, linux/mips64le, linux/mips64, linux/loong64, linux/arm/v7, linux/arm/v6</span><br></pre></td></tr></table></figure><h2 id="æ„å»ºæ—¶ä½¿ç”¨åŸºäºdocker-containeré©±åŠ¨çš„Buildxå®ä¾‹">æ„å»ºæ—¶ä½¿ç”¨åŸºäº<code>docker-container</code>é©±åŠ¨çš„Buildxå®ä¾‹</h2><ul class="lvl-0"><li class="lvl-2"><p>Docker çš„é»˜è®¤æ„å»ºé©±åŠ¨æ˜¯ dockerï¼Œå®ƒæ˜¯è¿è¡Œåœ¨æœ¬åœ° Docker å®ˆæŠ¤è¿›ç¨‹ä¸Šçš„ï¼Œä¸èƒ½è¿›è¡ŒçœŸæ­£çš„å¤šå¹³å°æ„å»ºï¼ˆä»…èƒ½æ„å»ºå½“å‰å¹³å°ï¼‰ã€‚</p></li><li class="lvl-2"><p>å¤šå¹³å°æ„å»ºéœ€è¦ä½¿ç”¨ BuildKit çš„ container é©±åŠ¨ï¼Œå®ƒä»¥å®¹å™¨çš„å½¢å¼è¿è¡Œæ„å»ºå™¨ï¼Œæ”¯æŒè™šæ‹ŸåŒ–å¹³å°å¹¶è¡Œæ„å»ºã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å½“å‰é»˜è®¤çš„æ„å»ºå™¨default</span></span><br><span class="line">docker buildx inspect default</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">Name:          default</span><br><span class="line">Driver:        docker</span><br><span class="line">Last Activity: 2025-06-06 07:42:42 +0000 UTC</span><br><span class="line"></span><br><span class="line">Nodes:</span><br><span class="line">Name:             default</span><br><span class="line">Endpoint:         default</span><br><span class="line">Status:           running</span><br><span class="line">BuildKit version: v0.13.2</span><br><span class="line">Platforms:        linux/amd64, linux/amd64/v2, linux/amd64/v3, linux/amd64/v4, linux/386, linux/arm64, linux/riscv64, linux/ppc64le, linux/s390x, linux/mips64le, linux/mips64, linux/loong64, linux/arm/v7, linux/arm/v6</span><br><span class="line">Labels:</span><br><span class="line"> org.mobyproject.buildkit.worker.moby.host-gateway-ip: 172.17.0.1</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åˆ›å»ºåŸºäº <code>docker-container</code> é©±åŠ¨çš„Buildxå®ä¾‹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºå¹¶åˆ‡æ¢åˆ°åä¸ºmybuilderçš„æ„å»ºå™¨å®ä¾‹</span></span><br><span class="line">docker buildx create --name mybuilder --use --driver docker-container</span><br><span class="line"><span class="comment"># æŸ¥çœ‹å½“å‰æ„å»ºå™¨ä¿¡æ¯ï¼Œ--bootstrapï¼šæŸ¥çœ‹å‰ç¡®ä¿æ„å»ºå™¨å·²å¯åŠ¨ ï¼Œæ­¤æ—¶çœ‹åˆ°å…¶Driverä¸ºdocker-containerï¼Œè¿™ä¸ªå‘½ä»¤ç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶å¯èƒ½ä¼šæç¤ºé”™è¯¯ï¼Œä¸è¿‡ä¸ç”¨ç®¡ï¼Œå†æ¬¡è¿è¡Œå°±æ­£å¸¸äº†</span></span><br><span class="line">docker buildx inspect --bootstrap</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">Name:          mybuilder</span><br><span class="line">Driver:        docker-container</span><br><span class="line">â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¤æ—¶ä¼šå¯åŠ¨ä¸€ä¸ªåç§°ä¸º`buildx_buildkit_mybuilder0`çš„å®¹å™¨ï¼Œæ¯åˆ›å»ºä¸€ä¸ªæ„å»ºå™¨å®ä¾‹ï¼Œå°±ä¼šå¯åŠ¨ä¸€ä¸ªåç§°ä¸º`buildx_buildkit_xxx`çš„å®¹å™¨ï¼Œåˆ é™¤æ„å»ºå™¨æ—¶ï¼Œå…¶å¯¹åº”çš„å®¹å™¨ä¹Ÿä¼šè¢«åˆ é™¤</span></span><br><span class="line">docker ps</span><br><span class="line">CONTAINER ID   IMAGE                           COMMAND                   CREATED             STATUS                       PORTS                    NAMES</span><br><span class="line">0ab9cab9ec9b   moby/buildkit:buildx-stable-1   <span class="string">&quot;buildkitd --allow-iâ€¦&quot;</span>   About an hour ago   Up About an hour                                      buildx_buildkit_mybuilder0</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>buildx_buildkit_xxx</code>è¿™ä¸ªå®¹å™¨å°±æ˜¯ä¸€ä¸ª BuildKit å®ˆæŠ¤è¿›ç¨‹å®¹å™¨ï¼Œå®ƒæ˜¯æ‰§è¡Œ buildx æ„å»ºä»»åŠ¡çš„å®é™…å·¥ä½œå¼•æ“ã€‚å…¶å¯¹åº”çš„é•œåƒä¸º<code>moby/buildkit:buildx-stable-1</code>ï¼Œå®¹å™¨ä¼šåœ¨æ‰§è¡Œ<code>docker buildx build</code> æˆ– <code>docker buildx inspect --bootstrap</code> æ—¶å¯åŠ¨</p></li></ul><table><thead><tr><th>åŠŸèƒ½</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>ğŸ‘· æ‰§è¡Œæ„å»ºä»»åŠ¡</td><td>çœŸæ­£æ‰§è¡Œ <code>buildx build</code> æŒ‡ä»¤é‡Œçš„æ„å»ºè¿‡ç¨‹ï¼Œæ¯”å¦‚å¤šé˜¶æ®µæ„å»ºã€ç¼“å­˜å¤„ç†ã€è·¨å¹³å°ç¼–è¯‘ç­‰</td></tr><tr><td>ğŸ“¦ æ‹‰å–é•œåƒ</td><td>æ‹‰å– <code>Dockerfile</code> ä¸­çš„åŸºç¡€é•œåƒ</td></tr><tr><td>ğŸ“¤ ä¸Šä¼ /å¯¼å‡ºé•œåƒ</td><td>æ”¯æŒå¯¼å‡ºä¸º <code>docker image</code>, <code>tar</code>, æ¨é€åˆ°è¿œç¨‹ registry</td></tr><tr><td>ğŸª£ ç®¡ç†ç¼“å­˜</td><td>ç®¡ç†æ„å»ºç¼“å­˜ï¼ˆä¸­é—´é•œåƒã€å±‚ç­‰ï¼‰ä»¥åŠ é€Ÿåç»­æ„å»º</td></tr><tr><td>ğŸŒ æ”¯æŒå¤šå¹³å°</td><td>é€šè¿‡ QEMU æˆ–äº¤å‰ç¼–è¯‘å™¨æ”¯æŒè·¨å¹³å°ï¼ˆå¦‚æ„å»º <code>arm64</code> é•œåƒï¼‰</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>åœ¨å›½å†…ç¯å¢ƒä½¿ç”¨æ—¶ï¼Œå¦‚æœä¸èƒ½ç§‘å­¦ä¸Šç½‘ï¼Œå½“æˆ‘ä»¬åœ¨æ„å»ºé•œåƒæ—¶ä¼šæç¤ºæ— æ³•æ‹‰å–åŸºç¡€é•œåƒï¼Œå³ä¾¿æˆ‘ä»¬å·²ç»åœ¨<code>/etc/docker/daemon.json</code>ä¸­é…ç½®äº†å›½å†…çš„é•œåƒæºä¹Ÿä¸è¡Œï¼Œè¿™æ˜¯å› ä¸º<code>docker buildx</code> ä½¿ç”¨çš„æ˜¯ BuildKitï¼Œå®ƒçš„è¡Œä¸ºä¸åŒäºä¼ ç»Ÿçš„ <code>docker build</code></p></li></ul><table><thead><tr><th>ç‰¹æ€§</th><th><code>docker build</code>ï¼ˆä¼ ç»Ÿï¼‰</th><th><code>docker buildx</code>ï¼ˆBuildKitï¼‰</th></tr></thead><tbody><tr><td>æ˜¯å¦ä½¿ç”¨æœ¬åœ°é•œåƒç¼“å­˜</td><td>âœ… æ˜¯</td><td>âš ï¸ <strong>ä¸æ˜¯</strong></td></tr><tr><td>æ˜¯å¦éœ€è¦è”ç½‘æ‹‰å–å…ƒæ•°æ®ï¼ˆå³ä½¿é•œåƒå·²å­˜åœ¨ï¼‰</td><td>å¦</td><td>æ˜¯</td></tr><tr><td>æ„å»ºç½‘ç»œéš”ç¦»</td><td>ä¸éš”ç¦»</td><td>éš”ç¦»æ„å»ºï¼Œæ— æ³•ç›´æ¥è®¿é—®å®¿ä¸»é•œåƒç¼“å­˜</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>è§£å†³æ–¹æ³•ä¸ºæ„å»ºå™¨é…ç½®é•œåƒæº</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»º BuildKit é…ç½®æ–‡ä»¶ buildkitd.toml</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; buildkitd.toml</span></span><br><span class="line"><span class="string">[registry.&quot;docker.io&quot;]</span></span><br><span class="line"><span class="string">  mirrors = [&quot;https://docker.1ms.run&quot;]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[worker.oci]</span></span><br><span class="line"><span class="string">  gc = true</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º BuildKit æ„å»ºå™¨ï¼Œå¹¶æŒ‡å®šé…ç½®æ–‡ä»¶</span></span><br><span class="line">docker buildx create --name mybuilder --use --driver docker-container --config ./buildkitd.toml</span><br><span class="line">docker buildx inspect --bootstrap</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœå­˜åœ¨åŒåçš„æ„å»ºå™¨ï¼Œåˆ™åˆ é™¤å®ƒåå†åˆ›å»º</span></span><br><span class="line">docker buildx <span class="built_in">rm</span> mybuilder</span><br><span class="line">docker buildx create --name mybuilder --use --driver docker-container --config ./buildkitd.toml</span><br><span class="line">docker buildx inspect --bootstrap</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ„å»ºå™¨åˆ—è¡¨</span></span><br><span class="line">docker buildx <span class="built_in">ls</span></span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">NAME/NODE        DRIVER/ENDPOINT                   STATUS    BUILDKIT   PLATFORMS</span><br><span class="line">mybuilder*       docker-container</span><br><span class="line"> \_ mybuilder0    \_ unix:///var/run/docker.sock   running   v0.21.1    linux/amd64, linux/amd64/v2, linux/amd64/v3, linux/amd64/v4, linux/arm64, linux/riscv64, linux/ppc64le, linux/s390x, linux/386, linux/mips64le, linux/mips64, linux/loong64, linux/arm/v7, linux/arm/v6</span><br><span class="line">default          docker</span><br><span class="line"> \_ default       \_ default                       running   v0.13.2    linux/amd64, linux/amd64/v2, linux/amd64/v3, linux/amd64/v4, linux/386, linux/arm64, linux/riscv64, linux/ppc64le, linux/s390x, linux/mips64le, linux/mips64, linux/loong64, linux/arm/v7, linux/arm/v6</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœè¦åˆ‡æ¢å›é»˜è®¤çš„æ„å»ºå™¨ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</span></span><br><span class="line">docker buildx use default</span><br></pre></td></tr></table></figure><h2 id="ä½¿ç”¨docker-buildx-buildå‘½ä»¤æ„å»ºé•œåƒï¼Œæ„å»ºå‘½ä»¤å¿…é¡»æŒ‡å®š-platformå‚æ•°">ä½¿ç”¨<code>docker buildx build</code>å‘½ä»¤æ„å»ºé•œåƒï¼Œæ„å»ºå‘½ä»¤å¿…é¡»æŒ‡å®š<code>--platform</code>å‚æ•°</h2><h3 id="ç¤ºä¾‹ä¸€ï¼šå•é˜¶æ®µæ„å»º">ç¤ºä¾‹ä¸€ï¼šå•é˜¶æ®µæ„å»º</h3><ul class="lvl-0"><li class="lvl-2"><p>æˆ‘ä»¬ä¾æ—§ä»¥ä¸€ä¸ªspringbooté¡¹ç›®ä¸ºä¾‹ï¼Œå…¶Dockerfileå¦‚ä¸‹ï¼š</p></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨è½»é‡çº§ Alpine ç‰ˆæœ¬çš„ OpenJDK 17 å®˜æ–¹é•œåƒï¼Œé€‚åˆéƒ¨ç½² Spring Boot åº”ç”¨</span></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">17</span>-alpine</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®æ„å»ºæ—¶å˜é‡ï¼Œé»˜è®¤ä½¿ç”¨æ„å»ºå¥½çš„ jar æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">ARG</span> JAR_FILE=app.jar</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®è¿è¡Œæ—¶ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_OPTS=<span class="string">&quot;-Xms1024M -Xmx1024M -XX:MetaspaceSize=128M -XX:MaxMetaspaceSize=128M&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"></span><br><span class="line"><span class="comment"># é•œåƒå…ƒä¿¡æ¯</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;yourname@example.com&quot;</span></span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> version=<span class="string">&quot;1.0.0&quot;</span></span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> description=<span class="string">&quot;ç”¨äºéƒ¨ç½² Spring Boot åº”ç”¨çš„ç”Ÿäº§çº§é•œåƒ&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å·¥ä½œç›®å½•</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶ Spring Boot æ„å»ºç”Ÿæˆçš„ jar åŒ…</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> <span class="variable">$&#123;JAR_FILE&#125;</span> app.jar</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å£°æ˜æš´éœ²çš„åº”ç”¨ç«¯å£ï¼ˆSpring Boot é»˜è®¤æ˜¯ 8080ï¼‰</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å®¹å™¨å¯åŠ¨æ—¶çš„ä¸»å‘½ä»¤ï¼ˆENTRYPOINT ä¸ä¼šè¢« docker run å‚æ•°è¦†ç›–ï¼‰</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;java <span class="variable">$JAVA_OPTS</span> -jar app.jar&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CMD æä¾›é»˜è®¤çš„è¿è¡Œå‚æ•°ï¼Œå¯ä»¥è¢« docker run è¦†ç›–</span></span><br><span class="line"><span class="comment"># è¿™é‡Œé€šè¿‡ Spring Boot å‚æ•°è®¾ç½®å¯åŠ¨ç¯å¢ƒå’Œç«¯å£å·</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;--spring.profiles.active=app&quot;</span>, <span class="string">&quot;--server.port=8080&quot;</span>]</span></span><br><span class="line"><span class="comment"># è¿™é‡Œä½¿ç”¨çš„æ˜¯ ENTRYPOINT + CMD çš„æ··åˆæ¨¡å¼</span></span><br><span class="line"><span class="comment"># å®Œæ•´å‘½ä»¤ï¼š java $JAVA_OPTS -jar app.jar --spring.profiles.active=app --server.port=8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å£°æ˜ä¸€ä¸ªå·æŒ‚è½½ç‚¹ï¼Œè¿è¡Œå®¹å™¨æ—¶å¯å°†è¯¥è·¯å¾„æ˜ å°„åˆ°å®¿ä¸»æœºï¼Œå®ç°æ•°æ®æŒä¹…åŒ–</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> [<span class="string">&quot;/app/logs&quot;</span>]</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å¼€å§‹æ„å»ºé•œåƒï¼Œ<code>docker buildx build == docker build</code>ï¼Œæ„å»ºå¤šå¹³å°æ¶æ„æ—¶éœ€è¦ä½¿ç”¨<code>--platform</code>æŒ‡å®šæ„å»ºå¹³å°</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --platform inux/arm64 :æ„å»ºarm64é•œåƒ</span></span><br><span class="line"><span class="comment"># -t &quot;app.arm64&quot; :æ„å»ºåé•œåƒåç§°ï¼Œæ²¡æœ‰æŒ‡å®šç‰ˆæœ¬é»˜è®¤å°±æ˜¯ï¼šlatest</span></span><br><span class="line"><span class="comment"># --load :æ„å»ºååŠ è½½åˆ°æœ¬åœ°</span></span><br><span class="line"><span class="comment"># . :å½“å‰ç›®å½•æŸ¥æ‰¾Dockerfileæ–‡ä»¶</span></span><br><span class="line"><span class="comment"># -f :å¦‚æœåç§°ä¸ä¸ºDockerfileï¼Œåˆ™é€šè¿‡è¯¥å‚æ•°æŒ‡å®šDockerfileæ–‡ä»¶çš„åç§°</span></span><br><span class="line">docker buildx build --platform linux/arm64 -t <span class="string">&quot;app.arm64&quot;</span> --load .</span><br><span class="line"><span class="comment">## æ­¤æ—¶ä¼šé‡åˆ°å¦‚ä¸‹é”™è¯¯</span></span><br><span class="line">ERROR: failed to solve: openjdk:17-alpine: failed to resolve <span class="built_in">source</span> metadata <span class="keyword">for</span> docker.io/library/openjdk:17-alpine: no match <span class="keyword">for</span> platform <span class="keyword">in</span> manifest: not found</span><br><span class="line"><span class="comment">## åŸå› ï¼šopenjdk:17-alpine è¿™ä¸ªé•œåƒä¸æ”¯æŒarm64å¹³å°ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ¢ä¸€ä¸ªæ”¯æŒå¤šå¹³å°çš„é•œåƒ</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å¦‚ä½•æŸ¥çœ‹é•œåƒæ˜¯å¦æ”¯æŒå¤šå¹³å°å‘¢ï¼Ÿå¯ä»¥åœ¨docker hubä¸ŠæŸ¥çœ‹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥è¯¢é•œåƒæ”¯æŒçš„å¹³å°ï¼Œä¸è¿‡å›½å†…ä¾æ—§æ˜¯ä¸æ”¯æŒ</span></span><br><span class="line">docker buildx imagetools inspect nginx:latest |  grep Platform | <span class="built_in">sort</span> | <span class="built_in">uniq</span></span><br><span class="line"><span class="comment"># å¯ä»¥åœ¨é•œåƒåç§°å‰åŠ ä¸Šå›½å†…çš„é•œåƒä»“åº“åœ°å€è¿›è¡ŒæŸ¥è¯¢ï¼Œæ¯”å¦‚ï¼š</span></span><br><span class="line">docker buildx imagetools inspect docker.1ms.run/nginx:latest |  grep Platform | <span class="built_in">sort</span> | <span class="built_in">uniq</span></span><br><span class="line"><span class="comment">## è¾“å‡ºç»“æœ</span></span><br><span class="line">  Platform:    linux/386</span><br><span class="line">  Platform:    linux/amd64</span><br><span class="line">  Platform:    linux/arm64/v8</span><br><span class="line">  Platform:    linux/arm/v5</span><br><span class="line">  Platform:    linux/arm/v7</span><br><span class="line">  Platform:    linux/mips64le</span><br><span class="line">  Platform:    linux/ppc64le</span><br><span class="line">  Platform:    linux/s390x</span><br><span class="line">  Platform:    unknown/unknown</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¥ç€æˆ‘ä»¬æŸ¥çœ‹openjdk:17-alpineè¿™ä¸ªé•œåƒ</span></span><br><span class="line">docker buildx imagetools inspect docker.1ms.run/openjdk:17-alpine | grep Platform | <span class="built_in">sort</span> | <span class="built_in">uniq</span></span><br><span class="line"><span class="comment">## è¾“å‡ºç»“æœï¼Œå…¶ç¡®å®ä¸æ”¯æŒ linux/arm64</span></span><br><span class="line">  Platform:  linux/amd64</span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ‘ä»¬æ¢ä¸€ä¸ªopenjdké•œåƒè¯•è¯•</span></span><br><span class="line">docker buildx imagetools inspect docker.1ms.run/openjdk:17-slim | grep Platform | <span class="built_in">sort</span> | <span class="built_in">uniq</span></span><br><span class="line"><span class="comment">## è¾“å‡ºç»“æœï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªé•œåƒåŒæ—¶æ”¯æŒamd64å’Œarm64æ¶æ„</span></span><br><span class="line">  Platform:  linux/amd64</span><br><span class="line">  Platform:  linux/arm64/v8</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¹Ÿå¯ä»¥ä½¿ç”¨skopeoå®¹å™¨çš„æ–¹å¼è¿›è¡ŒæŸ¥è¯¢</span></span><br><span class="line">docker run --<span class="built_in">rm</span> quay.io/skopeo/stable:latest inspect --raw --override-os linux docker://docker.1ms.run/openjdk:17-slim | jq -r <span class="string">&#x27;.manifests[].platform | &quot;\(.os)/\(.architecture)/\(.variant)&quot;&#x27;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> | sed <span class="string">&#x27;s/\/null//&#x27;</span></span><br><span class="line"><span class="comment">## è¾“å‡ºç»“æœ</span></span><br><span class="line">linux/amd64</span><br><span class="line">linux/arm64/v8</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ›¿æ¢æ”¯æŒå¤šæ¶æ„çš„é•œåƒåé‡æ–°æ„å»ºé•œåƒå°±ä¼šæˆåŠŸ</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">docker buildx build --platform linux/arm64 -t <span class="string">&quot;app.arm64&quot;</span> --load .</span><br><span class="line">docker buildx build --platform linux/amd64 -t <span class="string">&quot;app.amd64&quot;</span> --load .</span><br><span class="line"><span class="comment"># åˆ—å‡ºé•œåƒ</span></span><br><span class="line">docker images</span><br><span class="line"><span class="comment">## è¾“å‡ºç»“æœ</span></span><br><span class="line">REPOSITORY              TAG                IMAGE ID       CREATED        SIZE</span><br><span class="line">app.amd64               latest             859162438372   2 hours ago    431MB</span><br><span class="line">app.arm64               latest             0058c70dd16e   2 hours ago    426MB</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ„å»ºåé•œåƒçš„æ¶æ„</span></span><br><span class="line">docker inspect app.amd64 | jq <span class="string">&#x27;.[0].Architecture&#x27;</span></span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line"><span class="string">&quot;amd64&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ‘ä»¬ä¹Ÿå¯ä»¥å°†æ„å»ºåçš„é•œåƒè¾“å‡ºåˆ°æœ¬åœ°ç›®å½•</span></span><br><span class="line">docker buildx build --platform linux/amd64 -t <span class="string">&quot;app.amd64&quot;</span> --output <span class="built_in">type</span>=docker,dest=./app.amd64.tar .</span><br><span class="line"><span class="comment"># ç„¶åå†å°†é•œåƒå¯¼å…¥åˆ°æœ¬åœ°é•œåƒä»“åº“ä¸­</span></span><br><span class="line">docker load -i app.amd64.tar</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>--load</code>å’Œ <code>--output</code>éƒ½ä¸æ”¯æŒä¸€ä¸ªé•œåƒå¤šç§æ¶æ„ï¼Œè¦æ„å»ºåƒ<code>openjdk:17-slim</code>è¿™ç§æ”¯æŒå¤šæ¶æ„çš„é•œåƒå¯ä»¥ä½¿ç”¨<code>--push</code>ï¼Œä¸€æ­¥å°±æ¨é€åˆ°è¿œç¨‹ä»“åº“</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ„å»ºå¤šæ¶æ„é•œåƒï¼Œ--push å¯ä»¥ä¸€æ­¥åšåˆ°ï¼šå¤šå¹³å°æ„å»ºçš„é•œåƒä¸èƒ½åªä¿å­˜åˆ°æœ¬åœ°ï¼Œå¿…é¡»æ¨é€åˆ°è¿œç¨‹ registry æ‰èƒ½åˆå¹¶æ¶æ„ã€‚</span></span><br><span class="line"><span class="comment"># è¿™é‡Œä»¥æ¨é€åˆ° docker hub ä¸ºä¾‹</span></span><br><span class="line"><span class="comment"># ç™»å½• docker hup</span></span><br><span class="line">docker login -u hanqunfeng</span><br><span class="line"><span class="comment"># æ„å»ºï¼Œæ³¨æ„è¿™é‡Œçš„é•œåƒåç§°è¦åŠ ä¸Šä½ çš„dockerhubçš„å‘½åç©ºé—´ï¼Œ--platform æŒ‡å®šæ„å»ºçš„æ¶æ„ï¼Œå¯ä»¥æŒ‡å®šå¤šä¸ªï¼Œéœ€è¦Dockerfileé…ç½®åŸºç¡€é•œåƒæ”¯æŒå¯¹åº”çš„æ¶æ„</span></span><br><span class="line">docker buildx build --platform linux/amd64,linux/arm64 -t hanqunfeng/app:latest --push .</span><br></pre></td></tr></table></figure><p><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/WdmJx0.png" alt=""></p><ul class="lvl-0"><li class="lvl-2"><p>é•œåƒæ‹‰å–</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‹‰å–æŒ‡å®šæ¶æ„é•œåƒï¼Œä¸æŒ‡å®š --platform å‚æ•°ï¼Œé»˜è®¤æ‹‰å–å½“å‰æ¶æ„çš„é•œåƒ</span></span><br><span class="line">docker pull --platform=linux/arm64 hanqunfeng/app:latest</span><br></pre></td></tr></table></figure><h3 id="ç¤ºä¾‹äºŒï¼šå¤šé˜¶æ®µæ„å»º">ç¤ºä¾‹äºŒï¼šå¤šé˜¶æ®µæ„å»º</h3><ul class="lvl-0"><li class="lvl-2"><p>è¦æ±‚æ¯ä¸ªé˜¶æ®µä¸­çš„åŸºç¡€é•œåƒéƒ½è¦æ”¯æŒå¤šæ¶æ„</p></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¬¬ä¸€é˜¶æ®µï¼šè·å–ä»£ç </span></span><br><span class="line"><span class="keyword">FROM</span> alpine/git AS fetcher</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /workspace/application</span></span><br><span class="line"><span class="comment"># å°†æ›¿æ¢ä¸ºå®é™…çš„Gitä»“åº“URLå’Œåˆ†æ”¯/æ ‡ç­¾</span></span><br><span class="line"><span class="keyword">ARG</span> GIT_REPOSITORY=https://gitee.com/hanqunfeng/springbootweb.git</span><br><span class="line"><span class="keyword">ARG</span> GIT_BRANCH=master</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> git <span class="built_in">clone</span> -b <span class="variable">$&#123;GIT_BRANCH&#125;</span> <span class="variable">$&#123;GIT_REPOSITORY&#125;</span> .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¬¬äºŒé˜¶æ®µï¼šä½¿ç”¨Mavenç¯å¢ƒè¿›è¡Œæ„å»º</span></span><br><span class="line"><span class="keyword">FROM</span> maven:<span class="number">3.8</span>.<span class="number">4</span>-openjdk-<span class="number">17</span> AS builder</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /workspace/application</span></span><br><span class="line"><span class="comment"># ä»ç¬¬ä¸€é˜¶æ®µå¤åˆ¶ä»£ç </span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=fetcher /workspace/application .</span></span><br><span class="line"><span class="comment"># ä½¿ç”¨Mavenæ¸…ç†å¹¶æ‰“åŒ…</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> mvn clean package -DskipTests</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¬¬ä¸‰é˜¶æ®µï¼šåˆ›å»ºæœ€ç»ˆçš„è¿è¡Œç¯å¢ƒ</span></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">17</span>-slim</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="comment"># è®¾ç½®è¿è¡Œæ—¶ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_OPTS=<span class="string">&quot;-Xms1024M -Xmx1024M -XX:MetaspaceSize=128M -XX:MaxMetaspaceSize=128M&quot;</span></span><br><span class="line"><span class="comment"># å°†ç¬¬äºŒé˜¶æ®µç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶å¤åˆ¶åˆ°è¿™é‡Œã€‚æ³¨æ„è¿™é‡Œå‡è®¾ä½ çš„spring bootå·¥ç¨‹æ‰“æˆçš„jaråæ˜¯target/app.jar</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /workspace/application/target/app.jar app.jar</span></span><br><span class="line"><span class="comment"># æš´éœ²ç«¯å£ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰ã€‚è¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ç«¯å£å·</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"><span class="comment"># å£°æ˜ä¸€ä¸ªå·æŒ‚è½½ç‚¹ï¼Œè¿è¡Œå®¹å™¨æ—¶å¯å°†è¯¥è·¯å¾„æ˜ å°„åˆ°å®¿ä¸»æœºï¼Œå®ç°æ•°æ®æŒä¹…åŒ–</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> [<span class="string">&quot;/app/logs&quot;</span>]</span></span><br><span class="line"><span class="comment"># è®¾ç½®å®¹å™¨å¯åŠ¨æ—¶çš„ä¸»å‘½ä»¤ï¼ˆENTRYPOINT ä¸ä¼šè¢« docker run å‚æ•°è¦†ç›–ï¼‰</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;java <span class="variable">$JAVA_OPTS</span> -jar app.jar&quot;</span>]</span></span><br><span class="line"><span class="comment"># CMD æä¾›é»˜è®¤çš„è¿è¡Œå‚æ•°ï¼Œå¯ä»¥è¢« docker run è¦†ç›–</span></span><br><span class="line"><span class="comment"># è¿™é‡Œé€šè¿‡ Spring Boot å‚æ•°è®¾ç½®å¯åŠ¨ç¯å¢ƒå’Œç«¯å£å·</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;--spring.profiles.active=app&quot;</span>, <span class="string">&quot;--server.port=8080&quot;</span>]</span></span><br><span class="line"><span class="comment"># è¿™é‡Œä½¿ç”¨çš„æ˜¯ ENTRYPOINT + CMD çš„æ··åˆæ¨¡å¼</span></span><br><span class="line"><span class="comment"># å®Œæ•´å‘½ä»¤ï¼š java $JAVA_OPTS -jar app.jar --spring.profiles.active=app --server.port=8080</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ„å»ºé•œåƒ</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ„å»ºå¤šå¹³å°é•œåƒå¹¶å‘å¸ƒåˆ°dockerhub</span></span><br><span class="line">docker buildx build --platform linux/amd64,linux/arm64 -t hanqunfeng/springboot:latest --push .</span><br></pre></td></tr></table></figure><h2 id="å¦‚ä½•å°†æ„å»ºå¥½çš„å¤šä¸ªå•å¹³å°é•œåƒå‘å¸ƒä¸ºä¸€ä¸ªå¤šå¹³å°é•œåƒ">å¦‚ä½•å°†æ„å»ºå¥½çš„å¤šä¸ªå•å¹³å°é•œåƒå‘å¸ƒä¸ºä¸€ä¸ªå¤šå¹³å°é•œåƒ</h2><ul class="lvl-0"><li class="lvl-2"><p>å¦‚æœä½ å·²ç»åˆ†åˆ«æ„å»ºå¥½å•å¹³å°é•œåƒï¼Œä¹Ÿå¯ä»¥ç”¨ <code>docker buildx imagetools create</code> æ¥åˆå¹¶</p></li><li class="lvl-2"><p>ä»¥ä¸Šé¢åˆ›å»ºçš„ä¸¤ä¸ªå•å¹³å°é•œåƒä¸ºä¾‹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ—å‡ºé•œåƒ</span></span><br><span class="line">docker images</span><br><span class="line"><span class="comment">## è¾“å‡ºç»“æœ</span></span><br><span class="line">REPOSITORY              TAG                IMAGE ID       CREATED        SIZE</span><br><span class="line">app.amd64               latest             859162438372   2 hours ago    431MB</span><br><span class="line">app.arm64               latest             0058c70dd16e   2 hours ago    426MB</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸€å®šè¦æ¨é€å•å¹³å°é•œåƒåˆ°è¿œç¨‹ä»“åº“ï¼Œå¦åˆ™æ— æ³•å®Œæˆåˆå¹¶</span></span><br><span class="line">docker tag app.amd64 hanqunfeng/app:amd64</span><br><span class="line">docker push hanqunfeng/app:amd64</span><br><span class="line"></span><br><span class="line">docker tag app.arm64 hanqunfeng/app:arm64</span><br><span class="line">docker push hanqunfeng/app:arm64</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå¹¶ï¼Œåˆ›å»ºå¤šå¹³å°é•œåƒæŒ‡å‘ï¼ˆmanifest listï¼‰</span></span><br><span class="line">docker buildx imagetools create \</span><br><span class="line">  --tag hanqunfeng/app:latest \</span><br><span class="line">   hanqunfeng/app:amd64 \</span><br><span class="line">   hanqunfeng/app:arm64</span><br></pre></td></tr></table></figure><p><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/5azhzj.png" alt=""></p><ul class="lvl-0"><li class="lvl-2"><p>å¦‚æœä¸éœ€è¦å•å¹³å°é•œåƒï¼Œå¯ä»¥åœ¨dockerhubä¸Šåˆ é™¤å³å¯ã€‚</p></li></ul><h2 id="ç§»é™¤-BuildKitï¼ˆBuildxï¼‰æ„å»ºè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ç¼“å­˜æ•°æ®">ç§»é™¤ BuildKitï¼ˆBuildxï¼‰æ„å»ºè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ç¼“å­˜æ•°æ®</h2><ul class="lvl-0"><li class="lvl-2"><p>BuildKitï¼ˆBuildxï¼‰æ„å»ºè¿‡ç¨‹ä¼šäº§ç”Ÿç¼“å­˜æ•°æ®ï¼ŒåŒ…æ‹¬æœªä½¿ç”¨çš„ä¸­é—´é•œåƒã€æ„å»ºå±‚ç­‰ã€‚å¯¹äºé¢‘ç¹ä½¿ç”¨ Docker æ„å»ºçš„å¼€å‘è€…æ¥è¯´ï¼Œè¿™äº›ç¼“å­˜ä¼šé€æ¸å ç”¨å¤§é‡ç£ç›˜ç©ºé—´ã€‚</p></li><li class="lvl-2"><p>å¯ä»¥é€šè¿‡è¯¥å‘½ä»¤æŸ¥çœ‹ç¼“å­˜å ç”¨ç£ç›˜ç©ºé—´çš„å¤§å°</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker buildx <span class="built_in">du</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>docker buildx prune</code> æ˜¯ä¸€ä¸ªç”¨äº æ¸…ç† Docker Buildx æ„å»ºç¼“å­˜ çš„å‘½ä»¤ï¼Œå¸¸ç”¨äºé‡Šæ”¾ç£ç›˜ç©ºé—´ã€‚</p></li><li class="lvl-2"><p>å‘½ä»¤è¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker buildx prune [OPTIONS]</span><br></pre></td></tr></table></figure><table><thead><tr><th>OPTIONS</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td><code>-a</code>, <code>--all</code></td><td><strong>åŒ…æ‹¬å†…éƒ¨/å‰ç«¯é•œåƒ</strong>ã€‚é»˜è®¤åªåˆ é™¤æ— ç”¨ç¼“å­˜ï¼ŒåŠ ä¸Šè¯¥å‚æ•°ä¼šæ¸…é™¤æ›´å¤šç¼“å­˜å†…å®¹ï¼ŒåŒ…æ‹¬å¯èƒ½ä»å¯ç”¨çš„å†…å®¹ï¼ˆæ›´å½»åº•ï¼‰ã€‚</td></tr><tr><td><code>--builder string</code></td><td>æŒ‡å®šä½¿ç”¨å“ªä¸ª builder å®ä¾‹ï¼ˆå¯é€šè¿‡ <code>docker buildx ls</code> æŸ¥çœ‹å½“å‰æœ‰å“ªäº› builderï¼‰ã€‚</td></tr><tr><td><code>--filter filter</code></td><td>è®¾å®šæ¸…ç†æ¡ä»¶ï¼Œä¾‹å¦‚ï¼š<code>until=24h</code> è¡¨ç¤ºåªåˆ é™¤ 24 å°æ—¶å‰çš„ç¼“å­˜ã€‚</td></tr><tr><td><code>-f</code>, <code>--force</code></td><td><strong>ä¸æç¤ºç¡®è®¤ï¼Œç›´æ¥æ‰§è¡Œæ¸…ç†æ“ä½œ</strong>ã€‚å¸¸ç”¨äºè„šæœ¬ä¸­ã€‚</td></tr><tr><td><code>--keep-storage bytes</code></td><td>ä¿ç•™æŒ‡å®šå¤§å°çš„ç¼“å­˜ç©ºé—´ï¼Œå…¶ä½™åˆ é™¤ï¼ˆå¦‚ï¼š<code>--keep-storage 5GB</code>ï¼‰ã€‚</td></tr><tr><td><code>--verbose</code></td><td>è¾“å‡ºæ›´è¯¦ç»†çš„æ¸…ç†ä¿¡æ¯ã€‚</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„ç¼“å­˜ï¼Œå¹¶è·³è¿‡ç¡®è®¤æç¤º</span></span><br><span class="line">docker buildx prune -f</span><br><span class="line"></span><br><span class="line"><span class="comment"># åªåˆ é™¤ 24 å°æ—¶å‰çš„ç¼“å­˜ï¼Œä¿ç•™ 10GB çš„ç¼“å­˜ç©ºé—´</span></span><br><span class="line">docker buildx prune --filter <span class="string">&quot;until=24h&quot;</span> --keep-storage 10GB</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **åŠ ç²—**
 *æ–œä½“*
 ***åŠ ç²—å¹¶æ–œä½“***
 ~~åˆ é™¤çº¿~~
 ==çªå‡ºæ˜¾ç¤º==
 `çªå‡ºæ˜¾ç¤º(æ¨è)`
 ++ä¸‹åˆ’çº¿++
 ~ä¸‹æ ‡~
 ^ä¸Šæ ‡^
 è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.
 å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **ç‚¹å‡»æŠ˜å **
 è¿™æ˜¯è¢«éšè—çš„å†…å®¹
 +++

::: tips success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
:::

% note info % success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
% endnote %

å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}
 å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ
 --&gt;
&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ Dockerfile å¤šå¹³å°æ„å»ºçš„ä½¿ç”¨æ–¹æ³•&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com&quot;&gt;Dockerå®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com/engine/reference/builder/&quot;&gt;Dockerfileå®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com/build/building/multi-platform/&quot;&gt;Multi-platform builds&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/docker/"/>
    
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>Docker ä¹‹ è¿œç¨‹è¿æ¥</title>
    <link href="https://blog.hanqunfeng.com/2025/06/05/docker-remote-connection/"/>
    <id>https://blog.hanqunfeng.com/2025/06/05/docker-remote-connection/</id>
    <published>2025-06-05T13:30:05.000Z</published>
    <updated>2025-06-06T06:03:47.970Z</updated>
    
    <content type="html"><![CDATA[<!-- **åŠ ç²—** *æ–œä½“* ***åŠ ç²—å¹¶æ–œä½“*** ~~åˆ é™¤çº¿~~ ==çªå‡ºæ˜¾ç¤º== `çªå‡ºæ˜¾ç¤º(æ¨è)` ++ä¸‹åˆ’çº¿++ ~ä¸‹æ ‡~ ^ä¸Šæ ‡^ è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference. å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **ç‚¹å‡»æŠ˜å ** è¿™æ˜¯è¢«éšè—çš„å†…å®¹ +++::: tips success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹:::% note info % success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹% endnote %å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{} å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ --><h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2"><p>æœ¬æ–‡ä»‹ç»å¦‚ä½•è¿œç¨‹è¿æ¥Docker</p></li><li class="lvl-2"><p><a href="https://docs.docker.com">Dockerå®˜æ–¹æ–‡æ¡£</a></p></li></ul><span id="more"></span><h2 id="è¿œç¨‹è¿æ¥Dockeræœ‰å¦‚ä¸‹ä¸‰ç§æ–¹å¼">è¿œç¨‹è¿æ¥Dockeræœ‰å¦‚ä¸‹ä¸‰ç§æ–¹å¼</h2><h3 id="æ–¹å¼ä¸€ï¼šå¼€å¯-TCPï¼ˆä¸å¸¦-TLSï¼Œä»…ç”¨äºå†…ç½‘è°ƒè¯•ï¼‰">æ–¹å¼ä¸€ï¼šå¼€å¯ TCPï¼ˆä¸å¸¦ TLSï¼Œä»…ç”¨äºå†…ç½‘è°ƒè¯•ï¼‰</h3><ul class="lvl-0"><li class="lvl-2"><p>åœ¨dockeræœåŠ¡ç«¯ç¼–è¾‘ <code>/etc/docker/daemon.json</code>ï¼ŒåŠ ä¸Šï¼š</p></li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;hosts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;unix:///var/run/docker.sock&quot;</span><span class="punctuation">,</span> <span class="string">&quot;tcp://0.0.0.0:2375&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ­¤æ—¶é€šè¿‡<code>sudo systemctl restart docker</code>é‡å¯ Dockerä¼šå¯åŠ¨å¤±è´¥ï¼ŒåŸå› æ˜¯systemdä¼šåœ¨dockerå¯åŠ¨å‘½ä»¤ä¸­æ·»åŠ  <code>-H fd://</code>ï¼Œå…¶å«ä¹‰æ˜¯ä» systemd ä¼ é€’è¿›æ¥çš„ socket æ–‡ä»¶æè¿°ç¬¦ç›‘å¬ API è¯·æ±‚ï¼Œå½“ Docker è¢« systemd å¯åŠ¨å¹¶å¯ç”¨ socket activationï¼ˆå¥—æ¥å­—æ¿€æ´»ï¼‰æ—¶ï¼Œsystemd ä¼šé¢„å…ˆåˆ›å»º socketï¼ˆæ¯”å¦‚ /var/run/docker.sockï¼‰ï¼Œç„¶åå†å¯åŠ¨ dockerdï¼Œå¹¶é€šè¿‡æ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰æŠŠè¿™ä¸ª socket ä¼ é€’ç»™ dockerdã€‚æ­¤æ—¶ä½ åœ¨ dockerd ä¸­çœ‹åˆ°çš„ <code>-H fd://</code> æ„æ€æ˜¯ï¼šâ€œä¸ç”¨è‡ªå·±æ‰“å¼€ socketï¼Œå» systemd é‚£é‡Œæ‹¿å§ã€‚â€</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é€šè¿‡è¯¥å‘½ä»¤å¯ä»¥è·å– docker çš„å¯åŠ¨å‘½ä»¤æ–‡ä»¶æ˜¯ /usr/lib/systemd/system/docker.service</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl status docker</span><br><span class="line"><span class="comment"># æŸ¥çœ‹ /usr/lib/systemd/system/docker.serviceï¼Œå¯ä»¥çœ‹åˆ° dockerçš„å¯åŠ¨å‘½ä»¤å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°  -H fd://</span></span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span><br><span class="line"><span class="comment"># å¦å¤–å¯ä»¥åœ¨ä¸ docker.service åŒç›®å½•ä¸‹æ‰¾åˆ°  docker.socket æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹å†…å®¹</span></span><br><span class="line">ListenStream=/run/docker.sock <span class="comment"># /run ç›®å½•æ˜¯è¢«è½¯è¿æ¥åˆ° /var/run/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ€»ç»“ï¼šé€šè¿‡systemd å¯åŠ¨ dockeræ—¶ï¼Œå¦‚æœé…ç½®äº† -H fd://ï¼Œåˆ™ docker ä¼šç›‘å¬ /run/docker.sock æ–‡ä»¶ï¼Œå®é™…ä¸Šä¹Ÿå°±æ˜¯ /var/run/docker.sock</span></span><br><span class="line"><span class="comment"># è€Œæˆ‘ä»¬åœ¨/etc/docker/daemon.jsonä¸­åŠ ä¸Šçš„&quot;unix:///var/run/docker.sock&quot;, &quot;tcp://0.0.0.0:2375&quot;å®é™…ä¸Šå°±æ˜¯æ”¹å†™dockerçš„å¯åŠ¨å‚æ•°ï¼Œè¿™å°±ä¸ systemd å¯åŠ¨ docker çš„ `-H fd://` å‚æ•°å†²çªäº†</span></span><br><span class="line"><span class="comment"># æ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä¸ä½¿ç”¨systemd å¯åŠ¨ dockerï¼Œè€Œæ˜¯ä½¿ç”¨ docker daemon å¯åŠ¨ docker</span></span><br><span class="line"><span class="built_in">sudo</span> dockerd --containerd=/run/containerd/containerd.sock</span><br><span class="line"><span class="comment"># ä½†è¿™æ ·ä¸åˆ©äº docker çš„ç®¡ç†ï¼Œå› æ­¤æœ€å¥½çš„æ–¹å¼æ˜¯ç¦ç”¨ `-H fd://`</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¦ç”¨ <code>-H fd://</code>ï¼ˆsystemd ä¸ daemon.json å†²çªçš„æ ¹æºï¼‰</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ–¹å¼ä¸€: å»æ‰ `-H fd://` å‚æ•°</span></span><br><span class="line"><span class="built_in">sudo</span> vi /usr/lib/systemd/system/docker.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹å¼äºŒ(æ¨è): åˆ›å»º override.conf æ–‡ä»¶ï¼Œå…¶ä½œç”¨æ˜¯ è¦†ç›– systemd é»˜è®¤é…ç½®æ–‡ä»¶ï¼Œåªä¼šè¦†ç›–æŒ‡å®šçš„å‚æ•°</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /etc/systemd/system/docker.service.d</span><br><span class="line"><span class="built_in">sudo</span> vi /etc/systemd/system/docker.service.d/override.conf</span><br><span class="line"><span class="comment"># å¡«å…¥</span></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/bin/dockerd --containerd=/run/containerd/containerd.sock</span><br><span class="line"><span class="comment"># è¿™é‡Œé¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œ`--containerd=/run/containerd/containerd.sock` æ˜¯ docker é»˜è®¤å‚æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"># å‘Šè¯‰ Docker å®ˆæŠ¤è¿›ç¨‹å»è¿æ¥å·²æœ‰çš„ containerd å®ä¾‹ï¼Œè€Œä¸æ˜¯è‡ªå·±å¯åŠ¨ä¸€ä¸ªæ–°çš„ã€‚</span></span><br><span class="line"><span class="comment"># Docker é»˜è®¤å†…éƒ¨ä½¿ç”¨ containerd æ¥ç®¡ç†å®¹å™¨è¿è¡Œæ—¶ï¼Œæ‰€ä»¥è¿™æ¡å‚æ•°æ˜¯æ˜ç¡®æŒ‡å®šè¦ä½¿ç”¨å“ªä¸ª containerd æœåŠ¡ã€‚</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>é‡å¯ docker daemon</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line"><span class="built_in">sudo</span> systemctl restart docker</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åœ¨å®¢æˆ·ç«¯æµ‹è¯•è¿æ¥</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker -H tcp://è¿œç¨‹IP:2375 ps</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åœ¨å®¢æˆ·ç«¯åŠ å…¥ç¯å¢ƒå˜é‡åå°±ä¸éœ€è¦æ¯æ¬¡éƒ½åŠ ä¸Š -H å‚æ•°äº†</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># zsh å°±æ¢æˆ ~/.zshrc</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;export DOCKER_HOST=tcp://è¿œç¨‹IP:2375&quot;</span>  &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br><span class="line"><span class="comment"># æµ‹è¯•</span></span><br><span class="line">docker ps</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>â—ä¸è¦å¼€å¯æ— è®¤è¯çš„ <code>tcp://0.0.0.0:2375</code> åœ¨å…¬ç½‘ï¼Œè¿™æ˜¯è£¸å¥”çš„å®‰å…¨é£é™©ï¼Œä»»ä½•äººéƒ½èƒ½æ§åˆ¶ä½ çš„ Dockerã€‚</p></li><li class="lvl-2"><p>âœ… æ¨èæ–¹å¼æ˜¯ï¼š</p><ul class="lvl-2"><li class="lvl-6">ä½¿ç”¨ <code>tcp://0.0.0.0:2376 + --tlsverify</code></li><li class="lvl-6">æˆ–é€šè¿‡ <code>ssh:// éš§é“</code> è®¿é—® Docker</li></ul></li></ul><div class="tips"><p><em><strong>å°è´´å£«</strong></em></p><ul class="lvl-1"><li class="lvl-2">é€šè¿‡ä¸Šé¢çš„ä»‹ç»ä½ åº”è¯¥ææ˜ç™½ä¸€ä»¶äº‹ï¼Œå°±æ˜¯æˆ‘ä»¬å¯ä»¥ä¸ç”¨åœ¨ <code>/etc/docker/daemon.json</code> ä¸­é…ç½®è¿œç¨‹è¿æ¥ï¼Œè€Œæ˜¯é€šè¿‡ systemd æ¥é…ç½®ï¼Œå³åœ¨ <code>/usr/lib/systemd/system/docker.service</code> æˆ–è€… <code>/etc/systemd/system/docker.service.d/override.conf</code>ä¸­é…ç½®ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExecStart=/usr/bin/dockerd -H unix:///var/run/docker.sock -H tcp://0.0.0.0:2375 --containerd=/run/containerd/containerd.sock</span><br></pre></td></tr></table></figure><ul class="lvl-1"><li class="lvl-2">é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šæ—¢ç„¶ systemd å°±èƒ½æå®šä¸€åˆ‡ï¼Œé‚£è¿˜è¦ <code>/etc/docker/daemon.json</code> æœ‰ä»€ä¹ˆç”¨ï¼Ÿç­”æ¡ˆæ˜¯ï¼šå¯è¯»æ€§ã€å¯ç»´æŠ¤æ€§ã€å·¥å…·å…¼å®¹æ€§æ›´å¼ºã€‚</li></ul><table><thead><tr><th>é¡¹ç›®</th><th><code>daemon.json</code></th><th><code>systemd ExecStart</code></th></tr></thead><tbody><tr><td>è¯­æ³•</td><td>JSON</td><td>Shell å‘½ä»¤è¡Œ</td></tr><tr><td>é€‚åˆè®¾ç½®</td><td>Hostsã€æ—¥å¿—ã€registryã€é•œåƒé©±åŠ¨ç­‰</td><td>å¯åŠ¨å‘½ä»¤ã€èµ„æºé™åˆ¶ç­‰</td></tr><tr><td>å¯è¯»æ€§</td><td>ğŸ‘ ç»“æ„åŒ–</td><td>ğŸ‘ è¾ƒé•¿ã€å®¹æ˜“å‡ºé”™</td></tr><tr><td>è‡ªåŠ¨åŒ–æ”¯æŒ</td><td>ğŸ‘ å·¥å…·å‹å¥½</td><td>ğŸ‘ éœ€è¦ patch systemd</td></tr></tbody></table></div><h3 id="æ–¹å¼äºŒï¼šå¼€å¯-TCP-TLS-å®‰å…¨è®¿é—®ï¼ˆæ¨èç”¨äºå…¬ç½‘ï¼‰">æ–¹å¼äºŒï¼šå¼€å¯ TCP + TLS å®‰å…¨è®¿é—®ï¼ˆæ¨èç”¨äºå…¬ç½‘ï¼‰</h3><ul class="lvl-0"><li class="lvl-2"><p>åˆ›å»º TLS è¯ä¹¦ï¼Œé€šè¿‡ä¸€ä¸ªè„šæœ¬å®ç°ï¼Œè„šæœ¬åç§° <code>generate-docker-certs.sh</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line">SERVER_IP=166.189.9.114  <span class="comment"># ğŸš¨ ä¿®æ”¹ä¸ºä½ çš„ Docker æœåŠ¡å™¨ IP æˆ–åŸŸå</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[+] åˆ›å»º CA...&quot;</span></span><br><span class="line">openssl genrsa -out ca-key.pem 4096</span><br><span class="line">openssl req -new -x509 -days 365 \</span><br><span class="line">  -key ca-key.pem -subj <span class="string">&quot;/CN=docker-ca&quot;</span> -out ca.pem</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[+] åˆ›å»ºæœåŠ¡å™¨ç§é’¥...&quot;</span></span><br><span class="line">openssl genrsa -out server-key.pem 4096</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[+] åˆ›å»º OpenSSL é…ç½®æ–‡ä»¶...&quot;</span></span><br><span class="line"><span class="built_in">cat</span> &gt; extfile.cnf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[req]</span></span><br><span class="line"><span class="string">distinguished_name = req_distinguished_name</span></span><br><span class="line"><span class="string">x509_extensions = v3_req</span></span><br><span class="line"><span class="string">prompt = no</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[req_distinguished_name]</span></span><br><span class="line"><span class="string">CN = $&#123;SERVER_IP&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[v3_req]</span></span><br><span class="line"><span class="string">keyUsage = keyEncipherment, dataEncipherment</span></span><br><span class="line"><span class="string">extendedKeyUsage = serverAuth</span></span><br><span class="line"><span class="string">subjectAltName = @alt_names</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[alt_names]</span></span><br><span class="line"><span class="string">IP.1 = $&#123;SERVER_IP&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[+] åˆ›å»ºæœåŠ¡å™¨è¯ä¹¦ç­¾åè¯·æ±‚ (CSR)...&quot;</span></span><br><span class="line">openssl req -new -key server-key.pem \</span><br><span class="line">  -out server.csr -config extfile.cnf</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[+] ç­¾å‘æœåŠ¡å™¨è¯ä¹¦...&quot;</span></span><br><span class="line">openssl x509 -req -days 365 -<span class="keyword">in</span> server.csr \</span><br><span class="line">  -CA ca.pem -CAkey ca-key.pem -CAcreateserial \</span><br><span class="line">  -out server-cert.pem -extensions v3_req -extfile extfile.cnf</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[+] åˆ›å»ºå®¢æˆ·ç«¯ç§é’¥...&quot;</span></span><br><span class="line">openssl genrsa -out key.pem 4096</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[+] åˆ›å»ºå®¢æˆ·ç«¯ CSR...&quot;</span></span><br><span class="line">openssl req -new -key key.pem -subj <span class="string">&quot;/CN=client&quot;</span> -out client.csr</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[+] ç­¾å‘å®¢æˆ·ç«¯è¯ä¹¦...&quot;</span></span><br><span class="line"><span class="built_in">cat</span> &gt; client-ext.cnf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">extendedKeyUsage = clientAuth</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">openssl x509 -req -days 365 -<span class="keyword">in</span> client.csr \</span><br><span class="line">  -CA ca.pem -CAkey ca-key.pem -CAcreateserial \</span><br><span class="line">  -out cert.pem -extfile client-ext.cnf</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;[âœ“] æ‰€æœ‰è¯ä¹¦ç”Ÿæˆå®Œæˆï¼&quot;</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot; æœåŠ¡å™¨è¯ä¹¦: server-cert.pem, server-key.pem&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot; å®¢æˆ·ç«¯è¯ä¹¦: cert.pem, key.pem&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot; CAæ ¹è¯ä¹¦:   ca.pem&quot;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ‰§è¡Œè„šæœ¬</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x generate-docker-certs.sh</span><br><span class="line">./generate-docker-certs.sh</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å°†ä»¥ä¸‹è¯ä¹¦æ–‡ä»¶éƒ¨ç½²åˆ°dockeræœåŠ¡ç«¯</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æœåŠ¡ç«¯ï¼šserver-cert.pem, server-key.pem, ca.pem</span></span><br><span class="line"><span class="built_in">cp</span> server-cert.pem /etc/docker/server-cert.pem</span><br><span class="line"><span class="built_in">cp</span> server-key.pem /etc/docker/server-key.pem</span><br><span class="line"><span class="built_in">cp</span> ca.pem /etc/docker/ca.pem</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å°†ä»¥ä¸‹è¯ä¹¦æ–‡ä»¶éƒ¨ç½²åˆ°dockerå®¢æˆ·ç«¯</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cert.pem, key.pem, ca.pem</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åœ¨dockeræœåŠ¡ç«¯ç¼–è¾‘ <code>/etc/docker/daemon.json</code></p></li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;hosts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;unix:///var/run/docker.sock&quot;</span><span class="punctuation">,</span> <span class="string">&quot;tcp://0.0.0.0:2376&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tlsverify&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tlscacert&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/etc/docker/ca.pem&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tlscert&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/etc/docker/server-cert.pem&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tlskey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/etc/docker/server-key.pem&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¦ç”¨ <code>-H fd://</code>ï¼ˆsystemd ä¸ daemon.json å†²çªçš„æ ¹æºï¼‰</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /etc/systemd/system/docker.service.d</span><br><span class="line"><span class="built_in">sudo</span> vi /etc/systemd/system/docker.service.d/override.conf</span><br><span class="line"><span class="comment"># å¡«å…¥</span></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/bin/dockerd --containerd=/run/containerd/containerd.sock</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>é‡å¯ docker daemon</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line"><span class="built_in">sudo</span> systemctl restart docker</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åœ¨å®¢æˆ·ç«¯æµ‹è¯•è¿æ¥</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker \</span><br><span class="line">  --tlsverify \</span><br><span class="line">  --tlscacert=ca.pem \</span><br><span class="line">  --tlscert=cert.pem \</span><br><span class="line">  --tlskey=key.pem \</span><br><span class="line">  -H tcp://166.189.9.114:2376 \</span><br><span class="line">  ps</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åœ¨å®¢æˆ·ç«¯åŠ å…¥ç¯å¢ƒå˜é‡åå°±ä¸éœ€è¦æ¯æ¬¡éƒ½åŠ ä¸Š -H å‚æ•° å’Œè¯ä¹¦å‚æ•°äº†</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOT &gt;&gt; ~/.bashrc</span></span><br><span class="line"><span class="string"># è¿œç¨‹Docker IPå’Œç«¯å£</span></span><br><span class="line"><span class="string">export DOCKER_HOST=tcp://166.189.9.114:2376</span></span><br><span class="line"><span class="string"># ç”¨äºé€šè¿‡ TLSï¼ˆSSLï¼‰å®‰å…¨è¿æ¥è¿œç¨‹ Docker å®ˆæŠ¤è¿›ç¨‹ï¼Œç±»ä¼¼äº docker --tlsverify</span></span><br><span class="line"><span class="string">export DOCKER_TLS_VERIFY=1</span></span><br><span class="line"><span class="string"># è¿™ä¸ªç›®å½•ä¸‹è¦æœ‰è¿™äº›è¯ä¹¦æ–‡ä»¶ï¼šca.pem, cert.pem, key.pem</span></span><br><span class="line"><span class="string">export DOCKER_CERT_PATH=/path/to/certs</span></span><br><span class="line"><span class="string">EOT</span></span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br><span class="line"><span class="comment"># æµ‹è¯•</span></span><br><span class="line">docker ps</span><br></pre></td></tr></table></figure><h3 id="æ–¹å¼ä¸‰ï¼šssh-éš§é“è®¿é—®">æ–¹å¼ä¸‰ï¼šssh:// éš§é“è®¿é—®</h3><ul class="lvl-0"><li class="lvl-2"><p>æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯ä½¿ç”¨ ssh è¿œç¨‹æ‰§è¡Œå‘½ä»¤çš„æ–¹å¼ï¼Œè¿™ç§æ–¹å¼ä¸éœ€è¦ä»»ä½•é…ç½®ï¼Œæ”¯æŒå¯†ç å’Œè¯ä¹¦è®¤è¯ï¼Œä¹Ÿæ”¯æŒæŒ‡å®šç«¯å£ï¼Œä½†è¿™ä¸æ˜¯æ ‡å‡†çš„è¿œç¨‹è¿æ¥dockeræ–¹å¼ï¼Œé€‚ç”¨äºå¶å°”è®¿é—®çš„æƒ…å†µã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -i ~/.ssh/lexing-test.pem -p22 centos@166.189.9.114 <span class="string">&quot;docker ps&quot;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åŸºäºå…å¯†è®¤è¯ï¼Œå¦‚ä½•é…ç½®å…å¯†ç™»å½•å¯ä»¥å‚è€ƒ <a href="/2023/02/28/linux-command02-ssh/" title="Linuxå¸¸ç”¨å‘½ä»¤--sshã€scpä¸å…å¯†ç™»å½•">Linuxå¸¸ç”¨å‘½ä»¤--sshã€scpä¸å…å¯†ç™»å½•</a></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker -H è¿œç¨‹è®¿é—® ä¸æ”¯æŒåœ¨å‘½ä»¤è¡Œç›´æ¥è¾“å…¥å¯†ç æˆ–å¯†é’¥æ–‡ä»¶ï¼Œå¿…é¡»é…ç½®å…å¯†ç™»å½•æ‰å¯ä»¥ï¼Œè€Œä¸”æ­¤æ—¶ç«¯å£å¿…é¡»æ˜¯é»˜è®¤çš„22</span></span><br><span class="line"><span class="comment"># è¦æ±‚ç™»å½•ç”¨æˆ·å¿…é¡»æ‹¥æœ‰dockerçš„è¿è¡Œæƒé™ï¼ˆåŠ å…¥ docker groupï¼‰</span></span><br><span class="line">docker -H ssh://centos@166.189.9.114 ps</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åŸºäº<code>config</code>é…ç½®(æ¨è)</p><ul class="lvl-2"><li class="lvl-6">è¿™ç§æ–¹å¼çš„ä¼˜ç‚¹æ˜¯å¯ä»¥é…ç½®è¯ä¹¦å’Œç«¯å£</li><li class="lvl-6">åœ¨ ~/.ssh/config ä¸­æŒ‡å®šå…·ä½“çš„å¯†é’¥æ–‡ä»¶å’Œç«¯å£ï¼Œç™»å½•ç”¨æˆ·å¿…é¡»æ‹¥æœ‰dockerçš„è¿è¡Œæƒé™ï¼ˆåŠ å…¥ docker groupï¼‰</li></ul>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Host mydocker</span><br><span class="line">HostName 166.189.9.114</span><br><span class="line">User centos</span><br><span class="line">Port 22</span><br><span class="line">IdentityFile ~/.ssh/my_docker_key</span><br></pre></td></tr></table></figure><ul class="lvl-2"><li class="lvl-6">æµ‹è¯•</li></ul>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker -H ssh://mydocker ps</span><br></pre></td></tr></table></figure></li><li class="lvl-2"><p>æ·»åŠ ç¯å¢ƒå˜é‡é¿å…æ¯æ¬¡éƒ½åŠ ä¸Š <code>-H</code> å‚æ•°</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## åŸºäºå…å¯†è®¤è¯</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;export DOCKER_HOST=ssh://user@host&quot;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="comment">## æˆ–è€…åŸºäºconfigçš„æ–¹å¼</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;export DOCKER_HOST=ssh://mydocker&quot;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br><span class="line">docker ps</span><br></pre></td></tr></table></figure><h2 id="docker-context-åŒæ—¶è¿æ¥å¤šä¸ªè¿œç¨‹docker"><code>docker context</code>: åŒæ—¶è¿æ¥å¤šä¸ªè¿œç¨‹docker</h2><ul class="lvl-0"><li class="lvl-2"><p>ä¸Šé¢ä»‹ç»çš„ä¸‰ç§æ–¹å¼ï¼Œä¸ºäº†ç®€åŒ–è¿æ¥ï¼Œéƒ½åŠ ä¸Šäº†<code>DOCKER_HOST</code>ç¯å¢ƒå˜é‡ï¼Œä½†æ˜¯<code>DOCKER_HOST</code>åªèƒ½é…ç½®ä¸€ä¸ªï¼Œå¦‚æœæˆ‘ä»¬è¦åŒæ—¶è¿æ¥å¤šä¸ªè¿œç¨‹dockeræœåŠ¡å‘¢ï¼Œæ¯æ¬¡åˆ‡æ¢<code>DOCKER_HOST</code>ç¯å¢ƒå˜é‡å¤ªè¿‡ç¹çï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼ä¸ºæ¯ä¸ªè¿œç¨‹dockeræœåŠ¡åˆ›å»ºä¸€ä¸ª <code>context</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TCP</span></span><br><span class="line">docker context create remote-tcp \</span><br><span class="line">    --docker <span class="string">&quot;host=tcp://166.189.9.114:2375&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># TCP + TLS</span></span><br><span class="line">docker context create remote-tls \</span><br><span class="line">  --docker <span class="string">&quot;host=tcp://166.189.9.114:2376,ca=/path/ca.pem,cert=/path/cert.pem,key=/path/key.pem&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># sshéš§é“</span></span><br><span class="line">docker context create remote-ssh --docker <span class="string">&quot;host=ssh://mydocker&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨</span></span><br><span class="line">docker context <span class="built_in">ls</span> <span class="comment"># åˆ—å‡ºæ‰€æœ‰context</span></span><br><span class="line">docker context use remote-ssh <span class="comment"># åˆ‡æ¢åˆ°æŒ‡å®šçš„context</span></span><br><span class="line">docker ps <span class="comment"># æŸ¥çœ‹å®¹å™¨</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>docker context</code> æ˜¯ Docker CLI çš„ä¸€ä¸ªå¼ºå¤§åŠŸèƒ½ï¼Œå®ƒè®©ä½ å¯ä»¥è½»æ¾åœ°åœ¨ å¤šä¸ª Docker åç«¯ç¯å¢ƒä¹‹é—´åˆ‡æ¢ï¼Œæ¯”å¦‚ï¼š</p><ul class="lvl-2"><li class="lvl-6">æœ¬åœ° Dockerï¼ˆé»˜è®¤ï¼‰</li><li class="lvl-6">è¿œç¨‹ä¸»æœºçš„ Dockerï¼ˆé€šè¿‡ SSH æˆ– TCP/TLSï¼‰</li><li class="lvl-6">Docker Desktop</li><li class="lvl-6">Docker Swarm æˆ– Kubernetesï¼ˆéƒ¨åˆ†æ”¯æŒï¼‰</li></ul></li><li class="lvl-2"><p>å°±åƒä½ ç”¨ <code>kubectl config use-context</code> åˆ‡æ¢ Kubernetes é›†ç¾¤ï¼Œ<code>docker context</code> ä¹Ÿå…è®¸ä½ åœ¨å¤šä¸ª Docker åç«¯ä¹‹é—´åˆ‡æ¢ï¼Œè€Œæ— éœ€åå¤è®¾ç½® <code>DOCKER_HOST</code> ç¯å¢ƒå˜é‡æˆ–å†™ç¹ççš„ SSH éš§é“å‘½ä»¤ã€‚</p></li><li class="lvl-2"><p>å¸¸ç”¨å‘½ä»¤ä¸€è§ˆ</p></li></ul><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>docker context ls</code></td><td>åˆ—å‡ºæ‰€æœ‰ä¸Šä¸‹æ–‡</td></tr><tr><td><code>docker context use &lt;name&gt;</code></td><td>åˆ‡æ¢åˆ°æŒ‡å®š context</td></tr><tr><td><code>docker context create &lt;name&gt; --docker &quot;Docker endpoint config&quot;</code></td><td>åˆ›å»ºä¸€ä¸ªæ–°çš„ context</td></tr><tr><td><code>docker context rm &lt;name&gt;</code></td><td>åˆ é™¤ context</td></tr><tr><td><code>docker context inspect &lt;name&gt;</code></td><td>æŸ¥çœ‹ context è¯¦æƒ…</td></tr><tr><td><code>docker context update &lt;name&gt; --docker &quot;Docker endpoint config&quot;</code></td><td>æ›´æ–° context å‚æ•°ï¼ˆDocker 24+ æ”¯æŒï¼‰</td></tr><tr><td><code>docker context show</code></td><td>æ˜¾ç¤ºå½“å‰ context</td></tr><tr><td><code>docker context export &lt;name&gt; &lt;file.tar&gt;</code></td><td>å¯¼å‡º context åˆ°taræ–‡ä»¶</td></tr><tr><td><code>docker context import &lt;name&gt; &lt;file.tar&gt;</code></td><td>å¯¼å…¥ context ä»taræ–‡ä»¶</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>Docker endpoint config</p></li></ul><table><thead><tr><th>å‚æ•°å</th><th>ä¸­æ–‡æè¿°</th></tr></thead><tbody><tr><td><code>from</code></td><td>å¤åˆ¶æŒ‡å®š context åç§° çš„ Docker ç«¯ç‚¹é…ç½®</td></tr><tr><td><code>host</code></td><td>è¦è¿æ¥çš„ Docker ç«¯ç‚¹åœ°å€</td></tr><tr><td><code>ca</code></td><td>CA ç­¾åçš„è¯ä¹¦çš„è·¯å¾„</td></tr><tr><td><code>cert</code></td><td>TLS è¯ä¹¦æ–‡ä»¶çš„è·¯å¾„</td></tr><tr><td><code>key</code></td><td>TLS å¯†é’¥æ–‡ä»¶çš„è·¯å¾„</td></tr><tr><td><code>skip-tls-verify</code></td><td>è·³è¿‡ TLS è¯ä¹¦éªŒè¯ï¼ˆâš ï¸ ä¸å»ºè®®ç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰</td></tr></tbody></table><h2 id="ä¸‰ç§è¿œç¨‹è¿æ¥-Docker-çš„æ–¹å¼åŠå…¶ä¼˜ç¼ºç‚¹æ€»ç»“">ä¸‰ç§è¿œç¨‹è¿æ¥ Docker çš„æ–¹å¼åŠå…¶ä¼˜ç¼ºç‚¹æ€»ç»“</h2><table><thead><tr><th>è¿æ¥æ–¹å¼</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td><strong>1. SSH æ–¹å¼ (<code>ssh://</code>)</strong></td><td>- é…ç½®ç®€å•ï¼Œæ— éœ€é¢å¤–å¼€å¯ Docker TCP ç«¯å£å’Œ TLS<br>- å®‰å…¨æ€§é«˜ï¼ŒåŸºäº SSH åŠ å¯†å’Œè®¤è¯<br>- ä¸ç”¨å¼€æ”¾é¢å¤–ç«¯å£ï¼Œé˜²ç«å¢™å‹å¥½<br>- æ˜“äºç”¨ SSH ä»£ç†å’Œå¯†é’¥ç®¡ç†</td><td>- éœ€è¦è¿œç¨‹ç”¨æˆ·æœ‰ Docker æƒé™ï¼ˆå¦‚å±äº <code>docker</code> ç»„ï¼‰<br>- è¿æ¥é€Ÿåº¦å¯èƒ½å— SSH è¿æ¥å½±å“<br>- éœ€è¦åœ¨æœ¬åœ°å®‰è£…å¹¶é…ç½® SSH</td><td>å¼€å‘ç¯å¢ƒã€å†…ç½‘ç®¡ç†ã€å°è§„æ¨¡è¿œç¨‹æ“ä½œ</td></tr><tr><td><strong>2. TCP + TLS æ–¹å¼</strong></td><td>- æ ‡å‡†çš„è¿œç¨‹ Docker API è®¿é—®<br>- æ”¯æŒè¯ä¹¦è®¤è¯ï¼Œå®‰å…¨æ€§é«˜<br>- å¯ä»¥é…ç½®å¤šä¸ªå®¢æˆ·ç«¯å’Œæƒé™æ§åˆ¶<br>- é€‚åˆè‡ªåŠ¨åŒ–è„šæœ¬ã€CI/CD è®¿é—®</td><td>- é…ç½®è¾ƒå¤æ‚ï¼Œéœ€è¦ç”Ÿæˆå’Œç®¡ç† CAã€æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯è¯ä¹¦<br>- éœ€è¦å¼€æ”¾ TCP ç«¯å£ï¼ˆå¦‚ 2376ï¼‰ï¼Œå¢åŠ å®‰å…¨é£é™©<br>- è¯ä¹¦é…ç½®é”™è¯¯å®¹æ˜“å¯¼è‡´è¿æ¥å¤±è´¥</td><td>ç”Ÿäº§ç¯å¢ƒã€è‡ªåŠ¨åŒ–é›†æˆã€éœ€è¦é«˜å®‰å…¨è®¤è¯</td></tr><tr><td><strong>3. TCP æ˜æ–‡è®¿é—®ï¼ˆæ—  TLSï¼‰</strong></td><td>- é…ç½®æœ€ç®€å•ï¼Œåªéœ€ç›‘å¬ TCP ç«¯å£<br>- æ–¹ä¾¿å¿«é€Ÿæµ‹è¯•å’Œè°ƒè¯•</td><td>- æåº¦ä¸å®‰å…¨ï¼Œæ•°æ®æ˜æ–‡ä¼ è¾“<br>- ä»»ä½•äººéƒ½å¯è®¿é—® Docker APIï¼Œææ˜“è¢«æ”»å‡»<br>- ç”Ÿäº§ç¯å¢ƒä¸¥é‡ä¸å»ºè®®ä½¿ç”¨</td><td>ä»…é™å±€åŸŸç½‘å†…æµ‹è¯•æˆ–æç®€ç¯å¢ƒ</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;!--
 **åŠ ç²—**
 *æ–œä½“*
 ***åŠ ç²—å¹¶æ–œä½“***
 ~~åˆ é™¤çº¿~~
 ==çªå‡ºæ˜¾ç¤º==
 `çªå‡ºæ˜¾ç¤º(æ¨è)`
 ++ä¸‹åˆ’çº¿++
 ~ä¸‹æ ‡~
 ^ä¸Šæ ‡^
 è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.
 å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **ç‚¹å‡»æŠ˜å **
 è¿™æ˜¯è¢«éšè—çš„å†…å®¹
 +++

::: tips success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
:::

% note info % success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
% endnote %

å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}
 å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ
 --&gt;
&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;æœ¬æ–‡ä»‹ç»å¦‚ä½•è¿œç¨‹è¿æ¥Docker&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com&quot;&gt;Dockerå®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/docker/"/>
    
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>Docker å‘½ä»¤ ä¹‹ docker compose</title>
    <link href="https://blog.hanqunfeng.com/2025/06/04/docker-compose/"/>
    <id>https://blog.hanqunfeng.com/2025/06/04/docker-compose/</id>
    <published>2025-06-04T13:30:05.000Z</published>
    <updated>2025-06-12T07:24:46.165Z</updated>
    
    <content type="html"><![CDATA[<!-- **åŠ ç²—** *æ–œä½“* ***åŠ ç²—å¹¶æ–œä½“*** ~~åˆ é™¤çº¿~~ ==çªå‡ºæ˜¾ç¤º== `çªå‡ºæ˜¾ç¤º(æ¨è)` ++ä¸‹åˆ’çº¿++ ~ä¸‹æ ‡~ ^ä¸Šæ ‡^ è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference. å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **ç‚¹å‡»æŠ˜å ** è¿™æ˜¯è¢«éšè—çš„å†…å®¹ +++::: tips success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹:::% note info % success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹% endnote %å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{} å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ --><h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2"><p>æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ <code>docker compose</code> çš„ä½¿ç”¨æ–¹æ³•</p></li><li class="lvl-2"><p><a href="https://docs.docker.com">Dockerå®˜æ–¹æ–‡æ¡£</a></p></li><li class="lvl-2"><p><a href="https://docs.docker.com/compose/">docker compose</a></p></li><li class="lvl-2"><p><a href="https://docs.docker.com/reference/compose-file/">Compose file reference</a></p></li></ul><span id="more"></span><h2 id="docker-compose-æ˜¯ä»€ä¹ˆï¼Ÿ"><code>docker compose</code> æ˜¯ä»€ä¹ˆï¼Ÿ</h2><ul class="lvl-0"><li class="lvl-2"><p>Docker Composeæ˜¯ä¸€ä¸ªç”¨äºå®šä¹‰å’Œè¿è¡Œå¤šå®¹å™¨åº”ç”¨ç¨‹åºçš„å·¥å…·ã€‚</p></li><li class="lvl-2"><p>Composeç®€åŒ–äº†å¯¹æ•´ä¸ªåº”ç”¨ç¨‹åºå †æ ˆçš„æ§åˆ¶ï¼Œä¾¿äºåœ¨å•ä¸ªYAMLé…ç½®æ–‡ä»¶ä¸­ç®¡ç†æœåŠ¡ã€ç½‘ç»œå’Œå·ã€‚ç„¶åï¼Œé€šè¿‡ä¸€ä¸ªå‘½ä»¤ï¼Œæ‚¨ä»é…ç½®æ–‡ä»¶ä¸­åˆ›å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡ã€‚</p></li><li class="lvl-2"><p>Docker Compose çš„ä¼˜åŠ¿ï¼š</p></li></ul><table><thead><tr><th>ä¼˜ç‚¹</th><th>æè¿°</th></tr></thead><tbody><tr><td>ç®€åŒ–æ§åˆ¶</td><td>Docker Compose å…è®¸åœ¨å•ä¸ª YAML æ–‡ä»¶ä¸­å®šä¹‰å’Œç®¡ç†å¤šå®¹å™¨åº”ç”¨ç¨‹åºï¼Œç®€åŒ–äº†æœåŠ¡ç¼–æ’ä¸åè°ƒï¼Œä½¿ç¯å¢ƒç®¡ç†å’Œå¤åˆ¶æ›´å®¹æ˜“ã€‚</td></tr><tr><td>é«˜æ•ˆçš„åä½œ</td><td>é…ç½®æ–‡ä»¶æ˜“äºå…±äº«ï¼Œä¿ƒè¿›å¼€å‘äººå‘˜ã€è¿è¥å›¢é˜Ÿå’Œå…¶ä»–åˆ©ç›Šç›¸å…³è€…ä¹‹é—´çš„åä½œï¼Œä»è€Œæå‡å·¥ä½œæµç¨‹æ•ˆç‡å’Œé—®é¢˜è§£å†³é€Ÿåº¦ã€‚</td></tr><tr><td>å¿«é€Ÿåº”ç”¨ç¨‹åºå¼€å‘</td><td>Compose åˆ©ç”¨ç¼“å­˜é‡å¤ä½¿ç”¨æœªæ›´æ”¹æœåŠ¡çš„å®¹å™¨ï¼ŒåŠ å¿«ç¯å¢ƒå˜æ›´é€Ÿåº¦ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚</td></tr><tr><td>è·¨ç¯å¢ƒçš„å¯ç§»æ¤æ€§</td><td>æ”¯æŒåœ¨ Compose æ–‡ä»¶ä¸­ä½¿ç”¨å˜é‡ï¼Œä½¿é…ç½®èƒ½æ ¹æ®ä¸åŒç¯å¢ƒæˆ–ç”¨æˆ·è¿›è¡Œè‡ªå®šä¹‰ï¼Œå¢å¼ºäº†å¯ç§»æ¤æ€§ã€‚</td></tr><tr><td>å¹¿æ³›çš„ç¤¾åŒºå’Œæ”¯æŒ</td><td>æ‹¥æœ‰æ´»è·ƒçš„ç¤¾åŒºï¼Œæä¾›ä¸°å¯Œçš„èµ„æºã€æ•™ç¨‹å’ŒæŠ€æœ¯æ”¯æŒï¼Œæœ‰åŠ©äºæŒç»­æ”¹è¿›ä¸é«˜æ•ˆæ’éšœã€‚</td></tr></tbody></table><h2 id="docker-compose-å®‰è£…"><code>docker compose</code> å®‰è£…</h2><ul class="lvl-0"><li class="lvl-2"><p>åŒdockerä¸€èµ·å®‰è£…</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…dockeråŒæ—¶å®‰è£…docker composeï¼Œè¿™é‡Œ docker-compose-plugin å°±æ˜¯docker compose</span></span><br><span class="line"><span class="built_in">sudo</span> dnf install docker-ce-3:26.1.3-1.el8 docker-ce-cli-3:26.1.3-1.el8 containerd.io docker-buildx-plugin docker-compose-plugin -y</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å•ç‹¬å®‰è£…</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è‹¥å®‰è£…dockeræ—¶æ²¡æœ‰å®‰è£… docker-compose-plugin ï¼Œåˆ™éœ€è¦å•ç‹¬å®‰è£…</span></span><br><span class="line"><span class="built_in">sudo</span> dnf install docker-compose-plugin -y</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æŸ¥çœ‹ç‰ˆæœ¬</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker compose version</span><br></pre></td></tr></table></figure><div class="tips"><p><em><strong>ç›´æ¥ä¸‹è½½docker-composeçš„å‘½ä»¤æ–‡ä»¶</strong></em></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Install Docker Composeï¼Œæ³¨æ„é€šè¿‡è¿™ç§æ–¹å¼å®‰è£…çš„composeçš„ä½¿ç”¨æ–¹å¼ä¸º `docker-compose`ï¼Œè€Œéæ ‡å‡†çš„ `docker compose`</span></span><br><span class="line"><span class="built_in">sudo</span> curl -L <span class="string">&quot;https://github.com/docker/compose/releases/latest/download/docker-compose-<span class="subst">$(uname -s)</span>-<span class="subst">$(uname -m)</span>&quot;</span> -o /usr/local/bin/docker-compose</span><br><span class="line"><span class="comment"># Make the docker-compose command available</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> +x /usr/local/bin/docker-compose</span><br><span class="line"><span class="comment"># Check Docker Compose version</span></span><br><span class="line">docker-compose version</span><br></pre></td></tr></table></figure></div><h2 id="docker-compose-å‘½ä»¤"><code>docker compose</code> å‘½ä»¤</h2><table><thead><tr><th>å‘½ä»¤</th><th>ä¸­æ–‡è¯´æ˜</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>attach</td><td>è¿æ¥åˆ°æœåŠ¡çš„è¿è¡Œä¸­å®¹å™¨çš„æ ‡å‡†è¾“å…¥ã€è¾“å‡ºå’Œé”™è¯¯æµ</td><td><code>docker compose attach web</code></td></tr><tr><td>build</td><td>æ„å»ºæˆ–é‡æ–°æ„å»ºæœåŠ¡</td><td><code>docker compose build</code></td></tr><tr><td>config</td><td>è§£æå¹¶æ ‡å‡†åŒ– Compose æ–‡ä»¶</td><td><code>docker compose config</code></td></tr><tr><td>cp</td><td>åœ¨æœåŠ¡å®¹å™¨ä¸æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¹‹é—´å¤åˆ¶æ–‡ä»¶/æ–‡ä»¶å¤¹</td><td><code>docker compose cp web:/app/file.txt ./file.txt</code></td></tr><tr><td>create</td><td>ä¸ºæœåŠ¡åˆ›å»ºå®¹å™¨ï¼Œä½†ä¸å¯åŠ¨</td><td><code>docker compose create</code></td></tr><tr><td>down</td><td>åœæ­¢å¹¶ç§»é™¤å®¹å™¨ã€ç½‘ç»œç­‰èµ„æº</td><td><code>docker compose down</code></td></tr><tr><td>events</td><td>å®æ—¶æ¥æ”¶å®¹å™¨äº‹ä»¶</td><td><code>docker compose events</code></td></tr><tr><td>exec</td><td>åœ¨è¿è¡Œä¸­çš„å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤</td><td><code>docker compose exec web ls /app</code></td></tr><tr><td>images</td><td>åˆ—å‡ºå·²åˆ›å»ºå®¹å™¨æ‰€ä½¿ç”¨çš„é•œåƒ</td><td><code>docker compose images</code></td></tr><tr><td>kill</td><td>å¼ºåˆ¶åœæ­¢æœåŠ¡å®¹å™¨</td><td><code>docker compose kill</code></td></tr><tr><td>logs</td><td>æŸ¥çœ‹æœåŠ¡å®¹å™¨çš„æ—¥å¿—è¾“å‡º</td><td><code>docker compose logs</code></td></tr><tr><td>ls</td><td>åˆ—å‡ºå½“å‰è¿è¡Œçš„ Compose é¡¹ç›®</td><td><code>docker compose ls</code></td></tr><tr><td>pause</td><td>æš‚åœæœåŠ¡å®¹å™¨</td><td><code>docker compose pause</code></td></tr><tr><td>port</td><td>æ˜¾ç¤ºæŸç«¯å£æ˜ å°„çš„å…¬ç½‘åœ°å€</td><td><code>docker compose port web 80</code></td></tr><tr><td>ps</td><td>åˆ—å‡ºæœåŠ¡çš„å®¹å™¨</td><td><code>docker compose ps</code></td></tr><tr><td>pull</td><td>æ‹‰å–æœåŠ¡ä½¿ç”¨çš„é•œåƒ</td><td><code>docker compose pull</code></td></tr><tr><td>push</td><td>æ¨é€æœåŠ¡é•œåƒåˆ°ä»“åº“</td><td><code>docker compose push</code></td></tr><tr><td>restart</td><td>é‡å¯æœåŠ¡å®¹å™¨</td><td><code>docker compose restart</code></td></tr><tr><td>rm</td><td>ç§»é™¤å·²åœæ­¢çš„æœåŠ¡å®¹å™¨</td><td><code>docker compose rm</code></td></tr><tr><td>run</td><td>åœ¨æœåŠ¡ä¸Šè¿è¡Œä¸€æ¬¡æ€§å‘½ä»¤</td><td><code>docker compose run web echo Hello</code></td></tr><tr><td>scale</td><td>æ‰©å±•æœåŠ¡å®ä¾‹æ•°é‡</td><td><code>docker compose up --scale web=3</code></td></tr><tr><td>start</td><td>å¯åŠ¨å·²å­˜åœ¨ä½†å·²åœæ­¢çš„æœåŠ¡å®¹å™¨</td><td><code>docker compose start</code></td></tr><tr><td>stats</td><td>å®æ—¶æ˜¾ç¤ºå®¹å™¨èµ„æºä½¿ç”¨æƒ…å†µ</td><td><code>docker compose stats</code></td></tr><tr><td>stop</td><td>åœæ­¢è¿è¡Œä¸­çš„æœåŠ¡å®¹å™¨</td><td><code>docker compose stop</code></td></tr><tr><td>top</td><td>æ˜¾ç¤ºå®¹å™¨å†…çš„è¿è¡Œè¿›ç¨‹</td><td><code>docker compose top</code></td></tr><tr><td>unpause</td><td>å–æ¶ˆæš‚åœæœåŠ¡å®¹å™¨</td><td><code>docker compose unpause</code></td></tr><tr><td>up</td><td>åˆ›å»ºå¹¶å¯åŠ¨æœåŠ¡å®¹å™¨</td><td><code>docker compose up</code></td></tr><tr><td>version</td><td>æ˜¾ç¤º Docker Compose ç‰ˆæœ¬ä¿¡æ¯</td><td><code>docker compose version</code></td></tr><tr><td>wait</td><td>é˜»å¡ç›´åˆ°ç¬¬ä¸€ä¸ªæœåŠ¡å®¹å™¨åœæ­¢</td><td><code>docker compose wait</code></td></tr><tr><td>watch</td><td>ç›‘å¬æœåŠ¡æ„å»ºä¸Šä¸‹æ–‡å˜æ›´å¹¶é‡æ–°æ„å»º/åˆ·æ–°å®¹å™¨</td><td><code>docker compose watch</code></td></tr></tbody></table><h3 id="docker-compose-å¸¸ç”¨å‘½ä»¤"><code>docker compose</code> å¸¸ç”¨å‘½ä»¤</h3><ul class="lvl-0"><li class="lvl-2"><p>å¯åŠ¨ä¸å…³é—­</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯åŠ¨å¹¶è¿è¡Œï¼Œé»˜è®¤ä½¿ç”¨å½“å‰ç›®å½•çš„ docker-compose.yml æ–‡ä»¶</span></span><br><span class="line">docker compose up</span><br><span class="line"><span class="comment"># åå°è¿è¡Œ</span></span><br><span class="line">docker compose up -d</span><br><span class="line"><span class="comment"># æŒ‡å®šcomposeæ–‡ä»¶</span></span><br><span class="line">docker compose -f docker-compose.yml up -d</span><br><span class="line"><span class="comment"># å¯åŠ¨æ—¶é‡å»ºæœåŠ¡ï¼Œå½“ä¿®æ”¹äº† compose æ–‡ä»¶æ—¶</span></span><br><span class="line">docker compose up --build</span><br><span class="line"><span class="comment"># åœæ­¢service</span></span><br><span class="line">docker compose stop</span><br><span class="line"><span class="comment"># å¼ºåˆ¶åœæ­¢serviceï¼Œå½“ stop å‘½ä»¤æ— æ³•åœæ­¢æ—¶</span></span><br><span class="line">docker compose <span class="built_in">kill</span></span><br><span class="line"><span class="comment"># é‡å¯service</span></span><br><span class="line">docker compose restart</span><br><span class="line"><span class="comment"># åˆ é™¤serviceï¼Œ-s å‚æ•°è¡¨ç¤ºåˆ é™¤å‰å…ˆåœæ­¢å®¹å™¨</span></span><br><span class="line">docker compose <span class="built_in">rm</span> -s</span><br><span class="line"><span class="comment"># åœæ­¢å¹¶åˆ é™¤serviceï¼ŒåŒæ—¶åˆ é™¤ç½‘ç»œï¼Œä½†ä¸ä¼šåˆ é™¤å·</span></span><br><span class="line">docker compose down</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç›‘æ§</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ—å‡ºå½“å‰è¿è¡Œçš„ Compose é¡¹ç›®</span></span><br><span class="line">docker compose <span class="built_in">ls</span></span><br><span class="line"><span class="comment"># æŸ¥çœ‹serviceçŠ¶æ€ï¼Œ-a æ˜¾ç¤ºæ‰€æœ‰service</span></span><br><span class="line">docker compose ps -a</span><br><span class="line"><span class="comment"># è§£æå¹¶æ ‡å‡†åŒ– compose æ–‡ä»¶ï¼Œè¿™ä¸ªå‘½ä»¤å¯ä»¥æ£€æŸ¥ docker-compose.yml æ–‡ä»¶è¯­æ³•æ˜¯å¦æ­£ç¡®ï¼Œä½†ä¸ä¿è¯é€»è¾‘æ­£ç¡®</span></span><br><span class="line">docker compose config</span><br><span class="line"><span class="comment"># æŸ¥çœ‹ä½¿ç”¨çš„é•œåƒ</span></span><br><span class="line">docker compose images</span><br><span class="line"><span class="comment"># æŸ¥çœ‹è¿›ç¨‹</span></span><br><span class="line">docker compose top</span><br><span class="line"><span class="comment"># æŸ¥çœ‹serviceèµ„æºä½¿ç”¨æƒ…å†µ</span></span><br><span class="line">docker compose stats</span><br><span class="line"><span class="comment"># æŸ¥çœ‹serviceæ—¥å¿—ï¼Œ-f è¡¨ç¤ºæŒç»­è·Ÿè¸ª</span></span><br><span class="line">docker compose logs -f</span><br><span class="line"><span class="comment"># æŸ¥çœ‹æŒ‡å®šserviceçš„æ—¥å¿—</span></span><br><span class="line">docker compose logs -f service_name</span><br><span class="line"><span class="comment"># è¿›å…¥æŒ‡å®šçš„serviceå®¹å™¨</span></span><br><span class="line">docker compose <span class="built_in">exec</span> service_name bash</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å‡çº§é•œåƒ</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…ˆåœæ­¢æ‰€æœ‰service</span></span><br><span class="line">docker compose down</span><br><span class="line"><span class="comment"># æ‹‰å–æœ€æ–°é•œåƒ</span></span><br><span class="line">docker compose pull</span><br><span class="line"><span class="comment"># å¯åŠ¨service</span></span><br><span class="line">docker compose up -d --build</span><br></pre></td></tr></table></figure><h2 id="docker-compose-yml-çš„è¯­æ³•"><code>docker-compose.yml</code> çš„è¯­æ³•</h2><ul class="lvl-0"><li class="lvl-2"><p>å¸¸ç”¨æŒ‡ä»¤</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&quot;3.8&quot;</span> <span class="comment"># å®šä¹‰ç‰ˆæœ¬ï¼Œè¡¨ç¤ºå½“å‰ä½¿ç”¨çš„ docker compose è¯­æ³•çš„ç‰ˆæœ¬ï¼Œå·²è¿‡æ—¶ ï¼Œæ–°ç‰ˆ Docker ä¼šä½¿ç”¨æœ€æ–°çš„ Compose Specification è‡ªåŠ¨è§£æ</span></span><br><span class="line">name: <span class="string">&quot;project_name&quot;</span> <span class="comment">#  é¡¹ç›®åï¼Œé»˜è®¤ docker-compose.yml æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•åï¼Œä¸æ¨èè®¾ç½®</span></span><br><span class="line">services: <span class="comment"># æœåŠ¡åˆ—è¡¨</span></span><br><span class="line">  servicename: <span class="comment"># æœåŠ¡åå­—ï¼Œåªèƒ½åŒ…å«å°å†™å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€ä¸­åˆ’çº¿ï¼Œå¿…é¡»ä»¥å­—æ¯æˆ–æ•°å­—å¼€å¤´</span></span><br><span class="line">    build: <span class="comment"># åŸºäºDockerfileæ„å»ºç›®å½•ï¼Œå¦‚æœåŒæ—¶è®¾ç½®äº† image é€‰é¡¹ï¼Œåˆ™imageæŒ‡å®šçš„å°±æ˜¯æ„å»ºåçš„é•œåƒåç§°</span></span><br><span class="line">    image: <span class="comment"># é•œåƒçš„åå­—ï¼Œé»˜è®¤ä»è¿œç¨‹ä»“åº“æ‹‰å–ï¼Œå¦‚æœé…ç½®äº† build é€‰é¡¹ï¼Œåˆ™imageæŒ‡å®šçš„å°±æ˜¯æ„å»ºåçš„é•œåƒåç§°</span></span><br><span class="line">    <span class="built_in">command</span>: <span class="comment"># å¯é€‰ï¼Œå¦‚æœè®¾ç½®ï¼Œåˆ™ä¼šè¦†ç›–é»˜è®¤é•œåƒé‡Œçš„ CMD å‘½ä»¤</span></span><br><span class="line">    environment: <span class="comment"># å¯é€‰ï¼Œç­‰ä»·äº docker container run é‡Œçš„ --env é€‰é¡¹è®¾ç½®ç¯å¢ƒå˜é‡</span></span><br><span class="line">    volumes: <span class="comment"># å¯é€‰ï¼Œç­‰ä»·äº docker container run é‡Œçš„ -v é€‰é¡¹ ç»‘å®šæ•°æ®å·</span></span><br><span class="line">    networks: <span class="comment"># å¯é€‰ï¼Œç­‰ä»·äº docker container run é‡Œçš„ --network é€‰é¡¹æŒ‡å®šç½‘ç»œ</span></span><br><span class="line">    ports: <span class="comment"># å¯é€‰ï¼Œç­‰ä»·äº docker container run é‡Œçš„ -p é€‰é¡¹æŒ‡å®šç«¯å£æ˜ å°„</span></span><br><span class="line">    expose: <span class="comment"># å¯é€‰ï¼ŒæŒ‡å®šå®¹å™¨æš´éœ²çš„ç«¯å£</span></span><br><span class="line">    depends_on: <span class="comment"># æœåŠ¡ä¾èµ–çš„å…¶å®ƒæœåŠ¡</span></span><br><span class="line">    env_file: <span class="comment"># ç¯å¢ƒå˜é‡æ–‡ä»¶ï¼Œç”Ÿäº§ç¯å¢ƒæ›´æ¨èè¿™ç§æ–¹å¼</span></span><br><span class="line">  servicename2:</span><br><span class="line">    image:</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">    networks:</span><br><span class="line">    ports:</span><br><span class="line">  servicename3:</span><br><span class="line">    <span class="comment">#...</span></span><br><span class="line"></span><br><span class="line">volumes: <span class="comment"># å¯é€‰ï¼Œç­‰ä»·äº docker volume create</span></span><br><span class="line">networks: <span class="comment"># å¯é€‰ï¼Œç­‰ä»·äº docker network create</span></span><br></pre></td></tr></table></figure><h3 id="volumes">volumes</h3><ul class="lvl-0"><li class="lvl-2"><p>å·æ˜¯ç”±å®¹å™¨å¼•æ“å®ç°çš„æŒä¹…æ•°æ®å­˜å‚¨ã€‚Compose ä¸ºæœåŠ¡æä¾›äº†ä¸€ç§ä¸­ç«‹çš„æŒ‚è½½å·çš„æ–¹å¼ï¼Œå¹¶é€šè¿‡é…ç½®å‚æ•°å°†å·åˆ†é…ç»™åŸºç¡€æ¶æ„ã€‚é¡¶çº§volumeså£°æ˜å…è®¸æ‚¨é…ç½®å¯åœ¨å¤šä¸ªæœåŠ¡ä¹‹é—´é‡å¤ä½¿ç”¨çš„å‘½åå·ã€‚</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">backend:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">example/database</span></span><br><span class="line">    <span class="attr">volumes:</span> <span class="comment"># æŒ‚è½½å·æ˜ å°„</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db-data:/etc/data</span> <span class="comment"># æŒ‚è½½åˆ°å®¹å™¨çš„/etc/dataç›®å½•</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">backup:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">backup-service</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db-data:/var/lib/backup/data</span> <span class="comment"># ä¸€ä¸ªå·å¯ä»¥è¢«å¤šä¸ªæœåŠ¡ä½¿ç”¨</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span> <span class="comment"># å­˜å‚¨å·é…ç½®</span></span><br><span class="line">  <span class="attr">db-data:</span>  <span class="comment"># åˆ›å»ºä¸€ä¸ªåä¸ºdb-dataçš„å·ï¼Œå®é™…çš„ç½‘ç»œåç§°æ˜¯ å®¹å™¨ç»„åç§°_è¿™é‡Œçš„åç§°</span></span><br></pre></td></tr></table></figure><h4 id="volumes-çš„å±æ€§">volumes çš„å±æ€§</h4><ul class="lvl-0"><li class="lvl-2"><p>driver: å·ç±»å‹ï¼Œé»˜è®¤ä¸ºlocalï¼ŒæŒ‡å®šåº”ä½¿ç”¨å“ªä¸ªå·é©±åŠ¨ç¨‹åºã€‚å¦‚æœè¯¥é©±åŠ¨ç¨‹åºä¸å¯ç”¨ï¼ŒCompose å°†è¿”å›é”™è¯¯å¹¶ä¸”ä¸ä¼šéƒ¨ç½²è¯¥åº”ç”¨ç¨‹åºã€‚</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">db-data:</span> <span class="comment"># å£°æ˜ä¸€ä¸ªåä¸ºdb-dataçš„å·</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span> <span class="comment"># æŒ‡å®šå·ç±»å‹ï¼Œè¿™ä¸ªæ˜¯é»˜è®¤å€¼ï¼Œå¯ä»¥ä¸é…ç½®</span></span><br><span class="line">  <span class="attr">db-data2:</span> <span class="comment"># å£°æ˜ä¸€ä¸ªåä¸ºdb-data2çš„å·ï¼Œè¿™æ˜¯æœ€ç®€å•çš„ volumes é…ç½®</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>driver_opts: å·ç±»å‹å‚æ•°ï¼ŒæŒ‡å®šè¦ä¼ é€’ç»™æ­¤å·é©±åŠ¨ç¨‹åºçš„é€‰é¡¹åˆ—è¡¨ï¼ˆä»¥é”®å€¼å¯¹çš„å½¢å¼ï¼‰ã€‚è¿™äº›é€‰é¡¹ä¸é©±åŠ¨ç¨‹åºç›¸å…³ã€‚</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">db-data:</span></span><br><span class="line">    <span class="attr">driver_opts:</span> <span class="comment"># å·ç±»å‹å‚æ•°ï¼ŒæŒ‡å®šè¦ä¼ é€’ç»™æ­¤å·é©±åŠ¨ç¨‹åºçš„é€‰é¡¹åˆ—è¡¨ï¼ˆä»¥é”®å€¼å¯¹çš„å½¢å¼ï¼‰</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">&quot;nfs&quot;</span> <span class="comment"># å·ç±»å‹ï¼ŒæŒ‡å®šåº”ä½¿ç”¨å“ªä¸ªå·é©±åŠ¨ç¨‹åºï¼Œè¿™é‡Œæ˜¯nfs</span></span><br><span class="line">      <span class="attr">o:</span> <span class="string">&quot;addr=10.40.0.199,nolock,soft,rw&quot;</span> <span class="comment"># nfså‚æ•°ï¼Œaddrä¸ºnfsæœåŠ¡å™¨åœ°å€ï¼Œnolockä¸ºä¸é”å®šæ–‡ä»¶ï¼Œsoftä¸ºè½¯é“¾æ¥ï¼Œrwä¸ºè¯»å†™æƒé™</span></span><br><span class="line">      <span class="attr">device:</span> <span class="string">&quot;:/docker/example&quot;</span> <span class="comment"># nfsæŒ‚è½½è·¯å¾„</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>external: å·æ˜¯å¦ä¸ºå¤–éƒ¨å·ï¼Œé»˜è®¤ä¸ºfalse</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">db-data:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span> <span class="comment"># true è¡¨ç¤ºä¸ä¼šåˆ›å»ºï¼Œè€Œæ˜¯ä½¿ç”¨å·²å­˜åœ¨çš„ï¼Œå³ä¼šå»volumesä¸­æŸ¥æ‰¾(docker volume ls) å®¹å™¨ç»„åç§°_da-data ï¼Œé»˜è®¤ä¸ºfalse</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>name: å·çš„åç§°ï¼Œé»˜è®¤ä¸º å®¹å™¨ç»„åç§°_å£°æ˜çš„åç§°</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">db-data:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">db-data</span> <span class="comment"># åˆ›å»ºä¸€ä¸ªåä¸ºdb-dataçš„å·ï¼Œå®é™…çš„å·åç§°å°±æ˜¯ db-dataï¼Œä¸ä¼šå†åŠ ä¸Šå®¹å™¨ç»„åç§°å‰ç¼€</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span> <span class="comment"># name å±æ€§ç»å¸¸ä¸  external: true ä¸€èµ·ä½¿ç”¨</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>labels: ç”¨äºå‘å·æ·»åŠ å…ƒæ•°æ®ï¼Œå¯ä»¥æ·»åŠ ä»»æ„çš„é”®å€¼å¯¹</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">db-data:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">com.example.description:</span> <span class="string">&quot;Database volume&quot;</span></span><br><span class="line">      <span class="attr">com.example.department:</span> <span class="string">&quot;IT/Ops&quot;</span></span><br><span class="line">      <span class="attr">com.example.label-with-empty-value:</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure><h3 id="networks">networks</h3><ul class="lvl-0"><li class="lvl-2"><p>ç½‘ç»œä½¿æœåŠ¡èƒ½å¤Ÿç›¸äº’é€šä¿¡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒCompose ä¼šä¸ºæ‚¨çš„åº”ç”¨è®¾ç½®å•ä¸ªç½‘ç»œã€‚æœåŠ¡çš„æ¯ä¸ªå®¹å™¨éƒ½ä¼šåŠ å…¥é»˜è®¤ç½‘ç»œï¼Œå¹¶ä¸”è¯¥ç½‘ç»œä¸Šçš„å…¶ä»–å®¹å™¨éƒ½å¯ä»¥è®¿é—®ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡æœåŠ¡åç§°å‘ç°ã€‚é¡¶çº§networkså…ƒç´ å…è®¸æ‚¨é…ç½®å¯åœ¨å¤šä¸ªæœåŠ¡ä¹‹é—´é‡å¤ä½¿ç”¨çš„å‘½åç½‘ç»œã€‚</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">frontend:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">example/webapp</span></span><br><span class="line">    <span class="attr">networks:</span>  <span class="comment">#  ç½‘ç»œæ˜ å°„</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">front-tier</span> <span class="comment">#  åŠ å…¥front-tierç½‘ç»œ</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">back-tier</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">backend</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span>    <span class="comment"># ç½‘ç»œé…ç½®</span></span><br><span class="line">  <span class="attr">front-tier:</span> <span class="comment"># åˆ›å»ºä¸€ä¸ªåä¸ºfront-tierçš„ç½‘ç»œï¼Œå®é™…çš„ç½‘ç»œåç§°æ˜¯ å®¹å™¨ç»„åç§°_front-tier</span></span><br><span class="line">  <span class="attr">back-tier:</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å¦‚æœ Compose æ–‡ä»¶æœªæ˜¾å¼å£°æ˜ç½‘ç»œï¼ŒCompose å°†ä½¿ç”¨éšå¼defaultç½‘ç»œã€‚</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">some-service:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">foo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™ä¸ªä¾‹å­å®é™…ä¸Šç­‰åŒäºï¼š</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">some-service:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">foo</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="attr">default:</span> &#123;&#125;</span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">default:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><h4 id="networks-çš„å±æ€§">networks çš„å±æ€§</h4><ul class="lvl-0"><li class="lvl-2"><p>driver: ç½‘ç»œç±»å‹ï¼Œé»˜è®¤ä¸ºbridge</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">gitea:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>driver_opts: ç½‘ç»œç±»å‹å‚æ•°ï¼ŒæŒ‡å®šè¦ä¼ é€’ç»™æ­¤ç½‘ç»œé©±åŠ¨ç¨‹åºçš„é€‰é¡¹åˆ—è¡¨ï¼ˆä»¥é”®å€¼å¯¹çš„å½¢å¼ï¼‰ã€‚è¿™äº›é€‰é¡¹ä¸é©±åŠ¨ç¨‹åºç›¸å…³ã€‚</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">frontend:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line">    <span class="attr">driver_opts:</span></span><br><span class="line">      <span class="attr">com.docker.network.bridge.host_binding_ipv4:</span> <span class="string">&quot;127.0.0.1&quot;</span> <span class="comment"># è®¾ç½®å®¹å™¨ç«¯å£ç»‘å®šåˆ°ä¸»æœºçš„å“ªä¸ª IPï¼ˆå¦‚ &quot;127.0.0.1&quot;ï¼Œç»‘å®šåˆ°æœ¬åœ°ï¼‰</span></span><br></pre></td></tr></table></figure><blockquote><p>driver_opts å¸¸è§é…ç½®é¡¹ï¼ˆé’ˆå¯¹ bridge ç½‘ç»œé©±åŠ¨ï¼‰</p></blockquote><table><thead><tr><th>é€‰é¡¹é”®åï¼ˆ<code>driver_opts</code>ï¼‰</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>com.docker.network.bridge.name</code></td><td>æŒ‡å®šæ¡¥æ¥ç½‘ç»œçš„åç§°ï¼ˆé»˜è®¤æ˜¯éšæœºç”Ÿæˆï¼Œå¦‚ <code>br-xxxxx</code>ï¼‰</td></tr><tr><td><code>com.docker.network.bridge.enable_icc</code></td><td>æ˜¯å¦å…è®¸å®¹å™¨ä¹‹é—´çš„é€šä¿¡ï¼ˆ<code>true</code> æˆ– <code>false</code>ï¼‰</td></tr><tr><td><code>com.docker.network.bridge.enable_ip_masquerade</code></td><td>æ˜¯å¦å¯ç”¨ IP å‡å†’ï¼ˆNATï¼Œé€šå¸¸ç”¨äºå¤–ç½‘è®¿é—®ï¼‰</td></tr><tr><td><code>com.docker.network.bridge.host_binding_ipv4</code></td><td>è®¾ç½®å®¹å™¨ç«¯å£ç»‘å®šåˆ°ä¸»æœºçš„å“ªä¸ª IPï¼ˆå¦‚ <code>&quot;127.0.0.1&quot;</code>ï¼Œç»‘å®šåˆ°æœ¬åœ°ï¼‰</td></tr><tr><td><code>com.docker.network.bridge.default_bridge</code></td><td>æ˜¯å¦å°†è¯¥ç½‘ç»œè®¾ç½®ä¸ºé»˜è®¤ bridge ç½‘ç»œï¼ˆ<code>true</code> æˆ– <code>false</code>ï¼‰</td></tr><tr><td><code>com.docker.network.driver.mtu</code></td><td>è®¾ç½®ç½‘ç»œçš„æœ€å¤§ä¼ è¾“å•å…ƒï¼ˆMTUï¼Œä¾‹å¦‚ <code>&quot;1500&quot;</code>ï¼‰</td></tr><tr><td><code>com.docker.network.bridge.allow_non_default_bridge</code></td><td>æ˜¯å¦å…è®¸å®¹å™¨åŠ å…¥éé»˜è®¤çš„ bridge ç½‘ç»œï¼ˆè¾ƒå°‘ä½¿ç”¨ï¼‰</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>attachable: å¦‚æœä¸ºtrueï¼Œåˆ™å…è®¸å°†å…¶å®ƒç‹¬ç«‹å®¹å™¨ä¹ŸåŠ å…¥åˆ°æ­¤ç½‘ç»œã€‚é»˜è®¤å€¼ä¸ºfalseã€‚å¦‚æœç‹¬ç«‹å®¹å™¨è¿æ¥åˆ°æ­¤ç½‘ç»œï¼Œå®ƒå¯ä»¥ä¸åŒæ ·è¿æ¥åˆ°æ­¤ç½‘ç»œçš„æœåŠ¡å’Œå…¶ä»–ç‹¬ç«‹å®¹å™¨è¿›è¡Œé€šä¿¡ã€‚</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">gitea:</span></span><br><span class="line">    <span class="attr">attachable:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>external: true è¡¨ç¤ºä¸ä¼šåˆ›å»ºæ–°çš„ç½‘ç»œï¼Œå›å»networksä¸­æŸ¥æ‰¾ï¼ˆdocker network lsï¼‰ï¼Œé»˜è®¤ä¸ºfalse</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">gitea:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>name: ç½‘ç»œåç§°ï¼Œä¸ä¼šå†åŠ ä¸Šå®¹å™¨ç»„åç§°å‰ç¼€</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">gitea:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gitea</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span> <span class="comment"># name å±æ€§ç»å¸¸ä¸  external: true ä¸€èµ·ä½¿ç”¨</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>labels: ç”¨äºå‘ç½‘ç»œæ·»åŠ å…ƒæ•°æ®ï¼Œå¯ä»¥æ·»åŠ ä»»æ„çš„é”®å€¼å¯¹</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">mynet1:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">com.example.description:</span> <span class="string">&quot;Financial transaction network&quot;</span></span><br><span class="line">      <span class="attr">com.example.department:</span> <span class="string">&quot;Finance&quot;</span></span><br><span class="line">      <span class="attr">com.example.label-with-empty-value:</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>internal: é»˜è®¤æƒ…å†µä¸‹ï¼ŒCompose æä¾›ç½‘ç»œçš„å¤–éƒ¨è¿æ¥ã€‚internalå½“è®¾ç½®ä¸º æ—¶trueï¼Œå¯è®©æ‚¨åˆ›å»ºä¸å¤–éƒ¨éš”ç¦»çš„ç½‘ç»œã€‚</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">gitea:</span></span><br><span class="line">    <span class="attr">internal:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="services">services</h3><ul class="lvl-0"><li class="lvl-2"><p>æœåŠ¡æ˜¯åº”ç”¨ç¨‹åºä¸­è®¡ç®—èµ„æºçš„æŠ½è±¡å®šä¹‰ï¼Œå¯ä»¥ç‹¬ç«‹äºå…¶ä»–ç»„ä»¶è¿›è¡Œæ‰©å±•æˆ–æ›¿æ¢ã€‚æœåŠ¡ç”±ä¸€ç»„å®¹å™¨æ”¯æŒï¼Œç”±å¹³å°æ ¹æ®å¤åˆ¶è¦æ±‚å’Œå¸ƒå±€çº¦æŸè¿è¡Œã€‚ç”±äºæœåŠ¡ç”±å®¹å™¨æ”¯æŒï¼Œå› æ­¤å®ƒä»¬ç”± Docker é•œåƒå’Œä¸€ç»„è¿è¡Œæ—¶å‚æ•°å®šä¹‰ã€‚æœåŠ¡ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½ä½¿ç”¨è¿™äº›å‚æ•°ä»¥ç›¸åŒçš„æ–¹å¼åˆ›å»ºã€‚</p></li><li class="lvl-2"><p>service åŒ…å«çš„å±æ€§éå¸¸å¤šï¼Œå…·ä½“è¯·å‚è€ƒ<a href="https://docs.docker.com/reference/compose-file/services/">servicesé¡¶çº§å…ƒç´ </a>ï¼Œè¿™é‡Œåªä»‹ç»æ¯”è¾ƒå¸¸ç”¨çš„å±æ€§ï¼Œ</p></li><li class="lvl-2"><p>è¿™é‡Œä»¥<a href="https://docs.gitea.com/installation/install-with-docker">Gitea</a>çš„<code>docker-compose.yml</code>ä¸ºä¾‹</p></li></ul><blockquote><p>Gitea æ˜¯ä¸€ç§è½»æ¾ã€è‡ªæ‰˜ç®¡çš„ä¸€ä½“åŒ–è½¯ä»¶å¼€å‘æœåŠ¡ã€‚å®ƒåŒ…æ‹¬ Git æ‰˜ç®¡ã€ä»£ç å®¡æŸ¥ã€å›¢é˜Ÿåä½œã€åŒ…æ³¨å†Œè¡¨å’Œ CI/CDã€‚å®ƒç±»ä¼¼äº GitHubã€Bitbucket å’Œ GitLabã€‚</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># version: &#x27;3.8&#x27; # é…ç½®æ–‡ä»¶ç‰ˆæœ¬ï¼Œå·²è¿‡æ—¶ï¼Œé…ç½®ä¸Šä¼šå‘Šè­¦ä½†ä¸ä¼šæŠ¥é”™</span></span><br><span class="line"><span class="comment"># name: gitea # å®¹å™¨ç»„åç§°ï¼Œé»˜è®¤ä½¿ç”¨æ‰€åœ¨ç›®å½•çš„åç§°ï¼Œä¸æ¨èä½¿ç”¨</span></span><br><span class="line"><span class="attr">networks:</span> <span class="comment"># ç½‘ç»œé…ç½®</span></span><br><span class="line">  <span class="attr">gitea:</span> <span class="comment"># åˆ›å»ºä¸€ä¸ªåä¸ºgiteaçš„ç½‘ç»œï¼Œå®é™…çš„ç½‘ç»œåç§°æ˜¯ gitea_giteaï¼Œå³ å®¹å™¨ç»„åç§°_è¿™é‡Œçš„åç§°</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">false</span> <span class="comment"># å¦‚æœä¸ºtrueï¼Œåˆ™è¡¨ç¤ºæ­¤ç½‘ç»œä¸ä¼šç”±composeåˆ›å»ºï¼Œè€Œæ˜¯ä½¿ç”¨å·²æœ‰çš„ç½‘ç»œï¼Œé»˜è®¤ä¸ºfalse</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span>  <span class="comment"># ç½‘ç»œç±»å‹ï¼Œé»˜è®¤ä¸ºbridge</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span> <span class="comment"># å­˜å‚¨å·é…ç½®</span></span><br><span class="line">  <span class="attr">gitea:</span> <span class="comment"># åˆ›å»ºä¸€ä¸ªåä¸ºgiteaçš„å­˜å‚¨å·ï¼Œå®é™…çš„å·åç§°æ˜¯ gitea_giteaï¼Œå³ å®¹å™¨ç»„åç§°_è¿™é‡Œçš„åç§°</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span> <span class="comment"># å­˜å‚¨å·ç±»å‹ï¼Œé»˜è®¤ä¸ºlocal</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span> <span class="comment"># æœåŠ¡é…ç½®ï¼Œè¿™é‡Œå¯ä»¥å®šä¹‰ä¸€ç»„å®¹å™¨</span></span><br><span class="line">  <span class="attr">server:</span> <span class="comment"># å®šä¹‰ä¸€ä¸ªåä¸ºserverçš„æœåŠ¡ï¼Œæ³¨æ„è¿™ä¸ªä¸æ˜¯å®¹å™¨åç§°</span></span><br><span class="line">    <span class="comment"># build: . # æ„å»ºé•œåƒï¼Œä½¿ç”¨å½“å‰ç›®å½•ä¸‹çš„Dockerfile</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">gitea/gitea:latest</span> <span class="comment"># é•œåƒåç§°</span></span><br><span class="line">    <span class="comment"># container_name: gitea #  å®¹å™¨åç§°ï¼Œé»˜è®¤ä¸º â€œå®¹å™¨ç»„åç§°-æœåŠ¡åç§°-ç´¢å¼•â€ï¼Œä¸æ¨èé…ç½®ï¼Œå› ä¸º æ°´å¹³æ‰©å±•(--scale) æ—¶,å®¹å™¨åç§°ä¸èƒ½é‡å¤</span></span><br><span class="line">    <span class="attr">environment:</span> <span class="comment"># å®šä¹‰ç¯å¢ƒå˜é‡</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">USER_UID=1000</span> <span class="comment"># key=value</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">USER_GID=1000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_TYPE=mysql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_HOST=db:3306</span> <span class="comment"># è¿™é‡Œé…ç½®çš„ db å°±æ˜¯ ä¸‹é¢çš„æœåŠ¡åç§°ï¼Œç›¸åŒ network ä¸‹çš„æœåŠ¡åç§°ï¼Œdocker composeä¼šè‡ªåŠ¨è§£æä¸ºå®¹å™¨çš„ipåœ°å€</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_NAME=gitea</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_USER=gitea</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DB_PASSWD=gitea</span></span><br><span class="line">    <span class="comment"># env_file: .gitea.env # ä» .gitea.env æ–‡ä»¶è¯»å–ç¯å¢ƒå˜é‡ï¼Œç”Ÿäº§ç¯å¢ƒæ›´æ¨è</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span> <span class="comment"># å®¹å™¨å¯åŠ¨æ—¶ï¼Œè‡ªåŠ¨é‡å¯</span></span><br><span class="line">    <span class="attr">networks:</span> <span class="comment"># ç½‘ç»œå…³è”</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">gitea</span> <span class="comment"># ç½‘ç»œåç§°ï¼Œå°±æ˜¯ä¸Šé¢åˆ›å»ºçš„giteaç½‘ç»œ</span></span><br><span class="line">    <span class="attr">volumes:</span> <span class="comment">#  æ•°æ®å·å…³è”</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">gitea:/data</span> <span class="comment"># volumeæ˜ å°„ï¼Œæ•°æ®å·åç§°:/å®¹å™¨è·¯å¾„</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/timezone:/etc/timezone:ro</span> <span class="comment"># è·¯å¾„æ˜ å°„ï¼Œå®¿ä¸»æœºè·¯å¾„:/å®¹å™¨è·¯å¾„:è¯»å†™æƒé™</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/localtime:/etc/localtime:ro</span></span><br><span class="line">    <span class="attr">ports:</span> <span class="comment"># ç«¯å£æ˜ å°„</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3000:3000&quot;</span> <span class="comment"># å®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£</span></span><br><span class="line">    <span class="attr">depends_on:</span> <span class="comment"># å¯åŠ¨ä¾èµ–ï¼Œå°±æ˜¯ä¾èµ–çš„æœåŠ¡å¯åŠ¨åæ‰èƒ½å¯åŠ¨æœ¬æœåŠ¡</span></span><br><span class="line">      <span class="attr">db:</span> <span class="comment"># å¯åŠ¨dbæœåŠ¡</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">service_healthy</span> <span class="comment"># æœåŠ¡é€šè¿‡å¥åº·æ£€æŸ¥ï¼Œä¹Ÿå¯ä»¥é…ç½®ä¸º service_startedï¼šæœåŠ¡å¯åŠ¨ï¼Œè¿™ä¸ªæ˜¯é»˜è®¤å€¼</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">db:</span> <span class="comment"># æ•°æ®åº“æœåŠ¡</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:8</span> <span class="comment"># é•œåƒ</span></span><br><span class="line">    <span class="attr">environment:</span> <span class="comment"># ç¯å¢ƒå˜é‡</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_ROOT_PASSWORD=gitea</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_USER=gitea</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_PASSWORD=gitea</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_DATABASE=gitea</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span> <span class="comment"># å¯åŠ¨ç­–ç•¥</span></span><br><span class="line">    <span class="attr">networks:</span> <span class="comment"># ç½‘ç»œæ˜ å°„</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">gitea</span> <span class="comment"># æ˜ å°„åˆ°giteaç½‘ç»œ</span></span><br><span class="line">    <span class="attr">volumes:</span> <span class="comment"># å·æ˜ å°„</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./mysql:/var/lib/mysql</span> <span class="comment"># å®¿ä¸»æœºè·¯å¾„:/å®¹å™¨è·¯å¾„ï¼Œè¿™é‡Œå®¿ä¸»æœºæ”¯æŒç›¸å¯¹è·¯å¾„</span></span><br><span class="line">    <span class="attr">healthcheck:</span> <span class="comment"># å¥åº·æ£€æŸ¥</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD-SHELL&quot;</span>, <span class="string">&quot;mysql -u root -pgitea&quot;</span>, <span class="string">&quot;-e &#x27;SELECT 1;&#x27;&quot;</span>] <span class="comment"># æ‰§è¡Œå‘½ä»¤ï¼Œå¦‚æœè¿”å›0ï¼Œåˆ™å¥åº·æ£€æŸ¥é€šè¿‡ï¼Œè¿™é‡Œä¸æ”¯æŒä¸Šé¢çš„ç¯å¢ƒå˜é‡ï¼Œteståªæ”¯æŒ  CMD-SHELL å’Œ CMD</span></span><br><span class="line">      <span class="attr">interval:</span> <span class="string">10s</span> <span class="comment"># å¥åº·æ£€æŸ¥é—´éš”</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">5s</span> <span class="comment"># å¥åº·æ£€æŸ¥è¶…æ—¶æ—¶é—´</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span> <span class="comment"># å¥åº·æ£€æŸ¥é‡è¯•æ¬¡æ•°</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>build</code>: æ„å»ºé•œåƒ</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span> <span class="comment"># Dockerfileçš„ç›®å½•ï¼Œâ€œ.â€ è¡¨ç¤ºä½¿ç”¨å½“å‰ç›®å½•ä¸‹çš„Dockerfile</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">example/webapp</span> <span class="comment"># é•œåƒåç§°ï¼Œå¦‚æœæœ‰buildï¼Œåˆ™è¯¥åç§°å°±æ˜¯buildåçš„é•œåƒåç§°ï¼Œå¦‚æœæ²¡æœ‰buildï¼Œåˆ™å°±ä¼šä»è¿œç¨‹ä»“åº“æ‹‰å–</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./webapp</span> <span class="comment"># Dockerfileçš„ç›®å½•ï¼Œé»˜è®¤æ˜¯å½“å‰ç›®å½•</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile</span> <span class="comment"># æ„å»ºé•œåƒçš„Dockerfileåç§°ï¼Œé»˜è®¤æ˜¯Dockerfile</span></span><br><span class="line">      <span class="attr">platforms:</span> <span class="comment"># æ„å»ºé•œåƒçš„æ¶æ„</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">linux/amd64</span> <span class="comment"># æ„å»ºé•œåƒçš„æ¶æ„ï¼Œé»˜è®¤æ˜¯å½“å‰æ¶æ„</span></span><br><span class="line">      <span class="attr">args:</span> <span class="comment"># æ„å»ºé•œåƒçš„å‚æ•°</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">FOO=bar</span></span><br><span class="line">      <span class="attr">labels:</span> <span class="comment"># æ„å»ºé•œåƒçš„æ ‡ç­¾</span></span><br><span class="line">        <span class="attr">com.example.description:</span> <span class="string">&quot;Accounting webapp&quot;</span></span><br><span class="line">        <span class="attr">com.example.department:</span> <span class="string">&quot;Finance&quot;</span></span><br><span class="line">        <span class="attr">com.example.label-with-empty-value:</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>command</code>: è¦†ç›–å®¹å™¨æ˜ åƒå£°æ˜çš„é»˜è®¤å‘½ä»¤</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;python&quot;</span>, <span class="string">&quot;app.py&quot;</span>]</span><br><span class="line">    <span class="attr">image:</span> <span class="string">example/webapp</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>entrypoint</code>: å£°æ˜æœåŠ¡å®¹å™¨çš„é»˜è®¤å…¥å£ç‚¹ï¼Œè¿™è¦†ç›–äº†æœåŠ¡Dockerfileä¸­çš„ENTRYPOINTæŒ‡ä»¤ã€‚</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">example/webapp</span></span><br><span class="line">    <span class="attr">entrypoint:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">php</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">-d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">zend_extension=/usr/local/lib/php/extensions/no-debug-non-zts-20100525/xdebug.so</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">-d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">memory_limit=-1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">vendor/bin/phpunit</span></span><br><span class="line">      <span class="comment"># å¦‚æœå€¼ä¸ºnullï¼Œåˆ™ä½¿ç”¨å›¾åƒçš„é»˜è®¤å…¥å£ç‚¹ã€‚ entrypoint: null</span></span><br><span class="line">      <span class="comment"># å¦‚æœå€¼æ˜¯ []ï¼ˆç©ºåˆ—è¡¨ï¼‰æˆ– &#x27;&#x27;ï¼ˆç©ºå­—ç¬¦ä¸²ï¼‰ï¼Œå›¾åƒå£°æ˜çš„é»˜è®¤å…¥å£ç‚¹è¢«å¿½ç•¥ï¼Œæˆ–è€…æ¢å¥è¯è¯´ï¼Œè¢«è¦†ç›–ä¸ºç©ºã€‚ entrypoint: []</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>depends_on</code>: æœåŠ¡å¯åŠ¨ä¾èµ–ï¼Œå°±æ˜¯ä¾èµ–çš„æœåŠ¡å¯åŠ¨åæ‰èƒ½å¯åŠ¨æœ¬æœåŠ¡</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span> <span class="comment"># çŸ­è¯­æ³•</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="attr">db:</span>  <span class="comment"># é•¿è¯­æ³•</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">service_healthy</span> <span class="comment"># æ»¡è¶³çš„æ¡ä»¶</span></span><br><span class="line">        <span class="attr">restart:</span> <span class="literal">true</span>      <span class="comment"># å½“è®¾ç½®ä¸ºtrueï¼ŒComposeåœ¨æ›´æ–°ä¾èµ–æœåŠ¡åé‡æ–°å¯åŠ¨æ­¤æœåŠ¡ã€‚</span></span><br><span class="line">      <span class="attr">redis:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">service_started</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## conditionï¼šè®¾ç½®ä¾èµ–æ€§è¢«è§†ä¸ºæ»¡è¶³çš„æ¡ä»¶</span></span><br><span class="line"><span class="comment">#   service_startedï¼šç›¸å½“äºä¹‹å‰æè¿°çš„ç®€çŸ­è¯­æ³•</span></span><br><span class="line"><span class="comment">#   service_healthyï¼šæŒ‡å®šåœ¨å¯åŠ¨ä¾èµ–æœåŠ¡ä¹‹å‰ï¼Œä¾èµ–é¢„æœŸä¸ºâ€œå¥åº·â€ï¼ˆå¦‚healthcheckæ‰€ç¤ºï¼‰ã€‚</span></span><br><span class="line"><span class="comment">#   service_completed_successfullyï¼šæŒ‡å®šåœ¨å¯åŠ¨ä¾èµ–æœåŠ¡ä¹‹å‰ï¼Œä¾èµ–é¡¹é¢„è®¡å°†è¿è¡Œåˆ°æˆåŠŸå®Œæˆã€‚</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>environment</code>: å®šä¹‰ç¯å¢ƒå˜é‡</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">example/webapp</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">FOO=bar</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">BAZ=qux</span></span><br><span class="line"><span class="comment"># æˆ–è€…</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">example/webapp</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">FOO:</span> <span class="string">bar</span></span><br><span class="line">      <span class="attr">BAZ:</span> <span class="string">qux</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>env_file</code>: ç”¨äºæŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªåŒ…å«è¦ä¼ é€’åˆ°å®¹å™¨çš„ç¯å¢ƒå˜é‡çš„æ–‡ä»¶ã€‚</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">example/webapp</span></span><br><span class="line">    <span class="attr">env_file:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./a.env</span> <span class="comment"># åˆ—è¡¨ä¸­çš„æ–‡ä»¶æ˜¯ä»ä¸Šåˆ°ä¸‹å¤„ç†çš„ã€‚å¯¹äºä¸¤ä¸ªç¯å¢ƒæ–‡ä»¶ä¸­æŒ‡å®šçš„ç›¸åŒå˜é‡ï¼Œåˆ—è¡¨ä¸­æœ€åä¸€ä¸ªæ–‡ä»¶çš„å€¼æ˜¯æœ‰æ•ˆçš„ã€‚</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./b.env</span></span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">example/webapp</span></span><br><span class="line">    <span class="attr">env_file:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">./default.env</span></span><br><span class="line">        <span class="attr">required:</span> <span class="literal">true</span> <span class="comment"># default</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">./override.env</span></span><br><span class="line">        <span class="attr">required:</span> <span class="literal">false</span> <span class="comment"># å½“requiredè®¾ç½®ä¸ºfalseä¸”.envæ–‡ä»¶ç¼ºå¤±æ—¶ï¼ŒComposeä¼šå¿½ç•¥</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>restart</code>: å®šä¹‰å¹³å°åœ¨å®¹å™¨ç»ˆæ­¢æ—¶é€‚ç”¨çš„ç­–ç•¥</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">example/webapp</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">&quot;no&quot;</span>            <span class="comment"># é»˜è®¤é‡å¯ç­–ç•¥ã€‚åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œå®ƒéƒ½ä¸ä¼šé‡æ–°å¯åŠ¨å®¹å™¨ã€‚</span></span><br><span class="line">    <span class="comment"># restart: always        # ç­–ç•¥æ€»æ˜¯é‡æ–°å¯åŠ¨å®¹å™¨ï¼Œç›´åˆ°å®ƒè¢«ç§»é™¤ã€‚</span></span><br><span class="line">    <span class="comment"># restart: on-failure    # å¦‚æœé€€å‡ºä»£ç è¡¨æ˜é”™è¯¯ï¼Œç­–ç•¥å°†é‡æ–°å¯åŠ¨å®¹å™¨ã€‚</span></span><br><span class="line">    <span class="comment"># restart: on-failure:3  # å¦‚æœé€€å‡ºä»£ç è¡¨æ˜é”™è¯¯ï¼Œç­–ç•¥å°†é‡æ–°å¯åŠ¨å®¹å™¨ã€‚ä½†ä»…å°è¯•é‡å¯3æ¬¡ã€‚</span></span><br><span class="line">    <span class="comment"># restart: unless-stopped # æ— è®ºé€€å‡ºä»£ç å¦‚ä½•ï¼Œç­–ç•¥éƒ½ä¼šé‡æ–°å¯åŠ¨å®¹å™¨ï¼Œä½†å½“æœåŠ¡åœæ­¢æˆ–åˆ é™¤æ—¶ï¼Œç­–ç•¥ä¼šåœæ­¢é‡æ–°å¯åŠ¨ã€‚</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>healthcheck</code>: å¥åº·æ£€æŸ¥ã€‚</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">example/webapp</span></span><br><span class="line">    <span class="attr">healthcheck:</span>  <span class="comment"># å¥åº·æ£€æŸ¥</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost&quot;</span>] <span class="comment"># ç›‘æ§æ£€æŸ¥æ—¶æ‰§è¡Œçš„å‘½ä»¤</span></span><br><span class="line">      <span class="attr">interval:</span> <span class="string">1m30s</span> <span class="comment"># å¥åº·æ£€æŸ¥çš„é—´éš”ï¼Œé»˜è®¤å€¼ä¸º 30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">10s</span>    <span class="comment">#  å¥åº·æ£€æŸ¥çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤å€¼ä¸º 30s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span>      <span class="comment"># å¥åº·æ£€æŸ¥çš„å°è¯•æ¬¡æ•°ï¼Œé»˜è®¤å€¼ä¸º 3</span></span><br><span class="line">      <span class="attr">start_period:</span> <span class="string">40s</span> <span class="comment"># å¯åŠ¨å®½é™æœŸï¼šåœ¨æ­¤æœŸé—´ï¼Œå¤±è´¥ä¸ä¼šè®¡å…¥é‡è¯•æ¬¡æ•°ï¼ˆä»…ç”¨äºåˆ¤æ–­æœåŠ¡æ˜¯å¦å¯åŠ¨å®Œæ¯•ï¼‰</span></span><br><span class="line">      <span class="attr">start_interval:</span> <span class="string">5s</span> <span class="comment"># å¯åŠ¨å®½é™æœŸå†…æ£€æŸ¥çš„é¢‘ç‡ï¼Œæœ¬ç¤ºä¾‹ä¸ºåœ¨å‰ 40 ç§’å†…æ¯ 5 ç§’æ£€æŸ¥ä¸€æ¬¡</span></span><br></pre></td></tr></table></figure><blockquote><p>testå®šä¹‰Composeè¿è¡Œçš„å‘½ä»¤æ¥æ£€æŸ¥å®¹å™¨è¿è¡ŒçŠ¶å†µã€‚å®ƒå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯åˆ—è¡¨ã€‚å¦‚æœæ˜¯åˆ—è¡¨ï¼Œç¬¬ä¸€ä¸ªé¡¹ç›®å¿…é¡»æ˜¯NONEã€CMDæˆ–CMD-SHELLã€‚å¦‚æœå®ƒæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒç­‰åŒäºæŒ‡å®šCMD-SHELLåè·Ÿè¯¥å­—ç¬¦ä¸²ã€‚</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost&quot;</span>]</span><br><span class="line"><span class="comment"># ä½¿ç”¨CMD-SHELLè¿è¡Œé…ç½®ä¸ºå­—ç¬¦ä¸²çš„å‘½ä»¤ï¼Œä½¿ç”¨å®¹å™¨çš„é»˜è®¤å¤–å£³ï¼ˆLinuxçš„/bin/shï¼‰ã€‚ä»¥ä¸‹ä¸¤ç§å½¢å¼æ˜¯ç­‰ä»·çš„</span></span><br><span class="line"><span class="attr">test:</span> [<span class="string">&quot;CMD-SHELL&quot;</span>, <span class="string">&quot;curl -f http://localhost || exit 1&quot;</span>]</span><br><span class="line"><span class="attr">test:</span> <span class="string">curl</span> <span class="string">-f</span> <span class="string">https://localhost</span> <span class="string">||</span> <span class="string">exit</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><blockquote><p>test ä¸­çš„ CMD å’Œ CMD-SHELL æ˜¯ä¸¤ç§ä¸åŒçš„æ‰§è¡Œæ–¹å¼ï¼Œå®ƒä»¬çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼š</p></blockquote><table><thead><tr><th>é¡¹ç›®</th><th><code>CMD</code></th><th><code>CMD-SHELL</code></th></tr></thead><tbody><tr><td>âœ… <strong>ç”¨é€”</strong></td><td>ç›´æ¥æ‰§è¡Œå‘½ä»¤ï¼ˆä¸é€šè¿‡ shellï¼‰</td><td>é€šè¿‡ shellï¼ˆå¦‚ <code>/bin/sh -c</code>ï¼‰æ‰§è¡Œå‘½ä»¤</td></tr><tr><td>ğŸ§¾ <strong>å†™æ³•æ ¼å¼</strong></td><td><code>[&quot;CMD&quot;, &quot;executable&quot;, &quot;arg1&quot;, &quot;arg2&quot;]</code></td><td><code>[&quot;CMD-SHELL&quot;, &quot;command string&quot;]</code></td></tr><tr><td>ğŸ”§ <strong>æ˜¯å¦ä½¿ç”¨ shell</strong></td><td>å¦</td><td>æ˜¯</td></tr><tr><td>ğŸ§  <strong>æ˜¯å¦æ”¯æŒ shell è¯­æ³•</strong></td><td>âŒ å¦<br>ï¼ˆä¸èƒ½ä½¿ç”¨ <code>&amp;&amp;</code>ã€ <code>||</code>ã€<code>\$VAR</code> ç­‰ï¼‰</td><td>âœ… æ˜¯<br>ï¼ˆæ”¯æŒç®¡é“ã€é‡å®šå‘ã€å˜é‡ã€å‘½ä»¤ç»„åˆï¼‰</td></tr><tr><td>ğŸ›¡ï¸ <strong>å®‰å…¨æ€§/å¯ç§»æ¤æ€§</strong></td><td>âœ… æ›´å®‰å…¨ï¼Œæ‰§è¡Œæ›´æ˜ç¡®</td><td>âš  ä¾èµ–å®¹å™¨ä¸­å­˜åœ¨ shellï¼ˆå¦‚ <code>/bin/sh</code>ï¼‰</td></tr><tr><td>âš™ï¸ <strong>æ‰§è¡Œæ•ˆç‡</strong></td><td>âœ… ç¨å¿«ï¼Œå› æ— éœ€ shell è§£æ</td><td>âš  ç¨æ…¢ï¼Œéœ€é€šè¿‡ shell å¯åŠ¨</td></tr><tr><td>ğŸ“¦ <strong>æ¨èä½¿ç”¨åœºæ™¯</strong></td><td>- ç®€å•å¥åº·æ£€æŸ¥å‘½ä»¤<br>- å®‰å…¨ç¯å¢ƒ<br>- ç²¾ç®€é•œåƒ</td><td>- éœ€è¦ä½¿ç”¨é€»è¾‘æ§åˆ¶ï¼ˆ<code>||</code>, <code>&amp;&amp;</code>ï¼‰<br>- å¤æ‚æ£€æŸ¥é€»è¾‘</td></tr><tr><td>ğŸ“Œ <strong>ç¤ºä¾‹</strong></td><td><code>[&quot;CMD&quot;, &quot;curl&quot;, &quot;-f&quot;, &quot;http://localhost&quot;]</code></td><td><code>[&quot;CMD-SHELL&quot;, &quot;curl -f http\://localhost || exit 1&quot;]</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p><code>volumes</code>: æŒ‚è½½æ•°æ®å·ã€‚</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é•¿è¯­æ³•æ ¼å¼</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">backend:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">example/backend</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">volume</span>   <span class="comment"># å®‰è£…ç±»å‹ã€‚å¯ä»¥æ˜¯æ˜¯volumeã€bindã€tmpfsã€imageã€npipeã€cluster</span></span><br><span class="line">        <span class="attr">source:</span> <span class="string">db-data</span> <span class="comment"># æŒ‚è½½çš„æºã€ç»‘å®šæŒ‚è½½çš„ä¸»æœºä¸Šçš„è·¯å¾„ã€æ˜ åƒæŒ‚è½½çš„Dockeræ˜ åƒå¼•ç”¨æˆ–é¡¶å±‚volumesé”®ä¸­å®šä¹‰çš„å·åç§°ã€‚ä¸é€‚ç”¨äºtmpfsæ”¯æ¶ã€‚</span></span><br><span class="line">        <span class="attr">target:</span> <span class="string">/data</span> <span class="comment"># å®¹å™¨ä¸­è£…è½½å·çš„è·¯å¾„ã€‚</span></span><br><span class="line">        <span class="attr">volume:</span>  <span class="comment"># é…ç½®å…¶ä»–å·é€‰é¡¹</span></span><br><span class="line">          <span class="attr">nocopy:</span> <span class="literal">true</span> <span class="comment"># åœ¨åˆ›å»ºå·æ—¶ç¦ç”¨ä»å®¹å™¨å¤åˆ¶æ•°æ®çš„æ ‡å¿—ï¼Œé»˜è®¤å€¼ä¸ºfalseã€‚</span></span><br><span class="line">          <span class="attr">subpath:</span> <span class="string">sub</span> <span class="comment"># æŒ‚è½½å·çš„å­ç›®å½•ã€‚å³ db-data/sub</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">bind</span> <span class="comment"># bind è¡¨ç¤ºæŒ‚è½½ä¸»æœºä¸Šçš„è·¯å¾„</span></span><br><span class="line">        <span class="attr">source:</span> <span class="string">/var/run/postgres/postgres.sock</span></span><br><span class="line">        <span class="attr">target:</span> <span class="string">/var/run/postgres/postgres.sock</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span> <span class="comment"># å£°æ˜æ•°æ®å·</span></span><br><span class="line">  <span class="attr">db-data:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># çŸ­è¯­æ³•æ ¼å¼</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">backend:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">example/backend</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db-data:/data</span> <span class="comment"># è¿™ç§è¯­æ³•ä¸æ”¯æŒ subpath å’Œ nocopy</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/var/run/postgres/postgres.sock:/var/run/postgres/postgres.sock</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">db-data:</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>networks</code>: é…ç½®ç½‘ç»œã€‚</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">some-service:</span></span><br><span class="line">    <span class="attr">networks:</span>  <span class="comment"># é…ç½®ç½‘ç»œ</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">some-network</span> <span class="comment"># å…³è”ç½‘ç»œ</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">other-network</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span> <span class="comment"># å£°æ˜ç½‘ç»œ</span></span><br><span class="line">  <span class="attr">some-network:</span></span><br><span class="line">  <span class="attr">other-network:</span></span><br></pre></td></tr></table></figure><h2 id="docker-run-è½¬-docker-compose"><code>docker run</code> è½¬ <code>docker compose</code></h2><ul class="lvl-0"><li class="lvl-2"><p>åœ¨çº¿å·¥å…·ï¼š<a href="https://www.composerize.com/">composerize</a></p></li><li class="lvl-2"><p>æœ¬åœ°å®‰è£…ï¼š<a href="https://github.com/composerize/composerize">composerize</a></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…å‘½ä»¤ï¼Œnpmå®‰è£…ï¼šhttps://nodejs.org/zh-cn/download</span></span><br><span class="line">npm install composerize -g</span><br><span class="line"><span class="comment"># è¿è¡Œå‘½ä»¤</span></span><br><span class="line">composerize docker run -p 80:80 -v /var/run/docker.sock:/tmp/docker.sock:ro --restart always --log-opt max-size=1g nginx</span><br><span class="line"><span class="comment">##  è½¬æ¢ç»“æœ</span></span><br><span class="line">name: &lt;your project name&gt;</span><br><span class="line">services:</span><br><span class="line">  nginx:</span><br><span class="line">    ports:</span><br><span class="line">      - 80:80</span><br><span class="line">    volumes:</span><br><span class="line">      - /var/run/docker.sock:/tmp/docker.sock:ro</span><br><span class="line">    restart: always</span><br><span class="line">    logging:</span><br><span class="line">      options:</span><br><span class="line">        max-size: 1g</span><br><span class="line">    image: nginx</span><br></pre></td></tr></table></figure><h2 id="docker-compose-ç¼–æ’ç®¡ç†å·¥å…·-Dockge"><code>docker compose</code> ç¼–æ’ç®¡ç†å·¥å…· <code>Dockge</code></h2><ul class="lvl-0"><li class="lvl-2"><p><a href="https://dockge.kuma.pet">Dockge</a> æ˜¯ä¸€ä¸ªå¼€æºè½»é‡çº§ã€ŒDocker Compose ç®¡ç†å™¨ã€ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªæ¼‚äº®ã€å“åº”è¿…é€Ÿçš„ Web ç•Œé¢ï¼Œä¸“é—¨é¢å‘ä½¿ç”¨ <code>docker compose</code> çš„ç”¨æˆ·ã€‚</p></li></ul><table><thead><tr><th>åŠŸèƒ½æ¨¡å—</th><th>ä¸»è¦æè¿°</th></tr></thead><tbody><tr><td><strong>Compose å †æ ˆå…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†</strong></td><td>å¯ä»¥åˆ›å»ºã€ç¼–è¾‘ã€å¯åŠ¨ã€åœæ­¢ã€é‡å¯ã€åˆ é™¤åŸºäº <code>compose.yaml</code> æ–‡ä»¶çš„ Docker å †æ ˆ</td></tr><tr><td><strong>äº¤äº’å¼ Compose ç¼–è¾‘å™¨ + Web ç»ˆç«¯</strong></td><td>å®æ—¶ç¼–è¾‘ YAML å¹¶æŸ¥çœ‹è¾“å‡ºï¼Œè¿˜å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸­æ“ä½œç»ˆç«¯</td></tr><tr><td><strong>å°† <code>docker run â€¦</code> å‘½ä»¤è½¬æ¢ä¸º Compose æ–‡ä»¶</strong></td><td>å¿«é€Ÿç”Ÿæˆ <code>compose.yaml</code>ï¼Œä¾¿äºç‰ˆæœ¬æ§åˆ¶å’Œç»“æ„ç®¡ç†</td></tr><tr><td><strong>å®æ—¶æ“ä½œåé¦ˆ</strong></td><td>é•œåƒæ‹‰å–ã€å †æ ˆå¯åŠ¨/åœæ­¢ç­‰æ“ä½œå‡å¯å®æ—¶æŸ¥çœ‹è¿›åº¦</td></tr><tr><td><strong>å¤šä¸»æœºä»£ç†æ”¯æŒï¼ˆâ‰¥1.4.0ï¼‰</strong></td><td>èƒ½åœ¨å•ä¸€ UI ä¸­ç®¡ç†å¤šä¸ª Docker ä¸»æœº</td></tr><tr><td><strong>é«˜å…¼å®¹æ€§ &amp; å®‰å…¨è®¾è®¡</strong></td><td>Compose æ–‡ä»¶ä¿å­˜åœ¨æœ¬åœ°ï¼Œä¸ä¼šè¢«ç³»ç»Ÿæ‰˜ç®¡ï¼Œä¾¿äºä½¿ç”¨ CLI æˆ–å…¶ä»–å·¥å…·ç®¡ç†</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>å®‰è£…</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create directories that store your stacks and store Dockge&#x27;s stack</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /opt/stacks /opt/dockge</span><br><span class="line"><span class="built_in">cd</span> /opt/dockge</span><br><span class="line"></span><br><span class="line"><span class="comment"># Download your compose.yaml</span></span><br><span class="line">curl <span class="string">&quot;https://dockge.kuma.pet/compose.yaml?port=5001&amp;stacksPath=%2Fopt%2Fstacks&quot;</span> --output compose.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># Start the Server</span></span><br><span class="line">docker compose up -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµè§ˆå™¨è®¿é—® http://localhost:5001</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **åŠ ç²—**
 *æ–œä½“*
 ***åŠ ç²—å¹¶æ–œä½“***
 ~~åˆ é™¤çº¿~~
 ==çªå‡ºæ˜¾ç¤º==
 `çªå‡ºæ˜¾ç¤º(æ¨è)`
 ++ä¸‹åˆ’çº¿++
 ~ä¸‹æ ‡~
 ^ä¸Šæ ‡^
 è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.
 å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **ç‚¹å‡»æŠ˜å **
 è¿™æ˜¯è¢«éšè—çš„å†…å®¹
 +++

::: tips success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
:::

% note info % success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
% endnote %

å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}
 å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ
 --&gt;
&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ &lt;code&gt;docker compose&lt;/code&gt; çš„ä½¿ç”¨æ–¹æ³•&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com&quot;&gt;Dockerå®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com/compose/&quot;&gt;docker compose&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com/reference/compose-file/&quot;&gt;Compose file reference&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/docker/"/>
    
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>Docker å‘½ä»¤ ä¹‹ ç½‘ç»œ(Network)</title>
    <link href="https://blog.hanqunfeng.com/2025/05/28/docker-command-network/"/>
    <id>https://blog.hanqunfeng.com/2025/05/28/docker-command-network/</id>
    <published>2025-05-28T13:40:05.000Z</published>
    <updated>2025-05-29T09:58:22.618Z</updated>
    
    <content type="html"><![CDATA[<!-- **åŠ ç²—** *æ–œä½“* ***åŠ ç²—å¹¶æ–œä½“*** ~~åˆ é™¤çº¿~~ ==çªå‡ºæ˜¾ç¤º== `çªå‡ºæ˜¾ç¤º(æ¨è)` ++ä¸‹åˆ’çº¿++ ~ä¸‹æ ‡~ ^ä¸Šæ ‡^ è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference. å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **ç‚¹å‡»æŠ˜å ** è¿™æ˜¯è¢«éšè—çš„å†…å®¹ +++::: tips success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹:::% note info % success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹% endnote %å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{} å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ --><h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2"><p>æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ ç½‘ç»œç®¡ç† ç›¸å…³å‘½ä»¤</p></li><li class="lvl-2"><p><a href="https://docs.docker.com">Dockerå®˜æ–¹æ–‡æ¡£</a></p></li></ul><span id="more"></span><h2 id="ä»€ä¹ˆæ˜¯Network-ç½‘ç»œ">ä»€ä¹ˆæ˜¯Network(ç½‘ç»œ)?</h2><ul class="lvl-0"><li class="lvl-2"><p>åœ¨ Docker ä¸­ï¼Œ<strong>ç½‘ç»œï¼ˆNetworkï¼‰</strong> æ˜¯å®¹å™¨ä¹‹é—´é€šä¿¡ã€å®¹å™¨ä¸å¤–éƒ¨é€šä¿¡çš„é‡è¦æœºåˆ¶ã€‚Docker æä¾›äº†ä¸€å¥—çµæ´»çš„ç½‘ç»œæ¨¡å‹ï¼Œä½¿å¾—ä½ å¯ä»¥è‡ªç”±é…ç½®å®¹å™¨çš„ç½‘ç»œç¯å¢ƒä»¥é€‚é…ä¸åŒåœºæ™¯ã€‚</p></li><li class="lvl-2"><p>å®‰è£…dockeræ—¶ï¼Œä¼šè‡ªåŠ¨åœ¨å®¿ä¸»æœºä¸Šå®‰è£…ä¸€ä¸ª <code>docker0</code> ç½‘ç»œè®¾å¤‡ï¼Œå®ƒæ˜¯ä¸€ä¸ªç½‘æ¡¥è®¾å¤‡ï¼Œç”¨äº Docker å„å®¹å™¨åŠå®¿ä¸»æœºçš„ç½‘ç»œé€šä¿¡ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å®¿ä¸»æœºç½‘å¡ä¿¡æ¯ï¼Œå¯ä»¥æ‰¾åˆ°docker0</span></span><br><span class="line">$ ip addr</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc mq state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 0a:6b:88:11:66:39 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.250.0.205/24 brd 10.250.0.255 scope global dynamic noprefixroute eth0</span><br><span class="line">       valid_lft 3076sec preferred_lft 3076sec</span><br><span class="line">    inet6 fe80::86b:88ff:fe11:6639/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default</span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:d6:d5:09:b1 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:d6ff:fed5:9b1/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="comment">## è¯´æ˜</span></span><br><span class="line">eth0 å®¿ä¸»æœºçš„ipåœ°å€æ˜¯ 10.250.0.205</span><br><span class="line">docker0 æœ¬èº«çš„ipåœ°å€æ˜¯ 172.17.0.1</span><br><span class="line">docker0 çš„å­ç½‘æ©ç æ˜¯ 255.255.0.0</span><br><span class="line">docker0 çš„å¹¿æ’­åœ°å€æ˜¯ 172.17.255.255</span><br><span class="line">docker0 å¯ä»¥ä¸ºå®¹å™¨åˆ†é…çš„ipåœ°å€èŒƒå›´æ˜¯ 172.17.0.2-172.17.255.254ï¼Œæ€»è®¡65534ä¸ªipåœ°å€</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ—¢ç„¶docker0æ˜¯ä¸€ä¸ªç½‘æ¡¥è®¾å¤‡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æ¥æŸ¥çœ‹ç½‘æ¡¥çš„è¯¦ç»†ä¿¡æ¯ï¼š</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ brctl show</span><br><span class="line"><span class="comment">## è¾“å‡ºç»“æœ</span></span><br><span class="line">brctl show</span><br><span class="line">bridge name    bridge <span class="built_in">id</span>      STP enabled    interfaces</span><br><span class="line">docker0    8000.0242d6d509b1        no</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å¯åŠ¨dockeræœåŠ¡åï¼Œdockerå°±ä¸ºæˆ‘ä»¬è‡ªåŠ¨åˆ›å»ºäº†ä¸‰ä¸ªç½‘ç»œï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker network <span class="built_in">ls</span></span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">4182e112bf34   bridge    bridge    <span class="built_in">local</span></span><br><span class="line">958daf8a8a0d   host      host      <span class="built_in">local</span></span><br><span class="line">4674a17c6617   none      null      <span class="built_in">local</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>è¿™é‡Œ<code>NAME</code>ä¸º<code>bridge</code>çš„ç½‘ç»œå°±æ˜¯ä¸<code>docker0</code>è®¾å¤‡ç›¸å¯¹åº”çš„ç½‘ç»œï¼Œå…¶ä¹Ÿæ˜¯docker<code>é»˜è®¤</code>çš„ç½‘ç»œï¼Œå¦‚æœåˆ›å»ºçš„å®¹å™¨æ²¡æœ‰æŒ‡å®šç½‘ç»œï¼Œé‚£ä¹ˆå®¹å™¨å°±ä¼šåŠ å…¥è¿™ä¸ª <code>bridge</code> ç½‘ç»œã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œæ²¡æœ‰æŒ‡å®šç½‘ç»œ</span></span><br><span class="line">docker run -itd --name ap1 alpine</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¤æ—¶åœ¨å®¿ä¸»æœºä¸ŠæŸ¥çœ‹ç½‘å¡ä¿¡æ¯ï¼Œä¼šçœ‹åˆ°å¤šå‡ºä¸€ä¸ªè®¾å¤‡</span></span><br><span class="line">ip addr</span><br><span class="line"><span class="comment">## è¾“å‡ºç»“æœ</span></span><br><span class="line">10: vethc0e0cc3@if9: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default</span><br><span class="line">    <span class="built_in">link</span>/ether c6:0d:02:c8:<span class="built_in">df</span>:a4 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet6 fe80::c40d:2ff:fec8:dfa4/64 scope <span class="built_in">link</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å®¹å™¨çš„ç½‘å¡ä¿¡æ¯</span></span><br><span class="line">docker <span class="built_in">exec</span> -it ap1 ip addr</span><br><span class="line"><span class="comment">## è¾“å‡ºç»“æœ</span></span><br><span class="line">9: eth0@if10: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP</span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ­¤æ—¶èªæ˜çš„ä½ å·²ç»å‘ç°äº†ï¼šå®¿ä¸»æœºçš„ç½‘å¡ä¸å®¹å™¨çš„ç½‘å¡æ˜¯æˆå¯¹å‡ºç°çš„ï¼Œå¹¶ä¸”åŸºäºåºå·è¿›è¡Œå…³è”</span></span><br><span class="line">å®¿ä¸»æœº: 10 : veth c0e0cc3 @ <span class="keyword">if</span> 9  <span class="comment"># åºå· 10 ä¸ å®¹å™¨åç¼€çš„ 10 åŒ¹é…ï¼Œveth æ˜¯è™šæ‹Ÿç½‘å¡ï¼Œc0e0cc3 æ˜¯éšæœºå­—ç¬¦ä¸²ï¼Œif æ˜¯ interface</span></span><br><span class="line">å®¹å™¨:    9 : eth0         @ <span class="keyword">if</span> 10 <span class="comment"># åºå· 9 ä¸å®¿ä¸»æœºçš„åç¼€ 9 åŒ¹é…ï¼Œeth0 æ˜¯å®¹å™¨çš„ç½‘å¡ï¼Œif æ˜¯ interface</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ­¤æ—¶æŸ¥çœ‹å®¿ä¸»æœºçš„ç½‘æ¡¥ä¿¡æ¯</span></span><br><span class="line">brctl show</span><br><span class="line"><span class="comment">## è¾“å‡ºç»“æœï¼Œå¯ä»¥åœ¨ interfaces ä¸­çœ‹åˆ° vethc0e0cc3ï¼Œè¯´æ˜ vethc0e0cc3 å·²ç»åŠ å…¥åˆ°ç½‘æ¡¥ä¸­</span></span><br><span class="line">bridge name  bridge <span class="built_in">id</span>      STP enabled  interfaces</span><br><span class="line">docker0   8000.0242d6d509b1      no  vethc0e0cc3</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç½‘ç»œä¸­çš„å®¹å™¨ä¿¡æ¯ï¼Œè¿™é‡Œ jq æ˜¯ json æ ¼å¼åŒ–ï¼Œå¯ä»¥é€šè¿‡ dnf install jq -y å®‰è£…</span></span><br><span class="line">docker network inspect bridge --format <span class="string">&#x27;&#123;&#123;json .Containers&#125;&#125;&#x27;</span> | jq</span><br><span class="line"><span class="comment">## è¾“å‡ºç»“æœ</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;c2436a1d750cc3de3a6f8ab8a693af25b3371aa8f7f168d5561538dcd4a8ff2d&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;ap1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;75469fddbbdeb8b7a328c1a1c3cc7070bb1a3e102f5fb97cc332dcbc22829af5&quot;</span>,</span><br><span class="line">    <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:11:00:02&quot;</span>,</span><br><span class="line">    <span class="string">&quot;IPv4Address&quot;</span>: <span class="string">&quot;172.17.0.2/16&quot;</span>,</span><br><span class="line">    <span class="string">&quot;IPv6Address&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–å®¹å™¨çš„ IP åœ°å€</span></span><br><span class="line">docker <span class="built_in">exec</span> ap1 hostname -i</span><br><span class="line"><span class="comment">## è¾“å‡ºç»“æœ</span></span><br><span class="line">172.17.0.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›¸åŒç½‘ç»œè®¾å¤‡ä¸‹çš„å®¹å™¨å¯ä»¥é€šè¿‡ IP åœ°å€é€šä¿¡</span></span><br><span class="line"><span class="comment"># æˆ‘ä»¬å†åˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼Œå¹¶æŸ¥çœ‹èƒ½å¦æ­£å¸¸é€šä¿¡</span></span><br><span class="line">docker run -itd --name ap2 alpine</span><br><span class="line">docker <span class="built_in">exec</span> -it ap2 ping 172.17.0.2</span><br><span class="line"><span class="comment">## è¾“å‡ºç»“æœï¼Œè¯´æ˜å¯ä»¥é€šè¿‡IPåœ°å€é€šä¿¡</span></span><br><span class="line">PING 172.17.0.2 (172.17.0.2): 56 data bytes</span><br><span class="line">64 bytes from 172.17.0.2: <span class="built_in">seq</span>=0 ttl=64 time=0.137 ms</span><br><span class="line">64 bytes from 172.17.0.2: <span class="built_in">seq</span>=1 ttl=64 time=0.084 ms</span><br><span class="line">64 bytes from 172.17.0.2: <span class="built_in">seq</span>=2 ttl=64 time=0.081 ms</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç½‘ç»œä¸­çš„å®¹å™¨</span></span><br><span class="line">docker network inspect bridge --format <span class="string">&#x27;&#123;&#123;json .Containers&#125;&#125;&#x27;</span> | jq</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;9d3ed5be1916b14ec9befe3649c08cc9de247c595de248600f8ef8d0fc16c5cb&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;ap2&quot;</span>,</span><br><span class="line">    <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;35615a7ec10842401ad8c40187c792555b5089551a8eca39ddff6734aeba549e&quot;</span>,</span><br><span class="line">    <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:11:00:03&quot;</span>,</span><br><span class="line">    <span class="string">&quot;IPv4Address&quot;</span>: <span class="string">&quot;172.17.0.3/16&quot;</span>,</span><br><span class="line">    <span class="string">&quot;IPv6Address&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;c2436a1d750cc3de3a6f8ab8a693af25b3371aa8f7f168d5561538dcd4a8ff2d&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;ap1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;75469fddbbdeb8b7a328c1a1c3cc7070bb1a3e102f5fb97cc332dcbc22829af5&quot;</span>,</span><br><span class="line">    <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:11:00:02&quot;</span>,</span><br><span class="line">    <span class="string">&quot;IPv4Address&quot;</span>: <span class="string">&quot;172.17.0.2/16&quot;</span>,</span><br><span class="line">    <span class="string">&quot;IPv6Address&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•æ˜¯å¦å¯ä»¥é€šè¿‡å®¹å™¨åç§°è®¿é—®</span></span><br><span class="line">docker <span class="built_in">exec</span> -it ap2 ping ap1</span><br><span class="line"><span class="comment">## è¾“å‡ºï¼Œä¸å¯ä»¥é€šè¿‡å®¹å™¨åç§°è®¿é—®</span></span><br><span class="line">ping: bad address <span class="string">&#x27;ap1&#x27;</span></span><br><span class="line"><span class="comment">## å¦‚æœå¸Œæœ›é€šè¿‡å®¹å™¨åç§°è®¿é—®ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ docker network create åˆ›å»ºä¸€ä¸ªæ–°çš„ç½‘ç»œ</span></span><br></pre></td></tr></table></figure><div class="tips"><p><em><strong>å¦‚æœæ²¡æœ‰å®‰è£… brctlï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼å®‰è£…</strong></em></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># centos7:</span></span><br><span class="line">yum install bridge-utils -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># centos8: ä¸æ”¯æŒyumæºå®‰è£…ï¼Œéœ€è¦æ‰‹åŠ¨ç¼–è¯‘å®‰è£…</span></span><br><span class="line"><span class="comment"># ä¸‹è½½æºç å®‰è£…ï¼Œç›®å‰æœ€æ–°ç‰ˆæœ¬ä¸º1.7.1</span></span><br><span class="line">wget https://mirrors.edge.kernel.org/pub/linux/utils/net/bridge-utils/bridge-utils-1.7.1.tar.gz</span><br><span class="line">tar -zxvf bridge-utils-1.7.1.tar.gz</span><br><span class="line"><span class="built_in">cd</span> bridge-utils-1.7.1</span><br><span class="line"><span class="comment"># éœ€è¦å…ˆå®‰è£…ç¼–è¯‘æ‰€éœ€çš„å·¥å…·å’Œä¾èµ–</span></span><br><span class="line">dnf install autoconf automake libtool make -y</span><br><span class="line"><span class="comment"># å› ä¸ºæºç ç›®å½•ä¸­æ²¡æœ‰ configure æ–‡ä»¶ï¼ˆä½†æœ‰ configure.acï¼‰ï¼Œæ‰€ä»¥éœ€è¦å…ˆè¿è¡Œå¦‚ä¸‹å‘½ä»¤ç”Ÿæˆ configure æ–‡ä»¶</span></span><br><span class="line">autoreconf -i</span><br><span class="line"><span class="comment"># é…ç½®</span></span><br><span class="line">./configure</span><br><span class="line"><span class="comment"># ç¼–è¯‘ ä¸” å®‰è£…</span></span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"><span class="comment"># æ·»åŠ åˆ°ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;export PATH=<span class="variable">$PATH</span>:/usr/local/sbin&quot;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br><span class="line">brctl --version</span><br><span class="line"><span class="comment">## è¾“å‡ºç»“æœ</span></span><br><span class="line">bridge-utils, 1.7</span><br></pre></td></tr></table></figure></div><ul class="lvl-0"><li class="lvl-2"><p>Docker é»˜è®¤çš„ bridge ç½‘ç»œå’Œ Linux å†…æ ¸ä¸­çš„ docker0 ç½‘æ¡¥æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ã€‚bridge æ˜¯ Docker å¯¹ç½‘ç»œçš„å‘½åï¼Œè€Œ docker0 æ˜¯å†…æ ¸ä¸­ç½‘æ¡¥çš„åå­—ã€‚<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/wjWiNA.png" alt=""></p></li><li class="lvl-2"><p>docker0è´Ÿè´£ç»™è¿æ¥å…¶ä¸Šçš„å®¹å™¨åˆ†é…ipåœ°å€ï¼Œå¹¶ä¸”æ˜¯æ¯ä¸ªå®¹å™¨çš„é»˜è®¤ç½‘å…³ã€‚å½“å®¹å™¨éœ€è¦è®¿é—®å¤–ç½‘æ—¶ï¼Œä¼šé€šè¿‡docker0è½¬åˆ°å®¿ä¸»æœºçš„eth0ä¸Šï¼Œæ‰€ä»¥åªè¦å®¿ä¸»æœºå¯ä»¥è®¿é—®å¤–ç½‘ï¼Œé‚£ä¹ˆå®¹å™¨ä¹Ÿå¯ä»¥è®¿é—®å¤–ç½‘ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å®¿ä¸»æœºçš„è·¯ç”±è¡¨</span></span><br><span class="line">$ route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         10.250.0.1      0.0.0.0         UG    100    0        0 eth0</span><br><span class="line">10.250.0.0      0.0.0.0         255.255.255.0   U     100    0        0 eth0</span><br><span class="line">172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ap1å®¹å™¨çš„è·¯ç”±è¡¨</span></span><br><span class="line">$ docker <span class="built_in">exec</span> -it ap1 route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         172.17.0.1      0.0.0.0         UG    0      0        0 eth0</span><br><span class="line">172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 eth0</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>Docker Container çš„ bridge æ¡¥æ¥æ¨¡å¼å¯ä»¥å‚è€ƒä¸‹å›¾<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/32fupw.png" alt=""></p></li></ul><h2 id="docker-network-ç›¸å…³å‘½ä»¤"><code>docker network</code> ç›¸å…³å‘½ä»¤</h2><table><thead><tr><th>å‘½ä»¤</th><th>åŠŸèƒ½è¯´æ˜</th><th>ç¤ºä¾‹</th><th>ç¤ºä¾‹è¾“å‡ºï¼ˆç®€ç•¥ï¼‰</th></tr></thead><tbody><tr><td><code>docker network ls</code></td><td>åˆ—å‡ºæ‰€æœ‰ Docker ç½‘ç»œ</td><td><code>docker network ls</code></td><td><code>bridge</code>, <code>host</code>, <code>none</code> ç­‰ç½‘ç»œåç§°</td></tr><tr><td><code>docker network inspect &lt;ç½‘ç»œå&gt;</code></td><td>æŸ¥çœ‹æŒ‡å®šç½‘ç»œçš„è¯¦ç»†ä¿¡æ¯ï¼ˆå¦‚ IP èŒƒå›´ã€è¿æ¥å®¹å™¨ç­‰ï¼‰</td><td><code>docker network inspect bridge</code></td><td>æ˜¾ç¤º JSONï¼Œå«å­ç½‘ã€ç½‘å…³ã€å®¹å™¨ç­‰ä¿¡æ¯</td></tr><tr><td><code>docker network create &lt;ç½‘ç»œå&gt;</code></td><td>åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œï¼ˆé»˜è®¤æ¡¥æ¥ï¼‰</td><td><code>docker network create my-net</code></td><td><code>my-net</code> ç½‘ç»œ ID</td></tr><tr><td><code>docker network rm &lt;ç½‘ç»œå&gt;</code></td><td>åˆ é™¤ç½‘ç»œï¼ˆä¸èƒ½æœ‰å®¹å™¨è¿æ¥ï¼‰</td><td><code>docker network rm my-net</code></td><td>æˆåŠŸåˆ é™¤æ— æç¤ºï¼Œå¤±è´¥ä¼šæœ‰é”™è¯¯ä¿¡æ¯</td></tr><tr><td><code>docker network connect &lt;ç½‘ç»œå&gt; &lt;å®¹å™¨å&gt;</code></td><td>å°†ä¸€ä¸ªå®¹å™¨è¿æ¥åˆ°æŒ‡å®šç½‘ç»œ</td><td><code>docker network connect my-net my-container</code></td><td>æ— è¾“å‡ºï¼Œå®¹å™¨è¿æ¥æˆåŠŸ</td></tr><tr><td><code>docker network disconnect &lt;ç½‘ç»œå&gt; &lt;å®¹å™¨å&gt;</code></td><td>å°†å®¹å™¨ä»ç½‘ç»œä¸­æ–­å¼€è¿æ¥</td><td><code>docker network disconnect my-net my-container</code></td><td>æ— è¾“å‡ºï¼Œæ–­å¼€æˆåŠŸ</td></tr><tr><td><code>docker network prune</code></td><td>åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„ç½‘ç»œï¼ˆæ…ç”¨ï¼‰</td><td><code>docker network prune</code></td><td>ä¼šæç¤ºæ˜¯å¦ç¡®è®¤ï¼Œæ¸…ç†æœªä½¿ç”¨ç½‘ç»œ</td></tr></tbody></table><h3 id="docker-network-create-åˆ›å»ºç½‘ç»œ"><code>docker network create</code> : åˆ›å»ºç½‘ç»œ</h3><ul class="lvl-0"><li class="lvl-2"><p>è¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create [OPTIONS] NETWORK_NAME</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å¸¸ç”¨å‚æ•°è¯´æ˜è¡¨</p></li></ul><table><thead><tr><th>å‚æ•°</th><th>è¯´æ˜</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td><code>--driver</code> æˆ– <code>-d</code></td><td>æŒ‡å®šç½‘ç»œé©±åŠ¨ç±»å‹ï¼Œå¦‚ <code>bridge</code>, <code>overlay</code>, <code>macvlan</code>, <code>host</code>, <code>none</code></td><td><code>--driver bridge</code></td></tr><tr><td><code>--subnet</code></td><td>æŒ‡å®šå­ç½‘åœ°å€èŒƒå›´ï¼ˆCIDRï¼‰</td><td><code>--subnet 192.168.100.0/24</code></td></tr><tr><td><code>--gateway</code></td><td>æŒ‡å®šç½‘å…³ IP åœ°å€</td><td><code>--gateway 192.168.100.1</code></td></tr><tr><td><code>--ip-range</code></td><td>æŒ‡å®šå¯åˆ†é…çš„ IP èŒƒå›´</td><td><code>--ip-range 192.168.100.0/25</code></td></tr><tr><td><code>--aux-address</code></td><td>ä¿ç•™æŸäº› IP åœ°å€ä¸è¢«åˆ†é…</td><td><code>--aux-address=&quot;reserved=192.168.100.254&quot;</code></td></tr><tr><td><code>--internal</code></td><td>åˆ›å»ºä¸€ä¸ªå†…éƒ¨ç½‘ç»œï¼ˆä¸èƒ½è®¿é—®å¤–éƒ¨ï¼‰</td><td><code>--internal</code></td></tr><tr><td><code>--attachable</code></td><td>åˆ›å»ºå¯ä¾›å•ç‹¬å®¹å™¨è¿æ¥çš„ç½‘ç»œï¼ˆSwarm ä¸­ï¼‰</td><td><code>--attachable</code></td></tr><tr><td><code>--label</code></td><td>æ·»åŠ æ ‡ç­¾</td><td><code>--label env=dev</code></td></tr><tr><td><code>--opt</code></td><td>æä¾›è‡ªå®šä¹‰é©±åŠ¨é€‰é¡¹</td><td><code>--opt encrypted=true</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p><code>--driver</code> æˆ– <code>-d</code> : å¸¸è§çš„ Docker ç½‘ç»œé©±åŠ¨ç±»å‹</p></li></ul><table><thead><tr><th>ç±»å‹</th><th>å«ä¹‰</th><th>æ˜¯å¦æ”¯æŒç«¯å£æ˜ å°„</th><th>ç‰¹ç‚¹ä¸åº”ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td><code>bridge</code>ï¼ˆé»˜è®¤ï¼‰</td><td>é»˜è®¤çš„æ¡¥æ¥ç½‘ç»œï¼Œå®¹å™¨é€šè¿‡è™šæ‹Ÿç½‘æ¡¥è¿æ¥ï¼Œå…±äº«å®¿ä¸»æœºçš„ç½‘ç»œæ¥å£ã€‚</td><td>âœ… æ˜¯</td><td>é»˜è®¤æ¨¡å¼ï¼Œé€‚ç”¨äºå•ä¸»æœºéƒ¨ç½²ã€å¤šä¸ªå®¹å™¨éœ€è¦äº’é€šçš„åœºæ™¯ã€‚å¯æ˜ å°„ç«¯å£å¯¹å¤–è®¿é—®ã€‚</td></tr><tr><td><code>host</code></td><td>å®¹å™¨ä¸å®¿ä¸»æœºå…±ç”¨ç½‘ç»œå‘½åç©ºé—´ï¼Œå®¹å™¨ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºçš„ IP å’Œç«¯å£ã€‚</td><td>âŒ å¦</td><td>æ— ç½‘ç»œéš”ç¦»ï¼Œæ€§èƒ½é«˜ï¼Œé€‚ç”¨äºé«˜æ€§èƒ½ã€ä½å»¶è¿Ÿåœºæ™¯ï¼ˆå¦‚æ¸¸æˆæœåŠ¡å™¨ï¼‰ã€‚</td></tr><tr><td><code>none</code></td><td>å®¹å™¨æ²¡æœ‰ç½‘ç»œæ¥å£ï¼Œå®Œå…¨éš”ç¦»ã€‚</td><td>âŒ å¦</td><td>ç”¨äºå®‰å…¨æ€§æˆ–æµ‹è¯•ç½‘ç»œä¸å¯è¾¾åœºæ™¯ã€‚</td></tr><tr><td><code>macvlan</code></td><td>ä¸ºå®¹å™¨åˆ†é…ç‹¬ç«‹ MAC å’Œ IPï¼Œå®¹å™¨åƒç‰©ç†ä¸»æœºä¸€æ ·å‡ºç°åœ¨å±€åŸŸç½‘ä¸­ã€‚</td><td>âœ… æ˜¯ï¼ˆå°‘è§ï¼‰</td><td>é€‚ç”¨äºå®¹å™¨å¿…é¡»ç›´æ¥æš´éœ²åœ¨ç‰©ç†ç½‘ç»œä¸­çš„åœºæ™¯ï¼ˆå¦‚ DHCP æœåŠ¡ã€ARP å¹¿æ’­ï¼‰ã€‚</td></tr><tr><td><code>ipvlan</code>ï¼ˆé«˜çº§ï¼‰</td><td>ç±»ä¼¼ macvlanï¼Œä½†ä¸ä½¿ç”¨è™šæ‹Ÿ MAC åœ°å€ã€‚</td><td>âœ… æ˜¯ï¼ˆå°‘è§ï¼‰</td><td>é«˜çº§ç½‘ç»œæ–¹æ¡ˆï¼Œé€‚ç”¨äºå¯¹ç½‘ç»œæ‹“æ‰‘ç²¾ç»†æ§åˆ¶çš„åœºæ™¯ã€‚</td></tr><tr><td><code>overlay</code></td><td>ç”¨äºå¤šä¸»æœºä¹‹é—´å®¹å™¨é€šä¿¡ï¼Œéœ€è¦ Docker Swarm æ”¯æŒã€‚</td><td>âœ… æ˜¯ï¼ˆSwarmï¼‰</td><td>è·¨ä¸»æœºéƒ¨ç½²æœåŠ¡çš„å¿…è¦æ‰‹æ®µï¼Œé€‚åˆå®¹å™¨ç¼–æ’å¹³å°ï¼ˆå¦‚ Swarmã€Kubernetesï¼‰ã€‚</td></tr></tbody></table><blockquote><p>å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼ŒDockerä¼šè‡ªåŠ¨åˆ›å»ºä¸‰ä¸ªç½‘ç»œï¼Œå³ï¼šbridgeã€hostã€noneã€‚å¯¹äºå•å°å®¿ä¸»æœºçš„åœºæ™¯ï¼Œç»å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬éƒ½åªä¼šä½¿ç”¨bridgeç½‘ç»œã€‚</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªåä¸ºmy-networkçš„ç½‘ç»œ</span></span><br><span class="line">$ docker network create my-network</span><br><span class="line"><span class="comment"># ç­‰åŒäºï¼Œå› ä¸ºé»˜è®¤çš„ç½‘ç»œé©±åŠ¨ä¸ºbridge</span></span><br><span class="line">$ docker network create --driver bridge my-network</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç½‘ç»œï¼Œå¯ä»¥çœ‹åˆ°æ–°å»ºçš„ç½‘ç»œçš„é©±åŠ¨ä¸ºbridge</span></span><br><span class="line">$ docker network <span class="built_in">ls</span> -f name=my-network</span><br><span class="line">NETWORK ID     NAME         DRIVER    SCOPE</span><br><span class="line">c2dbe1686790   my-network   bridge    <span class="built_in">local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å®¿ä¸»æœºçš„ç½‘æ¡¥ä¿¡æ¯</span></span><br><span class="line">$ brctl show</span><br><span class="line"><span class="comment">## è¾“å‡ºï¼Œå¯ä»¥çœ‹åˆ°æ­¤æ—¶æœ‰ä¸€ä¸ªç½‘æ¡¥è®¾å¤‡ br-c2dbe1686790ï¼Œbr: bridgeï¼Œc2dbe1686790ï¼šnetwork id</span></span><br><span class="line">bridge name      bridge <span class="built_in">id</span>          STP enabled    interfaces</span><br><span class="line">br-c2dbe1686790      8000.02425be81fae          no</span><br><span class="line">docker0      8000.0242d6d509b1          no    vethc0e0cc3</span><br><span class="line">            vethf4b7577</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å®¿ä¸»æœºçš„ç½‘å¡</span></span><br><span class="line">$ ip addr</span><br><span class="line"><span class="comment">## è¾“å‡ºï¼Œbr-c2dbe1686790 ç½‘å¡åç§°ï¼Œå…¶IPç½‘æ®µä¸º 172.18.0.1/16</span></span><br><span class="line">13: br-c2dbe1686790: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default</span><br><span class="line">    <span class="built_in">link</span>/ether 02:42:5b:e8:1f:ae brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.18.0.1/16 brd 172.18.255.255 scope global br-c2dbe1686790</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨ä¸¤ä¸ªå®¹å™¨å¹¶æ·»åŠ åˆ°my-networkç½‘ç»œä¸­</span></span><br><span class="line">$ docker run -itd --network my-network --name a1 alpine</span><br><span class="line">$ docker run -itd --network my-network --name a2 alpine</span><br><span class="line"></span><br><span class="line">$ ip addr</span><br><span class="line"><span class="comment">## è¾“å‡º,å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªå®¹å™¨éƒ½æ·»åŠ åˆ°äº†my-networkç½‘ç»œä¸­</span></span><br><span class="line">bridge name      bridge <span class="built_in">id</span>        STP enabled    interfaces</span><br><span class="line">br-c2dbe16867908000.02425be81fae    no    veth094946c</span><br><span class="line">            vetha2ba68a</span><br><span class="line">docker0        8000.0242d6d509b1    no    vethc0e0cc3</span><br><span class="line">            vethf4b7577</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•è¿é€šæ€§ï¼Œå¯ä»¥çœ‹åˆ° a1å¯ä»¥pingé€š a2ï¼Œåè¿‡æ¥ a2ä¹Ÿå¯ä»¥pingé€š a1</span></span><br><span class="line">$ docker <span class="built_in">exec</span> -it a1 ping a2</span><br><span class="line">PING a2 (172.18.0.4): 56 data bytes</span><br><span class="line">64 bytes from 172.18.0.4: <span class="built_in">seq</span>=0 ttl=64 time=2.127 ms</span><br><span class="line">64 bytes from 172.18.0.4: <span class="built_in">seq</span>=1 ttl=64 time=0.119 ms</span><br><span class="line"></span><br><span class="line">$ docker ps</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND     CREATED         STATUS         PORTS     NAMES</span><br><span class="line">e0fb0614591e   alpine    <span class="string">&quot;/bin/sh&quot;</span>   4 minutes ago   Up 4 minutes             a2</span><br><span class="line">fc6e9477d2b7   alpine    <span class="string">&quot;/bin/sh&quot;</span>   4 minutes ago   Up 4 minutes             a1</span><br><span class="line">9d3ed5be1916   alpine    <span class="string">&quot;/bin/sh&quot;</span>   4 hours ago     Up 4 hours               ap2</span><br><span class="line">c2436a1d750c   alpine    <span class="string">&quot;/bin/sh&quot;</span>   4 hours ago     Up 4 hours               ap1</span><br><span class="line"><span class="comment"># ä¸åŒç½‘ç»œä¸­çš„å®¹å™¨ä¹‹é—´ä¸èƒ½ç›¸äº’pingé€š</span></span><br><span class="line"><span class="comment">## é€šè¿‡å®¹å™¨åç§°æ— æ³•pingé€š</span></span><br><span class="line">$ docker <span class="built_in">exec</span> -it a1 ping ap1</span><br><span class="line">ping: bad address <span class="string">&#x27;ap1&#x27;</span></span><br><span class="line"><span class="comment">## é€šè¿‡ap1å®¹å™¨IPä¹Ÿæ— æ³•pingé€šï¼Œè¿™å°±å®ç°äº†ä¸åŒç½‘ç»œä¸­çš„ç½‘ç»œéš”ç¦»</span></span><br><span class="line">$ docker <span class="built_in">exec</span> -it a1 ping 172.17.0.2</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å¦‚æœåˆ›å»ºç½‘ç»œæ—¶æ²¡æœ‰æŒ‡å®šå­ç½‘ï¼Œåˆ™ä»<code>docker0</code>çš„<code>172.17.0.0/16</code>å¾€åæ’ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¸Šé¢åˆ›å»ºçš„<code>my-network</code>ï¼Œå…¶å­ç½‘å°±æ˜¯<code>172.18.0.0/16</code>ï¼Œå¦‚ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ªbridgeç½‘ç»œï¼Œå¹¶æŒ‡å®šå­ç½‘ã€ç½‘å…³ç­‰ä¿¡æ¯</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker network create \</span><br><span class="line">  --driver bridge \</span><br><span class="line">  --subnet 192.168.50.0/24 \</span><br><span class="line">  --gateway 192.168.50.1 \</span><br><span class="line">  my-custom-net</span><br></pre></td></tr></table></figure><h4 id="bridge-æ€»ç»“"><code>bridge</code> æ€»ç»“</h4><ul class="lvl-0"><li class="lvl-2"><p>é»˜è®¤åˆ›å»ºçš„ <code>docker0</code> ç½‘ç»œï¼Œæ˜¯ä¸€ä¸ªæ¡¥æ¥ç½‘ç»œï¼Œåœ¨ docker network ä¸­çš„åç§°ä¸º <code>bridge</code>ï¼Œè¯¥ç½‘ç»œä¸‹çš„å®¹å™¨å¯ä»¥é€šè¿‡IPåœ°å€ç›¸äº’è®¿é—®ï¼Œä½†ä¸èƒ½é€šè¿‡å®¹å™¨åç§°è®¿é—®</p></li><li class="lvl-2"><p>é€šè¿‡<code>docker network create &lt;ç½‘ç»œåç§°&gt;</code>åˆ›å»ºçš„ç½‘ç»œä¹Ÿæ˜¯ä¸€ä¸ªæ¡¥æ¥ç½‘ç»œï¼Œåœ¨è¿™ä¸ªç½‘ç»œä¸‹ï¼Œå®¹å™¨å¯ä»¥é€šè¿‡IPåœ°å€ç›¸äº’è®¿é—®ï¼Œä¹Ÿèƒ½é€šè¿‡å®¹å™¨åç§°è®¿é—®ã€‚</p></li></ul><h3 id="docker-network-ls-åˆ—å‡ºæ‰€æœ‰ç½‘ç»œ"><code>docker network ls</code> : åˆ—å‡ºæ‰€æœ‰ç½‘ç»œ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ—å‡ºæ‰€æœ‰ç½‘ç»œ</span></span><br><span class="line">$ docker network <span class="built_in">ls</span></span><br><span class="line"><span class="comment"># è¾“å‡ºæŒ‡å®šçš„ä¿¡æ¯</span></span><br><span class="line">$ docker network <span class="built_in">ls</span> --format <span class="string">&quot;table &#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Name&#125;&#125;\t&#123;&#123;.Scope&#125;&#125;&quot;</span></span><br><span class="line"><span class="comment"># è¾“å‡ºjsonæ ¼å¼</span></span><br><span class="line">$ docker network <span class="built_in">ls</span> --format <span class="string">&quot;json&quot;</span></span><br><span class="line"><span class="comment"># è¿‡æ»¤</span></span><br><span class="line">$ docker network <span class="built_in">ls</span> -f <span class="string">&quot;driver=bridge&quot;</span></span><br><span class="line"><span class="comment"># ä¸æˆªæ–­è¾“å‡º</span></span><br><span class="line">$ docker network <span class="built_in">ls</span> --no-trunc</span><br><span class="line"><span class="comment"># åªæ˜¾ç¤ºnetwork id</span></span><br><span class="line">$ docker network <span class="built_in">ls</span> -q</span><br></pre></td></tr></table></figure><h3 id="docker-network-inspect-æŸ¥çœ‹ç½‘ç»œè¯¦æƒ…"><code>docker network inspect</code> : æŸ¥çœ‹ç½‘ç»œè¯¦æƒ…</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹åç§°ä¸ºbridgeç½‘ç»œè¯¦æƒ…</span></span><br><span class="line">$ docker network inspect bridge</span><br><span class="line"><span class="comment"># æŸ¥çœ‹å½“å‰ç½‘ç»œä¸‹æœ‰å“ªäº›å®¹å™¨</span></span><br><span class="line">$ docker network inspect bridge --format <span class="string">&quot;&#123;&#123;.Containers&#125;&#125;&quot;</span></span><br><span class="line"><span class="comment"># è¾“å‡ºjsonæ ¼å¼</span></span><br><span class="line">$ docker network inspect bridge --format <span class="string">&quot;json&quot;</span></span><br></pre></td></tr></table></figure><h3 id="docker-network-prune-æ¸…ç†æ²¡ç”¨çš„ç½‘ç»œ"><code>docker network prune</code> : æ¸…ç†æ²¡ç”¨çš„ç½‘ç»œ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„ç½‘ç»œ</span></span><br><span class="line">$ docker network prune</span><br><span class="line"><span class="comment"># åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„ç½‘ç»œï¼Œæ— éœ€ç¡®è®¤</span></span><br><span class="line">$ docker network prune -f</span><br><span class="line"><span class="comment"># æ¸…ç†24å°æ—¶å†…æœªä½¿ç”¨çš„ç½‘ç»œ</span></span><br><span class="line">$ docker network prune --filter <span class="string">&quot;until=24h&quot;</span></span><br></pre></td></tr></table></figure><h3 id="docker-network-rm-åˆ é™¤ç½‘ç»œ"><code>docker network rm</code> : åˆ é™¤ç½‘ç»œ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ é™¤æŒ‡å®šçš„ç½‘ç»œ</span></span><br><span class="line">$ docker network <span class="built_in">rm</span> &lt;network-name&gt;</span><br><span class="line"><span class="comment"># åˆ é™¤æ‰€æœ‰ç½‘ç»œ</span></span><br><span class="line">$ docker network <span class="built_in">rm</span> $(docker network <span class="built_in">ls</span> -q)</span><br><span class="line"><span class="comment"># åˆ é™¤æ‰€æœ‰bridgeç½‘ç»œï¼Œè¿™é‡Œè¦æ³¨æ„ï¼Œdockeré»˜è®¤åˆ›å»ºçš„3ä¸ªç½‘ç»œæ˜¯åˆ é™¤ä¸æ‰çš„</span></span><br><span class="line">$ docker network <span class="built_in">rm</span> $(docker network <span class="built_in">ls</span> -q -f driver=bridge)</span><br></pre></td></tr></table></figure><h3 id="docker-network-connect-å°†å®¹å™¨è¿æ¥åˆ°ç½‘ç»œ"><code>docker network connect</code> : å°†å®¹å™¨è¿æ¥åˆ°ç½‘ç»œ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†å®¹å™¨è¿æ¥åˆ°ç½‘ç»œï¼Œå¦‚æœå®¹å™¨å¯åŠ¨æ—¶å¿˜è®°è¿æ¥ç½‘ç»œï¼Œè¿™é‡Œå¯ä»¥æ‰‹åŠ¨æ·»åŠ </span></span><br><span class="line">$ docker network connect &lt;network-name&gt; &lt;container-name&gt;</span><br></pre></td></tr></table></figure><h3 id="docker-network-disconnect-å°†å®¹å™¨ä»ç½‘ç»œæ–­å¼€"><code>docker network disconnect</code> : å°†å®¹å™¨ä»ç½‘ç»œæ–­å¼€</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker network disconnect &lt;network-name&gt; &lt;container-name&gt;</span><br></pre></td></tr></table></figure><h2 id="æœ¬æ–‡æ€»ç»“">æœ¬æ–‡æ€»ç»“</h2><ul class="lvl-0"><li class="lvl-2"><p>å®¹å™¨ä¸ç½‘ç»œæ˜¯å¤šå¯¹å¤šçš„å…³ç³»ï¼Œå³ä¸€ä¸ªç½‘ç»œå¯ä»¥æœ‰å¤šä¸ªå®¹å™¨ï¼Œä¸€ä¸ªå®¹å™¨ä¹Ÿå¯ä»¥è¿æ¥åˆ°å¤šä¸ªç½‘ç»œã€‚</p></li><li class="lvl-2"><p>docker0 æ˜¯ docker é»˜è®¤åˆ›å»ºçš„ç½‘ç»œï¼Œä¸æŒ‡å®šç½‘ç»œçš„æƒ…å†µä¸‹æ‰€æœ‰å®¹å™¨éƒ½è¿æ¥åˆ° docker0 ç½‘ç»œã€‚</p></li><li class="lvl-2"><p>docker0 æ˜¯ bridge ç½‘ç»œï¼Œè¯¥ç½‘ç»œä¸­çš„å®¹å™¨ä¹‹é—´å¯ä»¥é€šè¿‡ IP äº’ç›¸è®¿é—®ï¼Œä½†ä¸èƒ½é€šè¿‡å®¹å™¨åç§°è®¿é—®ã€‚</p></li><li class="lvl-2"><p>è‡ªå»ºçš„ bridge ç½‘ç»œä¸­çš„å®¹å™¨å¯ä»¥é€šè¿‡å®¹å™¨åç§°ï¼ˆæˆ–å®¹å™¨IDï¼Œä½†ä¸å¸¸ç”¨ï¼‰è®¿é—®ã€‚</p></li><li class="lvl-2"><p>ä¸åŒçš„ bridge ç½‘ç»œä¸­çš„å®¹å™¨ä¸èƒ½äº’ç›¸è®¿é—®ã€‚</p></li></ul><h2 id="link-vs-network"><code>--link</code> vs <code>--network</code></h2><table><thead><tr><th>é¡¹ç›®</th><th><code>--link</code></th><th><code>--network</code></th></tr></thead><tbody><tr><td>åŠŸèƒ½</td><td>å°†ä¸€ä¸ªå®¹å™¨é“¾æ¥åˆ°å¦ä¸€ä¸ªå®¹å™¨ï¼Œå¹¶è®¾ç½®ç¯å¢ƒå˜é‡å’Œä¸»æœºåæ˜ å°„</td><td>å°†å®¹å™¨åŠ å…¥åˆ°ä¸€ä¸ªè‡ªå®šä¹‰ç½‘ç»œä¸­ï¼Œå®ç°çµæ´»ã€éš”ç¦»çš„ç½‘ç»œé€šä¿¡</td></tr><tr><td>æ˜¯å¦æ¨è</td><td>âŒ ä¸æ¨èï¼ˆå·²åºŸå¼ƒï¼‰</td><td>âœ… æ¨èä½¿ç”¨</td></tr><tr><td>ç½‘ç»œéš”ç¦»</td><td>åŸºäºé»˜è®¤ <code>bridge</code> ç½‘ç»œï¼Œéš”ç¦»æ€§å·®</td><td>å¯ä»¥åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œï¼ˆbridgeã€overlay ç­‰ï¼‰ï¼Œéš”ç¦»æ€§å¼º</td></tr><tr><td>å¯æ‰©å±•æ€§</td><td>åªé€‚ç”¨äºå·²è¿è¡Œçš„å®¹å™¨ï¼Œè¿æ¥å›ºå®š</td><td>æ”¯æŒå¤šä¸ªå®¹å™¨ï¼Œçµæ´»ç»„åˆå’ŒåŠ¨æ€æ‰©å±•</td></tr><tr><td>DNS æ”¯æŒ</td><td>ä»…è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œä¸æ”¯æŒè‡ªåŠ¨ DNS</td><td>è‡ªå®šä¹‰ç½‘ç»œä¸­æ”¯æŒå®¹å™¨åç§°ä½œä¸º DNS åç§°</td></tr><tr><td>ç”Ÿå‘½å‘¨æœŸ</td><td>ä¸€æ–¹å®¹å™¨å…³é—­ï¼Œå¦ä¸€æ–¹ä»ä¿å­˜è¿‡æ—¶é“¾æ¥</td><td>ç½‘ç»œå­˜åœ¨å³å¯ï¼Œå®¹å™¨ç”Ÿå‘½å‘¨æœŸä¸äº’ç›¸å½±å“</td></tr><tr><td>å®‰å…¨æ€§</td><td>æ‰€æœ‰å®¹å™¨å…±äº« bridgeï¼Œå®¹æ˜“ç›¸äº’è®¿é—®</td><td>è‡ªå®šä¹‰ç½‘ç»œé—´é»˜è®¤éš”ç¦»ï¼Œå®‰å…¨æ€§æ›´å¥½</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;!--
 **åŠ ç²—**
 *æ–œä½“*
 ***åŠ ç²—å¹¶æ–œä½“***
 ~~åˆ é™¤çº¿~~
 ==çªå‡ºæ˜¾ç¤º==
 `çªå‡ºæ˜¾ç¤º(æ¨è)`
 ++ä¸‹åˆ’çº¿++
 ~ä¸‹æ ‡~
 ^ä¸Šæ ‡^
 è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.
 å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **ç‚¹å‡»æŠ˜å **
 è¿™æ˜¯è¢«éšè—çš„å†…å®¹
 +++

::: tips success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
:::

% note info % success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
% endnote %

å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}
 å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ
 --&gt;
&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ ç½‘ç»œç®¡ç† ç›¸å…³å‘½ä»¤&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com&quot;&gt;Dockerå®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/docker/"/>
    
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>Docker å‘½ä»¤ ä¹‹ æ•°æ®å·(Volume)</title>
    <link href="https://blog.hanqunfeng.com/2025/05/28/docker-command-volume/"/>
    <id>https://blog.hanqunfeng.com/2025/05/28/docker-command-volume/</id>
    <published>2025-05-28T13:30:05.000Z</published>
    <updated>2025-05-29T09:27:21.992Z</updated>
    
    <content type="html"><![CDATA[<!-- **åŠ ç²—** *æ–œä½“* ***åŠ ç²—å¹¶æ–œä½“*** ~~åˆ é™¤çº¿~~ ==çªå‡ºæ˜¾ç¤º== `çªå‡ºæ˜¾ç¤º(æ¨è)` ++ä¸‹åˆ’çº¿++ ~ä¸‹æ ‡~ ^ä¸Šæ ‡^ è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference. å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **ç‚¹å‡»æŠ˜å ** è¿™æ˜¯è¢«éšè—çš„å†…å®¹ +++::: tips success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹:::% note info % success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹% endnote %å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{} å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ --><h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2"><p>æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ æ•°æ®å·ç®¡ç† ç›¸å…³å‘½ä»¤</p></li><li class="lvl-2"><p><a href="https://docs.docker.com">Dockerå®˜æ–¹æ–‡æ¡£</a></p></li></ul><span id="more"></span><h2 id="ä»€ä¹ˆæ˜¯Volume-æ•°æ®å·">ä»€ä¹ˆæ˜¯Volume(æ•°æ®å·)?</h2><ul class="lvl-0"><li class="lvl-2"><p>Volume æ˜¯ç”± Docker ç®¡ç†çš„ç‰¹æ®Šç›®å½•ï¼Œä½äºå®¿ä¸»æœºæ–‡ä»¶ç³»ç»Ÿä¸­(<code>/var/lib/docker/volumes/</code>)ï¼Œç”¨äºå­˜å‚¨å’Œå…±äº«å®¹å™¨çš„æ•°æ®ã€‚</p></li><li class="lvl-2"><p>å½“å®¹å™¨è¢«åˆ é™¤åï¼Œå®¹å™¨å†…çš„æ–‡ä»¶ç³»ç»Ÿä¹Ÿä¼šä¸€èµ·åˆ é™¤ï¼Œä½†æŒ‚è½½åœ¨ Volume ä¸­çš„æ•°æ®ä¸ä¼šä¸¢å¤±ï¼Œå¯ä¾›å¤šä¸ªå®¹å™¨å…±äº«ã€‚</p></li><li class="lvl-2"><p>Volume çš„ç‰¹ç‚¹</p></li></ul><table><thead><tr><th>ç‰¹æ€§</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>æ•°æ®æŒä¹…åŒ–</td><td>å³ä½¿å®¹å™¨åˆ é™¤ï¼Œæ•°æ®ä»ä¿ç•™åœ¨å·ä¸­</td></tr><tr><td>å¤šå®¹å™¨å…±äº«è®¿é—®</td><td>å¤šä¸ªå®¹å™¨å¯ä»¥æŒ‚è½½åŒä¸€ä¸ªå·ï¼Œå®ç°æ•°æ®å…±äº«</td></tr><tr><td>ä¸ä¾èµ–å®¹å™¨è·¯å¾„</td><td>å·ä¸å®¹å™¨ç”Ÿå‘½å‘¨æœŸè§£è€¦ï¼Œæ”¯æŒçµæ´»çš„å®¹å™¨é‡å»ºå’Œå‡çº§</td></tr><tr><td>ç®¡ç†ç®€ä¾¿</td><td>å¯ç”¨ <code>docker volume</code> å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹ã€åˆ›å»ºã€åˆ é™¤ç­‰æ“ä½œ</td></tr><tr><td>å®‰å…¨éš”ç¦»</td><td>Docker ç®¡ç†çš„è·¯å¾„æ¯”ç»‘å®šæŒ‚è½½æ›´å®‰å…¨</td></tr></tbody></table><h2 id="docker-volume-ç›¸å…³å‘½ä»¤"><code>docker volume</code> ç›¸å…³å‘½ä»¤</h2><table><thead><tr><th>å‘½ä»¤</th><th>ä½œç”¨è¯´æ˜</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td><code>docker volume create</code></td><td>åˆ›å»ºä¸€ä¸ªæ–°çš„å·ï¼Œåç§°å¯é€‰ï¼ˆä¸æŒ‡å®šä¼šè‡ªåŠ¨ç”Ÿæˆï¼‰</td><td><code>docker volume create myvolume</code></td></tr><tr><td><code>docker volume ls</code></td><td>åˆ—å‡ºæ‰€æœ‰å·²å­˜åœ¨çš„å·</td><td><code>docker volume ls</code></td></tr><tr><td><code>docker volume inspect &lt;name&gt;</code></td><td>æŸ¥çœ‹æŒ‡å®šå·çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬æŒ‚è½½ç‚¹ã€é©±åŠ¨ç­‰</td><td><code>docker volume inspect myvolume</code></td></tr><tr><td><code>docker volume rm &lt;name&gt;</code></td><td>åˆ é™¤ä¸€ä¸ªå·ï¼ˆå‰ææ˜¯æ²¡æœ‰å®¹å™¨æ­£åœ¨ä½¿ç”¨è¯¥å·ï¼‰</td><td><code>docker volume rm myvolume</code></td></tr><tr><td><code>docker volume prune</code></td><td>åˆ é™¤æ‰€æœ‰æœªè¢«ä½¿ç”¨çš„å·ï¼ˆä¼šæœ‰ç¡®è®¤æç¤ºï¼‰</td><td><code>docker volume prune</code></td></tr></tbody></table><h3 id="docker-volume-create-åˆ›å»ºä¸€ä¸ªæ–°çš„å·"><code>docker volume create</code> : åˆ›å»ºä¸€ä¸ªæ–°çš„å·</h3><ul class="lvl-0"><li class="lvl-2"><p>è¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker volume create [OPTIONS] [VOLUME]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å‚æ•°è¯¦è§£</p></li></ul><table><thead><tr><th>é€‰é¡¹</th><th>è¯´æ˜</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td><code>-d, --driver string</code></td><td>æŒ‡å®šå·é©±åŠ¨ç¨‹åºï¼Œé»˜è®¤æ˜¯ <code>local</code>ï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰</td><td><code>-d local</code> æˆ– ç¬¬ä¸‰æ–¹é©±åŠ¨åç§°(éœ€è¦å®‰è£…ç¬¬ä¸‰æ–¹æ’ä»¶)</td></tr><tr><td><code>--label list</code></td><td>ç»™å·æ·»åŠ æ ‡ç­¾ï¼ˆå…ƒæ•°æ®ï¼‰ï¼Œå¯ç”¨äºåˆ†ç±»ã€è¿‡æ»¤</td><td><code>--label env=prod</code></td></tr><tr><td><code>-o, --opt map</code></td><td>è®¾ç½®é©±åŠ¨çš„ç‰¹å®šé€‰é¡¹ï¼Œæ ¼å¼ä¸º <code>key=value</code>ï¼Œå¤šä¸ªé€‰é¡¹å¯é‡å¤ä½¿ç”¨</td><td><code>-o type=tmpfs -o device=tmpfs</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªé»˜è®¤å·ï¼ˆlocal é©±åŠ¨ï¼‰</span></span><br><span class="line">docker volume create myvolume</span><br><span class="line"><span class="comment"># ä¹Ÿå¯ä»¥åœ¨å¯åŠ¨å®¹å™¨çš„æ—¶å€™åˆ›å»ºé»˜è®¤æ•°æ®å·ï¼Œå¦‚ä¸‹å‘½ä»¤ï¼Œè‹¥ myvolume å·ä¸å­˜åœ¨ï¼Œåˆ™ä¼šè‡ªåŠ¨åˆ›å»º</span></span><br><span class="line">docker run -d -v myvolume:/data nginx</span><br><span class="line">docker run -d --mount <span class="built_in">type</span>=volume,<span class="built_in">source</span>=myvolume,target=/data nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªå¸¦æœ‰æ ‡ç­¾çš„å·</span></span><br><span class="line">docker volume create --label <span class="built_in">env</span>=dev --label team=backend myvolume</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºåŒ¿åå·ï¼ˆä¸æŒ‡å®šåç§°ï¼‰</span></span><br><span class="line">docker volume create</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ tmpfs ç±»å‹å·ï¼ˆåªå­˜äºå†…å­˜ä¸­ï¼Œä¸è½ç›˜ï¼‰,é€‚ç”¨äºé«˜é€Ÿè¯»å†™ä½†ä¸éœ€è¦æŒä¹…åŒ–çš„æ•°æ®</span></span><br><span class="line">docker volume create \</span><br><span class="line">  -d <span class="built_in">local</span> \            <span class="comment"># æŒ‡å®šé©±åŠ¨ç¨‹åºä¸º local</span></span><br><span class="line">  -o <span class="built_in">type</span>=tmpfs \       <span class="comment"># æŒ‡å®šåº•å±‚æ–‡ä»¶ç³»ç»Ÿç±»å‹ä¸º tmpfsï¼ˆå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼‰</span></span><br><span class="line">  -o device=tmpfs \     <span class="comment"># è®¾ç½®æŒ‚è½½è®¾å¤‡ä¸º tmpfsï¼Œç”¨äºä¸ type=tmpfs é…åˆ</span></span><br><span class="line">  -o o=size=100m \      <span class="comment"># è®¾ç½® tmpfs çš„æœ€å¤§å®¹é‡ä¸º 100MB</span></span><br><span class="line">  mytmpfs               <span class="comment"># å·çš„åç§°ï¼Œå¯é€šè¿‡ docker volume ls æŸ¥çœ‹</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰é©±åŠ¨çš„å·ï¼ˆå¦‚ nfsï¼‰</span></span><br><span class="line">docker volume create \</span><br><span class="line">  -d <span class="built_in">local</span> \                    <span class="comment"># é»˜è®¤é©±åŠ¨ç¨‹åºä¸º local</span></span><br><span class="line">  -o <span class="built_in">type</span>=nfs \                 <span class="comment"># åº•å±‚æ–‡ä»¶ç³»ç»Ÿç±»å‹ä¸º nfs</span></span><br><span class="line">  -o o=addr=192.168.1.100,rw \  <span class="comment"># è®¾ç½® nfs çš„åœ°å€å’Œè¯»å†™æƒé™ï¼Œè‹¥åªè¯»ä¸º ro</span></span><br><span class="line">  -o device=:/path/to/share \   <span class="comment"># æŒ‚è½½è®¾å¤‡ä¸º nfsï¼Œæ ¼å¼ä¸ºï¼šnfs://192.168.1.100:/path/to/share</span></span><br><span class="line">  mynfs                         <span class="comment"># å·çš„åç§°ï¼Œå¯é€šè¿‡ docker volume ls æŸ¥çœ‹</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åˆ›å»ºçš„æ•°æ®å·ä¼šä¿å­˜åœ¨ <code>/var/lib/docker/volumes/</code> ç›®å½•ä¸‹ï¼Œæ¯”å¦‚æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå· myvolumeï¼Œé‚£ä¹ˆè¯¥å·ä¼šä¿å­˜åœ¨ <code>/var/lib/docker/volumes/myvolume/_data</code> ç›®å½•ä¸‹</p></li></ul><h3 id="docker-volume-ls-åˆ—å‡ºæ‰€æœ‰å·²å­˜åœ¨çš„å·"><code>docker volume ls</code> : åˆ—å‡ºæ‰€æœ‰å·²å­˜åœ¨çš„å·</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ—å‡ºæ‰€æœ‰å·</span></span><br><span class="line">docker volume <span class="built_in">ls</span></span><br><span class="line"><span class="comment"># åˆ—å‡ºæ‰€æœ‰å·çš„ID</span></span><br><span class="line">docker volume <span class="built_in">ls</span> -q</span><br><span class="line"><span class="comment"># åˆ—å‡ºæŒ‡å®šé©±åŠ¨çš„å·</span></span><br><span class="line">docker volume <span class="built_in">ls</span> -f driver=<span class="built_in">local</span></span><br><span class="line"><span class="comment"># åˆ—å‡ºæŒ‡å®šæ ‡ç­¾çš„å·</span></span><br><span class="line">docker volume <span class="built_in">ls</span> -f label=<span class="built_in">env</span>=dev</span><br><span class="line"><span class="comment"># åˆ—å‡ºæ‰€æœ‰æœªä½¿ç”¨çš„å·ï¼ŒåŒ…æ‹¬åŒ¿åå·å’Œå‘½åå·</span></span><br><span class="line">docker volume <span class="built_in">ls</span> -f dangling=<span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="docker-volume-inspect-name-æŸ¥çœ‹æŒ‡å®šå·çš„è¯¦ç»†ä¿¡æ¯"><code>docker volume inspect &lt;name&gt;</code> : æŸ¥çœ‹æŒ‡å®šå·çš„è¯¦ç»†ä¿¡æ¯</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ—å‡ºæŒ‡å®šå·çš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">docker volume inspect myvolume</span><br><span class="line"><span class="comment"># åˆ—å‡ºæŒ‡å®šå·çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¹¶ä½¿ç”¨jsonæ ¼å¼è¾“å‡º</span></span><br><span class="line">docker volume inspect -f json myvolume</span><br><span class="line"><span class="comment"># åˆ—å‡ºæŒ‡å®šå·çš„æŒ‚è½½ç‚¹</span></span><br><span class="line">docker volume inspect myvolume --format <span class="string">&quot;&#123;&#123;.Mountpoint&#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure><h3 id="docker-volume-prune-åˆ é™¤æ‰€æœ‰æœªè¢«å®¹å™¨ä½¿ç”¨çš„å·"><code>docker volume prune</code> : åˆ é™¤æ‰€æœ‰æœªè¢«å®¹å™¨ä½¿ç”¨çš„å·</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ é™¤æ‰€æœ‰æœªè¢«ä½¿ç”¨çš„åŒ¿åæ•°æ®å·ï¼Œä¼šæç¤ºç¡®è®¤</span></span><br><span class="line">docker volume prune</span><br><span class="line"><span class="comment"># åˆ é™¤æ‰€æœ‰æœªè¢«ä½¿ç”¨çš„æ•°æ®å·ï¼Œä¼šæç¤ºç¡®è®¤</span></span><br><span class="line">docker volume prune -a</span><br><span class="line"><span class="comment"># åˆ é™¤æ‰€æœ‰æœªè¢«ä½¿ç”¨çš„å·ï¼Œæ— éœ€ç¡®è®¤ç«‹åˆ»åˆ é™¤</span></span><br><span class="line">docker volume prune -a -f</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åŒ¿åå· vs å‘½åå·</p><ul class="lvl-2"><li class="lvl-4">åŒ¿åå·ï¼šæ²¡æœ‰åç§°ï¼Œåªåœ¨ <code>docker run -v /container/path</code> æ—¶è‡ªåŠ¨åˆ›å»ºï¼›</li><li class="lvl-4">å‘½åå·ï¼šæœ‰åç§°ï¼Œä¾‹å¦‚ <code>docker run -v mydata:/container/path</code>ï¼›</li></ul></li></ul><h3 id="docker-volume-rm-name-åˆ é™¤æ•°æ®å·"><code>docker volume rm &lt;name&gt;</code> : åˆ é™¤æ•°æ®å·</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ é™¤æŒ‡å®šæ•°æ®å·</span></span><br><span class="line">docker volume <span class="built_in">rm</span> myvolume</span><br><span class="line"><span class="comment"># åˆ é™¤æ‰€æœ‰æ•°æ®å·</span></span><br><span class="line">docker volume <span class="built_in">rm</span> $(docker volume <span class="built_in">ls</span> -q)</span><br><span class="line"><span class="comment"># åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„æ•°æ®å·</span></span><br><span class="line">docker volume <span class="built_in">rm</span> $(docker volume <span class="built_in">ls</span> -qf dangling=<span class="literal">true</span>)</span><br><span class="line"><span class="comment"># åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„æ•°æ®å·ï¼Œæ— éœ€ç¡®è®¤</span></span><br><span class="line">docker volume <span class="built_in">rm</span> $(docker volume <span class="built_in">ls</span> -qf dangling=<span class="literal">true</span>) -f</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **åŠ ç²—**
 *æ–œä½“*
 ***åŠ ç²—å¹¶æ–œä½“***
 ~~åˆ é™¤çº¿~~
 ==çªå‡ºæ˜¾ç¤º==
 `çªå‡ºæ˜¾ç¤º(æ¨è)`
 ++ä¸‹åˆ’çº¿++
 ~ä¸‹æ ‡~
 ^ä¸Šæ ‡^
 è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.
 å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **ç‚¹å‡»æŠ˜å **
 è¿™æ˜¯è¢«éšè—çš„å†…å®¹
 +++

::: tips success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
:::

% note info % success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
% endnote %

å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}
 å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ
 --&gt;
&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ æ•°æ®å·ç®¡ç† ç›¸å…³å‘½ä»¤&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com&quot;&gt;Dockerå®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/docker/"/>
    
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>Docker å‘½ä»¤ ä¹‹ å®¹å™¨(Container)</title>
    <link href="https://blog.hanqunfeng.com/2025/05/27/docker-command-container/"/>
    <id>https://blog.hanqunfeng.com/2025/05/27/docker-command-container/</id>
    <published>2025-05-27T13:30:05.000Z</published>
    <updated>2025-05-29T09:02:17.040Z</updated>
    
    <content type="html"><![CDATA[<!-- **åŠ ç²—** *æ–œä½“* ***åŠ ç²—å¹¶æ–œä½“*** ~~åˆ é™¤çº¿~~ ==çªå‡ºæ˜¾ç¤º== `çªå‡ºæ˜¾ç¤º(æ¨è)` ++ä¸‹åˆ’çº¿++ ~ä¸‹æ ‡~ ^ä¸Šæ ‡^ è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference. å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **ç‚¹å‡»æŠ˜å ** è¿™æ˜¯è¢«éšè—çš„å†…å®¹ +++::: tips success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹:::% note info % success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹% endnote %å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{} å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ --><h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2"><p>æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ å®¹å™¨ç®¡ç† ç›¸å…³å‘½ä»¤</p></li><li class="lvl-2"><p><a href="https://docs.docker.com">Dockerå®˜æ–¹æ–‡æ¡£</a></p></li></ul><span id="more"></span><h2 id="å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸ">å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸ</h2><ul class="lvl-0"><li class="lvl-2"><p>å®¹å™¨å¯èƒ½å¤„äºä»¥ä¸‹å‡ ç§çŠ¶æ€ï¼š</p><ul class="lvl-2"><li class="lvl-5">åˆå»ºï¼ˆcreatedï¼‰</li><li class="lvl-5">è¿è¡Œï¼ˆrunningï¼‰</li><li class="lvl-5">æš‚åœï¼ˆpausedï¼‰</li><li class="lvl-5">åœæ­¢ï¼ˆstoppedï¼‰</li><li class="lvl-5">åˆ é™¤ï¼ˆdeletedï¼‰</li></ul></li><li class="lvl-2"><p>å„ç”Ÿå‘½å‘¨æœŸä¹‹é—´çš„è½¬æ¢å…³ç³»å¦‚å›¾æ‰€ç¤ºï¼š<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/19n9NJ.png" alt=""></p></li></ul><table><thead><tr><th>å‘½ä»¤/æƒ…å†µ</th><th>è¯´æ˜</th><th>å®¹å™¨çŠ¶æ€å˜æ›´</th></tr></thead><tbody><tr><td><code>docker create</code></td><td>åˆ›å»ºå®¹å™¨åï¼Œä¸ç«‹å³å¯åŠ¨è¿è¡Œï¼Œå®¹å™¨è¿›å…¥åˆå»ºçŠ¶æ€</td><td>åˆå»ºçŠ¶æ€</td></tr><tr><td><code>docker run</code></td><td>åˆ›å»ºå®¹å™¨ï¼Œå¹¶ç«‹å³å¯åŠ¨è¿è¡Œï¼Œè¿›å…¥è¿è¡ŒçŠ¶æ€</td><td>åˆå»º â†’ è¿è¡Œ</td></tr><tr><td><code>docker start</code></td><td>å¯åŠ¨å·²åˆ›å»ºçš„å®¹å™¨ï¼Œå®¹å™¨è½¬ä¸ºè¿è¡ŒçŠ¶æ€</td><td>åœæ­¢ â†’ è¿è¡Œ</td></tr><tr><td><code>docker stop</code></td><td>åœæ­¢æ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼Œå®¹å™¨è½¬å…¥åœæ­¢çŠ¶æ€</td><td>è¿è¡Œ â†’ åœæ­¢</td></tr><tr><td><code>docker kill</code></td><td>å¼ºåˆ¶ç»ˆæ­¢å®¹å™¨ï¼Œç›¸å½“äºâ€œæ–­ç”µâ€ï¼Œå®¹æ˜“ä¸¢å¤±æ•°æ®ï¼Œä¸å»ºè®®è½»æ˜“ä½¿ç”¨</td><td>è¿è¡Œ â†’ åœæ­¢ï¼ˆéæ­£å¸¸ï¼‰</td></tr><tr><td><code>docker restart</code></td><td>é‡å¯å®¹å™¨ï¼Œå®¹å™¨é‡æ–°è¿›å…¥è¿è¡ŒçŠ¶æ€</td><td>è¿è¡Œ â†’ åœæ­¢ â†’ è¿è¡Œ</td></tr><tr><td><code>docker pause</code></td><td>æš‚åœå®¹å™¨å†…æ‰€æœ‰è¿›ç¨‹ï¼Œå®¹å™¨è¿›å…¥æš‚åœçŠ¶æ€</td><td>è¿è¡Œ â†’ æš‚åœ</td></tr><tr><td><code>docker unpause</code></td><td>å–æ¶ˆæš‚åœçŠ¶æ€ï¼Œå®¹å™¨æ¢å¤è¿è¡Œ</td><td>æš‚åœ â†’ è¿è¡Œ</td></tr><tr><td><code>docker rm</code></td><td>åˆ é™¤å®¹å™¨ï¼Œå®¹å™¨è½¬å…¥åˆ é™¤çŠ¶æ€</td><td>ä»»æ„ â†’ åˆ é™¤</td></tr><tr><td>Killed by out-of-memory (OOM)</td><td>å®¿ä¸»æœºå†…å­˜è€—å°½ï¼Œå®¹å™¨è¢«ç³»ç»Ÿç»ˆæ­¢ï¼Œæ­¤ä¸ºéè®¡åˆ’ç»ˆæ­¢ï¼›å»ºè®®æ€æ­»å†…å­˜å ç”¨æœ€é«˜çš„å®¹å™¨</td><td>è¿è¡Œ â†’ åœæ­¢ï¼ˆå¼‚å¸¸ï¼‰</td></tr><tr><td>Container process exited</td><td>å®¹å™¨è¿›ç¨‹å¼‚å¸¸ç»ˆæ­¢åï¼Œè¿›å…¥â€œæ˜¯å¦é‡å¯â€åˆ¤æ–­æµç¨‹ï¼šæ˜¯åˆ™æ‰§è¡Œ <code>start</code> è¿›å…¥è¿è¡Œï¼›å¦åˆ™ä¿æŒåœæ­¢çŠ¶æ€</td><td>å¼‚å¸¸ â†’ åœæ­¢æˆ–è¿è¡Œ</td></tr></tbody></table><h2 id="docker-container-å®¹å™¨ç®¡ç†"><code>docker container</code> : å®¹å™¨ç®¡ç†</h2><ul class="lvl-0"><li class="lvl-2"><p><code>docker container --help</code></p></li></ul><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th><th>åˆ«å</th></tr></thead><tbody><tr><td>attach</td><td>å°†æœ¬åœ°çš„æ ‡å‡†è¾“å…¥ã€è¾“å‡ºå’Œé”™è¯¯æµé™„åŠ åˆ°ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„å®¹å™¨ä¸Š</td><td>docker attach</td></tr><tr><td>commit</td><td>æ ¹æ®å®¹å™¨çš„æ›´æ”¹åˆ›å»ºä¸€ä¸ªæ–°çš„é•œåƒ</td><td>docker commit</td></tr><tr><td>cp</td><td>åœ¨å®¹å™¨å’Œæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¹‹é—´å¤åˆ¶æ–‡ä»¶/æ–‡ä»¶å¤¹</td><td>docker cp</td></tr><tr><td>create</td><td>åˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨</td><td>docker create</td></tr><tr><td>diff</td><td>æ£€æŸ¥å®¹å™¨æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ–‡ä»¶æˆ–ç›®å½•çš„æ›´æ”¹</td><td>docker diff</td></tr><tr><td>exec</td><td>åœ¨æ­£åœ¨è¿è¡Œçš„å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤</td><td>docker exec</td></tr><tr><td>export</td><td>å°†å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿå¯¼å‡ºä¸º tar å½’æ¡£æ–‡ä»¶</td><td>docker export</td></tr><tr><td>inspect</td><td>æ˜¾ç¤ºä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨çš„è¯¦ç»†ä¿¡æ¯</td><td>å¯ä»¥ä½¿ç”¨ <code>docker inspect</code></td></tr><tr><td>kill</td><td>ç»ˆæ­¢ä¸€ä¸ªæˆ–å¤šä¸ªæ­£åœ¨è¿è¡Œçš„å®¹å™¨</td><td>docker kill</td></tr><tr><td>logs</td><td>è·å–å®¹å™¨çš„æ—¥å¿—</td><td>docker logs</td></tr><tr><td>ls</td><td>åˆ—å‡ºå®¹å™¨</td><td>docker ps</td></tr><tr><td>pause</td><td>æš‚åœä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨å†…çš„æ‰€æœ‰è¿›ç¨‹</td><td>docker pause</td></tr><tr><td>port</td><td>åˆ—å‡ºå®¹å™¨çš„ç«¯å£æ˜ å°„æˆ–ç‰¹å®šçš„ç«¯å£æ˜ å°„</td><td>docker port</td></tr><tr><td>prune</td><td>åˆ é™¤æ‰€æœ‰å·²åœæ­¢çš„å®¹å™¨</td><td></td></tr><tr><td>rename</td><td>é‡å‘½åä¸€ä¸ªå®¹å™¨</td><td>docker rename</td></tr><tr><td>restart</td><td>é‡å¯ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨</td><td>docker restart</td></tr><tr><td>rm</td><td>åˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨</td><td>docker rm</td></tr><tr><td>run</td><td>æ ¹æ®é•œåƒåˆ›å»ºå¹¶è¿è¡Œä¸€ä¸ªæ–°å®¹å™¨</td><td>docker run</td></tr><tr><td>start</td><td>å¯åŠ¨ä¸€ä¸ªæˆ–å¤šä¸ªå·²åœæ­¢çš„å®¹å™¨</td><td>docker start</td></tr><tr><td>stats</td><td>å®æ—¶æ˜¾ç¤ºå®¹å™¨èµ„æºä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯</td><td>docker stats</td></tr><tr><td>stop</td><td>åœæ­¢ä¸€ä¸ªæˆ–å¤šä¸ªæ­£åœ¨è¿è¡Œçš„å®¹å™¨</td><td>docker stop</td></tr><tr><td>top</td><td>æ˜¾ç¤ºå®¹å™¨ä¸­è¿è¡Œçš„è¿›ç¨‹</td><td>docker top</td></tr><tr><td>unpause</td><td>å–æ¶ˆæš‚åœä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨å†…çš„æ‰€æœ‰è¿›ç¨‹</td><td>docker unpause</td></tr><tr><td>update</td><td>æ›´æ–°ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨çš„é…ç½®</td><td>docker update</td></tr><tr><td>wait</td><td>é˜»å¡ç›´åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨åœæ­¢ï¼Œç„¶åæ‰“å°å…¶é€€å‡ºä»£ç </td><td>docker wait</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>è¿è¡Œ <code>docker container COMMAND --help</code> å¯è·å–æŸä¸ªå‘½ä»¤çš„æ›´å¤šä¿¡æ¯ã€‚</p></li></ul><h3 id="docker-create-åˆ›å»ºå®¹å™¨ï¼Œä½†ä¸å¯åŠ¨"><code>docker create</code> : åˆ›å»ºå®¹å™¨ï¼Œä½†ä¸å¯åŠ¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker create \</span><br><span class="line">    --name my-container \ <span class="comment"># å®¹å™¨å</span></span><br><span class="line">    -e MY_ENV_VAR=my-value \ <span class="comment"># è®¾ç½®ç¯å¢ƒå˜é‡</span></span><br><span class="line">    -p 80:80 \ <span class="comment"># æ˜ å°„ç«¯å£ï¼Œæ ¼å¼ï¼šå®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£</span></span><br><span class="line">    -v /path/to/my/dir:/path/in/container \ <span class="comment"># æ˜ å°„ç›®å½•ï¼Œæ ¼å¼ï¼šå®¿ä¸»æœºç›®å½•:å®¹å™¨ç›®å½•ï¼Œéƒ½å¿…é¡»æ˜¯ç»å¯¹è·¯å¾„</span></span><br><span class="line">    --restart always \ <span class="comment"># è®¾ç½®é‡å¯ç­–ç•¥</span></span><br><span class="line">    nginx:latest \ <span class="comment"># é•œåƒåï¼Œé•œåƒä¸å­˜åœ¨æ—¶ä¼šè‡ªåŠ¨ä¸‹è½½</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>docker create</code> ä¸ <code>docker run</code> çš„å‚æ•°åŸºæœ¬ä¸€è‡´ï¼Œå…·ä½“æŸ¥çœ‹ä¸‹é¢ <code>docker run</code> ä¸­çš„ä»‹ç»ã€‚</p></li></ul><h3 id="docker-start-å¯åŠ¨ä¸€ä¸ªå®¹å™¨"><code>docker start</code> : å¯åŠ¨ä¸€ä¸ªå®¹å™¨</h3><ul class="lvl-0"><li class="lvl-2"><p>å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œå®¹å™¨å¿…é¡»å·²ç»åˆ›å»ºï¼Œå¹¶ä¸”å¤„äºåœæ­¢çŠ¶æ€ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¯­æ³•ï¼šdocker start &lt;container_id|container_name&gt;</span></span><br><span class="line">$ docker start my-container</span><br></pre></td></tr></table></figure><h3 id="docker-run-åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªå®¹å™¨"><code>docker run</code> : åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªå®¹å™¨</h3><ul class="lvl-0"><li class="lvl-2"><p>ç›¸å½“äº<code>docker create</code> + <code>docker start</code></p></li><li class="lvl-2"><p>å¸¸ç”¨å‚æ•°è¯´æ˜</p></li></ul><table><thead><tr><th>å‚æ•°</th><th>è¯´æ˜</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td><code>-d</code>, <code>--detach</code></td><td>åå°è¿è¡Œå®¹å™¨ï¼ˆå³â€œå®ˆæŠ¤æ€â€ï¼‰ï¼Œ<code>run</code>ç‹¬æœ‰</td><td><code>docker run -d nginx</code></td></tr><tr><td><code>-it</code></td><td>äº¤äº’å¼è¿è¡Œå®¹å™¨å¹¶åˆ†é…ç»ˆç«¯ï¼ˆå¸¸ç”¨äºè°ƒè¯•ï¼‰</td><td><code>docker run -it ubuntu bash</code></td></tr><tr><td><code>--name</code></td><td>æŒ‡å®šå®¹å™¨åç§°</td><td><code>docker run --name my-nginx nginx</code></td></tr><tr><td><code>--rm</code></td><td>å®¹å™¨é€€å‡ºæ—¶è‡ªåŠ¨åˆ é™¤</td><td><code>docker run --rm ubuntu</code></td></tr><tr><td><code>-p</code>, <code>--publish</code></td><td>ç«¯å£æ˜ å°„ï¼ˆå®¿ä¸»æœº:å®¹å™¨ï¼‰</td><td><code>docker run -p 8080:80 nginx</code></td></tr><tr><td><code>-P</code>, <code>--publish-all</code></td><td>è‡ªåŠ¨éšæœºæ˜ å°„å®¹å™¨å†…éƒ¨æ‰€æœ‰æš´éœ²ç«¯å£åˆ°å®¿ä¸»æœºç«¯å£</td><td><code>docker run -P nginx</code></td></tr><tr><td><code>-v</code>, <code>--volume</code></td><td>æŒ‚è½½å·ï¼ˆå®¿ä¸»æœºç›®å½•:å®¹å™¨ç›®å½•ï¼‰</td><td><code>docker run -v /data:/app/data myapp</code></td></tr><tr><td><code>--mount</code></td><td>æ›´çµæ´»çš„æŒ‚è½½æ–¹å¼ï¼ˆæ¨èæ–°é¡¹ç›®ä½¿ç”¨ï¼‰</td><td><code>docker run --mount type=bind,source=/host,target=/container nginx</code></td></tr><tr><td><code>--env</code>, <code>-e</code></td><td>è®¾ç½®ç¯å¢ƒå˜é‡</td><td><code>docker run -e ENV=prod myapp</code></td></tr><tr><td><code>--env-file</code></td><td>ä»æ–‡ä»¶ä¸­åŠ è½½å¤šä¸ªç¯å¢ƒå˜é‡</td><td><code>docker run --env-file .env myapp</code></td></tr><tr><td><code>--network</code></td><td>è®¾ç½®å®¹å™¨ä½¿ç”¨çš„ç½‘ç»œæ¨¡å¼</td><td><code>docker run --network host myapp</code></td></tr><tr><td><code>--restart</code></td><td>è®¾ç½®å®¹å™¨çš„è‡ªåŠ¨é‡å¯ç­–ç•¥</td><td><code>docker run --restart=always myapp</code></td></tr><tr><td><code>--privileged</code></td><td>ç»™äºˆå®¹å™¨æ›´å¤šçš„æƒé™ï¼ˆå¦‚è®¿é—® host è®¾å¤‡ï¼‰</td><td><code>docker run --privileged myapp</code></td></tr><tr><td><code>--entrypoint</code></td><td>è¦†ç›–é•œåƒé»˜è®¤çš„ ENTRYPOINT</td><td><code>docker run --entrypoint /bin/bash myapp</code></td></tr><tr><td><code>-u</code>, <code>--user</code></td><td>æŒ‡å®šå®¹å™¨å†…è¿è¡Œçš„ç”¨æˆ·ï¼ˆæ ¼å¼ï¼šUID æˆ– UID:GIDï¼‰</td><td><code>docker run --user 1000:1000 myapp</code></td></tr><tr><td><code>-c</code>, <code>--cpu-shares</code></td><td>è®¾ç½® CPU æƒé‡ï¼ˆç›¸å¯¹å€¼ï¼‰</td><td><code>docker run --cpu-shares=512 myapp</code></td></tr><tr><td><code>-m</code>, <code>--memory</code></td><td>é™åˆ¶å®¹å™¨æœ€å¤§å†…å­˜ï¼ˆå¦‚ <code>512m</code>, <code>1g</code>ï¼‰</td><td><code>docker run --memory=512m myapp</code></td></tr><tr><td><code>-h</code>,<code> --hostname</code></td><td>è®¾ç½®å®¹å™¨ä¸»æœºå</td><td><code>docker run -h myhost myapp</code></td></tr><tr><td><code>--link</code>(æ›´æ¨èä½¿ç”¨ <code>--network</code>)</td><td>åˆ›å»ºé“¾æ¥åˆ°å…¶ä»–å®¹å™¨</td><td><code>docker run --link myapp:app myapp2</code></td></tr><tr><td><code>--cpus</code></td><td>é™åˆ¶å®¹å™¨ä½¿ç”¨çš„CPUæ ¸æ•°</td><td><code>docker run --cpus=&quot;1.5&quot;</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p><code>-p</code>, <code>--publish</code> ç«¯å£æ˜ å°„</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p [ä¸»æœºIP:]ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£[/åè®®]</span><br></pre></td></tr></table></figure><table><thead><tr><th>ç¤ºä¾‹</th><th>å«ä¹‰è¯´æ˜</th></tr></thead><tbody><tr><td><code>-p 8080:80</code></td><td>å°†ä¸»æœºçš„ 8080 ç«¯å£æ˜ å°„åˆ°å®¹å™¨çš„ 80 ç«¯å£ï¼ˆé»˜è®¤ TCPï¼‰</td></tr><tr><td><code>-p 127.0.0.1:8080:80</code></td><td>ä»…å°†ä¸»æœºæœ¬åœ° IPï¼ˆ127.0.0.1ï¼‰çš„ 8080 æ˜ å°„åˆ°å®¹å™¨çš„ 80 ç«¯å£ï¼ˆå¤–éƒ¨æ— æ³•è®¿é—®ï¼‰</td></tr><tr><td><code>-p 8080:80/tcp</code></td><td>æ˜¾å¼æŒ‡å®šåè®®ä¸º TCPï¼ˆç­‰åŒäºä¸åŠ  <code>/tcp</code>ï¼‰</td></tr><tr><td><code>-p 8080:80/udp</code></td><td>æ˜ å°„ UDP åè®®ç«¯å£ï¼ˆå¦‚ DNS æœåŠ¡ç­‰ï¼‰</td></tr><tr><td><code>-p 8080</code></td><td>å®¿ä¸»æœºéšæœºç«¯å£æ˜ å°„åˆ°å®¹å™¨çš„8080ç«¯å£</td></tr><tr><td><code>-p 3000-3006:4000-4006</code></td><td><strong>èŒƒå›´æ˜ å°„</strong>ï¼Œä¸èƒ½æ˜ å°„éå¯¹ç§°èŒƒå›´ï¼ˆå¦‚ 3000-3006:4000-4006ï¼‰ï¼Œåªèƒ½ä¸€ä¸€å¯¹åº”</td></tr><tr><td>å¤šä¸ª <code>-p</code></td><td>å¯ä»¥å¤šæ¬¡ä½¿ç”¨ <code>-p</code>ï¼Œæ˜ å°„å¤šä¸ªç«¯å£ã€‚ä¾‹å¦‚ï¼š<code>-p 80:80 -p 443:443</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p><code>-v, --volume</code> æ•°æ®å·æ˜ å°„</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">docker run -v &lt;æœ¬åœ°è·¯å¾„&gt;:&lt;å®¹å™¨è·¯å¾„&gt;[:æƒé™]</span><br><span class="line">  <span class="comment"># &lt;æœ¬åœ°è·¯å¾„&gt;ä¸»æœºä¸Šçš„è·¯å¾„ï¼ˆç»å¯¹è·¯å¾„ï¼Œæˆ–å‘½åå·ï¼‰ï¼Œç›®å½•ä¸å­˜åœ¨ä¼šè‡ªåŠ¨åˆ›å»º</span></span><br><span class="line">  <span class="comment"># &lt;å®¹å™¨è·¯å¾„&gt;å®¹å™¨å†…çš„è·¯å¾„ï¼Œç›®å½•ä¸å­˜åœ¨ä¼šè‡ªåŠ¨åˆ›å»º</span></span><br><span class="line">  <span class="comment"># [:æƒé™]å¯é€‰ï¼šroï¼ˆåªè¯»ï¼‰ æˆ– rwï¼ˆè¯»å†™ï¼Œé»˜è®¤ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹</span></span><br><span class="line"><span class="comment"># æŒ‚è½½æœ¬åœ°ç›®å½•åˆ°å®¹å™¨</span></span><br><span class="line">docker run -v /data:/app/data myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‚è½½ä¸ºåªè¯»</span></span><br><span class="line">docker run -v /data:/app/data:ro myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‚è½½å¤šä¸ªæ•°æ®å·</span></span><br><span class="line">docker run -v /data1:/app/data1 -v /data2:/app/data2 myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨å‘½åå·</span></span><br><span class="line">docker volume create mydata</span><br><span class="line">docker run -v mydata:/app/data myapp</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>--mount</code> æŒ‚è½½å·</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --mount æ˜¯ Docker æ¨èä½¿ç”¨çš„ ç°ä»£æŒ‚è½½æ–¹å¼ï¼ŒåŠŸèƒ½å’Œ -vï¼ˆæˆ– --volumeï¼‰ç±»ä¼¼ï¼Œä½†è¯­æ³•æ›´æ¸…æ™°ã€ç»“æ„æ›´è§„èŒƒï¼Œé€‚ç”¨äºå·ï¼ˆvolumeï¼‰ã€ç»‘å®šæŒ‚è½½ï¼ˆbindï¼‰å’Œä¸´æ—¶æŒ‚è½½ï¼ˆtmpfsï¼‰ã€‚</span></span><br><span class="line">docker run --mount <span class="built_in">type</span>=&lt;ç±»å‹&gt;,<span class="built_in">source</span>=&lt;ä¸»æœºè·¯å¾„æˆ–å·å&gt;,target=&lt;å®¹å™¨è·¯å¾„&gt;[,<span class="built_in">readonly</span>]</span><br></pre></td></tr></table></figure><blockquote><p>ä¸‰ç§æŒ‚è½½ç±»å‹å¯¹æ¯”</p></blockquote><table><thead><tr><th>ç±»å‹ (<code>type</code>)</th><th>ç”¨é€”</th><th>ç¤ºä¾‹ <code>source</code></th></tr></thead><tbody><tr><td><code>volume</code></td><td>ä½¿ç”¨ Docker ç®¡ç†çš„å·</td><td>å·åï¼Œå¦‚ <code>mydata</code></td></tr><tr><td><code>bind</code></td><td>æŒ‚è½½å®¿ä¸»æœºçš„å®é™…è·¯å¾„</td><td>ç»å¯¹è·¯å¾„ï¼Œå¦‚ <code>/home/user/app/config</code></td></tr><tr><td><code>tmpfs</code></td><td>æŒ‚è½½å†…å­˜ä¸­çš„ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ</td><td>æ— éœ€æŒ‡å®š <code>source</code></td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨å‘½åå·æŒ‚è½½ï¼ˆæ¨èæ–¹å¼ï¼‰,è¿™é‡Œ --target æŒ‡å®šå®¹å™¨å†…çš„æŒ‚è½½ç‚¹ï¼Œä¹Ÿå¯ä»¥æ›¿æ¢ä¸º --destination</span></span><br><span class="line">docker run --mount <span class="built_in">type</span>=volume,<span class="built_in">source</span>=mydata,target=/app/data myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨æœ¬åœ°è·¯å¾„æŒ‚è½½ï¼ˆç»‘å®šæŒ‚è½½ï¼‰,sourceæŒ‡å®šçš„æœ¬åœ°è·¯å¾„å¿…é¡»å­˜åœ¨</span></span><br><span class="line">docker run --mount <span class="built_in">type</span>=<span class="built_in">bind</span>,<span class="built_in">source</span>=/home/user/app/config,target=/app/config myapp</span><br><span class="line"><span class="comment"># åªè¯»æŒ‚è½½ï¼Œreadonly å¯ä»¥ç®€å†™ä¸º ro</span></span><br><span class="line">docker run --mount <span class="built_in">type</span>=<span class="built_in">bind</span>,<span class="built_in">source</span>=/home/user/app/config,target=/app/config,<span class="built_in">readonly</span> myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨å†…å­˜ä¸­çš„ä¸´æ—¶æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ï¼Œæ•°æ®ä¸ä¼šæŒä¹…åŒ–ï¼Œåªå­˜å‚¨åœ¨å®¹å™¨è¿è¡Œæ—¶çš„å†…å­˜ä¸­</span></span><br><span class="line">docker run --mount <span class="built_in">type</span>=tmpfs,target=/app/tmpfs myapp</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>--link</code> å®¹å™¨é—´é“¾æ¥</p></li></ul><blockquote><p>ç”¨äºåœ¨å®¹å™¨ä¹‹é—´å»ºç«‹è¿æ¥ï¼Œä½¿ä¸€ä¸ªå®¹å™¨å¯ä»¥é€šè¿‡å¦ä¸€ä¸ªå®¹å™¨çš„åç§°è®¿é—®å…¶ç½‘ç»œä¿¡æ¯ï¼ˆå¦‚ IPã€ç¯å¢ƒå˜é‡ç­‰ï¼‰ã€‚<br>æ³¨æ„ï¼š<code>--link</code> å·²è¢«å¼ƒç”¨ï¼Œå»ºè®®ä½¿ç”¨ <code>--network</code> æ¥å®ç°å®¹å™¨é—´é“¾æ¥ã€‚</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">docker run --<span class="built_in">link</span> &lt;ç›®æ ‡å®¹å™¨å&gt;:&lt;åˆ«å&gt; &lt;å…¶ä»–å‚æ•°&gt; &lt;é•œåƒå&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">## ç¤ºä¾‹</span></span><br><span class="line"><span class="comment"># åœºæ™¯ï¼šä¸€ä¸ª web å®¹å™¨æƒ³è¦è¿æ¥å¦ä¸€ä¸ªè¿è¡Œä¸­çš„ db å®¹å™¨</span></span><br><span class="line"><span class="comment"># å…ˆå¯åŠ¨æ•°æ®åº“å®¹å™¨</span></span><br><span class="line">docker run -d --name db mysql</span><br><span class="line"><span class="comment"># å¯åŠ¨ web å®¹å™¨å¹¶è¿æ¥åˆ° db å®¹å™¨</span></span><br><span class="line">docker run -it --<span class="built_in">rm</span> --name web --<span class="built_in">link</span> db:mydb ubuntu bash</span><br><span class="line"><span class="comment"># åœ¨ web å®¹å™¨ä¸­ï¼Œç°åœ¨ä½ å¯ä»¥ç”¨ mydb æ¥è®¿é—® db å®¹å™¨ï¼Œä½†åè¿‡æ¥ db å®¹å™¨æ— æ³•è®¿é—® web å®¹å™¨</span></span><br><span class="line">docker <span class="built_in">exec</span> web ping mydb</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ”¹ç”¨ --network å®ç°</span></span><br><span class="line">docker network create mynet</span><br><span class="line">docker run -d --name db --network mynet mysql</span><br><span class="line">docker run -it --<span class="built_in">rm</span> --name web --network mynet ubuntu bash</span><br><span class="line">docker <span class="built_in">exec</span> web ping db</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>--network</code> ç½‘ç»œæ¨¡å¼ç±»å‹</p></li></ul><table><thead><tr><th>ç±»å‹</th><th>å«ä¹‰</th><th>ç‰¹ç‚¹/é€‚ç”¨åœºæ™¯</th><th>æ˜¯å¦å…è®¸ç«¯å£æ˜ å°„</th></tr></thead><tbody><tr><td><code>bridge</code></td><td>é»˜è®¤ç½‘ç»œç±»å‹ï¼ˆç”¨æˆ·è‡ªå®šä¹‰æˆ– Docker é»˜è®¤æ¡¥æ¥ç½‘ç»œï¼‰</td><td>å®¹å™¨é€šè¿‡è™šæ‹Ÿç½‘æ¡¥è¿æ¥ï¼Œå¯ç›¸äº’é€šä¿¡ï¼›é€‚ç”¨äºå•ä¸»æœºéƒ¨ç½²</td><td>âœ… æ˜¯</td></tr><tr><td><code>host</code></td><td>å®¹å™¨ä¸å®¿ä¸»æœºå…±äº«ç½‘ç»œæ ˆ</td><td>æ²¡æœ‰ç½‘ç»œéš”ç¦»ï¼Œå®¹å™¨ä½¿ç”¨å®¿ä¸»æœºçš„ IP å’Œç«¯å£ï¼Œæ€§èƒ½é«˜ï¼Œé€‚åˆå¯¹ç½‘ç»œè¦æ±‚é«˜çš„æœåŠ¡</td><td>âŒ å¦</td></tr><tr><td><code>none</code></td><td>å®¹å™¨æ²¡æœ‰ç½‘ç»œæ¥å£</td><td>å®Œå…¨éš”ç¦»ï¼›é€‚ç”¨äºéœ€è¦å®Œå…¨æ§åˆ¶ç½‘ç»œçš„åœºæ™¯æˆ–æµ‹è¯•ç½‘ç»œä¸å¯è¾¾æ€§</td><td>âŒ å¦</td></tr><tr><td><code>&lt;user-defined&gt;</code></td><td>ç”¨æˆ·è‡ªå®šä¹‰çš„ç½‘ç»œåç§°ï¼Œé€šè¿‡ <code>docker network create</code> åˆ›å»º</td><td>æ”¯æŒå®¹å™¨åç§°äº’è§£æï¼ˆDNSï¼‰ï¼Œé€‚åˆå¤šå®¹å™¨é€šä¿¡åœºæ™¯ï¼Œå¦‚ Docker Compose</td><td>âœ… æ˜¯</td></tr><tr><td><code>container:&lt;name|id&gt;</code></td><td>ä¸å¦ä¸€ä¸ªå®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´</td><td>ä¸¤ä¸ªå®¹å™¨å…±äº« IP å’Œç«¯å£ï¼Œé€‚ç”¨äºä¸»-è¾…å®¹å™¨æ¨¡å¼ï¼Œå¦‚ sidecar å®¹å™¨å…±äº«ä¸»å®¹å™¨ç½‘ç»œ</td><td>âŒ å¦</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨é»˜è®¤ bridge ç½‘ç»œ</span></span><br><span class="line">docker run -p 8080:80 --network bridge --name my-nginx nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸å®¿ä¸»æœºå…±äº«ç½‘ç»œï¼Œä¸èƒ½ä½¿ç”¨-p</span></span><br><span class="line">docker run --network host nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸ä½¿ç”¨ä»»ä½•ç½‘ç»œï¼Œä¸èƒ½ä½¿ç”¨-p</span></span><br><span class="line">docker run --network none nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨å·²åˆ›å»ºçš„è‡ªå®šä¹‰ç½‘ç»œï¼Œç›¸åŒç½‘ç»œå‘½åç©ºé—´ä¸‹çš„å®¹å™¨ï¼Œå¯ä»¥é€šè¿‡å®¹å™¨ åç§°æˆ–ID äº’ç›¸è®¿é—®</span></span><br><span class="line">docker network create nginx_net</span><br><span class="line">docker run -p 8080:80 --network nginx_net nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸å¦ä¸€ä¸ªå®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´ï¼Œä¸èƒ½ä½¿ç”¨-pï¼Œå¹¶ä¸”æ­¤æ—¶æ–°å¯åŠ¨çš„å®¹å™¨å ç”¨çš„ç«¯å£ä¸èƒ½ä¸è¦è¿æ¥çš„å®¹å™¨ç«¯å£ä¸€è‡´ï¼Œå¦åˆ™å°†å¯åŠ¨å¤±è´¥</span></span><br><span class="line">docker run --network container:my-nginx busybox</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>--restart</code> é‡å¯ç­–ç•¥</p></li></ul><table><thead><tr><th>ç­–ç•¥</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td><code>no</code>ï¼ˆé»˜è®¤ï¼‰</td><td>å®¹å™¨é€€å‡ºåä¸ä¼šè‡ªåŠ¨é‡å¯</td></tr><tr><td><code>always</code></td><td>æ— è®ºé€€å‡ºçŠ¶æ€ç å¦‚ä½•ï¼Œå®¹å™¨æ€»æ˜¯è‡ªåŠ¨é‡å¯</td></tr><tr><td><code>unless-stopped</code></td><td>å®¹å™¨æ€»æ˜¯è‡ªåŠ¨é‡å¯ï¼Œé™¤éç”¨æˆ·æ‰‹åŠ¨åœæ­¢å®ƒ</td></tr><tr><td><code>on-failure[:N]</code></td><td>ä»…åœ¨å®¹å™¨é 0 çŠ¶æ€ç é€€å‡ºæ—¶è‡ªåŠ¨é‡å¯ï¼ˆå¯é€‰è®¾ç½®æœ€å¤§é‡å¯æ¬¡æ•° Nï¼‰</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®¹å™¨éæ­£å¸¸é€€å‡ºæ—¶è‡ªåŠ¨é‡å¯</span></span><br><span class="line">docker run --restart on-failure my-app</span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ€å¤šé‡å¯ 5 æ¬¡</span></span><br><span class="line">docker run --restart on-failure:5 my-app</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ€»æ˜¯é‡å¯ï¼ˆå³ä½¿ä½ é‡å¯ Docker æœåŠ¡åï¼‰</span></span><br><span class="line">docker run --restart always my-app</span><br><span class="line"></span><br><span class="line"><span class="comment"># é™¤éæ‰‹åŠ¨åœæ­¢ï¼Œå¦åˆ™ä¸€ç›´é‡å¯</span></span><br><span class="line">docker run --restart unless-stopped my-app</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>--cpu-shares</code> : è®¾ç½®å®¹å™¨çš„ CPU ç›¸å¯¹æƒé‡ï¼Œå³åœ¨ CPU èµ„æºç«äº‰æ—¶çš„ç›¸å¯¹ä¼˜å…ˆçº§ï¼Œé»˜è®¤å€¼ä¸º 1024ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®¹å™¨1ï¼Œæƒé‡ 1024ï¼ˆé»˜è®¤ï¼‰</span></span><br><span class="line">docker run -d --name c1 --cpu-shares 1024 nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®¹å™¨2ï¼Œæƒé‡ 512ï¼ˆä¼˜å…ˆçº§ä½ï¼‰</span></span><br><span class="line">docker run -d --name c2 --cpu-shares 512 nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">## è¯´æ˜ï¼š</span></span><br><span class="line">  <span class="comment"># c1çš„æƒé‡1024ï¼Œc2çš„æƒé‡512,ä¸æ˜¯ç»å¯¹é™åˆ¶ï¼Œè€Œæ˜¯åˆ†é…æ¯”ä¾‹</span></span><br><span class="line">  <span class="comment"># è¯¥æƒé‡è¡¨ç¤ºå®¹å™¨åœ¨ CPU ç«äº‰ä¸‹ï¼Œæƒé‡è¶Šé«˜åˆ™ä¼˜å…ˆçº§è¶Šé«˜ï¼Œä¼šå°½å¯èƒ½ä½¿ç”¨ CPU èµ„æºã€‚</span></span><br><span class="line">  <span class="comment"># å¦‚æœè¿™ä¸¤ä¸ªå®¹å™¨éƒ½è¿è¡Œåœ¨ CPU å¿™ç¢Œçš„ç¯å¢ƒä¸‹(åªæœ‰åœ¨ å¤šå®¹å™¨å…±äº« CPU ä¸”ç«äº‰èµ„æº çš„æƒ…å†µä¸‹æ‰ç”Ÿæ•ˆ)ï¼š</span></span><br><span class="line">    <span class="comment"># c1 å°†è·å¾—å¤§çº¦ 2/3 çš„ CPU æ—¶é—´</span></span><br><span class="line">    <span class="comment"># c2 å°†è·å¾—å¤§çº¦ 1/3 çš„ CPU æ—¶é—´</span></span><br><span class="line">  <span class="comment"># å¦‚æœç³»ç»Ÿ CPU ç©ºé—²ï¼Œæ‰€æœ‰å®¹å™¨éƒ½å¯ä»¥ä½¿ç”¨ 100% çš„ CPUã€‚</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>docker run</code> ç¤ºä¾‹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯åŠ¨ä¸€ä¸ªnginx å®¹å™¨</span></span><br><span class="line">docker run -d -p 80:80 --name nginx nginx</span><br><span class="line"><span class="comment"># æ›¿æ¢nginxé•œåƒé»˜è®¤çš„å¯åŠ¨å‘½ä»¤ï¼Œnginx é•œåƒé»˜è®¤å¯åŠ¨ nginx æœåŠ¡ï¼Œæ­¤å‘½ä»¤ä¼šæ”¹ä¸ºæ‰§è¡Œ nginx -v æ˜¾ç¤ºç‰ˆæœ¬å·</span></span><br><span class="line">docker run --name test_nginx --entrypoint <span class="string">&quot;&quot;</span> nginx nginx -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œè„šæœ¬æˆ–å‘½ä»¤ï¼Œè¿™é‡Œæ·»åŠ  --rm å‚æ•°ï¼Œè¡¨ç¤ºè¿è¡Œç»“æŸåè‡ªåŠ¨åˆ é™¤å®¹å™¨ï¼Œè¿™é‡Œæ˜¯å®‰è£… ping å‘½ä»¤</span></span><br><span class="line">docker run --<span class="built_in">rm</span> ubuntu bash -c <span class="string">&quot;apt update &amp;&amp; apt install -y iputils-ping&quot;</span></span><br><span class="line"><span class="comment"># äº¤äº’å¼æ‰§è¡Œ shell å‘½ä»¤ï¼Œæ‰§è¡Œå‘½ä»¤åä¼šè¿›å…¥å®¹å™¨çš„shell</span></span><br><span class="line">docker run --<span class="built_in">rm</span> -it ubuntu /bin/bash</span><br><span class="line"><span class="comment"># è¿™æ ·ä¹Ÿå¯ä»¥ï¼Œå› ä¸º ubuntu çš„é»˜è®¤å¯åŠ¨å‘½ä»¤æ˜¯ /bin/bash</span></span><br><span class="line">docker run --<span class="built_in">rm</span> -it ubuntu</span><br><span class="line"><span class="comment"># è½¬åˆ°åå°è¿è¡Œ</span></span><br><span class="line">docker run --<span class="built_in">rm</span> -itd ubuntu</span><br></pre></td></tr></table></figure><h3 id="docker-stop-åœæ­¢å®¹å™¨ï¼Œå®¹å™¨ä¼˜é›…é€€å‡º"><code>docker stop</code> : åœæ­¢å®¹å™¨ï¼Œå®¹å™¨ä¼˜é›…é€€å‡º</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœæ­¢å®¹å™¨ï¼Œé€šè¿‡å®¹å™¨åç§°</span></span><br><span class="line">docker stop test_nginx</span><br><span class="line"><span class="comment"># åœæ­¢å®¹å™¨ï¼Œé€šè¿‡å®¹å™¨ID</span></span><br><span class="line">docker stop 5d7c0c5d5c0c</span><br><span class="line"><span class="comment"># åœæ­¢æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨</span></span><br><span class="line">docker stop $(docker ps -q)</span><br><span class="line"><span class="comment"># ç­‰å¾…5ç§’åå¼ºåˆ¶å…³é—­</span></span><br><span class="line">docker stop -t 5 test_nginx</span><br></pre></td></tr></table></figure><h3 id="docker-kill-å¼ºåˆ¶åœæ­¢å®¹å™¨"><code>docker kill</code> : å¼ºåˆ¶åœæ­¢å®¹å™¨</h3><ul class="lvl-0"><li class="lvl-2"><p>å½“å®¹å™¨å®Œå…¨å¡æ­»ã€æŒ‚èµ·ã€ä¸å“åº” <code>stop</code> å‘½ä»¤æ—¶ä½¿ç”¨</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">kill</span> test_nginx</span><br><span class="line">docker <span class="built_in">kill</span> 5d7c0c5d5c0c</span><br><span class="line">docker <span class="built_in">kill</span> $(docker ps -q)</span><br></pre></td></tr></table></figure><h3 id="docker-restart-é‡å¯å®¹å™¨"><code>docker restart</code> : é‡å¯å®¹å™¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker restart test_nginx</span><br><span class="line">docker restart 5d7c0c5d5c0c</span><br><span class="line">docker restart $(docker ps -q)</span><br></pre></td></tr></table></figure><h3 id="docker-pause-æš‚åœå®¹å™¨"><code>docker pause</code> : æš‚åœå®¹å™¨</h3><ul class="lvl-0"><li class="lvl-2"><p>æš‚åœåå®¿ä¸»æœºå°†ä¸å†ä¸ºå®¹å™¨åˆ†é…CPUæ—¶é—´ç‰‡ï¼Œä½†å†…å­˜ä¾ç„¶æœ‰æ•ˆï¼Œä½ å¯ä»¥ç†è§£ä¸ºæ­¤æ—¶ä¸ºå®¹å™¨ä¿å­˜äº†å¿«ç…§</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pause test_nginx</span><br><span class="line">docker pause 5d7c0c5d5c0c</span><br><span class="line">docker pause $(docker ps -q)</span><br></pre></td></tr></table></figure><h3 id="docker-unpause-æ¢å¤å®¹å™¨"><code>docker unpause</code> : æ¢å¤å®¹å™¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker unpause test_nginx</span><br><span class="line">docker unpause 5d7c0c5d5c0c</span><br><span class="line">docker unpause $(docker ps -q)</span><br></pre></td></tr></table></figure><h3 id="docker-ps-æŸ¥çœ‹å®¹å™¨åˆ—è¡¨"><code>docker ps</code> : æŸ¥çœ‹å®¹å™¨åˆ—è¡¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ˜¾ç¤ºæ‰€æœ‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨</span></span><br><span class="line">docker ps</span><br><span class="line"><span class="comment"># æ˜¾ç¤ºæ‰€æœ‰å®¹å™¨</span></span><br><span class="line">docker ps -a</span><br><span class="line"><span class="comment"># æ˜¾ç¤ºæ‰€æœ‰æ­£åœ¨è¿è¡Œçš„å®¹å™¨çš„ID</span></span><br><span class="line">docker ps -q</span><br><span class="line"><span class="comment"># ä¸æˆªæ–­è¾“å‡ºï¼Œæ­¤æ—¶ COMMAND åˆ—ä¼šæ˜¾ç¤ºå®Œæ•´çš„å‘½ä»¤</span></span><br><span class="line">docker ps -notrunc</span><br><span class="line"><span class="comment"># æ˜¾ç¤ºæœ€è¿‘åˆ›å»ºçš„5æ¡å®¹å™¨</span></span><br><span class="line">docker ps -n 5</span><br><span class="line"><span class="comment"># è¿‡æ»¤å™¨ï¼Œæ˜¾ç¤ºçŠ¶æ€ä¸ºexitedçš„å®¹å™¨</span></span><br><span class="line">docker ps -a --filter <span class="string">&quot;status=exited&quot;</span></span><br><span class="line"><span class="comment"># æŒ‡å®šæ¨¡æ¿ï¼Œåªæ˜¾ç¤º ID å’Œ Names</span></span><br><span class="line">docker ps --format <span class="string">&quot;&#123;&#123;.ID&#125;&#125;: &#123;&#123;.Names&#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure><h3 id="docker-inspect-æŸ¥çœ‹å®¹å™¨ä¿¡æ¯"><code>docker inspect</code> : æŸ¥çœ‹å®¹å™¨ä¿¡æ¯</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å®¹å™¨ä¿¡æ¯</span></span><br><span class="line">docker inspect &lt;container_id&gt;</span><br><span class="line"><span class="comment"># è·å–å®¹å™¨åç§°</span></span><br><span class="line">docker inspect --format=<span class="string">&#x27;&#123;&#123;.Name&#125;&#125;&#x27;</span> &lt;container_id | container_name&gt;</span><br><span class="line"><span class="comment"># è·å–å®¹å™¨é•œåƒ</span></span><br><span class="line">docker inspect --format=<span class="string">&#x27;&#123;&#123;.Config.Image&#125;&#125;&#x27;</span> &lt;container_id | container_name&gt;</span><br><span class="line"><span class="comment"># è·å–å®¹å™¨ç¯å¢ƒå˜é‡</span></span><br><span class="line">docker inspect --format=<span class="string">&#x27;&#123;&#123;.Config.Env&#125;&#125;&#x27;</span> &lt;container_id | container_name&gt;</span><br><span class="line"><span class="comment"># è·å–å®¹å™¨çŠ¶æ€ï¼Œå‰é¢çš„ json è¡¨ç¤ºè¾“å‡ºä¸º json æ ¼å¼</span></span><br><span class="line">docker inspect --format=<span class="string">&#x27;&#123;&#123;json .State&#125;&#125;&#x27;</span> &lt;container_id | container_name&gt;</span><br><span class="line"><span class="comment"># è·å–å®¹å™¨å†…å­˜é™åˆ¶</span></span><br><span class="line">docker inspect --format=<span class="string">&#x27;&#123;&#123;.HostConfig.Memory&#125;&#125;&#x27;</span> &lt;container_id | container_name&gt;</span><br><span class="line"><span class="comment"># è·å–å®¹å™¨label</span></span><br><span class="line">docker inspect --format=<span class="string">&#x27;&#123;&#123;json .Config.Labels&#125;&#125;&#x27;</span> &lt;container_id | container_name&gt;</span><br><span class="line"><span class="comment"># è·å–å®¹å™¨çš„ç½‘ç»œä¿¡æ¯</span></span><br><span class="line">docker inspect --format=<span class="string">&#x27;&#123;&#123;json .NetworkSettings&#125;&#125;&#x27;</span> &lt;container_id | container_name&gt;</span><br></pre></td></tr></table></figure><h3 id="docker-logs-è·å–å®¹å™¨æ—¥å¿—"><code>docker logs</code> : è·å–å®¹å™¨æ—¥å¿—</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å–å®¹å™¨æ—¥å¿—</span></span><br><span class="line">docker logs &lt;container_id | container_name&gt;</span><br><span class="line"><span class="comment"># è·å–å®¹å™¨å®æ—¶æ—¥å¿—</span></span><br><span class="line">docker logs -f &lt;container_id | container_name&gt;</span><br><span class="line"><span class="comment"># è·å–å®¹å™¨æœ€æ–°çš„ 10 è¡Œæ—¥å¿—</span></span><br><span class="line">docker logs -n 10 &lt;container_id | container_name&gt;</span><br><span class="line"><span class="comment"># è·å–å®¹å™¨çš„å¸¦æ—¶é—´æˆ³çš„æ—¥å¿—</span></span><br><span class="line">docker logs -t &lt;container_id | container_name&gt;</span><br><span class="line"><span class="comment"># è·å–å®¹å™¨çš„æ—¥å¿—ï¼Œä» 1 å°æ—¶å‰å¼€å§‹</span></span><br><span class="line">docker logs --since 1h &lt;container_id | container_name&gt;</span><br><span class="line"><span class="comment"># è·å–å®¹å™¨çš„æ—¥å¿—ï¼Œç›´åˆ° 1 å°æ—¶å‰</span></span><br><span class="line">docker logs --<span class="keyword">until</span> 1h &lt;container_id | container_name&gt;</span><br><span class="line"><span class="comment"># è·å–å®¹å™¨çš„è¯¦ç»†æ—¥å¿—</span></span><br><span class="line">docker logs --details &lt;container_id | container_name&gt;</span><br><span class="line"><span class="comment"># è·å–å®¹å™¨çš„æ—¥å¿—ï¼Œä» 2 å°æ—¶å‰å¼€å§‹ï¼Œç›´åˆ° 1 å°æ—¶å‰</span></span><br><span class="line">docker logs --since 2h --<span class="keyword">until</span> 1h &lt;container_id | container_name&gt;</span><br></pre></td></tr></table></figure><h3 id="docker-exec-åœ¨å·²ç»è¿è¡Œçš„å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤"><code>docker exec</code> : åœ¨å·²ç»è¿è¡Œçš„å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨å·²ç»è¿è¡Œçš„å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">docker <span class="built_in">exec</span> &lt;container_id | container_name&gt; &lt;<span class="built_in">command</span>&gt;</span><br><span class="line"><span class="comment"># è¿›å…¥å®¹å™¨shell</span></span><br><span class="line">docker <span class="built_in">exec</span> -it &lt;container_id | container_name&gt; bash</span><br></pre></td></tr></table></figure><h3 id="docker-rename-é‡å‘½åå®¹å™¨"><code>docker rename</code> : é‡å‘½åå®¹å™¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rename &lt;old_container_name&gt; &lt;new_container_name&gt;</span><br></pre></td></tr></table></figure><h3 id="docker-cp-å®¹å™¨ä¸å®¿ä¸»æœºé—´å¤åˆ¶æ–‡ä»¶"><code>docker cp</code> : å®¹å™¨ä¸å®¿ä¸»æœºé—´å¤åˆ¶æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®¿ä¸»æœº -&gt; å®¹å™¨</span></span><br><span class="line"><span class="comment"># docker cp &lt;host_path&gt; &lt;container_id | container_name&gt;:&lt;container_path&gt;</span></span><br><span class="line">docker <span class="built_in">cp</span> ./docker-command-container.md nginx:/tmp</span><br><span class="line"><span class="comment"># å®¹å™¨ -&gt; å®¿ä¸»æœº</span></span><br><span class="line"><span class="comment"># docker cp &lt;container_id | container_name&gt;:&lt;container_path&gt; &lt;host_path&gt;</span></span><br><span class="line">docker <span class="built_in">cp</span> nginx:/tmp/docker-command-container.md ./</span><br></pre></td></tr></table></figure><h3 id="docker-rm-åˆ é™¤å®¹å™¨"><code>docker rm</code> : åˆ é™¤å®¹å™¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ é™¤æŒ‡å®šå®¹å™¨</span></span><br><span class="line">docker <span class="built_in">rm</span> &lt;container_id | container_name&gt;</span><br><span class="line"><span class="comment"># åˆ é™¤æ‰€æœ‰å®¹å™¨</span></span><br><span class="line">docker <span class="built_in">rm</span> $(docker ps -aq)</span><br></pre></td></tr></table></figure><h3 id="docker-container-prune-åˆ é™¤æ‰€æœ‰åœæ­¢çš„å®¹å™¨"><code>docker container prune</code> : åˆ é™¤æ‰€æœ‰åœæ­¢çš„å®¹å™¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container prune</span><br></pre></td></tr></table></figure><h3 id="docker-update-æ›´æ–°å®¹å™¨é…ç½®"><code>docker update</code> : æ›´æ–°å®¹å™¨é…ç½®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ›´æ–°æŒ‡å®šå®¹å™¨çš„CPUæ ¸æ•°å’Œå†…å­˜å¤§å°</span></span><br><span class="line">docker update --cpus=2 --memory=2g &lt;container_id | container_name&gt;</span><br><span class="line"><span class="comment"># æ›´æ–°æŒ‡å®šå®¹å™¨è‡ªåŠ¨é‡å¯</span></span><br><span class="line">docker update --restart=always &lt;container_id | container_name&gt;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å¹¶ä¸æ˜¯æ‰€æœ‰çš„é…ç½®éƒ½æ”¯æŒæ›´æ–°ï¼Œupdate å‘½ä»¤åªæ”¯æŒå¦‚ä¸‹é…ç½®ï¼ŒåŸºæœ¬ä¸Šä¹Ÿå°±åªèƒ½è°ƒä¸€ä¸‹cpuå’Œå†…å­˜ï¼Œä»¥åŠè‡ªåŠ¨é‡å¯ç­–ç•¥ï¼Œæ‰€ä»¥åˆ¶ä½œå®¹å™¨æ—¶ä¸€å®šè¦åšå¥½è§„åˆ’ã€‚</p></li></ul><table><thead><tr><th>å‚æ•°å</th><th>è¯´æ˜</th><th>ç¤ºä¾‹å€¼</th></tr></thead><tbody><tr><td><code>--blkio-weight</code></td><td>è®¾ç½® Block IO çš„ç›¸å¯¹æƒé‡ï¼ŒèŒƒå›´æ˜¯ 10 åˆ° 1000ï¼Œè®¾ç½®ä¸º 0 è¡¨ç¤ºç¦ç”¨ï¼ˆé»˜è®¤å€¼ä¸º 0ï¼‰</td><td><code>--blkio-weight=500</code></td></tr><tr><td><code>--cpu-period</code></td><td>è®¾ç½® CPU CFSï¼ˆå®Œå…¨å…¬å¹³è°ƒåº¦å™¨ï¼‰çš„å‘¨æœŸé™åˆ¶ï¼ˆå•ä½ï¼šå¾®ç§’ï¼‰</td><td><code>--cpu-period=100000</code></td></tr><tr><td><code>--cpu-quota</code></td><td>è®¾ç½® CPU CFS çš„é…é¢é™åˆ¶ï¼ˆå•ä½ï¼šå¾®ç§’ï¼‰</td><td><code>--cpu-quota=50000</code></td></tr><tr><td><code>--cpu-rt-period</code></td><td>è®¾ç½®å®æ—¶ CPU çš„è°ƒåº¦å‘¨æœŸï¼ˆå•ä½ï¼šå¾®ç§’ï¼‰</td><td><code>--cpu-rt-period=1000000</code></td></tr><tr><td><code>--cpu-rt-runtime</code></td><td>è®¾ç½®å®æ—¶ CPU çš„è¿è¡Œæ—¶é—´é™åˆ¶ï¼ˆå•ä½ï¼šå¾®ç§’ï¼‰</td><td><code>--cpu-rt-runtime=950000</code></td></tr><tr><td><code>-c</code>, <code>--cpu-shares</code></td><td>è®¾ç½® CPU å…±äº«æƒé‡ï¼Œé»˜è®¤å€¼ä¸º 1024</td><td><code>--cpu-shares=512</code></td></tr><tr><td><code>--cpus</code></td><td>é™åˆ¶å®¹å™¨ä½¿ç”¨çš„ CPU æ•°é‡ï¼ˆæ”¯æŒå°æ•°ï¼‰</td><td><code>--cpus=1.5</code></td></tr><tr><td><code>--cpuset-cpus</code></td><td>æŒ‡å®šå®¹å™¨å¯ä»¥åœ¨å“ªäº› CPU ä¸Šè¿è¡Œï¼ˆå¦‚ 0-3ã€0,1ï¼‰</td><td><code>--cpuset-cpus=&quot;0,1&quot;</code></td></tr><tr><td><code>--cpuset-mems</code></td><td>æŒ‡å®šå®¹å™¨å¯ä»¥ä½¿ç”¨å“ªäº›å†…å­˜èŠ‚ç‚¹ï¼ˆå¦‚ 0-3ã€0,1ï¼‰ï¼Œé€‚ç”¨äº NUMA ç³»ç»Ÿ</td><td><code>--cpuset-mems=&quot;0&quot;</code></td></tr><tr><td><code>-m</code>, <code>--memory</code></td><td>è®¾ç½®å†…å­˜é™åˆ¶ï¼ˆä¾‹å¦‚ 512mã€2gï¼‰</td><td><code>--memory=1g</code></td></tr><tr><td><code>--memory-reservation</code></td><td>è®¾ç½®å†…å­˜è½¯é™åˆ¶ï¼ˆä½äº <code>--memory</code> çš„å€¼æ—¶ï¼Œå…è®¸ç³»ç»Ÿåœ¨å‹åŠ›è¾ƒå°æ—¶å›æ”¶ï¼‰</td><td><code>--memory-reservation=512m</code></td></tr><tr><td><code>--memory-swap</code></td><td>è®¾ç½® swap é™åˆ¶ï¼ˆå†…å­˜ + swap æ€»å’Œï¼‰ï¼Œè®¾ä¸º -1 è¡¨ç¤ºæ— é™åˆ¶</td><td><code>--memory-swap=2g</code></td></tr><tr><td><code>--pids-limit</code></td><td>è®¾ç½®å®¹å™¨çš„æœ€å¤§è¿›ç¨‹æ•°é‡ï¼Œè®¾ä¸º -1 è¡¨ç¤ºæ— é™åˆ¶</td><td><code>--pids-limit=100</code></td></tr><tr><td><code>--restart</code></td><td>è®¾ç½®å®¹å™¨é€€å‡ºåçš„é‡å¯ç­–ç•¥</td><td><code>--restart=always</code></td></tr></tbody></table><h3 id="docker-stats-æ˜¾ç¤ºå®¹å™¨çš„å®æ—¶èµ„æºä½¿ç”¨æƒ…å†µ"><code>docker stats</code> : æ˜¾ç¤ºå®¹å™¨çš„å®æ—¶èµ„æºä½¿ç”¨æƒ…å†µ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ˜¾ç¤ºæ‰€æœ‰å®¹å™¨çš„å®æ—¶èµ„æºä½¿ç”¨æƒ…å†µ</span></span><br><span class="line">docker stats</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">CONTAINER ID   NAME         CPU %     MEM USAGE / LIMIT     MEM %     NET I/O           BLOCK I/O     PIDS</span><br><span class="line">15caf520e3a5   nginx        0.00%     10.22MiB / 7.752GiB   0.13%     6.38kB / 2.61kB   0B / 28.7kB   13</span><br><span class="line">b680087420b8   dockge       0.01%     199.5MiB / 7.752GiB   2.51%     6.44kB / 1.48kB   94.8MB / 0B   24</span><br><span class="line">861dd9c1475f   remote-api   0.00%     4.188MiB / 7.752GiB   0.05%     2.77kB / 126B     3.31MB / 0B   1</span><br><span class="line"><span class="comment">### CONTAINER ID ä¸ NAMEï¼šå®¹å™¨ ID ä¸åç§°ã€‚</span></span><br><span class="line"><span class="comment">### CPU % ä¸ MEM %ï¼šå®¹å™¨ä½¿ç”¨çš„ CPU å’Œå†…å­˜çš„ç™¾åˆ†æ¯”ã€‚</span></span><br><span class="line"><span class="comment">### MEM USAGE / LIMITï¼šå®¹å™¨æ­£åœ¨ä½¿ç”¨çš„æ€»å†…å­˜ï¼Œä»¥åŠå…è®¸ä½¿ç”¨çš„å†…å­˜æ€»é‡ã€‚</span></span><br><span class="line"><span class="comment">### NET I/Oï¼šå®¹å™¨é€šè¿‡å…¶ç½‘ç»œæ¥å£å‘é€å’Œæ¥æ”¶çš„æ•°æ®é‡ã€‚</span></span><br><span class="line"><span class="comment">### BLOCK I/Oï¼šå®¹å™¨ä»ä¸»æœºä¸Šçš„å—è®¾å¤‡è¯»å–å’Œå†™å…¥çš„æ•°æ®é‡ã€‚</span></span><br><span class="line"><span class="comment">### PIDsï¼šå®¹å™¨åˆ›å»ºçš„è¿›ç¨‹æˆ–çº¿ç¨‹æ•°ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—å‡ºæ‰€æœ‰å®¹å™¨çš„èµ„æºä½¿ç”¨æƒ…å†µï¼ŒåŒ…æ‹¬è¿è¡Œå’Œåœæ­¢çš„</span></span><br><span class="line">docker stats -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># å±•ç¤ºå½“å‰çŠ¶æ€å°±ç›´æ¥é€€å‡ºäº†ï¼Œä¸å†å®æ—¶æ›´æ–°ã€‚</span></span><br><span class="line">docker stats --no-stream</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šè¾“å‡ºæ¨¡æ¿ï¼Œè¿™é‡ŒåŠ ä¸åŠ  table éƒ½å¯ä»¥</span></span><br><span class="line">docker stats --no-stream --format <span class="string">&quot;table &#123;&#123;.Name&#125;&#125;\t&#123;&#123;.CPUPerc&#125;&#125;\t&#123;&#123;.MemUsage&#125;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºjsonæ ¼å¼</span></span><br><span class="line">docker stats --no-stream --format json</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šå®¹å™¨</span></span><br><span class="line">docker stats &lt;container_id | container_name&gt;</span><br></pre></td></tr></table></figure><h3 id="docker-top-æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹"><code>docker top</code> :  æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker top &lt;container_id | container_name&gt; [ps options]</span></span><br><span class="line">docker top nginx</span><br></pre></td></tr></table></figure><h3 id="docker-port-åˆ—å‡ºæŒ‡å®šçš„å®¹å™¨çš„ç«¯å£æ˜ å°„"><code>docker port</code> : åˆ—å‡ºæŒ‡å®šçš„å®¹å™¨çš„ç«¯å£æ˜ å°„</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker port &lt;container_id | container_name&gt;</span></span><br><span class="line">$ docker port nginx</span><br><span class="line">80/tcp -&gt; 0.0.0.0:8081</span><br></pre></td></tr></table></figure><h3 id="docker-diff-åˆ—å‡ºå®¹å™¨è¿è¡Œæ—¶å¯¹æ–‡ä»¶ç³»ç»Ÿçš„ä¿®æ”¹"><code>docker diff</code> : åˆ—å‡ºå®¹å™¨è¿è¡Œæ—¶å¯¹æ–‡ä»¶ç³»ç»Ÿçš„ä¿®æ”¹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker diff &lt;container_id | container_name&gt;</span></span><br><span class="line">$ docker diff nginx</span><br><span class="line">C /root</span><br><span class="line">A /root/.bash_history</span><br><span class="line">C /run</span><br><span class="line">A /run/nginx.pid</span><br><span class="line">C /tmp</span><br><span class="line">A /tmp/demo.py</span><br><span class="line">C /var</span><br><span class="line">C /var/cache</span><br><span class="line">C /var/cache/nginx</span><br><span class="line">A /var/cache/nginx/client_temp</span><br><span class="line">A /var/cache/nginx/fastcgi_temp</span><br><span class="line">A /var/cache/nginx/proxy_temp</span><br><span class="line">A /var/cache/nginx/scgi_temp</span><br><span class="line">A /var/cache/nginx/uwsgi_temp</span><br><span class="line">C /etc</span><br><span class="line">C /etc/nginx</span><br><span class="line">C /etc/nginx/conf.d</span><br><span class="line">C /etc/nginx/conf.d/default.conf</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å‰ç¼€å«ä¹‰è¯´æ˜ï¼š</p></li></ul><table><thead><tr><th>æ ‡å¿—</th><th>å«ä¹‰</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>A</code></td><td><strong>Addedï¼ˆæ–°å¢ï¼‰</strong></td><td>æ–‡ä»¶æˆ–ç›®å½•æ˜¯å®¹å™¨è¿è¡Œåæ–°å¢çš„</td></tr><tr><td><code>C</code></td><td><strong>Changedï¼ˆä¿®æ”¹ï¼‰</strong></td><td>æ–‡ä»¶æˆ–ç›®å½•æ˜¯å·²æœ‰çš„ï¼Œä½†å†…å®¹æˆ–å…ƒæ•°æ®ï¼ˆå¦‚æƒé™ã€æ—¶é—´æˆ³ç­‰ï¼‰è¢«ä¿®æ”¹äº†</td></tr><tr><td><code>D</code></td><td><strong>Deletedï¼ˆåˆ é™¤ï¼‰</strong></td><td>æ–‡ä»¶æˆ–ç›®å½•æ˜¯å­˜åœ¨äºåŸé•œåƒä¸­çš„ï¼Œä½†åœ¨å®¹å™¨ä¸­è¢«åˆ é™¤</td></tr></tbody></table><h3 id="docker-commit-ä»å®¹å™¨åˆ›å»ºä¸€ä¸ªæ–°çš„é•œåƒ"><code>docker commit</code> : ä»å®¹å™¨åˆ›å»ºä¸€ä¸ªæ–°çš„é•œåƒ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker commit &lt;container_id | container_name&gt; [image_name[:tag]]</span></span><br><span class="line">docker commit nginx nginx:v1.0</span><br></pre></td></tr></table></figure><h3 id="docker-export-å¯¼å‡ºå®¹å™¨å†…å®¹ä¸º-tar-æ–‡ä»¶"><code>docker export</code> : å¯¼å‡ºå®¹å™¨å†…å®¹ä¸º tar æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">export</span> nginx &gt; nginx.tar</span><br><span class="line">dcoker <span class="built_in">export</span> -o nginx.tar nginx</span><br><span class="line">docker <span class="built_in">export</span> nginx | gzip &gt; nginx.tar.gz</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>Docker Export / Save / Commit å‘½ä»¤å¯¹æ¯”ä¸å¯¼å…¥æ–¹å¼ä¸€è§ˆè¡¨</p></li></ul><table><thead><tr><th>å‘½ä»¤</th><th>æ“ä½œå¯¹è±¡</th><th>è¾“å‡ºå†…å®¹</th><th>æ˜¯å¦åŒ…å«å†å²å±‚ï¼ˆé•œåƒå±‚ï¼‰</th><th>æ˜¯å¦ä¿ç•™å…ƒæ•°æ®ï¼ˆæ ‡ç­¾ã€å‘½ä»¤ç­‰ï¼‰</th><th>å…¸å‹ç”¨é€”</th><th>å¯¼å…¥å‘½ä»¤</th></tr></thead><tbody><tr><td><code>docker export</code></td><td><strong>å®¹å™¨</strong></td><td>å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆtar å½’æ¡£ï¼‰</td><td>âŒ å¦</td><td>âŒ å¦</td><td>å¤‡ä»½å®¹å™¨æ–‡ä»¶ç³»ç»Ÿæˆ–è¿ç§»å®¹å™¨çŠ¶æ€</td><td><code>docker import &lt;tar&gt; &lt;image:tag&gt;</code></td></tr><tr><td><code>docker save</code></td><td><strong>é•œåƒ</strong></td><td>é•œåƒçš„å®Œæ•´å†…å®¹ï¼ˆå«æ‰€æœ‰å±‚çš„ tarï¼‰</td><td>âœ… æ˜¯</td><td>âœ… æ˜¯</td><td>åˆ†å‘æˆ–å¤‡ä»½é•œåƒ</td><td><code>docker load &lt; &lt;tar&gt;</code></td></tr><tr><td><code>docker commit</code></td><td><strong>å®¹å™¨</strong></td><td>åˆ›å»ºä¸€ä¸ªæ–°çš„é•œåƒ</td><td>âœ… æ˜¯ï¼ˆä½†åªä¸€å±‚ï¼‰</td><td>âœ… æ˜¯</td><td>å°†å½“å‰å®¹å™¨çŠ¶æ€æ‰“åŒ…æˆæ–°é•œåƒ</td><td>ä¸é€‚ç”¨ï¼ˆç›´æ¥ç”Ÿæˆé•œåƒï¼‰</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;!--
 **åŠ ç²—**
 *æ–œä½“*
 ***åŠ ç²—å¹¶æ–œä½“***
 ~~åˆ é™¤çº¿~~
 ==çªå‡ºæ˜¾ç¤º==
 `çªå‡ºæ˜¾ç¤º(æ¨è)`
 ++ä¸‹åˆ’çº¿++
 ~ä¸‹æ ‡~
 ^ä¸Šæ ‡^
 è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.
 å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **ç‚¹å‡»æŠ˜å **
 è¿™æ˜¯è¢«éšè—çš„å†…å®¹
 +++

::: tips success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
:::

% note info % success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
% endnote %

å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}
 å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ
 --&gt;
&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ å®¹å™¨ç®¡ç† ç›¸å…³å‘½ä»¤&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com&quot;&gt;Dockerå®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/docker/"/>
    
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>Docker å‘½ä»¤ ä¹‹ Dockerfile</title>
    <link href="https://blog.hanqunfeng.com/2025/05/26/docker-dockerfile/"/>
    <id>https://blog.hanqunfeng.com/2025/05/26/docker-dockerfile/</id>
    <published>2025-05-26T13:30:05.000Z</published>
    <updated>2025-06-12T06:02:38.760Z</updated>
    
    <content type="html"><![CDATA[<!-- **åŠ ç²—** *æ–œä½“* ***åŠ ç²—å¹¶æ–œä½“*** ~~åˆ é™¤çº¿~~ ==çªå‡ºæ˜¾ç¤º== `çªå‡ºæ˜¾ç¤º(æ¨è)` ++ä¸‹åˆ’çº¿++ ~ä¸‹æ ‡~ ^ä¸Šæ ‡^ è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference. å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **ç‚¹å‡»æŠ˜å ** è¿™æ˜¯è¢«éšè—çš„å†…å®¹ +++::: tips success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹:::% note info % success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹% endnote %å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{} å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ --><h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2"><p>æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ Dockerfile çš„ä½¿ç”¨æ–¹æ³•</p></li><li class="lvl-2"><p><a href="https://docs.docker.com">Dockerå®˜æ–¹æ–‡æ¡£</a></p></li><li class="lvl-2"><p><a href="https://docs.docker.com/engine/reference/builder/">Dockerfileå®˜æ–¹æ–‡æ¡£</a></p></li></ul><span id="more"></span><h2 id="Dockerfile-æ˜¯ä»€ä¹ˆï¼Ÿ">Dockerfile æ˜¯ä»€ä¹ˆï¼Ÿ</h2><ul class="lvl-0"><li class="lvl-2"><p>Dockerå¯ä»¥é€šè¿‡è¯»å– <code>Dockerfile</code> ä¸­çš„æŒ‡ä»¤æ¥è‡ªåŠ¨æ„å»ºé•œåƒã€‚</p></li><li class="lvl-2"><p><code>Dockerfile</code> æ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡æ¡£ï¼Œå…¶ä¸­åŒ…å«ç”¨æˆ·å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸Šè°ƒç”¨ä»¥ç»„è£…é•œåƒçš„æ‰€æœ‰æŒ‡ä»¤ã€‚</p></li><li class="lvl-2"><p>å¯ä»¥åœ¨Dockerfileä¸­ä½¿ç”¨çš„æŒ‡ä»¤ï¼š</p></li></ul><table><thead><tr><th>æŒ‡ä»¤</th><th>ä¸­æ–‡æè¿°</th></tr></thead><tbody><tr><td><strong>ADD</strong></td><td>å°†æœ¬åœ°æˆ–è¿œç¨‹çš„æ–‡ä»¶/ç›®å½•æ·»åŠ åˆ°é•œåƒä¸­ï¼Œæ”¯æŒè‡ªåŠ¨è§£å‹ <code>.tar</code> æ–‡ä»¶å’Œä½¿ç”¨ URL ä¸‹è½½è¿œç¨‹èµ„æºã€‚é€šå¸¸æ¨èä½¿ç”¨ <code>COPY</code>ï¼Œé™¤ééœ€è¦è¿™äº›é«˜çº§åŠŸèƒ½ã€‚</td></tr><tr><td><strong>ARG</strong></td><td>å®šä¹‰æ„å»ºé˜¶æ®µä½¿ç”¨çš„å˜é‡ï¼Œå¯åœ¨ <code>docker build</code> å‘½ä»¤ä¸­é€šè¿‡ <code>--build-arg</code> ä¼ å…¥ï¼Œå˜é‡ä»…åœ¨æ„å»ºæ—¶æœ‰æ•ˆï¼Œä¸ä¼šä¿ç•™åœ¨æœ€ç»ˆé•œåƒä¸­ã€‚</td></tr><tr><td><strong>CMD</strong></td><td>æŒ‡å®šå®¹å™¨é»˜è®¤æ‰§è¡Œçš„å‘½ä»¤å’Œå‚æ•°ï¼Œå®¹å™¨è¿è¡Œæ—¶è‹¥æœªæŒ‡å®šå‘½ä»¤ï¼Œåˆ™ä½¿ç”¨è¯¥æŒ‡ä»¤è®¾ç½®çš„å‘½ä»¤ã€‚å¦‚æœé…ç½®äº†å¤šä¸ª<code>CMD</code>ï¼Œåˆ™åªæœ‰æœ€åä¸€ä¸ªç”Ÿæ•ˆã€‚å’Œ<code>ENTRYPOINT</code>å…±åŒä½¿ç”¨æ—¶ï¼Œä½œä¸ºä¼ é€’ç»™<code>ENTRYPOINT</code>çš„å‚æ•°ã€‚å¯è¢« <code>docker run</code> æä¾›çš„å‘½ä»¤è¦†ç›–ã€‚</td></tr><tr><td><strong>COPY</strong></td><td>å°†æ„å»ºä¸Šä¸‹æ–‡ä¸­çš„æ–‡ä»¶æˆ–ç›®å½•å¤åˆ¶åˆ°é•œåƒä¸­ã€‚ç›¸æ¯” <code>ADD</code> æ›´ç®€å•ã€å®‰å…¨ï¼Œæ¨èä¼˜å…ˆä½¿ç”¨ã€‚</td></tr><tr><td><strong>ENTRYPOINT</strong></td><td>æŒ‡å®šå®¹å™¨å¯åŠ¨æ—¶çš„ä¸»å‘½ä»¤ï¼Œä¸å®¹æ˜“è¢« <code>docker run</code> ä¸­çš„å‘½ä»¤è¦†ç›–ã€‚å¯ä¸ <code>CMD</code> é…åˆä½¿ç”¨ï¼Œç”¨äºæä¾›é»˜è®¤å‚æ•°ã€‚</td></tr><tr><td><strong>ENV</strong></td><td>è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œå˜é‡å°†åœ¨æ„å»ºå’Œå®¹å™¨è¿è¡Œæ—¶å‡å¯ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼šé…ç½®åº”ç”¨å‚æ•°æˆ–ç³»ç»Ÿè·¯å¾„ç­‰ã€‚</td></tr><tr><td><strong>EXPOSE</strong></td><td>å£°æ˜å®¹å™¨è¿è¡Œæ—¶å°†å¼€æ”¾çš„ç«¯å£ï¼Œä»…ç”¨äºæ–‡æ¡£è¯´æ˜æˆ–ä¸å®¹å™¨ç¼–æ’å·¥å…·é…åˆï¼Œä¸ä¼šè‡ªåŠ¨è¿›è¡Œç«¯å£æ˜ å°„ã€‚</td></tr><tr><td><strong>FROM</strong></td><td>æŒ‡å®šåŸºç¡€é•œåƒï¼Œæ˜¯ Dockerfile çš„èµ·ç‚¹ã€‚ä¹Ÿå¯ä»¥ç”¨äºå¤šé˜¶æ®µæ„å»ºï¼Œé€šè¿‡å¤šæ¬¡ä½¿ç”¨ <code>FROM</code> æŒ‡ä»¤åˆ›å»ºå¤šä¸ªæ„å»ºé˜¶æ®µã€‚</td></tr><tr><td><strong>HEALTHCHECK</strong></td><td>å®šä¹‰å®¹å™¨å¥åº·æ£€æŸ¥å‘½ä»¤ï¼Œç”¨äºå®šæœŸæ£€æµ‹å®¹å™¨å†…éƒ¨æœåŠ¡çš„å¥åº·çŠ¶æ€ï¼Œå¯ç»“åˆå®¹å™¨ç¼–æ’ç³»ç»Ÿå®ç°æ•…éšœè‡ªåŠ¨æ¢å¤ã€‚</td></tr><tr><td><strong>LABEL</strong></td><td>ä¸ºé•œåƒæ·»åŠ é”®å€¼å¯¹å½¢å¼çš„å…ƒæ•°æ®ï¼Œä¾‹å¦‚ç‰ˆæœ¬ã€ç»´æŠ¤è€…ã€ç”¨é€”è¯´æ˜ç­‰ï¼Œæ–¹ä¾¿é•œåƒç®¡ç†ä¸è‡ªåŠ¨åŒ–å¤„ç†ã€‚</td></tr><tr><td><strong>MAINTAINER</strong></td><td>ï¼ˆå·²å¼ƒç”¨ï¼‰ç”¨äºæŒ‡å®šé•œåƒç»´æŠ¤è€…ä¿¡æ¯ï¼Œæ¨èæ”¹ç”¨ <code>LABEL</code> æ¥è®¾ç½®ä½œè€…ä¿¡æ¯ã€‚</td></tr><tr><td><strong>ONBUILD</strong></td><td>å®šä¹‰ä¸€ä¸ªè§¦å‘æŒ‡ä»¤ï¼Œå½“å½“å‰é•œåƒä½œä¸ºåŸºç¡€é•œåƒè¢«å…¶ä»– Dockerfile ä½¿ç”¨æ—¶è‡ªåŠ¨æ‰§è¡Œã€‚å¸¸ç”¨äºåŸºç¡€é•œåƒçš„é¢„è®¾è¡Œä¸ºã€‚</td></tr><tr><td><strong>RUN</strong></td><td>æ‰§è¡Œä¸€æ¡å‘½ä»¤å¹¶æäº¤ç»“æœä½œä¸ºæ–°é•œåƒå±‚ï¼Œå¸¸ç”¨äºå®‰è£…è½¯ä»¶åŒ…ã€å¤åˆ¶æ–‡ä»¶ã€è®¾ç½®æƒé™ç­‰æ„å»ºæ“ä½œã€‚</td></tr><tr><td><strong>SHELL</strong></td><td>æ›´æ”¹ Dockerfile ä¸­åç»­ <code>RUN</code>ã€<code>CMD</code>ã€<code>ENTRYPOINT</code> ç­‰æŒ‡ä»¤çš„é»˜è®¤ shellï¼ˆå¦‚ä½¿ç”¨ <code>sh</code> æˆ– <code>powershell</code>ï¼‰ã€‚</td></tr><tr><td><strong>STOPSIGNAL</strong></td><td>è®¾ç½®å®¹å™¨ç»ˆæ­¢æ—¶å‘é€çš„ç³»ç»Ÿä¿¡å·ï¼ˆå¦‚ <code>SIGTERM</code>ï¼‰ï¼Œç”¨äºä¼˜é›…å…³é—­åº”ç”¨ã€‚</td></tr><tr><td><strong>USER</strong></td><td>è®¾ç½®æ‰§è¡Œåç»­å‘½ä»¤æ—¶æ‰€ä½¿ç”¨çš„ç”¨æˆ·å’Œç”¨æˆ·ç»„ï¼Œå¢å¼ºå®¹å™¨çš„å®‰å…¨æ€§ï¼Œé¿å…ä½¿ç”¨ root æƒé™ã€‚</td></tr><tr><td><strong>VOLUME</strong></td><td>å®šä¹‰å®¹å™¨å†…çš„æŒ‚è½½ç‚¹ï¼Œç”¨äºæŒä¹…åŒ–æ•°æ®æˆ–ä¸å®¿ä¸»æœº/å…¶ä»–å®¹å™¨å…±äº«æ•°æ®ã€‚è¿è¡Œå®¹å™¨æ—¶å¯æŒ‡å®šæŒ‚è½½è·¯å¾„ã€‚</td></tr><tr><td><strong>WORKDIR</strong></td><td>è®¾ç½®å·¥ä½œç›®å½•ï¼Œç›¸å½“äºæ‰§è¡Œ <code>cd</code>ï¼Œç”¨äºç®€åŒ–åç»­å‘½ä»¤ä¸­çš„è·¯å¾„ã€‚è‹¥ç›®å½•ä¸å­˜åœ¨åˆ™è‡ªåŠ¨åˆ›å»ºã€‚</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>æ„å»ºé˜¶æ®µæŒ‡ä»¤ï¼šFROM, ARG, ENV, COPY, ADD, RUN, WORKDIR, LABEL, USER, SHELL, ONBUILD</p></li><li class="lvl-2"><p>å¯åŠ¨é…ç½®æŒ‡ä»¤ï¼šCMD, ENTRYPOINT, HEALTHCHECK, EXPOSE, VOLUME, STOPSIGNAL</p></li></ul><h2 id="Dockerfile-æŒ‡ä»¤ä»‹ç»">Dockerfile æŒ‡ä»¤ä»‹ç»</h2><h3 id="FROM">FROM</h3><ul class="lvl-0"><li class="lvl-2"><p>FROM æŒ‡ä»¤ç”¨äºæŒ‡å®šåŸºç¡€é•œåƒï¼ˆbase imageï¼‰ï¼Œæ˜¯æ¯ä¸€ä¸ª Dockerfile ä¸­å¿…é¡»çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ã€‚æ‰€æœ‰åç»­æŒ‡ä»¤éƒ½æ˜¯åŸºäºè¿™ä¸ªåŸºç¡€é•œåƒæ„å»ºçš„ã€‚</p></li><li class="lvl-2"><p>è¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM &lt;image&gt;[:&lt;tag&gt;] [AS &lt;stage-name&gt;]</span><br><span class="line"><span class="comment"># è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment">#   &lt;image&gt;ï¼šé•œåƒåç§°ï¼ˆå¯ä»¥æ˜¯æœ¬åœ°å·²æœ‰çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯ä» Docker Hub æˆ–å…¶ä»–é•œåƒä»“åº“æ‹‰å–çš„ï¼‰</span></span><br><span class="line"><span class="comment">#   [:&lt;tag&gt;]ï¼šé•œåƒæ ‡ç­¾ï¼ˆå¯é€‰ï¼Œé»˜è®¤æ˜¯ latestï¼‰</span></span><br><span class="line"><span class="comment">#   [AS &lt;stage-name&gt;]ï¼šä¸ºè¯¥æ„å»ºé˜¶æ®µæŒ‡å®šåç§°ï¼Œç”¨äºå¤šé˜¶æ®µæ„å»º</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹</p></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„é•œåƒï¼ˆé»˜è®¤æ ‡ç­¾æ˜¯ latestï¼‰</span></span><br><span class="line"><span class="keyword">FROM</span> node</span><br><span class="line"><span class="comment"># ä½¿ç”¨æŒ‡å®šçš„æ ‡ç­¾</span></span><br><span class="line"><span class="keyword">FROM</span> node:<span class="number">16.13</span>.<span class="number">2</span>-alpine</span><br><span class="line"><span class="comment"># ä½¿ç”¨ç§æœ‰é•œåƒä»“åº“</span></span><br><span class="line"><span class="keyword">FROM</span> private.registry.com/my-image:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨å¤šé˜¶æ®µæ„å»º</span></span><br><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.20</span> AS builder</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> go build -o myapp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> alpine:latest</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/myapp /usr/local/bin/myapp</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;myapp&quot;</span>]</span></span><br><span class="line"><span class="comment">## è¿™é‡Œç”¨äº†ä¸¤ä¸ªé˜¶æ®µï¼š</span></span><br><span class="line"><span class="comment">###   builder é˜¶æ®µç”¨æ¥ç¼–è¯‘åº”ç”¨ï¼›</span></span><br><span class="line"><span class="comment">###   alpine é˜¶æ®µç”¨æ¥æ‰“åŒ…æœ€ç»ˆé•œåƒï¼ŒåªåŒ…å«ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå‡å°‘ä½“ç§¯ã€‚</span></span><br></pre></td></tr></table></figure><h3 id="WORKDIR">WORKDIR</h3><ul class="lvl-0"><li class="lvl-2"><p>WORKDIR æŒ‡å®šäº†å·¥ä½œç›®å½•ï¼Œå³åç»­æ‰€æœ‰æŒ‡ä»¤ï¼ˆå¦‚ RUNã€CMDã€ENTRYPOINTã€COPYã€ADD ç­‰ï¼‰æ‰€è¿è¡Œçš„å½“å‰è·¯å¾„ï¼ˆworking directoryï¼‰ã€‚</p></li><li class="lvl-2"><p>å¦‚æœç›®å½•ä¸å­˜åœ¨ï¼ŒDocker ä¼šè‡ªåŠ¨åˆ›å»ºå®ƒã€‚</p></li><li class="lvl-2"><p>æ¯ä¸ª WORKDIR éƒ½ä¼šåˆ›å»ºä¸€å±‚é•œåƒï¼ˆlayerï¼‰ï¼Œæ‰€ä»¥ä¸è¦é‡å¤è®¾ç½®æ— æ„ä¹‰çš„è·¯å¾„ã€‚</p></li><li class="lvl-2"><p>è¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WORKDIR &lt;path&gt;</span><br><span class="line"><span class="comment"># è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment">#   &lt;path&gt;ï¼šè¦åˆ‡æ¢çš„å·¥ä½œç›®å½•ï¼Œå¯ä»¥æ˜¯ç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹è·¯å¾„ã€‚</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹</p></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®ç»å¯¹è·¯å¾„</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿ç»­è®¾ç½®å¤šä¸ªå·¥ä½œç›®å½•ï¼ˆé€å±‚åµŒå¥—ï¼‰</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /var</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> www</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> html</span></span><br><span class="line"><span class="comment"># ç­‰åŒäº:</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /var/www/html</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é¿å…åœ¨ RUN cd some_dir åç»§ç»­æ‰§è¡Œä¾èµ–è·¯å¾„çš„å‘½ä»¤ï¼Œå› ä¸º Docker æ¯ä¸€æ¡æŒ‡ä»¤éƒ½æ˜¯æ–°çš„ shell å®ä¾‹ï¼Œcd ä¸ä¼šè·¨æŒ‡ä»¤ä¿ç•™ï¼Œåº”è¯¥æ”¹ç”¨ WORKDIRã€‚</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> some_dir  <span class="comment"># é”™è¯¯</span></span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> some_dir <span class="comment"># æ­£ç¡®</span></span></span><br></pre></td></tr></table></figure><h3 id="ARG">ARG</h3><ul class="lvl-0"><li class="lvl-2"><p>ARG ç”¨äºåœ¨ æ„å»ºé•œåƒæ—¶ï¼ˆbuild-timeï¼‰ä¼ å…¥å‚æ•°ã€‚è¿™äº›å‚æ•°åªåœ¨ æ„å»ºé˜¶æ®µæœ‰æ•ˆï¼Œä¸ä¼šå‡ºç°åœ¨æœ€ç»ˆé•œåƒä¸­ï¼Œä¹Ÿä¸ä¼šåœ¨å®¹å™¨è¿è¡Œæ—¶è¢«ä¿ç•™ã€‚</p></li><li class="lvl-2"><p>è¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ARG &lt;name&gt;[=&lt;default_value&gt;]</span><br><span class="line"><span class="comment"># è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment">#   &lt;name&gt;ï¼šå‚æ•°åç§°</span></span><br><span class="line"><span class="comment">#   [=&lt;default_value&gt;]ï¼šå‚æ•°çš„é»˜è®¤å€¼ï¼Œå¦‚æœæœªä¼ å…¥å‚æ•°ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼ï¼Œå¦‚æœä¸ºè®¾ç½®default_valueï¼Œåˆ™æ„å»ºé•œåƒæ—¶å¿…é¡»ä¼ é€’å‚æ•°ï¼Œ--build-arg</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹</p></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªå‚æ•°ï¼Œåœ¨æ„å»ºé•œåƒæ—¶å¿…é¡»ä¼ å…¥å‚æ•°ï¼Œ--build-arg APP_ENV=development</span></span><br><span class="line"><span class="keyword">ARG</span> APP_ENV</span><br><span class="line"><span class="comment"># å¸¦é»˜è®¤å€¼çš„ ARG</span></span><br><span class="line"><span class="keyword">ARG</span> APP_ENV=development</span><br><span class="line"><span class="comment"># ä½¿ç”¨å‚æ•°</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;å½“å‰ç¯å¢ƒï¼š<span class="variable">$&#123;APP_ENV&#125;</span>&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸ FROM ä¸€èµ·ç”¨ï¼ˆä» Docker 17.05 èµ·ï¼‰</span></span><br><span class="line"><span class="keyword">ARG</span> BASE=ubuntu</span><br><span class="line"><span class="keyword">FROM</span> $&#123;BASE&#125;:<span class="number">22.04</span></span><br></pre></td></tr></table></figure><h3 id="ENV">ENV</h3><ul class="lvl-0"><li class="lvl-2"><p>ENV æŒ‡ä»¤ç”¨äºåœ¨é•œåƒæ„å»ºè¿‡ç¨‹ä¸­å®šä¹‰ç¯å¢ƒå˜é‡ï¼ˆEnvironment Variablesï¼‰ã€‚è¿™äº›å˜é‡å¯ä»¥åœ¨ä¹‹åçš„æ„å»ºæ­¥éª¤ï¼ˆæ¯”å¦‚ RUNã€CMD ç­‰ï¼‰ä¸­ä½¿ç”¨ï¼Œä¹Ÿä¼šåœ¨å®¹å™¨è¿è¡Œæ—¶ç”Ÿæ•ˆã€‚</p></li><li class="lvl-2"><p>è¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸¤ç§è¯­æ³•</span></span><br><span class="line">ENV &lt;key&gt; &lt;value&gt;</span><br><span class="line">ENV &lt;key&gt;=&lt;value&gt; ...</span><br><span class="line"><span class="comment"># è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment">#   &lt;key&gt;ï¼šç¯å¢ƒå˜é‡çš„åç§°</span></span><br><span class="line"><span class="comment">#   &lt;value&gt;ï¼šç¯å¢ƒå˜é‡çš„å€¼</span></span><br><span class="line"><span class="comment"># å¦‚æœå®šä¹‰å¤šä¸ªå˜é‡ï¼Œæ¨èä½¿ç”¨ key=value çš„å½¢å¼ã€‚</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹</p></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="keyword">ENV</span> APP_ENV=production</span><br><span class="line"><span class="comment"># å®šä¹‰å¤šä¸ªå˜é‡</span></span><br><span class="line"><span class="keyword">ENV</span> APP_PORT=<span class="number">8080</span> NODE_ENV=production</span><br><span class="line"><span class="comment"># ä½¿ç”¨å¤šè¡Œæ ¼å¼ï¼ˆæé«˜å¯è¯»æ€§ï¼‰</span></span><br><span class="line"><span class="keyword">ENV</span> PATH=<span class="string">&quot;/usr/local/bin:$&#123;PATH&#125;&quot;</span> \</span><br><span class="line">    LANG=<span class="string">&quot;en_US.UTF-8&quot;</span> \</span><br><span class="line">    TZ=<span class="string">&quot;Asia/Shanghai&quot;</span></span><br><span class="line"><span class="comment"># ä¹Ÿå¯ä»¥åˆ†å¼€å®šä¹‰</span></span><br><span class="line"><span class="keyword">ENV</span> PATH=<span class="string">&quot;/usr/local/bin:$PATH&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> LANG=<span class="string">&quot;en_US.UTF-8&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> TZ=<span class="string">&quot;Asia/Shanghai&quot;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ³¨æ„ï¼šENV æŒ‡ä»¤å®šä¹‰çš„ç¯å¢ƒå˜é‡åœ¨æ„å»ºé˜¶æ®µå’Œè¿è¡Œé˜¶æ®µéƒ½ä¼šç”Ÿæ•ˆï¼Œä½†è¿è¡Œé˜¶æ®µä¼šè¦†ç›–æ„å»ºé˜¶æ®µå®šä¹‰çš„å˜é‡ã€‚</p></li></ul><h3 id="LABEL">LABEL</h3><ul class="lvl-0"><li class="lvl-2"><p>LABEL ç”¨äºä¸ºé•œåƒæ·»åŠ å…ƒæ•°æ®æ ‡ç­¾ï¼Œä»¥ <code>key=value</code> çš„å½¢å¼å­˜åœ¨ã€‚è¿™äº›æ ‡ç­¾å¯ä»¥æ˜¯ä½œè€…ä¿¡æ¯ã€ç‰ˆæœ¬æè¿°ã€ç”¨é€”è¯´æ˜ã€æ„å»ºæ—¶é—´ç­‰ã€‚</p></li><li class="lvl-2"><p>æ—§çš„ <code>MAINTAINER</code> æŒ‡ä»¤ç°åœ¨å·²è¢«åºŸå¼ƒï¼Œæ¨èä½¿ç”¨ <code>LABEL</code> æ¥ä»£æ›¿ã€‚</p></li><li class="lvl-2"><p>æ¯ä¸ª LABEL éƒ½ä¼šåˆ›å»ºä¸€å±‚é•œåƒï¼ˆlayerï¼‰ï¼Œæ¨èä¸€æ¬¡è®¾ç½®å¤šä¸ªã€‚</p></li><li class="lvl-2"><p>è¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LABEL &lt;key&gt;=&lt;value&gt; [&lt;key&gt;=&lt;value&gt;...]</span><br><span class="line"><span class="comment"># è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment">#   &lt;key&gt;ï¼šæ ‡ç­¾çš„é”®</span></span><br><span class="line"><span class="comment">#   &lt;value&gt;ï¼šæ ‡ç­¾çš„å€¼</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹</p></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ ä¸€ä¸ªæ ‡ç­¾</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;yourname@example.com&quot;</span></span></span><br><span class="line"><span class="comment"># æ¢è¡Œæ ¼å¼ï¼ˆæ¨èï¼‰,ä»¥ä¸‹æ ‡ç­¾ç¬¦åˆ OCIï¼ˆOpen Container Initiativeï¼‰ é•œåƒè§„èŒƒ</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> \</span></span><br><span class="line"><span class="language-bash">    org.opencontainers.image.title=<span class="string">&quot;MyApp&quot;</span> \</span></span><br><span class="line"><span class="language-bash">    org.opencontainers.image.description=<span class="string">&quot;æ¼”ç¤ºé¡¹ç›®&quot;</span> \</span></span><br><span class="line"><span class="language-bash">    org.opencontainers.image.version=<span class="string">&quot;1.0.0&quot;</span> \</span></span><br><span class="line"><span class="language-bash">    org.opencontainers.image.authors=<span class="string">&quot;zhangsan@example.com&quot;</span></span></span><br></pre></td></tr></table></figure><h3 id="USER">USER</h3><ul class="lvl-0"><li class="lvl-2"><p>USER æŒ‡ä»¤ç”¨äºæŒ‡å®šåç»­æŒ‡ä»¤ï¼ˆå¦‚ RUNã€CMDã€ENTRYPOINTã€COPY ç­‰ï¼‰ä»¥å“ªä¸ªç”¨æˆ·èº«ä»½æ¥æ‰§è¡Œã€‚</p></li><li class="lvl-2"><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒDocker å®¹å™¨ä¸­çš„å‘½ä»¤ä»¥ root ç”¨æˆ·è¿è¡Œï¼Œè¿™è™½ç„¶çµæ´»ä½†ä¸å®‰å…¨ã€‚ä½¿ç”¨ USER å¯ä»¥è®©æˆ‘ä»¬åˆ‡æ¢åˆ°æ™®é€šç”¨æˆ·ï¼Œä»è€Œæå‡å®¹å™¨çš„å®‰å…¨æ€§ï¼Œé˜²æ­¢æ½œåœ¨çš„æƒé™æ»¥ç”¨ã€‚</p></li><li class="lvl-2"><p>è¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">USER &lt;user&gt;[:&lt;group&gt;]</span><br><span class="line"><span class="comment"># è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment">#   &lt;user&gt;ï¼šç”¨æˆ·åæˆ– UID</span></span><br><span class="line"><span class="comment">#   [:&lt;group&gt;]ï¼šå¯é€‰ï¼Œç”¨æˆ·ç»„åæˆ– GID</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹</p></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®ç”¨æˆ·</span></span><br><span class="line"><span class="keyword">USER</span> appuser</span><br><span class="line"><span class="comment"># è®¾ç½®ç”¨æˆ·ç»„</span></span><br><span class="line"><span class="keyword">USER</span> appuser:appgroup</span><br><span class="line"><span class="comment"># ä½¿ç”¨ UID å’Œ GID</span></span><br><span class="line"><span class="keyword">USER</span> <span class="number">1000</span>:<span class="number">1000</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å¦‚æœåŸºç¡€é•œåƒä¸­æ²¡æœ‰ä½ æƒ³è¦çš„ç”¨æˆ·ï¼Œéœ€è¦åœ¨ Dockerfile ä¸­æ‰‹åŠ¨åˆ›å»º</p></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºç”¨æˆ·å’Œç»„</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> groupadd -r appgroup &amp;&amp; useradd -r -g appgroup appuser</span></span><br><span class="line"><span class="comment"># åˆ‡æ¢ç”¨æˆ·</span></span><br><span class="line"><span class="keyword">USER</span> appuser</span><br></pre></td></tr></table></figure><h3 id="ADD">ADD</h3><ul class="lvl-0"><li class="lvl-2"><p>ADD ç”¨äºå°†æœ¬åœ°æ–‡ä»¶æˆ–ç›®å½•ã€è¿œç¨‹æ–‡ä»¶ï¼ˆURLï¼‰ æˆ– å‹ç¼©åŒ… å¤åˆ¶åˆ°é•œåƒä¸­çš„æŒ‡å®šä½ç½®ã€‚</p></li><li class="lvl-2"><p>å®ƒçš„åŠŸèƒ½ç±»ä¼¼äº COPYï¼Œä½†æ¯” COPY å¤šå‡ ä¸ªåŠŸèƒ½ï¼ˆè§£å‹ã€æ‹‰å–è¿œç¨‹æ–‡ä»¶ç­‰ï¼‰ã€‚</p></li><li class="lvl-2"><p>è¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ADD &lt;src&gt;... &lt;dest&gt;</span><br><span class="line"><span class="comment"># è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment">#   &lt;src&gt;ï¼šè¦å¤åˆ¶çš„æ–‡ä»¶æˆ–ç›®å½•ï¼Œå¯ä»¥æ˜¯æœ¬åœ°æ–‡ä»¶ã€è¿œç¨‹ URLã€å‹ç¼©åŒ…ç­‰</span></span><br><span class="line"><span class="comment">#   &lt;dest&gt;ï¼šç›®æ ‡è·¯å¾„</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹</p></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»æœ¬åœ°æ–‡ä»¶å¤åˆ¶</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> app.jar /app.jar</span></span><br><span class="line"><span class="comment"># å¤åˆ¶å¤šä¸ª</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> app1.jar app2.jar /app/</span></span><br><span class="line"><span class="comment"># é€šé…ç¬¦</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> static-assets/*.html /app/public/</span></span><br><span class="line"><span class="comment"># ä»è¿œç¨‹ URL å¤åˆ¶</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> https://example.com/app.jar /app.jar</span></span><br><span class="line"><span class="comment"># ä»å‹ç¼©åŒ…ä¸­å¤åˆ¶</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> static-assets.tar.gz /app/public/</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æœ€ä½³å®è·µæ˜¯ä¼˜å…ˆä½¿ç”¨ COPYï¼Œåªæœ‰åœ¨éœ€è¦ ADD çš„é¢å¤–åŠŸèƒ½æ—¶æ‰ä½¿ç”¨å®ƒã€‚</p></li></ul><h3 id="COPY">COPY</h3><ul class="lvl-0"><li class="lvl-2"><p>COPY æŒ‡ä»¤ç”¨äºå°†ä¸»æœºä¸Šçš„æ–‡ä»¶æˆ–ç›®å½•å¤åˆ¶åˆ°é•œåƒçš„æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚å®ƒæ˜¯æ„å»ºé•œåƒè¿‡ç¨‹ä¸­æœ€å¸¸ç”¨çš„æ•°æ®å¼•å…¥æ–¹å¼ä¹‹ä¸€ã€‚</p></li><li class="lvl-2"><p>ä¸ ADD ç±»ä¼¼ï¼Œä½†åŠŸèƒ½æ›´ç®€å•ã€æ˜ç¡®ã€å®‰å…¨</p></li><li class="lvl-2"><p>æ¨èä¼˜å…ˆä½¿ç”¨ COPYï¼Œé™¤éä½ ç¡®å®éœ€è¦ ADD æä¾›çš„è‡ªåŠ¨è§£å‹æˆ–è¿œç¨‹ä¸‹è½½åŠŸèƒ½ã€‚</p></li><li class="lvl-2"><p>è¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">COPY &lt;src&gt;... &lt;dest&gt;</span><br><span class="line"><span class="comment"># è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment">#   &lt;src&gt;ï¼šè¦å¤åˆ¶çš„æ–‡ä»¶æˆ–ç›®å½•</span></span><br><span class="line"><span class="comment">#   &lt;dest&gt;ï¼šç›®æ ‡è·¯å¾„</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹</p></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¤åˆ¶å•ä¸ªæ–‡ä»¶</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> app.jar /app.jar</span></span><br><span class="line"><span class="comment"># å¤åˆ¶å¤šä¸ªæ–‡ä»¶</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> app1.jar app2.jar /app/</span></span><br><span class="line"><span class="comment"># å¤åˆ¶ç›®å½•</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> static-assets/ /app/public/</span></span><br><span class="line"><span class="comment"># é€šé…ç¬¦</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> static-assets/*.html /app/public/</span></span><br><span class="line"><span class="comment"># è®¾ç½®ç›®æ ‡æ–‡ä»¶å±ä¸»å±ç»„</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --<span class="built_in">chown</span>=appuser:appgroup app.jar /app.jar</span></span><br></pre></td></tr></table></figure><h3 id="RUN">RUN</h3><ul class="lvl-0"><li class="lvl-2"><p>RUN æŒ‡ä»¤ç”¨äºåœ¨é•œåƒæ„å»ºé˜¶æ®µæ‰§è¡Œå‘½ä»¤ï¼Œç»“æœä¼šè¢«æ‰“åŒ…è¿›é•œåƒå±‚ä¸­ã€‚</p></li><li class="lvl-2"><p>å®ƒå¯ä»¥ç”¨äºå®‰è£…ä¾èµ–ã€ç¼–è¯‘ä»£ç ã€è¿è¡Œå‘½ä»¤ç­‰ã€‚</p></li><li class="lvl-2"><p>æ¯ä¸€æ¡ RUN æŒ‡ä»¤ä¼šåˆ›å»ºä¸€å±‚é•œåƒï¼ˆlayerï¼‰,åˆå¹¶å¤šä¸ªå‘½ä»¤æˆä¸€æ¡ RUNï¼Œå¯ä»¥å‡å°‘é•œåƒå±‚æ•°ï¼ˆä¾‹å¦‚ä½¿ç”¨ &amp;&amp; ä¸²è”ï¼‰ã€‚</p></li><li class="lvl-2"><p>è¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¬¬ä¸€ç§æ ¼å¼ï¼šå®é™…è¿è¡Œçš„æ˜¯ï¼š/bin/sh -c &quot;&lt;å‘½ä»¤å­—ç¬¦ä¸²&gt;&quot;</span></span><br><span class="line">RUN &lt;å‘½ä»¤å­—ç¬¦ä¸²&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¬¬äºŒç§æ ¼å¼</span></span><br><span class="line">RUN [<span class="string">&quot;å¯æ‰§è¡Œæ–‡ä»¶&quot;</span>, <span class="string">&quot;å‚æ•°1&quot;</span>, <span class="string">&quot;å‚æ•°2&quot;</span>, ...]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹</p></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å‘½ä»¤å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y curl</span></span><br><span class="line"><span class="comment"># æ„å»ºå¤šä¸ªå‘½ä»¤(ç”¨ &amp;&amp; ä¸²è”)</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y python3 &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯æ‰§è¡Œæ–‡ä»¶å‚æ•°</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;curl https://example.com/app.jar &gt; app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure><h3 id="CMD">CMD</h3><ul class="lvl-0"><li class="lvl-2"><p>CMD ç”¨äºæŒ‡å®šå®¹å™¨å¯åŠ¨æ—¶é»˜è®¤æ‰§è¡Œçš„å‘½ä»¤åŠå…¶å‚æ•°ã€‚</p></li><li class="lvl-2"><p>å¦‚æœç”¨æˆ·åœ¨è¿è¡Œå®¹å™¨æ—¶æ²¡æœ‰æ‰‹åŠ¨æŒ‡å®šå…¶ä»–å‘½ä»¤ï¼ŒDocker å°±ä¼šä½¿ç”¨ CMD æä¾›çš„å†…å®¹ã€‚</p></li><li class="lvl-2"><p>å®ƒå¯ä»¥å®šä¹‰å¤šä¸ªï¼Œä½†åªæœ‰æœ€åä¸€ä¸ªä¼šè¢«ä½¿ç”¨ã€‚</p></li><li class="lvl-2"><p>è¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Shell å½¢å¼ï¼ˆå­—ç¬¦ä¸²ï¼‰</span></span><br><span class="line">CMD <span class="built_in">command</span> param1 param2</span><br><span class="line"><span class="comment"># ç­‰ä»·äº /bin/sh -c &quot;command param1 param2&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Exec å½¢å¼ï¼ˆæ•°ç»„ï¼‰</span></span><br><span class="line">CMD [<span class="string">&quot;executable&quot;</span>, <span class="string">&quot;param1&quot;</span>, <span class="string">&quot;param2&quot;</span>, ...]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹</p></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç®€å• shell å‘½ä»¤</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;Hello from container&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Exec å½¢å¼</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;npm&quot;</span>, <span class="string">&quot;start&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½œä¸º ENTRYPOINT çš„å‚æ•°</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;python3&quot;</span>, <span class="string">&quot;app.py&quot;</span>]</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;--host=0.0.0.0&quot;</span>, <span class="string">&quot;--port=8080&quot;</span>]</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç”¨æˆ·å¯ä»¥è¦†ç›– CMDï¼š</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run &lt;myapp&gt; npm run <span class="built_in">test</span></span><br></pre></td></tr></table></figure><h3 id="ENTRYPOINT">ENTRYPOINT</h3><ul class="lvl-0"><li class="lvl-2"><p>ENTRYPOINT å®šä¹‰å®¹å™¨å¯åŠ¨æ—¶æ‰§è¡Œçš„ä¸»å‘½ä»¤ï¼Œç›¸æ¯” CMDï¼Œå®ƒä¸å®¹æ˜“è¢«è¦†ç›–ï¼Œæ›´é€‚åˆåˆ¶ä½œâ€œä¸“ç”¨å‹â€å®¹å™¨ï¼ˆå¦‚ nginxã€python è„šæœ¬ç­‰ï¼‰ã€‚</p></li><li class="lvl-2"><p>ä½ å¯ä»¥æŠŠ ENTRYPOINT ç†è§£ä¸ºå®¹å™¨çš„â€œä¸»ç¨‹åºâ€ï¼Œè€Œ CMD æ˜¯ä¸ºå®ƒæä¾›çš„é»˜è®¤â€œå‘½ä»¤è¡Œå‚æ•°â€ã€‚</p></li><li class="lvl-2"><p>è¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Shell å½¢å¼ï¼ˆå­—ç¬¦ä¸²ï¼‰</span></span><br><span class="line">ENTRYPOINT <span class="built_in">command</span> param1 param2</span><br><span class="line"><span class="comment">#  ç­‰ä»·äº /bin/sh -c &quot;command param1 param2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Exec å½¢å¼ï¼ˆæ•°ç»„ï¼‰</span></span><br><span class="line">ENTRYPOINT [<span class="string">&quot;executable&quot;</span>, <span class="string">&quot;param1&quot;</span>, <span class="string">&quot;param2&quot;</span>, ...]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹</p></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç®€å• shell å‘½ä»¤</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;Hello from container&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Exec å½¢å¼</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;npm&quot;</span>, <span class="string">&quot;start&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»“åˆ CMD ä½¿ç”¨</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;python3&quot;</span>, <span class="string">&quot;app.py&quot;</span>]</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;--host=0.0.0.0&quot;</span>, <span class="string">&quot;--port=8080&quot;</span>]</span></span><br></pre></td></tr></table></figure><h3 id="EXPOSE">EXPOSE</h3><ul class="lvl-0"><li class="lvl-2"><p>EXPOSE ç”¨äºå£°æ˜å®¹å™¨å°†ä¼šç›‘å¬çš„ç«¯å£ï¼Œè®©ä½¿ç”¨è¯¥é•œåƒçš„äººçŸ¥é“åº”è¯¥å¯¹å¤–å¼€æ”¾å“ªäº›ç«¯å£ã€‚</p></li><li class="lvl-2"><p>âš ï¸ æ³¨æ„ï¼šEXPOSE å¹¶ä¸ä¼šçœŸçš„å¼€æ”¾ç«¯å£ï¼Œåªæ˜¯â€œå£°æ˜â€è¿™ä¸ªå®¹å™¨ç›‘å¬äº†è¿™äº›ç«¯å£ã€‚</p></li><li class="lvl-2"><p>è¦è®©ç«¯å£çœŸæ­£æš´éœ²å‡ºæ¥ï¼Œè¿˜éœ€è¦åœ¨è¿è¡Œå®¹å™¨æ—¶åŠ ä¸Š <code>-p</code> æˆ– <code>--publish</code> å‚æ•°ã€‚</p></li><li class="lvl-2"><p>è¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">EXPOSE &lt;port&gt; [&lt;port&gt;/&lt;protocol&gt;...]</span><br><span class="line"><span class="comment"># è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment">#   &lt;port&gt;ï¼šç«¯å£å·ï¼Œå¯ä»¥æ˜¯å•ä¸ªç«¯å£å·ï¼Œä¹Ÿå¯ä»¥æ˜¯èŒƒå›´ï¼ˆå¦‚ 8080-8085ï¼‰</span></span><br><span class="line"><span class="comment">#   &lt;protocol&gt;ï¼šåè®®ï¼Œå¯ä»¥æ˜¯ tcp æˆ– udpï¼Œé»˜è®¤ä¸º tcp</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹</p></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span>/udp</span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span>-<span class="number">8085</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span> <span class="number">8081</span> <span class="number">8082</span> <span class="number">8083</span> <span class="number">8084</span> <span class="number">8085</span></span><br></pre></td></tr></table></figure><h3 id="VOLUME">VOLUME</h3><ul class="lvl-0"><li class="lvl-2"><p>VOLUME æŒ‡ä»¤ç”¨äºå£°æ˜ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ä¸­çš„æŒ‚è½½ç‚¹ï¼ˆmount pointï¼‰ï¼Œç”¨äºæŒä¹…åŒ–æ•°æ®æˆ–ä¸å®¿ä¸»æœº/å…¶ä»–å®¹å™¨å…±äº«æ•°æ®ã€‚</p></li><li class="lvl-2"><p>è¯­æ³•ï¼š</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">VOLUME [<span class="string">&quot;/path/in/container&quot;</span>, ...]</span><br><span class="line"><span class="comment"># è·¯å¾„å¿…é¡»æ˜¯å®¹å™¨å†…éƒ¨çš„ç»å¯¹è·¯å¾„</span></span><br><span class="line"><span class="comment"># å¯ä»¥ä¸€æ¬¡å£°æ˜ä¸€ä¸ªï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªã€‚</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹</p></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å£°æ˜ä¸€ä¸ªæŒ‚è½½ç‚¹</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> /app/public</span></span><br><span class="line"><span class="comment"># å£°æ˜å¤šä¸ªæŒ‚è½½ç‚¹</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> [<span class="string">&quot;/app/public&quot;</span>, <span class="string">&quot;/app/logs&quot;</span>]</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å½“å®¹å™¨è¿è¡Œæ—¶ï¼Œå¯ä»¥å°†é•œåƒä¸­å£°æ˜çš„æŒ‚è½½ç‚¹æ˜ å°„åˆ°å®¿ä¸»æœºä¸Šï¼Œä»è€Œå®ç°æŒä¹…åŒ–æ•°æ®ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -v /host/path:/app/public myimage</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å¦‚æœä½ æ²¡æœ‰æ‰‹åŠ¨ç»‘å®šæŒ‚è½½ï¼ŒDocker ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªåŒ¿åå·ï¼Œå·çš„å†…å®¹é»˜è®¤ä¿å­˜åœ¨å®¿ä¸»æœºçš„ <code>/var/lib/docker/volumes</code> ä¸‹ã€‚</p></li></ul><h3 id="HEALTHCHECK">HEALTHCHECK</h3><ul class="lvl-0"><li class="lvl-2"><p>HEALTHCHECK ç”¨æ¥å®šä¹‰å®¹å™¨è¿è¡Œæ—¶çš„å¥åº·æ£€æŸ¥å‘½ä»¤ï¼Œå®šæœŸæ£€æµ‹å®¹å™¨å†…æœåŠ¡çš„çŠ¶æ€ï¼Œå¸®åŠ©ç¼–æ’å·¥å…·ï¼ˆDocker Swarmã€Kubernetes ç­‰ï¼‰åˆ¤æ–­å®¹å™¨æ˜¯å¦å¥åº·ã€‚</p></li><li class="lvl-2"><p>å¦‚æœå¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒDocker ä¼šå°†å®¹å™¨æ ‡è®°ä¸º unhealthyï¼Œä¾¿äºè‡ªåŠ¨é‡å¯æˆ–æ›¿æ¢ã€‚</p></li><li class="lvl-2"><p>è¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HEALTHCHECK &lt;options&gt; CMD &lt;<span class="built_in">command</span>&gt;</span><br><span class="line"><span class="comment"># è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment"># &lt;options&gt;ï¼šå¯é€‰é¡¹ï¼Œç”¨äºè®¾ç½®å¥åº·æ£€æŸ¥çš„é€‰é¡¹ï¼Œå¦‚è¶…æ—¶æ—¶é—´ã€é‡è¯•æ¬¡æ•°ç­‰ã€‚</span></span><br><span class="line"><span class="comment"># &lt;command&gt;ï¼šå¥åº·æ£€æŸ¥å‘½ä»¤ï¼Œå¯ä»¥æ˜¯ä»»ä½•æœ‰æ•ˆçš„ shell å‘½ä»¤ã€‚</span></span><br><span class="line">            <span class="comment"># å¿…é¡»è¿”å›é€€å‡ºç :</span></span><br><span class="line">              <span class="comment"># 0 è¡¨ç¤ºå¥åº·</span></span><br><span class="line">              <span class="comment"># 1 è¡¨ç¤ºä¸å¥åº·</span></span><br><span class="line">              <span class="comment"># 2 è¡¨ç¤ºæœªçŸ¥</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å¯é€‰å‚æ•°ï¼ˆOPTIONSï¼‰</p></li></ul><table><thead><tr><th>å‚æ•°</th><th>è¯´æ˜</th><th>é»˜è®¤å€¼</th></tr></thead><tbody><tr><td><code>--interval=DURATION</code></td><td>ä¸¤æ¬¡å¥åº·æ£€æŸ¥ä¹‹é—´çš„æ—¶é—´é—´éš”</td><td>30s</td></tr><tr><td><code>--timeout=DURATION</code></td><td>å•æ¬¡æ£€æµ‹å‘½ä»¤çš„è¶…æ—¶æ—¶é—´</td><td>30s</td></tr><tr><td><code>--start-period=DURATION</code></td><td>å®¹å™¨å¯åŠ¨åï¼Œå¼€å§‹å¥åº·æ£€æŸ¥å‰çš„ç­‰å¾…æ—¶é—´</td><td>0s</td></tr><tr><td><code>--retries=N</code></td><td>è¿ç»­å¤±è´¥å‡ æ¬¡ååˆ¤å®šå®¹å™¨ä¸å¥åº·</td><td>3</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹</p></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ curl æ£€æµ‹ Web æœåŠ¡æ˜¯å¦å“åº”</span></span><br><span class="line"><span class="keyword">HEALTHCHECK</span><span class="language-bash"> --interval=5s --<span class="built_in">timeout</span>=3s --retries=3 CMD curl -f http://localhost:8080/health || <span class="built_in">exit</span> 1</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>è¿è¡Œå®¹å™¨åï¼Œå¯ä»¥ç”¨å‘½ä»¤æŸ¥çœ‹å¥åº·çŠ¶æ€</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¦‚æœé•œåƒä¸­æœ‰å¥åº·æ£€æŸ¥ï¼Œå¯ä»¥æŸ¥çœ‹å®¹å™¨çŠ¶æ€ï¼ˆSTATUSï¼‰</span></span><br><span class="line">docker ps</span><br><span class="line">  <span class="comment"># STATUS åˆ—ä¼šæ˜¾ç¤ºï¼š</span></span><br><span class="line">  <span class="comment">#   healthy</span></span><br><span class="line">  <span class="comment">#   unhealthy</span></span><br><span class="line">  <span class="comment">#   startingï¼ˆå¯åŠ¨ä¸­ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ›´è¯¦ç»†çš„ä¿¡æ¯</span></span><br><span class="line">docker inspect --format=<span class="string">&#x27;&#123;&#123;json .State.Health&#125;&#125;&#x27;</span> &lt;container-id&gt;</span><br></pre></td></tr></table></figure><h3 id="SHELL">SHELL</h3><ul class="lvl-0"><li class="lvl-2"><p>SHELL æŒ‡ä»¤ç”¨æ¥è‡ªå®šä¹‰åç»­ RUNã€CMD å’Œ ENTRYPOINT æŒ‡ä»¤æ‰€ä½¿ç”¨çš„é»˜è®¤ shell ç¨‹åºå’Œå‚æ•°ã€‚</p></li><li class="lvl-2"><p>é»˜è®¤æƒ…å†µä¸‹ï¼š</p><ul class="lvl-2"><li class="lvl-4">åœ¨ Linux é•œåƒä¸­ï¼ŒDocker ä½¿ç”¨ /bin/sh -c</li><li class="lvl-4">åœ¨ Windows é•œåƒä¸­ï¼Œä½¿ç”¨ cmd /S /C</li></ul></li><li class="lvl-2"><p>ä½¿ç”¨ SHELLï¼Œä½ å¯ä»¥æ›¿æ¢ä¸ºå…¶ä»– shellï¼Œå¦‚ Bashã€PowerShellã€zsh ç­‰ã€‚</p></li><li class="lvl-2"><p>è¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHELL [<span class="string">&quot;executable&quot;</span>, <span class="string">&quot;param1&quot;</span>, <span class="string">&quot;param2&quot;</span>, ...]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹</p></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ‡æ¢åˆ° bash</span></span><br><span class="line"><span class="keyword">SHELL</span><span class="language-bash"> [<span class="string">&quot;bash&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤šæ¬¡åˆ‡æ¢</span></span><br><span class="line"><span class="keyword">SHELL</span><span class="language-bash"> [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;Hello from Bash&quot;</span> <span class="comment"># åœ¨ Bash ä¸­æ‰§è¡Œ</span></span></span><br><span class="line"><span class="keyword">SHELL</span><span class="language-bash"> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;Now back to sh&quot;</span> <span class="comment">#  åœ¨ sh ä¸­æ‰§è¡Œ</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Windows</span></span><br><span class="line"><span class="keyword">SHELL</span><span class="language-bash"> [<span class="string">&quot;powershell&quot;</span>, <span class="string">&quot;-Command&quot;</span>]</span></span><br></pre></td></tr></table></figure><h3 id="STOPSIGNAL">STOPSIGNAL</h3><ul class="lvl-0"><li class="lvl-2"><p>STOPSIGNAL æŒ‡å®šå½“å®¹å™¨æ”¶åˆ° <code>docker stop</code> å‘½ä»¤æ—¶ï¼Œå‘é€ç»™å®¹å™¨ä¸»è¿›ç¨‹çš„ä¿¡å·ç±»å‹ã€‚</p></li><li class="lvl-2"><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒDocker ä¼šå‘å®¹å™¨çš„ä¸»è¿›ç¨‹å‘é€ <code>SIGTERM</code> ä¿¡å·ï¼Œè®©å®ƒæœ‰æœºä¼šä¼˜é›…åœ°é€€å‡ºï¼ˆåœ¨è¶…æ—¶æ—¶æœªé€€å‡ºåˆ™å‘ <code>SIGKILL</code> å¼ºåˆ¶ç»ˆæ­¢ï¼‰ã€‚</p></li><li class="lvl-2"><p>é»˜è®¤æƒ…å†µï¼Œå¤§å¤šæ•°ç¨‹åºï¼ˆå¦‚ nginxï¼‰ï¼Œä¸éœ€è¦è®¾ç½®ï¼ˆé»˜è®¤ SIGTERMï¼‰</p></li><li class="lvl-2"><p>ä½†æœ‰äº›ç¨‹åºå¯èƒ½éœ€è¦ä½¿ç”¨ä¸åŒçš„ä¿¡å·ï¼Œæ¯”å¦‚ SIGINTã€SIGHUPï¼Œè¿™æ—¶ä½ å¯ä»¥é€šè¿‡ STOPSIGNAL æ¥ä¿®æ”¹ã€‚</p></li><li class="lvl-2"><p>è¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">STOPSIGNAL &lt;signal&gt;</span><br><span class="line"><span class="comment"># è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment"># å…¶ä¸­ &lt;signal&gt; å¯ä»¥æ˜¯ï¼š</span></span><br><span class="line"><span class="comment">#   ä¿¡å·åç§°ï¼Œä¾‹å¦‚ï¼šSIGTERMã€SIGKILLã€SIGINTã€SIGHUP</span></span><br><span class="line"><span class="comment">#   æˆ–ä¿¡å·ç¼–å·ï¼Œä¾‹å¦‚ï¼š15ï¼ˆç­‰ä»·äº SIGTERMï¼‰</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹</p></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿™æ˜¯é»˜è®¤è¡Œä¸ºï¼Œä¸å†™ä¹Ÿä¸€æ ·ã€‚</span></span><br><span class="line"><span class="keyword">STOPSIGNAL</span> SIGTERM</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹ä¸º SIGINT</span></span><br><span class="line"><span class="keyword">STOPSIGNAL</span> SIGINT</span><br></pre></td></tr></table></figure><h3 id="ONBUILD">ONBUILD</h3><ul class="lvl-0"><li class="lvl-2"><p>ONBUILD ç”¨äºå®šä¹‰å»¶è¿Ÿæ‰§è¡Œçš„æ„å»ºæŒ‡ä»¤ï¼Œå³è¿™äº›å‘½ä»¤ä¸ä¼šåœ¨å½“å‰ Dockerfile æ„å»ºæ—¶æ‰§è¡Œï¼Œè€Œæ˜¯åœ¨ ä»¥å½“å‰é•œåƒä¸ºåŸºç¡€çš„å­é•œåƒä¸­æ„å»ºæ—¶è§¦å‘æ‰§è¡Œã€‚</p></li><li class="lvl-2"><p>å®ƒçš„å…¸å‹ç”¨é€”æ˜¯ï¼šæ„å»ºä¸€ä¸ªâ€œé€šç”¨åŸºç¡€é•œåƒâ€ï¼Œè®©ä½¿ç”¨è€…åœ¨è‡ªå·±çš„ Dockerfile ä¸­ FROM å®ƒæ—¶è‡ªåŠ¨ç»§æ‰¿ä¸€äº›æ“ä½œï¼ˆæ¯”å¦‚ COPYã€RUN ç­‰ï¼‰ã€‚</p></li><li class="lvl-2"><p>ONBUILD æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œæ–¹ä¾¿åŸºç¡€é•œåƒä½œè€…é¢„å…ˆå®šä¹‰â€œæœªæ¥å­é•œåƒæ„å»ºæ—¶ä¸€å®šè¦æ‰§è¡Œçš„æ­¥éª¤â€ï¼Œè€Œä¸æ˜¯åœ¨åŸºç¡€é•œåƒä¸­â€œç¡¬ç¼–ç â€é‚£äº›æ­¥éª¤ã€‚</p></li><li class="lvl-2"><p>è¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ONBUILD &lt;INSTRUCTION&gt;</span><br><span class="line"><span class="comment"># è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment"># &lt;INSTRUCTION&gt;ï¼šå¿…é¡»æ˜¯ä¸€ä¸ªåˆæ³•çš„ Dockerfile æŒ‡ä»¤ï¼Œå¦‚ RUNã€COPYã€ADDã€CMD ç­‰ï¼ˆä½†ä¸èƒ½æ˜¯ FROM, ONBUILD, HEALTHCHECK ç­‰ï¼‰ã€‚</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹</p></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŸºç¡€é•œåƒä¸­ä½¿ç”¨ ONBUILD</span></span><br><span class="line"><span class="comment"># æ–‡ä»¶ï¼šDockerfile.base</span></span><br><span class="line"><span class="keyword">FROM</span> node:<span class="number">18</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">ONBUILD</span> <span class="keyword">COPY</span><span class="language-bash"> . /app</span></span><br><span class="line"><span class="keyword">ONBUILD</span> <span class="keyword">RUN</span><span class="language-bash"> npm install</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„å»ºåŸºç¡€é•œåƒ</span></span><br><span class="line">docker build -t my-node-base -f Dockerfile.base .</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨åŸºç¡€é•œåƒæ„å»ºå­é•œåƒ</span></span><br><span class="line"><span class="comment"># æ–‡ä»¶ï¼šDockerfileï¼ˆå­é•œåƒï¼‰</span></span><br><span class="line"><span class="keyword">FROM</span> my-node-base</span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;node&quot;</span>, <span class="string">&quot;index.js&quot;</span>]</span></span><br><span class="line"><span class="comment"># æ„å»ºå­é•œåƒæ—¶ï¼Œç­‰äºè‡ªåŠ¨æ’å…¥äº†ï¼š</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . /app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm install</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ONBUILD æ˜¯ä¸€ç§â€œæ„å»ºé’©å­â€æœºåˆ¶</p><ul class="lvl-2"><li class="lvl-4">ONBUILD å¯ä»¥ç†è§£æˆâ€œé’©å­â€æˆ–â€œè§¦å‘å™¨â€ï¼š<ul class="lvl-4"><li class="lvl-6">åœ¨åŸºç¡€é•œåƒæ„å»ºæ—¶ä¸æ‰§è¡Œ</li><li class="lvl-6">ä½†å½“æŸäººä»¥è¿™ä¸ªåŸºç¡€é•œåƒä¸ºèµ·ç‚¹å†™è‡ªå·±çš„ Dockerfileï¼Œå¹¶æ„å»ºæ—¶ï¼Œè¿™äº› ONBUILD é‡Œçš„æŒ‡ä»¤è‡ªåŠ¨æ’å…¥æ‰§è¡Œ</li></ul></li><li class="lvl-4">è¿™æ ·ï¼š<ul class="lvl-4"><li class="lvl-6">åŸºç¡€é•œåƒåªè´Ÿè´£å®šä¹‰ç¯å¢ƒï¼ˆnodeã€npmç‰ˆæœ¬ã€ç³»ç»Ÿä¾èµ–ç­‰ï¼‰ï¼Œä¿æŒè½»é‡</li><li class="lvl-6">ä¸‹æ¸¸é¡¹ç›®å¯ä»¥ä¸ç”¨å†™é‡å¤çš„ä»£ç å¤åˆ¶å’Œå®‰è£…æŒ‡ä»¤ï¼Œè‡ªåŠ¨ç»§æ‰¿åŸºç¡€é•œåƒé¢„å®šä¹‰çš„æ„å»ºæ­¥éª¤</li><li class="lvl-6">ä»£ç å¤åˆ¶å’Œä¾èµ–å®‰è£…åœ¨ä¸‹æ¸¸é•œåƒæ„å»ºæ—¶æ‰§è¡Œï¼Œä½¿ç”¨è‡ªå·±çš„ä¸Šä¸‹æ–‡ï¼ˆä¹Ÿå°±æ˜¯é¡¹ç›®ä»£ç ï¼‰</li></ul></li></ul></li><li class="lvl-2"><p><code>ONBUILD</code> æ€»ç»“</p></li></ul><table><thead><tr><th>ç‰¹æ€§</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>â± å»¶è¿Ÿæ‰§è¡Œ</td><td>æ„å»ºåŸºç¡€é•œåƒæ—¶ä¸ä¼šæ‰§è¡Œï¼Œåœ¨å­é•œåƒæ„å»ºæ—¶è§¦å‘</td></tr><tr><td>âœ… æ”¯æŒæŒ‡ä»¤</td><td>ä¾‹å¦‚ <code>RUN</code>, <code>COPY</code>, <code>ADD</code>, <code>CMD</code>, <code>WORKDIR</code>, <code>ENV</code> ç­‰</td></tr><tr><td>âŒ ä¸æ”¯æŒ</td><td><code>FROM</code>, <code>ONBUILD</code>, <code>HEALTHCHECK</code>, <code>SHELL</code>, <code>STOPSIGNAL</code></td></tr><tr><td>ğŸ‘ ä¸æ¨èæ»¥ç”¨</td><td>ä¼šéšè—æ„å»ºè¡Œä¸ºï¼Œé™ä½å¯ç»´æŠ¤æ€§</td></tr><tr><td>âœ… æ¨èåœºæ™¯</td><td>å›¢é˜Ÿå…±äº«æ¨¡æ¿ã€æ„å»ºâ€œæ ‡å‡†å¼€å‘é•œåƒâ€</td></tr></tbody></table><h2 id="Dockerfile-å“ªäº›-æŒ‡ä»¤-ä¼šåˆ›å»ºæ–°çš„å±‚">Dockerfile å“ªäº› æŒ‡ä»¤ ä¼šåˆ›å»ºæ–°çš„å±‚</h2><ul class="lvl-0"><li class="lvl-2"><p>å½“ Dockerfile ä¸­åˆ›å»ºæ–°å±‚çš„æŒ‡ä»¤å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä½¿ç”¨ <code>--no-cache</code> é€‰é¡¹å¯ä»¥ç¡®ä¿è¿™äº›å˜æ›´è¢«æ­£ç¡®åº”ç”¨ã€‚</p></li></ul><table><thead><tr><th>æŒ‡ä»¤</th><th>æè¿°</th></tr></thead><tbody><tr><td>ADD</td><td>ä» <src> å¤åˆ¶æ–‡ä»¶å¹¶è‡ªåŠ¨è§£å‹ï¼ˆå¦‚æœæ˜¯ä¸€ä¸ª tar æ–‡ä»¶ï¼‰åˆ°å®¹å™¨çš„ <dest> è·¯å¾„ã€‚</td></tr><tr><td>COPY</td><td>ä» <src> å¤åˆ¶æ–‡ä»¶åˆ°å®¹å™¨çš„ <dest> è·¯å¾„ï¼Œä¸ä¼šè‡ªåŠ¨è§£å‹ã€‚</td></tr><tr><td>RUN</td><td>æ‰§è¡Œä»»æ„å‘½ä»¤å¹¶åœ¨å®¹å™¨ä¸­åšå‡ºæ›´æ”¹ã€‚æ¯æ¡ RUN æŒ‡ä»¤éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å±‚ã€‚</td></tr><tr><td>ENV</td><td>è®¾ç½®ç¯å¢ƒå˜é‡ã€‚æ¯ä¸€è¡Œ ENV æŒ‡ä»¤éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å±‚ã€‚</td></tr><tr><td>WORKDIR</td><td>è®¾ç½®å·¥ä½œç›®å½•ã€‚æ¯ä¸€è¡Œ WORKDIR æŒ‡ä»¤éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å±‚ã€‚</td></tr><tr><td>VOLUME</td><td>åˆ›å»ºä¸€ä¸ªæŒ‚è½½ç‚¹ã€‚æ¯ä¸€è¡Œ VOLUME æŒ‡ä»¤éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å±‚ã€‚</td></tr><tr><td>LABEL</td><td>æ·»åŠ å…ƒæ•°æ®æ ‡ç­¾ã€‚æ¯ä¸€è¡Œ LABEL æŒ‡ä»¤éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å±‚ã€‚</td></tr></tbody></table><h2 id="Dockerfile-ç¤ºä¾‹-Spring-Boot-åº”ç”¨">Dockerfile ç¤ºä¾‹: Spring Boot åº”ç”¨</h2><ul class="lvl-0"><li class="lvl-2"><p>ç›®å½•ç»“æ„</p></li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">springbootweb/</span><br><span class="line">â”œâ”€â”€ Dockerfile</span><br><span class="line">â”œâ”€â”€ target/</span><br><span class="line">â”‚   â””â”€â”€ app.jar</span><br><span class="line">â”œâ”€â”€ <span class="type">static</span>-assets.tar.gz</span><br><span class="line">â””â”€â”€ ...</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>Dockerfile: æ³¨æ„ Dockerfile ä¸­æ‰€æœ‰å…³é”®å­—éƒ½è¦æ±‚å¤§å†™</p></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨è½»é‡çº§ Alpine ç‰ˆæœ¬çš„ OpenJDK 17 å®˜æ–¹é•œåƒï¼Œé€‚åˆéƒ¨ç½² Spring Boot åº”ç”¨</span></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">17</span>-alpine</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®æ„å»ºæ—¶å˜é‡ï¼Œé»˜è®¤ä½¿ç”¨æ„å»ºå¥½çš„ jar æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">ARG</span> JAR_FILE=target/app.jar</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®è¿è¡Œæ—¶ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_OPTS=<span class="string">&quot;-Xms1024M -Xmx1024M -XX:MetaspaceSize=128M -XX:MaxMetaspaceSize=128M&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"></span><br><span class="line"><span class="comment"># é•œåƒå…ƒä¿¡æ¯</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;yourname@example.com&quot;</span></span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> version=<span class="string">&quot;1.0.0&quot;</span></span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> description=<span class="string">&quot;ç”¨äºéƒ¨ç½² Spring Boot åº”ç”¨çš„ç”Ÿäº§çº§é•œåƒ&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å·¥ä½œç›®å½•</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹ RUNï¼šå®‰è£… curlï¼ˆç”¨äºå®¹å™¨å¥åº·æ£€æŸ¥æˆ–è°ƒè¯•ï¼‰</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk add --no-cache curl</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶ Spring Boot æ„å»ºç”Ÿæˆçš„ jar åŒ…</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> <span class="variable">$&#123;JAR_FILE&#125;</span> app.jar</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£å‹é™æ€èµ„æºåˆ°å®¹å™¨ä¸­ï¼ˆADD å¯ä»¥è‡ªåŠ¨è§£å‹ tar.gzï¼‰</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> static-assets.tar.gz /app/public/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å£°æ˜æš´éœ²çš„åº”ç”¨ç«¯å£ï¼ˆSpring Boot é»˜è®¤æ˜¯ 8080ï¼‰</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®¹å™¨å¥åº·æ£€æŸ¥ï¼šè®¿é—® actuator å¥åº·ç«¯ç‚¹</span></span><br><span class="line"><span class="keyword">HEALTHCHECK</span><span class="language-bash"> --interval=30s --<span class="built_in">timeout</span>=5s --retries=3 \</span></span><br><span class="line"><span class="language-bash">  CMD curl -f http://localhost:8080/app/actuator/health || <span class="built_in">exit</span> 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®¹å™¨ç»ˆæ­¢æ—¶ä¼˜é›…å…³é—­ï¼ˆJava æ¨è SIGTERMï¼‰</span></span><br><span class="line"><span class="keyword">STOPSIGNAL</span> SIGTERM</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å®¹å™¨å¯åŠ¨æ—¶çš„ä¸»å‘½ä»¤ï¼ˆENTRYPOINT ä¸ä¼šè¢« docker run å‚æ•°è¦†ç›–ï¼‰</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;java <span class="variable">$JAVA_OPTS</span> -jar app.jar&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CMD æä¾›é»˜è®¤çš„è¿è¡Œå‚æ•°ï¼Œå¯ä»¥è¢« docker run è¦†ç›–</span></span><br><span class="line"><span class="comment"># è¿™é‡Œé€šè¿‡ Spring Boot å‚æ•°è®¾ç½®å¯åŠ¨ç¯å¢ƒå’Œç«¯å£å·</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;--spring.profiles.active=app&quot;</span>, <span class="string">&quot;--server.port=8080&quot;</span>]</span></span><br><span class="line"><span class="comment"># è¿™é‡Œä½¿ç”¨çš„æ˜¯ ENTRYPOINT + CMD çš„æ··åˆæ¨¡å¼</span></span><br><span class="line"><span class="comment"># å®Œæ•´å‘½ä»¤ï¼š java $JAVA_OPTS -jar app.jar --spring.profiles.active=app --server.port=8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å£°æ˜ä¸€ä¸ªå·æŒ‚è½½ç‚¹ï¼Œè¿è¡Œå®¹å™¨æ—¶å¯å°†è¯¥è·¯å¾„æ˜ å°„åˆ°å®¿ä¸»æœºï¼Œå®ç°æ•°æ®æŒä¹…åŒ–</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> [<span class="string">&quot;/app/logs&quot;</span>]</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ„å»ºé•œåƒ</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ„å»ºé•œåƒæ—¶ç”¨ --build-arg æŒ‡å®šæ„å»ºå‚æ•°ï¼Œå¦‚æœéœ€è¦å¤šä¸ªï¼Œå°±é…ç½®å¤šä¸ª --build-arg</span></span><br><span class="line">docker build --build-arg JAR_FILE=target/app.jar -t springbootweb:latest .</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>è¿è¡Œå®¹å™¨</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name springbootweb \</span><br><span class="line">  -p 8080:8080 \</span><br><span class="line">  -e JAVA_OPTS=<span class="string">&quot;-Xms512m -Xmx1024m&quot;</span> \</span><br><span class="line">  -v /home/centos/logs/app/:/app/logs \</span><br><span class="line">  springbootweb:latest</span><br></pre></td></tr></table></figure><h2 id="Dockerfile-ç¤ºä¾‹-å¤šé˜¶æ®µæ„å»º">Dockerfile ç¤ºä¾‹: å¤šé˜¶æ®µæ„å»º</h2><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¬¬ä¸€é˜¶æ®µï¼šè·å–ä»£ç </span></span><br><span class="line"><span class="keyword">FROM</span> alpine/git AS fetcher</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /workspace/application</span></span><br><span class="line"><span class="comment"># å°†æ›¿æ¢ä¸ºå®é™…çš„Gitä»“åº“URLå’Œåˆ†æ”¯/æ ‡ç­¾</span></span><br><span class="line"><span class="keyword">ARG</span> GIT_REPOSITORY=https://gitee.com/hanqunfeng/springbootweb.git</span><br><span class="line"><span class="keyword">ARG</span> GIT_BRANCH=master</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> git <span class="built_in">clone</span> -b <span class="variable">$&#123;GIT_BRANCH&#125;</span> <span class="variable">$&#123;GIT_REPOSITORY&#125;</span> .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¬¬äºŒé˜¶æ®µï¼šä½¿ç”¨Mavenç¯å¢ƒè¿›è¡Œæ„å»º</span></span><br><span class="line"><span class="keyword">FROM</span> maven:<span class="number">3.8</span>.<span class="number">4</span>-openjdk-<span class="number">17</span> AS builder</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /workspace/application</span></span><br><span class="line"><span class="comment"># ä»ç¬¬ä¸€é˜¶æ®µå¤åˆ¶ä»£ç </span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=fetcher /workspace/application .</span></span><br><span class="line"><span class="comment"># ä½¿ç”¨Mavenæ¸…ç†å¹¶æ‰“åŒ…</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> mvn clean package -DskipTests</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¬¬ä¸‰é˜¶æ®µï¼šåˆ›å»ºæœ€ç»ˆçš„è¿è¡Œç¯å¢ƒ</span></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">17</span>-alpine</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="comment"># è®¾ç½®è¿è¡Œæ—¶ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_OPTS=<span class="string">&quot;-Xms1024M -Xmx1024M -XX:MetaspaceSize=128M -XX:MaxMetaspaceSize=128M&quot;</span></span><br><span class="line"><span class="comment"># å°†ç¬¬äºŒé˜¶æ®µç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶å¤åˆ¶åˆ°è¿™é‡Œã€‚æ³¨æ„è¿™é‡Œå‡è®¾ä½ çš„spring bootå·¥ç¨‹æ‰“æˆçš„jaråæ˜¯target/app.jar</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /workspace/application/target/app.jar app.jar</span></span><br><span class="line"><span class="comment"># æš´éœ²ç«¯å£ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰ã€‚è¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ç«¯å£å·</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"><span class="comment"># å£°æ˜ä¸€ä¸ªå·æŒ‚è½½ç‚¹ï¼Œè¿è¡Œå®¹å™¨æ—¶å¯å°†è¯¥è·¯å¾„æ˜ å°„åˆ°å®¿ä¸»æœºï¼Œå®ç°æ•°æ®æŒä¹…åŒ–</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> [<span class="string">&quot;/app/logs&quot;</span>]</span></span><br><span class="line"><span class="comment"># è®¾ç½®å®¹å™¨å¯åŠ¨æ—¶çš„ä¸»å‘½ä»¤ï¼ˆENTRYPOINT ä¸ä¼šè¢« docker run å‚æ•°è¦†ç›–ï¼‰</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;java <span class="variable">$JAVA_OPTS</span> -jar app.jar&quot;</span>]</span></span><br><span class="line"><span class="comment"># CMD æä¾›é»˜è®¤çš„è¿è¡Œå‚æ•°ï¼Œå¯ä»¥è¢« docker run è¦†ç›–</span></span><br><span class="line"><span class="comment"># è¿™é‡Œé€šè¿‡ Spring Boot å‚æ•°è®¾ç½®å¯åŠ¨ç¯å¢ƒå’Œç«¯å£å·</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;--spring.profiles.active=app&quot;</span>, <span class="string">&quot;--server.port=8080&quot;</span>]</span></span><br><span class="line"><span class="comment"># è¿™é‡Œä½¿ç”¨çš„æ˜¯ ENTRYPOINT + CMD çš„æ··åˆæ¨¡å¼</span></span><br><span class="line"><span class="comment"># å®Œæ•´å‘½ä»¤ï¼š java $JAVA_OPTS -jar app.jar --spring.profiles.active=app --server.port=8080</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ„å»ºé•œåƒ</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ„å»ºé•œåƒï¼Œ--no-cache è¡¨ç¤ºä¸ä½¿ç”¨ç¼“å­˜ï¼Œæ¯æ¬¡æ„å»ºéƒ½ä¼šé‡æ–°æ„å»º</span></span><br><span class="line">docker build --no-cache -t app:latest .</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>è¿è¡Œå®¹å™¨</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name app \</span><br><span class="line">  -p 8080:8080 \</span><br><span class="line">  -e JAVA_OPTS=<span class="string">&quot;-Xms512m -Xmx1024m&quot;</span> \</span><br><span class="line">  -v /home/centos/logs/app/:/app/logs \</span><br><span class="line">  app:latest</span><br></pre></td></tr></table></figure><h2 id="Dockerfile-è¯­æ³•æ£€æµ‹">Dockerfile è¯­æ³•æ£€æµ‹</h2><ul class="lvl-0"><li class="lvl-2"><p>åœ¨çº¿æ£€æŸ¥ï¼š<a href="https://hadolint.github.io/hadolint/">Dockerfile Linter</a></p></li><li class="lvl-2"><p>æœ¬åœ°æ£€æŸ¥ï¼š<a href="https://github.com/hadolint/hadolint">Haskell Dockerfile Linter</a>ï¼Œå¯ä»¥å®‰è£…å‘½ä»¤ï¼Œä¹Ÿå¯ä»¥é€šè¿‡dockerè¿è¡Œ</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…å‘½ä»¤</span></span><br><span class="line">wget -O /usr/local/bin/hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64</span><br><span class="line"><span class="built_in">chmod</span> +x /usr/local/bin/hadolint</span><br><span class="line">hadolint --version</span><br><span class="line"><span class="comment"># æ£€æŸ¥</span></span><br><span class="line">hadolint Dockerfile</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker è¿è¡Œ</span></span><br><span class="line">docker run --<span class="built_in">rm</span> -i hadolint/hadolint &lt; Dockerfile</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **åŠ ç²—**
 *æ–œä½“*
 ***åŠ ç²—å¹¶æ–œä½“***
 ~~åˆ é™¤çº¿~~
 ==çªå‡ºæ˜¾ç¤º==
 `çªå‡ºæ˜¾ç¤º(æ¨è)`
 ++ä¸‹åˆ’çº¿++
 ~ä¸‹æ ‡~
 ^ä¸Šæ ‡^
 è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.
 å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **ç‚¹å‡»æŠ˜å **
 è¿™æ˜¯è¢«éšè—çš„å†…å®¹
 +++

::: tips success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
:::

% note info % success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
% endnote %

å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}
 å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ
 --&gt;
&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ Dockerfile çš„ä½¿ç”¨æ–¹æ³•&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com&quot;&gt;Dockerå®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com/engine/reference/builder/&quot;&gt;Dockerfileå®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/docker/"/>
    
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>Docker å‘½ä»¤ ä¹‹ é•œåƒ(Image)</title>
    <link href="https://blog.hanqunfeng.com/2025/05/22/docker-command-image/"/>
    <id>https://blog.hanqunfeng.com/2025/05/22/docker-command-image/</id>
    <published>2025-05-22T13:30:05.000Z</published>
    <updated>2025-06-12T06:57:51.843Z</updated>
    
    <content type="html"><![CDATA[<!-- **åŠ ç²—** *æ–œä½“* ***åŠ ç²—å¹¶æ–œä½“*** ~~åˆ é™¤çº¿~~ ==çªå‡ºæ˜¾ç¤º== `çªå‡ºæ˜¾ç¤º(æ¨è)` ++ä¸‹åˆ’çº¿++ ~ä¸‹æ ‡~ ^ä¸Šæ ‡^ è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference. å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **ç‚¹å‡»æŠ˜å ** è¿™æ˜¯è¢«éšè—çš„å†…å®¹ +++::: tips success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹:::% note info % success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹% endnote %å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{} å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ --><h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2"><p>æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ é•œåƒç®¡ç† ç›¸å…³å‘½ä»¤</p></li><li class="lvl-2"><p><a href="https://docs.docker.com">Dockerå®˜æ–¹æ–‡æ¡£</a></p></li><li class="lvl-2"><p><a href="https://docs.docker.com/reference/#application-programming-interfaces-apis">Application programming interfaces (APIs)</a></p></li></ul><span id="more"></span><h2 id="docker-search-æœç´¢é•œåƒ"><code>docker search</code> : æœç´¢é•œåƒ</h2><ul class="lvl-0"><li class="lvl-2"><p>æ¨èåœ¨<a href="https://hub.docker.com/">dockerhub</a>ä¸Šæœç´¢é•œåƒï¼Œä»¥è·å–æ›´è¯¦ç»†çš„é•œåƒä¿¡æ¯ã€‚</p></li><li class="lvl-2"><p>å›½å†…ä¹Ÿå¯ä»¥é€šè¿‡<a href="https://1ms.run/">æ¯«ç§’é•œåƒ</a>,<a href="https://dockers.xuanyuan.me">è½©è¾• Docker é•œåƒæœç´¢</a>æ¥æœç´¢é•œåƒã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ docker search --<span class="built_in">help</span></span><br><span class="line">ç”¨æ³•:  docker search [OPTIONS] TERM</span><br><span class="line"></span><br><span class="line">åœ¨ Docker Hub ä¸­æœç´¢é•œåƒ</span><br><span class="line"></span><br><span class="line">é€‰é¡¹:</span><br><span class="line">  -f, --filter filter   æ ¹æ®æä¾›çš„æ¡ä»¶è¿‡æ»¤è¾“å‡ºï¼Œå¸¸è§çš„è¿‡æ»¤æ¡ä»¶åŒ…æ‹¬ï¼šstarsï¼ˆæ˜Ÿçº§ï¼‰ã€is-officialï¼ˆæ˜¯å¦ä¸ºå®˜æ–¹é•œåƒï¼‰</span><br><span class="line">      --format string   ä½¿ç”¨ Go æ¨¡æ¿ç¾åŒ–è¾“å‡ºï¼Œä¸å¤ªå¸¸ç”¨</span><br><span class="line">      --<span class="built_in">limit</span> int       æœç´¢ç»“æœçš„æœ€å¤§æ•°é‡</span><br><span class="line">      --no-trunc        ä¸æˆªæ–­è¾“å‡ºå†…å®¹ï¼Œæ˜¾ç¤ºå®Œæ•´ä¿¡æ¯ï¼ˆé»˜è®¤è¾“å‡ºä¸­æŸäº›å­—æ®µå¦‚æè¿°å¯èƒ½è¢«æˆªæ–­ï¼‰</span><br></pre></td></tr></table></figure><h3 id="ç¤ºä¾‹">ç¤ºä¾‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æœç´¢åç§°ä¸­åŒ…å« nginx çš„é•œåƒ</span></span><br><span class="line">$ docker search nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># æœç´¢åç§°ä¸­åŒ…å« nginx ä¸”æ˜Ÿçº§ä¸å°‘äº 100 çš„é•œåƒã€‚</span></span><br><span class="line">$ docker search -f stars=100 nginx</span><br><span class="line"><span class="comment"># æœç´¢å®˜æ–¹é•œåƒ</span></span><br><span class="line">$ docker search -f is-official=<span class="literal">true</span> nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># æœç´¢ nginxï¼ŒæŒ‰ç…§æŒ‡å®šæ¨¡æ¿æ ¼å¼åŒ–è¾“å‡º</span></span><br><span class="line">$ docker search nginx --format <span class="string">&quot;&#123;&#123;.Name&#125;&#125;: &#123;&#123;.StarCount&#125;&#125; stars:  &#123;&#123;.Description&#125;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æœç´¢nginxé•œåƒï¼Œå¹¶é™åˆ¶5ä¸ªç»“æœ</span></span><br><span class="line">$ docker search nginx --<span class="built_in">limit</span> 5</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»„åˆä½¿ç”¨å¤šä¸ªé€‰é¡¹</span></span><br><span class="line">$ docker search -f stars=100 --<span class="built_in">limit</span> 5 --no-trunc nginx</span><br></pre></td></tr></table></figure><div class="tips"><p><em><strong><code>docker search</code> å‘½ä»¤æŠ¥é”™çš„è§£å†³æ–¹æ³•</strong></em></p><ul class="lvl-1"><li class="lvl-2">ç›®å‰å›½å†…ä½¿ç”¨<code>docker search</code>æ—¶ä¼šå‡ºç°<code>Error response from daemon: Get &quot;https://index.docker.io/v1/search?q=nginx&amp;n=25&quot;: dial tcp 210.56.51.193:443: i/o timeout</code>çš„é”™è¯¯ï¼Œå³ä¾¿æˆ‘ä»¬é…ç½®äº†å›½å†…çš„é•œåƒæºï¼Œè¿™ä¸ªé”™è¯¯è¿˜æ˜¯ä¼šå­˜åœ¨ã€‚</li><li class="lvl-2">å³ä¾¿ä¸ºå®¿ä¸»æœºå’Œdockeréƒ½é…ç½®ä¸ŠDNSä¹Ÿä¾ç„¶ä¼šæŠ¥é”™ã€‚</li><li class="lvl-2">ä¸è¿‡å¯ä»¥é€šè¿‡ç¬¬ä¸‰æ–¹é•œåƒä»“åº“è¿›è¡ŒæŸ¥è¯¢ï¼Œæ¯”å¦‚åœ¨æŸ¥è¯¢çš„é•œåƒåç§°å‰åŠ ä¸Š <code>docker.1ms.run/</code>ï¼Œæ¯”å¦‚æŸ¥è¯¢<code>nginx</code>é•œåƒï¼Œåˆ™è¾“å…¥<code>docker search docker.1ms.run/nginx</code>ï¼Œè¿™é‡Œè¦æ³¨æ„å¹¶ä¸æ˜¯æ‰€æœ‰çš„ç¬¬ä¸‰æ–¹é•œåƒä»“åº“éƒ½æ”¯æŒæŸ¥è¯¢ã€‚</li><li class="lvl-2">å¯ä»¥ç¼–å†™ä¸€ä¸ªè„šæœ¬<code>docker_search</code>ï¼ŒæŸ¥è¯¢é•œåƒå¹¶è¾“å‡ºç»“æœï¼Œå¦‚ä¸‹ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span> &gt; docker_search</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">QUERY=<span class="variable">$&#123;1&#125;</span>     <span class="comment"># æŸ¥è¯¢å…³é”®è¯ï¼Œè¿™é‡Œè¦æ³¨æ„ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»æ˜¯æŸ¥è¯¢å…³é”®è¯</span></span><br><span class="line"><span class="comment"># è·å–é™¤ç¬¬ä¸€ä¸ªå‚æ•°å¤–çš„æ‰€æœ‰å‚æ•°</span></span><br><span class="line">ARGS=<span class="variable">$&#123;@:2&#125;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;æŸ¥è¯¢é•œåƒï¼šdocker search docker.1ms.run/<span class="variable">$QUERY</span> <span class="variable">$ARGS</span>&quot;</span></span><br><span class="line">docker search docker.1ms.run/<span class="variable">$QUERY</span> <span class="variable">$ARGS</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®æ‰§è¡Œæƒé™</span></span><br><span class="line"><span class="built_in">chmod</span> +x docker_search</span><br><span class="line"><span class="comment"># å°†å…¶ç§»åŠ¨åˆ° /usr/local/bin/</span></span><br><span class="line"><span class="built_in">mv</span> docker_search /usr/local/bin/docker_search</span><br><span class="line"><span class="comment"># å¦‚æœ/usr/local/bin/æ²¡æœ‰åœ¨PATHä¸­ï¼Œè¯·æ·»åŠ åˆ°ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;export PATH=<span class="variable">$PATH</span>:/usr/local/sbin&quot;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br><span class="line"><span class="comment"># æµ‹è¯•</span></span><br><span class="line">docker_search redis -f stars=100 --<span class="built_in">limit</span> 5 --no-trunc</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">NAME                DESCRIPTION                                                                                       STARS     OFFICIAL</span><br><span class="line">redis               Redis is the worldâ€™s fastest data platform <span class="keyword">for</span> caching, vector search, and NoSQL databases.      13315     [OK]</span><br><span class="line">redis/redis-stack   redis-stack installs a Redis server with additional database capabilities and the RedisInsight.   149</span><br><span class="line">bitnami/redis       Bitnami container image <span class="keyword">for</span> Redis</span><br></pre></td></tr></table></figure><ul class="lvl-1"><li class="lvl-2">åŸºäºurlæœç´¢ï¼Œæ”¯æŒåˆ†é¡µï¼Œä½†ä¸èƒ½æ”¯æŒå…¶å®ƒsearchå‚æ•°</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">&#x27;EOF&#x27;</span> &gt; docker_search_by_url</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å‚æ•°å¤„ç†</span></span><br><span class="line">QUERY=<span class="variable">$&#123;1:-nginx&#125;</span>     <span class="comment"># é»˜è®¤æŸ¥è¯¢å…³é”®è¯</span></span><br><span class="line">N=<span class="variable">$&#123;2:-25&#125;</span>            <span class="comment"># é»˜è®¤æ¯é¡µæ¡æ•°</span></span><br><span class="line">PAGE=<span class="variable">$&#123;3:-1&#125;</span>          <span class="comment"># é»˜è®¤é¡µç </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é•œåƒæºåˆ—è¡¨ï¼šä¾æ¬¡å°è¯•è®¿é—®è¿™äº›åŸŸåï¼Œè¿™é‡Œè¦æ³¨æ„ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„é•œåƒæºéƒ½æ”¯æŒæœç´¢åŠŸèƒ½</span></span><br><span class="line">REGISTRIES=(</span><br><span class="line">  <span class="string">&quot;docker.1ms.run&quot;</span></span><br><span class="line">  <span class="string">&quot;register.librax.org&quot;</span></span><br><span class="line">  <span class="comment"># ä½ å¯ä»¥ç»§ç»­æ·»åŠ å¤‡ç”¨åŸŸå</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–æˆåŠŸæ ‡å¿—</span></span><br><span class="line">WORKING_URL=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># éå†åŸŸåï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯è®¿é—®çš„</span></span><br><span class="line"><span class="keyword">for</span> REG <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;REGISTRIES[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">  TEST_URL=<span class="string">&quot;https://<span class="variable">$&#123;REG&#125;</span>/v1/search?q=test&amp;n=1&quot;</span></span><br><span class="line">  <span class="keyword">if</span> curl -s --connect-timeout 2 <span class="string">&quot;<span class="variable">$TEST_URL</span>&quot;</span> | grep -q <span class="string">&#x27;&quot;results&quot;&#x27;</span>; <span class="keyword">then</span></span><br><span class="line">    WORKING_URL=<span class="string">&quot;https://<span class="variable">$&#123;REG&#125;</span>/v1/search?q=<span class="variable">$&#123;QUERY&#125;</span>&amp;n=<span class="variable">$&#123;N&#125;</span>&amp;page=<span class="variable">$&#123;PAGE&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">break</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœéƒ½å¤±è´¥ï¼Œé€€å‡º</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$WORKING_URL</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;âŒ æ— æ³•è¿æ¥ä»»ä½•é•œåƒæºï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–å¤‡ç”¨åŸŸåè®¾ç½®ã€‚&quot;</span></span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯·æ±‚æ•°æ®å¹¶æ ¼å¼åŒ–è¾“å‡º</span></span><br><span class="line">curl -s <span class="string">&quot;<span class="variable">$WORKING_URL</span>&quot;</span> \</span><br><span class="line">| jq -r <span class="string">&#x27;[&quot;NAME&quot;,&quot;STARS&quot;,&quot;OFFICIAL&quot;,&quot;DESCRIPTION&quot;],</span></span><br><span class="line"><span class="string">         (.results[] |</span></span><br><span class="line"><span class="string">         [.name,</span></span><br><span class="line"><span class="string">          (.star_count|tostring),</span></span><br><span class="line"><span class="string">          (if .is_official then &quot;[OK]&quot; else &quot;&quot; end),</span></span><br><span class="line"><span class="string">          .description])</span></span><br><span class="line"><span class="string">         | @tsv&#x27;</span> \</span><br><span class="line">| column -t -s $<span class="string">&#x27;\t&#x27;</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></div><h2 id="docker-image-é•œåƒç®¡ç†"><code>docker image</code> : é•œåƒç®¡ç†</h2><ul class="lvl-0"><li class="lvl-2"><p><code>docker image --help</code></p></li></ul><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th><th>åˆ«å(ç®€å†™)</th></tr></thead><tbody><tr><td>build</td><td>ä» Dockerfile æ„å»ºä¸€ä¸ªé•œåƒ</td><td>docker build</td></tr><tr><td>history</td><td>æ˜¾ç¤ºé•œåƒçš„å†å²è®°å½•</td><td>docker history</td></tr><tr><td>import</td><td>ä» tar åŒ…å¯¼å…¥å†…å®¹ä»¥åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿé•œåƒ</td><td>docker import</td></tr><tr><td>inspect</td><td>æ˜¾ç¤ºä¸€ä¸ªæˆ–å¤šä¸ªé•œåƒçš„è¯¦ç»†ä¿¡æ¯</td><td>å¯ä»¥ä½¿ç”¨ <code>docker inspect</code></td></tr><tr><td>load</td><td>ä» tar å½’æ¡£æˆ–æ ‡å‡†è¾“å…¥ä¸­åŠ è½½é•œåƒ</td><td>docker load</td></tr><tr><td>ls</td><td>åˆ—å‡ºé•œåƒ</td><td>docker images</td></tr><tr><td>prune</td><td>ç§»é™¤æœªä½¿ç”¨çš„é•œåƒ</td><td></td></tr><tr><td>pull</td><td>ä»é•œåƒä»“åº“ä¸‹è½½é•œåƒ</td><td>docker pull</td></tr><tr><td>push</td><td>ä¸Šä¼ é•œåƒåˆ°é•œåƒä»“åº“</td><td>docker push</td></tr><tr><td>rm</td><td>ç§»é™¤ä¸€ä¸ªæˆ–å¤šä¸ªé•œåƒ</td><td>docker rmi</td></tr><tr><td>save</td><td>å°†ä¸€ä¸ªæˆ–å¤šä¸ªé•œåƒä¿å­˜ä¸º tar å½’æ¡£ï¼ˆé»˜è®¤è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼‰</td><td>docker save</td></tr><tr><td>tag</td><td>åˆ›å»ºä¸€ä¸ªæ ‡ç­¾ TARGET_IMAGE æŒ‡å‘ SOURCE_IMAGE</td><td>docker tag</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>è¿è¡Œ <code>docker image COMMAND --help</code> å¯è·å–æŸä¸ªå‘½ä»¤çš„æ›´å¤šä¿¡æ¯ã€‚</p></li></ul><h3 id="docker-pull-æ‹‰å–é•œåƒ"><code>docker pull</code> : æ‹‰å–é•œåƒ</h3><ul class="lvl-0"><li class="lvl-2"><p><code>docker image pull</code> == <code>docker pull</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å‘½ä»¤æ ¼å¼ï¼Œä¸åŠ tagé»˜è®¤æ‹‰å– :latest</span></span><br><span class="line">$ docker pull &lt;image_name&gt;[:&lt;tag&gt;]</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹‰å–nginxé•œåƒï¼Œé»˜è®¤æ‹‰å–æœ€æ–°ç‰ˆæœ¬ï¼šlatestï¼Œnginxæ˜¯å®˜æ–¹é•œåƒï¼Œå®Œæ•´åç§°å®é™…ä¸Šæ˜¯ library/nginx</span></span><br><span class="line">$ docker pull nginx  ==  docker pull library/nginx  ==  docker pull nginx:latest</span><br><span class="line"><span class="comment"># æ‹‰å–æŒ‡å®štagçš„é•œåƒ</span></span><br><span class="line">$ docker pull nginx:1.28.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹‰å–éå®˜æ–¹é•œåƒï¼Œç”¨æˆ·ä¸Šä¼ çš„</span></span><br><span class="line">$ docker pull hanqunfeng/alpine-jre8-slim:1.0.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‹‰å–æŒ‡å®šå¹³å°çš„é•œåƒï¼Œå¦‚æœä¸æŒ‡å®š --platform å‚æ•°ï¼Œé»˜è®¤ä¼šæ‹‰å–ä¸ä½ å½“å‰ Docker å®¢æˆ·ç«¯è¿è¡Œå¹³å°åŒ¹é…çš„é•œåƒï¼Œé€šè¿‡ docker version æŸ¥çœ‹</span></span><br><span class="line">$ docker pull --platform=linux/amd64 nginx:latest</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åœ¨ <a href="/2025/05/20/docker-install/" title="Linux å®‰è£… Docker">Linux å®‰è£… Docker</a> ä¸­ä»‹ç»äº†å¦‚é…ç½®å›½å†…çš„é•œåƒåŠ é€Ÿæºæ¥åŠ å¿«é•œåƒçš„æ‹‰å–ï¼Œä½†æ˜¯å›½å†…é•œåƒæºä¸ç¨³å®šï¼Œéšæ—¶éƒ½æœ‰å¯èƒ½ä¸å¯ç”¨ï¼Œè€Œä¸”æ¯æ¬¡é‡æ–°é…ç½®é•œåƒæºè¿˜éœ€è¦é‡å¯Dockerï¼Œå¯ä»¥ç¼–å†™ä¸€ä¸ªè„šæœ¬æ¥å®Œæˆ<code>pull</code>ï¼Œè¿™æ ·æ¯æ¬¡æ›´æ–°é•œåƒæºæ—¶åªéœ€è¦ä¿®æ”¹è„šæœ¬ï¼Œè€Œä¸éœ€è¦é‡å¯Dockeräº†ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è„šæœ¬åç§°ï¼šdocker_pull</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”¨æ³•æ£€æŸ¥</span></span><br><span class="line"><span class="keyword">if</span> [[ -z <span class="string">&quot;<span class="variable">$1</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;ç”¨æ³•: <span class="variable">$0</span> &lt;é•œåƒå&gt;ï¼Œä¾‹å¦‚ï¼šdocker_pull redis, docker_pull nginx --platform=linux/arm64&quot;</span></span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åŸå§‹é•œåƒåç§°ï¼Œä¾‹å¦‚ nginx æˆ– someuser/imageï¼Œè¦æ±‚ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»æ˜¯é•œåƒåç§°</span></span><br><span class="line">ORIGINAL_IMAGE_NAME=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–é™¤ç¬¬ä¸€ä¸ªå‚æ•°å¤–çš„æ‰€æœ‰å‚æ•°</span></span><br><span class="line">ARGS=<span class="variable">$&#123;@:2&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é•œåƒæºåˆ—è¡¨ï¼Œä¿®æ”¹é•œåƒæºæ—¶åªéœ€è¦ä¿®æ”¹è¯¥åˆ—è¡¨å³å¯</span></span><br><span class="line">MIRROR_LIST=(</span><br><span class="line">  <span class="string">&quot;docker.1ms.run&quot;</span></span><br><span class="line">  <span class="string">&quot;docker.xuanyuan.me&quot;</span></span><br><span class="line">  <span class="string">&quot;docker.m.daocloud.io&quot;</span></span><br><span class="line">  <span class="string">&quot;docker.1panel.live&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœé•œåƒåä¸­ä¸åŒ…å« &quot;/&quot;ï¼ŒåŠ ä¸Š &quot;library/&quot;</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$ORIGINAL_IMAGE_NAME</span>&quot;</span> != *<span class="string">&quot;/&quot;</span>* ]]; <span class="keyword">then</span></span><br><span class="line">  IMAGE_NAME=<span class="string">&quot;library/<span class="variable">$ORIGINAL_IMAGE_NAME</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  IMAGE_NAME=<span class="string">&quot;<span class="variable">$ORIGINAL_IMAGE_NAME</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># éå†é•œåƒæº</span></span><br><span class="line"><span class="keyword">for</span> MIRROR <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;MIRROR_LIST[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">  FULL_IMAGE=<span class="string">&quot;<span class="variable">$MIRROR</span>/<span class="variable">$IMAGE_NAME</span>&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;å°è¯•ä» <span class="variable">$FULL_IMAGE</span> <span class="variable">$ARGS</span> æ‹‰å–é•œåƒ...&quot;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;docker pull <span class="variable">$&#123;FULL_IMAGE&#125;</span> <span class="variable">$&#123;ARGS&#125;</span>&quot;</span></span><br><span class="line">  <span class="keyword">if</span> docker pull <span class="variable">$&#123;FULL_IMAGE&#125;</span> <span class="variable">$&#123;ARGS&#125;</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;æˆåŠŸæ‹‰å–é•œåƒï¼š<span class="variable">$FULL_IMAGE</span> <span class="variable">$ARGS</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å°†é•œåƒé‡å‘½åä¸ºå»é™¤é•œåƒæºå‰ç¼€çš„ç‰ˆæœ¬</span></span><br><span class="line">    docker tag <span class="string">&quot;<span class="variable">$FULL_IMAGE</span>&quot;</span> <span class="string">&quot;<span class="variable">$ORIGINAL_IMAGE_NAME</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;é•œåƒé‡å‘½åä¸ºï¼š<span class="variable">$ORIGINAL_IMAGE_NAME</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯é€‰ï¼šåˆ é™¤å¸¦é•œåƒæºå‰ç¼€çš„é•œåƒ</span></span><br><span class="line">    docker rmi <span class="string">&quot;<span class="variable">$FULL_IMAGE</span>&quot;</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;ä» <span class="variable">$MIRROR</span> æ‹‰å–å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ªé•œåƒæº...&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;æ‰€æœ‰é•œåƒæºå°è¯•å¤±è´¥ï¼Œæ— æ³•æ‹‰å–é•œåƒï¼š<span class="variable">$ORIGINAL_IMAGE_NAME</span> <span class="variable">$ARGS</span>&quot;</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br></pre></td></tr></table></figure><div class="tips"><p><em><strong>å¦‚ä½•è·å–é•œåƒtag</strong></em></p><ul class="lvl-1"><li class="lvl-2">docker å‘½ä»¤ä¸­æ²¡æœ‰æä¾›ç›´æ¥è·å–é•œåƒtagçš„å‘½ä»¤ï¼Œå¦‚æœä¸æƒ³åˆ°<code>dockerhub</code>ä¸ŠæŸ¥çœ‹ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼è·å–</li><li class="lvl-2">é€šè¿‡dockerhubçš„apiæ¥å£è·å–(éœ€è¦ç§‘å­¦ä¸Šç½‘)</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åªæ˜¾ç¤ºtagåç§°ï¼Œå®˜æ–¹é•œåƒæ›¿æ¢ nginxï¼Œéå®˜æ–¹é•œåƒæ›¿æ¢ libryary/nginxï¼Œpage_size=5è¡¨ç¤ºæ¯é¡µ5æ¡æ•°æ®ï¼Œpage=1è¡¨ç¤ºç¬¬ä¸€é¡µï¼ˆé»˜è®¤ä¸º1ï¼‰</span></span><br><span class="line">curl -s <span class="string">&quot;https://registry.hub.docker.com/v2/repositories/library/nginx/tags?page_size=5&amp;page=1&quot;</span> | jq <span class="string">&#x27;.results[].name&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## ä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹urlï¼Œä¸¤è€…æ•ˆæœç›¸åŒ</span></span><br><span class="line"><span class="comment">## https://hub.docker.com/v2/namespaces/&#123;namespace&#125;/repositories/&#123;repository&#125;/tags?page_size=5&amp;page=1</span></span><br><span class="line"><span class="comment">## ç¤ºä¾‹ï¼šhttps://hub.docker.com/v2/namespaces/library/repositories/nginx/tags?page_size=1&amp;page=1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºjsonæ ¼å¼ï¼Œå¹¶æ˜¾ç¤ºæœ€åæ›´æ–°æ—¶é—´å’Œé•œåƒå¤§å°</span></span><br><span class="line">curl -s <span class="string">&quot;https://registry.hub.docker.com/v2/repositories/library/nginx/tags?page_size=5&amp;page=1&quot;</span> | jq <span class="string">&#x27;.results[] | &#123;name,last_updated,full_size&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºè¡¨æ ¼æ ¼å¼ï¼Œå¹¶æ ¼å¼åŒ–è¾“å‡º</span></span><br><span class="line">curl -s <span class="string">&quot;https://registry.hub.docker.com/v2/repositories/library/nginx/tags?page_size=5&amp;page=1&quot;</span> \</span><br><span class="line">| jq -r <span class="string">&#x27;.results[] |</span></span><br><span class="line"><span class="string">  &quot;\(.name)\t\t\(.last_updated | sub(&quot;T&quot;; &quot; &quot;) | sub(&quot;\\..*&quot;; &quot;&quot;))\t\t\(((.full_size / 1024 / 1024 * 100 | round)/100) | tostring) MB&quot;&#x27;</span> \</span><br><span class="line">  | awk <span class="string">&#x27;&#123;printf &quot;%-30s %-20s %8.2f MB\n&quot;, $1, $2&quot; &quot;$3, $4&#125;&#x27;</span></span><br></pre></td></tr></table></figure><ul class="lvl-1"><li class="lvl-2">é€šè¿‡<a href="https://github.com/containers/skopeo">skopeo</a>å·¥å…·è·å–</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿™é‡Œä½¿ç”¨å®¹å™¨çš„æ–¹å¼(éœ€è¦ç§‘å­¦ä¸Šç½‘)</span></span><br><span class="line">docker run --<span class="built_in">rm</span> quay.io/skopeo/stable:latest inspect --override-os linux  docker://docker.io/nginx | jq <span class="string">&#x27;.RepoTags[]&#x27;</span></span><br><span class="line"><span class="comment"># å°†`docker.io`æ›¿æ¢ä¸ºé•œåƒæº`docker.1ms.run`ï¼Œä¸éœ€è¦ç§‘å­¦ä¸Šç½‘</span></span><br><span class="line">docker run --<span class="built_in">rm</span> quay.io/skopeo/stable:latest inspect --override-os linux  docker://docker.1ms.run/nginx | jq <span class="string">&#x27;.RepoTags[]&#x27;</span></span><br></pre></td></tr></table></figure><ul class="lvl-1"><li class="lvl-2">ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨å¯ä»¥ç¼–å†™ä¸€ä¸ªè„šæœ¬</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; docker_tags</span></span><br><span class="line"><span class="string">#!/bin/bash</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># ç”¨æ³•æç¤º</span></span><br><span class="line"><span class="string">if [ -z &quot;\$1&quot; ]; then</span></span><br><span class="line"><span class="string">  echo &quot;ç”¨æ³•: \$0 &lt;é•œåƒåç§°ï¼Œä¾‹å¦‚ nginx æˆ– library/nginx&gt;&quot;</span></span><br><span class="line"><span class="string">  exit 1</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">IMAGE_NAME=\$1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># ä½¿ç”¨ skopeo è·å–é•œåƒä¿¡æ¯å¹¶è§£ææ ‡ç­¾åˆ—è¡¨</span></span><br><span class="line"><span class="string">docker run --rm quay.io/skopeo/stable:latest \\</span></span><br><span class="line"><span class="string">  inspect --override-os linux docker://docker.1ms.run/\$IMAGE_NAME \\</span></span><br><span class="line"><span class="string">  | jq &#x27;.RepoTags[]&#x27;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">chmod</span> +x docker_tags</span><br><span class="line"><span class="comment"># ä½¿ç”¨</span></span><br><span class="line">docker_tags nginx</span><br></pre></td></tr></table></figure></div><h3 id="docker-images-åˆ—å‡ºé•œåƒ"><code>docker images</code> : åˆ—å‡ºé•œåƒ</h3><ul class="lvl-0"><li class="lvl-2"><p><code>docker image ls</code> == <code>docker images</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ—å‡ºæ‰€æœ‰é•œåƒï¼Œä¸åŒ…æ‹¬æ‚¬ç©ºé•œåƒï¼Œï¼ˆdangling images:æ²¡æœ‰ tag çš„é•œåƒ,é€šå¸¸æ˜¯æ„å»ºä¸­é—´äº§ç‰©,ä¾‹å¦‚ï¼š&lt;none&gt;:&lt;none&gt; å½¢å¼ã€‚ï¼‰</span></span><br><span class="line">$ docker images</span><br><span class="line"><span class="comment"># åˆ—å‡ºæ‰€æœ‰é•œåƒï¼ŒåŒ…æ‹¬æ‚¬ç©ºé•œåƒ</span></span><br><span class="line">$ docker images -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—å‡ºæ‰€æœ‰é•œåƒï¼Œå¹¶æ˜¾ç¤ºé•œåƒçš„æ‘˜è¦ä¿¡æ¯</span></span><br><span class="line">$ docker images --digests</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ—å‡ºæ‰€æœ‰é•œåƒï¼Œå¹¶è¾“å‡ºä¸ºjsonæ ¼å¼</span></span><br><span class="line">$ docker images --format json</span><br><span class="line"><span class="comment"># åªæ˜¾ç¤ºé•œåƒåç§°å’Œæ ‡ç­¾</span></span><br><span class="line">$ docker images --format <span class="string">&quot;&#123;&#123;.Repository&#125;&#125;:&#123;&#123;.Tag&#125;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åªæ˜¾ç¤ºé•œåƒID</span></span><br><span class="line">$ docker images -q</span><br></pre></td></tr></table></figure><h3 id="docker-inspect-æŸ¥çœ‹é•œåƒçš„è¯¦ç»†ä¿¡æ¯"><code>docker inspect</code> : æŸ¥çœ‹é•œåƒçš„è¯¦ç»†ä¿¡æ¯</h3><ul class="lvl-0"><li class="lvl-2"><p><code>docker image inspect</code> == <code>docker inspect</code></p></li><li class="lvl-2"><p>è¿™é‡Œè¦æ³¨æ„ï¼Œ<code>docker inspect</code>å¦‚æœåŸºäºåç§°æŸ¥æ‰¾ä¼šä¼˜å…ˆæŸ¥æ‰¾å®¹å™¨</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å‘½ä»¤æ ¼å¼</span></span><br><span class="line">$ docker inspect [OPTIONS] NAME|ID [NAME|ID...]</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ˜¾ç¤ºé•œåƒçš„è¯¦ç»†ä¿¡æ¯ï¼Œé•œåƒåç§°</span></span><br><span class="line">$ docker inspect nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ˜¾ç¤ºé•œåƒçš„è¯¦ç»†ä¿¡æ¯ï¼Œé•œåƒID</span></span><br><span class="line">$ docker inspect 9f0c0d0a0f0f</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ˜¾ç¤ºé•œåƒçš„Labelsä¿¡æ¯ï¼Œè·å–jsonä¸­æŒ‡å®šçš„å­—æ®µ</span></span><br><span class="line">$ docker image inspect --format=<span class="string">&#x27;&#123;&#123;json .Config.Labels&#125;&#125;&#x27;</span> nginx</span><br></pre></td></tr></table></figure><h3 id="docker-image-prune-åˆ é™¤æœªä½¿ç”¨çš„é•œåƒ"><code>docker image prune</code> : åˆ é™¤æœªä½¿ç”¨çš„é•œåƒ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ é™¤æ‚¬ç©ºé•œåƒï¼Œï¼ˆdangling images:æ²¡æœ‰ tag çš„é•œåƒ,é€šå¸¸æ˜¯æ„å»ºä¸­é—´äº§ç‰©,ä¾‹å¦‚ï¼š&lt;none&gt;:&lt;none&gt; å½¢å¼ã€‚ï¼‰</span></span><br><span class="line">$ docker image prune</span><br><span class="line"><span class="comment"># åˆ é™¤å…¨éƒ¨æœªä½¿ç”¨é•œåƒ(æœªè¢«ä»»ä½•ä¸€ä¸ªå®¹å™¨å¼•ç”¨)ï¼ŒåŒ…æ‹¬æ‚¬ç©ºé•œåƒ</span></span><br><span class="line">$ docker image prune -a</span><br><span class="line"><span class="comment"># ä¸è¿›è¡Œç¡®è®¤æç¤ºï¼Œç›´æ¥æ‰§è¡Œ</span></span><br><span class="line">$ docker image prune -f</span><br></pre></td></tr></table></figure><h3 id="docker-rmi-åˆ é™¤é•œåƒ"><code>docker rmi</code> : åˆ é™¤é•œåƒ</h3><ul class="lvl-0"><li class="lvl-2"><p><code>docker image rm</code> == <code>docker rmi</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å‘½ä»¤æ ¼å¼</span></span><br><span class="line">$ docker rmi [OPTIONS] IMAGE [IMAGE...]</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤é•œåƒï¼Œé•œåƒåç§°</span></span><br><span class="line">$ docker rmi nginx</span><br><span class="line"><span class="comment"># åˆ é™¤å¤šä¸ªé•œåƒï¼Œç©ºæ ¼åˆ†éš”</span></span><br><span class="line">$ docker rmi nginx mysql</span><br><span class="line"><span class="comment"># åˆ é™¤é•œåƒï¼Œé•œåƒID</span></span><br><span class="line">$ docker rmi 9f0c0d0a0f0f</span><br><span class="line"><span class="comment"># å¼ºåˆ¶åˆ é™¤é•œåƒï¼Œå½“é•œåƒè¢«å®¹å™¨å¼•ç”¨æ—¶ï¼Œä¼šæŠ¥é”™ï¼Œéœ€è¦ä½¿ç”¨-få‚æ•°è¿›è¡Œå¼ºåˆ¶åˆ é™¤</span></span><br><span class="line">$ docker rmi -f nginx</span><br><span class="line"><span class="comment"># åˆ é™¤å…¨éƒ¨é•œåƒ</span></span><br><span class="line">$ docker rmi $(docker images -q)</span><br></pre></td></tr></table></figure><h3 id="docker-history-æŸ¥çœ‹é•œåƒçš„æ„å»ºå†å²"><code>docker history</code> : æŸ¥çœ‹é•œåƒçš„æ„å»ºå†å²</h3><ul class="lvl-0"><li class="lvl-2"><p><code>docker image history</code> == <code>docker history</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å‘½ä»¤æ ¼å¼</span></span><br><span class="line">$ docker <span class="built_in">history</span> [OPTIONS] IMAGE</span><br><span class="line"><span class="comment"># æŸ¥çœ‹é•œåƒçš„å†å²è®°å½•ï¼Œé•œåƒåç§°</span></span><br><span class="line">$ docker <span class="built_in">history</span> nginx</span><br><span class="line"><span class="comment"># æŸ¥çœ‹é•œåƒçš„å†å²è®°å½•ï¼Œé•œåƒID</span></span><br><span class="line">$ docker <span class="built_in">history</span> 9f0c0d0a0f0f</span><br><span class="line"><span class="comment"># æ˜¾ç¤ºå®Œæ•´çš„é•œåƒå†å²è®°å½•ï¼Œé»˜è®¤`CREATED BY`ä¸­çš„ä¿¡æ¯å¤ªé•¿ä¼šè¢«æˆªæ–­</span></span><br><span class="line">$ docker <span class="built_in">history</span> --no-trunc nginx</span><br><span class="line"><span class="comment"># æ˜¾ç¤ºä¸ºjsonæ ¼å¼</span></span><br><span class="line">$ docker <span class="built_in">history</span> --format=json nginx</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>docker history</code> æ˜¾ç¤ºçš„æ˜¯æ„å»ºå†å²ï¼Œä¼šå°†æ¯ä¸€ä¸ª Dockerfile æŒ‡ä»¤éƒ½ç®—ä¸€å±‚ï¼Œè€Œä¸æ˜¯ç‰©ç†é•œåƒå±‚ï¼ˆlayerï¼‰æ•°é‡ï¼Œè‹¥è¦æŸ¥çœ‹é•œåƒçš„ç‰©ç†å±‚æ•°ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker image inspect --format <span class="string">&#x27;&#123;&#123; len .RootFS.Layers &#125;&#125;&#x27;</span> nginx</span><br></pre></td></tr></table></figure><h3 id="docker-tag-åˆ›å»ºä¸€ä¸ªæ ‡ç­¾"><code>docker tag</code> : åˆ›å»ºä¸€ä¸ªæ ‡ç­¾</h3><ul class="lvl-0"><li class="lvl-2"><p><code>docker image tag</code> == <code>docker tag</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å‘½ä»¤æ ¼å¼</span></span><br><span class="line">$ docker tag SOURCE_IMAGE[:TAG] TARGET_IMAGE[:TAG]</span><br><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªæ ‡ç­¾</span></span><br><span class="line">$ docker tag nginx:latest hanqunfeng/nginx:latest</span><br><span class="line"><span class="comment"># æŸ¥çœ‹é•œåƒï¼Œå¯ä»¥çœ‹åˆ°ä¸¤ä¸ªé•œåƒçš„ IMAGE ID ä¸€è‡´</span></span><br><span class="line">$ docker images</span><br><span class="line">REPOSITORY         TAG       IMAGE ID       CREATED       SIZE</span><br><span class="line">hanqunfeng/nginx   latest    be69f2940aaf   5 weeks ago   192MB</span><br><span class="line">nginx              latest    be69f2940aaf   5 weeks ago   192MB</span><br><span class="line"><span class="comment"># æ­¤æ—¶è‹¥é€šè¿‡ IMAGE ID åˆ é™¤é•œåƒï¼Œä¼šæŠ¥é”™ï¼Œæç¤ºè¢«å¤šä¸ª REPOSITORY å…³è”ï¼Œéœ€è¦ä½¿ç”¨ -f å‚æ•°è¿›è¡Œå¼ºåˆ¶åˆ é™¤</span></span><br><span class="line">$ docker rmi be69f2940aaf</span><br><span class="line">Error response from daemon: conflict: unable to delete be69f2940aaf (must be forced) - image is referenced <span class="keyword">in</span> multiple repositories</span><br></pre></td></tr></table></figure><h3 id="docker-save-å°†é•œåƒä¿å­˜ä¸º-tar-å½’æ¡£"><code>docker save</code> : å°†é•œåƒä¿å­˜ä¸º tar å½’æ¡£</h3><ul class="lvl-0"><li class="lvl-2"><p><code>docker image save</code> == <code>docker save</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å‘½ä»¤æ ¼å¼</span></span><br><span class="line">$ docker save [OPTIONS] IMAGE [IMAGE...]</span><br><span class="line"><span class="comment"># å°†é•œåƒä¿å­˜ä¸º tar å½’æ¡£ï¼Œ-o  æŒ‡å®šè¾“å‡ºæ–‡ä»¶ï¼Œæ–‡ä»¶åç§°ä»»æ„ï¼Œç”šè‡³éƒ½ä¸éœ€è¦ä»¥ .tar ç»“å°¾</span></span><br><span class="line">$ docker save -o nginx.tar nginx</span><br><span class="line"><span class="comment"># æˆ–è€…</span></span><br><span class="line">$ docker save nginx &gt; nginx.tar</span><br></pre></td></tr></table></figure><h3 id="docker-load-ä»-tar-å½’æ¡£ä¸­åŠ è½½é•œåƒ"><code>docker load</code> : ä» tar å½’æ¡£ä¸­åŠ è½½é•œåƒ</h3><ul class="lvl-0"><li class="lvl-2"><p><code>docker image load</code> == <code>docker load</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å‘½ä»¤æ ¼å¼</span></span><br><span class="line">$ docker load [OPTIONS]</span><br><span class="line"><span class="comment"># ä» tar å½’æ¡£ä¸­åŠ è½½é•œåƒï¼Œå¯¼å‡ºtarå½’æ¡£æ—¶çš„é•œåƒåç§°å°±æ˜¯åŠ è½½åçš„é•œåƒåç§°</span></span><br><span class="line">$ docker load -i nginx.tar</span><br><span class="line"><span class="comment"># -q å‚æ•°è¡¨ç¤ºä¸æ˜¾ç¤ºè¿›åº¦æ¡</span></span><br><span class="line">$ docker load -q -i nginx.tar</span><br></pre></td></tr></table></figure><h3 id="docker-import-ä»æ–‡ä»¶åˆ›å»ºé•œåƒ"><code>docker import</code> : ä»æ–‡ä»¶åˆ›å»ºé•œåƒ</h3><ul class="lvl-0"><li class="lvl-2"><p><code>docker image import</code> == <code>docker import</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å‘½ä»¤æ ¼å¼</span></span><br><span class="line">$ docker import [OPTIONS] FILE|URL|- [REPOSITORY[:TAG]]</span><br><span class="line"><span class="comment">## å‚æ•°è¯´æ˜</span></span><br><span class="line">fileæœ¬åœ° tar æ–‡ä»¶ï¼Œä¾‹å¦‚ rootfs.tar</span><br><span class="line">URL    ç½‘ç»œåœ°å€ï¼ˆhttp/httpsï¼‰</span><br><span class="line">-    ä»æ ‡å‡†è¾“å…¥è¯»å–ï¼ˆæ¯”å¦‚é€šè¿‡ç®¡é“ï¼‰</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºé•œåƒåç§°ä¸æ ‡ç­¾</span></span><br><span class="line">REPOSITORY[:TAG]å¯¼å…¥åé•œåƒçš„åç§°ä¸æ ‡ç­¾</span><br><span class="line"></span><br><span class="line"><span class="comment"># OPTIONS</span></span><br><span class="line">--changeåœ¨å¯¼å…¥é•œåƒæ—¶è®¾ç½® Dockerfile æŒ‡ä»¤ï¼Œå¦‚ CMDã€ENVã€EXPOSE ç­‰</span><br><span class="line">--message, -mæ·»åŠ å¯¼å…¥è¯´æ˜ï¼ˆcommit messageï¼‰</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>docker import</code> ä¸  <code>docker load</code> çš„åŒºåˆ«</p></li></ul><table><thead><tr><th>å‘½ä»¤</th><th>ç”¨é€”</th><th>æ ¼å¼</th><th>æ˜¯å¦ä¿ç•™å†å²</th></tr></thead><tbody><tr><td><code>docker import</code></td><td>å¯¼å…¥æ–‡ä»¶ç³»ç»Ÿï¼Œåˆ›å»ºé•œåƒ(ç”± <code>docker export</code> ç”Ÿæˆ)</td><td>çº¯æ–‡ä»¶ç³»ç»Ÿ tar åŒ…</td><td>âŒ ä¸ä¿ç•™å†å²ã€æ ‡ç­¾ç­‰å…ƒæ•°æ®</td></tr><tr><td><code>docker load</code></td><td>åŠ è½½é•œåƒï¼ˆé€šå¸¸ç”± <code>docker save</code> ç”Ÿæˆï¼‰</td><td>Docker é•œåƒ tarï¼ˆå«å…ƒæ•°æ®ï¼‰</td><td>âœ… ä¿ç•™ tagã€å±‚ã€å†å²ç­‰</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹: ä»å®¹å™¨å¯¼å‡ºå†å¯¼å…¥</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯åŠ¨ä¸€ä¸ªå®¹å™¨</span></span><br><span class="line">$ docker run -d -p 8080:80 --name nginx nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¼å‡ºå®¹å™¨æ–‡ä»¶ç³»ç»Ÿï¼Œæ­¤æ—¶ nginx å®¹å™¨ä¸­çš„æ‰€æœ‰æ–‡ä»¶éƒ½ä¿å­˜åœ¨ my_nginx.tar æ–‡ä»¶ä¸­</span></span><br><span class="line">$ docker <span class="built_in">export</span> -o my_nginx.tar nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¼å…¥æ–‡ä»¶ç³»ç»Ÿï¼Œå¯¼å…¥æ—¶æŒ‡å®š å¯åŠ¨å‘½ä»¤ï¼Œå› ä¸º my_nginx.tar åªæ˜¯æ–‡ä»¶ï¼Œå¹¶ä¸åŒ…å«ä»»ä½•å¯åŠ¨å‘½ä»¤</span></span><br><span class="line">$ docker import --change=<span class="string">&#x27;CMD [&quot;nginx&quot;, &quot;-g&quot;, &quot;daemon off;&quot;]&#x27;</span> my_nginx.tar nginx:my_tag</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹é•œåƒï¼Œé•œåƒIDä¸ä¸€è‡´</span></span><br><span class="line">$ docker images</span><br><span class="line">REPOSITORY         TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">nginx              my_tag    4ab42de31bac   4 seconds ago   191MB</span><br><span class="line">nginx              latest    be69f2940aaf   5 weeks ago     192MB</span><br></pre></td></tr></table></figure><h3 id="docker-build-ä»æŒ‡å®šç›®å½•æˆ–URLä¸­çš„-Dockerfile-æ„å»º-Docker-é•œåƒ"><code>docker build</code> : ä»æŒ‡å®šç›®å½•æˆ–URLä¸­çš„ Dockerfile æ„å»º Docker é•œåƒ</h3><ul class="lvl-0"><li class="lvl-2"><p><code>docker image build</code> == <code>docker build</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å‘½ä»¤æ ¼å¼</span></span><br><span class="line">docker build [OPTIONS] PATH | URL | -</span><br><span class="line"><span class="comment"># å‚æ•°è¯´æ˜</span></span><br><span class="line">PATH  Dockerfile æ‰€åœ¨çš„ç›®å½•</span><br><span class="line">URL      Git ä»“åº“çš„ URL</span><br><span class="line">-      ä»æ ‡å‡†è¾“å…¥è¯»å– Dockerfile</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„å»ºé•œåƒï¼Œ-t: æŒ‡å®šé•œåƒåç§°ï¼Œ.: è¡¨ç¤ºä»å½“å‰ç›®å½•æŸ¥æ‰¾Dockerfileï¼Œé»˜è®¤æ–‡ä»¶åç§°ä¸º Dockerfile</span></span><br><span class="line">docker build -t myimage:latest .</span><br><span class="line"><span class="comment"># æ„å»ºé•œåƒï¼Œ-f: æŒ‡å®š Dockerfile çš„ç›¸å¯¹è·¯å¾„ï¼Œ.: è¡¨ç¤ºåŸºäºå½“å‰ç›®å½•ï¼Œå®é™…çš„ Dockerfile è·¯å¾„å°±æ˜¯ ./path/MyDockerfile</span></span><br><span class="line">docker build -t myimage:latest -f path/MyDockerfile .</span><br><span class="line"><span class="comment"># å®é™…çš„ Dockerfile è·¯å¾„å°±æ˜¯ /usr/local/path/MyDockerfile</span></span><br><span class="line">docker build -t myimage:latest -f path/MyDockerfile /usr/local</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„å»ºé•œåƒï¼Œä» Git ä»“åº“ä¸­æ„å»ºï¼Œgit ä»“åº“çš„ Dockerfile å¿…é¡»åœ¨æ ¹ç›®å½•ä¸‹</span></span><br><span class="line">docker build https://github.com/hanqunfeng/docker_test.git -t abc:1.0.0</span><br><span class="line"><span class="comment"># æ„å»ºé•œåƒï¼Œä» Git ä»“åº“ä¸­æ„å»ºï¼ŒæŒ‡å®š Dockerfile çš„ç›¸å¯¹è·¯å¾„</span></span><br><span class="line">docker build -f docker/Dockerfile https://github.com/hanqunfeng/docker_test.git -t abc:1.0.1</span><br><span class="line"><span class="comment"># æ„å»ºé•œåƒï¼Œä» Git ä»“åº“ä¸­æ„å»ºï¼ŒæŒ‡å®šåˆ†æ”¯æˆ– tag</span></span><br><span class="line">docker build -f docker/Dockerfile https://github.com/hanqunfeng/docker_test.git#release -t abc:1.0.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„å»ºé•œåƒï¼Œ--no-cache è¡¨ç¤ºä¸ä½¿ç”¨ç¼“å­˜ï¼Œæ¯æ¬¡æ„å»ºéƒ½ä¼šé‡æ–°æ„å»ºï¼Œä½†ä¼šéå¸¸æ…¢ï¼Œä¸€èˆ¬æ²¡æœ‰å¯¼è‡´æŸä¸€ä¸ªå±‚å‘ç”Ÿå˜åŒ–æ—¶ä¸éœ€è¦åŠ ä¸Šè¿™ä¸ªå‚æ•°</span></span><br><span class="line">docker build --no-cache -t app:latest .</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>docker build</code>ä¸­è¿˜æœ‰ä¸€äº›é‡è¦çš„å‚æ•°ï¼Œä»¥åŠ<code>Dockerfile</code>æ–‡ä»¶è¯¥æ€ä¹ˆç¼–å†™ï¼Œè¯·å‚è€ƒ<a href="/2025/05/26/docker-dockerfile/" title="Docker å‘½ä»¤ ä¹‹ Dockerfile">Docker å‘½ä»¤ ä¹‹ Dockerfile</a></p></li></ul><h3 id="docker-push-æ¨é€æœ¬åœ°é•œåƒåˆ°è¿œç¨‹ä»“åº“"><code>docker push</code> : æ¨é€æœ¬åœ°é•œåƒåˆ°è¿œç¨‹ä»“åº“</h3><ul class="lvl-0"><li class="lvl-2"><p><code>docker image push</code> == <code>docker push</code></p></li><li class="lvl-2"><p>è¿™é‡Œä»‹ç»å¦‚ä½•å°†é•œåƒæ¨é€åˆ°<code>docker hub</code>è¿œç¨‹ä»“åº“</p></li><li class="lvl-2"><p>éœ€è¦å…ˆåœ¨<a href="https://hub.docker.com/">docker hub</a>ç½‘ç«™ä¸Šåˆ›å»ºä¸€ä¸ªè´¦å·ï¼Œæ¯”å¦‚æˆ‘çš„ç”¨æˆ·åæ˜¯<code>hanqunfeng</code></p></li><li class="lvl-2"><p>ç„¶åå°±å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å°†æœ¬åœ°é•œåƒæ¨é€åˆ°è¿œç¨‹ä»“åº“äº†</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹æœ¬åœ°é•œåƒ</span></span><br><span class="line">$ docker images</span><br><span class="line">REPOSITORY         TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">nginx              latest    e573c6323878   18 hours ago   191MB</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¹nginxé•œåƒæ‰“tag,å‰ç¼€å¿…é¡»ä¸ç”¨æˆ·åä¸€è‡´</span></span><br><span class="line">$ docker tag nginx hanqunfeng/nginx:1.0.0</span><br><span class="line">$ docker images</span><br><span class="line">REPOSITORY         TAG       IMAGE ID       CREATED        SIZE</span><br><span class="line">hanqunfeng/nginx   1.0.0     be69f2940aaf   5 weeks ago    192MB</span><br><span class="line">nginx              latest    be69f2940aaf   5 weeks ago    192MB</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç™»å½• docker hup</span></span><br><span class="line">$ docker login -u hanqunfeng</span><br><span class="line"></span><br><span class="line">i Info â†’ A Personal Access Token (PAT) can be used instead.</span><br><span class="line">          To create a PAT, visit https://app.docker.com/settings</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Password: <span class="comment"># è¾“å…¥å¯†ç </span></span><br><span class="line">Login Succeeded</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç™»å½•åŒæ—¶è¾“å…¥å¯†ç </span></span><br><span class="line"><span class="comment"># docker login -u hanqunfeng -p 12345678</span></span><br><span class="line"><span class="comment"># ç™»å½•å…¶å®ƒä»“åº“</span></span><br><span class="line"><span class="comment"># docker login -u username -p password registry.orther.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¨é€åˆ°docker hubï¼Œæ­¤åå°±å¯ä»¥é€šè¿‡ docker pull hanqunfeng/nginx:1.0.0 è·å–äº†</span></span><br><span class="line">$ docker push hanqunfeng/nginx:1.0.0</span><br></pre></td></tr></table></figure><div class="tips"><p><em><strong>å°è´´å£«</strong></em></p><ul class="lvl-1"><li class="lvl-2">æœªç™»å½•Docker Hubçš„æƒ…å†µä¸‹ï¼Œè¿è¡Œ<code>docker pull</code>ä¼šæœ‰æ‹‰å–é€Ÿç‡å’Œæ•°é‡ä¸Šçš„é™åˆ¶ï¼Œå…·ä½“å¯ä»¥å‚çœ‹<a href="https://docs.docker.com/docker-hub/usage/">Docker Hubçš„ä½¿ç”¨å’Œé™åˆ¶</a></li></ul></div>]]></content>
    
    
    <summary type="html">&lt;!--
 **åŠ ç²—**
 *æ–œä½“*
 ***åŠ ç²—å¹¶æ–œä½“***
 ~~åˆ é™¤çº¿~~
 ==çªå‡ºæ˜¾ç¤º==
 `çªå‡ºæ˜¾ç¤º(æ¨è)`
 ++ä¸‹åˆ’çº¿++
 ~ä¸‹æ ‡~
 ^ä¸Šæ ‡^
 è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.
 å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **ç‚¹å‡»æŠ˜å **
 è¿™æ˜¯è¢«éšè—çš„å†…å®¹
 +++

::: tips success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
:::

% note info % success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
% endnote %

å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}
 å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ
 --&gt;
&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;æœ¬æ–‡ä»‹ç» Docker å‘½ä»¤ ä¸­ é•œåƒç®¡ç† ç›¸å…³å‘½ä»¤&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com&quot;&gt;Dockerå®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com/reference/#application-programming-interfaces-apis&quot;&gt;Application programming interfaces (APIs)&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/docker/"/>
    
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>Linux å®‰è£… Docker</title>
    <link href="https://blog.hanqunfeng.com/2025/05/20/docker-install/"/>
    <id>https://blog.hanqunfeng.com/2025/05/20/docker-install/</id>
    <published>2025-05-20T13:30:05.000Z</published>
    <updated>2025-06-12T07:49:05.593Z</updated>
    
    <content type="html"><![CDATA[<!-- **åŠ ç²—** *æ–œä½“* ***åŠ ç²—å¹¶æ–œä½“*** ~~åˆ é™¤çº¿~~ ==çªå‡ºæ˜¾ç¤º== `çªå‡ºæ˜¾ç¤º(æ¨è)` ++ä¸‹åˆ’çº¿++ ~ä¸‹æ ‡~ ^ä¸Šæ ‡^ è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference. å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **ç‚¹å‡»æŠ˜å ** è¿™æ˜¯è¢«éšè—çš„å†…å®¹ +++::: tips success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹:::% note info % success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹% endnote %å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{} å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ --><h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2"><p>æœ¬æ–‡ä»‹ç» Linux ä¸‹çš„ Docker å®‰è£…æ–¹æ³•ï¼Œæœ¬æ–‡ä»¥ CentOS 8 ä¸ºä¾‹ã€‚</p></li><li class="lvl-2"><p>windowsã€macosã€ubuntuç­‰æ¡Œé¢ç³»ç»Ÿè¯·å®‰è£… <a href="https://www.docker.com/products/docker-desktop/">Docker Desktop</a>ã€‚</p></li><li class="lvl-2"><p>é˜¿é‡Œäº‘ä¸“æœ‰æœåŠ¡å™¨å‚è€ƒï¼š<a href="https://help.aliyun.com/zh/ecs/use-cases/install-and-use-docker">é˜¿é‡Œäº‘ä¸“æœ‰æœåŠ¡å™¨å¦‚ä½•å®‰è£…Docker</a></p></li><li class="lvl-2"><p>è…¾è®¯äº‘ä¸“æœ‰æœåŠ¡å™¨å‚è€ƒï¼š<a href="https://cloud.tencent.com/document/product/1207/45596">è…¾è®¯äº‘ä¸“æœ‰æœåŠ¡å™¨å¦‚ä½•å®‰è£…Docker</a></p></li><li class="lvl-2"><p>AWSä¸“æœ‰æœåŠ¡å™¨å‚è€ƒï¼š<a href="/2025/05/19/docker-install-aws/" title="AWSä¸“æœ‰æœåŠ¡å™¨å¦‚ä½•å®‰è£…Docker">AWSä¸“æœ‰æœåŠ¡å™¨å¦‚ä½•å®‰è£…Docker</a></p></li><li class="lvl-2"><p><a href="https://docs.docker.com">Dockerå®˜æ–¹æ–‡æ¡£</a></p></li><li class="lvl-2"><p><a href="https://docs.docker.com/engine/install/">å®‰è£…Docker Engine</a></p></li></ul><span id="more"></span><h2 id="Docker-ç®€ä»‹">Docker ç®€ä»‹</h2><ul class="lvl-0"><li class="lvl-2"><p>Docker æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨åŒ–å¹³å°ï¼Œç”¨äºæ‰“åŒ…ã€åˆ†å‘å’Œè¿è¡Œåº”ç”¨ç¨‹åºã€‚å®ƒé€šè¿‡å°†åº”ç”¨ç¨‹åºåŠå…¶ä¾èµ–æ‰“åŒ…åˆ°ä¸€ä¸ªâ€œå®¹å™¨â€ä¸­ï¼Œç¡®ä¿åº”ç”¨åœ¨ä¸åŒç¯å¢ƒä¸­å§‹ç»ˆèƒ½å¤Ÿä¸€è‡´è¿è¡Œã€‚ä¸ä¼ ç»Ÿçš„è™šæ‹Ÿæœºç›¸æ¯”ï¼ŒDocker å®¹å™¨æ›´è½»é‡ã€å¯åŠ¨æ›´å¿«ã€èµ„æºå ç”¨æ›´å°‘ã€‚</p></li><li class="lvl-2"><p>Docker é‡‡ç”¨<code>å®¢æˆ·ç«¯-æœåŠ¡å™¨</code>æ¶æ„ï¼Œæ ¸å¿ƒç»„ä»¶åŒ…æ‹¬ <code>Docker Engine</code>ï¼ˆè´Ÿè´£æ„å»ºå’Œè¿è¡Œå®¹å™¨ï¼‰ã€<code>Dockerfile</code>ï¼ˆå®šä¹‰æ„å»ºé•œåƒçš„æŒ‡ä»¤ï¼‰ã€<code>é•œåƒ</code>ï¼ˆåº”ç”¨å’Œä¾èµ–çš„åªè¯»æ¨¡æ¿ï¼‰å’Œ<code>å®¹å™¨</code>ï¼ˆåŸºäºé•œåƒè¿è¡Œçš„å®ä¾‹ï¼‰ã€‚å¼€å‘è€…å¯ä»¥é€šè¿‡ Docker Hub å…±äº«æˆ–ä¸‹è½½é•œåƒï¼Œæå¤§ç®€åŒ–äº†éƒ¨ç½²æµç¨‹ã€‚</p></li><li class="lvl-2"><p>æ€»ç»“æ¥è¯´ï¼ŒDocker æé«˜äº†å¼€å‘æ•ˆç‡ï¼Œæ”¯æŒæŒç»­é›†æˆä¸éƒ¨ç½²ï¼ˆCI/CDï¼‰ï¼Œåœ¨å¾®æœåŠ¡æ¶æ„ä¸­å°¤ä¸ºå¸¸ç”¨ï¼Œæ˜¯ç°ä»£ DevOps æµç¨‹çš„é‡è¦å·¥å…·ã€‚</p></li><li class="lvl-2"><p><a href="https://docs.docker.com/get-started/docker-overview/">Dockeræ˜¯ä»€ä¹ˆï¼Ÿ</a><br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/nIdftv.png" alt=""></p></li></ul><table><thead><tr><th>åç§°</th><th>æè¿°</th></tr></thead><tbody><tr><td>Docker ä»“åº“ï¼ˆRegistryï¼‰</td><td>Dockerä»“åº“ç”¨äºå­˜å‚¨Dockeré•œåƒã€‚Docker Hubæ˜¯ä¸€ä¸ªä»»ä½•äººéƒ½å¯ä»¥ä½¿ç”¨çš„å…¬å…±ä»“åº“ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒDockeråœ¨Docker Hubä¸ŠæŸ¥æ‰¾å›¾åƒã€‚ä½ ä¹Ÿå¯ä»¥é…ç½®è‡ªå·±çš„ç§äººä»“åº“ã€‚<br>å½“æ‚¨ä½¿ç”¨docker pullæˆ–docker runå‘½ä»¤æ—¶ï¼ŒDockerä¼šä»æ‚¨é…ç½®çš„ä»“åº“ä¸­æå–æ‰€éœ€çš„é•œåƒã€‚å½“æ‚¨ä½¿ç”¨docker pushå‘½ä»¤æ—¶ï¼ŒDockerä¼šå°†æ‚¨çš„é•œåƒæ¨é€åˆ°å·²é…ç½®çš„ä»“åº“ä¸­ã€‚</td></tr><tr><td>Docker å®ˆæŠ¤è¿›ç¨‹ï¼ˆDaemonï¼‰</td><td>ç›‘å¬Docker APIè¯·æ±‚ï¼Œå¹¶ç®¡ç†Dockerå¯¹è±¡ï¼Œå¦‚é•œåƒã€å®¹å™¨ã€ç½‘ç»œå’Œå·ã€‚å®ˆæŠ¤ç¨‹åºè¿˜å¯ä»¥ä¸å…¶ä»–å®ˆæŠ¤ç¨‹åºé€šä¿¡æ¥ç®¡ç†DockeræœåŠ¡ã€‚</td></tr><tr><td>Docker å®¢æˆ·ç«¯ï¼ˆClientï¼‰</td><td>Docker å®¢æˆ·ç«¯ï¼ˆdockerï¼‰æ˜¯è®¸å¤šç”¨æˆ·ä¸ Docker äº¤äº’çš„ä¸»è¦æ–¹å¼ã€‚å½“ä½ ä½¿ç”¨å¦‚ docker run è¿™æ ·çš„å‘½ä»¤æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šå°†è¿™äº›å‘½ä»¤å‘é€ç»™ dockerdï¼ˆDocker å®ˆæŠ¤è¿›ç¨‹ï¼‰ï¼Œç”±å®ƒæ¥æ‰§è¡Œè¿™äº›æ“ä½œã€‚<br>docker å‘½ä»¤æ˜¯é€šè¿‡ Docker API è¿›è¡Œé€šä¿¡çš„ã€‚Docker å®¢æˆ·ç«¯å¯ä»¥ä¸å¤šä¸ªå®ˆæŠ¤è¿›ç¨‹è¿›è¡Œé€šä¿¡ã€‚</td></tr><tr><td>Docker ä¸»æœºï¼ˆHostï¼‰</td><td>è¿è¡Œ Docker å®ˆæŠ¤è¿›ç¨‹å’Œå®¹å™¨çš„ç‰©ç†æˆ–è™šæ‹Ÿæœºå™¨ã€‚</td></tr><tr><td>Docker é•œåƒï¼ˆImagesï¼‰</td><td>åˆ›å»ºå®¹å™¨çš„åªè¯»æ¨¡æ¿ï¼ŒåŒ…å«è¿è¡Œåº”ç”¨æ‰€éœ€çš„æ‰€æœ‰æ–‡ä»¶å’Œé…ç½®ã€‚</td></tr><tr><td>Docker å®¹å™¨ï¼ˆContainerï¼‰</td><td>åŸºäºé•œåƒè¿è¡Œçš„å®ä¾‹ï¼Œæ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªåº”ç”¨çš„ç‹¬ç«‹è¿è¡Œç¯å¢ƒã€‚</td></tr></tbody></table><h2 id="Docker-å®‰è£…">Docker å®‰è£…</h2><ul class="lvl-0"><li class="lvl-2"><p>å…¨æ–°å®‰è£…å‰éœ€è¦å…ˆå¸è½½æ—§ç‰ˆæœ¬ï¼Œå¸è½½<code>docker</code>ä¹Ÿå¯ä»¥æŒ‰ç…§å¦‚ä¸‹æ–¹å¼æ“ä½œ</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ é™¤Dockerç›¸å…³æº</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> -f /etc/yum.repos.d/docker*.repo</span><br><span class="line"><span class="comment"># åˆ é™¤Dockerç›¸å…³è½¯ä»¶åŒ…ï¼Œdnfå¯èƒ½ä¼šæŠ¥å‘Šæ‚¨æ²¡æœ‰å®‰è£…è¿™äº›è½¯ä»¶åŒ…ã€‚</span></span><br><span class="line"><span class="comment"># å¸è½½dockeræ—§ç‰ˆæœ¬</span></span><br><span class="line"><span class="built_in">sudo</span> dnf -y remove \</span><br><span class="line">               docker \</span><br><span class="line">               docker-client \</span><br><span class="line">               docker-client-latest \</span><br><span class="line">               docker-common \</span><br><span class="line">               docker-latest \</span><br><span class="line">               docker-latest-logrotate \</span><br><span class="line">               docker-logrotate \</span><br><span class="line">               docker-engine</span><br><span class="line"><span class="comment"># å¸è½½dockeræ–°ç‰ˆæœ¬</span></span><br><span class="line"><span class="built_in">sudo</span> dnf -y remove \</span><br><span class="line">            docker-ce \</span><br><span class="line">            containerd.io \</span><br><span class="line">            docker-ce-rootless-extras \</span><br><span class="line">            docker-buildx-plugin \</span><br><span class="line">            docker-ce-cli \</span><br><span class="line">            docker-compose-plugin</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤Dockeræ•°æ®,é•œåƒã€å®¹å™¨ã€å·å’Œç½‘ç»œ</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> -rf /var/lib/docker</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> -rf /var/lib/containerd</span><br><span class="line"><span class="comment"># Dockeræ‰§è¡ŒçŠ¶æ€æ–‡ä»¶çš„å­˜å‚¨è·¯å¾„</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> -rf /var/run/docker</span><br><span class="line"><span class="comment"># åˆ é™¤Dockeré…ç½®</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> -rf /etc/docker/</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>è®¾ç½®dockerå­˜å‚¨åº“</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dnf -y install dnf-plugins-core</span><br><span class="line"><span class="comment"># æµ·å¤–ï¼Œæ·»åŠ Dockerçš„å®˜æ–¹å­˜å‚¨åº“</span></span><br><span class="line"><span class="built_in">sudo</span> dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"><span class="comment"># å›½å†…ï¼Œæ·»åŠ é˜¿é‡Œäº‘çš„å­˜å‚¨åº“</span></span><br><span class="line"><span class="built_in">sudo</span> dnf config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å®‰è£… Docker</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…æœ€æ–°ç‰ˆæœ¬ï¼Œå‡çº§ docker æ—¶ä¹Ÿæ˜¯æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</span></span><br><span class="line"><span class="built_in">sudo</span> dnf -y install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…æŒ‡å®šç‰ˆæœ¬</span></span><br><span class="line"><span class="comment"># å…ˆæŸ¥çœ‹æ‰€æœ‰ç‰ˆæœ¬</span></span><br><span class="line"><span class="built_in">sudo</span> dnf list docker-ce --showduplicates | <span class="built_in">sort</span> -r</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">docker-ce.x86_64               3:26.1.3-1.el8                  docker-ce-stable</span><br><span class="line">docker-ce.x86_64               3:26.1.3-1.el8                  @docker-ce-stable</span><br><span class="line">docker-ce.x86_64               3:26.1.2-1.el8                  docker-ce-stable</span><br><span class="line">docker-ce.x86_64               3:26.1.1-1.el8                  docker-ce-stable</span><br><span class="line">docker-ce.x86_64               3:26.1.0-1.el8                  docker-ce-stable</span><br><span class="line">â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…æŒ‡å®šç‰ˆæœ¬ï¼Œè¿™é‡Œ VERSION_STRING ä¸ºç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ 3:26.1.3-1.el8</span></span><br><span class="line"><span class="built_in">sudo</span> dnf install docker-ce-&lt;VERSION_STRING&gt; docker-ce-cli-&lt;VERSION_STRING&gt; containerd.io docker-buildx-plugin docker-compose-plugin -y</span><br><span class="line"><span class="comment">## æ¯”å¦‚</span></span><br><span class="line"><span class="built_in">sudo</span> dnf install docker-ce-3:26.1.3-1.el8 docker-ce-cli-3:26.1.3-1.el8 containerd.io docker-buildx-plugin docker-compose-plugin -y</span><br><span class="line"></span><br><span class="line"><span class="comment">## å¦‚æœåªå®‰è£…å®¢æˆ·ç«¯ç”¨äºè¿æ¥è¿œç¨‹ Docker ä¸»æœº</span></span><br><span class="line"><span class="built_in">sudo</span> dnf install docker-ce-cli docker-buildx-plugin docker-compose-plugin -y</span><br></pre></td></tr></table></figure><table><thead><tr><th>ç»„ä»¶åç§°</th><th>æ˜¯å¦å¿…éœ€ï¼ˆæœ¬åœ°è¿è¡Œ Dockerï¼‰</th><th>åŠŸèƒ½ç®€ä»‹</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td><code>docker-ce</code></td><td>âœ… æ˜¯</td><td>Docker Engine çš„æ ¸å¿ƒï¼ŒåŒ…æ‹¬ <code>dockerd</code>ï¼ˆå®ˆæŠ¤è¿›ç¨‹ï¼‰å’Œ <code>docker</code>ï¼ˆCLIï¼‰</td><td>å®Œæ•´å®‰è£… Docker æ—¶åŒ…å«æ­¤ç»„ä»¶</td></tr><tr><td><code>docker-ce-cli</code></td><td>âœ… æ˜¯ï¼ˆæˆ–å•ç‹¬ç”¨äºè¿œç¨‹æ§åˆ¶ï¼‰</td><td>Docker å‘½ä»¤è¡Œå·¥å…·ï¼Œå¦‚ <code>docker run</code>, <code>docker ps</code>, <code>docker build</code> ç­‰</td><td>å¯ä»¥ç‹¬ç«‹å®‰è£…ï¼Œåªç”¨äºæ§åˆ¶è¿œç¨‹ Docker ä¸»æœº</td></tr><tr><td><code>containerd.io</code></td><td>âœ… æ˜¯ï¼ˆæœ¬åœ°è¿è¡Œå®¹å™¨ï¼‰</td><td>å®¹å™¨è¿è¡Œæ—¶ï¼ŒDocker åç«¯ç”¨äºçœŸæ­£å¯åŠ¨/ç®¡ç†å®¹å™¨</td><td>å¦‚æœä½ åªä½¿ç”¨ Docker CLIï¼Œä¸è¿è¡Œæœ¬åœ°å®¹å™¨åˆ™ä¸éœ€è¦</td></tr><tr><td><code>docker-buildx-plugin</code></td><td>âŒ å¦</td><td>æä¾› <code>docker buildx</code> å‘½ä»¤ï¼Œæ”¯æŒé«˜çº§æ„å»ºç‰¹æ€§ï¼ˆå¦‚è·¨å¹³å°ã€å¤šé˜¶æ®µæ„å»ºï¼‰</td><td>å¯é€‰ï¼Œé€‚åˆé«˜çº§æ„å»ºéœ€æ±‚</td></tr><tr><td><code>docker-compose-plugin</code></td><td>âŒ å¦</td><td>æä¾› <code>docker compose</code> å‘½ä»¤ï¼Œç”¨äºç¼–æ’å¤šä¸ªæœåŠ¡</td><td>å¦‚æœä½¿ç”¨ Composeï¼Œåˆ™å»ºè®®å®‰è£…æ­¤æ’ä»¶</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>å¯åŠ¨ Docker</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®Dockerå®ˆæŠ¤è¿›ç¨‹åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨å¯åŠ¨</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> docker</span><br><span class="line"><span class="comment"># å¯åŠ¨Docker</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl start docker</span><br><span class="line"><span class="comment"># æŸ¥çœ‹ docker daemon æ—¥å¿—ï¼Œ-f: æŒç»­è·Ÿè¸ª</span></span><br><span class="line"><span class="built_in">sudo</span> journalctl -u docker -f</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ·»åŠ å½“å‰ç”¨æˆ·åˆ°dockerç»„</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ å½“å‰ç”¨æˆ·åˆ°dockerç»„ï¼Œè¿™æ ·å½“å‰ç”¨æˆ·å°±å¯ä»¥ä¸éœ€è¦ä½¿ç”¨sudoå°±èƒ½ä½¿ç”¨dockerå‘½ä»¤</span></span><br><span class="line"><span class="comment"># å½“å‰ç”¨æˆ·æ˜¯centos</span></span><br><span class="line"><span class="built_in">sudo</span> usermod -aG docker centos</span><br><span class="line"><span class="comment"># è®©ç»„æƒé™ç«‹å³ç”Ÿæ•ˆæœ€ç¨³å¦¥çš„åšæ³•æ˜¯ï¼šæ³¨é”€å¹¶é‡æ–°ç™»å½•è¿œç¨‹ä¸»æœºï¼Œä½†ä¹Ÿå¯ä»¥å°è¯•ç”¨ä¸‹é¢å‘½ä»¤ç«‹å³åŠ è½½æ–°ç»„</span></span><br><span class="line">newgrp docker</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>éªŒè¯ Docker å®‰è£…</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker version <span class="comment"># æŸ¥çœ‹ Docker version</span></span><br><span class="line"><span class="comment"># æ˜¾ç¤º Docker åŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç‰ˆæœ¬ä¿¡æ¯ï¼Œæ’ä»¶ä¿¡æ¯ï¼Œé•œåƒåŠ é€Ÿä¿¡æ¯ç­‰ç­‰ã€‚</span></span><br><span class="line">docker info</span><br><span class="line"><span class="comment"># æ‹‰å–hello-worldé•œåƒï¼Œæ­¤æ—¶å›½å†…ä¼šæç¤ºè®¿é—®å¤±è´¥ï¼Œéœ€è¦æ·»åŠ å›½å†…é•œåƒæº</span></span><br><span class="line">docker pull hello-world</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ·»åŠ å›½å†…é•œåƒæº</p></li></ul><blockquote><p>ç›®å‰å›½å†…å¤§éƒ¨åˆ†çš„Dockeré•œåƒæºéƒ½å…³é—­äº†ï¼Œå¦å¤–é˜¿é‡Œäº‘çš„Dockeré•œåƒæºåªå…è®¸åœ¨é˜¿é‡Œäº‘çš„æœºå™¨ä¸Šä½¿ç”¨ã€‚<br>å‚è€ƒï¼š<a href="https://blog.xuanyuan.me/archives/1154">Docker/DockerHub å›½å†…é•œåƒæº/åŠ é€Ÿåˆ—è¡¨</a>,<a href="https://status.1panel.top/status/docker">å›½å†… Docker æœåŠ¡çŠ¶æ€ &amp; é•œåƒåŠ é€Ÿç›‘æ§</a><br>æ³¨æ„ï¼šå›½å†…é•œåƒæºçš„æ›´æ–°ä¼šæ¯”å®˜ç½‘æ»åï¼Œä½†åªè¦ä¸æ˜¯è·å–æœ€æ–°ç‰ˆæœ¬åŸºæœ¬ä¸Šæ˜¯å¤Ÿç”¨çš„ã€‚</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;registry-mirrors&quot;: [</span></span><br><span class="line"><span class="string">        &quot;https://docker.1ms.run&quot;,</span></span><br><span class="line"><span class="string">        &quot;https://docker.xuanyuan.me&quot;,</span></span><br><span class="line"><span class="string">        &quot;https://docker.m.daocloud.io&quot;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯Docker</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line"><span class="built_in">sudo</span> systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹æ˜¯å¦é…ç½®ç”Ÿæ•ˆï¼ŒæŸ¥çœ‹ Registry Mirrors ä¸­çš„é…ç½®</span></span><br><span class="line">docker info</span><br><span class="line"><span class="comment"># éªŒè¯å›½å†…é•œåƒæº</span></span><br><span class="line">docker pull hello-world</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>Dockerå‘½ä»¤è‡ªåŠ¨è¡¥å…¨ï¼Œå‚è€ƒï¼š<a href="https://docs.docker.com/engine/cli/completion/">å®˜æ–¹æ–‡æ¡£</a></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨çš„bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…bash-completion</span></span><br><span class="line"><span class="built_in">sudo</span> dnf install bash-completion -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ è‡ªåŠ¨è¡¥å…¨åˆ°å½“å‰ç™»å½•ç”¨æˆ·</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOT &gt;&gt; ~/.bashrc</span></span><br><span class="line"><span class="string">if [ -f /etc/bash_completion ]; then</span></span><br><span class="line"><span class="string">    . /etc/bash_completion</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">EOT</span></span><br><span class="line"><span class="comment"># åˆ·æ–°bash</span></span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºè‡ªåŠ¨è¡¥å…¨æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">mkdir</span> -p ~/.local/share/bash-completion/completions</span><br><span class="line">docker completion bash &gt; ~/.local/share/bash-completion/completions/docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨ä¸€ä¸ªæ–°çš„bash</span></span><br><span class="line"><span class="built_in">exec</span> bash</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>/var/lib/docker</code> ç”¨äºå­˜å‚¨ Docker è¿è¡Œæ—¶ç”Ÿæˆçš„æ•°æ®ï¼Œå¦‚é•œåƒã€å®¹å™¨ã€ç½‘ç»œã€å·ã€é…ç½®æ–‡ä»¶ã€æ—¥å¿—ç­‰ï¼Œå…¶ç›®å½•ç»“æ„è¯´æ˜å¦‚ä¸‹ï¼š</p></li></ul><table><thead><tr><th>ç›®å½•å</th><th>ä½œç”¨è¯´æ˜</th></tr></thead><tbody><tr><td><code>buildkit/</code></td><td>å­˜æ”¾ Docker BuildKit æ„å»ºç¼“å­˜å’ŒçŠ¶æ€ä¿¡æ¯ï¼›æ„å»ºé•œåƒæ—¶çš„ä¸­é—´æ–‡ä»¶å’Œä¸Šä¸‹æ–‡ä¼šå­˜äºæ­¤ï¼Œç©ºé—´å ç”¨å¯èƒ½è¾ƒå¤§ã€‚</td></tr><tr><td><code>containers/</code></td><td>æ¯ä¸ªå®¹å™¨ä¸€ä¸ªå­ç›®å½•ï¼ŒåŒ…å«é…ç½®æ–‡ä»¶å’Œè¿è¡Œæ—¥å¿—ï¼ˆå¦‚ <code>container.log</code>ï¼‰ï¼Œç”¨äºå®¹å™¨çš„è¿è¡ŒçŠ¶æ€è®°å½•å’Œç®¡ç†ã€‚</td></tr><tr><td><code>engine-id</code></td><td>å­˜å‚¨ Docker å¼•æ“çš„å”¯ä¸€ IDï¼ŒDocker å®‰è£…æ—¶ç”Ÿæˆï¼Œå¸¸ç”¨äº swarm èŠ‚ç‚¹è¯†åˆ«ã€‚</td></tr><tr><td><code>image/</code></td><td>é•œåƒçš„å…ƒæ•°æ®ï¼ˆä¸å«å®é™… layer æ•°æ®ï¼‰ï¼Œç»„ç»‡é•œåƒçš„ç»“æ„ã€æ ‡ç­¾ã€é©±åŠ¨ç­‰ä¿¡æ¯ã€‚</td></tr><tr><td><code>network/</code></td><td>ç½‘ç»œé…ç½®åŠçŠ¶æ€ä¿¡æ¯ï¼Œå¦‚é»˜è®¤ <code>bridge</code> ç½‘ç»œã€è‡ªå®šä¹‰ç½‘ç»œé…ç½®ç­‰ã€‚</td></tr><tr><td><code>overlay2/</code></td><td>é•œåƒå’Œå®¹å™¨å®é™…çš„æ•°æ®å±‚ï¼ˆoverlay2 æ˜¯å­˜å‚¨é©±åŠ¨ï¼‰ï¼ŒåŒ…å«æ‰€æœ‰è”åˆæ–‡ä»¶ç³»ç»Ÿå±‚ï¼Œæ˜¯ Docker ä¸­æœ€å¤§çš„ç©ºé—´ä½¿ç”¨è€…ã€‚</td></tr><tr><td><code>plugins/</code></td><td>å­˜æ”¾ Docker æ’ä»¶ï¼ˆå¦‚ç½‘ç»œã€å·æ’ä»¶ï¼‰çš„é…ç½®å’Œæ•°æ®ï¼Œä¸€èˆ¬ä¸ºç©ºï¼Œé™¤éä½¿ç”¨äº†æ‰©å±•æ’ä»¶ã€‚</td></tr><tr><td><code>runtimes/</code></td><td>æ”¯æŒçš„ OCI runtime é…ç½®ç›®å½•ï¼Œå¦‚é»˜è®¤çš„ <code>runc</code>ï¼Œä¹Ÿå¯èƒ½åŒ…å«å…¶ä»– runtimeï¼ˆå¦‚ <code>kata</code>, <code>gvisor</code>ï¼‰ã€‚</td></tr><tr><td><code>swarm/</code></td><td>Docker swarm æ¨¡å¼ä¸‹çš„é›†ç¾¤å…ƒæ•°æ®ä¸èŠ‚ç‚¹çŠ¶æ€ï¼Œä»…åœ¨åˆå§‹åŒ– swarm åå­˜åœ¨å®é™…æ•°æ®ã€‚</td></tr><tr><td><code>tmp/</code></td><td>Docker çš„ä¸´æ—¶æ–‡ä»¶ç›®å½•ï¼Œå¦‚é•œåƒä¸‹è½½ç¼“å­˜ã€æŒ‚è½½æ“ä½œä¸­çš„ä¸´æ—¶æ–‡ä»¶ï¼Œé€šå¸¸å¯ä»¥æ¸…ç†ä½†éœ€å°å¿ƒã€‚</td></tr><tr><td><code>volumes/</code></td><td>Docker å·çš„æ•°æ®ç›®å½•ï¼Œæ¯ä¸ªå·ä¸€ä¸ªå­ç›®å½•ï¼Œå·ä¸­çš„æŒä¹…åŒ–æ•°æ®å®é™…å­˜æ”¾äºæ­¤ã€‚</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p><code>/var/lib/containerd</code> æ˜¯ Containerd å®ˆæŠ¤è¿›ç¨‹çš„é»˜è®¤æ•°æ®å­˜å‚¨ç›®å½•ã€‚Containerd æ˜¯ Docker å’Œå…¶ä»–å®¹å™¨å¹³å°ï¼ˆå¦‚ Kubernetesï¼‰åº•å±‚çš„ å®¹å™¨è¿è¡Œæ—¶ï¼ˆContainer Runtimeï¼‰ï¼Œè´Ÿè´£æ‹‰å–é•œåƒã€ç®¡ç†å®¹å™¨ç”Ÿå‘½å‘¨æœŸã€æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿç­‰æ“ä½œã€‚å…¶ç›®å½•ç»“æ„è¯´æ˜å¦‚ä¸‹ï¼š</p></li></ul><table><thead><tr><th>ç›®å½•å</th><th>ä½œç”¨è¯´æ˜</th></tr></thead><tbody><tr><td><code>io.containerd.content.v1.content/</code></td><td>å­˜å‚¨é•œåƒ layer çš„å®é™…äºŒè¿›åˆ¶å†…å®¹ï¼ˆblobï¼‰ï¼Œéµå¾ª OCI é•œåƒè§„èŒƒï¼Œæ˜¯é•œåƒå’Œå®¹å™¨æ–‡ä»¶ç³»ç»Ÿçš„æ•°æ®æ¥æºã€‚</td></tr><tr><td><code>io.containerd.metadata.v1.bolt/</code></td><td>ä½¿ç”¨ BoltDB å­˜å‚¨ containerd çš„å…ƒæ•°æ®ï¼ˆå¦‚é•œåƒä¿¡æ¯ã€å®¹å™¨çŠ¶æ€ã€å¿«ç…§å¼•ç”¨ç­‰ï¼‰ï¼Œæ˜¯ containerd çš„æ ¸å¿ƒå…ƒæ•°æ®æ•°æ®åº“ã€‚</td></tr><tr><td><code>io.containerd.runtime.v1.linux/</code></td><td>å­˜å‚¨æ—§ç‰ˆï¼ˆv1 APIï¼‰è¿è¡Œæ—¶å®¹å™¨ä¿¡æ¯ï¼Œç›®å‰å·²é€æ­¥è¢« <code>v2</code> æ¥å£å–ä»£ï¼Œä»…åœ¨å‘åå…¼å®¹åœºæ™¯ä¸­å­˜åœ¨ã€‚</td></tr><tr><td><code>io.containerd.runtime.v2.task/</code></td><td>å­˜å‚¨ v2 è¿è¡Œæ—¶æ¥å£ä¸‹å®¹å™¨çš„è¿è¡Œæ—¶çŠ¶æ€ï¼Œå¦‚å®¹å™¨è¿›ç¨‹çš„ shimã€PIDã€æ—¥å¿—è·¯å¾„ç­‰ï¼Œæ˜¯å®¹å™¨å®é™…è¿è¡Œæ—¶æ‰€ä¾èµ–çš„ã€‚</td></tr><tr><td><code>io.containerd.snapshotter.v1.native/</code></td><td>ä½¿ç”¨ native æ¨¡å¼å­˜å‚¨çš„å®¹å™¨å¿«ç…§ï¼ˆæ–‡ä»¶ç³»ç»Ÿå±‚ï¼‰ï¼Œç›´æ¥å¤åˆ¶åº•å±‚æ–‡ä»¶ï¼›æ€§èƒ½è¾ƒå·®ï¼Œå ç”¨ç©ºé—´è¾ƒå¤§ï¼Œä¸»è¦ç”¨äºæµ‹è¯•æˆ–ç‰¹å®šç”¨é€”ã€‚</td></tr><tr><td><code>io.containerd.snapshotter.v1.overlayfs/</code></td><td>ä½¿ç”¨ overlayfs æ¨¡å¼å­˜å‚¨å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿå¿«ç…§ï¼ˆé•œåƒå±‚å’Œå®¹å™¨å±‚ï¼‰ï¼›è¿™æ˜¯ç”Ÿäº§ç¯å¢ƒé»˜è®¤çš„é«˜æ•ˆå­˜å‚¨é©±åŠ¨ã€‚</td></tr><tr><td><code>tmpmounts/</code></td><td>ä¸´æ—¶æŒ‚è½½ç‚¹ç›®å½•ï¼Œcontainerd ç”¨äºé•œåƒè§£åŒ…ã€ä¸­é—´æ„å»ºè¿‡ç¨‹ä¸­çš„æŒ‚è½½æ“ä½œï¼Œé€šå¸¸æ˜¯æ„å»ºæˆ–è¿è¡Œè¿‡ç¨‹çš„ä¸´æ—¶æ•°æ®ã€‚</td></tr></tbody></table><div class="tips"><p><em><strong>MacOS/Windowsä¸‹æ— æ³•æŸ¥çœ‹<code>/var/lib/docker</code>çš„è§£å†³æ–¹æ³•</strong></em></p><ul class="lvl-1"><li class="lvl-2">åœ¨ MacOS/Windows ä¸Šä½¿ç”¨Dockeræ—¶ï¼Œæ˜¯å¯åŠ¨äº†ä¸€ä¸ªè™šæ‹Ÿæœºæ¥è¿è¡Œdockerçš„ï¼Œç”±äºå…¶è¿è¡Œåœ¨è™šæ‹Ÿæœºå†…éƒ¨ï¼Œç›´æ¥æŸ¥æ‰¾<code>/var/lib/docker</code>è·¯å¾„æ˜¯æ— æ•ˆçš„ã€‚</li><li class="lvl-2">è§£å†³æ–¹æ³•å¦‚ä¸‹ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯åŠ¨ä¸€ä¸ªä¸´æ—¶å®¹å™¨ï¼Œå¹¶è¿›å…¥å…¶å†…éƒ¨</span></span><br><span class="line">docker run --<span class="built_in">rm</span> -it --privileged --pid=host debian nsenter -t 1 -m -u -n -i sh</span><br><span class="line"><span class="comment">## è¯´æ˜</span></span><br><span class="line">--it</span><br><span class="line">    äº¤äº’å¼åœ°è¿è¡Œå®¹å™¨,å¹¶åˆ†é…ä¸€ä¸ªä¼ªç»ˆç«¯</span><br><span class="line"></span><br><span class="line">--<span class="built_in">rm</span></span><br><span class="line">    é€€å‡ºå®¹å™¨æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤å®¹å™¨</span><br><span class="line"></span><br><span class="line">--privileged</span><br><span class="line">    ç»™å®¹å™¨ç‰¹æƒæƒé™ï¼Œè¿™æ„å‘³ç€å®¹å™¨å‡ ä¹æ‹¥æœ‰å®¿ä¸»æœºçš„æ‰€æœ‰èƒ½åŠ›ï¼Œèƒ½è®¿é—® /devã€ä¿®æ”¹å†…æ ¸å‚æ•°ç­‰ã€‚éå¸¸å¼ºå¤§ä½†ä¹Ÿå¾ˆå±é™©ã€‚</span><br><span class="line"></span><br><span class="line">--pid=host</span><br><span class="line">    å®¹å™¨å…±äº«å®¿ä¸»æœºçš„è¿›ç¨‹å‘½åç©ºé—´ï¼ˆPID Namespaceï¼‰ã€‚</span><br><span class="line">    è¿™ä½¿å¾—å®¹å™¨å¯ä»¥çœ‹åˆ°å¹¶è®¿é—®å®¿ä¸»æœºçš„æ‰€æœ‰è¿›ç¨‹ï¼ˆåŒ…æ‹¬ PID 1ï¼Œå³ç³»ç»Ÿ init è¿›ç¨‹ï¼‰ã€‚</span><br><span class="line"></span><br><span class="line">debian</span><br><span class="line">    ä½¿ç”¨çš„åŸºç¡€é•œåƒæ˜¯ Debianï¼Œå®¹å™¨é‡Œè¿è¡Œçš„æ˜¯è¿™ä¸ªç³»ç»Ÿã€‚</span><br><span class="line"></span><br><span class="line">nsenter -t 1 -m -u -n -i sh</span><br><span class="line">    è¿™æ˜¯å®¹å™¨å†…éƒ¨è¿è¡Œçš„å‘½ä»¤ï¼Œç”¨æ¥è¿›å…¥å®¿ä¸»æœºçš„å‘½åç©ºé—´ï¼š</span><br><span class="line">        nsenterï¼šLinux å·¥å…·ï¼Œç”¨äºè¿›å…¥å…¶ä»–è¿›ç¨‹çš„å‘½åç©ºé—´ã€‚</span><br><span class="line">        -t 1ï¼šæŒ‡å®šç›®æ ‡è¿›ç¨‹çš„ PID æ˜¯ 1ï¼ˆå®¿ä¸»æœºçš„ init æˆ– systemdï¼‰ã€‚</span><br><span class="line">        -mï¼šè¿›å…¥ç›®æ ‡è¿›ç¨‹çš„ Mount Namespaceï¼ˆæ–‡ä»¶ç³»ç»ŸæŒ‚è½½ï¼‰ã€‚</span><br><span class="line">        -uï¼šè¿›å…¥ç›®æ ‡çš„ UTS Namespaceï¼ˆä¸»æœºåç­‰ï¼‰ã€‚</span><br><span class="line">        -nï¼šè¿›å…¥ç›®æ ‡çš„ Network Namespaceï¼ˆç½‘ç»œï¼‰ã€‚</span><br><span class="line">        -iï¼šè¿›å…¥ç›®æ ‡çš„ IPC Namespaceï¼ˆè¿›ç¨‹é—´é€šä¿¡ï¼‰ã€‚</span><br><span class="line">        shï¼šåœ¨è¿™äº›å‘½åç©ºé—´ä¸­æ‰§è¡Œä¸€ä¸ª shellã€‚</span><br></pre></td></tr></table></figure><ul class="lvl-1"><li class="lvl-2">è¿™ä¸ªå‘½ä»¤å¯åŠ¨ä¸€ä¸ªåŸºäº Debian çš„å®¹å™¨ï¼Œç»™å®ƒæ‰€æœ‰ç‰¹æƒï¼Œè®©å®ƒèƒ½çœ‹åˆ°å®¿ä¸»æœºçš„è¿›ç¨‹ï¼Œç„¶åä½¿ç”¨ nsenter è¿›å…¥ PID ä¸º 1 çš„æ‰€æœ‰å‘½åç©ºé—´ï¼ˆç›¸å½“äºè¿›å…¥å®¿ä¸»æœºçš„è§†è§’ï¼‰ï¼Œæœ€åå¯åŠ¨ä¸€ä¸ª shï¼Œä½ å°±åœ¨å®¹å™¨é‡Œ â€œå˜æˆäº†å®¿ä¸»æœºâ€ã€‚</li><li class="lvl-2">è¿™æ ·ï¼Œä½ å°±å¯ä»¥åœ¨è¿™ä¸ªå®¹å™¨ä¸­æŸ¥çœ‹<code>/var/lib/docker</code>ç›®å½•äº†ã€‚</li></ul></div><h2 id="Docker-çš„-etc-docker-daemon-json-èƒ½é…ç½®å“ªäº›ä¼˜åŒ–é¡¹">Docker çš„ <code>/etc/docker/daemon.json</code> èƒ½é…ç½®å“ªäº›ä¼˜åŒ–é¡¹</h2><ul class="lvl-0"><li class="lvl-2"><p>é•œåƒåŠ é€Ÿï¼ˆå›½å†…å¸¸ç”¨ï¼‰</p></li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;registry-mirrors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;https://ä½ çš„åŠ é€Ÿåœ°å€&quot;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ§åˆ¶æ—¥å¿—æ–‡ä»¶å¤§å°ä¸æ•°é‡ï¼Œé¿å…æ—¥å¿—æ— é™åˆ¶å¢é•¿å¯¼è‡´ç£ç›˜æ‰“æ»¡ã€‚</p></li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;log-level&quot;</span><span class="punctuation">:</span>  <span class="string">&quot;info&quot;</span><span class="punctuation">,</span> # log-level é…ç½®ä¸º debugã€infoã€warnã€errorã€fatalï¼Œé»˜è®¤ä¸º info</span><br><span class="line">  <span class="attr">&quot;log-driver&quot;</span><span class="punctuation">:</span> <span class="string">&quot;json-file&quot;</span><span class="punctuation">,</span> # log-driver ä¹Ÿå¯ä»¥é…ç½®ä¸º journaldã€syslogã€none ç­‰ã€‚é»˜è®¤ä¸º json-file</span><br><span class="line">  <span class="attr">&quot;log-opts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;max-size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;100m&quot;</span><span class="punctuation">,</span>     #  æ—¥å¿—æ–‡ä»¶å¤§å°</span><br><span class="line">    <span class="attr">&quot;max-file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5&quot;</span>         #  æ—¥å¿—æ–‡ä»¶æ•°é‡</span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>é»˜è®¤ç½‘æ¡¥ç½‘æ®µé…ç½®ï¼ˆé¿å…å’Œå®¿ä¸»æœºç½‘æ®µå†²çªï¼‰</p></li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;bridge&quot;</span><span class="punctuation">:</span> <span class="string">&quot;docker0&quot;</span><span class="punctuation">,</span>       # è®¾ç½®é»˜è®¤ç½‘æ¡¥åç§°ï¼Œé»˜è®¤docker0</span><br><span class="line">  <span class="attr">&quot;bip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;192.168.100.1/24&quot;</span><span class="punctuation">,</span>  #  é»˜è®¤<span class="number">172.17</span><span class="number">.0</span><span class="number">.1</span>/<span class="number">16</span></span><br><span class="line">  <span class="attr">&quot;fixed-cidr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;192.168.100.0/24&quot;</span> # è®¾ç½®å®¹å™¨IPåœ°å€æ®µ</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>é»˜è®¤ ulimit é™åˆ¶æå‡</p></li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;default-ulimits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>   # é»˜è®¤ulimité™åˆ¶</span><br><span class="line">    <span class="attr">&quot;nofile&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nofile&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Hard&quot;</span><span class="punctuation">:</span> <span class="number">65535</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Soft&quot;</span><span class="punctuation">:</span> <span class="number">65535</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å¹¶å‘è¿æ¥ä¼˜åŒ–</p></li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;max-concurrent-downloads&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span> # å¹¶å‘ä¸‹è½½æ•°é‡</span><br><span class="line">  <span class="attr">&quot;max-concurrent-uploads&quot;</span><span class="punctuation">:</span> <span class="number">5</span>     # å¹¶å‘ä¸Šä¼ æ•°é‡</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>DNSé…ç½®ï¼ˆæœ‰äº›å…¬å¸å†…ç½‘éœ€è¦ï¼‰</p></li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;dns&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;8.8.8.8&quot;</span><span class="punctuation">,</span> <span class="string">&quot;114.114.114.114&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç§æœ‰ä»“åº“å…è®¤è¯é…ç½® (ä¸å»ºè®®ç”Ÿäº§ç”¨)</p></li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;insecure-registries&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;registry.example.com:5000&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>é‡å¯Dockeråæ¢å¤å®¹å™¨ï¼Œå»ºè®®è¿˜æ˜¯ä½¿ç”¨å®¹å™¨çš„<code>restart</code>å‚æ•°</p></li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;live-restore&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span>  # å½“è®¾ç½®ä¸º<span class="literal"><span class="keyword">true</span></span>æ—¶ï¼ŒDockerä¼šåœ¨å®ˆæŠ¤è¿›ç¨‹å¯åŠ¨æ—¶å°è¯•é‡å¯æ‰€æœ‰ä¹‹å‰è¿è¡Œä¸­çš„å®¹å™¨ï¼Œé»˜è®¤ä¸º<span class="literal"><span class="keyword">false</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **åŠ ç²—**
 *æ–œä½“*
 ***åŠ ç²—å¹¶æ–œä½“***
 ~~åˆ é™¤çº¿~~
 ==çªå‡ºæ˜¾ç¤º==
 `çªå‡ºæ˜¾ç¤º(æ¨è)`
 ++ä¸‹åˆ’çº¿++
 ~ä¸‹æ ‡~
 ^ä¸Šæ ‡^
 è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.
 å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **ç‚¹å‡»æŠ˜å **
 è¿™æ˜¯è¢«éšè—çš„å†…å®¹
 +++

::: tips success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
:::

% note info % success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
% endnote %

å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}
 å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ
 --&gt;
&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;æœ¬æ–‡ä»‹ç» Linux ä¸‹çš„ Docker å®‰è£…æ–¹æ³•ï¼Œæœ¬æ–‡ä»¥ CentOS 8 ä¸ºä¾‹ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;windowsã€macosã€ubuntuç­‰æ¡Œé¢ç³»ç»Ÿè¯·å®‰è£… &lt;a href=&quot;https://www.docker.com/products/docker-desktop/&quot;&gt;Docker Desktop&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;é˜¿é‡Œäº‘ä¸“æœ‰æœåŠ¡å™¨å‚è€ƒï¼š&lt;a href=&quot;https://help.aliyun.com/zh/ecs/use-cases/install-and-use-docker&quot;&gt;é˜¿é‡Œäº‘ä¸“æœ‰æœåŠ¡å™¨å¦‚ä½•å®‰è£…Docker&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;è…¾è®¯äº‘ä¸“æœ‰æœåŠ¡å™¨å‚è€ƒï¼š&lt;a href=&quot;https://cloud.tencent.com/document/product/1207/45596&quot;&gt;è…¾è®¯äº‘ä¸“æœ‰æœåŠ¡å™¨å¦‚ä½•å®‰è£…Docker&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;AWSä¸“æœ‰æœåŠ¡å™¨å‚è€ƒï¼š&lt;a href=&quot;/2025/05/19/docker-install-aws/&quot; title=&quot;AWSä¸“æœ‰æœåŠ¡å™¨å¦‚ä½•å®‰è£…Docker&quot;&gt;AWSä¸“æœ‰æœåŠ¡å™¨å¦‚ä½•å®‰è£…Docker&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com&quot;&gt;Dockerå®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.docker.com/engine/install/&quot;&gt;å®‰è£…Docker Engine&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/docker/"/>
    
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>AWSä¸“æœ‰æœåŠ¡å™¨å¦‚ä½•å®‰è£…Docker</title>
    <link href="https://blog.hanqunfeng.com/2025/05/19/docker-install-aws/"/>
    <id>https://blog.hanqunfeng.com/2025/05/19/docker-install-aws/</id>
    <published>2025-05-19T13:30:05.000Z</published>
    <updated>2025-06-05T09:08:14.574Z</updated>
    
    <content type="html"><![CDATA[<!-- **åŠ ç²—** *æ–œä½“* ***åŠ ç²—å¹¶æ–œä½“*** ~~åˆ é™¤çº¿~~ ==çªå‡ºæ˜¾ç¤º== `çªå‡ºæ˜¾ç¤º(æ¨è)` ++ä¸‹åˆ’çº¿++ ~ä¸‹æ ‡~ ^ä¸Šæ ‡^ è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference. å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **ç‚¹å‡»æŠ˜å ** è¿™æ˜¯è¢«éšè—çš„å†…å®¹ +++::: tips success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹:::% note info % success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹% endnote %å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{} å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ --><h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2"><p>æœ¬æ–‡ä»‹ç»å¦‚ä½•åœ¨ AWS ä¸“æœ‰æœåŠ¡å™¨ä¸Šå®‰è£… Docker</p></li></ul><span id="more"></span><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Update and install Docker</span></span><br><span class="line"><span class="built_in">sudo</span> yum update -y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Amazon Linux 2</span></span><br><span class="line"><span class="built_in">sudo</span> amazon-linux-extras install docker -y</span><br><span class="line"><span class="comment"># Amazon Linux 2023</span></span><br><span class="line"><span class="built_in">sudo</span> yum install docker -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install Docker Composeï¼Œæ³¨æ„é€šè¿‡è¿™ç§æ–¹å¼å®‰è£…çš„composeçš„ä½¿ç”¨æ–¹å¼ä¸º `docker-compose`ï¼Œè€Œéæ ‡å‡†çš„ `docker compose`</span></span><br><span class="line"><span class="built_in">sudo</span> curl -L <span class="string">&quot;https://github.com/docker/compose/releases/latest/download/docker-compose-<span class="subst">$(uname -s)</span>-<span class="subst">$(uname -m)</span>&quot;</span> -o /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Make the docker-compose command available</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> +x /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable Docker service</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> docker</span><br><span class="line"><span class="comment"># Start the service</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl start docker</span><br><span class="line"><span class="comment"># Add the current user to the docker group</span></span><br><span class="line"><span class="built_in">sudo</span> usermod -aG docker ec2-user</span><br><span class="line"><span class="comment"># è®©ç»„æƒé™ç«‹å³ç”Ÿæ•ˆæœ€ç¨³å¦¥çš„åšæ³•æ˜¯ï¼šæ³¨é”€å¹¶é‡æ–°ç™»å½•è¿œç¨‹ä¸»æœºï¼Œä½†ä¹Ÿå¯ä»¥å°è¯•ç”¨ä¸‹é¢å‘½ä»¤ç«‹å³åŠ è½½æ–°ç»„</span></span><br><span class="line">newgrp docker</span><br><span class="line"><span class="comment"># Check Docker version</span></span><br><span class="line">docker version</span><br><span class="line"><span class="comment"># Test Docker</span></span><br><span class="line">docker run hello-world</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **åŠ ç²—**
 *æ–œä½“*
 ***åŠ ç²—å¹¶æ–œä½“***
 ~~åˆ é™¤çº¿~~
 ==çªå‡ºæ˜¾ç¤º==
 `çªå‡ºæ˜¾ç¤º(æ¨è)`
 ++ä¸‹åˆ’çº¿++
 ~ä¸‹æ ‡~
 ^ä¸Šæ ‡^
 è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.
 å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **ç‚¹å‡»æŠ˜å **
 è¿™æ˜¯è¢«éšè—çš„å†…å®¹
 +++

::: tips success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
:::

% note info % success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
% endnote %

å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}
 å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ
 --&gt;
&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;æœ¬æ–‡ä»‹ç»å¦‚ä½•åœ¨ AWS ä¸“æœ‰æœåŠ¡å™¨ä¸Šå®‰è£… Docker&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/docker/"/>
    
    
    <category term="docker" scheme="https://blog.hanqunfeng.com/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>JVM ä¹‹ å‘½ä»¤è¡Œå·¥å…·</title>
    <link href="https://blog.hanqunfeng.com/2025/05/13/jvm-tools-01/"/>
    <id>https://blog.hanqunfeng.com/2025/05/13/jvm-tools-01/</id>
    <published>2025-05-13T13:30:05.000Z</published>
    <updated>2025-05-19T02:45:12.011Z</updated>
    
    <content type="html"><![CDATA[<!-- **åŠ ç²—** *æ–œä½“* ***åŠ ç²—å¹¶æ–œä½“*** ~~åˆ é™¤çº¿~~ ==çªå‡ºæ˜¾ç¤º== `çªå‡ºæ˜¾ç¤º(æ¨è)` ++ä¸‹åˆ’çº¿++ ~ä¸‹æ ‡~ ^ä¸Šæ ‡^ è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference. å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **ç‚¹å‡»æŠ˜å ** è¿™æ˜¯è¢«éšè—çš„å†…å®¹ +++::: tips success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹:::% note info % success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹% endnote %å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{} å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ --><h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2"><p>æœ¬æ–‡ä»‹ç»JVMçš„å‘½ä»¤è¡Œå·¥å…·</p></li><li class="lvl-2"><p><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/index.html">JDK8 The JavaÂ® Virtual Machine Specification</a></p></li><li class="lvl-2"><p><a href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html">JDK8çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£</a></p></li><li class="lvl-2"><p><a href="https://docs.oracle.com/en/java/javase/17/docs/specs/man/index.html">JDKâ¼¯å…·å®˜â½¹â½‚æ¡£</a></p></li><li class="lvl-2"><p><a href="https://docs.oracle.com/en/java/javase/17/docs/specs/man/java.html">JDK17çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£</a></p></li></ul><span id="more"></span><h2 id="JVM-çš„å‚æ•°-ä¸‰ç±»">JVM çš„å‚æ•°(ä¸‰ç±»)</h2><ul class="lvl-0"><li class="lvl-2"><p>æ ‡å‡†å‚æ•°: ä»¥<code>-</code>å¼€å¤´ï¼Œæ‰€æœ‰ HotSpot éƒ½â½€æŒã€‚ä¾‹å¦‚<code>java -version</code>ã€‚è¿™ç±»å‚æ•°å¯ä»¥ä½¿â½¤<code>java -help</code> æˆ–è€…<code>java -?</code>å…¨éƒ¨æ‰“å°å‡ºæ¥</p></li><li class="lvl-2"><p>â¾®æ ‡å‡†å‚æ•°: ä»¥<code>-X</code>å¼€å¤´ï¼Œæ˜¯ç‰¹å®š HotSpotç‰ˆæœ¬â½€æŒçš„æŒ‡ä»¤ã€‚ä¾‹å¦‚<code>java -Xms200M -Xmx200M</code>ã€‚è¿™ç±»æŒ‡ä»¤å¯ä»¥â½¤<code>java -X</code> å…¨éƒ¨æ‰“å°å‡ºæ¥ã€‚</p></li><li class="lvl-2"><p>ä¸ç¨³å®šå‚æ•°: è¿™ä¹Ÿæ˜¯ JVMè°ƒä¼˜çš„å™©æ¢¦ã€‚ä»¥<code>-XX</code> å¼€å¤´ï¼Œè¿™äº›å‚æ•°æ˜¯è·Ÿç‰¹å®šHotSpotç‰ˆæœ¬å¯¹åº”çš„ï¼Œå¾ˆæœ‰å¯èƒ½æ¢ä¸ªç‰ˆæœ¬å°±æ²¡æœ‰äº†ã€‚è¯¦ç»†çš„â½‚æ¡£èµ„æ–™ä¹Ÿç‰¹åˆ«å°‘ã€‚JDK8 ä¸­çš„ä»¥ä¸‹â¼ä¸ªæŒ‡ä»¤å¯ä»¥å¸®åŠ©å¼€å‘è€…äº†è§£ JDK8 ä¸­çš„è¿™â¼€ç±»ä¸ç¨³å®šå‚æ•°ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java -XX:+PrintFlagsInitial -version   <span class="comment"># æ‰€æœ‰å‚æ•°çš„é»˜è®¤å€¼</span></span><br><span class="line">java -XX:+PrintFlagsFinal -version      <span class="comment"># æ‰€æœ‰å‚æ•°æœ€ç»ˆâ½£æ•ˆçš„å€¼ã€‚</span></span><br><span class="line">java -XX:+UnlockExperimentalVMOptions -XX:+PrintFlagsFinal -version      <span class="comment"># æ‰€æœ‰å‚æ•°æœ€ç»ˆâ½£æ•ˆçš„å€¼ï¼ŒåŒ…å«å®éªŒæ€§å‚æ•°ã€‚</span></span><br><span class="line">java -XX:+PrintCommandLineFlags -version <span class="comment"># å½“å‰å‘½ä»¤ç”Ÿæ•ˆçš„å€¼ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯â½¤çš„å“ªç§GCã€‚ JDK1.8é»˜è®¤â½¤çš„ParallelGC</span></span><br></pre></td></tr></table></figure><h3 id="è¿è¡Œ-java-XX-UnlockExperimentalVMOptions-XX-PrintFlagsFinal-version-è¿”å›å€¼è¯´æ˜">è¿è¡Œ <code>java -XX:+UnlockExperimentalVMOptions -XX:+PrintFlagsFinal -version</code> è¿”å›å€¼è¯´æ˜</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[Global flags]</span><br><span class="line">     intx ActiveProcessorCount                      = -1                                  &#123;product&#125;</span><br><span class="line">    uintx AdaptiveSizeDecrementScaleFactor          = 4                                   &#123;product&#125;</span><br><span class="line">    uintx AdaptiveSizeMajorGCDecayTimeScale         = 10                                  &#123;product&#125;</span><br><span class="line">    uintx AdaptiveSizePausePolicy                   = 0                                   &#123;product&#125;</span><br><span class="line">    uintx AdaptiveSizePolicyCollectionCostMargin    = 50                                  &#123;product&#125;</span><br><span class="line">    uintx AdaptiveSizePolicyInitializingSteps       = 20                                  &#123;product&#125;</span><br><span class="line">    uintx AdaptiveSizePolicyOutputInterval          = 0                                   &#123;product&#125;</span><br><span class="line">    uintx AdaptiveSizePolicyWeight                  = 10                                  &#123;product&#125;</span><br><span class="line">    uintx AdaptiveSizeThroughPutPolicy              = 0                                   &#123;product&#125;</span><br><span class="line">    uintx AdaptiveTimeWeight                        = 25                                  &#123;product&#125;</span><br><span class="line">     bool AdjustConcurrency                         = <span class="literal">false</span>                               &#123;product&#125;</span><br><span class="line">     bool AggressiveHeap                            = <span class="literal">false</span>                               &#123;product&#125;</span><br><span class="line">     bool AggressiveOpts                            = <span class="literal">false</span>                               &#123;product&#125;</span><br><span class="line">     intx AliasLevel                                = 3                                   &#123;C2 product&#125;</span><br><span class="line">     â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class="line"><span class="comment"># æ ¼å¼ï¼šflagç±»å‹ï¼Œflagåç§°ï¼Œflagå€¼ï¼Œflagæ¥æºä¸ä½œç”¨åŸŸä¿®é¥°ç¬¦</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>flagç±»å‹:</p></li></ul><blockquote><p>jdk8</p></blockquote><table><thead><tr><th>æ ‡è¯†ç¬¦</th><th>å«ä¹‰</th><th>æè¿°è¯´æ˜</th></tr></thead><tbody><tr><td><code>intx</code></td><td>æœ‰ç¬¦å·æ•´æ•°ï¼ˆint extendedï¼‰</td><td>ç”¨äºè¡¨ç¤ºå¸¦ç¬¦å·æ•´æ•°å‹å‚æ•°</td></tr><tr><td><code>uintx</code></td><td>æ— ç¬¦å·æ•´æ•°ï¼ˆunsigned int extendedï¼‰</td><td>è¡¨ç¤ºéè´Ÿæ•´æ•°å‹å‚æ•°</td></tr><tr><td><code>uint64_t</code></td><td>æ— ç¬¦å· 64 ä½æ•´æ•°</td><td>é€‚ç”¨äºéœ€è¦æ›´å¤§æ•´æ•°å€¼çš„å‚æ•°ï¼Œæ¯”å¦‚å†…å­˜å¤§å°ã€çº³ç§’æ—¶é—´æˆ³ç­‰</td></tr><tr><td><code>bool</code></td><td>å¸ƒå°”å‹</td><td><code>true</code> æˆ– <code>false</code>ï¼Œè¡¨ç¤ºå¼€å…³å‹å‚æ•°ã€‚<code>+</code>è¡¨ç¤ºå¼€å¯ï¼Œ<code>-</code>è¡¨ç¤ºå…³é—­ã€‚ å¦‚ <code>-XX:+UseG1GC</code>ï¼Œè¡¨ç¤ºå¼€å¯ G1 å›æ”¶å™¨åŠŸèƒ½ã€‚</td></tr><tr><td><code>double</code></td><td>åŒç²¾åº¦æµ®ç‚¹å‹</td><td>ç”¨äºè¡¨ç¤ºæµ®ç‚¹æ•°å€¼ç±»å‹çš„ JVM å‚æ•°</td></tr><tr><td><code>ccstr</code></td><td>å¸¸é‡ C å­—ç¬¦ä¸²æŒ‡é’ˆ</td><td>è¡¨ç¤ºå­—ç¬¦ä¸²å‚æ•°ï¼ˆä¸å¯å˜ï¼‰</td></tr><tr><td><code>ccstrlist</code></td><td>C å­—ç¬¦ä¸²åˆ—è¡¨</td><td>è¡¨ç¤ºä»¥é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²åˆ—è¡¨</td></tr></tbody></table><blockquote><p>jdk11åå‡ºç°æ›´å¤šçš„ç±»å‹</p></blockquote><table><thead><tr><th>æ ‡è¯†ç¬¦</th><th>å«ä¹‰</th><th>æè¿°è¯´æ˜</th></tr></thead><tbody><tr><td><code>int</code></td><td>æœ‰ç¬¦å·æ•´æ•°,é€šå¸¸æ˜¯ 32 ä½</td><td>JVM å†…éƒ¨ä½¿ç”¨çš„æ™®é€š int å‚æ•°</td></tr><tr><td><code>uint</code></td><td>æ— ç¬¦å·æ•´æ•°,é€šå¸¸æ˜¯ 32 ä½</td><td>å°‘é‡ç”¨äºç‰¹æ®Šåœºæ™¯çš„å‚æ•°</td></tr><tr><td><code>size_t</code></td><td>å†…å­˜å¤§å°</td><td>è¡¨ç¤ºå†…å­˜å¤§å°å‚æ•°ï¼ˆå•ä½ä¸€èˆ¬ä¸ºå­—èŠ‚ï¼‰,jdk11åå‡ºç°ï¼ŒåŸæ¥æ˜¯ <code>uintx</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>flagæ¥æºä¸ä½œç”¨åŸŸä¿®é¥°ç¬¦</p></li></ul><blockquote><p>jdk8</p></blockquote><table><thead><tr><th>æ ‡è®°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td><code>&#123;product&#125;</code></td><td>æ­£å¼äº§å“å‚æ•°ï¼ˆç”¨æˆ·å¯ç”¨ï¼Œå¯é€šè¿‡ <code>-XX:</code> è¿›è¡Œè®¾ç½®ï¼‰</td></tr><tr><td><code>&#123;pd product&#125;</code></td><td>å¹³å°ç›¸å…³çš„æ­£å¼å‚æ•°ï¼ˆplatform-dependentï¼‰ï¼Œåœ¨æŸäº›æ“ä½œç³»ç»Ÿ/CPU ä¸Šå¯ç”¨</td></tr><tr><td><code>&#123;C1 product&#125;</code></td><td>ä»…åœ¨ä½¿ç”¨ <strong>C1 ç¼–è¯‘å™¨ï¼ˆä¼˜åŒ–ç¼–è¯‘å™¨ï¼‰</strong> æ—¶æœ‰æ•ˆçš„å‚æ•°</td></tr><tr><td><code>&#123;C2 product&#125;</code></td><td>ä»…åœ¨ä½¿ç”¨ <strong>C2 ç¼–è¯‘å™¨ï¼ˆä¼˜åŒ–ç¼–è¯‘å™¨ï¼‰</strong> æ—¶æœ‰æ•ˆçš„å‚æ•°</td></tr><tr><td><code>&#123;manageable&#125;</code></td><td>å¯é€šè¿‡ JMX åŠ¨æ€ç®¡ç†çš„å‚æ•°ï¼ˆè¿è¡Œæ—¶å¯è°ƒæ•´ï¼‰</td></tr><tr><td><code>&#123;ARCH product&#125;</code></td><td>ä¸ CPU æ¶æ„ç›¸å…³çš„äº§å“å‚æ•°ï¼ˆå¦‚ x86ã€ARM ç­‰ï¼‰</td></tr><tr><td><code>&#123;lp64_product&#125;</code></td><td>ä»…åœ¨ 64 ä½ JVM ä¸Šæ‰æœ‰æ•ˆçš„äº§å“å‚æ•°</td></tr><tr><td><code>&#123;experimental&#125;</code></td><td>å®éªŒæ€§çš„ å‚æ•°ï¼Œå¯èƒ½åœ¨å°†æ¥çš„ç‰ˆæœ¬ä¸­åˆ é™¤æˆ–æ›´æ”¹ã€‚éœ€è¦å¼€å¯ -XX:+UnlockExperimentalVMOptions</td></tr></tbody></table><blockquote><p>jdk11åå‡ºç°æ›´å¤šçš„ç±»å‹</p></blockquote><table><thead><tr><th>æ ‡è®°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td><code>&#123;C1 pd product&#125;</code></td><td>å¹³å°ç›¸å…³çš„æ­£å¼å‚æ•°,ä»…åœ¨ä½¿ç”¨ <strong>C1 ç¼–è¯‘å™¨ï¼ˆä¼˜åŒ–ç¼–è¯‘å™¨ï¼‰</strong> æ—¶æœ‰æ•ˆçš„å‚æ•°</td></tr><tr><td><code>&#123;C2 pd product&#125;</code></td><td>å¹³å°ç›¸å…³çš„æ­£å¼å‚æ•°,ä»…åœ¨ä½¿ç”¨ <strong>C2 ç¼–è¯‘å™¨ï¼ˆä¼˜åŒ–ç¼–è¯‘å™¨ï¼‰</strong> æ—¶æœ‰æ•ˆçš„å‚æ•°</td></tr><tr><td><code>&#123;JVMCI product&#125;</code></td><td>æ­¤å‚æ•°é€‚ç”¨äº JVMCI æˆ– Graal ç¼–è¯‘å™¨ç›¸å…³åŠŸèƒ½ï¼Œjdk21æ·»åŠ </td></tr></tbody></table><blockquote><p>å¦å¤–ï¼Œjdk11+ ä¸­ï¼Œæœ€åè¿˜ä¼šå¤šå‡ºä¸€åˆ—ï¼Œå…¶ä½œç”¨æ˜¯è¯´æ˜è¯¥å‚æ•°çš„è®¾ç½®æ¥æº</p></blockquote><table><thead><tr><th>æ¥æºæ ‡è¯†</th><th>å«ä¹‰è¯´æ˜</th></tr></thead><tbody><tr><td><code>&#123;default&#125;</code></td><td>ä½¿ç”¨çš„æ˜¯è¯¥å‚æ•°çš„é»˜è®¤å€¼ï¼ˆæ²¡æœ‰è¢«ç”¨æˆ·æˆ–ç³»ç»Ÿè®¾ç½®ï¼‰</td></tr><tr><td><code>&#123;command line&#125;</code></td><td>ç”¨æˆ·é€šè¿‡å‘½ä»¤è¡Œæ˜¾å¼è®¾ç½®çš„å‚æ•°ï¼ˆå¦‚ <code>-XX:+UseG1GC</code>ï¼‰</td></tr><tr><td><code>&#123;ergonomic&#125;</code></td><td>JVM æ ¹æ®ç³»ç»Ÿç¯å¢ƒè‡ªåŠ¨é€‰æ‹©çš„å€¼ï¼ˆè‡ªé€‚åº”è®¾ç½®ï¼‰</td></tr></tbody></table><h2 id="jps-æŸ¥çœ‹å½“å‰jvmä¸­çš„è¿›ç¨‹">jps: æŸ¥çœ‹å½“å‰jvmä¸­çš„è¿›ç¨‹</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹javaè¿›ç¨‹ID</span></span><br><span class="line">jps</span><br><span class="line"><span class="comment"># æŸ¥çœ‹javaè¿›ç¨‹ä¿¡æ¯ï¼ŒåŒ…æ‹¬IDå’Œå¯åŠ¨ç±»æˆ–jarçš„åç§°</span></span><br><span class="line">jps -l</span><br><span class="line"><span class="comment"># æŸ¥çœ‹å¯åŠ¨javaè¿›ç¨‹æ—¶ä¼ é€’ç»™jvmçš„å‚æ•°è®¾ç½®</span></span><br><span class="line">jps -v</span><br><span class="line"><span class="comment"># æŸ¥çœ‹javaè¿›ç¨‹ä¿¡æ¯ï¼ŒåŒæ—¶æ˜¾ç¤ºå¯åŠ¨javaè¿›ç¨‹æ—¶ä¼ é€’ç»™jvmçš„å‚æ•°è®¾ç½®</span></span><br><span class="line">jps -lv</span><br></pre></td></tr></table></figure><h2 id="jinfo-æŸ¥çœ‹JVMå‚æ•°">jinfo: æŸ¥çœ‹JVMå‚æ•°</h2><ul class="lvl-0"><li class="lvl-2"><p>jinfo æ˜¯ JDK è‡ªå¸¦çš„å‘½ä»¤è¡Œå·¥å…·ä¹‹ä¸€ï¼Œç”¨äº æŸ¥çœ‹å’Œä¿®æ”¹æ­£åœ¨è¿è¡Œä¸­çš„ Java è¿›ç¨‹çš„é…ç½®ä¿¡æ¯ï¼Œä¸»è¦åŒ…æ‹¬ JVM å‚æ•°ã€ç³»ç»Ÿå±æ€§ç­‰ä¿¡æ¯ã€‚</p></li><li class="lvl-2"><p>åœ¨ Java 9+ ä¹‹åè¢«æ ‡è®°ä¸º deprecatedï¼Œå»ºè®®æ”¹ç”¨ jcmd æ›¿ä»£</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„ JVM å‚æ•°</span></span><br><span class="line">jinfo &lt;PID&gt;</span><br><span class="line"><span class="comment"># jcmd å‘½ä»¤ï¼Œåˆ†æˆä¸‰ä¸ª</span></span><br><span class="line">jcmd &lt;pid&gt; VM.flags <span class="comment"># VM Flags</span></span><br><span class="line">jcmd &lt;pid&gt; VM.system_properties <span class="comment"># System Properties</span></span><br><span class="line">jcmd &lt;pid&gt; VM.command_line <span class="comment"># Command Line</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹çš„ç³»ç»Ÿå±æ€§ï¼ˆ-syspropsï¼‰</span></span><br><span class="line">jinfo -sysprops &lt;PID&gt;</span><br><span class="line"><span class="comment"># jcmd å‘½ä»¤</span></span><br><span class="line">jcmd &lt;pid&gt; VM.system_properties</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ¨æ€ä¿®æ”¹ JVM å‚æ•°ï¼ˆä»…æ”¯æŒéƒ¨åˆ†å‚æ•°ï¼‰</span></span><br><span class="line">jinfo -flag [+|-]&lt;flagname&gt; &lt;pid&gt;</span><br><span class="line"><span class="comment">## ä¾‹ï¼šæ‰“å¼€ GC æ—¥å¿—</span></span><br><span class="line">jinfo -flag +PrintGC &lt;pid&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥æ˜¯å¦å¼€å¯äº†æŸä¸ª JVM ç‰¹æ€§ï¼ˆå¦‚ UseG1GCï¼‰</span></span><br><span class="line">jinfo -flag UseG1GC &lt;pid&gt;</span><br></pre></td></tr></table></figure><h2 id="jstat-æŸ¥çœ‹æŒ‡å®šJAVAè¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€">jstat: æŸ¥çœ‹æŒ‡å®šJAVAè¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹è¿è¡ŒçŠ¶æ€</span></span><br><span class="line">jstat -gc &lt;PID&gt;</span><br><span class="line"><span class="comment"># æŸ¥çœ‹è¿è¡ŒçŠ¶æ€ï¼Œæ¯éš”5000æ¯«ç§’è¾“å‡ºä¸€æ¬¡ï¼Œå…±è¾“å‡º20æ¬¡</span></span><br><span class="line">jstat -gc &lt;PID&gt; 5000 20</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line"> S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT</span><br><span class="line">512.0  512.0   0.0   224.0  29696.0  27138.2   105984.0   96531.8   122368.0 114450.4 15360.0 14018.9    733    5.099   4      0.833    5.931</span><br><span class="line">512.0  512.0   0.0   224.0  29696.0  27203.9   105984.0   96531.8   122368.0 114450.4 15360.0 14018.9    733    5.099   4      0.833    5.931</span><br><span class="line">512.0  512.0   0.0   224.0  29696.0  27220.4   105984.0   96531.8   122368.0 114450.4 15360.0 14018.9    733    5.099   4      0.833    5.931</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å†…å­˜åŒºç»Ÿè®¡ï¼ˆå•ä½ï¼šKBï¼‰</p></li></ul><table><thead><tr><th>åˆ—å</th><th>å«ä¹‰è¯´æ˜</th></tr></thead><tbody><tr><td><strong>S0C</strong></td><td>Survivor 0 åŒºçš„å®¹é‡ï¼ˆKBï¼‰</td></tr><tr><td><strong>S1C</strong></td><td>Survivor 1 åŒºçš„å®¹é‡ï¼ˆKBï¼‰</td></tr><tr><td><strong>S0U</strong></td><td>Survivor 0 åŒºå·²ä½¿ç”¨å†…å­˜ï¼ˆKBï¼‰</td></tr><tr><td><strong>S1U</strong></td><td>Survivor 1 åŒºå·²ä½¿ç”¨å†…å­˜ï¼ˆKBï¼‰</td></tr><tr><td><strong>EC</strong></td><td>Eden åŒºçš„å®¹é‡ï¼ˆKBï¼‰</td></tr><tr><td><strong>EU</strong></td><td>Eden åŒºå·²ä½¿ç”¨å†…å­˜ï¼ˆKBï¼‰</td></tr><tr><td><strong>OC</strong></td><td>Old Generationï¼ˆè€å¹´ä»£ï¼‰çš„å®¹é‡ï¼ˆKBï¼‰</td></tr><tr><td><strong>OU</strong></td><td>Old Generation å·²ä½¿ç”¨å†…å­˜ï¼ˆKBï¼‰</td></tr><tr><td><strong>MC</strong></td><td>Metaspaceï¼ˆå…ƒç©ºé—´ï¼‰çš„å®¹é‡ï¼ˆKBï¼‰</td></tr><tr><td><strong>MU</strong></td><td>Metaspace å·²ä½¿ç”¨å†…å­˜ï¼ˆKBï¼‰</td></tr><tr><td><strong>CCSC</strong></td><td>Compressed Class Space çš„å®¹é‡ï¼ˆKBï¼‰</td></tr><tr><td><strong>CCSU</strong></td><td>Compressed Class Space å·²ä½¿ç”¨å†…å­˜ï¼ˆKBï¼‰</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>GC æ¬¡æ•°ä¸è€—æ—¶(ä»åº”ç”¨ç¨‹åºå¯åŠ¨åˆ°é‡‡æ ·æ—¶)</p></li></ul><table><thead><tr><th>åˆ—å</th><th>å«ä¹‰è¯´æ˜</th></tr></thead><tbody><tr><td><strong>YGC</strong></td><td>Young GCï¼ˆMinor GCï¼‰ çš„ç´¯è®¡æ¬¡æ•°</td></tr><tr><td><strong>YGCT</strong></td><td>Young GC ç´¯è®¡è€—æ—¶ï¼ˆå•ä½ï¼šç§’ï¼‰</td></tr><tr><td><strong>FGC</strong></td><td>Full GC çš„ç´¯è®¡æ¬¡æ•°</td></tr><tr><td><strong>FGCT</strong></td><td>Full GC ç´¯è®¡è€—æ—¶ï¼ˆå•ä½ï¼šç§’ï¼‰</td></tr><tr><td><strong>GCT</strong></td><td>GC æ€»è€—æ—¶ï¼ˆYGCT + FGCTï¼Œæ€»å’Œï¼‰</td></tr></tbody></table><h2 id="jstack-æŸ¥çœ‹æŒ‡å®šJAVAè¿›ç¨‹ä¸­å„çº¿ç¨‹çš„è°ƒç”¨å †æ ˆ">jstack: æŸ¥çœ‹æŒ‡å®šJAVAè¿›ç¨‹ä¸­å„çº¿ç¨‹çš„è°ƒç”¨å †æ ˆ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰“å°çº¿ç¨‹çš„æ ‡å‡†æ ˆä¿¡æ¯ï¼ˆæ ˆå¸§ + çº¿ç¨‹çŠ¶æ€ï¼‰</span></span><br><span class="line">jstack &lt;PID&gt;</span><br><span class="line"><span class="comment"># åœ¨æ ‡å‡†è¾“å‡ºåŸºç¡€ä¸Šï¼Œé¢å¤–æ‰“å°çº¿ç¨‹æ‹¥æœ‰çš„é”ï¼ˆmonitorï¼‰å’Œ waited on é”å¯¹è±¡ä¿¡æ¯</span></span><br><span class="line">jstack -l &lt;PID&gt;</span><br><span class="line"><span class="comment"># è¾“å‡ºåˆ°æ–‡ä»¶</span></span><br><span class="line">jstack -l &lt;PID&gt; &gt; jstack.tdump <span class="comment"># è¿™ä¸ªæ–‡ä»¶ååç¼€åªæ˜¯ä¸ºäº†æ–¹ä¾¿ jvisualvm æŸ¥çœ‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line"><span class="string">&quot;idle-connection-reaper&quot;</span> <span class="comment">#68 daemon prio=5 os_prio=0 tid=0x00007f38b6ae2800 nid=0x62e9 waiting on condition [0x00007f385b0f5000]</span></span><br><span class="line">   java.lang.Thread.State: TIMED_WAITING (sleeping)</span><br><span class="line">at java.lang.Thread.<span class="built_in">sleep</span>(Native Method)</span><br><span class="line">at software.amazon.awssdk.http.apache.internal.conn.IdleConnectionReaper<span class="variable">$ReaperTask</span>.run(IdleConnectionReaper.java:151)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>.run(ThreadPoolExecutor.java:624)</span><br><span class="line">at java.lang.Thread.run(Thread.java:750)</span><br><span class="line"></span><br><span class="line">   Locked ownable synchronizers:</span><br><span class="line">- &lt;0x00000000c561cfd8&gt; (a java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>)</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>jstackè¾“å‡ºå†…å®¹å«ä¹‰</p></li></ul><table><thead><tr><th>å­—æ®µ</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td><code>&quot;idle-connection-reaper&quot;</code></td><td>çº¿ç¨‹åç§°ã€‚è¿™ä¸ªçº¿ç¨‹æ˜¯ AWS SDK ä¸­ç”¨äºæ¸…ç†ç©ºé—²è¿æ¥çš„åå°çº¿ç¨‹ã€‚</td></tr><tr><td><code>#68</code></td><td>çº¿ç¨‹ IDï¼ˆJava å±‚åˆ†é…çš„ç¼–å·ï¼‰ã€‚</td></tr><tr><td><code>daemon</code></td><td>è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª <strong>å®ˆæŠ¤çº¿ç¨‹</strong>ã€‚JVM é€€å‡ºæ—¶ä¸ä¼šç­‰å¾…å®ˆæŠ¤çº¿ç¨‹è¿è¡Œç»“æŸã€‚</td></tr><tr><td><code>prio=5</code></td><td>Java å±‚çš„çº¿ç¨‹ä¼˜å…ˆçº§ï¼ˆé»˜è®¤ 1â€“10ï¼Œ5 æ˜¯é»˜è®¤ï¼‰ã€‚</td></tr><tr><td><code>os_prio=0</code></td><td>æ“ä½œç³»ç»Ÿå±‚çº¿ç¨‹ä¼˜å…ˆçº§ï¼ˆå–å†³äºæ“ä½œç³»ç»Ÿå’Œ JVM çš„å®ç°ï¼‰ã€‚</td></tr><tr><td><code>tid=0x00007f38b6ae2800</code></td><td>çº¿ç¨‹ IDï¼ˆJava å±‚ä½¿ç”¨çš„åœ°å€æ ‡è¯†ï¼‰ã€‚</td></tr><tr><td><code>nid=0x62e9</code></td><td>Native IDï¼Œæ“ä½œç³»ç»Ÿåˆ†é…çš„çº¿ç¨‹ IDï¼ˆåå…­è¿›åˆ¶è¡¨ç¤ºï¼‰ï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤<code>printf &quot;%d\n&quot; 0x62e9</code>è½¬æ¢ä¸º10è¿›åˆ¶ã€‚<br>  <code>ps -Lp &lt;PID&gt;</code> å’Œ <code>top -Hp &lt;PID&gt;</code> å±•ç¤ºçš„çº¿ç¨‹idæ˜¯10è¿›åˆ¶</td></tr><tr><td><code>waiting on condition</code></td><td>çº¿ç¨‹çŠ¶æ€è¯´æ˜ï¼šæ­£åœ¨ç­‰å¾…æŸç§æ¡ä»¶ï¼Œä¸€èˆ¬æŒ‡ <code>sleep()</code> æˆ– <code>wait()</code> ç­‰ã€‚</td></tr><tr><td><code>[0x00007f385b0f5000]</code></td><td>æ ˆå¸§çš„å†…å­˜åœ°å€ã€‚</td></tr><tr><td><code>java.lang.Thread.State: TIMED_WAITING (sleeping)</code></td><td>çº¿ç¨‹çŠ¶æ€ã€‚</td></tr><tr><td><code>at java.lang.Thread.sleep(Native Method)</code> <br> â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</td><td>çº¿ç¨‹è°ƒç”¨æ ˆä¿¡æ¯ï¼ŒåŒ…æ‹¬è°ƒç”¨æ–¹æ³•ã€è°ƒç”¨å‚æ•°ã€è°ƒç”¨æ ˆå¸§ã€‚</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>å¦å¤–è¿˜æœ‰å¦‚ä¸‹ä¿¡æ¯ï¼Œè¡¨ç¤ºæ­¤çº¿ç¨‹æŒæœ‰çš„å¯æ‹¥æœ‰åŒæ­¥å™¨ï¼ˆä¾‹å¦‚ ReentrantLockï¼‰ï¼Œå…·ä½“å†…å®¹å¦‚ä¸‹ï¼š</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Locked ownable synchronizers:</span><br><span class="line">- &lt;0x00000000c561cfd8&gt; (a java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>)</span><br></pre></td></tr></table></figure><table><thead><tr><th>å†…å®¹</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td><code>&lt;0x00000000c561cfd8&gt;</code></td><td>æŒæœ‰é”çš„å¯¹è±¡åœ°å€ã€‚å¯ä»¥åœ¨å…¶ä»–çº¿ç¨‹ä¸­æŸ¥æ‰¾è¿™ä¸ªåœ°å€ï¼Œä»¥åˆ¤æ–­æ­»é”ç­‰é—®é¢˜ã€‚</td></tr><tr><td><code>(a ThreadPoolExecutor$Worker)</code></td><td>è¡¨ç¤ºè¯¥é”å±äº <code>ThreadPoolExecutor</code> çš„æŸä¸ª <code>Worker</code> çº¿ç¨‹ï¼ˆè¿™æ˜¯çº¿ç¨‹æ± çš„å·¥ä½œçº¿ç¨‹ï¼‰ã€‚</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>çº¿ç¨‹çŠ¶æ€</p></li></ul><table><thead><tr><th>çŠ¶æ€</th><th>å«ä¹‰</th><th>å¸¸è§åŸå›  / ç¤ºä¾‹æ–¹æ³•</th><th>ç¤ºä¾‹ jstack è¾“å‡º</th></tr></thead><tbody><tr><td><code>RUNNABLE</code></td><td>çº¿ç¨‹æ­£åœ¨è¿è¡Œæˆ–å‡†å¤‡è¿è¡Œï¼Œç­‰å¾… CPU æ—¶é—´ç‰‡ã€‚</td><td>çº¿ç¨‹æ´»è·ƒè¿è¡Œä¸­</td><td><code>&quot;Thread-0&quot; #1 prio=5 os_prio=0 tid=0x00007f8d9c001000 nid=0x1a runnable [0x00007f8dbf7fe000]</code></td></tr><tr><td><code>BLOCKED (on object monitor)</code></td><td>ç­‰å¾…è·å–å¯¹è±¡çš„ç›‘è§†å™¨é”ï¼ˆåŒæ­¥é”ï¼‰ï¼Œå³ç­‰å¾…è¿›å…¥åŒæ­¥å—æˆ–æ–¹æ³•ã€‚</td><td><code>synchronized</code> åŒæ­¥å—æˆ–æ–¹æ³•</td><td><code>&quot;Thread-1&quot; #2 prio=5 os_prio=0 tid=0x00007f8d9c002000 nid=0x1b waiting for monitor entry [0x00007f8dbeaff000]</code></td></tr><tr><td><code>WAITING (on object monitor)</code></td><td>æ— é™æœŸç­‰å¾…å…¶ä»–çº¿ç¨‹æ‰§è¡ŒæŸæ“ä½œã€‚</td><td><code>Object.wait()</code><br><code>Thread.join()</code><br><code>LockSupport.park()</code><br><code>Condition.await()</code></td><td><code>&quot;Thread-2&quot; #3 prio=5 os_prio=0 tid=0x00007f8d9c003000 nid=0x1c waiting on condition [0x00007f8dbebff000]</code></td></tr><tr><td><code>TIMED_WAITING (on object monitor)</code></td><td>ç­‰å¾…å›ºå®šæ—¶é—´ï¼Œç›´åˆ°æ¡ä»¶æ»¡è¶³æˆ–è¶…æ—¶ã€‚</td><td><code>Object.wait(long)</code><br><code>Thread.sleep(long)</code><br><code>Condition.awaitNanos(long)</code><br><code>DelayQueue.take()</code></td><td><code>&quot;Thread-3&quot; #4 prio=5 os_prio=0 tid=0x00007f8d9c004000 nid=0x1d timed_waiting [0x00007f8dbebff000]</code></td></tr><tr><td><code>TERMINATED</code></td><td>çº¿ç¨‹å·²è¿è¡Œå®Œæ¯•å¹¶é€€å‡ºï¼ˆé€šå¸¸ä¸åœ¨ jstack ä¸­æ˜¾ç¤ºï¼‰ã€‚</td><td>-</td><td>-</td></tr></tbody></table><h3 id="ä½¿ç”¨jstackæ£€æŸ¥æ­»é”">ä½¿ç”¨jstackæ£€æŸ¥æ­»é”</h3><ul class="lvl-0"><li class="lvl-2"><p>æ­»é”æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”ï¼Œå¯¼è‡´æ— æ³•ç»§ç»­è¿è¡Œçš„æƒ…å†µã€‚</p></li></ul><h4 id="ç›´æ¥æŸ¥æ‰¾-Found-one-Java-level-deadlock-æç¤º">ç›´æ¥æŸ¥æ‰¾ <code>Found one Java-level deadlock</code> æç¤º</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Found one Java-level deadlock:</span><br><span class="line">=============================</span><br><span class="line"><span class="string">&quot;Thread-1&quot;</span>:</span><br><span class="line">  waiting to lock monitor 0x0000000005c0a098 (object 0x00000000d5c10a70, a java.lang.Object),</span><br><span class="line">  <span class="built_in">which</span> is held by <span class="string">&quot;Thread-2&quot;</span></span><br><span class="line"><span class="string">&quot;Thread-2&quot;</span>:</span><br><span class="line">  waiting to lock monitor 0x0000000005c0a128 (object 0x00000000d5c10aa0, a java.lang.Object),</span><br><span class="line">  <span class="built_in">which</span> is held by <span class="string">&quot;Thread-1&quot;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>è¡¨ç¤ºä¸¤ä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”ï¼Œé€ æˆæ­»é”ã€‚</p></li><li class="lvl-2"><p>ç›®å‰åªæ”¯æŒæ‰¾å‡º <code>synchronized</code> å…³é”®å­—é˜»å¡ä½çš„çº¿ç¨‹ï¼Œå¦‚æœæ˜¯ <code>java.util.concurrent.Lock</code> ç›®å‰è¿˜ä¸æ”¯æŒã€‚</p></li></ul><h4 id="æ‰‹åŠ¨åˆ¤æ–­æ­»é”çš„ç‰¹å¾ï¼ˆå¦‚æœæ²¡æœ‰ä¸Šé¢çš„æç¤ºï¼‰">æ‰‹åŠ¨åˆ¤æ–­æ­»é”çš„ç‰¹å¾ï¼ˆå¦‚æœæ²¡æœ‰ä¸Šé¢çš„æç¤ºï¼‰</h4><ul class="lvl-0"><li class="lvl-2"><p>å¦‚æœ JVM æ²¡æœ‰æ˜¾å¼æç¤ºï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ­»é”ç‰¹å¾è¿›è¡Œæ‰‹åŠ¨è¯†åˆ«ï¼š</p></li></ul><table><thead><tr><th>ç‰¹å¾</th><th>æè¿°</th></tr></thead><tbody><tr><td>çº¿ç¨‹å¤„äº <code>BLOCKED</code> çŠ¶æ€</td><td>çº¿ç¨‹è¢«é”é˜»å¡åœ¨ <code>monitor</code> ä¸Šã€‚</td></tr><tr><td><code>waiting to lock</code> å’Œ <code>locked</code> å‡ºç°äº¤å‰</td><td>ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æŒæœ‰çš„é”ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹ä¹Ÿåœ¨ç­‰å¾…å½“å‰çº¿ç¨‹çš„é”ã€‚</td></tr><tr><td>æ²¡æœ‰èƒ½ç»§ç»­æ‰§è¡Œçš„çº¿ç¨‹</td><td>å¤šä¸ªçº¿ç¨‹éƒ½å¤„äº <code>BLOCKED</code> çŠ¶æ€ï¼Œä¸”ç›¸äº’ä¾èµ–ã€‚</td></tr></tbody></table><div class="tips"><p><em><strong>åœ¨ Java 8 ä¹‹åæ”¯æŒè·å– JVM å†…éƒ¨çº¿ç¨‹</strong></em></p><ul class="lvl-1"><li class="lvl-2">VM å†…éƒ¨çº¿ç¨‹åŒ…æ‹¬ä¸‹é¢å‡ ç§ï¼š</li></ul><table><thead><tr><th>çº¿ç¨‹ç±»å‹</th><th>ç¤ºä¾‹åç§°</th></tr></thead><tbody><tr><td>JITï¼ˆJust-In-Timeï¼‰ç¼–è¯‘çº¿ç¨‹</td><td>C1 CompilerThread0, C2 CompilerThread0</td></tr><tr><td>GC çº¿ç¨‹</td><td>GC Thread0, G1 Young RemSet Sampling</td></tr><tr><td>å…¶å®ƒå†…éƒ¨çº¿ç¨‹</td><td>VM Periodic Task Thread, VM Thread, Service Thread</td></tr></tbody></table><ul class="lvl-1"><li class="lvl-2"><p>è‡ª JDK 7 åŠä»¥ä¸Šç‰ˆæœ¬å¼€å§‹ï¼ŒHotSpot JVM é»˜è®¤å¯ç”¨äº†ï¼šåˆ†å±‚ç¼–è¯‘ï¼ˆTiered Compilationï¼‰ï¼Œå³åŒæ—¶ä½¿ç”¨ C1 å’Œ C2 ç¼–è¯‘å™¨ã€‚</p></li></ul><table><thead><tr><th>ç¼–è¯‘å™¨</th><th>ç‰¹æ€§</th><th>ç”¨é€”</th></tr></thead><tbody><tr><td><strong>C1ï¼ˆClient Compilerï¼‰</strong></td><td>ç¼–è¯‘é€Ÿåº¦å¿«ï¼Œä¼˜åŒ–å°‘</td><td>ç¨‹åºå¯åŠ¨æ—¶ä½¿ç”¨ï¼Œæå‡å¯åŠ¨é€Ÿåº¦</td></tr><tr><td><strong>C2ï¼ˆServer Compilerï¼‰</strong></td><td>ç¼–è¯‘é€Ÿåº¦æ…¢ï¼Œä¼˜åŒ–å¼º</td><td>çƒ­ç‚¹ä»£ç è¾¾åˆ°ä¸€å®šé—¨æ§›åä½¿ç”¨ï¼Œæå‡é•¿æœŸè¿è¡Œæ€§èƒ½</td></tr></tbody></table><blockquote><p>JVM å¯åŠ¨åï¼Œå…ˆè§£é‡Šæ‰§è¡Œå­—èŠ‚ç ï¼›çƒ­ç‚¹ä»£ç é¦–å…ˆç”± C1 ç¼–è¯‘å™¨å¤„ç†ï¼›å¦‚æœè¿›ä¸€æ­¥å˜çƒ­ï¼Œäº¤ç”± C2 ç¼–è¯‘å™¨ä¼˜åŒ–ï¼›æ•´ä¸ªè¿‡ç¨‹ç”± JVM è‡ªåŠ¨ç®¡ç†ï¼Œä¸éœ€è¦æ‰‹åŠ¨å¹²é¢„ã€‚</p></blockquote><ul class="lvl-1"><li class="lvl-2"><p>æ˜¯å¦å¯ä»¥æŒ‡å®šåªç”¨æŸä¸ªç¼–è¯‘å™¨ï¼Ÿæ˜¯çš„ï¼Œä½ å¯ä»¥ç”¨ JVM å‚æ•°æ§åˆ¶ï¼Œä½†çœŸæ²¡å¿…è¦ã€‚</p></li></ul><table><thead><tr><th>å‚æ•°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td><code>-client</code></td><td>ä½¿ç”¨ C1 ç¼–è¯‘å™¨ï¼ˆé€‚åˆå¯åŠ¨å¿«ï¼‰</td></tr><tr><td><code>-server</code></td><td>ä½¿ç”¨ C2 ç¼–è¯‘å™¨ï¼ˆé€‚åˆé•¿æ—¶é—´è¿è¡Œçš„æœåŠ¡ï¼‰</td></tr><tr><td><code>-XX:-TieredCompilation</code></td><td>ç¦ç”¨åˆ†å±‚ç¼–è¯‘ï¼Œä»…ä½¿ç”¨ <code>-client</code> æˆ– <code>-server</code> æŒ‡å®šçš„ç¼–è¯‘å™¨</td></tr></tbody></table></div><h2 id="jmap-åˆ†æè¿è¡Œä¸­-Java-è¿›ç¨‹çš„å†…å­˜ä½¿ç”¨æƒ…å†µ">jmap: åˆ†æè¿è¡Œä¸­ Java è¿›ç¨‹çš„å†…å­˜ä½¿ç”¨æƒ…å†µ</h2><ul class="lvl-0"><li class="lvl-2"><p>jmap æ¯”è¾ƒæ¶ˆè€—å†…å­˜ï¼Œæ‰€ä»¥ä¸æ¨èç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚</p></li></ul><h3 id="jmap-histo-pid-æŸ¥çœ‹ç±»å®ä¾‹æ•°é‡åŠå ç”¨å†…å­˜"><code>jmap -histo &lt;pid&gt;</code>: æŸ¥çœ‹ç±»å®ä¾‹æ•°é‡åŠå ç”¨å†…å­˜</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ jmap -histo 25238</span><br><span class="line">25238:</span><br><span class="line"></span><br><span class="line"> num     <span class="comment">#instances         #bytes  class name</span></span><br><span class="line">----------------------------------------------</span><br><span class="line">   1:        106175       10838440  [C</span><br><span class="line">   2:         94344        3019008  java.util.concurrent.ConcurrentHashMap<span class="variable">$Node</span></span><br><span class="line">   3:        105529        2532696  java.lang.String</span><br><span class="line">   4:         11203        2496608  [B</span><br><span class="line">   5:         20178        2430136  [Ljava.lang.Object;</span><br><span class="line">   6:         21642        2399904  java.lang.Class</span><br><span class="line">â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class="line">Total        857252       51328200</span><br><span class="line"></span><br><span class="line"><span class="comment"># num: åºå·</span></span><br><span class="line"><span class="comment"># instances: å®ä¾‹æ•°é‡</span></span><br><span class="line"><span class="comment"># bytes: å®ä¾‹å­—èŠ‚æ•°</span></span><br><span class="line"><span class="comment"># class name: ç±»å, [C is a char[]ï¼Œ[S is a short[]ï¼Œ[I is a int[]ï¼Œ[B is a byte[]ï¼Œ[L is a List</span></span><br><span class="line"><span class="comment"># Total: æ€»æ•°</span></span><br></pre></td></tr></table></figure><h3 id="jmap-heap-pid-æŸ¥çœ‹å †ä½¿ç”¨æƒ…å†µ"><code>jmap -heap &lt;pid&gt;</code>: æŸ¥çœ‹å †ä½¿ç”¨æƒ…å†µ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">$ jmap -heap 25238</span><br><span class="line">Attaching to process ID 25238, please <span class="built_in">wait</span>...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.371-b11</span><br><span class="line"></span><br><span class="line">using thread-local object allocation.</span><br><span class="line">Parallel GC with 2 thread(s)</span><br><span class="line"></span><br><span class="line">Heap Configuration:    <span class="comment"># å †é…ç½®</span></span><br><span class="line">   MinHeapFreeRatio         = 0                     <span class="comment"># æœ€å°ç©ºé—²ç™¾åˆ†æ¯”</span></span><br><span class="line">   MaxHeapFreeRatio         = 100                     <span class="comment"># æœ€å¤§ç©ºé—²ç™¾åˆ†æ¯”</span></span><br><span class="line">   MaxHeapSize              = 1010827264 (964.0MB)    <span class="comment"># æœ€å¤§å †å¤§å°</span></span><br><span class="line">   NewSize                  = 21495808 (20.5MB)       <span class="comment"># æ–°ç”Ÿä»£å¤§å°</span></span><br><span class="line">   MaxNewSize               = 336592896 (321.0MB)     <span class="comment"># æ–°ç”Ÿä»£æœ€å¤§å¤§å°</span></span><br><span class="line">   OldSize                  = 43515904 (41.5MB)       <span class="comment"># è€å¹´ä»£å¤§å°</span></span><br><span class="line">   NewRatio                 = 2                       <span class="comment"># æ–°ç”Ÿä»£ä¸è€å¹´ä»£æ¯”ä¾‹</span></span><br><span class="line">   SurvivorRatio            = 8                       <span class="comment"># å¹¸å­˜è€…æ¯”ä¾‹</span></span><br><span class="line">   MetaspaceSize            = 21807104 (20.796875MB)   <span class="comment"># å…ƒç©ºé—´å¤§å°</span></span><br><span class="line">   CompressedClassSpaceSize = 1073741824 (1024.0MB)   <span class="comment"># å‹ç¼©ç±»ç©ºé—´å¤§å°ï¼Œç”¨äºå­˜å‚¨æ‰€æœ‰ ç±»æŒ‡é’ˆï¼ˆKlass pointerï¼‰</span></span><br><span class="line">   MaxMetaspaceSize         = 17592186044415 MB       <span class="comment"># å…ƒç©ºé—´æœ€å¤§å¤§å°</span></span><br><span class="line">   G1HeapRegionSize         = 0 (0.0MB)               <span class="comment"># G1å †å¤§å°</span></span><br><span class="line"></span><br><span class="line">Heap Usage:       <span class="comment"># å †ä½¿ç”¨æƒ…å†µ</span></span><br><span class="line">PS Young Generation <span class="comment"># å¹´è½»ç”Ÿä»£</span></span><br><span class="line">Eden Space:         <span class="comment"># Eden åŒº</span></span><br><span class="line">   capacity = 30932992 (29.5MB)    <span class="comment">#  Eden åŒºå¤§å°</span></span><br><span class="line">   used     = 16705104 (15.931228637695312MB) <span class="comment">#  Eden åŒºä½¿ç”¨æƒ…å†µ</span></span><br><span class="line">   free     = 14227888 (13.568771362304688MB) <span class="comment">#  Eden åŒºå‰©ä½™æƒ…å†µ</span></span><br><span class="line">   54.00416487354343% used                    <span class="comment">#  Eden åŒºä½¿ç”¨ç™¾åˆ†æ¯”</span></span><br><span class="line">From Space:                      <span class="comment"># å¹¸å­˜è€…åŒº survivor0</span></span><br><span class="line">   capacity = 524288 (0.5MB)</span><br><span class="line">   used     = 0 (0.0MB)</span><br><span class="line">   free     = 524288 (0.5MB)</span><br><span class="line">   0.0% used</span><br><span class="line">To Space:                       <span class="comment"># å¹¸å­˜è€…åŒº survivor1</span></span><br><span class="line">   capacity = 524288 (0.5MB)</span><br><span class="line">   used     = 0 (0.0MB)</span><br><span class="line">   free     = 524288 (0.5MB)</span><br><span class="line">   0.0% used</span><br><span class="line">PS Old Generation                <span class="comment"># è€å¹´ä»£</span></span><br><span class="line">   capacity = 193462272 (184.5MB)</span><br><span class="line">   used     = 43292112 (41.28657531738281MB)</span><br><span class="line">   free     = 150170160 (143.2134246826172MB)</span><br><span class="line">   22.377547597497458% used</span><br><span class="line"></span><br><span class="line">38722 interned Strings occupying 4184168 bytes. <span class="comment"># å †ä¸­å­—ç¬¦ä¸²æ•°é‡åŠå ç”¨å†…å­˜</span></span><br></pre></td></tr></table></figure><h3 id="jmap-dump-live-format-b-file-file-pid-åˆ›å»ºä¸€ä¸ªå¿«ç…§ï¼Œå¹¶ä¿å­˜åˆ°æ–‡ä»¶ä¸­"><code>jmap -dump:live,format=b,file=&lt;file&gt; &lt;pid&gt;</code>: åˆ›å»ºä¸€ä¸ªå¿«ç…§ï¼Œå¹¶ä¿å­˜åˆ°æ–‡ä»¶ä¸­</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªå¿«ç…§ï¼Œå¹¶ä¿å­˜åˆ°å½“å‰ç›®å½•ä¸‹</span></span><br><span class="line">$ jmap -dump:live,format=b,file=test.hprof 25238</span><br><span class="line">Dumping heap to /tmp/test.hprof ...</span><br><span class="line">Heap dump file created</span><br></pre></td></tr></table></figure><h2 id="jcmd-å¯ä»¥æ›¿ä»£jmapå‘½ä»¤ï¼Œjdk1-8-æ¨èä½¿ç”¨">jcmd: å¯ä»¥æ›¿ä»£<code>jmap</code>å‘½ä»¤ï¼Œ<code>jdk1.8+</code>æ¨èä½¿ç”¨</h2><ul class="lvl-0"><li class="lvl-2"><p><code>jcmd</code> æ˜¯ <code>JDK</code> çš„ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºç®¡ç† <code>JVM</code>ï¼Œ<code>jcmd</code> å¯ä»¥æŸ¥çœ‹ <code>JVM</code> çš„è¿è¡ŒçŠ¶æ€ã€æŸ¥çœ‹å †å†…å­˜ä¿¡æ¯ã€è§¦å‘ GCã€æŸ¥çœ‹çº¿ç¨‹ä¿¡æ¯ã€æŸ¥çœ‹ç±»ä¿¡æ¯ç­‰ç­‰ã€‚</p></li><li class="lvl-2"><p>ç”Ÿäº§ç¯å¢ƒä¸å»ºè®®ä½¿ç”¨<code>jmap</code>ï¼Œå› å…¶ä¼šå ç”¨å¤§é‡å†…å­˜ï¼Œæ¨èä½¿ç”¨ <code>jcmd</code>ã€‚</p></li></ul><h3 id="jcmd-pid-GC-heap-info-æŸ¥çœ‹å †ä½¿ç”¨æƒ…å†µ"><code>jcmd &lt;pid&gt; GC.heap_info</code>: æŸ¥çœ‹å †ä½¿ç”¨æƒ…å†µ</h3><ul class="lvl-0"><li class="lvl-2"><p>ç±»ä¼¼ <code>jmap -heap &lt;pid&gt;</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ jcmd 25238 GC.heap_info</span><br><span class="line">25238:</span><br><span class="line"> PSYoungGen      total 30208K, used 23593K [0x00000000ebf00000, 0x00000000edd80000, 0x0000000100000000)</span><br><span class="line">  eden space 29696K, 78% used [0x00000000ebf00000,0x00000000ed5d2560,0x00000000edc00000)</span><br><span class="line">  from space 512K, 43% used [0x00000000edd00000,0x00000000edd38000,0x00000000edd80000)</span><br><span class="line">  to   space 512K, 0% used [0x00000000edc80000,0x00000000edc80000,0x00000000edd00000)</span><br><span class="line"> ParOldGen       total 105984K, used 96547K [0x00000000c3c00000, 0x00000000ca380000, 0x00000000ebf00000)</span><br><span class="line">  object space 105984K, 91% used [0x00000000c3c00000,0x00000000c9a48f10,0x00000000ca380000)</span><br><span class="line"> Metaspace       used 114450K, capacity 122262K, committed 122368K, reserved 1157120K</span><br><span class="line">  class space    used 14018K, capacity 15294K, committed 15360K, reserved 1048576K</span><br></pre></td></tr></table></figure><h3 id="jcmd-pid-GC-class-histogram-æŸ¥çœ‹ç±»åŠ è½½æƒ…å†µ"><code>jcmd &lt;pid&gt; GC.class_histogram</code>: æŸ¥çœ‹ç±»åŠ è½½æƒ…å†µ</h3><ul class="lvl-0"><li class="lvl-2"><p>ç±»ä¼¼ <code>jmap -histo &lt;pid&gt;</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ jcmd 25238 GC.class_histogram</span><br><span class="line">25238:</span><br><span class="line"></span><br><span class="line"> num     <span class="comment">#instances         #bytes  class name</span></span><br><span class="line">----------------------------------------------</span><br><span class="line">   1:        106175       10838440  [C</span><br><span class="line">   2:         94344        3019008  java.util.concurrent.ConcurrentHashMap<span class="variable">$Node</span></span><br><span class="line">   3:        105529        2532696  java.lang.String</span><br><span class="line">   4:         11203        2496608  [B</span><br><span class="line">   5:         20178        2430136  [Ljava.lang.Object;</span><br><span class="line">   6:         21642        2399904  java.lang.Class</span><br><span class="line">â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class="line">Total        857252       51328200</span><br><span class="line"></span><br><span class="line"><span class="comment"># num: åºå·</span></span><br><span class="line"><span class="comment"># instances: å®ä¾‹æ•°é‡</span></span><br><span class="line"><span class="comment"># bytes: å®ä¾‹å­—èŠ‚æ•°</span></span><br><span class="line"><span class="comment"># class name: ç±»å, [C is a char[]ï¼Œ[S is a short[]ï¼Œ[I is a int[]ï¼Œ[B is a byte[]ï¼Œ[L is a List</span></span><br><span class="line"><span class="comment"># Total: æ€»æ•°</span></span><br></pre></td></tr></table></figure><h3 id="jcmd-pid-GC-heap-dump-path-to-heap-hprof-å¯¼å‡º-heap-dump"><code>jcmd &lt;pid&gt; GC.heap_dump /path/to/heap.hprof</code>: å¯¼å‡º heap dump</h3><ul class="lvl-0"><li class="lvl-2"><p>æ›¿ä»£ <code>jmap -dump:format=b,file=heap.hprof &lt;pid&gt;</code>ï¼Œä½†ä»ä¼šæœ‰åœé¡¿ï¼ˆè§¦å‘FullGCï¼‰ï¼Œdump è¿‡ç¨‹æ…¢ï¼Œç”Ÿäº§ç¯å¢ƒæ…é‡ä½¿ç”¨</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ jcmd 25238 GC.heap_dump ./heap.hprof</span><br><span class="line">25238:</span><br><span class="line">Heap dump file created</span><br><span class="line"><span class="comment"># æ³¨æ„è¿™é‡Œä½¿ç”¨çš„æ˜¯ç›¸å¯¹ç›®å½•ï¼Œ./heap.hprofï¼Œä½†æ­¤æ—¶ &quot;./&quot; å¹¶ä¸æ˜¯è¿è¡Œå‘½ä»¤æ—¶æ‰€åœ¨çš„ç›®å½•ï¼Œè€Œæ˜¯æŒ‡ Java è¿›ç¨‹çš„å·¥ä½œç›®å½•ï¼Œå¦‚æœä½ ä¸çŸ¥é“å·¥ä½œç›®å½•ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹</span></span><br><span class="line">jcmd &lt;pid&gt; VM.system_properties | grep <span class="string">&quot;user.dir&quot;</span></span><br><span class="line"><span class="comment"># linuxä¸‹ä¹Ÿå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹</span></span><br><span class="line"><span class="built_in">ls</span> -l /proc/&lt;pid&gt;/cwd</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å› ä¸ºç”Ÿäº§ç¯å¢ƒä¸æ¨èä½¿ç”¨ <code>jmap</code> æˆ– <code>jcmd</code> å¯¼å‡º heap dumpï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­é…ç½®å¦‚ä¸‹jvmå‚æ•°</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-XX:+HeadDumpOnOutOfMemoryError <span class="comment"># å†…å­˜æº¢å‡ºï¼ˆOOMï¼‰æ—¶ä¼šè‡ªåŠ¨ä¿å­˜å †å†…å­˜å¿«ç…§æ–‡ä»¶</span></span><br><span class="line">-XX:HeapDumpPath=/path/to/dump.hprof <span class="comment"># æŒ‡å®šå †å†…å­˜å¿«ç…§æ–‡ä»¶ä¿å­˜è·¯å¾„ï¼Œå¦‚æœä¸é…ç½®ï¼Œåˆ™é»˜è®¤ä¿å­˜åœ¨ Java è¿›ç¨‹çš„å·¥ä½œç›®å½•ä¸‹ï¼Œæ–‡ä»¶åç§°é»˜è®¤ä¸º java_&lt;pid&gt;.hprof</span></span><br></pre></td></tr></table></figure><h2 id="jhat-åˆ†æ-Java-Heap-Dump-æ–‡ä»¶ï¼ˆ-hprofï¼‰çš„å·¥å…·">jhat: åˆ†æ Java Heap Dump æ–‡ä»¶ï¼ˆ.hprofï¼‰çš„å·¥å…·</h2><ul class="lvl-0"><li class="lvl-2"><p>jhatï¼ˆJava Heap Analysis Toolï¼‰æ˜¯ JDK é™„å¸¦çš„ä¸€ä¸ªç”¨äº**åˆ†æ Java Heap Dump æ–‡ä»¶ï¼ˆ.hprofï¼‰**çš„å·¥å…·ã€‚å®ƒå¯ä»¥å°†å †å¿«ç…§ä½œä¸º HTTP æœåŠ¡åŠ è½½ï¼Œå¹¶å…è®¸ä½ é€šè¿‡æµè§ˆå™¨äº¤äº’å¼åœ°æŸ¥çœ‹å’ŒæŸ¥è¯¢å¯¹è±¡ä¿¡æ¯ã€‚</p></li><li class="lvl-2"><p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼š<br>ğŸ”º ä» JDK 9 èµ·ï¼Œjhat å·²è¢«å®˜æ–¹åºŸå¼ƒï¼Œæ¨èä½¿ç”¨æ›´å¼ºå¤§çš„å·¥å…·å¦‚ <code>VisualVM</code>ã€<code>Eclipse MAT</code> æˆ– <code>jcmd + å¤–éƒ¨å·¥å…·</code>ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é»˜è®¤ç«¯å£7000</span></span><br><span class="line">jhat &lt;heap dump file&gt;</span><br><span class="line"><span class="comment"># æŒ‡å®šç«¯å£</span></span><br><span class="line">jhat -port 8000 &lt;heap dump file&gt;</span><br></pre></td></tr></table></figure><h2 id="jvisualvm-å›¾å½¢åŒ–çš„-JVM-ç›‘æ§ä¸åˆ†æå·¥å…·">jvisualvm: å›¾å½¢åŒ–çš„ JVM ç›‘æ§ä¸åˆ†æå·¥å…·</h2><ul class="lvl-0"><li class="lvl-2"><p>jvisualvmï¼ˆå…¨ç§°ï¼šJava VisualVMï¼‰æ˜¯ Java å®˜æ–¹æä¾›çš„ä¸€æ¬¾ å›¾å½¢åŒ–çš„ JVM ç›‘æ§ä¸åˆ†æå·¥å…·ï¼Œç”¨äºè§‚å¯Ÿã€åˆ†æå’Œè°ƒè¯•æ­£åœ¨è¿è¡Œçš„ Java ç¨‹åºã€‚å®ƒéå¸¸é€‚åˆå¼€å‘å’Œæµ‹è¯•ç¯å¢ƒä¸­è¿›è¡Œå†…å­˜åˆ†æã€çº¿ç¨‹åˆ†æã€GC è¡Œä¸ºè§‚å¯Ÿç­‰ä»»åŠ¡ã€‚</p></li><li class="lvl-2"><p>åŠŸèƒ½æ¦‚è§ˆ</p></li></ul><table><thead><tr><th>åŠŸèƒ½</th><th>æè¿°</th></tr></thead><tbody><tr><td><strong>è¿›ç¨‹ç›‘æ§</strong></td><td>æŸ¥çœ‹æœ¬åœ°æˆ–è¿œç¨‹ JVM è¿›ç¨‹çš„å†…å­˜ã€CPUã€çº¿ç¨‹ç­‰è¿è¡ŒçŠ¶æ€</td></tr><tr><td><strong>å†…å­˜ä½¿ç”¨åˆ†æ</strong></td><td>æŸ¥çœ‹å †å†…å­˜ä½¿ç”¨æƒ…å†µã€GC æ¬¡æ•°å’Œæ—¶é—´ã€ç±»å®ä¾‹åˆ†å¸ƒç­‰</td></tr><tr><td><strong>çº¿ç¨‹åˆ†æ</strong></td><td>æŸ¥çœ‹çº¿ç¨‹çŠ¶æ€ã€çº¿ç¨‹æ ˆã€æ˜¯å¦å­˜åœ¨æ­»é”</td></tr><tr><td><strong>GC åˆ†æ</strong></td><td>å›¾å½¢åŒ–å±•ç¤º GC æ´»åŠ¨ã€é¢‘ç‡ä¸è€—æ—¶</td></tr><tr><td><strong>å †è½¬å‚¨åˆ†æ</strong></td><td>å¯¼å…¥ <code>.hprof</code> æ–‡ä»¶è¿›è¡Œå¯¹è±¡å®ä¾‹ã€ç±»ã€å¼•ç”¨å…³ç³»åˆ†æ</td></tr><tr><td><strong>CPU åˆ†æ</strong></td><td>åˆ†ææ–¹æ³•è°ƒç”¨è·¯å¾„ã€è€—æ—¶ã€çƒ­ç‚¹ä»£ç ï¼ˆéœ€æ‰‹åŠ¨å¯ç”¨ CPU profilerï¼‰</td></tr><tr><td><strong>æ’ä»¶æ”¯æŒ</strong></td><td>å¯ä»¥é€šè¿‡æ’ä»¶å®‰è£…æ›´å¤šåŠŸèƒ½ï¼ˆå¦‚ Visual GCï¼‰</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>å¯åŠ¨ jvisualvm</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼Œå¦‚æœæ˜¯åˆ†ææœåŠ¡ç«¯ .hprof æ–‡ä»¶ï¼Œå¯ä»¥å¯¼å‡ºåˆ°æœ¬åœ°ååœ¨æœ¬åœ°å¯åŠ¨</span></span><br><span class="line">$ jvisualvm</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åœ¨ jvisualvm ä¸­å¯¼å…¥ .hprof æ–‡ä»¶</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ jvisualvm --openfile &lt;heap dump file&gt;</span><br><span class="line"><span class="comment"># æˆ–è€… å…ˆæ‰“å¼€ jvisualvm åï¼Œç‚¹å‡» File -&gt; Open File -&gt; é€‰æ‹© .hprof æ–‡ä»¶</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>âš ï¸ æ³¨æ„äº‹é¡¹</p></li></ul><table><thead><tr><th>æ³¨æ„ç‚¹</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>ä¸é€‚ç”¨äºå¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒç›‘æ§</td><td>å› ä¸ºå…¶åˆ†æè¿‡ç¨‹å¯èƒ½ä¼šå¯¹ JVM æœ‰è½»å¾®å½±å“</td></tr><tr><td><code>.hprof</code> æ–‡ä»¶è¿‡å¤§æ—¶åŠ è½½ç¼“æ…¢</td><td>å¯é…åˆ Eclipse MAT ä½¿ç”¨</td></tr><tr><td>CPU/Memory Profiler ä¼šå¢åŠ ç³»ç»Ÿè´Ÿæ‹…</td><td>ä½¿ç”¨æ—¶è°¨æ…ï¼Œå»ºè®®åªåœ¨æµ‹è¯•ç¯å¢ƒå¯ç”¨</td></tr></tbody></table><h2 id="Eclipse-MAT-Java-Heap-Dump-åˆ†æå·¥å…·">Eclipse MAT: Java Heap Dump åˆ†æå·¥å…·</h2><ul class="lvl-0"><li class="lvl-2"><p><a href="https://eclipse.dev/mat">Eclipse MAT</a>ï¼ˆEclipse Memory Analyzer Toolï¼‰æ˜¯ä¸€ä¸ªç”¨äºåˆ†æ Java å †å¿«ç…§çš„å·¥å…·ï¼Œå®ƒæä¾›äº†è®¸å¤šåŠŸèƒ½æ¥å¸®åŠ©å¼€å‘äººå‘˜ç†è§£ Java åº”ç”¨ç¨‹åºä¸­çš„å†…å­˜é—®é¢˜ã€‚</p></li></ul><div class="tips"><p><em><strong>MaxOSç³»ç»Ÿå®‰è£…Eclipse MATåï¼Œå¯åŠ¨æŠ¥é”™ï¼ŒæŠ¥é”™ä¿¡æ¯ä¸ºï¼šThe JVM shared library â€œ/Library/Internet Plug-Ins/JavaAppletPlugin.plugin/Contents/Home/bin/â€¦/lib/server/libjvm.dylibâ€ does not contain the JNI_CreateJavaVM symbol.</strong></em></p><ul class="lvl-1"><li class="lvl-2">è§£å†³æ–¹æ³•ï¼š<br>1.åœ¨åº”ç”¨åˆ—è¡¨ï¼Œæ‰¾åˆ°<code>MemoryAnalyzer.app</code>ï¼Œç„¶åå³é”®å•å‡»åï¼Œé€‰æ‹©<code>æ˜¾ç¤ºåŒ…å†…å®¹</code>,è¿›å…¥Contentsç›®å½•ï¼Œæ‰¾åˆ°<code>Info.plist</code>æ–‡ä»¶<br>2.æ‰“å¼€<code>Info.plist</code>æ–‡ä»¶åï¼Œå¯ä»¥çœ‹åˆ°æ³¨é‡Š<code>&lt;string&gt;-vm&lt;/string&gt;</code>é…ç½®é¡¹ï¼Œæˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯æ‰“å¼€è¿™ä¸ªé…ç½®é¡¹ï¼Œå¹¶ä¸”å°†å…¶è®¾ç½®ä¸ºæˆ‘ä»¬ç³»ç»Ÿçš„Javaè·¯å¾„ï¼Œæœ€æ–°ç‰ˆéœ€è¦<code>jdk17+</code></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">string</span>&gt;</span>-vm<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">string</span>&gt;</span>/Users/hanqf/develop_soft/jdk17/bin/java<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br></pre></td></tr></table></figure></div><h2 id="Arthas-æ¨è">Arthas : æ¨è</h2><ul class="lvl-0"><li class="lvl-2"><p><a href="https://arthas.aliyun.com">Arthas</a> æ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„ä¸€æ¬¾ Java è¯Šæ–­å·¥å…·ï¼Œä¸“ä¸ºçº¿ä¸Šè¯Šæ–­è€Œè®¾è®¡ã€‚å®ƒå¯ä»¥å¸®åŠ©å¼€å‘è€…åœ¨ä¸é‡å¯ã€ä¸ä¿®æ”¹ä»£ç çš„æƒ…å†µä¸‹ï¼Œæ’æŸ¥ç”Ÿäº§ç¯å¢ƒä¸­ Java åº”ç”¨çš„é—®é¢˜ã€‚</p></li><li class="lvl-2"><p>Arthas æ”¯æŒ JDK 6+ï¼Œæ”¯æŒ Linux/Mac/Windowsï¼Œé‡‡ç”¨å‘½ä»¤è¡Œäº¤äº’æ¨¡å¼ï¼ŒåŒæ—¶æä¾›ä¸°å¯Œçš„ Tab è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ï¼Œè¿›ä¸€æ­¥æ–¹ä¾¿è¿›è¡Œé—®é¢˜çš„å®šä½å’Œè¯Šæ–­ã€‚</p></li><li class="lvl-2"><p>è¿™é‡Œè¦æ³¨æ„ä¸€ç‚¹ï¼Œå°±æ˜¯Arthasä»<code>4.x</code>ç‰ˆæœ¬å¼€å§‹ï¼Œéœ€è¦ä¾èµ–<code>JDK8+</code>ï¼Œå¦‚æœæ˜¯<code>JDK6/7</code>ï¼Œå¯ä»¥ä¸‹è½½æœ€åä¸€ä¸ª3.xç‰ˆæœ¬ <a href="https://github.com/alibaba/arthas/releases/tag/arthas-all-3.7.2">3.7.2</a>ã€‚</p></li><li class="lvl-2"><p>ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬å­¦ä¹ ï¼ŒArthasè¿˜ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªç»ƒä¹ åœºï¼Œ<a href="https://killercoda.com/arthas/course/arthas-tutorials-cn">Arthas Playground</a>ã€‚</p></li></ul><h3 id="Arthas-æ ¸å¿ƒç‰¹ç‚¹">Arthas æ ¸å¿ƒç‰¹ç‚¹</h3><ul class="lvl-0"><li class="lvl-2"><p>æ— éœ€é‡å¯ã€ä¾µå…¥æ€§ä½<br>Arthas å¯ä»¥ attach åˆ°æ­£åœ¨è¿è¡Œçš„ JVM ä¸Šï¼Œä¸éœ€è¦é‡å¯æœåŠ¡æˆ–ä¿®æ”¹æºä»£ç ã€‚</p></li><li class="lvl-2"><p>å‘½ä»¤å¼äº¤äº’ä½“éªŒ<br>ç±»ä¼¼ Linux shell çš„æ“ä½œæ–¹å¼ï¼Œæ”¯æŒ tab è¡¥å…¨ã€ä¸Šä¸‹é”®å†å²å‘½ä»¤ç­‰ï¼Œéå¸¸ç›´è§‚ã€‚</p></li><li class="lvl-2"><p>å®æ—¶æŸ¥çœ‹å’Œç›‘æ§<br>å¯æŸ¥çœ‹æ–¹æ³•å‚æ•°ã€è¿”å›å€¼ã€è°ƒç”¨æ ˆã€æ‰§è¡Œè€—æ—¶ã€JVM çº¿ç¨‹ã€å†…å­˜ç­‰å®æ—¶æ•°æ®ã€‚</p></li><li class="lvl-2"><p>å¤šç§è¿æ¥æ–¹å¼<br>æ”¯æŒå‘½ä»¤è¡Œç»ˆç«¯ã€æœ¬åœ° shellã€Web é¡µé¢ã€telnet ç­‰å¤šç§è¿æ¥æ–¹å¼ã€‚</p></li><li class="lvl-2"><p>æ”¯æŒå¤šç§ JVM ç‰ˆæœ¬<br>æ”¯æŒ Java 6+ï¼ŒåŒ…æ‹¬ OpenJDKã€Oracle JDKã€Alibaba Dragonwell ç­‰ã€‚</p></li></ul><h3 id="Arthas-å¸¸ç”¨å‘½ä»¤">Arthas å¸¸ç”¨å‘½ä»¤</h3><h4 id="å¯åŠ¨">å¯åŠ¨</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">java -jar arthas-boot.jar</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">java -jar arthas-boot.jar --target-ip 0.0.0.0</span><br><span class="line">[INFO] JAVA_HOME: /Library/Java/JavaVirtualMachines/jdk1.8.0_271.jdk/Contents/Home/jre</span><br><span class="line">[INFO] arthas-boot version: 4.0.5</span><br><span class="line">[INFO] Process 43959 already using port 3658</span><br><span class="line">[INFO] Process 43959 already using port 8563</span><br><span class="line">[INFO] Found existing java process, please choose one and input the serial number of the process, eg : 1. Then hit ENTER.</span><br><span class="line">* [1]: 43959 demo-arthas-spring-boot.jar</span><br><span class="line">  [2]: 50851 org.jetbrains.idea.maven.server.RemoteMavenServer36</span><br><span class="line">  [3]: 50813 org.sonarsource.sonarlint.core.backend.cli.SonarLintServerCli</span><br><span class="line">  [4]: 50655 com.intellij.idea.Main</span><br><span class="line"><span class="comment"># å¯åŠ¨åï¼Œä¼šè‡ªåŠ¨è¿›å…¥äº¤äº’æ¨¡å¼ï¼Œæ­¤æ—¶è¾“å…¥è¦ç›‘æ§çš„è¿›ç¨‹åºå·</span></span><br><span class="line">1 <span class="comment"># æ¯”å¦‚è¿™é‡Œè¾“å…¥ 1 å›è½¦</span></span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">[INFO] arthas home: /Users/hanqf/.arthas/lib/4.0.5/arthas</span><br><span class="line">[INFO] The target process already listen port 3658, skip attach.</span><br><span class="line">[INFO] arthas-client connect 0.0.0.0 3658</span><br><span class="line">  ,---.  ,------. ,--------.,--.  ,--.  ,---.   ,---.</span><br><span class="line"> /  O  \ |  .--. <span class="string">&#x27;&#x27;</span>--.  .--<span class="string">&#x27;|  &#x27;</span>--<span class="string">&#x27;  | /  O  \ &#x27;</span>   .-<span class="string">&#x27;</span></span><br><span class="line"><span class="string">|  .-.  ||  &#x27;</span>--<span class="string">&#x27;.&#x27;</span>   |  |   |  .--.  ||  .-.  |`.  `-.</span><br><span class="line">|  | |  ||  |\  \    |  |   |  |  |  ||  | |  |.-<span class="string">&#x27;    |</span></span><br><span class="line"><span class="string">`--&#x27;</span> `--<span class="string">&#x27;`--&#x27;</span> <span class="string">&#x27;--&#x27;</span>   `--<span class="string">&#x27;   `--&#x27;</span>  `--<span class="string">&#x27;`--&#x27;</span> `--<span class="string">&#x27;`-----&#x27;</span></span><br><span class="line"></span><br><span class="line">wiki        https://arthas.aliyun.com/doc</span><br><span class="line">tutorials   https://arthas.aliyun.com/doc/arthas-tutorials.html</span><br><span class="line">version     4.0.5</span><br><span class="line">main_class  demo-arthas-spring-boot.jar</span><br><span class="line">pid         43959</span><br><span class="line">start_time  2025-05-14 14:57:18.031</span><br><span class="line">currnt_time 2025-05-14 14:59:22.004</span><br><span class="line"></span><br><span class="line">[arthas@43959]$ <span class="comment"># æ­¤æ—¶è¿›å…¥ arthas å‘½ä»¤è¡Œäº¤äº’çŠ¶æ€</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é€€å‡º arthas</span></span><br><span class="line">[arthas@43959]$ stop <span class="comment"># é€€å‡º arthas</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>arthas å‘½ä»¤æœ‰å¾ˆå¤šï¼Œå½“å¸¸ç”¨çš„ä¹Ÿå°±å‡ ä¸ªï¼Œå¦å¤–å¦‚æœè®°ä¸ä½æŸä¸ªå‘½ä»¤æ€ä¹ˆç”¨äº†å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥è¯¢</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="built_in">command</span>&gt; -h æˆ–è€… <span class="built_in">help</span> &lt;<span class="built_in">command</span>&gt;</span><br></pre></td></tr></table></figure><h4 id="dashboard-å®æ—¶æŸ¥çœ‹-JVM-è¿è¡ŒçŠ¶æ€">dashboard :  å®æ—¶æŸ¥çœ‹ JVM è¿è¡ŒçŠ¶æ€</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ JVM è¿è¡ŒçŠ¶æ€ï¼Œ é»˜è®¤æ¯éš” 5 ç§’åˆ·æ–° CPUã€å†…å­˜ã€çº¿ç¨‹ã€GC ç­‰ä¿¡æ¯</span></span><br><span class="line"><span class="comment"># é»˜è®¤ä¼šä¸€ç›´åˆ·æ–°çŠ¶æ€ï¼ŒæŒ‰ `q` æˆ–  `Ctrl+C` é€€å‡º</span></span><br><span class="line">dashboard</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¯éš” 2 ç§’åˆ·æ–°ä¸€æ¬¡</span></span><br><span class="line">dashboard -i 2000</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ·æ–° 10 æ¬¡ååœæ­¢</span></span><br><span class="line">dashboard -n 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¯éš” 2 ç§’åˆ·æ–°ä¸€æ¬¡ï¼Œåˆ·æ–° 10 æ¬¡ååœæ­¢</span></span><br><span class="line">dashboard -i 2000 -n 10</span><br></pre></td></tr></table></figure><p><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/2L73Hi.png" alt="" width="1400" height="900"></p><h4 id="thread-æŸ¥çœ‹å½“å‰-JVM-çº¿ç¨‹ä¿¡æ¯">thread : æŸ¥çœ‹å½“å‰ JVM çº¿ç¨‹ä¿¡æ¯</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å½“å‰ JVM çº¿ç¨‹ä¿¡æ¯ï¼ŒæŒ‰ CPU ä½¿ç”¨ç‡å€’åº</span></span><br><span class="line">thread</span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ‰€æœ‰çº¿ç¨‹ä¿¡æ¯</span></span><br><span class="line">thread --all</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æŒ‡å®šçº¿ç¨‹çš„å †æ ˆä¿¡æ¯</span></span><br><span class="line">thread 18</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line"><span class="string">&quot;http-nio-80-exec-1&quot;</span> Id=18 WAITING on java.util.concurrent.locks.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>@51866c16</span><br><span class="line">    at sun.misc.Unsafe.park(Native Method)</span><br><span class="line">    -  waiting on java.util.concurrent.locks.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>@51866c16</span><br><span class="line">    at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)</span><br><span class="line">    at java.util.concurrent.locks.AbstractQueuedSynchronizer<span class="variable">$ConditionObject</span>.await(AbstractQueuedSynchronizer.java:2039)</span><br><span class="line">    at java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:442)</span><br><span class="line">    at org.apache.tomcat.util.threads.TaskQueue.take(TaskQueue.java:103)</span><br><span class="line">    at org.apache.tomcat.util.threads.TaskQueue.take(TaskQueue.java:31)</span><br><span class="line">    at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1074)</span><br><span class="line">    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1134)</span><br><span class="line">    at java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>.run(ThreadPoolExecutor.java:624)</span><br><span class="line">    at org.apache.tomcat.util.threads.TaskThread<span class="variable">$WrappingRunnable</span>.run(TaskThread.java:61)</span><br><span class="line">    at java.lang.Thread.run(Thread.java:748)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æœ€å¿™çš„å‰5ä¸ªçº¿ç¨‹çš„å †æ ˆä¿¡æ¯</span></span><br><span class="line">thread -n 5</span><br><span class="line"><span class="comment"># æŸ¥çœ‹å…¨éƒ¨çº¿ç¨‹çš„å †æ ˆä¿¡æ¯</span></span><br><span class="line">thread -n -1</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®š cpu ä½¿ç”¨ç‡ç»Ÿè®¡çš„é‡‡æ ·é—´éš”ï¼Œå•ä½ä¸ºæ¯«ç§’ï¼Œé»˜è®¤å€¼ä¸º 200</span></span><br><span class="line">thread -i 500</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰¾å‡ºå½“å‰é˜»å¡å…¶ä»–çº¿ç¨‹çš„çº¿ç¨‹</span></span><br><span class="line">thread -b</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æŒ‡å®šçŠ¶æ€çš„çº¿ç¨‹</span></span><br><span class="line">thread --state WAITING</span><br></pre></td></tr></table></figure><h4 id="sc-æŸ¥çœ‹-JVM-å·²åŠ è½½çš„ç±»ä¿¡æ¯">sc : æŸ¥çœ‹ JVM å·²åŠ è½½çš„ç±»ä¿¡æ¯</h4><ul class="lvl-0"><li class="lvl-2"><p><code>Search-Class</code> çš„ç®€å†™ï¼Œè¿™ä¸ªå‘½ä»¤èƒ½æœç´¢å‡ºæ‰€æœ‰å·²ç»åŠ è½½åˆ° JVM ä¸­çš„ Class ä¿¡æ¯</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é€šé…ç¬¦åŒ¹é…ï¼Œæ‰“å°æœç´¢åˆ°çš„ç±»å…¨å</span></span><br><span class="line">sc *.demo.*</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“å°ç±»çš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">sc -d com.example.demo.arthas.AdminFilterConfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“å°å‡ºç±»çš„ Field ä¿¡æ¯</span></span><br><span class="line">sc -d -f com.example.demo.arthas.AdminFilterConfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€šé…ç¬¦æŸ¥è¯¢å¹¶è·å–classLoaderHash</span></span><br><span class="line">sc -d *AdminFilterConfig | grep classLoaderHash</span><br></pre></td></tr></table></figure><h4 id="sm-æŸ¥çœ‹å·²åŠ è½½ç±»çš„æ–¹æ³•ä¿¡æ¯">sm  : æŸ¥çœ‹å·²åŠ è½½ç±»çš„æ–¹æ³•ä¿¡æ¯</h4><ul class="lvl-0"><li class="lvl-2"><p><code>Search-Method</code> çš„ç®€å†™ï¼Œè¿™ä¸ªå‘½ä»¤èƒ½æœç´¢å‡ºæ‰€æœ‰å·²ç»åŠ è½½åˆ° JVM ä¸­çš„ Method ä¿¡æ¯</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰“å°æŒ‡å®šç±»ä¸­çš„æ–¹æ³•</span></span><br><span class="line">sm java.lang.String</span><br><span class="line"><span class="comment"># å±•ç¤ºæ–¹æ³•çš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">sm -d java.lang.String</span><br><span class="line"><span class="comment"># å±•ç¤ºæŒ‡å®šæ–¹æ³•çš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">sm -d java.lang.String substring</span><br><span class="line"><span class="comment"># æ¨¡ç³ŠåŒ¹é…</span></span><br><span class="line">sm -d java.lang.String eq*</span><br></pre></td></tr></table></figure><h4 id="jad-Javaæºç åç¼–è¯‘å·¥å…·">jad : Javaæºç åç¼–è¯‘å·¥å…·</h4><ul class="lvl-0"><li class="lvl-2"><p>éªŒè¯ç”Ÿäº§ç¯å¢ƒä¸‹çš„ä»£ç æ˜¯å¦ä¸æäº¤çš„ä»£ç ä¸€è‡´</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰“å°å‡ºç±»çš„æºç ï¼Œç±»å</span></span><br><span class="line">jad com.example.demo.arthas.user.UserController</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">jad com.example.demo.arthas.user.UserController</span><br><span class="line"></span><br><span class="line">ClassLoader:</span><br><span class="line">+-org.springframework.boot.loader.LaunchedURLClassLoader@5b2133b1</span><br><span class="line">  +-sun.misc.Launcher<span class="variable">$AppClassLoader</span>@5c647e05</span><br><span class="line">    +-sun.misc.Launcher<span class="variable">$ExtClassLoader</span>@452b3a41</span><br><span class="line"></span><br><span class="line">Location:</span><br><span class="line">file:/Users/hanqf/Desktop/arhtas_dir/demo-arthas-spring-boot.jar!/BOOT-INF/classes!/</span><br><span class="line"></span><br><span class="line">       /*</span><br><span class="line">        * Decompiled with CFR.</span><br><span class="line">        *</span><br><span class="line">        * Could not load the following classes:</span><br><span class="line">        *  com.example.demo.arthas.user.User</span><br><span class="line">        *  org.slf4j.Logger</span><br><span class="line">        *  org.slf4j.LoggerFactory</span><br><span class="line">        *  org.springframework.web.bind.annotation.GetMapping</span><br><span class="line">        *  org.springframework.web.bind.annotation.PathVariable</span><br><span class="line">        *  org.springframework.web.bind.annotation.RestController</span><br><span class="line">        */</span><br><span class="line">       package com.example.demo.arthas.user;</span><br><span class="line"></span><br><span class="line">       import com.example.demo.arthas.user.User;</span><br><span class="line">       import org.slf4j.Logger;</span><br><span class="line">       import org.slf4j.LoggerFactory;</span><br><span class="line">       import org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line">       import org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line">       import org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line">       @RestController</span><br><span class="line">       public class UserController &#123;</span><br><span class="line">           private static final Logger logger = LoggerFactory.getLogger(UserController.class);</span><br><span class="line"></span><br><span class="line">           @GetMapping(value=&#123;<span class="string">&quot;/user/&#123;id&#125;&quot;</span>&#125;)</span><br><span class="line">           public User findUserById(@PathVariable Integer <span class="built_in">id</span>) &#123;</span><br><span class="line">/*15*/         logger.info(<span class="string">&quot;id: &#123;&#125;&quot;</span>, (Object)<span class="built_in">id</span>);</span><br><span class="line">/*17*/         <span class="keyword">if</span> (<span class="built_in">id</span> != null &amp;&amp; <span class="built_in">id</span> &lt; 1) &#123;</span><br><span class="line">                   throw new IllegalArgumentException(<span class="string">&quot;id &lt; 1&quot;</span>);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="built_in">return</span> new User(id.intValue(), <span class="string">&quot;name&quot;</span> + <span class="built_in">id</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">Affect(row-cnt:1) cost <span class="keyword">in</span> 411 ms.</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åç¼–è¯‘åçš„æºç ä¼šæœ‰ç±»åŠ è½½å™¨çš„ä¿¡æ¯ï¼Œå¦‚æœåªå¸Œæœ›æ‰“å°æºç ï¼Œå¯ä»¥åŠ ä¸Š --source-only</span></span><br><span class="line">jad --source-only com.example.demo.arthas.user.UserController</span><br><span class="line"><span class="comment"># ä¸æ˜¾ç¤ºè¡Œå·</span></span><br><span class="line">jad --source-only com.example.demo.arthas.user.UserController --lineNumber <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å‡ºåˆ°æ–‡ä»¶</span></span><br><span class="line">jad --source-only com.example.demo.arthas.user.UserController &gt; /tmp/UserController.java</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“å°å‡ºç±»ä¸­æŸä¸ªæ–¹æ³•çš„æºç ï¼Œç±»å + æ–¹æ³•å</span></span><br><span class="line">jad com.example.demo.arthas.user.UserController findUserById</span><br><span class="line"></span><br><span class="line"><span class="comment"># åç¼–è¯‘æ—¶æŒ‡å®šdump classæ–‡ä»¶ç›®å½•</span></span><br><span class="line">jad --source-only com.example.demo.arthas.user.UserController --lineNumber <span class="literal">false</span> -d /tmp/jad</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å½“æœ‰å¤šä¸ª ClassLoader éƒ½åŠ è½½äº†è¿™ä¸ªç±»æ—¶ï¼Œjad å‘½ä»¤ä¼šè¾“å‡ºå¯¹åº” ClassLoader å®ä¾‹çš„ hashcodeï¼Œç„¶åä½ åªéœ€è¦é‡æ–°æ‰§è¡Œ jad å‘½ä»¤ï¼Œå¹¶ä½¿ç”¨å‚æ•° -c <hashcode> å°±å¯ä»¥åç¼–è¯‘æŒ‡å®š ClassLoader åŠ è½½çš„é‚£ä¸ªç±»äº†ï¼›</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ jad org.apache.log4j.Logger</span><br><span class="line"></span><br><span class="line">Found more than one class <span class="keyword">for</span>: org.apache.log4j.Logger, Please use jad -c hashcode org.apache.log4j.Logger</span><br><span class="line">HASHCODE  CLASSLOADER</span><br><span class="line">69dcaba4  +-monitor<span class="string">&#x27;s ModuleClassLoader</span></span><br><span class="line"><span class="string">6e51ad67  +-java.net.URLClassLoader@6e51ad67</span></span><br><span class="line"><span class="string">            +-sun.misc.Launcher$AppClassLoader@6951a712</span></span><br><span class="line"><span class="string">            +-sun.misc.Launcher$ExtClassLoader@6fafc4c2</span></span><br><span class="line"><span class="string">2bdd9114  +-pandora-qos-service&#x27;</span>s ModuleClassLoader</span><br><span class="line">4c0df5f8  +-pandora-framework<span class="string">&#x27;s ModuleClassLoader</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Affect(row-cnt:0) cost in 38 ms.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># æŒ‡å®šç±»åŠ è½½å™¨</span></span><br><span class="line"><span class="string">$ jad org.apache.log4j.Logger -c 69dcaba4</span></span><br></pre></td></tr></table></figure><h4 id="mc-Memory-Compiler-å†…å­˜ç¼–è¯‘å™¨ï¼Œç¼–è¯‘-javaæ–‡ä»¶ç”Ÿæˆ-class">mc : Memory Compiler/å†…å­˜ç¼–è¯‘å™¨ï¼Œç¼–è¯‘<code>.java</code>æ–‡ä»¶ç”Ÿæˆ<code>.class</code></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¼–è¯‘ï¼Œè¿™é‡Œä¸€å®šè¦æŒ‡å®šç±»åŠ è½½å™¨ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼Œå› ä¸ºä½ ç¼–è¯‘çš„ç±»ä¸­å¯èƒ½importå…¶å®ƒç±»ï¼Œä¸æŒ‡å®šå°±ä¼šæç¤ºæ‰¾ä¸åˆ°å¯¹åº”çš„ç±»ã€‚</span></span><br><span class="line"><span class="comment"># ç±»åŠ è½½å™¨å¯ä»¥é€šè¿‡ jad å‘½ä»¤è·å–</span></span><br><span class="line">mc --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader /tmp/UserController.java</span><br><span class="line"><span class="comment"># æŒ‡å®šç±»åŠ è½½å™¨çš„ç¼–å·</span></span><br><span class="line">mc -c 5b2133b1 /tmp/UserController.java</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°† UserController.class æ–‡ä»¶è¾“å‡ºåˆ°æŒ‡å®šç›®å½•ï¼Œ -d æŒ‡å®šè¾“å‡ºç›®å½•</span></span><br><span class="line">mc --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader /tmp/UserController.java -d /tmp</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>mc å‘½ä»¤æœ‰å¯èƒ½å¤±è´¥ã€‚å¦‚æœç¼–è¯‘å¤±è´¥å¯ä»¥åœ¨æœ¬åœ°ç¼–è¯‘å¥½.classæ–‡ä»¶ï¼Œå†ä¸Šä¼ åˆ°æœåŠ¡å™¨ã€‚</p></li></ul><h4 id="retransform-é‡æ–°åŠ è½½ç±»-çƒ­ä¿®æ”¹ä»£ç ">retransform : é‡æ–°åŠ è½½ç±»(çƒ­ä¿®æ”¹ä»£ç )</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">retransform /tmp/com/example/demo/arthas/user/UserController.class</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ é€šè¿‡ retransform é‡æ–°åŠ è½½çš„ class</span></span><br><span class="line">retransform -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤é€šè¿‡ retransform é‡æ–°åŠ è½½çš„ classï¼Œé€šè¿‡ id åˆ é™¤</span></span><br><span class="line">retransform -d 1</span><br><span class="line"><span class="comment"># åˆ é™¤æ‰€æœ‰</span></span><br><span class="line">retransform --deleteAll</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤åè¦é‡æ–°è§¦å‘ retransformï¼Œå¦åˆ™å†…å­˜ä¸­ä¾æ—§ä½¿ç”¨çš„æ˜¯åˆ é™¤å‰çš„ class</span></span><br><span class="line">retransform --classPattern com.example.demo.arthas.user.UserController</span><br></pre></td></tr></table></figure><h4 id="sysprop-æŸ¥çœ‹å½“å‰-JVM-çš„ç³»ç»Ÿå±æ€§">sysprop : æŸ¥çœ‹å½“å‰ JVM çš„ç³»ç»Ÿå±æ€§</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰“å°ç³»ç»Ÿå±æ€§</span></span><br><span class="line">sysprop</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šå•ä¸ª keyï¼Œkeyæ”¯æŒè‡ªåŠ¨è¡¥å…¨</span></span><br><span class="line">sysprop java.version</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€šè¿‡grepè¿‡æ»¤</span></span><br><span class="line">sysprop | grep user</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½® æˆ– ä¿®æ”¹ ç³»ç»Ÿå±æ€§</span></span><br><span class="line">sysprop testKey testValue</span><br></pre></td></tr></table></figure><h4 id="sysenv-æŸ¥çœ‹å½“å‰-JVM-çš„ç¯å¢ƒå˜é‡">sysenv : æŸ¥çœ‹å½“å‰ JVM çš„ç¯å¢ƒå˜é‡</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ—å‡ºæ‰€æœ‰ç¯å¢ƒå˜é‡</span></span><br><span class="line">sysenv</span><br><span class="line"><span class="comment"># æŒ‡å®šå•ä¸ª keyï¼Œkeyæ”¯æŒè‡ªåŠ¨è¡¥å…¨</span></span><br><span class="line">sysenv PATH</span><br><span class="line"><span class="comment"># é€šè¿‡grepè¿‡æ»¤</span></span><br><span class="line">sysenv | grep PATH</span><br></pre></td></tr></table></figure><h4 id="jvm-æŸ¥çœ‹å½“å‰-JVM-çš„ä¿¡æ¯ï¼ŒåŒ…å«å¾ˆå¤šé‡è¦çš„ä¿¡æ¯">jvm : æŸ¥çœ‹å½“å‰ JVM çš„ä¿¡æ¯ï¼ŒåŒ…å«å¾ˆå¤šé‡è¦çš„ä¿¡æ¯</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jvm</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>GARBAGE-COLLECTORS </code> GC ç›¸å…³</p></li><li class="lvl-2"><p><code>THREAD</code> ç›¸å…³</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">COUNT: JVM å½“å‰æ´»è·ƒçš„çº¿ç¨‹æ•°</span><br><span class="line">DAEMON-COUNT: JVM å½“å‰æ´»è·ƒçš„å®ˆæŠ¤çº¿ç¨‹æ•°</span><br><span class="line">PEAK-COUNT: ä» JVM å¯åŠ¨å¼€å§‹æ›¾ç»æ´»ç€çš„æœ€å¤§çº¿ç¨‹æ•°</span><br><span class="line">STARTED-COUNT: ä» JVM å¯åŠ¨å¼€å§‹æ€»å…±å¯åŠ¨è¿‡çš„çº¿ç¨‹æ¬¡æ•°</span><br><span class="line">DEADLOCK-COUNT: JVM å½“å‰æ­»é”çš„çº¿ç¨‹æ•°</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>FILE-DESCRIPTOR</code> æ–‡ä»¶æè¿°ç¬¦ç›¸å…³</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MAX-FILE-DESCRIPTOR-COUNTï¼šJVM è¿›ç¨‹æœ€å¤§å¯ä»¥æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•°</span><br><span class="line">OPEN-FILE-DESCRIPTOR-COUNTï¼šJVM å½“å‰æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ•°</span><br></pre></td></tr></table></figure><h4 id="watch-å‡½æ•°æ‰§è¡Œæ•°æ®è§‚æµ‹">watch : å‡½æ•°æ‰§è¡Œæ•°æ®è§‚æµ‹</h4><ul class="lvl-0"><li class="lvl-2"><p>è®©ä½ èƒ½æ–¹ä¾¿çš„è§‚å¯Ÿåˆ°æŒ‡å®šå‡½æ•°çš„è°ƒç”¨æƒ…å†µã€‚èƒ½è§‚å¯Ÿåˆ°çš„èŒƒå›´ä¸ºï¼šè¿”å›å€¼ã€æŠ›å‡ºå¼‚å¸¸ã€å…¥å‚ï¼Œé€šè¿‡ç¼–å†™ OGNL è¡¨è¾¾å¼è¿›è¡Œå¯¹åº”å˜é‡çš„æŸ¥çœ‹ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è§‚å¯ŸæŒ‡å®šç±»ä¸­æŸä¸ªæ–¹æ³•çš„è°ƒç”¨æƒ…å†µï¼ŒclassName +  methodName + è¿”å›å€¼è¡¨è¾¾å¼</span></span><br><span class="line"><span class="comment"># å¼€å¯åï¼Œå½“æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œä¼šæŒ‰ç…§æŒ‡å®šçš„ `è¿”å›å€¼è¡¨è¾¾å¼` è¾“å‡ºç»“æœï¼Œè¿”å›å€¼è¡¨è¾¾å¼ å¯ä»¥ä¸æŒ‡å®šï¼Œé»˜è®¤ä¸º &#123;params, target, returnObj&#125;</span></span><br><span class="line">watch com.example.demo.arthas.user.UserController findUserById <span class="string">&#x27;&#123;params, throwExp&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è§‚å¯Ÿå…¨éƒ¨æ–¹æ³•ï¼Œé€šé…ç¬¦åŒ¹é…</span></span><br><span class="line">watch com.example.demo.arthas.user.UserController <span class="string">&#x27;*&#x27;</span> <span class="string">&#x27;&#123;params, throwExp&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é»˜è®¤è¾“å‡ºç»“æœæ²¡æœ‰å±•å¼€ï¼Œå¯ä»¥åŠ ä¸Š -x æŒ‡å®šè¾“å‡ºç»“æœçš„å±æ€§éå†æ·±åº¦ï¼Œé»˜è®¤ä¸º 1ï¼Œæœ€å¤§å€¼æ˜¯ 4</span></span><br><span class="line">watch com.example.demo.arthas.user.UserController <span class="string">&#x27;*&#x27;</span> <span class="string">&#x27;&#123;params, throwExp&#125;&#x27;</span> -x 2</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»…å½“æŠ›å‡ºå¼‚å¸¸æ—¶æ‰æ‰“å°ï¼Œ-e åœ¨å‡½æ•°å¼‚å¸¸ä¹‹åè§‚å¯Ÿ</span></span><br><span class="line">watch com.example.demo.arthas.user.UserController <span class="string">&#x27;*&#x27;</span> <span class="string">&#x27;&#123;params, throwExp&#125;&#x27;</span> -x 2 -e</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‚æ•°æ¡ä»¶è¿‡æ»¤ï¼Œparams[0] &gt; 100 è¡¨ç¤ºæ–¹æ³•å…¥å‚ä¸­ç¬¬ä¸€ä¸ªå‚æ•°çš„å€¼å¤§äº 100 æ—¶æ‰è§¦å‘æ‰“å°</span></span><br><span class="line">watch com.example.demo.arthas.user.UserController * returnObj <span class="string">&#x27;params[0] &gt; 100&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‰è¯·æ±‚è€—æ—¶è¿›è¡Œè¿‡æ»¤ï¼Œ#cost&gt;200 è¡¨ç¤ºè€—æ—¶å¤§äº200ms</span></span><br><span class="line">watch com.example.demo.arthas.user.UserController * <span class="string">&#x27;&#123;params, returnObj&#125;&#x27;</span> <span class="string">&#x27;#cost&gt;200&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é€€å‡ºwatch</span></span><br><span class="line">q</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>watch å‘½ä»¤è¡¨è¾¾å¼æ”¯æŒå˜é‡è¯´æ˜è¡¨</p></li></ul><table><thead><tr><th>åç§°</th><th>ç±»å‹/è¯´æ˜</th><th>ä½œç”¨/å«ä¹‰</th></tr></thead><tbody><tr><td><code>loader</code></td><td><code>ClassLoader</code></td><td>æ–¹æ³•æ‰€åœ¨ç±»çš„ç±»åŠ è½½å™¨å¯¹è±¡</td></tr><tr><td><code>clazz</code></td><td><code>Class&lt;?&gt;</code></td><td>æ–¹æ³•æ‰€å±çš„ç±»ï¼ˆ<code>Class</code> å¯¹è±¡ï¼‰</td></tr><tr><td><code>method</code></td><td><code>java.lang.reflect.Method</code></td><td>è¢«è°ƒç”¨çš„æ–¹æ³•çš„åå°„å¯¹è±¡</td></tr><tr><td><code>target</code></td><td><code>Object</code></td><td>æ–¹æ³•çš„è°ƒç”¨ç›®æ ‡å¯¹è±¡ï¼ˆå³ <code>this</code> å¯¹è±¡ï¼‰ï¼Œé™æ€æ–¹æ³•ä¸­ä¸º <code>null</code></td></tr><tr><td><code>params</code></td><td><code>Object[]</code></td><td>æ–¹æ³•çš„å…¥å‚æ•°ç»„</td></tr><tr><td><code>returnObj</code></td><td><code>Object</code></td><td>æ–¹æ³•çš„è¿”å›å€¼</td></tr><tr><td><code>throwExp</code></td><td><code>Throwable</code></td><td>æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸</td></tr><tr><td><code>isBefore</code></td><td><code>boolean</code></td><td>å½“å‰æ‰§è¡Œä½ç½®æ˜¯å¦æ˜¯æ–¹æ³•è°ƒç”¨<strong>ä¹‹å‰</strong>ï¼ˆ<code>BEFORE</code> é˜¶æ®µï¼‰</td></tr><tr><td><code>isThrow</code></td><td><code>boolean</code></td><td>å½“å‰æ–¹æ³•æ˜¯å¦ä»¥å¼‚å¸¸ç»“æŸï¼ˆ<code>THROWS</code> é˜¶æ®µï¼‰</td></tr><tr><td><code>isReturn</code></td><td><code>boolean</code></td><td>å½“å‰æ–¹æ³•æ˜¯å¦æ­£å¸¸è¿”å›ï¼ˆ<code>RETURN</code> é˜¶æ®µï¼‰</td></tr></tbody></table><h4 id="jobs-æŸ¥çœ‹è¿è¡Œä¸­çš„ä»»åŠ¡">jobs : æŸ¥çœ‹è¿è¡Œä¸­çš„ä»»åŠ¡</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¦‚ä¸‹å‘½ä»¤ä¼šè½¬åˆ°åå°è¿è¡Œ ï¼Œä¸linuxå‘½ä»¤ç±»ä¼¼ï¼Œå‘½ä»¤æœ€ååŠ ä¸Š `&amp;` å³å¯</span></span><br><span class="line">watch com.example.demo.arthas.user.UserController * <span class="string">&#x27;&#123;params, throwExp&#125;&#x27;</span> <span class="string">&#x27;throwExp != null&#x27;</span> &gt;&gt; a.log &amp;</span><br><span class="line"><span class="comment"># æŸ¥çœ‹åå°ä»»åŠ¡</span></span><br><span class="line"><span class="built_in">jobs</span></span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">[1]*</span><br><span class="line">       Running           watch com.example.demo.arthas.user.UserController * <span class="string">&#x27;&#123;params, throwExp&#125;&#x27;</span> <span class="string">&#x27;throwExp != null&#x27;</span> &gt;&gt; a.log &amp;</span><br><span class="line">       execution count : 0</span><br><span class="line">       start time      : Thu May 15 15:10:04 CST 2025</span><br><span class="line">       <span class="built_in">timeout</span> <span class="built_in">date</span>    : Fri May 16 15:10:04 CST 2025</span><br><span class="line">       session         : ded56dfd-5683-4427-ac08-792f8fb75e5e (current)</span><br><span class="line"><span class="comment"># ç»“æŸä»»åŠ¡</span></span><br><span class="line"><span class="built_in">kill</span> 1 <span class="comment"># 1ä¸ºåå°ä»»åŠ¡id</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†åå°ä»»åŠ¡è½¬åˆ°å‰å°</span></span><br><span class="line"><span class="built_in">fg</span> 1 <span class="comment"># 1ä¸ºåå°ä»»åŠ¡id</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æš‚åœä»»åŠ¡ï¼Œä½†æ­¤æ—¶ä¼šå°†arthasè¿›ç¨‹éƒ½æŒ‚èµ·ï¼Œæ‰€ä»¥å¹¶ä¸å¥½ç”¨</span></span><br><span class="line">ctrl+z</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†å‰å°ä»»åŠ¡è½¬åˆ°åå°ç»§ç»­æ‰§è¡Œ</span></span><br><span class="line"><span class="built_in">bg</span> 1 <span class="comment"># 1ä¸ºå‰å°ä»»åŠ¡id</span></span><br></pre></td></tr></table></figure><h4 id="logger-æŸ¥çœ‹-logger-ä¿¡æ¯ï¼Œæ›´æ–°-logger-level">logger : æŸ¥çœ‹ logger ä¿¡æ¯ï¼Œæ›´æ–° logger level</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ logger ä¿¡æ¯</span></span><br><span class="line">logger</span><br><span class="line"><span class="comment"># æŸ¥çœ‹æŒ‡å®šåå­—çš„loggerä¿¡æ¯</span></span><br><span class="line">logger -n ROOT</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ²¡æœ‰ appender çš„ logger çš„ä¿¡æ¯ï¼Œä¸åŠ è¿™ä¸ªå‚æ•°åªä¼šæ‰“å°æœ‰ appender çš„ logger çš„ä¿¡æ¯</span></span><br><span class="line">logger --include-no-appender</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›´æ–° logger levelï¼Œ-c classLoader çš„ hashcode</span></span><br><span class="line">logger --name ROOT --level debug -c 5b2133b1</span><br><span class="line">logger --name ROOT --level error --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader</span><br></pre></td></tr></table></figure><h4 id="classloader-æŸ¥çœ‹-classloader-çš„ç»§æ‰¿æ ‘ï¼Œurlsï¼Œç±»åŠ è½½ä¿¡æ¯">classloader : æŸ¥çœ‹ classloader çš„ç»§æ‰¿æ ‘ï¼Œurlsï¼Œç±»åŠ è½½ä¿¡æ¯</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ classloader çš„ä¿¡æ¯ï¼ŒåŠ è½½classçš„æ•°é‡ï¼Œhashcodeï¼Œclassloader çš„ parent</span></span><br><span class="line">classloader -l</span><br><span class="line"><span class="comment"># æ ‘å½¢å±•ç¤º</span></span><br><span class="line">classloader -t</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥æ‰¾èµ„æºï¼Œæ¯”å¦‚æŸ¥æ‰¾æŒ‡å®šåç§°çš„æ–‡ä»¶</span></span><br><span class="line">classloader -c 5b2133b1 -r application.properties</span><br><span class="line">classloader --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader -r logback-spring.xml</span><br></pre></td></tr></table></figure><h4 id="ognl-æ‰§è¡Œ-ognl-è¡¨è¾¾å¼">ognl : æ‰§è¡Œ ognl è¡¨è¾¾å¼</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è°ƒç”¨é™æ€å‡½æ•°</span></span><br><span class="line">ognl <span class="string">&#x27;@java.lang.System@out.println(&quot;hello&quot;)&#x27;</span></span><br><span class="line">ognl <span class="string">&#x27;@java.lang.Math@sqrt(9.0)&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–é™æ€ç±»çš„é™æ€å­—æ®µ</span></span><br><span class="line">ognl <span class="string">&#x27;@java.io.File@separator&#x27;</span></span><br><span class="line"><span class="comment"># éœ€è¦æŒ‡å®šclassLoaderClass</span></span><br><span class="line">ognl --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader @com.example.demo.arthas.user.UserController@logger</span><br><span class="line"><span class="comment"># è·å–classLoaderHash</span></span><br><span class="line">sc -d *UserController | grep classLoaderHash</span><br><span class="line">ognl -c 5b2133b1 @com.example.demo.arthas.user.UserController@logger</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿”å›å€¼å±•å¼€åŸºå±‚ -x</span></span><br><span class="line">ognl -c 5b2133b1 @com.example.demo.arthas.user.UserController@logger -x 3</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œå¤šè¡Œè¡¨è¾¾å¼ï¼Œèµ‹å€¼ç»™ä¸´æ—¶å˜é‡ï¼Œè¿”å›ä¸€ä¸ª List</span></span><br><span class="line">ognl <span class="string">&#x27;#value1=@System@getProperty(&quot;java.home&quot;), #value2=@System@getProperty(&quot;java.runtime.name&quot;), &#123;#value1, #value2&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç´¢å¼•</span></span><br><span class="line"><span class="comment"># è·å–æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">ognl <span class="string">&quot;&#123;1,2,3,4&#125;[0]&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å˜é‡å¼•ç”¨ï¼Œä½¿ç”¨ # åœ¨ OGNL ä¸­å®šä¹‰ä¸´æ—¶å˜é‡ï¼Œä»–ä»¬å…¨å±€å¯è§ï¼Œæ­¤å¤–è¡¨è¾¾å¼è®¡ç®—çš„æ¯ä¸€æ­¥ç»“æœéƒ½ä¿å­˜åœ¨å˜é‡ this ä¸­</span></span><br><span class="line"><span class="comment"># ä¸‹é¢å‘½ä»¤é€šè¿‡è·å–åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ è¿›è¡Œåˆ¤æ–­å¦‚æœå¤§äº 5 åˆ™ä¹˜ä»¥ 2 åä¹‹åˆ™åŠ  10</span></span><br><span class="line">ognl <span class="string">&quot;&#123;10,20,30&#125;[0].(#this &gt; 5 ? #this*2 : #this+10)&quot;</span></span><br><span class="line"><span class="comment"># æ¯ä¸ªå…ƒç´ ä¹˜ä»¥ 2 åè¿”å›</span></span><br><span class="line">ognl <span class="string">&quot;&#123;1, 2, 3&#125;.&#123;#this*2&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹æ³•è°ƒç”¨</span></span><br><span class="line"><span class="comment"># é€šè¿‡ä¸‹é¢å‘½ä»¤å¯ä»¥è°ƒç”¨ ArrayList çš„ size() æ–¹æ³•è·å–åˆ° ArrayList çš„å¤§å°</span></span><br><span class="line">ognl <span class="string">&quot;&#123;1,2,3,4&#125;.size()&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤æ‚é“¾å¼è¡¨è¾¾å¼</span></span><br><span class="line">ognl <span class="string">&quot;@java.lang.System@out.(print(&#x27;Hello &#x27;), print(&#x27;world\n&#x27;))&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–°å»ºåŸç”Ÿæ•°ç»„</span></span><br><span class="line">ognl <span class="string">&quot;new int[] &#123;1, 2, 3&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–°å»ºæ™®é€š Map</span></span><br><span class="line">ognl <span class="string">&quot;#&#123; &#x27;foo&#x27;: &#x27;foo value&#x27;, &#x27;bar&#x27;: &#x27;bar value&#x27; &#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–°å»ºç‰¹å®šç±»å‹ Map</span></span><br><span class="line">ognl <span class="string">&quot;#@java.util.HashMap@&#123; &#x27;foo&#x27;: &#x27;foo value&#x27;, &#x27;bar&#x27;: &#x27;bar value&#x27; &#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…çš„å…ƒç´ </span></span><br><span class="line">ognl <span class="string">&quot;&#123;1024, &#x27;Hello world!&#x27;, true, 2048&#125;.&#123;? #this instanceof Number&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥æ‰¾ç¬¬ä¸€ä¸ªåŒ¹é…çš„å…ƒç´ </span></span><br><span class="line">ognl <span class="string">&quot;&#123;1024, &#x27;Hello world!&#x27;, true, 2048&#125;.&#123;^ #this instanceof Number&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥æ‰¾æœ€åä¸€ä¸ªåŒ¹é…çš„å…ƒç´ </span></span><br><span class="line">ognl <span class="string">&quot;&#123;1024, &#x27;Hello world!&#x27;, true, 2048&#125;.&#123;$ #this instanceof Number&#125;&quot;</span></span><br></pre></td></tr></table></figure><h4 id="vmoption-æŸ¥çœ‹ï¼Œæ›´æ–°-VM-è¯Šæ–­ç›¸å…³çš„å‚æ•°">vmoption : æŸ¥çœ‹ï¼Œæ›´æ–° VM è¯Šæ–­ç›¸å…³çš„å‚æ•°</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹æ‰€æœ‰çš„ option</span></span><br><span class="line">vmoption</span><br><span class="line"><span class="comment"># æŸ¥çœ‹æŒ‡å®šçš„ option</span></span><br><span class="line">vmoption PrintGC</span><br><span class="line"><span class="comment"># æ›´æ–°æŒ‡å®šçš„ option</span></span><br><span class="line">vmoption PrintGC <span class="literal">true</span></span><br><span class="line">vmoption PrintGCDetails <span class="literal">true</span></span><br></pre></td></tr></table></figure><h4 id="vmtool-å®ç°æŸ¥è¯¢å†…å­˜å¯¹è±¡ï¼Œå¼ºåˆ¶-GC-ç­‰åŠŸèƒ½">vmtool : å®ç°æŸ¥è¯¢å†…å­˜å¯¹è±¡ï¼Œå¼ºåˆ¶ GC ç­‰åŠŸèƒ½</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å–å¯¹è±¡ï¼Œ--action getInstances: è·å–å¯¹è±¡å®ä¾‹ï¼Œ--className: æŒ‡å®šç±»åï¼Œ--limit: æŒ‡å®šè·å–æ•°é‡</span></span><br><span class="line">vmtool --action getInstances --className java.lang.String --<span class="built_in">limit</span> 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®š classloader nameï¼Œè¿™é‡Œè·å– springçš„ ApplicationContext å¯¹è±¡ï¼Œ-x: å±•å¼€å¤šå°‘å±‚</span></span><br><span class="line">vmtool --action getInstances --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader --className org.springframework.context.ApplicationContext -x 3</span><br><span class="line"><span class="comment"># æŒ‡å®š classloader hash</span></span><br><span class="line">sc -d org.springframework.context.ApplicationContext | grep classLoaderHash</span><br><span class="line">vmtool --action getInstances -c 19469ea2 --className org.springframework.context.ApplicationContext</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œè¡¨è¾¾å¼ï¼Œ--express: æ‰§è¡Œçš„è¡¨è¾¾å¼ï¼Œè¿™é‡Œæ˜¯è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•</span></span><br><span class="line">vmtool --action getInstances --className com.example.demo.arthas.aop.HelloWorldService --express <span class="string">&#x27;instances[0].getHelloMessage()&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼ºåˆ¶ GCï¼Œå¯ä»¥ç»“åˆ vmoption å‘½ä»¤åŠ¨æ€æ‰“å¼€PrintGCå¼€å…³</span></span><br><span class="line">vmtool --action forceGc</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸­æ–­çº¿ç¨‹ï¼Œ -t çº¿ç¨‹ID,å¯ä»¥ä½¿ç”¨ threadå‘½ä»¤è·å–</span></span><br><span class="line">vmtool --action interruptThread -t 1</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **åŠ ç²—**
 *æ–œä½“*
 ***åŠ ç²—å¹¶æ–œä½“***
 ~~åˆ é™¤çº¿~~
 ==çªå‡ºæ˜¾ç¤º==
 `çªå‡ºæ˜¾ç¤º(æ¨è)`
 ++ä¸‹åˆ’çº¿++
 ~ä¸‹æ ‡~
 ^ä¸Šæ ‡^
 è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.
 å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **ç‚¹å‡»æŠ˜å **
 è¿™æ˜¯è¢«éšè—çš„å†…å®¹
 +++

::: tips success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
:::

% note info % success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
% endnote %

å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}
 å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ
 --&gt;
&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;æœ¬æ–‡ä»‹ç»JVMçš„å‘½ä»¤è¡Œå·¥å…·&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.oracle.com/javase/specs/jvms/se8/html/index.html&quot;&gt;JDK8 The JavaÂ® Virtual Machine Specification&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html&quot;&gt;JDK8çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.oracle.com/en/java/javase/17/docs/specs/man/index.html&quot;&gt;JDKâ¼¯å…·å®˜â½¹â½‚æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.oracle.com/en/java/javase/17/docs/specs/man/java.html&quot;&gt;JDK17çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="jvm" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/jvm/"/>
    
    
    <category term="jvm" scheme="https://blog.hanqunfeng.com/tags/jvm/"/>
    
  </entry>
  
  <entry>
    <title>JVM ä¹‹ å†…å­˜æ¨¡å‹ä¸åƒåœ¾å›æ”¶æœºåˆ¶(GC)</title>
    <link href="https://blog.hanqunfeng.com/2025/05/12/jvm-gc-01/"/>
    <id>https://blog.hanqunfeng.com/2025/05/12/jvm-gc-01/</id>
    <published>2025-05-12T14:30:05.000Z</published>
    <updated>2025-05-18T06:11:43.854Z</updated>
    
    <content type="html"><![CDATA[<!-- **åŠ ç²—** *æ–œä½“* ***åŠ ç²—å¹¶æ–œä½“*** ~~åˆ é™¤çº¿~~ ==çªå‡ºæ˜¾ç¤º== `çªå‡ºæ˜¾ç¤º(æ¨è)` ++ä¸‹åˆ’çº¿++ ~ä¸‹æ ‡~ ^ä¸Šæ ‡^ è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference. å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **ç‚¹å‡»æŠ˜å ** è¿™æ˜¯è¢«éšè—çš„å†…å®¹ +++::: tips success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹:::% note info % success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹% endnote %å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{} å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ --><h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2"><p>æœ¬æ–‡ä»‹ç»JVMçš„å†…å­˜æ¨¡å‹ä¸åƒåœ¾å›æ”¶æœºåˆ¶</p></li><li class="lvl-2"><p><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/index.html">JDK8 The JavaÂ® Virtual Machine Specification</a></p></li><li class="lvl-2"><p><a href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html">JDK8çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£</a></p></li><li class="lvl-2"><p><a href="https://docs.oracle.com/en/java/javase/17/docs/specs/man/index.html">JDKâ¼¯å…·å®˜â½¹â½‚æ¡£</a></p></li><li class="lvl-2"><p><a href="https://docs.oracle.com/en/java/javase/17/docs/specs/man/java.html">JDK17çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£</a></p></li></ul><span id="more"></span><h2 id="JVMè™šæ‹Ÿæœºç»“æ„-HotSpot">JVMè™šæ‹Ÿæœºç»“æ„(HotSpot)</h2><p><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/cGMyEe.png" alt=""></p><ul class="lvl-0"><li class="lvl-2"><p>è®¾ç½®å†…å­˜åˆ†é…ç¤ºä¾‹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># jdk1.8+</span></span><br><span class="line">java â€Xms2048M â€Xmx2048M â€Xmn1024M â€Xss512K â€XX:MetaspaceSize=128M â€XX:MaxMetaspaceSize=256M â€jar server.jar</span><br><span class="line"><span class="comment"># jdk1.6/1.7</span></span><br><span class="line">java â€Xms2048M â€Xmx2048M â€Xmn1024M â€Xss512K â€XX:PermSize=128M â€XX:MaxPermSize=256M â€jar server.jar</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å„å‚æ•°å«ä¹‰ä¸é»˜è®¤å€¼ï¼ˆé’ˆå¯¹ JDK 1.8ï¼‰</p></li></ul><table><thead><tr><th>å‚æ•°</th><th>å«ä¹‰è¯´æ˜</th><th>é»˜è®¤å€¼ï¼ˆJDK 1.8ï¼‰</th></tr></thead><tbody><tr><td><code>-Xms2048M</code></td><td><strong>åˆå§‹å †å¤§å°</strong>ï¼Œå³ JVM å¯åŠ¨æ—¶åˆ†é…çš„å †å†…å­˜å¤§å°ï¼ˆè¿™é‡Œæ˜¯ 2GBï¼‰</td><td>ç‰©ç†å†…å­˜çš„ 1/64ï¼ˆæœ€å° 1MBï¼‰ï¼Œæ¨èé…ç½®ä¸ºä¸ -Xmx ä¸€è‡´</td></tr><tr><td><code>-Xmx2048M</code></td><td><strong>æœ€å¤§å †å†…å­˜å¤§å°</strong>ï¼ŒJVM å…è®¸åˆ†é…çš„æœ€å¤§å †å†…å­˜</td><td>ç‰©ç†å†…å­˜çš„ 1/4ï¼ˆå—é™äº 32ä½/64ä½ï¼‰</td></tr><tr><td><code>-Xmn1024M</code></td><td><strong>æ–°ç”Ÿä»£å¤§å°</strong>ï¼ˆEden + Survivorï¼‰ä¸º 1GB</td><td>æœªæ˜¾å¼æŒ‡å®šæ—¶ï¼Œé€šå¸¸å å †çš„ 1/3 å·¦å³</td></tr><tr><td><code>-Xss512K</code></td><td><strong>æ¯ä¸ªçº¿ç¨‹çš„æ ˆå¤§å°</strong>ï¼ˆThread Stack Sizeï¼‰ï¼Œè¿™é‡Œè®¾ç½®ä¸º 512KB</td><td>1MBï¼ˆ64ä½ç³»ç»Ÿï¼‰æˆ– 512KBï¼ˆ32ä½ç³»ç»Ÿï¼‰</td></tr><tr><td><code>-XX:MetaspaceSize=256M</code></td><td><strong>å…ƒç©ºé—´åˆå§‹å¤§å°</strong>ï¼ˆç”¨äºåŠ è½½ç±»çš„å…ƒæ•°æ®ï¼Œä¸å†ä½¿ç”¨ PermGenï¼‰ï¼Œè¾¾åˆ°è¯¥å€¼åï¼ŒJVM ä¼šè§¦å‘ä¸€æ¬¡ GCï¼Œç©ºé—´ä¸å¤Ÿæ—¶ä¼šè¿›è¡Œæ‰©å®¹ï¼Œæœ€å¤§åˆ°  <code>MaxMetaspaceSize</code></td><td>é»˜è®¤ 21MBï¼ˆå®¢æˆ·ç«¯ï¼‰æˆ– 16MBï¼ˆæœåŠ¡å™¨ç«¯ï¼‰ï¼Œä¸ºé¿å…é¢‘ç¹æ‰©å®¹å¯¼è‡´çš„GCï¼Œå¯ä»¥è®¾ç½®çš„ç¨å¾®å¤§ä¸€äº›ï¼Œæ¯”å¦‚<code>MaxMetaspaceSize</code>çš„ä¸€åŠï¼Œæˆ–å¹²è„†ä¸<code>MaxMetaspaceSize</code>ä¸€æ ·å¤§</td></tr><tr><td><code>-XX:MaxMetaspaceSize=256M</code></td><td><strong>å…ƒç©ºé—´æœ€å¤§å¤§å°</strong>ï¼Œæ¥è¿‘è®¾ç½®å€¼æ—¶ä¼šè§¦å‘ Full GC</td><td>æ— é™åˆ¶ï¼ˆé»˜è®¤åªå—ç‰©ç†å†…å­˜çº¦æŸï¼‰ ï¼Œæ¨èé…ç½®ä¸€ä¸ªåˆé€‚çš„æ•°å€¼ï¼Œæ¯”å¦‚8Gçš„å†…å­˜å¯ä»¥é…ç½®ä¸º256M</td></tr></tbody></table><h3 id="ç±»è£…è½½å­ç³»ç»Ÿï¼ˆClass-Loading-Subsystemï¼‰">ç±»è£…è½½å­ç³»ç»Ÿï¼ˆClass Loading Subsystemï¼‰</h3><ul class="lvl-0"><li class="lvl-2"><p>ç±»è£…è½½å­ç³»ç»Ÿè´Ÿè´£å°† <code>.class</code> æ–‡ä»¶åŠ è½½åˆ° JVM ä¸­ï¼Œå¹¶è¿›è¡Œè§£æã€éªŒè¯ã€åˆå§‹åŒ–ç­‰è¿‡ç¨‹ã€‚</p></li><li class="lvl-2"><p>åŠ è½½è¿‡ç¨‹çš„å‡ ä¸ªé˜¶æ®µï¼š</p></li></ul><table><thead><tr><th>é˜¶æ®µ</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><strong>åŠ è½½ï¼ˆLoadingï¼‰</strong></td><td>å°† <code>.class</code> æ–‡ä»¶è¯»å–ä¸ºäºŒè¿›åˆ¶æ•°æ®ï¼Œæ„é€  <code>Class</code> å¯¹è±¡</td></tr><tr><td><strong>éªŒè¯ï¼ˆVerificationï¼‰</strong></td><td>ç¡®ä¿å­—èŠ‚ç æ–‡ä»¶æ ¼å¼æ­£ç¡®ã€å®‰å…¨åˆæ³•ï¼ˆé˜²æ­¢æ¶æ„ä»£ç ï¼‰</td></tr><tr><td><strong>å‡†å¤‡ï¼ˆPreparationï¼‰</strong></td><td>ä¸ºç±»çš„é™æ€å˜é‡åˆ†é…å†…å­˜ï¼Œå¹¶è®¾ç½®é»˜è®¤åˆå§‹å€¼</td></tr><tr><td><strong>è§£æï¼ˆResolutionï¼‰</strong></td><td>å°†å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨ï¼ˆæ–¹æ³•ã€å­—æ®µç­‰ï¼‰</td></tr><tr><td><strong>åˆå§‹åŒ–ï¼ˆInitializationï¼‰</strong></td><td>æ‰§è¡Œ <code>&lt;clinit&gt;</code> é™æ€åˆå§‹åŒ–æ–¹æ³•ï¼Œå¯¹é™æ€å˜é‡èµ‹åˆå§‹å€¼</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>ç±»åŠ è½½å™¨ï¼ˆClassLoaderï¼‰ä½“ç³»ç»“æ„ï¼šè¯¦ç»†å‚è€ƒ <a href="/2025/05/08/jvm-classloader-01/" title="JVM ä¹‹ ç±»åŠ è½½å™¨">JVM ä¹‹ ç±»åŠ è½½å™¨</a></p></li></ul><table><thead><tr><th>ç±»åŠ è½½å™¨åç§°</th><th>åŠ è½½å†…å®¹</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><strong>å¼•å¯¼ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰</strong></td><td>Java æ ¸å¿ƒç±»åº“ï¼ˆå¦‚ <code>java.lang.*</code>ï¼‰</td><td>ç”± JVM è‡ªèº«å®ç°ï¼Œç”¨æœ¬åœ°ä»£ç å®ç°ï¼Œæ— æ³•ç›´æ¥è®¿é—®</td></tr><tr><td><strong>æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension ClassLoaderï¼‰</strong></td><td><code>JAVA_HOME/jre/lib/ext</code> ç›®å½•ä¸‹çš„ç±»</td><td>åŠ è½½æ ‡å‡†æ‰©å±•ç±»åº“</td></tr><tr><td><strong>åº”ç”¨ç±»åŠ è½½å™¨ï¼ˆApplication ClassLoaderï¼‰</strong></td><td>ç”¨æˆ·åº”ç”¨ç±»è·¯å¾„ï¼ˆCLASSPATH æŒ‡å®šçš„ç›®å½•ï¼‰</td><td>æœ€å¸¸ç”¨ï¼ŒåŠ è½½å¤§å¤šæ•°åº”ç”¨ä»£ç </td></tr><tr><td><strong>è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼ˆCustom ClassLoaderï¼‰</strong></td><td>ç”¨æˆ·æ‰‹åŠ¨å®ç°çš„ç±»åŠ è½½å™¨</td><td>å¯ä»¥æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ï¼Œå®ç°çƒ­åŠ è½½ã€åŠ å¯†ç±»åŠ è½½ç­‰</td></tr></tbody></table><blockquote><p>ç±»åŠ è½½é‡‡ç”¨ åŒäº²å§”æ´¾æ¨¡å‹ï¼šè¯·æ±‚ä¼šå…ˆå‘çˆ¶åŠ è½½å™¨å§”æ‰˜ï¼Œåªæœ‰åœ¨çˆ¶åŠ è½½å™¨åŠ è½½å¤±è´¥æ—¶æ‰å°è¯•è‡ªèº«åŠ è½½ã€‚</p></blockquote><h3 id="å­—èŠ‚ç æ‰§è¡Œå¼•æ“ï¼ˆExecution-Engineï¼‰">å­—èŠ‚ç æ‰§è¡Œå¼•æ“ï¼ˆExecution Engineï¼‰</h3><ul class="lvl-0"><li class="lvl-2"><p>å­—èŠ‚ç æ‰§è¡Œå¼•æ“è´Ÿè´£å°† Java å­—èŠ‚ç è§£é‡Šæˆ–ç¼–è¯‘ä¸ºæœºå™¨ä»£ç ï¼Œå¹¶åœ¨åº•å±‚å¹³å°ä¸Šæ‰§è¡Œã€‚</p></li><li class="lvl-2"><p>æ‰§è¡Œå¼•æ“çš„æ ¸å¿ƒæ¨¡å—</p></li></ul><table><thead><tr><th>ç»„ä»¶åç§°</th><th>ä½œç”¨è¯´æ˜</th><th>å…³é”®ç‰¹æ€§</th></tr></thead><tbody><tr><td><strong>è§£é‡Šå™¨ï¼ˆInterpreterï¼‰</strong></td><td>å°†å­—èŠ‚ç é€æ¡è§£é‡Šæ‰§è¡Œ</td><td>å¯åŠ¨å¿«ï¼Œé€‚åˆå†·ä»£ç ï¼ˆéçƒ­ç‚¹ä»£ç ï¼‰ï¼Œæ‰§è¡Œæ•ˆç‡ç›¸å¯¹è¾ƒä½</td></tr><tr><td><strong>å³æ—¶ç¼–è¯‘å™¨ï¼ˆJIT Compilerï¼‰</strong></td><td>å°†çƒ­ç‚¹ä»£ç ç¼–è¯‘ä¸ºæœ¬åœ°æœºå™¨ç ï¼Œæé«˜æ‰§è¡Œæ•ˆç‡</td><td>åŒ…å« C1ï¼ˆClientï¼‰å’Œ C2ï¼ˆServerï¼‰ä¸¤ç§ï¼Œæ”¯æŒä¼˜åŒ–å¦‚ï¼šæ–¹æ³•å†…è”ã€é€ƒé€¸åˆ†æã€å¾ªç¯å±•å¼€ç­‰</td></tr><tr><td><strong>åƒåœ¾æ”¶é›†å™¨ï¼ˆGarbage Collector, GCï¼‰</strong></td><td>è‡ªåŠ¨å†…å­˜ç®¡ç†ï¼Œè´Ÿè´£å¯¹è±¡ç”Ÿå‘½å‘¨æœŸçš„å›æ”¶</td><td>å¸¸è§ç®—æ³•åŒ…æ‹¬ï¼šSerialã€Parallelã€CMSã€G1ã€ZGCï¼ˆä½å»¶è¿Ÿï¼‰ç­‰ï¼Œæ ¹æ®ä¸åŒåœºæ™¯é€‰æ‹©</td></tr><tr><td><strong>æœ¬åœ°æ¥å£ï¼ˆNative Interfaceï¼‰</strong></td><td>æ”¯æŒ Java ä¸æœ¬åœ°è¯­è¨€ï¼ˆå¦‚ C/C++ï¼‰çš„äº’æ“ä½œ</td><td>é€šè¿‡ JNIï¼ˆJava Native Interfaceï¼‰å®ç°ï¼Œè°ƒç”¨åº•å±‚æ“ä½œç³»ç»Ÿæˆ–ç¬¬ä¸‰æ–¹åº“åŠŸèƒ½</td></tr></tbody></table><div class="tips"><p><em><strong>å³æ—¶ç¼–è¯‘å™¨ï¼ˆJIT Compilerï¼‰</strong></em></p><ul class="lvl-1"><li class="lvl-2">JVM çš„ HotSpot ç¼–è¯‘å™¨æœ‰ä¸¤ä¸ªä¸»è¦ç»„ä»¶ï¼š<br>C1 ç¼–è¯‘å™¨ï¼ˆClient ç¼–è¯‘å™¨ï¼‰ï¼šè½»é‡ã€å¿«é€Ÿç¼–è¯‘ï¼Œä¼˜åŒ–å°‘ã€‚<br>C2 ç¼–è¯‘å™¨ï¼ˆServer ç¼–è¯‘å™¨ï¼‰ï¼šä¼˜åŒ–é«˜çº§ï¼Œè€—æ—¶é•¿ï¼Œé€‚åˆé•¿æ—¶é—´è¿è¡Œçš„çƒ­ç‚¹ä»£ç ã€‚</li><li class="lvl-2">åœ¨ 64 ä½ JDK ä¸­ï¼Œé»˜è®¤å°±æ˜¯ -server æ¨¡å¼ <code>(C2 ç¼–è¯‘å™¨)</code> ï¼Œä¸å†æ”¯æŒ -client <code>(C1 ç¼–è¯‘å™¨)</code>ã€‚</li><li class="lvl-2">åœ¨ 32 ä½ JDK ä¸­ï¼Œæ ¹æ®å¹³å°å’Œå¯åŠ¨æ–¹å¼ï¼Œå¯èƒ½ä¼šè‡ªåŠ¨é€‰æ‹© -client æˆ– -serverï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨æŒ‡å®šã€‚</li><li class="lvl-2">åˆ†å±‚ç¼–è¯‘ï¼ˆTiered Compilationï¼‰ å…è®¸ JVM åœ¨ä¸€å¼€å§‹ç”¨ C1 ç¼–è¯‘å™¨å¿«é€Ÿç¼–è¯‘å­—èŠ‚ç ï¼Œåç»­çƒ­ç‚¹ä»£ç å†äº¤ç»™ C2 ç¼–è¯‘å™¨è¿›è¡Œæ›´é«˜çº§ä¼˜åŒ–ã€‚è¿™æ ·ç»“åˆäº† -clientï¼ˆå¿«å¯åŠ¨ï¼‰å’Œ -serverï¼ˆé«˜æ€§èƒ½ï¼‰çš„ä¼˜ç‚¹ã€‚<code>TieredCompilation</code>å‚æ•°æ§åˆ¶æ˜¯å¦å¼€å¯åˆ†å±‚ç¼–è¯‘ï¼Œé»˜è®¤å¼€å¯ã€‚</li><li class="lvl-2"><code>-XX:TieredStopAtLeve=&lt;level&gt;</code> å‚æ•°æ§åˆ¶ ç¼–è¯‘å™¨æœ€å¤šä½¿ç”¨å“ªä¸€å±‚ä¼˜åŒ–çº§åˆ«ã€‚å®ƒçš„å–å€¼å¦‚ä¸‹ï¼Œå€¼è¶Šä½å¯åŠ¨è¶Šå¿«ï¼Œä½†ä¼˜åŒ–è¶Šå°‘ã€‚</li></ul><table><thead><tr><th>å€¼</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>0</td><td>ä»…è§£é‡Šæ‰§è¡Œï¼ˆä¸å¼€å¯ç¼–è¯‘å™¨ï¼‰</td></tr><tr><td>1</td><td>åªä½¿ç”¨ C1 ç¼–è¯‘å™¨çš„ç¬¬ä¸€çº§ï¼ˆæœ€å°‘ä¼˜åŒ–ï¼‰</td></tr><tr><td>2</td><td>C1 ç¬¬äºŒçº§ï¼Œç•¥å¤šä¼˜åŒ–</td></tr><tr><td>3</td><td>C1 ç¬¬ä¸‰çº§ï¼Œæ›´ä¼˜åŒ–</td></tr><tr><td>4</td><td>å¯ç”¨ C2 ç¼–è¯‘å™¨ï¼ˆå®Œå…¨ä¼˜åŒ–ï¼Œé»˜è®¤å€¼ï¼‰</td></tr></tbody></table></div><h3 id="JVM-å†…å­˜æ¨¡å‹ï¼ˆJava-Memory-Modelï¼ŒJMMï¼‰">JVM å†…å­˜æ¨¡å‹ï¼ˆJava Memory Modelï¼ŒJMMï¼‰</h3><ul class="lvl-0"><li class="lvl-2"><p>JMM æ˜¯ Java è™šæ‹Ÿæœºè§„èŒƒä¸­å®šä¹‰çš„ä¸€ç§ æŠ½è±¡å†…å­˜æ¨¡å‹ï¼Œå®ƒå†³å®šäº†å¤šçº¿ç¨‹ç¨‹åºä¸­å˜é‡çš„è¯»å†™å¯è§æ€§ã€æœ‰åºæ€§å’ŒåŸå­æ€§ã€‚åŒæ—¶ï¼ŒJVM åœ¨ç‰©ç†å±‚ä¹Ÿæœ‰ä¸€ä¸ªå®é™…çš„å†…å­˜ç»“æ„ï¼Œç§°ä¸ºè¿è¡Œæ—¶æ•°æ®åŒºåŸŸï¼ˆRuntime Data Areasï¼‰ï¼Œè¿™ä¸¤ä¸ªå¯ä»¥ç»“åˆç†è§£ã€‚</p></li><li class="lvl-2"><p>JMM çš„ä¸»è¦ç›®æ ‡</p><ul class="lvl-2"><li class="lvl-6">ä¿è¯å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ•°æ®ä¸€è‡´æ€§</li><li class="lvl-6">æŒ‡å¯¼ JVM å’Œ CPU çš„å†…å­˜äº¤äº’è¡Œä¸ºï¼ˆå¦‚é‡æ’åºã€ç¼“å­˜ï¼‰</li></ul></li><li class="lvl-2"><p>å®é™…è¿è¡Œæ—¶å†…å­˜ç»“æ„å¦‚ä¸‹ï¼š</p></li></ul><table><thead><tr><th>å†…å­˜åŒºåŸŸ</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>ğŸ“Œ <strong>ç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰</strong></td><td>æ¯ä¸ªçº¿ç¨‹ç§æœ‰ï¼Œè®°å½•å½“å‰æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤åœ°å€</td></tr><tr><td>ğŸ“Œ <strong>Java çº¿ç¨‹æ ˆ</strong></td><td>æ¯ä¸ªçº¿ç¨‹ç§æœ‰ï¼Œæ–¹æ³•è°ƒç”¨æ—¶ç”¨äºå­˜å‚¨å±€éƒ¨å˜é‡ã€æ“ä½œæ•°æ ˆç­‰</td></tr><tr><td>ğŸ“Œ <strong>æœ¬åœ°æ–¹æ³•æ ˆ</strong></td><td>ä¸è™šæ‹Ÿæœºæ ˆç±»ä¼¼ï¼Œç”¨äº native æ–¹æ³•</td></tr><tr><td>ğŸ“Œ <strong>å †ï¼ˆHeapï¼‰</strong></td><td>æ‰€æœ‰çº¿ç¨‹å…±äº«ï¼Œå­˜å‚¨å¯¹è±¡å®ä¾‹ã€æ•°ç»„ç­‰ï¼ŒGC çš„ä¸»è¦åŒºåŸŸ</td></tr><tr><td>ğŸ“Œ <strong>æ–¹æ³•åŒºï¼ˆæˆ–å…ƒç©ºé—´ï¼‰</strong></td><td>æ‰€æœ‰çº¿ç¨‹å…±äº«ï¼Œå­˜å‚¨ç±»ä¿¡æ¯ã€é™æ€å˜é‡ã€å¸¸é‡æ± ç­‰ï¼ˆJDK8 åç§°ä¸º Metaspaceï¼‰</td></tr></tbody></table><h2 id="åƒåœ¾å›æ”¶å™¨">åƒåœ¾å›æ”¶å™¨</h2><ul class="lvl-0"><li class="lvl-2"><p>åƒåœ¾å›æ”¶å™¨è´Ÿè´£è‡ªåŠ¨ç®¡ç†å†…å­˜ï¼Œå›æ”¶ä¸å†ä½¿ç”¨çš„å¯¹è±¡ï¼Œé¿å…å†…å­˜æ³„æ¼å’Œæº¢å‡ºã€‚</p></li></ul><h3 id="ä»€ä¹ˆæ˜¯åƒåœ¾">ä»€ä¹ˆæ˜¯åƒåœ¾</h3><ul class="lvl-0"><li class="lvl-2"><p>å†…å­˜ä¸­æ²¡æœ‰è¢«ï¼ˆçº¿ç¨‹æ ˆå˜é‡ï¼Œé™æ€å˜é‡ï¼Œå¸¸é‡æ± ï¼ŒJNIæŒ‡é’ˆï¼‰å¼•ç”¨çš„åœ°å€å°±æ˜¯åƒåœ¾</p></li><li class="lvl-2"><p>å¯è¾¾æ€§åˆ†æç®—æ³•ï¼šæ˜¯ç°ä»£ JVM åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦â€œè¿˜æ´»ç€â€çš„ä¸»è¦ç®—æ³•ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">åŸºæœ¬æ€æƒ³ï¼š</span><br><span class="line">ä»ä¸€ç»„ç§°ä¸º â€œGC Rootsâ€ çš„å¯¹è±¡å‡ºå‘ï¼Œæ²¿ç€å¯¹è±¡ä¹‹é—´çš„å¼•ç”¨é“¾å‘ä¸‹æœç´¢ã€‚</span><br><span class="line">å¦‚æœæŸä¸ªå¯¹è±¡ å¯ä»¥ä» GC Roots è¿½è¸ªåˆ°ï¼Œå°±è®¤ä¸ºå®ƒæ˜¯ â€œå¯è¾¾â€ çš„ï¼ˆAliveï¼‰ã€‚</span><br><span class="line">å¦åˆ™å°±è®¤ä¸ºæ˜¯ â€œä¸å¯è¾¾â€ çš„ï¼ˆGarbageï¼‰ï¼Œå¯ä»¥è¢«å›æ”¶ã€‚</span><br></pre></td></tr></table></figure><div class="tips"><ul class="lvl-1"><li class="lvl-2"><p>åœ¨ JVM ä¸­ï¼Œ<code>GC Roots</code> æ˜¯ä¸€äº› å§‹ç»ˆå¯ç”¨çš„ã€ä¸ä¼šè¢«åƒåœ¾å›æ”¶çš„å¼•ç”¨èµ·ç‚¹ï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p></li></ul><table><thead><tr><th>GC Roots æ¥æº</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>å½“å‰çº¿ç¨‹æ ˆä¸­çš„å¼•ç”¨ï¼ˆå±€éƒ¨å˜é‡è¡¨ï¼‰</td><td>å„ä¸ªçº¿ç¨‹æ­£åœ¨è°ƒç”¨çš„æ–¹æ³•ä¸­çš„å±€éƒ¨å˜é‡ã€å‚æ•°ç­‰</td></tr><tr><td>é™æ€å­—æ®µå¼•ç”¨</td><td>ç±»çš„é™æ€å­—æ®µå¼•ç”¨çš„å¯¹è±¡</td></tr><tr><td>JNI å¼•ç”¨ï¼ˆNative æ–¹æ³•å¼•ç”¨ï¼‰</td><td>Java æœ¬åœ°æ–¹æ³•ä¸­å¼•ç”¨çš„å¯¹è±¡</td></tr><tr><td>å¸¸é‡å¼•ç”¨æ± ä¸­çš„å¯¹è±¡</td><td>å­—ç¬¦ä¸²å¸¸é‡ç­‰å¯èƒ½æŒæœ‰å¯¹è±¡å¼•ç”¨</td></tr><tr><td>æ´»åŠ¨çº¿ç¨‹å¯¹è±¡</td><td>çº¿ç¨‹è‡ªèº«åœ¨ GC æ—¶ä¸ä¼šè¢«å›æ”¶</td></tr><tr><td>JVM å†…éƒ¨ç»“æ„ï¼ˆå¦‚ç³»ç»Ÿç±»åŠ è½½å™¨ç­‰ï¼‰</td><td>JVM å…³é”®ç³»ç»Ÿå¯¹è±¡</td></tr></tbody></table></div><h3 id="åƒåœ¾å›æ”¶å™¨ç§ç±»ï¼š">åƒåœ¾å›æ”¶å™¨ç§ç±»ï¼š</h3><p><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/TEILZ9.png" alt=""></p><ul class="lvl-0"><li class="lvl-2"><p>å·¦è¾¹6ç§å«åˆ†ä»£æ¨¡å‹ï¼Œå³è¾¹çš„4ç§å«åˆ†åŒºæ¨¡å‹</p></li></ul><div class="tips"><p><em><strong>åˆ†ä»£æ¨¡å‹ï¼ˆGenerational Modelï¼‰</strong></em><br>å †å†…å­˜åˆ’åˆ†ä¸ºï¼š<br>å¹´è½»ä»£ï¼ˆYoung Generationï¼‰ï¼šå­˜æ”¾æ–°åˆ›å»ºçš„å¯¹è±¡ï¼Œåˆ†ä¸º Eden å’Œ Survivor åŒºã€‚<br>è€å¹´ä»£ï¼ˆOld Generationï¼‰ï¼šå­˜æ”¾ç»è¿‡å¤šæ¬¡ GC åä»ç„¶å­˜æ´»çš„å¯¹è±¡ã€‚</p><p><em><strong>åˆ†åŒºæ¨¡å‹ï¼ˆRegion-based Modelï¼‰</strong></em><br>åˆ†åŒºæ¨¡å‹ï¼ˆå¦‚ G1ã€ZGCã€Shenandoahï¼‰ä¸å†ä¸¥æ ¼æŒ‰ç…§ä»£åˆ’åˆ†å†…å­˜ï¼Œè€Œæ˜¯æŠŠå †åˆ’åˆ†ä¸ºå¤šä¸ª å¤§å°ç›¸åŒçš„ Regionã€‚æ¯ä¸ª Region å¯ä»¥åœ¨è¿è¡Œæ—¶è¢«åŠ¨æ€æ ‡è®°ä¸º Edenã€Survivor æˆ– Oldã€‚</p></div><ul class="lvl-0"><li class="lvl-2"><p>åˆ†ä»£æ¨¡å‹ä¸­ï¼Œä¸Šé¢3ä¸ªæ˜¯æ–°ç”Ÿä»£åƒåœ¾å›æ”¶å™¨ï¼Œä¸‹é¢3ä¸ªæ˜¯è€å¹´ä»£åƒåœ¾å›æ”¶å™¨ï¼Œå¯ä»¥äº¤å‰é…å¯¹ï¼ˆè§ä¸Šå›¾è™šçº¿ï¼‰ï¼Œä½†æœ€å¸¸ç”¨æ˜¯ä¸Šä¸‹ä¸¤ä¸¤é…å¯¹ã€‚</p></li><li class="lvl-2"><p>CMSå³å¯ä»¥ä½œä¸ºæ–°ç”Ÿä»£åƒåœ¾å›æ”¶å™¨ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºè€å¹´ä»£åƒåœ¾å›æ”¶å™¨ã€‚</p></li><li class="lvl-2"><p>EpsilonGCï¼Œæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„åƒåœ¾å›æ”¶å™¨ï¼Œå®ƒä¸å›æ”¶ä»»ä½•å¯¹è±¡ï¼Œåªè´Ÿè´£æœ€ç»ˆè®°å½•ï¼Œåšæµ‹è¯•ç”¨çš„ã€‚</p></li><li class="lvl-2"><p>ç›®å‰æœ€å…ˆè¿›çš„æ¨¡å‹æ˜¯ <code>ZGC</code>ï¼Œjkd11å¼€å§‹æ”¯æŒï¼Œä½†ç›´åˆ°JDK16æ‰æ¯”è¾ƒå®Œå–„ï¼Œç›®å‰éé»˜è®¤é…ç½®ï¼Œéœ€è¦æ‰‹åŠ¨é…ç½®ã€‚å…¶ä¸Redhatå‡ºå“çš„ <code>Shenandoah</code> æ˜¯ç«äº‰å…³ç³»ã€‚</p></li><li class="lvl-2"><p>å¸¸è§åƒåœ¾å›æ”¶å™¨åŠå…¶åˆ†ç±»ã€JDKç‰ˆæœ¬</p></li></ul><table><thead><tr><th>åƒåœ¾å›æ”¶å™¨</th><th>æ‰€å±æ¨¡å‹</th><th>è¯´æ˜</th><th>é¦–æ¬¡å‡ºç° JDK ç‰ˆæœ¬</th><th>å¯ç”¨å‘½ä»¤ï¼ˆJVM å‚æ•°ï¼‰</th><th>é€‚åˆçš„å †å†…å­˜å¤§å°</th></tr></thead><tbody><tr><td><strong>Serial</strong></td><td>åˆ†ä»£æ¨¡å‹</td><td>å•çº¿ç¨‹ï¼Œæ–°ç”Ÿä»£å’Œè€å¹´ä»£éƒ½ä½¿ç”¨ Serialï¼Œé€‚ç”¨äºå°å †å†…å­˜, <code>å·²å¼ƒç”¨</code></td><td>JDK 1.2</td><td><code>-XX:+UseSerialGC</code></td><td>ğŸ’¾ å°äº 1GB</td></tr><tr><td><strong>ParNew</strong></td><td>åˆ†ä»£æ¨¡å‹</td><td>Serial çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ï¼Œ<strong>ä»…ç”¨äº CMS æ–°ç”Ÿä»£</strong>, <code>JDK11å·²å¼ƒç”¨</code></td><td>JDK 1.4</td><td><code>-XX:+UseParNewGC -XX:+UseConcMarkSweepGC</code></td><td>ğŸ’¾ 1GB ~ 4GB</td></tr><tr><td><strong>Parallelï¼ˆååé‡ GCï¼‰</strong></td><td>åˆ†ä»£æ¨¡å‹</td><td>å¤šçº¿ç¨‹ GCï¼Œé€‚åˆååé‡ä¼˜å…ˆçš„åº”ç”¨åœºæ™¯</td><td>JDK 1.4</td><td><code>-XX:+UseParallelGC</code>ï¼ˆæ–°ç”Ÿä»£ï¼‰<br><code>-XX:+UseParallelOldGC</code>ï¼ˆè€å¹´ä»£ï¼‰</td><td>ğŸ’¾ 2GB ~ 8GB</td></tr><tr><td><strong>CMSï¼ˆConcurrent Mark Sweepï¼‰</strong></td><td>åˆ†ä»£æ¨¡å‹</td><td>è€å¹´ä»£å¹¶å‘æ ‡è®°-æ¸…é™¤ï¼Œä½å»¶è¿Ÿï¼Œä½†å­˜åœ¨ç¢ç‰‡ï¼Œ<code>JDK14å·²å¼ƒç”¨</code></td><td>JDK 1.4</td><td><code>-XX:+UseConcMarkSweepGC</code></td><td>ğŸ’¾ 2GB ~ 8GB</td></tr><tr><td><strong>G1ï¼ˆGarbage Firstï¼‰</strong></td><td>åˆ†åŒºæ¨¡å‹</td><td>å°†å †åˆ’åˆ†ä¸º Regionï¼Œé€»è¾‘åˆ†ä»£ï¼Œæ”¯æŒå¹¶å‘å‹ç¼©ï¼Œå¹³è¡¡å»¶è¿Ÿä¸åå</td><td>JDK 7u4ï¼ˆæ­£å¼ï¼‰</td><td><code>-XX:+UseG1GC</code></td><td>ğŸ’¾ 4GB ~ æ•°å GB</td></tr><tr><td><strong>ZGCï¼ˆZ Garbage Collectorï¼‰</strong></td><td>åˆ†åŒºæ¨¡å‹</td><td>Region å¼¹æ€§å¤§å°ï¼Œæ”¯æŒè¶…å¤§å †ï¼Œä½å»¶è¿Ÿï¼ˆ&lt;10ms åœé¡¿ï¼‰</td><td>JDK 11ï¼ˆå®éªŒï¼‰ï¼ŒJDK 15ï¼ˆæ­£å¼ï¼‰</td><td><code>-XX:+UseZGC</code></td><td>ğŸ’¾ 8GB ~ æ•° TBï¼ˆè¶…å¤§å †ï¼‰</td></tr><tr><td><strong>Shenandoah</strong></td><td>åˆ†åŒºæ¨¡å‹</td><td>çº¢å¸½ä¸»å¯¼ï¼Œä½å»¶è¿Ÿï¼Œå¹¶å‘å›æ”¶ä¸å¹¶å‘å‹ç¼©</td><td>JDK 12ï¼ˆå®éªŒï¼‰ï¼ŒJDK 15ï¼ˆæ­£å¼ï¼‰</td><td><code>-XX:+UseShenandoahGC</code></td><td>ğŸ’¾ 2GB ~ æ•°å GB</td></tr></tbody></table><blockquote><p>å¯¹äº CMSï¼Œå¯ç”¨åä¼šè‡ªåŠ¨ä½¿ç”¨ ParNew ä½œä¸ºæ–°ç”Ÿä»£å›æ”¶å™¨ï¼ˆé™¤éæ˜¾å¼ç¦æ­¢ï¼‰ã€‚<br>å¯¹äº Parallel GC å¯ç”¨ <code>-XX:+UseParallelGC</code>ï¼ˆæ–°ç”Ÿä»£ï¼‰ä¼šè‡ªåŠ¨å¯ç”¨ <code>-XX:+UseParallelOldGC</code>ï¼ˆè€å¹´ä»£ï¼‰ã€‚<br>å¯¹äºZGCï¼Œjdk15ä»¥å‰æœ€å¤§æ”¯æŒ4Tå†…å­˜ï¼Œä¹‹åæœ€å¤§æ”¯æŒ16Tå†…å­˜ã€‚</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>å„ç‰ˆæœ¬é»˜è®¤åƒåœ¾å›æ”¶å™¨åŠæ¨èé…ç½®ï¼ˆJDK 1.6 èµ·ï¼‰</p></li></ul><table><thead><tr><th>JDK ç‰ˆæœ¬</th><th>é»˜è®¤ GC</th><th>å»ºè®®ä½¿ç”¨ GCï¼ˆæŒ‰åœºæ™¯åˆ†ç±»ï¼‰</th></tr></thead><tbody><tr><td><strong>JDK 1.6</strong></td><td>Serial / Parallel</td><td>- å°å‹åº”ç”¨ï¼ˆå¦‚æ¡Œé¢ç¨‹åºï¼‰ï¼š<code>-XX:+UseSerialGC</code>  <br> - ä¸­å¤§å‹åº”ç”¨ï¼ˆååé‡ä¼˜å…ˆï¼‰ï¼š<code>-XX:+UseParallelGC</code></td></tr><tr><td><strong>JDK 1.7</strong></td><td>åŒä¸Š</td><td>åŒ JDK 1.6</td></tr><tr><td><strong>JDK 1.8</strong></td><td>Parallel</td><td>- ååä¼˜å…ˆï¼šé»˜è®¤ <code>-XX:+UseParallelGC</code> <br> - å“åº”ä¼˜å…ˆï¼š<code>-XX:+UseConcMarkSweepGC</code>ï¼ˆCMSï¼‰<br> - å¤§å † + æœªæ¥å‡çº§è€ƒè™‘ï¼š<code>-XX:+UseG1GC</code>ï¼ˆæ¨èï¼‰</td></tr><tr><td><strong>JDK 9-14</strong></td><td>G1 GC</td><td>- ä¸€èˆ¬é»˜è®¤å³å¯ï¼š<code>-XX:+UseG1GC</code>ï¼ˆå»¶è¿Ÿä¸ååå¹³è¡¡ï¼‰<br> - æç«¯ä½å»¶è¿Ÿè¦æ±‚ï¼šå‡çº§åˆ° JDK 11+ ä½¿ç”¨ ZGC/Shenandoah</td></tr><tr><td><strong>JDK 15+</strong></td><td>G1 GCï¼ˆé»˜è®¤ï¼‰ï¼ŒZGC / Shenandoah å¯é€‰</td><td>- å»¶è¿Ÿæ•æ„Ÿï¼ˆåœ¨çº¿æœåŠ¡ã€RTç³»ç»Ÿï¼‰ï¼š<code>-XX:+UseZGC</code> æˆ– <code>-XX:+UseShenandoahGC</code><br> - ååä¸ºä¸»ï¼š<code>-XX:+UseParallelGC</code><br> - ç»¼åˆå¹³è¡¡ï¼š<code>-XX:+UseG1GC</code>ï¼ˆé»˜è®¤ï¼‰</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>åˆ¤æ–­é»˜è®¤ GC çš„æ–¹å¼</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -XX:+PrintCommandLineFlags -version</span><br></pre></td></tr></table></figure><h3 id="åƒåœ¾å›æ”¶ç®—æ³•">åƒåœ¾å›æ”¶ç®—æ³•</h3><ul class="lvl-0"><li class="lvl-2"><p>JVM ä¸­å¸¸è§åƒåœ¾å›æ”¶ç®—æ³•æ±‡æ€»</p></li></ul><table><thead><tr><th>ç®—æ³•åç§°</th><th>æ ¸å¿ƒæ€æƒ³</th><th>é€‚ç”¨é˜¶æ®µ/åŒºåŸŸ</th><th>ä¼˜ç¼ºç‚¹ç®€è¿°</th></tr></thead><tbody><tr><td><strong>æ ‡è®°-æ¸…é™¤ï¼ˆMark-Sweepï¼‰</strong></td><td>æ ‡è®°å‡ºå­˜æ´»å¯¹è±¡ï¼Œæ¸…é™¤æœªæ ‡è®°å¯¹è±¡</td><td>è€å¹´ä»£</td><td>ç®€å•é«˜æ•ˆï¼Œä½†ä¼šäº§ç”Ÿå¤§é‡ç¢ç‰‡ï¼Œä¸é€‚åˆè¿ç»­å†…å­˜åˆ†é…</td></tr><tr><td><strong>æ ‡è®°-æ•´ç†ï¼ˆMark-Compactï¼‰</strong></td><td>æ ‡è®°åç§»åŠ¨å­˜æ´»å¯¹è±¡ï¼Œæ•´ç†ç¢ç‰‡</td><td>è€å¹´ä»£</td><td>æ¶ˆé™¤ç¢ç‰‡ï¼Œä»£ä»·æ˜¯ç§»åŠ¨å¯¹è±¡ï¼Œé€‚ç”¨äºè€å¹´ä»£å‹ç¼©</td></tr><tr><td><strong>å¤åˆ¶ç®—æ³•ï¼ˆCopyingï¼‰</strong></td><td>å°†å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€å—å†…å­˜ï¼ˆå¦‚ Eden â†’ Survivorï¼‰</td><td>æ–°ç”Ÿä»£</td><td>é«˜æ•ˆç‡ï¼Œé€‚åˆå›æ”¶å¤§å¤šæ•°å¯¹è±¡çŸ­å‘½çš„æ–°ç”Ÿä»£ï¼Œä½†éœ€è¦é¢å¤–ç©ºé—´</td></tr><tr><td><strong>åˆ†ä»£å›æ”¶ï¼ˆGenerationalï¼‰</strong></td><td>å°†å¯¹è±¡æŒ‰ç”Ÿå‘½å‘¨æœŸåˆ’åˆ†ï¼ˆæ–°ç”Ÿä»£/è€å¹´ä»£ï¼‰</td><td>æ•´ä¸ªå †ç»“æ„</td><td>å®ç”¨æ€§å¼ºï¼Œç»“åˆä¸åŒç®—æ³•åº”ç”¨äºä¸åŒä»£ï¼Œç°ä»£ GC åŸºç¡€</td></tr><tr><td><strong>åˆ†åŒºå›æ”¶ï¼ˆRegion-basedï¼‰</strong></td><td>å°†å †åˆ’åˆ†ä¸ºè‹¥å¹²ç­‰å¤§å°çš„ Region åŠ¨æ€åˆ†é…</td><td>æ•´ä¸ªå †ï¼ˆå¦‚ G1ã€ZGCï¼‰</td><td>æ›´çµæ´»ï¼Œæ”¯æŒå¹¶å‘å¹¶è¡Œï¼Œå‡å°‘ STW åœé¡¿ï¼Œé€‚ç”¨äºå¤§å †ã€ä½å»¶è¿Ÿåœºæ™¯</td></tr><tr><td><strong>å¢é‡å›æ”¶ï¼ˆIncrementalï¼‰</strong></td><td>åˆ†é˜¶æ®µå°æ­¥æ‰§è¡Œ GC ä»¥å‡å°‘å•æ¬¡åœé¡¿</td><td>æŸäº›å¹¶å‘/ä½å»¶è¿Ÿ GC</td><td>å‡å°‘æš‚åœæ—¶é—´ï¼Œä½†æ•´ä½“æ•ˆç‡å¯èƒ½é™ä½</td></tr><tr><td><strong>å¹¶å‘å›æ”¶ï¼ˆConcurrentï¼‰</strong></td><td>æ ‡è®°ã€æ¸…ç†ç­‰æ­¥éª¤ä¸åº”ç”¨çº¿ç¨‹å¹¶å‘æ‰§è¡Œ</td><td>CMSã€G1ã€ZGC ç­‰</td><td>åœé¡¿æ—¶é—´çŸ­ï¼Œå¯¹å“åº”æ—¶é—´è¦æ±‚é«˜çš„ç³»ç»Ÿå‹å¥½</td></tr><tr><td><strong>ä¸‰è‰²æ ‡è®°ï¼ˆTri-color Markingï¼‰</strong></td><td>å¹¶å‘æ ‡è®°ç®—æ³•çš„ä¸€ç§å®ç°æ€æƒ³</td><td>CMSã€G1ã€ZGC ç­‰</td><td>ç™½ï¼ˆå¾…å›æ”¶ï¼‰ã€ç°ï¼ˆå·²æ ‡è®°æœªæ‰«æï¼‰ã€é»‘ï¼ˆå·²æ ‡è®°å·²æ‰«æï¼‰ï¼Œé¿å…â€œæ¼æ ‡â€é—®é¢˜</td></tr><tr><td><strong>SATBï¼ˆSnapshot-At-The-Beginningï¼‰</strong></td><td>å¹¶å‘æ ‡è®°çš„å¿«ç…§ç­–ç•¥</td><td>G1ã€ZGC</td><td>ä¿è¯åœ¨å¹¶å‘æ ‡è®°è¿‡ç¨‹ä¸­ä¸é—æ¼æ–°å¼•ç”¨ï¼Œé€‚åˆé«˜å¹¶å‘åœºæ™¯</td></tr><tr><td><strong>Lazy Compactionï¼ˆå»¶è¿Ÿå‹ç¼©ï¼‰</strong></td><td>ä¸æ¯æ¬¡ GC éƒ½å‹ç¼©ï¼Œè§†æƒ…å†µè€Œå®š</td><td>G1 ç­‰</td><td>é™ä½ä¸å¿…è¦çš„ç§»åŠ¨æˆæœ¬</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>å¯¹åº”å…³ç³»ï¼šGC å›æ”¶å™¨å’Œåº•å±‚ç®—æ³•</p></li></ul><table><thead><tr><th>å›æ”¶å™¨</th><th>ä½¿ç”¨çš„ç®—æ³•ç»„åˆ</th></tr></thead><tbody><tr><td><strong>Serial</strong></td><td>æ–°ç”Ÿä»£ï¼šå¤åˆ¶ç®—æ³•<br>è€å¹´ä»£ï¼šæ ‡è®°-æ•´ç†</td></tr><tr><td><strong>ParNew</strong></td><td>æ–°ç”Ÿä»£ï¼šå¤åˆ¶ç®—æ³•ï¼ˆå¤šçº¿ç¨‹ï¼‰</td></tr><tr><td><strong>Parallel</strong></td><td>æ–°ç”Ÿä»£ï¼šå¤åˆ¶ç®—æ³•<br>è€å¹´ä»£ï¼šæ ‡è®°-æ•´ç†</td></tr><tr><td><strong>CMS</strong></td><td>æ–°ç”Ÿä»£ï¼šParNewï¼ˆå¤åˆ¶ï¼‰<br>è€å¹´ä»£ï¼šæ ‡è®°-æ¸…é™¤ + ä¸‰è‰²æ ‡è®° + å¹¶å‘</td></tr><tr><td><strong>G1</strong></td><td>åˆ†åŒºå›æ”¶ + ä¸‰è‰²æ ‡è®° + SATB + Lazy Compaction</td></tr><tr><td><strong>ZGC</strong></td><td>åˆ†åŒºå›æ”¶ + å¹¶å‘æ ‡è®° + SATB + Region Remapping</td></tr><tr><td><strong>Shenandoah</strong></td><td>åˆ†åŒºå›æ”¶ + å¹¶å‘æ ‡è®° + å¹¶å‘å‹ç¼© + ä¸‰è‰²æ ‡è®°</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">       â”‚   å¸¸è§ GC ç®—æ³•åˆ†ç±»       â”‚</span><br><span class="line">       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                 â”‚</span><br><span class="line">   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br><span class="line">   â”‚                            â”‚</span><br><span class="line">åˆ†ä»£æ¨¡å‹                      åˆ†åŒºæ¨¡å‹</span><br><span class="line">   â”‚                            â”‚</span><br><span class="line"> â”Œâ”€â”´â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”</span><br><span class="line">å¤åˆ¶   æ ‡è®°-æ¸…é™¤         Region-based å¹¶å‘</span><br><span class="line">      æ ‡è®°-æ•´ç†             SATB / ä¸‰è‰²æ ‡è®°</span><br></pre></td></tr></table></figure><h4 id="ä»€ä¹ˆæ˜¯-STWï¼ˆStop-The-Worldï¼‰">ä»€ä¹ˆæ˜¯ STWï¼ˆStop-The-Worldï¼‰</h4><ul class="lvl-0"><li class="lvl-2"><p>STWï¼ˆStop-The-Worldï¼‰ æŒ‡çš„æ˜¯ï¼šåœ¨æŸäº›åƒåœ¾å›æ”¶é˜¶æ®µï¼ŒJVM ä¼šæš‚åœæ‰€æœ‰åº”ç”¨çº¿ç¨‹ï¼ˆä¹Ÿå«ç”¨æˆ·çº¿ç¨‹ï¼‰ï¼Œè®©åƒåœ¾å›æ”¶çº¿ç¨‹ç‹¬å  CPU æ‰§è¡Œ GC é€»è¾‘ã€‚</p></li><li class="lvl-2"><p>ä½ å¯ä»¥è¿™æ ·ç†è§£ STW</p><ul class="lvl-2"><li class="lvl-6">JVM ä¼šâ€œæŒ‰ä¸‹æš‚åœé”®â€æš‚åœæ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ Java ç¨‹åºä»£ç ï¼›</li><li class="lvl-6">ç„¶å ä¸“å¿ƒè¿›è¡Œ GC çš„æŸäº›é˜¶æ®µï¼ˆå¦‚æ ‡è®°ã€æ•´ç†ã€å¤åˆ¶ç­‰ï¼‰ï¼›</li><li class="lvl-6">GC å®Œæˆåï¼Œæ‰ä¼šâ€œæ¢å¤è¿è¡Œâ€åº”ç”¨çº¿ç¨‹ã€‚</li></ul></li><li class="lvl-2"><p>å„ GC ä¸­ STW çš„å­˜åœ¨æƒ…å†µ</p></li></ul><table><thead><tr><th>å›æ”¶å™¨</th><th>æ˜¯å¦å­˜åœ¨ STWï¼Ÿ</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>Serial</td><td>âœ… æ˜¯ï¼Œå…¨åœé¡¿ï¼Œå…¨é˜¶æ®µå•çº¿ç¨‹</td><td>å †è¶Šå¤§ STW è¶Šé•¿</td></tr><tr><td>Parallel</td><td>âœ… æ˜¯ï¼Œå…¨åœé¡¿ï¼Œå¤šçº¿ç¨‹æ‰§è¡Œ GC</td><td>æé«˜æ•ˆç‡ä½†ä»ä¼šæš‚åœ</td></tr><tr><td>CMS</td><td>âœ… æœ‰ï¼Œåˆå§‹æ ‡è®°å’Œæœ€ç»ˆé‡æ–°æ ‡è®°æ˜¯ STW</td><td>å¤§éƒ¨åˆ†é˜¶æ®µå¹¶å‘æ‰§è¡Œ</td></tr><tr><td>G1</td><td>âœ… æœ‰ï¼Œä½†è®¾è®¡ä¸ºå°½å¯èƒ½ç¼©çŸ­ STW</td><td>åˆ†é˜¶æ®µå¹¶å‘ + å¹¶è¡Œå¤„ç†</td></tr><tr><td>ZGC</td><td>âœ… æçŸ­ï¼ˆ&lt;10msï¼‰</td><td>ä»…ä¸ªåˆ«é˜¶æ®µæ˜¯ STWï¼Œå‡ ä¹æ„ŸçŸ¥ä¸åˆ°</td></tr><tr><td>Shenandoah</td><td>âœ… æçŸ­</td><td>é«˜åº¦å¹¶å‘ï¼ŒSTW æ—¶é—´ä¹ŸæçŸ­</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>ä¸ºä»€ä¹ˆè¦å…³æ³¨ STWï¼Ÿ</p><ul class="lvl-2"><li class="lvl-6">åœ¨å“åº”æ—¶é—´æ•æ„Ÿå‹ç³»ç»Ÿï¼ˆå¦‚åœ¨çº¿äº¤æ˜“ç³»ç»Ÿã€æ¸¸æˆæœåŠ¡å™¨ã€API ç½‘å…³ï¼‰ä¸­ï¼Œé•¿æ—¶é—´çš„ STW ä¼šé€ æˆç”¨æˆ·è¯·æ±‚å¡é¡¿ã€è¶…æ—¶ã€‚</li><li class="lvl-6">å› æ­¤ï¼Œé€‰æ‹© ä½ STW çš„ GCï¼ˆå¦‚ G1ã€ZGCã€Shenandoahï¼‰ å¯¹è¿™ç±»ç³»ç»Ÿè‡³å…³é‡è¦ã€‚</li></ul></li></ul><h2 id="å †å†…å­˜ç»“æ„">å †å†…å­˜ç»“æ„</h2><ul class="lvl-0"><li class="lvl-2"><p>ä¸åŒçš„åƒåœ¾å›æ”¶å™¨å†³å®šäº†å †å†…å­˜çš„ç»“æ„ä¸åŒï¼Œä½†æ€»ä½“ä¸Šåˆ†ä¸ºä¸¤ç§ç±»å‹ï¼šåˆ†ä»£æ¨¡å‹å’Œåˆ†åŒºæ¨¡å‹ã€‚</p></li></ul><h3 id="åˆ†ä»£æ¨¡å‹">åˆ†ä»£æ¨¡å‹</h3><h4 id="Parallel-åƒåœ¾å›æ”¶å™¨">Parallel åƒåœ¾å›æ”¶å™¨</h4><p><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/Apr5aY.png" alt=""></p><ul class="lvl-0"><li class="lvl-2"><p>å †ç»“æ„è¢«åˆ’åˆ†ä¸º <code>Old Generationï¼ˆè€å¹´ä»£ï¼‰</code> å’Œ <code>Young Generationï¼ˆæ–°ç”Ÿä»£ï¼‰</code> ä¸¤éƒ¨åˆ†ã€‚</p></li><li class="lvl-2"><p><code>Young Generation</code> ç”± <code>Eden</code> å’Œ ä¸¤ä¸ª <code>Survivor</code> ç»„æˆï¼Œå…¶ä¸­ <code>Eden</code> æ˜¯ä¸€ä¸ªè¿ç»­çš„å†…å­˜åŒºåŸŸï¼Œ<code>Survivor</code> æ˜¯ä¸€ä¸ªéè¿ç»­çš„å†…å­˜åŒºåŸŸã€‚</p></li><li class="lvl-2"><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>Young Generation</code>å å †å†…å­˜çš„ <code>1/3</code>,  <code>Old Generation</code> å å †å†…å­˜çš„ <code>2/3</code>ã€‚</p></li><li class="lvl-2"><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>Eden:S0:S1 = 8:1:1</code> ,å¦‚æœå¸Œæœ›ä¸º 4:1:1ï¼Œä½¿ç”¨ <code>-XX:SurvivorRatio=4</code>ï¼Œä½†å®é™…ä¸Šè¿™ä¸ªæ¯”ä¾‹å¹¶ä¸æ˜¯å›ºå®šçš„ï¼Œè€Œæ˜¯ç”±jvmåŸºäºæƒ…å†µè‡ªåŠ¨å˜åŒ–çš„ï¼Œå› ä¸ºJVMé»˜è®¤å¼€å¯äº†è¿™ä¸ªå‚æ•°<code>-XX:+UseAdaptiveSizePolicy</code>ï¼Œå¦‚æœå¸Œæœ›å›ºå®šè¿™ä¸ªæ¯”ä¾‹ï¼Œå¯ä»¥è®¾ç½®ä¸º <code>-XX:-UseAdaptiveSizePolicy</code>æ¥å…³é—­è¿™ä¸ªé…ç½®ã€‚</p></li><li class="lvl-2"><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯¹è±¡æœ€å¤šç»å†<code>15æ¬¡</code>Minor GCåè¿›å…¥è€å¹´ä»£ï¼Œå¯ä»¥é€šè¿‡ <code>-XX:MaxTenuringThreshold=n</code> è®¾ç½®ã€‚</p></li></ul><table><thead><tr><th>åŒºåŸŸ</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><strong>Eden</strong></td><td>å¯¹è±¡é¦–æ¬¡åˆ›å»ºçš„åŒºåŸŸï¼Œå¤§éƒ¨åˆ†å¯¹è±¡åœ¨è¿™é‡Œåˆ›å»ºå¹¶å¾ˆå¿«è¢«å›æ”¶</td></tr><tr><td><strong>S0/S1</strong></td><td>Survivor åŒºåŸŸï¼šä¸¤ä¸ªäº¤æ›¿ä½¿ç”¨çš„ç¼“å†²åŒºï¼ˆFrom å’Œ Toï¼‰ï¼Œç”¨äºæ‹·è´å­˜æ´»å¯¹è±¡</td></tr><tr><td><strong>Old</strong></td><td>è€å¹´ä»£ï¼šå­˜æ´»æ¬¡æ•°å¤šã€ç”Ÿå‘½å‘¨æœŸé•¿çš„å¯¹è±¡ä¼šä»æ–°ç”Ÿä»£æ™‹å‡åˆ°è€å¹´ä»£ï¼Œå›æ”¶é¢‘ç‡ä½</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>å¯¹è±¡å†…å­˜åˆ†é…å›¾è§£(ç®€åŒ–)</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">åˆ›å»ºå¯¹è±¡</span><br><span class="line">   â†“</span><br><span class="line">è¿›å…¥ Eden åŒºï¼ˆæ–°ç”Ÿä»£ï¼‰</span><br><span class="line">   â†“ Eden åŒºæ»¡</span><br><span class="line">ç¬¬ä¸€æ¬¡ Minor GCï¼ˆå­˜æ´»å¯¹è±¡[Eden]å¤åˆ¶åˆ° S0ï¼‰</span><br><span class="line">   â†“ Eden åŒºæ»¡ æˆ– S0 åŒºæ»¡</span><br><span class="line">ç¬¬äºŒæ¬¡ Minor GCï¼ˆå­˜æ´»å¯¹è±¡[Edenå’ŒS0]å¤åˆ¶åˆ° S1ï¼Œå¹´é¾„ +1ï¼‰</span><br><span class="line">   â†“ Eden åŒºæ»¡ æˆ– S1 åŒºæ»¡</span><br><span class="line">ç¬¬ä¸‰æ¬¡ Minor GCï¼ˆå­˜æ´»å¯¹è±¡[Edenå’ŒS1]å¤åˆ¶åˆ° S0ï¼Œå¹´é¾„ +1ï¼‰</span><br><span class="line">   â†“</span><br><span class="line">â€¦â€¦  S0/S1 äº¤æ›¿ï¼Œå¹´é¾„è¾¾åˆ°é˜ˆå€¼ï¼ˆå¦‚ 15ï¼‰</span><br><span class="line">   â†“ è¿˜æ²¡æœ‰è¢«å›æ”¶</span><br><span class="line">æ™‹å‡åˆ° Old åŒºï¼ˆè€å¹´ä»£ï¼‰ï¼Œç­‰å¾…OldåŒºæ»¡ è§¦å‘ Full GC</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£</p><ul class="lvl-2"><li class="lvl-6">å¤§å¯¹è±¡å°±æ˜¯éœ€è¦å¤§é‡è¿ç»­å†…å­˜ç©ºé—´çš„å¯¹è±¡ï¼ˆæ¯”å¦‚ï¼šå­—ç¬¦ä¸²ã€æ•°ç»„ï¼‰ï¼Œå¦‚æœå¯¹è±¡å¾ˆå¤§ï¼ˆå¦‚è¶…è¿‡ Eden åŒºå¤§å°ï¼Œæˆ–æ˜¯è¶…è¿‡ Survivor åŒºå¤§å°ï¼‰ï¼Œå¯èƒ½ç›´æ¥åˆ†é…åˆ°è€å¹´ä»£</li><li class="lvl-6">ä¹Ÿå¯ä»¥é€šè¿‡ <code>-XX:PretenureSizeThreshold=&lt;å¤§å°ï¼Œå•ä½å­—èŠ‚&gt;</code> æ§åˆ¶è¶…è¿‡ä¸€å®šå¤§å°çš„å¯¹è±¡æ˜¯å¦ç›´æ¥åˆ†é…åˆ°è€å¹´ä»£ï¼ˆOld Generationï¼‰ï¼Œè·³è¿‡æ–°ç”Ÿä»£ï¼ˆEdenï¼‰ï¼Œä»¥é¿å…å¤§å¯¹è±¡é¢‘ç¹åœ¨å¹´è½»ä»£é€ æˆ GC å‹åŠ›ã€‚è¿™ä¸ªå‚æ•°åªåœ¨ Serial å’ŒParNewä¸¤ä¸ªæ”¶é›†å™¨ä¸‹æœ‰æ•ˆã€‚</li></ul></li><li class="lvl-2"><p>å¯¹è±¡åŠ¨æ€å¹´é¾„åˆ¤æ–­</p><ul class="lvl-2"><li class="lvl-6">å¯¹è±¡åœ¨SurvivoråŒºæ¥å›ç§»åŠ¨æ—¶ï¼Œå¦‚æœè¿™æ‰¹å¯¹è±¡çš„æ€»å¤§å°å¤§äºè¿™å—SurvivoråŒºåŸŸå†…å­˜å¤§å°çš„50%(-XX:TargetSurvivorRatioå¯ä»¥æŒ‡å®š)ï¼Œé‚£ä¹ˆæ­¤æ—¶å¤§äºç­‰äºè¿™æ‰¹å¯¹è±¡å¹´é¾„æœ€å¤§å€¼çš„å¯¹è±¡ï¼Œå°±å¯ä»¥ç›´æ¥è¿›å…¥è€å¹´ä»£äº†ï¼Œ</li><li class="lvl-6">ä¾‹å¦‚SurvivoråŒºåŸŸé‡Œç°åœ¨æœ‰ä¸€æ‰¹å¯¹è±¡ï¼Œå¹´é¾„1+å¹´é¾„2+å¹´é¾„nçš„å¤šä¸ªå¹´é¾„å¯¹è±¡æ€»å’Œè¶…è¿‡äº†SurvivoråŒºåŸŸçš„50%ï¼Œæ­¤æ—¶å°±ä¼šæŠŠå¹´é¾„n(å«)ä»¥ä¸Šçš„å¯¹è±¡éƒ½æ”¾å…¥è€å¹´ä»£ã€‚è¿™ä¸ªè§„åˆ™å…¶å®æ˜¯å¸Œæœ›é‚£äº›å¯èƒ½æ˜¯é•¿æœŸå­˜æ´»çš„å¯¹è±¡ï¼Œå°½æ—©è¿›å…¥è€å¹´ä»£ã€‚</li><li class="lvl-6">å¯¹è±¡åŠ¨æ€å¹´é¾„åˆ¤æ–­æœºåˆ¶ä¸€èˆ¬æ˜¯åœ¨minor gcä¹‹åè§¦å‘çš„ã€‚</li></ul></li></ul><div class="tips"><ul class="lvl-1"><li class="lvl-2"><p>å¯¹è±¡é€ƒé€¸åˆ†æ</p><ul class="lvl-3"><li class="lvl-6">å¦‚æœå¯¹è±¡å¾ˆå°ï¼Œä¸”åªåœ¨æ–¹æ³•å†…éƒ¨ä½¿ç”¨ï¼Œå¹¶æ²¡æœ‰è¢«å¤–éƒ¨å¼•ç”¨ï¼Œåˆ™å…¶æœ‰å¯èƒ½ç›´æ¥åˆ†é…åˆ°æ ˆå†…å­˜ï¼Œè€Œä¸è¿›å…¥å †å†…å­˜</li><li class="lvl-6">JVMå¯¹äºè¿™ç§æƒ…å†µå¯ä»¥é€šè¿‡å¼€å¯é€ƒé€¸åˆ†æå‚æ•°(-XX:+DoEscapeAnalysis)æ¥ä¼˜åŒ–å¯¹è±¡å†…å­˜åˆ†é…ä½ç½®ï¼Œä½¿å…¶é€šè¿‡<code>æ ‡é‡æ›¿æ¢</code>ä¼˜å…ˆåˆ†é…åœ¨æ ˆä¸Š(æ ˆä¸Šåˆ†é…)ï¼ŒJDK7ä¹‹åé»˜è®¤å¼€å¯é€ƒé€¸åˆ†æï¼Œå¦‚æœè¦å…³é—­ä½¿ç”¨å‚æ•°(-XX:-DoEscapeAnalysis)</li></ul></li><li class="lvl-2"><p>æ ‡é‡æ›¿æ¢</p><ul class="lvl-3"><li class="lvl-6">é€šè¿‡é€ƒé€¸åˆ†æç¡®å®šè¯¥å¯¹è±¡ä¸ä¼šè¢«å¤–éƒ¨è®¿é—®ï¼Œå¹¶ä¸”å¯¹è±¡å¯ä»¥è¢«è¿›ä¸€æ­¥åˆ†è§£æ—¶ï¼ŒJVMä¸ä¼šåˆ›å»ºè¯¥å¯¹è±¡ï¼Œè€Œæ˜¯å°†è¯¥å¯¹è±¡æˆå‘˜å˜é‡åˆ†è§£è‹¥å¹²ä¸ªè¢«è¿™ä¸ªæ–¹æ³•ä½¿ç”¨çš„æˆå‘˜å˜é‡æ‰€ä»£æ›¿ï¼Œè¿™äº›ä»£æ›¿çš„æˆå‘˜å˜é‡åœ¨æ ˆå¸§æˆ–å¯„å­˜å™¨ä¸Šåˆ†é…ç©ºé—´ï¼Œè¿™æ ·å°±ä¸ä¼šå› ä¸ºæ²¡æœ‰ä¸€å¤§å—è¿ç»­ç©ºé—´å¯¼è‡´å¯¹è±¡å†…å­˜ä¸å¤Ÿåˆ†é…ã€‚</li><li class="lvl-6">å¼€å¯æ ‡é‡æ›¿æ¢å‚æ•°(-XX:+EliminateAllocations)ï¼ŒJDK7ä¹‹åé»˜è®¤å¼€å¯ã€‚</li></ul></li><li class="lvl-2"><p>æ ‡é‡ä¸èšåˆé‡</p><ul class="lvl-3"><li class="lvl-6">æ ‡é‡å³ä¸å¯è¢«è¿›ä¸€æ­¥åˆ†è§£çš„é‡ï¼Œè€ŒJAVAçš„åŸºæœ¬æ•°æ®ç±»å‹å°±æ˜¯æ ‡é‡ï¼ˆå¦‚ï¼šintï¼Œlongç­‰åŸºæœ¬æ•°æ®ç±»å‹ä»¥åŠreferenceç±»å‹ç­‰ï¼‰ï¼Œ</li><li class="lvl-6">æ ‡é‡çš„å¯¹ç«‹å°±æ˜¯å¯ä»¥è¢«è¿›ä¸€æ­¥åˆ†è§£çš„é‡ï¼Œè€Œè¿™ç§é‡ç§°ä¹‹ä¸ºèšåˆé‡ã€‚è€Œåœ¨JAVAä¸­å¯¹è±¡å°±æ˜¯å¯ä»¥è¢«è¿›ä¸€æ­¥åˆ†è§£çš„èšåˆé‡ã€‚</li></ul></li></ul></div><h4 id="Parallel-åƒåœ¾å›æ”¶å™¨ï¼ˆParallel-GCï¼‰-çš„å·¥ä½œæ–¹å¼">Parallel åƒåœ¾å›æ”¶å™¨ï¼ˆParallel GCï¼‰ çš„å·¥ä½œæ–¹å¼</h4><p><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/fo2Egs.png" alt="" width="1200" height="600"></p><ul class="lvl-0"><li class="lvl-2"><p>Parallel GC æ˜¯å¤šçº¿ç¨‹åƒåœ¾å›æ”¶å™¨ï¼Œå¯ä»¥é€šè¿‡ <code>-XX:ParallelGCThreads</code> æ¥è®¾ç½®GCçº¿ç¨‹æ•°é‡ã€‚</p></li><li class="lvl-2"><p>å½“ Parallel GC è¢«è§¦å‘ï¼ˆä¾‹å¦‚ Minor GC æˆ– Full GCï¼‰æ—¶ï¼Œæ‰€æœ‰ç”¨æˆ·çº¿ç¨‹ è¢«å®Œå…¨æš‚åœï¼ˆStop-The-World, STWï¼‰</p></li></ul><h4 id="Parallel-GC-å‚æ•°é…ç½®è¡¨ï¼ˆååé‡ä¼˜å…ˆ-GCï¼‰">Parallel GC å‚æ•°é…ç½®è¡¨ï¼ˆååé‡ä¼˜å…ˆ GCï¼‰</h4><table><thead><tr><th>å‚æ•°å</th><th>è¯´æ˜</th><th>é»˜è®¤å€¼ï¼ˆå¦‚æœªç‰¹åˆ«è¯´æ˜ï¼‰</th></tr></thead><tbody><tr><td><code>-XX:+UseParallelGC</code></td><td>å¼€å¯ Parallel GCï¼Œç”¨äºæ–°ç”Ÿä»£æ”¶é›†</td><td>-</td></tr><tr><td><code>-XX:+UseParallelOldGC</code></td><td>å¼€å¯è€å¹´ä»£å¹¶è¡Œæ”¶é›†ï¼ˆParallel Oldï¼‰</td><td>-</td></tr><tr><td><code>-XX:ParallelGCThreads</code></td><td>åƒåœ¾å›æ”¶æ—¶çš„å¹¶è¡Œçº¿ç¨‹æ•°ï¼ˆä¸ CPU æ•°é‡ç›¸å…³ï¼‰</td><td>æ ¹æ®ç¡¬ä»¶è‡ªåŠ¨é…ç½®</td></tr><tr><td><code>-XX:MaxGCPauseMillis</code></td><td>è®¾ç½® GC æœ€å¤§æš‚åœæ—¶é—´ç›®æ ‡ï¼ˆå½±å“å†…å­˜åˆ†é…ç­–ç•¥ï¼‰</td><td>ä¸€ä¸ªéå¸¸å¤§çš„å€¼ï¼Œå¯ä»¥è®¤ä¸ºæ— é™åˆ¶ï¼ˆå»ºè®®æŒ‰éœ€è®¾ç½®ï¼‰</td></tr><tr><td><code>-XX:GCTimeRatio</code></td><td>è®¾ç½® GC æ—¶é—´ä¸åº”ç”¨è¿è¡Œæ—¶é—´çš„æ¯”å€¼ï¼ˆ0~100ï¼‰<br>å€¼è¶Šå°ï¼ŒGC è¶Šé¢‘ç¹ï¼Œå€¼è¶Šå¤§ GC è¶Šå°‘</td><td>99ï¼ˆè¡¨ç¤º 1% ç”¨äº GCï¼Œ99% ç”¨äºåº”ç”¨ï¼‰</td></tr><tr><td><code>-XX:+UseAdaptiveSizePolicy</code></td><td>å¯ç”¨è‡ªé€‚åº” GC ç­–ç•¥ï¼ˆæ ¹æ®è¿è¡ŒçŠ¶å†µè‡ªåŠ¨è°ƒæ•´å„åŒºåŸŸå¤§å°ï¼‰</td><td>é»˜è®¤å¼€å¯</td></tr><tr><td><code>-XX:SurvivorRatio</code></td><td>Eden ä¸ Survivor çš„å†…å­˜æ¯”ä¾‹ï¼ˆå¦‚ 8 è¡¨ç¤º Eden:S0:S1 = 8:1:1ï¼‰</td><td>8</td></tr><tr><td><code>-XX:InitialTenuringThreshold</code></td><td>å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£çš„åˆå§‹å¹´é¾„ï¼ˆä¼šéšè¿è¡ŒåŠ¨æ€è°ƒæ•´ï¼‰</td><td>7</td></tr><tr><td><code>-XX:MaxTenuringThreshold</code></td><td>æ™‹å‡åˆ°è€å¹´ä»£çš„æœ€å¤§å¹´é¾„ï¼ˆå¯¹è±¡åœ¨ Survivor åŒºç»å†å‡ æ¬¡ GCï¼‰</td><td>15</td></tr><tr><td><code>-XX:PretenureSizeThreshold</code></td><td>è®¾ç½®å¤§å¯¹è±¡é˜ˆå€¼ï¼Œè¶…è¿‡è¯¥å¤§å°çš„å¯¹è±¡ç›´æ¥åˆ†é…åˆ°è€å¹´ä»£</td><td>0ï¼ˆå³ç¦ç”¨ï¼‰</td></tr><tr><td><code>-XX:+ScavengeBeforeFullGC</code></td><td>åœ¨ Full GC ä¹‹å‰æ˜¯å¦å…ˆæ‰§è¡Œä¸€æ¬¡ Minor GC</td><td>trueå¯</td></tr><tr><td><code>-XX:+UseFastAccessorMethods</code></td><td>ä¼˜åŒ–åŸå§‹ç±»å‹çš„ get/set æ–¹æ³•æ€§èƒ½</td><td>falseå¯</td></tr><tr><td><code>-XX:+AlwaysPreTouch</code></td><td>JVM å¯åŠ¨æ—¶ç«‹å³åˆ†é…å¹¶åˆå§‹åŒ–æ‰€æœ‰å†…å­˜é¡µï¼Œé¿å…è¿è¡Œæ—¶é¦–æ¬¡åˆ†é…å¸¦æ¥çš„åœé¡¿</td><td>false</td></tr></tbody></table><h3 id="åˆ†åŒºæ¨¡å‹">åˆ†åŒºæ¨¡å‹</h3><h4 id="G1-åƒåœ¾å›æ”¶å™¨">G1 åƒåœ¾å›æ”¶å™¨</h4><p><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/AaqBxm.png" alt="" width="900" height="300"></p><ul class="lvl-0"><li class="lvl-2"><p>G1(Garbage-First) å±äº ç‰©ç†ä¸Šåˆ†åŒºï¼Œé€»è¾‘ä¸Šåˆ†ä»£ï¼ŒçœŸæ­£çš„åˆ†åŒºæ¨¡å‹æ˜¯ <code>ZGC</code>ï¼ˆjdk21åä¹Ÿæ”¯æŒåˆ†ä»£ï¼‰</p></li><li class="lvl-2"><p>G1å°†Javaå †åˆ’åˆ†ä¸ºå¤šä¸ªå¤§å°ç›¸ç­‰çš„Regionï¼ŒRegionå¤§å°æ˜¯2çš„å¹‚ï¼ŒèŒƒå›´åœ¨1MBåˆ°32MBä¹‹é—´ã€‚JDK9ä¹‹å‰é»˜è®¤æœ€å¤šæ”¯æŒ2048ä¸ªRegionï¼Œè¿™å°±å¯¼è‡´G1æœ€å¤§æ”¯æŒ64G çš„å † (<code>2048 Regions Ã— 32MB = 64GB</code>)ï¼ŒJDK10ä¹‹åçš„ç‰ˆæœ¬å¯æ”¯æŒæ›´å¤šRegionæ•°é‡ï¼ŒJDK17è¿›ä¸€æ­¥ä¼˜åŒ–äº†Regionæ˜ å°„æœºåˆ¶ï¼Œæå‡äº†å¤§å †åœºæ™¯ä¸‹çš„æ€§èƒ½ï¼Œä½¿å…¶å¯ä»¥æ”¯æŒæ›´å¤§çš„å†…å­˜ï¼Œä½†å¯¹äºè¶…å¤§å †ï¼ˆ&gt;1Tï¼‰ï¼Œè€ƒè™‘åˆ°GCæš‚åœæ—¶é—´ï¼Œå»ºè®®ä½¿ç”¨ZGCæˆ–Shenandoah GCã€‚</p></li><li class="lvl-2"><p>Regionä¸€æ—¦è¢«å›æ”¶ï¼Œé‡æ–°åˆ†é…æ—¶å¯ä»¥æ˜¯ä»»æ„ç±»å‹ï¼Œæ¯”å¦‚åŸå…ˆæ˜¯<code>Eden</code>ï¼Œé‚£ä¹ˆé‡æ–°åˆ†é…æ—¶å¯ä»¥æ˜¯<code>Old</code>ï¼Œåä¹‹äº¦ç„¶ã€‚</p></li><li class="lvl-2"><p>ä¸€èˆ¬Regionå¤§å°ç”±JVMè‡ªåŠ¨è®¡ç®—ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç”¨å‚æ•°<code>-XX:G1HeapRegionSize</code>æ‰‹åŠ¨æŒ‡å®šRegionå¤§å°ï¼Œä½†æ˜¯æ¨èé»˜è®¤çš„è®¡ç®—æ–¹å¼ã€‚</p></li><li class="lvl-2"><p>G1ä¿ç•™äº†å¹´è½»ä»£å’Œè€å¹´ä»£çš„æ¦‚å¿µï¼Œä½†ä¸å†æ˜¯ç‰©ç†éš”é˜‚äº†ï¼Œå®ƒä»¬éƒ½æ˜¯ï¼ˆå¯ä»¥ä¸è¿ç»­ï¼‰Regionçš„é›†åˆã€‚</p></li><li class="lvl-2"><p>åœ¨ G1 GC ä¸­ï¼Œä¸è¦ä½¿ç”¨ <code>-Xmn</code>ï¼ŒG1 ä¸­æ¨èä½¿ç”¨ä»¥ä¸‹æ›´ç»†ç²’åº¦çš„æ§åˆ¶æ–¹å¼ï¼š</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿™æ˜¯å®éªŒæ€§å‚æ•°ï¼Œéœ€è¦å¼€å¯ `-XX:+UnlockExperimentalVMOptions`ï¼Œä½†ä¾æ—§æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨</span></span><br><span class="line">-XX:G1NewSizePercent=5</span><br><span class="line">-XX:G1MaxNewSizePercent=60</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>é»˜è®¤å¹´è½»ä»£å¯¹å †å†…å­˜çš„å æ¯”æ˜¯<code>5%</code>ï¼Œå¦‚æœå †å¤§å°ä¸º4096Mï¼Œé‚£ä¹ˆå¹´è½»ä»£å æ®200MBå·¦å³çš„å†…å­˜ï¼Œå¯¹åº”å¤§æ¦‚æ˜¯100ä¸ªRegionï¼Œå¯ä»¥é€šè¿‡   <code>-XX:G1NewSizePercent</code>è®¾ç½®æ–°ç”Ÿä»£åˆå§‹å æ¯”ï¼Œè¿™æ˜¯å®éªŒæ€§å‚æ•°ï¼Œéœ€è¦å¼€å¯ <code>-XX:+UnlockExperimentalVMOptions</code>ï¼Œä½†ä¾æ—§æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚</p></li><li class="lvl-2"><p>åœ¨ç³»ç»Ÿè¿è¡Œä¸­ï¼ŒJVMä¼šä¸åœçš„ç»™å¹´è½»ä»£å¢åŠ æ›´å¤šçš„Regionï¼Œä½†æ˜¯æœ€å¤šæ–°ç”Ÿä»£çš„å æ¯”ä¸ä¼šè¶…è¿‡<code>60%</code>ï¼Œå¯ä»¥é€šè¿‡<code>-XX:G1MaxNewSizePercent</code>è°ƒæ•´ï¼Œè¿™æ˜¯å®éªŒæ€§å‚æ•°ï¼Œéœ€è¦å¼€å¯ <code>-XX:+UnlockExperimentalVMOptions</code>ï¼Œä½†ä¾æ—§æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚</p></li><li class="lvl-2"><p>å¹´è½»ä»£ä¸­çš„Edenå’ŒSurvivorå¯¹åº”çš„regionä¹Ÿè·Ÿä¹‹å‰ä¸€æ ·ï¼Œé»˜è®¤<code>8:1:1</code>ï¼Œå‡è®¾å¹´è½»ä»£ç°åœ¨æœ‰1000ä¸ªregionï¼ŒedenåŒºå¯¹åº”800ä¸ªï¼Œs0å¯¹åº”100ä¸ªï¼Œs1å¯¹åº”100ä¸ªã€‚</p></li><li class="lvl-2"><p>ä¸€ä¸ªRegionå¯èƒ½ä¹‹å‰æ˜¯å¹´è½»ä»£ï¼Œå¦‚æœRegionè¿›è¡Œäº†åƒåœ¾å›æ”¶ï¼Œä¹‹åå¯èƒ½åˆä¼šå˜æˆè€å¹´ä»£ï¼Œä¹Ÿå°±æ˜¯è¯´Regionçš„åŒºåŸŸåŠŸèƒ½å¯èƒ½ä¼šåŠ¨æ€å˜åŒ–ã€‚</p></li><li class="lvl-2"><p>G1åƒåœ¾æ”¶é›†å™¨å¯¹äºå¯¹è±¡ä»€ä¹ˆæ—¶å€™ä¼šè½¬ç§»åˆ°è€å¹´ä»£è·Ÿä¹‹å‰è®²è¿‡çš„åŸåˆ™ä¸€æ ·ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯å¯¹å¤§å¯¹è±¡çš„å¤„ç†ï¼ŒG1æœ‰ä¸“é—¨åˆ†é…å¤§å¯¹è±¡çš„Regionå«<code>Humongous</code>åŒºï¼Œè€Œä¸æ˜¯è®©å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£çš„Regionä¸­ã€‚</p></li><li class="lvl-2"><p>åœ¨G1ä¸­ï¼Œå¤§å¯¹è±¡çš„åˆ¤å®šè§„åˆ™å°±æ˜¯ä¸€ä¸ªå¤§å¯¹è±¡è¶…è¿‡äº†ä¸€ä¸ªRegionå¤§å°çš„<code>50%</code>ï¼Œæ¯”å¦‚æŒ‰ç…§ä¸Šé¢ç®—çš„ï¼Œæ¯ä¸ªRegionæ˜¯2Mï¼Œåªè¦ä¸€ä¸ªå¤§å¯¹è±¡è¶…è¿‡äº†1Mï¼Œå°±ä¼šè¢«æ”¾å…¥Humongousä¸­ï¼Œè€Œä¸”ä¸€ä¸ªå¤§å¯¹è±¡å¦‚æœå¤ªå¤§ï¼Œå¯èƒ½ä¼šæ¨ªè·¨å¤šä¸ªRegionæ¥å­˜æ”¾ã€‚</p></li><li class="lvl-2"><p>HumongousåŒºä¸“é—¨å­˜æ”¾çŸ­æœŸå·¨å‹å¯¹è±¡ï¼Œä¸ç”¨ç›´æ¥è¿›è€å¹´ä»£ï¼Œå¯ä»¥èŠ‚çº¦è€å¹´ä»£çš„ç©ºé—´ï¼Œé¿å…å› ä¸ºè€å¹´ä»£ç©ºé—´ä¸å¤Ÿçš„GCå¼€é”€ã€‚</p></li><li class="lvl-2"><p>Full GCçš„æ—¶å€™é™¤äº†æ”¶é›†å¹´è½»ä»£å’Œè€å¹´ä»£ä¹‹å¤–ï¼Œä¹Ÿä¼šå°†HumongousåŒºä¸€å¹¶å›æ”¶ã€‚</p></li></ul><h5 id="G1åƒåœ¾æ”¶é›†åˆ†ç±»">G1åƒåœ¾æ”¶é›†åˆ†ç±»</h5><ul class="lvl-0"><li class="lvl-2"><p>YoungGC<br>YoungGCå¹¶ä¸æ˜¯è¯´ç°æœ‰çš„EdenåŒºæ”¾æ»¡äº†å°±ä¼šé©¬ä¸Šè§¦å‘ï¼ŒG1ä¼šè®¡ç®—ä¸‹ç°åœ¨EdenåŒºå›æ”¶å¤§æ¦‚è¦å¤šä¹…æ—¶é—´ï¼Œå¦‚æœå›æ”¶æ—¶é—´è¿œè¿œå°äºå‚æ•° <code>-XX:MaxGCPauseMills</code> è®¾å®šçš„å€¼ï¼Œé‚£ä¹ˆå¢åŠ å¹´è½»ä»£çš„regionï¼Œç»§ç»­ç»™æ–°å¯¹è±¡å­˜æ”¾ï¼Œä¸ä¼šé©¬ä¸ŠåšYoungGCï¼Œç›´åˆ°ä¸‹ä¸€æ¬¡EdenåŒºæ”¾æ»¡ï¼ŒG1è®¡ç®—å›æ”¶æ—¶é—´æ¥è¿‘å‚æ•° <code>-XX:MaxGCPauseMills</code> è®¾å®šçš„å€¼ï¼Œé‚£ä¹ˆå°±ä¼šè§¦å‘Young GC</p></li><li class="lvl-2"><p>MixedGC<br>ä¸æ˜¯FullGCï¼Œè€å¹´ä»£çš„å †å æœ‰ç‡è¾¾åˆ°å‚æ•° <code>-XX:InitiatingHeapOccupancyPercent</code> è®¾å®šçš„å€¼åˆ™è§¦å‘ï¼Œå›æ”¶æ‰€æœ‰çš„Youngå’Œéƒ¨åˆ†Old(æ ¹æ®æœŸæœ›çš„GCåœé¡¿æ—¶é—´ç¡®å®šoldåŒºåƒåœ¾æ”¶é›†çš„ä¼˜å…ˆé¡ºåº)ä»¥åŠå¤§å¯¹è±¡åŒºï¼Œæ­£å¸¸æƒ…å†µG1çš„åƒåœ¾æ”¶é›†æ˜¯å…ˆåšMixedGCï¼Œä¸»è¦ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œéœ€è¦æŠŠå„ä¸ªregionä¸­å­˜æ´»çš„å¯¹è±¡æ‹·è´åˆ°åˆ«çš„regioné‡Œå»ï¼Œæ‹·è´è¿‡ç¨‹ä¸­å¦‚æœå‘ç°æ²¡æœ‰è¶³å¤Ÿçš„ç©ºregionèƒ½å¤Ÿæ‰¿è½½æ‹·è´å¯¹è±¡å°±ä¼šè§¦å‘ä¸€æ¬¡Full GC</p></li><li class="lvl-2"><p>Full GC<br>åœæ­¢ç³»ç»Ÿç¨‹åºï¼Œç„¶åé‡‡ç”¨å•çº¿ç¨‹è¿›è¡Œæ ‡è®°ã€æ¸…ç†å’Œå‹ç¼©æ•´ç†ï¼Œå¥½ç©ºé—²å‡ºæ¥ä¸€æ‰¹Regionæ¥ä¾›ä¸‹ä¸€æ¬¡MixedGCä½¿ç”¨ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯éå¸¸è€—æ—¶çš„ã€‚(Shenandoahä¼˜åŒ–æˆå¤šçº¿ç¨‹æ”¶é›†äº†)</p></li></ul><h4 id="G1-æ”¶é›†å™¨çš„å·¥ä½œæ–¹å¼-MixedGC">G1 æ”¶é›†å™¨çš„å·¥ä½œæ–¹å¼(MixedGC)</h4><p><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/XbkEoh.png" alt="" width="1200" height="400"></p><ul class="lvl-0"><li class="lvl-2"><p>å›¾ä¸­ä¸»è¦å±•ç¤ºäº†ä¸€ä¸ªå…¸å‹çš„ G1 GC çš„ å¹¶å‘æ ‡è®°å‘¨æœŸï¼ˆConcurrent Mark Cycleï¼‰ çš„è¿‡ç¨‹ã€‚</p></li><li class="lvl-2"><p>å›¾ä¸­çš„æ°´å¹³ç®­å¤´è¡¨ç¤ºå„çº¿ç¨‹ï¼ˆç”¨æˆ·çº¿ç¨‹å’ŒGCçº¿ç¨‹ï¼‰çš„æ‰§è¡Œè·¯å¾„ã€‚</p></li><li class="lvl-2"><p>ç«–ç›´çš„<code>Safepoint</code>çº¿è¡¨ç¤ºä¸€æ¬¡GCè¿‡ç¨‹ä¸­ä¼šæš‚åœæ‰€æœ‰ç”¨æˆ·çº¿ç¨‹çš„æ—¶åˆ»ï¼ˆStop-The-Worldï¼‰ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">1ï¸âƒ£ åˆå§‹æ ‡è®°ï¼ˆInitial Markï¼‰</span><br><span class="line">    è¿›å…¥ Safepointï¼š æ‰€æœ‰ç”¨æˆ·çº¿ç¨‹åœ¨æ­¤åˆ»æš‚åœï¼ˆSTWï¼‰ã€‚</span><br><span class="line">    æ ‡è®° GC Roots ç›´æ¥å¯è¾¾å¯¹è±¡ã€‚</span><br><span class="line">    éå¸¸çŸ­æš‚ï¼Œä½†å±äº Stop-The-World é˜¶æ®µã€‚</span><br><span class="line">    å›¾ä¸­æ˜¯â€œåˆå§‹æ ‡è®°â€ç®­å¤´åœ¨ Safepoint ä¹‹åç«‹åˆ»æ‰§è¡Œã€‚</span><br><span class="line"></span><br><span class="line">2ï¸âƒ£ å¹¶å‘æ ‡è®°ï¼ˆConcurrent Markï¼‰</span><br><span class="line">    ç”¨æˆ·çº¿ç¨‹ æ¢å¤è¿è¡Œï¼ˆå›¾ä¸­ç”¨æˆ·çº¿ç¨‹ç»§ç»­å‘å³å»¶ä¼¸ï¼‰ã€‚</span><br><span class="line">    GC çº¿ç¨‹ å¹¶å‘è¿›è¡Œæ ‡è®°å·¥ä½œï¼ˆå³åœ¨ç”¨æˆ·çº¿ç¨‹è¿è¡ŒæœŸé—´è¿›è¡Œæ ‡è®°ï¼‰ã€‚</span><br><span class="line">    å›¾ä¸­è“è‰²çš„â€œå¹¶å‘æ ‡è®°â€ç®­å¤´ä¸ç”¨æˆ·çº¿ç¨‹ç®­å¤´å¹¶è¡Œæ˜¾ç¤ºï¼Œè¡¨ç¤ºå¹¶å‘æ‰§è¡Œã€‚</span><br><span class="line"></span><br><span class="line">3ï¸âƒ£ æœ€ç»ˆæ ‡è®°ï¼ˆRemark / Final Markï¼‰</span><br><span class="line">    å†æ¬¡è¿›å…¥ Safepointã€‚</span><br><span class="line">    é‡æ–°æš‚åœæ‰€æœ‰ç”¨æˆ·çº¿ç¨‹ã€‚</span><br><span class="line">    å¤„ç†å¹¶å‘æ ‡è®°é˜¶æ®µä¸­é—æ¼çš„å¼•ç”¨æ›´æ–°ç­‰ä¿¡æ¯ï¼Œä¿è¯æ ‡è®°çš„å‡†ç¡®æ€§ã€‚</span><br><span class="line"></span><br><span class="line">4ï¸âƒ£ ç­›é€‰å›æ”¶ï¼ˆCleanup / Filtered Collectionï¼‰</span><br><span class="line">    å¯¹å·²æ ‡è®°çš„å¯¹è±¡åšæ¸…ç†ï¼ˆå›æ”¶ä¸å¯è¾¾å¯¹è±¡ï¼‰ã€‚</span><br><span class="line">    åˆ¤æ–­æ˜¯å¦éœ€è¦å›æ”¶æŸäº› Regionã€‚</span><br><span class="line">    å›¾ä¸­è“è‰²ç®­å¤´æ ‡æ³¨ä¸ºâ€œç­›é€‰å›æ”¶â€ã€‚</span><br><span class="line"></span><br><span class="line">5ï¸âƒ£ æ¢å¤ç”¨æˆ·çº¿ç¨‹</span><br><span class="line">    åœ¨æœ€åä¸€ä¸ª Safepoint ä¹‹åï¼Œæ‰€æœ‰ç”¨æˆ·çº¿ç¨‹é‡æ–°å¼€å§‹æ‰§è¡Œï¼ˆå›¾ä¸­é»„è‰²ç®­å¤´é‡æ–°å‘å³å»¶ä¼¸ï¼‰ã€‚</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>G1çš„GC è¿‡ç¨‹ä¼šç»å†å¤šæ¬¡<code>Safepoint</code>ï¼Œä½†åªæœ‰ <code>å¹¶å‘æ ‡è®°é˜¶æ®µ</code> æ˜¯æ•´ä¸ªå‘¨æœŸä¸­æœ€è€—æ—¶ä½†ä¸ä¼šæš‚åœç”¨æˆ·çº¿ç¨‹(STW)çš„éƒ¨åˆ†ã€‚</p></li></ul><div class="tips"><p><em><strong>Safepointï¼ˆå®‰å…¨ç‚¹ï¼‰</strong></em></p><ul class="lvl-1"><li class="lvl-2">åœ¨ JVMï¼ˆJava è™šæ‹Ÿæœºï¼‰ä¸­ï¼ŒSafepointï¼ˆå®‰å…¨ç‚¹ï¼‰ æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œå®ƒä»£è¡¨ æ‰€æœ‰çº¿ç¨‹å¿…é¡»â€œå®‰å…¨åœ°â€æš‚åœçš„æŸä¸ªæ—¶é—´ç‚¹ï¼Œä»¥ä¾¿ JVM èƒ½å¤Ÿæ‰§è¡ŒæŸäº›å…¨å±€æ“ä½œï¼Œæ¯”å¦‚ï¼š<br>åƒåœ¾å›æ”¶ï¼ˆGCï¼‰<br>æ ˆéå†ï¼ˆä¾‹å¦‚ç”Ÿæˆå †å¿«ç…§ã€åšé€ƒé€¸åˆ†æç­‰ï¼‰<br>ç±»å¸è½½<br>JIT ç¼–è¯‘çš„ä¸€äº›é‡å†™æ“ä½œç­‰</li><li class="lvl-2">å¦‚æœçº¿ç¨‹æ­£åœ¨è¿è¡Œã€æ”¹å˜å †ä¸­å¯¹è±¡çš„æ•°æ®ï¼Œé‚£ä¹ˆ GC å°±æ— æ³•å‡†ç¡®æ ‡è®°å’Œå›æ”¶å¯¹è±¡ã€‚å› æ­¤ JVM éœ€è¦ è®©æ‰€æœ‰çº¿ç¨‹åœ¨ä¸€ä¸ªâ€œå¯æ§ã€å®‰å…¨çš„ä½ç½®â€ä¸Šæš‚åœï¼Œè¿™ä¸ªä½ç½®å°±å« Safepointã€‚</li><li class="lvl-2">Safepoint æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Ÿ<br>1.JVM å‘å‡ºâ€œè¿›å…¥ Safepointâ€çš„ä¿¡å·ï¼ˆæ¯”å¦‚è¦å¼€å§‹ GCï¼‰<br>2.æ‰€æœ‰çº¿ç¨‹æ”¶åˆ°ä¿¡å·åï¼Œå¿…é¡»ç­‰åˆ°â€œæœ€è¿‘çš„ Safepointâ€å†åœä¸‹æ¥ï¼š<br>Safepoint ä¸æ˜¯ä»»æ„ä½ç½®éƒ½å¯ä»¥åœï¼Œå®ƒåªå‡ºç°åœ¨å­—èŠ‚ç ä¸­ä¸€äº›ç‰¹å®šçš„æŒ‡ä»¤ç‚¹ï¼ˆæ¯”å¦‚æ–¹æ³•è°ƒç”¨ã€å¾ªç¯è·³è½¬ç­‰ï¼‰<br>3.ç­‰æ‰€æœ‰çº¿ç¨‹éƒ½è¿›å…¥ Safepoint åï¼ŒJVM æ‰èƒ½å¼€å§‹æ‰§è¡Œ GC ç­‰å…¨å±€æ“ä½œã€‚</li></ul></div><h5 id="G1-æ”¶é›†å™¨å‚æ•°é…ç½®è¡¨">G1 æ”¶é›†å™¨å‚æ•°é…ç½®è¡¨</h5><table><thead><tr><th>å‚æ•°å</th><th>è¯´æ˜</th><th>é»˜è®¤å€¼</th></tr></thead><tbody><tr><td><code>-XX:+UseG1GC</code></td><td>ä½¿ç”¨ G1 åƒåœ¾æ”¶é›†å™¨</td><td>-</td></tr><tr><td><code>-XX:ParallelGCThreads</code></td><td>æŒ‡å®š GC å·¥ä½œçš„çº¿ç¨‹æ•°é‡</td><td>ä¸ CPU æ•°é‡ç›¸å…³</td></tr><tr><td><code>-XX:G1HeapRegionSize</code></td><td>è®¾ç½®å †åˆ†åŒºå¤§å°ï¼ˆ1MB~32MBï¼Œ2 çš„å¹‚ï¼‰ï¼Œå †é»˜è®¤åˆ’åˆ†ä¸º 2048 ä¸ª Region</td><td>è‡ªåŠ¨è®¡ç®—</td></tr><tr><td><code>-XX:MaxGCPauseMillis</code></td><td>è®¾ç½® GC ç›®æ ‡æœ€å¤§æš‚åœæ—¶é—´</td><td>200ms</td></tr><tr><td><code>-XX:G1NewSizePercent</code></td><td>æ–°ç”Ÿä»£åˆå§‹å æ¯”ï¼ˆå æ•´ä¸ªå †ï¼‰ï¼Œå®éªŒæ€§å‚æ•°ï¼Œ-XX:+UnlockExperimentalVMOptions</td><td>5%</td></tr><tr><td><code>-XX:G1MaxNewSizePercent</code></td><td>æ–°ç”Ÿä»£æœ€å¤§å æ¯”ï¼ˆå æ•´ä¸ªå †ï¼‰ï¼Œå®éªŒæ€§å‚æ•°ï¼Œ-XX:+UnlockExperimentalVMOptions</td><td>60%</td></tr><tr><td><code>-XX:TargetSurvivorRatio</code></td><td>Survivor åŒºå¡«å……ç›®æ ‡ï¼ˆè¶…è¿‡è¯¥æ¯”ä¾‹ï¼Œæ™‹å‡è€å¹´ä»£ï¼‰</td><td>50%</td></tr><tr><td><code>-XX:MaxTenuringThreshold</code></td><td>æœ€å¤§å¯¹è±¡å¹´é¾„é˜ˆå€¼ï¼ˆå¹´é¾„è¶…è¿‡å°†è¿›å…¥è€å¹´ä»£ï¼‰</td><td>15</td></tr><tr><td><code>-XX:InitiatingHeapOccupancyPercent</code></td><td>è€å¹´ä»£çš„ä½¿ç”¨ç‡è¶…è¿‡è¯¥å€¼è§¦å‘ Mixed GC</td><td>45%</td></tr><tr><td><code>-XX:G1MixedGCLiveThresholdPercent</code></td><td>Mixed GC ä¸­ï¼šRegion å­˜æ´»å¯¹è±¡å æ¯”ä½äºè¯¥å€¼æ‰ä¼šè¢«å›æ”¶ï¼Œå®éªŒæ€§å‚æ•°ï¼Œ-XX:+UnlockExperimentalVMOptions</td><td>85%</td></tr><tr><td><code>-XX:G1HeapWastePercent</code></td><td>Mixed GC å›æ”¶ç›®æ ‡ï¼šç©ºé—² Region è¾¾å †æ€»é‡è¯¥ç™¾åˆ†æ¯”å°±ç»“æŸæ··åˆå›æ”¶</td><td>5%</td></tr><tr><td><code>-XX:G1ReservePercent</code></td><td>ä¸ºæ»¡è¶³åœé¡¿æ—¶é—´ç›®æ ‡ä¿ç•™çš„å †ç©ºé—´æ¯”ä¾‹ï¼Œæ˜¯ä¸€ç§ç©ºé—´æ¢æ—¶é—´çš„ç­–ç•¥ï¼Œåœ¨å†…å­˜ä¸è¶³æ—¶å¯èƒ½é€ æˆå†…å­˜æ›´åŠ ç´§å¼ </td><td>10%</td></tr><tr><td><code>-XX:G1UseAdaptiveIHOP</code></td><td>æ˜¯å¦å¯ç”¨è‡ªé€‚åº”IHOPï¼Œå¯ç”¨åG1ä¼šåœ¨åˆå§‹é‡‡æ ·åè‡ªåŠ¨è°ƒæ•´IHOPå€¼</td><td>true</td></tr><tr><td><code>-XX:G1AdaptiveIHOPNumInitialSamples</code></td><td>æŒ‡å®šå‰å‡ æ¬¡GCæ´»åŠ¨æŒ‰IHOPå‚æ•°è®¡ç®—</td><td>3</td></tr><tr><td><code>-XX:SoftRefLRUPolicyMSPerMB</code></td><td>æ¯MBå †å†…å­˜ä¸­è½¯å¼•ç”¨çš„è¿‡æœŸæ—¶é—´(ms)</td><td>1000</td></tr><tr><td><code>-XX:G1OldCSetRegionThresholdPercent</code></td><td>è®¾ç½®ä¸€æ¬¡æ··åˆGCä¸­éœ€è¦æ¸…ç†çš„OldåŒºçš„å†…å­˜æ¯”ä¾‹ï¼Œè°ƒå¤§å¯é™ä½G1é¢‘ç‡ä½†ä¼šå¢åŠ æ¯æ¬¡GCæ—¶é—´</td><td>10%</td></tr><tr><td><code>-XX:G1MixedGCCountTarget</code></td><td>è®¾ç½®G1åƒåœ¾å›æ”¶å™¨çš„çº¿ç¨‹ä¸Šé™ï¼ŒHotSpotä¼šæ ¹æ®æ¸…ç†ç›®æ ‡è‡ªåŠ¨è®¡ç®—æ‰€éœ€çº¿ç¨‹æ•°ï¼Œä½†ä¸ä¼šè¶…è¿‡æ­¤ä¸Šé™</td><td>8</td></tr></tbody></table><h4 id="ZGC-åƒåœ¾å›æ”¶å™¨">ZGC åƒåœ¾å›æ”¶å™¨</h4><p><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/bBUAYt.png" alt="" width="700" height="500"></p><ul class="lvl-0"><li class="lvl-2"><p>ZGC(Z Garbage Collector)æ˜¯ä¸€æ¬¾JDK 11ä¸­æ–°åŠ å…¥çš„å…·æœ‰å®éªŒæ€§è´¨çš„ä½å»¶è¿Ÿåƒåœ¾æ”¶é›†å™¨ï¼ŒZGCå¯ä»¥è¯´æºè‡ªäºæ˜¯Azul Systemå…¬å¸å¼€å‘çš„C4ï¼ˆConcurrent Continuously Compacting Collectorï¼‰ æ”¶é›†å™¨</p></li></ul><table><thead><tr><th>Platform</th><th>Supported</th><th>Since</th><th>Comment</th></tr></thead><tbody><tr><td>Linux/x64</td><td>âœ…</td><td>JDK 11</td><td></td></tr><tr><td>Linux/AArch64</td><td>âœ…</td><td>JDK 13</td><td></td></tr><tr><td>macOS</td><td>âœ…</td><td>JDK 14</td><td></td></tr><tr><td>Windows</td><td>âœ…</td><td>JDK 14</td><td>Requires Windows version 1803 (Windows 10 or Windows Server 2019) or later.</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>ZGCæ”¶é›†å™¨æ˜¯ä¸€æ¬¾åŸºäºRegionå†…å­˜å¸ƒå±€çš„ï¼Œæš‚æ—¶ä¸è®¾åˆ†ä»£çš„(jdk21åæ”¯æŒåˆ†ä»£)ï¼Œä½¿ç”¨äº†<code>è¯»å±éšœ</code>ã€<code>é¢œè‰²æŒ‡é’ˆ</code>ç­‰æŠ€æœ¯æ¥å®ç°å¯å¹¶å‘çš„æ ‡è®°-æ•´ç†ç®—æ³•çš„ï¼Œä»¥ä½å»¶è¿Ÿä¸ºé¦–è¦ç›®æ ‡çš„ä¸€æ¬¾åƒåœ¾æ”¶é›†å™¨ã€‚</p></li></ul><div class="tips"><p><em><strong>é¢œè‰²æŒ‡é’ˆ</strong></em></p><ul class="lvl-1"><li class="lvl-2">åœ¨ ZGCï¼ˆZ Garbage Collectorï¼‰ä¸­ï¼Œé¢œè‰²æŒ‡é’ˆï¼ˆColored Pointerï¼‰æ˜¯ä¸€ç§æ ¸å¿ƒæœºåˆ¶ï¼ŒæŠŠå¯¹è±¡çš„ GC çŠ¶æ€ä¿¡æ¯ç›´æ¥åµŒå…¥åˆ°å¯¹è±¡çš„å¼•ç”¨ï¼ˆåœ°å€ï¼‰ä¸­ï¼Œç”¨äºåœ¨ä¸å¢åŠ å¯¹è±¡é¢å¤–å…ƒæ•°æ®çš„å‰æä¸‹ï¼Œè·Ÿè¸ªå¯¹è±¡åœ¨åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­çš„çŠ¶æ€ã€‚</li><li class="lvl-2">åœ¨ä¼ ç»Ÿ GC ä¸­ï¼Œå¯¹è±¡çš„â€œé¢œè‰²â€ï¼ˆå¦‚ç™½è‰²ã€ç°è‰²ã€é»‘è‰²ï¼‰è¡¨ç¤ºå…¶åœ¨ GC ä¸åŒé˜¶æ®µçš„çŠ¶æ€ï¼Œè¿™äº›ä¿¡æ¯ä¸€èˆ¬å­˜å‚¨åœ¨é¢å¤–çš„æ•°æ®ç»“æ„ä¸­ï¼ˆå¦‚è®°å¿†é›†åˆã€ä½å›¾ç­‰ï¼‰ã€‚</li><li class="lvl-2">è€Œåœ¨ ZGC ä¸­ï¼ŒZGC å°†å¯¹è±¡çš„è¿™äº›çŠ¶æ€ä¿¡æ¯ç¼–ç è¿›æŒ‡é’ˆçš„é«˜ä½ä¸­ã€‚æ‰€ä»¥ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼ˆpointerï¼‰ä¸ä»…ä»…æ˜¯å†…å­˜åœ°å€ï¼Œè¿˜æºå¸¦äº†å¯¹è±¡åœ¨ GC è¿‡ç¨‹ä¸­çš„â€œé¢œè‰²â€ä¿¡æ¯ã€‚</li><li class="lvl-2">ZGC ä¸»è¦è¿è¡Œåœ¨ 64 ä½ç³»ç»Ÿä¸Šï¼Œä½†å½“å‰çš„æ“ä½œç³»ç»Ÿå’Œ CPU å®é™…ä¸Šåªä½¿ç”¨ 48ï½57 ä½è™šæ‹Ÿåœ°å€ã€‚ZGC åˆ©ç”¨æœªä½¿ç”¨çš„é«˜ä½è¿›è¡Œç¼–ç ã€‚<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/LD51Zb.png" alt="" width="900" height="300"></li><li class="lvl-2">æ¯ä¸ªå¯¹è±¡æœ‰ä¸€ä¸ª64ä½æŒ‡é’ˆï¼Œè¿™64ä½è¢«åˆ†ä¸ºï¼š</li></ul><table><thead><tr><th>ä½æ•°</th><th>åç§°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>18 ä½</td><td>é¢„ç•™</td><td>ä¿ç•™ä½ï¼Œæœªæ¥å¯èƒ½ç”¨äºæ‰©å±•åŠŸèƒ½</td></tr><tr><td>1 ä½</td><td>Finalizable</td><td>è¡¨ç¤ºå¯¹è±¡å¯ç»ˆç»“ï¼ˆå³å®ç°äº† <code>finalize()</code> æ–¹æ³•ï¼‰</td></tr><tr><td>1 ä½</td><td>Remapped</td><td>æ ‡è¯†å¯¹è±¡æ˜¯å¦å·²è¢«è½¬ç§»(ç”¨äºæ ‡è¯†æŸä¸ªå¼•ç”¨æ˜¯å¦å·²ç»è¢«é‡å®šå‘ï¼ˆæ›´æ–°ä¸ºæ–°åœ°å€ï¼‰)ï¼›ä¸º 1 è¡¨ç¤ºè¯¥å¯¹è±¡æœªåœ¨é‡å®šä½é›†ï¼ˆRelocation Setï¼‰ä¸­ï¼Œå³æ–°åœ°å€ï¼Œä¸º0è¡¨ç¤ºæ—§åœ°å€</td></tr><tr><td>1 ä½</td><td>Marked1</td><td>æ ‡è®°ä½ä¹‹ä¸€ï¼Œç”¨äº GC è¿‡ç¨‹ä¸­çš„å¯¹è±¡æ ‡è®°é˜¶æ®µ ,ç”±äº ZGC æ˜¯å¹¶å‘ GCï¼Œéœ€è¦ä¸¤ä½æ¥æ”¯æŒé¢œè‰²åˆ‡æ¢æœºåˆ¶ï¼ˆColor Flipï¼‰ï¼Œç¡®ä¿åœ¨ä¸åŒ GC å‘¨æœŸä¸­å¯ä»¥åŒºåˆ†æ–°æ—§æ ‡è®°ï¼Œéœ€è¦è§¦å‘ä¸€æ¬¡è¯»å–å±éšœï¼ˆload barrierï¼‰ï¼Œæ‰¾åˆ°å¯¹è±¡çš„æ–°ä½ç½®ï¼Œå¹¶æ›´æ–°è¿™ä¸ªå¼•ç”¨ã€‚</td></tr><tr><td>1 ä½</td><td>Marked0</td><td>å¦ä¸€ä¸ªæ ‡è®°ä½ï¼Œä¸ Marked1 é…åˆç”¨äº GC æ ‡è®°é˜¶æ®µ</td></tr><tr><td>42 ä½</td><td>å¯¹è±¡åœ°å€éƒ¨åˆ†</td><td>å®é™…çš„å†…å­˜åœ°å€éƒ¨åˆ†ï¼Œæœ€å¤šå¯è¡¨ç¤º 2^42 å­—èŠ‚ï¼ˆå³ 4 TBï¼‰,jdk15åå ç”¨ 44ä½ï¼Œæ”¯æŒ 16TB</td></tr></tbody></table><p><em><strong>è¯»å±éšœ</strong></em></p><ul class="lvl-1"><li class="lvl-2"><p>ZGCï¼ˆZ Garbage Collectorï¼‰ä¸­çš„**è¯»å±éšœï¼ˆRead Barrierï¼‰æ˜¯å…¶æ ¸å¿ƒæœºåˆ¶ä¹‹ä¸€ï¼Œå®ƒä¿è¯äº†å¹¶å‘å‹ç¼©ï¼ˆå¯¹è±¡ç§»åŠ¨ï¼‰**æ—¶ç¨‹åºçš„æ­£ç¡®æ€§ï¼Œæ˜¯å®ç°ä½å»¶è¿Ÿã€é«˜å¹¶å‘åƒåœ¾å›æ”¶çš„å…³é”®ã€‚</p></li><li class="lvl-2"><p>åœ¨ä¼ ç»Ÿ GC ä¸­ï¼Œå¦‚æœå¯¹è±¡åœ¨ GC è¿‡ç¨‹ä¸­è¢«ç§»åŠ¨ï¼Œç¨‹åºè®¿é—®åˆ°çš„å¯¹è±¡åœ°å€å¯èƒ½å°±æ— æ•ˆäº†ã€‚å› æ­¤ï¼Œéœ€è¦**â€œåœä¸–ç•Œâ€**å°†æ‰€æœ‰å¼•ç”¨æ›´æ–°ã€‚</p></li><li class="lvl-2"><p>è€Œ ZGC çš„è®¾è®¡ç›®æ ‡æ˜¯ &lt;10ms çš„ GC åœé¡¿æ—¶é—´ï¼Œæ‰€ä»¥å®ƒé‡‡ç”¨ <code>å¹¶å‘æ ‡è®° + å¹¶å‘ç§»åŠ¨ + å¹¶å‘å¼•ç”¨æ›´æ–°</code> çš„æ¨¡å¼ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå¯¹è±¡å¯ä»¥åœ¨ç¨‹åºè¿è¡Œæ—¶è¢«ç§»åŠ¨ï¼Œä½†ç¨‹åºè®¿é—®æ—¶å¿…é¡»â€œçŸ¥é“â€è¿™ä¸ªå¯¹è±¡æ˜¯å¦å·²ç»è¢«ç§»åŠ¨ï¼Œå¹¶è·å–å…¶æœ€æ–°åœ°å€ï¼Œè¿™å°±æ˜¯è¯»å±éšœçš„èŒè´£ã€‚</p></li><li class="lvl-2"><p>è¯»å±éšœæ˜¯ä¸€ç§åœ¨è¯»å–å¯¹è±¡å¼•ç”¨æ—¶è‡ªåŠ¨æ’å…¥çš„é€»è¾‘ï¼Œç”¨äºæ£€æŸ¥å¼•ç”¨æ˜¯å¦æœ‰æ•ˆï¼Œå¹¶åœ¨å¿…è¦æ—¶è¿›è¡Œä¿®æ­£ï¼ˆå³åœ°å€é‡å®šå‘ï¼‰ã€‚</p></li><li class="lvl-2"><p>ZGC æ˜¯ç›®å‰å”¯ä¸€åœ¨æ‰€æœ‰å¯¹è±¡è®¿é—®ä¸­éƒ½ä½¿ç”¨è¯»å±éšœçš„ GCï¼Œå®ƒåœ¨æ¯æ¬¡å¯¹è±¡æŒ‡é’ˆè§£å¼•ç”¨æ—¶éƒ½è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š</p></li></ul><table><thead><tr><th>èŒè´£</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><strong>æ£€æµ‹å¼•ç”¨æ˜¯å¦æ˜¯è€åœ°å€</strong></td><td>åˆ©ç”¨æŒ‡é’ˆä¸­çš„å…ƒä¿¡æ¯ï¼ˆé¢œè‰²æŒ‡é’ˆï¼Œå¦‚ Remapped ä½ï¼‰åˆ¤æ–­å¼•ç”¨æ˜¯å¦å·²ç»è¢«æ›´æ–°</td></tr><tr><td><strong>å¦‚æœæœªæ›´æ–°åˆ™é‡å®šå‘å¼•ç”¨</strong></td><td>å¦‚æœå¼•ç”¨çš„æ˜¯æ—§åœ°å€ï¼Œå±éšœä¼šé€šè¿‡ forwarding table æ‰¾åˆ°æ–°åœ°å€å¹¶æ›´æ–°</td></tr><tr><td><strong>ä¿è¯æœ€ç»ˆè®¿é—®å¯¹è±¡çš„åœ°å€æ­£ç¡®</strong></td><td>å³ä½¿åœ¨å¯¹è±¡ç§»åŠ¨è¿‡ç¨‹ä¸­ï¼Œç¨‹åºä¹Ÿæ€»èƒ½è®¿é—®åˆ°æœ‰æ•ˆåœ°å€ï¼Œæ— éœ€åœé¡¿æ‰€æœ‰çº¿ç¨‹</td></tr></tbody></table><pre><code class="mermaid">graph TDA[ç¨‹åºè®¿é—®å¯¹è±¡å¼•ç”¨&lt;br&#x2F;&gt;ä¾‹å¦‚ï¼šPerson p &#x3D; personField] --&gt; B[JVM æ’å…¥è¯»å±éšœé€»è¾‘]B --&gt; C[è¯»å±éšœæ£€æŸ¥é¢œè‰²æŒ‡é’ˆä¸­çš„ Remapped ä½]C --&gt; D{Remapped ä½ä¸º 0 å—ï¼Ÿ}D -- æ˜¯ --&gt; E[æ£€æŸ¥å¯¹è±¡æ˜¯å¦å·²è¢«ç§»åŠ¨]E --&gt; F[æ›´æ–°å¼•ç”¨åœ°å€ä¸ºæ–°åœ°å€]F --&gt; G[è®¾ç½® Remapped ä½ä¸º 1]G --&gt; H[ä½¿ç”¨æ›´æ–°åçš„å¼•ç”¨è®¿é—®å¯¹è±¡]D -- å¦ --&gt; I[ç›´æ¥ä½¿ç”¨å½“å‰å¼•ç”¨è®¿é—®å¯¹è±¡]</code></pre></div><ul class="lvl-0"><li class="lvl-2"><p>ZGCçš„Regionå¯ä»¥å…·æœ‰å¤§ã€ä¸­ã€å°ä¸‰ç±»å®¹é‡ï¼š</p><ul class="lvl-2"><li class="lvl-6">å°å‹Regionï¼ˆSmall Regionï¼‰ ï¼š å®¹é‡å›ºå®šä¸º2MBï¼Œç”¨äºæ”¾ç½®å°äº256KBçš„å°å¯¹è±¡ã€‚</li><li class="lvl-6">ä¸­å‹Regionï¼ˆMedium Regionï¼‰ ï¼š å®¹é‡å›ºå®šä¸º32MBï¼Œç”¨äºæ”¾ç½®å¤§äºç­‰äº256KBä½†å°äº4MBçš„å¯¹è±¡ã€‚</li><li class="lvl-6">å¤§å‹Regionï¼ˆLarge Regionï¼‰ ï¼š å®¹é‡ä¸å›ºå®šï¼Œå¯ä»¥åŠ¨æ€å˜åŒ–ï¼Œä½†å¿…é¡»ä¸º2MBçš„æ•´æ•°å€ï¼Œç”¨äºæ”¾ç½®4MBæˆ–ä»¥ä¸Šçš„å¤§å¯¹è±¡ã€‚</li></ul><blockquote><p>æ¯ä¸ªå¤§å‹Regionä¸­åªä¼šå­˜æ”¾ä¸€ä¸ªå¤§å¯¹è±¡ï¼Œè¿™ä¹Ÿé¢„ç¤ºç€è™½ç„¶åå­—å«ä½œâ€œå¤§å‹Regionâ€ï¼Œä½†å®ƒçš„å®é™…å®¹é‡å®Œå…¨æœ‰å¯èƒ½å°äºä¸­å‹Regionï¼Œæœ€å°å®¹é‡å¯ä½è‡³4MBã€‚</p></blockquote></li><li class="lvl-2"><p>ZGC ç‰¹ç‚¹ï¼š</p><ul class="lvl-2"><li class="lvl-6">æ”¯æŒæå¤§å †ï¼ˆJDK 15 èµ·æ”¯æŒæœ€é«˜ 16TBï¼‰</li><li class="lvl-6">GC åœé¡¿æ—¶é—´é€šå¸¸ä½äº 1msï¼ˆä¸å †å¤§å°åŸºæœ¬æ— å…³ï¼‰</li><li class="lvl-6">é€‚åˆä½å»¶è¿Ÿã€é«˜ååã€é«˜å¯ç”¨çš„åº”ç”¨åœºæ™¯ï¼Œå¦‚äº¤æ˜“ç³»ç»Ÿã€å¹¿å‘Šæ¨èç­‰</li></ul></li></ul><h5 id="ZGC-æ”¶é›†å™¨çš„å·¥ä½œæ–¹å¼">ZGC æ”¶é›†å™¨çš„å·¥ä½œæ–¹å¼</h5><p><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/94yKcU.png" alt=""></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">1ï¸âƒ£ å¹¶å‘æ ‡è®°ï¼ˆConcurrent Markï¼‰ï¼š</span><br><span class="line">   ä¸G1ä¸€æ ·ï¼Œå¹¶å‘æ ‡è®°æ˜¯éå†å¯¹è±¡å›¾åšå¯è¾¾æ€§åˆ†æçš„é˜¶æ®µï¼Œ</span><br><span class="line">   å®ƒçš„åˆå§‹æ ‡è®°(Mark Start)å’Œæœ€ç»ˆæ ‡è®°(Mark End)ä¹Ÿä¼šå‡ºç°çŸ­æš‚çš„åœé¡¿ï¼Œ</span><br><span class="line">   ä¸G1ä¸åŒçš„æ˜¯ï¼ŒZGCçš„æ ‡è®°æ˜¯åœ¨æŒ‡é’ˆä¸Šè€Œä¸æ˜¯åœ¨å¯¹è±¡ä¸Šè¿›è¡Œçš„ï¼Œ</span><br><span class="line">   æ ‡è®°é˜¶æ®µä¼šæ›´æ–°æŸ“è‰²æŒ‡é’ˆä¸­çš„ Marked 0ã€ Marked 1 æ ‡å¿—ä½ã€‚</span><br><span class="line"></span><br><span class="line">2ï¸âƒ£ å¹¶å‘é¢„å¤‡é‡åˆ†é…ï¼ˆConcurrent Prepare <span class="keyword">for</span> Relocateï¼‰ï¼š</span><br><span class="line">   è¿™ä¸ªé˜¶æ®µéœ€è¦æ ¹æ®ç‰¹å®šçš„æŸ¥è¯¢æ¡ä»¶ç»Ÿè®¡å¾—å‡ºæœ¬æ¬¡æ”¶é›†è¿‡ç¨‹è¦æ¸…ç†å“ªäº›Regionï¼Œå°†è¿™äº›Regionç»„æˆé‡åˆ†é…é›†ï¼ˆRelocation Setï¼‰ã€‚</span><br><span class="line">   ZGCæ¯æ¬¡å›æ”¶éƒ½ä¼šæ‰«ææ‰€æœ‰çš„Regionï¼Œç”¨èŒƒå›´æ›´å¤§çš„æ‰«ææˆæœ¬æ¢å–çœå»G1ä¸­è®°å¿†é›†çš„ç»´æŠ¤æˆæœ¬ã€‚</span><br><span class="line"></span><br><span class="line">3ï¸âƒ£ å¹¶å‘é‡åˆ†é…ï¼ˆConcurrent Relocateï¼‰ï¼š</span><br><span class="line">   é‡åˆ†é…æ˜¯ZGCæ‰§è¡Œè¿‡ç¨‹ä¸­çš„æ ¸å¿ƒé˜¶æ®µï¼Œè¿™ä¸ªè¿‡ç¨‹è¦æŠŠé‡åˆ†é…é›†ä¸­çš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°æ–°çš„Regionä¸Šï¼Œ</span><br><span class="line">   å¹¶ä¸ºé‡åˆ†é…é›†ä¸­çš„æ¯ä¸ªRegionç»´æŠ¤ä¸€ä¸ªè½¬å‘è¡¨ï¼ˆForward Tableï¼‰ï¼Œè®°å½•ä»æ—§å¯¹è±¡åˆ°æ–°å¯¹è±¡çš„è½¬å‘å…³ç³»ã€‚</span><br><span class="line">   ZGCæ”¶é›†å™¨èƒ½ä»…ä»å¼•ç”¨ä¸Šå°±æ˜ç¡®å¾—çŸ¥ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¤„äºé‡åˆ†é…é›†ä¹‹ä¸­ï¼Œå¦‚æœç”¨æˆ·çº¿ç¨‹æ­¤æ—¶å¹¶å‘è®¿é—®äº†ä½äºé‡åˆ†é…é›†ä¸­çš„å¯¹è±¡ï¼Œ</span><br><span class="line">   è¿™æ¬¡è®¿é—®å°†ä¼šè¢«é¢„ç½®çš„å†…å­˜å±éšœ(è¯»å±éšœ)æ‰€æˆªè·ï¼Œç„¶åç«‹å³æ ¹æ®Regionä¸Šçš„è½¬å‘è¡¨è®°å½•å°†è®¿é—®è½¬å‘åˆ°æ–°å¤åˆ¶çš„å¯¹è±¡ä¸Šï¼Œ</span><br><span class="line">   å¹¶åŒæ—¶ä¿®æ­£æ›´æ–°è¯¥å¼•ç”¨çš„å€¼ï¼Œä½¿å…¶ç›´æ¥æŒ‡å‘æ–°å¯¹è±¡ï¼ŒZGCå°†è¿™ç§è¡Œä¸ºç§°ä¸ºæŒ‡é’ˆçš„â€œè‡ªæ„ˆâ€ï¼ˆSelf-Healingï¼‰èƒ½åŠ›ã€‚</span><br><span class="line"></span><br><span class="line">4ï¸âƒ£ å¹¶å‘é‡æ˜ å°„ï¼ˆConcurrent Remapï¼‰ï¼š</span><br><span class="line">   é‡æ˜ å°„æ‰€åšçš„å°±æ˜¯ä¿®æ­£æ•´ä¸ªå †ä¸­æŒ‡å‘é‡åˆ†é…é›†ä¸­æ—§å¯¹è±¡çš„æ‰€æœ‰å¼•ç”¨ï¼Œä½†æ˜¯ZGCä¸­å¯¹è±¡å¼•ç”¨å­˜åœ¨â€œè‡ªæ„ˆâ€åŠŸèƒ½ï¼Œæ‰€ä»¥è¿™ä¸ªé‡æ˜ å°„æ“ä½œå¹¶ä¸æ˜¯å¾ˆè¿«åˆ‡ã€‚</span><br><span class="line">   ZGCå¾ˆå·§å¦™åœ°æŠŠå¹¶å‘é‡æ˜ å°„é˜¶æ®µï¼ˆConcurrent Remapï¼‰è¦åšçš„å·¥ä½œï¼Œåˆå¹¶åˆ°äº†ä¸‹ä¸€æ¬¡åƒåœ¾æ”¶é›†å¾ªç¯ä¸­çš„å¹¶å‘æ ‡è®°é˜¶æ®µï¼ˆConcurrent Markï¼‰é‡Œå»å®Œæˆï¼Œ</span><br><span class="line">   åæ­£å®ƒä»¬éƒ½æ˜¯è¦éå†æ‰€æœ‰å¯¹è±¡çš„ï¼Œè¿™æ ·åˆå¹¶å°±èŠ‚çœäº†ä¸€æ¬¡éå†å¯¹è±¡å›¾çš„å¼€é”€ã€‚</span><br><span class="line">   ä¸€æ—¦æ‰€æœ‰æŒ‡é’ˆéƒ½è¢«ä¿®æ­£ä¹‹åï¼Œ åŸæ¥è®°å½•æ–°æ—§å¯¹è±¡å…³ç³»çš„è½¬å‘è¡¨å°±å¯ä»¥é‡Šæ”¾æ‰äº†ã€‚</span><br></pre></td></tr></table></figure><h5 id="ZGCå­˜åœ¨çš„é—®é¢˜">ZGCå­˜åœ¨çš„é—®é¢˜</h5><ul class="lvl-0"><li class="lvl-2"><p>ZGCæœ€å¤§çš„é—®é¢˜æ˜¯<code>æµ®åŠ¨åƒåœ¾</code>ã€‚ZGCçš„åœé¡¿æ—¶é—´æ˜¯åœ¨10msä»¥ä¸‹ï¼Œä½†æ˜¯ZGCçš„æ‰§è¡Œæ—¶é—´è¿˜æ˜¯è¿œè¿œå¤§äºè¿™ä¸ªæ—¶é—´çš„ã€‚å‡å¦‚ZGCå…¨è¿‡ç¨‹éœ€è¦æ‰§è¡Œ10åˆ†é’Ÿï¼Œåœ¨è¿™ä¸ªæœŸé—´ç”±äºå¯¹è±¡åˆ†é…é€Ÿç‡å¾ˆé«˜ï¼Œå°†åˆ›å»ºå¤§é‡çš„æ–°å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡å¾ˆéš¾è¿›å…¥å½“æ¬¡GCï¼Œæ‰€ä»¥åªèƒ½åœ¨ä¸‹æ¬¡GCçš„æ—¶å€™è¿›è¡Œå›æ”¶ï¼Œè¿™äº›åªèƒ½ç­‰åˆ°ä¸‹æ¬¡GCæ‰èƒ½å›æ”¶çš„å¯¹è±¡å°±æ˜¯æµ®åŠ¨åƒåœ¾ã€‚</p></li><li class="lvl-2"><p>ZGCæ²¡æœ‰åˆ†ä»£æ¦‚å¿µï¼Œæ¯æ¬¡éƒ½éœ€è¦è¿›è¡Œå…¨å †æ‰«æï¼Œå¯¼è‡´ä¸€äº›â€œæœç”Ÿå¤•æ­»â€çš„å¯¹è±¡æ²¡èƒ½åŠæ—¶çš„è¢«å›æ”¶ã€‚</p></li><li class="lvl-2"><p>ç›®å‰å”¯ä¸€çš„åŠæ³•æ˜¯å¢å¤§å †çš„å®¹é‡ï¼Œä½¿å¾—ç¨‹åºå¾—åˆ°æ›´å¤šçš„å–˜æ¯æ—¶é—´ï¼Œä½†æ˜¯è¿™ä¸ªä¹Ÿæ˜¯ä¸€ä¸ªæ²»æ ‡ä¸æ²»æœ¬çš„æ–¹æ¡ˆã€‚å¦‚æœéœ€è¦ä»æ ¹æœ¬ä¸Šè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¿˜æ˜¯éœ€è¦å¼•å…¥åˆ†ä»£æ”¶é›†ï¼Œè®©æ–°ç”Ÿå¯¹è±¡éƒ½åœ¨ä¸€ä¸ªä¸“é—¨çš„åŒºåŸŸä¸­åˆ›å»ºï¼Œç„¶åä¸“é—¨é’ˆå¯¹è¿™ä¸ªåŒºåŸŸè¿›è¡Œæ›´é¢‘ç¹ã€æ›´å¿«çš„æ”¶é›†ã€‚</p></li><li class="lvl-2"><p>JDK21æ­£å¼å¼•å…¥äº†åˆ†ä»£ï¼ˆjdk17æ˜¯é¢„è§ˆç‰ˆï¼‰ï¼Œå¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œéœ€è¦æ‰‹åŠ¨å¼€å¯ï¼š<code>-XX:+ZGenerational</code></p></li></ul><h5 id="ZGC-æ”¶é›†å™¨å‚æ•°é…ç½®è¡¨">ZGC æ”¶é›†å™¨å‚æ•°é…ç½®è¡¨</h5><table><thead><tr><th>å‚æ•°å</th><th>è¯´æ˜</th><th>é»˜è®¤å€¼ï¼ˆå¦‚æœªç‰¹æ®Šæ ‡æ³¨ï¼‰</th></tr></thead><tbody><tr><td><code>-XX:+UseZGC</code></td><td>å¯ç”¨ ZGC åƒåœ¾æ”¶é›†å™¨</td><td>-</td></tr><tr><td><code>-XX:+UnlockExperimentalVMOptions</code></td><td>è§£é”å®éªŒæ€§å‚æ•°ï¼ˆJDK 11~14 ä½¿ç”¨ ZGC å¿…é¡»ï¼‰</td><td>-</td></tr><tr><td><code>-XX:+UseLargePages</code></td><td>å¯ç”¨å¤§é¡µå†…å­˜ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰</td><td>false</td></tr><tr><td><code>-XX:+UseTransparentHugePages</code></td><td>å¯ç”¨é€æ˜å¤§é¡µï¼ˆéƒ¨åˆ† Linux ä¸Šå¯ç»“åˆä½¿ç”¨ï¼‰</td><td>false</td></tr><tr><td><code>-Xmx</code> / <code>-Xms</code></td><td>è®¾ç½®æœ€å¤§/åˆå§‹å †å¤§å°</td><td>ç”¨æˆ·é…ç½®</td></tr><tr><td><code>-XX:ZUncommitDelay=&lt;ç§’&gt;</code></td><td>æœªä½¿ç”¨å†…å­˜é‡Šæ”¾å›æ“ä½œç³»ç»Ÿçš„å»¶è¿Ÿæ—¶é—´ï¼ˆZGC ä¼šè‡ªåŠ¨é‡Šæ”¾å†…å­˜ï¼‰</td><td>300ï¼ˆ5åˆ†é’Ÿï¼‰</td></tr><tr><td><code>-XX:SoftMaxHeapSize=&lt;å¤§å°&gt;</code></td><td>è½¯æœ€å¤§å †ï¼ˆSoft Heap Limitï¼‰ï¼šZGC å°è¯•å°†ä½¿ç”¨çš„å †æ§åˆ¶åœ¨è¯¥å€¼ä»¥å†…</td><td>é»˜è®¤ç­‰äº -Xmx</td></tr><tr><td><code>-XX:MaxHeapFreeRatio</code></td><td>æœ€å¤§å †ç©ºé—²æ¯”ä¾‹ï¼ˆè¶…è¿‡æ­¤æ¯”ä¾‹å¯èƒ½è§¦å‘å†…å­˜é‡Šæ”¾ï¼‰</td><td>70</td></tr><tr><td><code>-XX:MinHeapFreeRatio</code></td><td>æœ€å°å †ç©ºé—²æ¯”ä¾‹ï¼ˆä½äºæ­¤æ¯”ä¾‹å¯èƒ½è§¦å‘æ‰©å®¹ï¼‰</td><td>40</td></tr><tr><td><code>-XX:+ZGenerational</code></td><td>å¯ç”¨ ZGC åˆ†ä»£æ”¶é›†ï¼ˆä» JDK 21 èµ·æ”¯æŒï¼Œé»˜è®¤å…³é—­ï¼‰</td><td>falseï¼ˆJDK 21+ï¼‰</td></tr><tr><td><code>-XX:+PrintGC</code> / <code>-Xlog:gc*</code></td><td>å¼€å¯ GC æ—¥å¿—è¾“å‡º</td><td>-</td></tr><tr><td><code>-XX:+ZProactive</code></td><td>ä¸»åŠ¨å›æ”¶ç­–ç•¥ï¼ˆåœ¨ç³»ç»Ÿç©ºé—²æ—¶å°è¯•å›æ”¶ï¼‰</td><td>true</td></tr><tr><td><code>-XX:ZCollectionInterval=&lt;ç§’&gt;</code></td><td>ä¸»åŠ¨å›æ”¶ä¹‹é—´çš„æœ€å°æ—¶é—´é—´éš”ï¼ˆé…åˆ ZProactiveï¼‰</td><td>é»˜è®¤å€¼å› ç‰ˆæœ¬è€Œå¼‚</td></tr></tbody></table><h3 id="ZGC-vs-G1-GC-vs-Parallel-GC-å¯¹æ¯”è¡¨">ZGC vs G1 GC vs Parallel GC å¯¹æ¯”è¡¨</h3><table><thead><tr><th>ç‰¹æ€§</th><th><strong>ZGC</strong></th><th><strong>G1 GC</strong></th><th><strong>Parallel GC</strong></th></tr></thead><tbody><tr><td><strong>è®¾è®¡ç›®æ ‡</strong></td><td><strong>æä½å»¶è¿Ÿ</strong>ï¼Œ&lt;1ms åœé¡¿</td><td>å¹³è¡¡ <strong>ä½å»¶è¿Ÿ</strong> ä¸ <strong>é«˜åå</strong></td><td><strong>é«˜åå</strong>ï¼Œæœ€å¤§åŒ– CPU ä½¿ç”¨</td></tr><tr><td><strong>GC åœé¡¿æ—¶é—´</strong></td><td>&lt;1msï¼Œå †å¤§å°å¢åŠ ä¸å½±å“åœé¡¿æ—¶é—´</td><td>å‡ ååˆ°å‡ ç™¾æ¯«ç§’ï¼Œå †è¶Šå¤§åœé¡¿è¶Šæ˜æ˜¾</td><td>åœé¡¿æ—¶é—´å¯èƒ½è¾¾åˆ°ç§’çº§ï¼Œ<strong>å †è¶Šå¤§è¶Šæ˜æ˜¾</strong></td></tr><tr><td><strong>å †å¤§å°æ”¯æŒ</strong></td><td>æ”¯æŒé«˜è¾¾ <strong>16TB</strong>ï¼ˆJDK 15+ï¼‰</td><td>æ”¯æŒ <strong>æœ€å¤š 4TB</strong></td><td>æ”¯æŒå¤§å †ï¼Œä½†åœé¡¿æ˜æ˜¾</td></tr><tr><td><strong>æ˜¯å¦åˆ†ä»£</strong></td><td>é»˜è®¤ä¸åˆ†ä»£ï¼ˆJDK 21+ å¯å¼€å¯ <code>-XX:+ZGenerational</code>ï¼‰</td><td>åˆ†ä»£ï¼ˆæ–°ç”Ÿä»£ + è€å¹´ä»£ï¼‰</td><td>åˆ†ä»£ï¼ˆæ–°ç”Ÿä»£ + è€å¹´ä»£ï¼‰</td></tr><tr><td><strong>å¹¶å‘å›æ”¶</strong></td><td>æ˜¯ï¼Œ<strong>åŒ…æ‹¬æ ‡è®°ã€å‹ç¼©ã€å¼•ç”¨å¤„ç†éƒ½å¹¶å‘</strong></td><td>éƒ¨åˆ†å¹¶å‘ï¼Œä»åŒ…å«æ˜æ˜¾ Stop-The-World é˜¶æ®µ</td><td>å¦ï¼Œ<strong>å…¨éƒ¨ Stop-The-World</strong></td></tr><tr><td><strong>ç§»åŠ¨å¯¹è±¡æ—¶æ˜¯å¦åœé¡¿</strong></td><td>å¦ï¼Œä½¿ç”¨è¯»å±éšœå¹¶å‘è½¬ç§»å¯¹è±¡</td><td>æ˜¯ï¼ˆé€šè¿‡å¤åˆ¶åŒºåŸŸï¼‰</td><td>æ˜¯</td></tr><tr><td><strong>å®ç°æœºåˆ¶</strong></td><td>æ ‡è®°-é‡å®šä½ï¼ŒåŸºäºè¯»å±éšœ</td><td>Region åˆ†åŒº + æ ‡è®°-å¤åˆ¶ + Mixed GC</td><td>æ ‡è®°-å¤åˆ¶ï¼ˆæ–°ç”Ÿä»£ï¼‰ã€æ ‡è®°-æ•´ç†ï¼ˆè€å¹´ä»£ï¼‰</td></tr><tr><td><strong>ååèƒ½åŠ›</strong></td><td>ä¸­é«˜</td><td>é«˜</td><td><strong>æœ€é«˜</strong></td></tr><tr><td><strong>é€‚ç”¨åœºæ™¯</strong></td><td>ä½å»¶è¿Ÿç³»ç»Ÿï¼Œå¦‚é‡‘èã€äº¤æ˜“ã€æ¨èç­‰å®æ—¶åº”ç”¨</td><td>é€šç”¨åå°ç³»ç»Ÿã€Web æœåŠ¡ç­‰</td><td>æ‰¹å¤„ç†ã€æ•°æ®è®¡ç®—ã€æ—¥å¿—åˆ†æç­‰ä¸æ•æ„Ÿäºåœé¡¿çš„ç³»ç»Ÿ</td></tr><tr><td><strong>é»˜è®¤å¯ç”¨</strong></td><td>å¦ï¼Œéœ€æŒ‡å®š <code>-XX:+UseZGC</code></td><td>JDK 9+ é»˜è®¤ GC</td><td>JDK 8 åŠä»¥å‰é»˜è®¤ GC</td></tr><tr><td><strong>è°ƒä¼˜å¤æ‚åº¦</strong></td><td>ä½ï¼Œå¤§å¤šæ•°å‚æ•°å¯çœç•¥</td><td>ä¸­ï¼Œéœ€è¦è®¾ç½®ç›®æ ‡åœé¡¿æ—¶é—´ç­‰</td><td>é«˜ï¼Œéœ€è¦ç²¾ç»†é…ç½® Eden/Survivor ç­‰æ¯”ä¾‹</td></tr><tr><td><strong>GC æ—¥å¿—é…ç½®æ–¹å¼</strong></td><td>ç»Ÿä¸€æ—¥å¿—æ ¼å¼ï¼š<code>-Xlog:gc*</code>ï¼ˆJDK 9+ï¼‰</td><td>æ”¯æŒä¼ ç»Ÿçš„ <code>-XX:+PrintGCDetails</code> å’Œ <code>-Xlog:gc*</code> æ—¥å¿—è¾“å‡º</td><td>ä¸»è¦ä½¿ç”¨æ—§å‚æ•°ï¼š<code>-XX:+PrintGCDetails</code> ç­‰</td></tr></tbody></table><div class="tips"><p><em><strong>ZGC ååèƒ½åŠ›è¾ƒå¼±çš„åŸå› </strong></em></p><table><thead><tr><th>åŸå› </th><th>è§£é‡Š</th></tr></thead><tbody><tr><td><strong>1. å¹¶å‘é˜¶æ®µä»£ä»·è¾ƒé«˜</strong></td><td>ZGC å‡ ä¹æ‰€æœ‰çš„ GC å·¥ä½œï¼ˆåŒ…æ‹¬æ ‡è®°ã€æ•´ç†ã€å¼•ç”¨å¤„ç†ã€è½¬ç§»å¯¹è±¡ï¼‰éƒ½åœ¨ä¸åº”ç”¨çº¿ç¨‹å¹¶å‘æ‰§è¡Œã€‚è™½ç„¶å‡å°‘äº†åœé¡¿ï¼Œä½†è¿™äº› GC çº¿ç¨‹ä¸ä¸šåŠ¡çº¿ç¨‹å…±äº« CPU èµ„æºï¼Œ<strong>å¢åŠ äº† CPU ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œç¼“å­˜ç«äº‰</strong>ï¼Œä»è€Œå½±å“ä¸šåŠ¡çº¿ç¨‹çš„æ‰§è¡Œæ•ˆç‡ã€‚</td></tr><tr><td><strong>2. è¯»å±éšœå¼€é”€</strong></td><td>ZGC ä¾èµ–<strong>ç€è‰²æŒ‡é’ˆå’Œè¯»å±éšœï¼ˆload barrierï¼‰æœºåˆ¶</strong>æ¥è·Ÿè¸ªå¯¹è±¡å¼•ç”¨çŠ¶æ€ï¼Œæ”¯æŒå¹¶å‘è½¬ç§»ã€‚è™½ç„¶éå¸¸é«˜æ•ˆï¼Œä½†ä»æ¯”ä¼ ç»Ÿ GC çš„æ™®é€šè¯»å†™è·¯å¾„æ…¢ä¸€äº›ï¼Œåœ¨é«˜é¢‘è®¿é—®å¯¹è±¡åœºæ™¯ä¸‹ä¼šå¸¦æ¥ä¸€å®š CPU å¼€é”€ã€‚</td></tr><tr><td><strong>3. å¯¹ç¡¬ä»¶ä¾èµ–é«˜ï¼Œè°ƒåº¦ä¿å®ˆ</strong></td><td>ä¸ºäº†å®ç°â€œ&lt;1ms åœé¡¿â€çš„ç›®æ ‡ï¼ŒZGC ä¼šé€‰æ‹©æ›´ä¿å®ˆçš„è°ƒåº¦ç­–ç•¥ï¼ˆå¦‚é¿å…å¹¶å‘çº¿ç¨‹ä½¿ç”¨è¿‡å¤š CPUï¼‰ï¼Œè€Œä¸ä¼šåƒ Parallel GC é‚£æ ·â€œæ¦¨å¹²â€æ‰€æœ‰æ ¸å¿ƒèµ„æºã€‚</td></tr><tr><td><strong>4. å†…å­˜å¼€é”€æ›´é«˜</strong></td><td>ä¸ºäº†æ”¯æŒå¹¶å‘å‹ç¼©å’Œè½¬ç§»ï¼ŒZGC é€šå¸¸éœ€è¦ä¸ºæ¯ä¸ªå¯¹è±¡ä¿ç•™å…ƒæ•°æ®å’Œæ›´å¤šçš„è½¬ç§»ç©ºé—´ï¼ˆå³â€œæµ®åŠ¨åƒåœ¾â€åŒºåŸŸï¼‰ï¼Œè¿™å¯èƒ½å¯¼è‡´<strong>é¢‘ç¹çš„ GC å‘¨æœŸ</strong>ï¼Œå½±å“ååã€‚</td></tr><tr><td><strong>5. è®¾è®¡ç›®æ ‡éååä¼˜å…ˆ</strong></td><td>ZGC çš„é¦–è¦ç›®æ ‡æ˜¯<strong>ä½å»¶è¿Ÿè€Œéæœ€å¤§åå</strong>ã€‚ä¸ Parallel GCï¼ˆä»¥ååä¸ºæ ¸å¿ƒï¼‰è®¾è®¡ç›®æ ‡ä¸åŒï¼ŒZGC æ›´é€‚åˆåœºæ™¯ä¸ºâ€œå¯¹å»¶è¿Ÿæ•æ„Ÿä½†ååå¯æ¥å—â€çš„ç³»ç»Ÿã€‚</td></tr></tbody></table><p>æœ€ç³Ÿç³•çš„æƒ…å†µä¸‹ååé‡ä¼šé™ä½15%ã€‚è¿™éƒ½ä¸æ˜¯äº‹ï¼Œåœé¡¿æ—¶é—´è¶³å¤Ÿä¼˜ç§€ã€‚è‡³äºååé‡ï¼Œé€šè¿‡æ‰©å®¹åˆ†åˆ†é’Ÿè§£å†³ã€‚<br>å¦å¤–ï¼ŒOracleå®˜æ–¹æåˆ°äº†å®ƒæœ€å¤§çš„ä¼˜ç‚¹æ˜¯ï¼šå®ƒçš„åœé¡¿æ—¶é—´ä¸ä¼šéšç€å †çš„å¢å¤§è€Œå¢é•¿ï¼<br>ä¹Ÿå°±æ˜¯è¯´ï¼Œå‡ åGå †çš„åœé¡¿æ—¶é—´æ˜¯10msä»¥ä¸‹ï¼Œå‡ ç™¾Gç”šè‡³ä¸ŠTå †çš„åœé¡¿æ—¶é—´ä¹Ÿæ˜¯10msä»¥ä¸‹ã€‚</p><p>ZGC ååå¼±ï¼Œä¸æ˜¯å› ä¸ºæŠ€æœ¯è½åï¼Œè€Œæ˜¯å› ä¸ºå®ƒä¸»åŠ¨é€‰æ‹©åœ¨ä½å»¶è¿Ÿå’Œé«˜ååä¹‹é—´åå‘äº†ä½å»¶è¿Ÿã€‚<br>åœ¨å¯¹å“åº”æ—¶é—´è¦æ±‚æé«˜çš„ç³»ç»Ÿä¸­ï¼Œå®ƒæ˜¯éå¸¸åˆé€‚çš„é€‰æ‹©ã€‚<br>ä½†å¦‚æœä½ çš„ç›®æ ‡æ˜¯å‹æ¦¨æœºå™¨æ€§èƒ½è·‘æ‰¹å¤„ç†ã€æ—¥å¿—åˆ†æè¿™ç±»ååå¯¼å‘å‹ä»»åŠ¡ï¼ŒParallel GC æˆ– G1 ä¼šæ›´åˆé€‚ã€‚</p></div><h2 id="å†…å­˜æº¢å‡º-OutOfMemoryErrorï¼Œç®€ç§°-OOM">å†…å­˜æº¢å‡º(OutOfMemoryErrorï¼Œç®€ç§° OOM)</h2><ul class="lvl-0"><li class="lvl-2"><p>JVM å¸¸è§å†…å­˜æº¢å‡ºç±»å‹æ±‡æ€»è¡¨</p></li></ul><table><thead><tr><th>æº¢å‡ºç±»å‹</th><th>å¼‚å¸¸ä¿¡æ¯</th><th>è§¦å‘åŸå› /æè¿°</th><th>ç›¸å…³å‚æ•°å’Œå»ºè®®é…ç½®</th></tr></thead><tbody><tr><td><strong>å †å†…å­˜æº¢å‡º</strong></td><td><code>java.lang.OutOfMemoryError: Java heap space</code></td><td>- åˆ›å»ºå¤§é‡å¯¹è±¡ï¼Œå †ç©ºé—´ä¸è¶³<br>- å†…å­˜æ³„æ¼ï¼šå¯¹è±¡ä¸å†ä½¿ç”¨å´æœ‰å¼ºå¼•ç”¨<br>- è€å¹´ä»£å¯¹è±¡å¤ªå¤šæ— æ³•æ™‹å‡</td><td><code>-Xms</code> / <code>-Xmx</code> è®¾ç½®å †å¤§å°</td></tr><tr><td><strong>æ ˆæº¢å‡ºï¼ˆé€’å½’ï¼‰</strong></td><td><code>java.lang.StackOverflowError</code></td><td>- æ–¹æ³•æ— é™é€’å½’æˆ–é€’å½’å±‚çº§å¤ªæ·±</td><td><code>-Xss</code> è®¾ç½®çº¿ç¨‹æ ˆå¤§å°</td></tr><tr><td><strong>æ— æ³•åˆ›å»ºæ–°çº¿ç¨‹</strong></td><td><code>java.lang.OutOfMemoryError: unable to create new native thread</code></td><td>- åˆ›å»ºçº¿ç¨‹è¿‡å¤šï¼ˆå¦‚çº¿ç¨‹æ± é…ç½®è¿‡å¤§ï¼‰<br>- ç³»ç»Ÿæˆ– JVM native çº¿ç¨‹èµ„æºè€—å°½</td><td>æ§åˆ¶çº¿ç¨‹æ± å¤§å°ï¼Œé¿å…æ— é™æ–°å»ºçº¿ç¨‹</td></tr><tr><td><strong>å…ƒç©ºé—´æº¢å‡º</strong></td><td><code>java.lang.OutOfMemoryError: Metaspace</code></td><td>- åŠ¨æ€åŠ è½½ç±»è¿‡å¤šï¼ˆå¦‚ä½¿ç”¨ CGLIBã€JSP åŠ¨æ€ç”Ÿæˆç±»ï¼‰<br>- ç±»æ— æ³•å¸è½½ï¼ˆå¦‚ ClassLoader æ³„æ¼ï¼‰</td><td><code>-XX:MetaspaceSize</code> / <code>-XX:MaxMetaspaceSize</code></td></tr><tr><td><strong>ç›´æ¥å†…å­˜æº¢å‡º</strong></td><td><code>java.lang.OutOfMemoryError: Direct buffer memory</code></td><td>- ä½¿ç”¨ <code>ByteBuffer.allocateDirect()</code> åˆ†é…å¤§é‡ç›´æ¥å†…å­˜<br>- Netty ç­‰æ¡†æ¶é»˜è®¤ä½¿ç”¨ç›´æ¥å†…å­˜</td><td><code>-XX:MaxDirectMemorySize</code></td></tr><tr><td><strong>GC å¼€é”€è¿‡é«˜</strong></td><td><code>java.lang.OutOfMemoryError: GC overhead limit exceeded</code></td><td>- JVM èŠ±è´¹ &gt;98% çš„æ—¶é—´ GC ä½†å›æ”¶ &lt;2% çš„å†…å­˜ï¼Œè®¤ä¸ºè¿›å…¥â€œGC æ­»å¾ªç¯â€</td><td>åˆ†æ GC æ—¥å¿—ã€ä¼˜åŒ–å †è®¾ç½®</td></tr><tr><td><strong>ç±»å¸è½½å¤±è´¥ï¼ˆå†…å­˜æ³„æ¼ï¼‰</strong></td><td>ï¼ˆä¸ä¸€å®šæŠ¥é”™ï¼Œä½†å¯èƒ½å¯¼è‡´ Metaspace OOMï¼‰</td><td>- Web å®¹å™¨é¢‘ç¹éƒ¨ç½²çƒ­æ›´æ–° WAR åŒ…æ—¶ï¼ŒClassLoader æ— æ³•å¸è½½ï¼Œå¯¼è‡´ç±»æ°¸ä¹…é©»ç•™</td><td>ä¼˜åŒ– ClassLoader ç®¡ç†ï¼Œä½¿ç”¨å†…å­˜åˆ†æå·¥å…·</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>å †å¿«ç…§(å †è½¬å‚¨)æ–‡ä»¶åˆ†æ</p></li></ul><table><thead><tr><th>å‚æ•°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>-XX:+HeapDumpOnOutOfMemoryError</code></td><td>OOM æ—¶ç”Ÿæˆå †è½¬å‚¨æ–‡ä»¶ ,å»ºè®®ç”Ÿäº§ç¯å¢ƒå¼€å¯</td></tr><tr><td><code>-XX:HeapDumpPath=xxx.hprof</code></td><td>æŒ‡å®šå †è½¬å‚¨æ–‡ä»¶ä¿å­˜è·¯å¾„ <br> é»˜è®¤ä¿å­˜åœ¨å½“å‰ç›®å½•</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>å¸¸ç”¨åˆ†æå·¥å…·ä¸å‘½ä»¤</p></li></ul><table><thead><tr><th>å·¥å…·/å‘½ä»¤</th><th>ç®€ä»‹ä¸åŠŸèƒ½</th><th>ä½¿ç”¨è¯´æ˜</th></tr></thead><tbody><tr><td><strong>MATï¼ˆMemory Analyzer Toolï¼‰</strong></td><td>Eclipse å‡ºå“çš„å¼ºå¤§å›¾å½¢å·¥å…·ï¼Œæ”¯æŒæ³„æ¼åˆ†æã€å¯¹è±¡å¼•ç”¨é“¾åˆ†æã€å†…å­˜å ç”¨ç»Ÿè®¡ç­‰</td><td>ä¸‹è½½åœ°å€ï¼š<br><a href="https://www.eclipse.org/mat/">https://www.eclipse.org/mat/</a><br>æ‰“å¼€åç›´æ¥å¯¼å…¥ <code>.hprof</code> æ–‡ä»¶å³å¯åˆ†æ</td></tr><tr><td><strong>VisualVM</strong></td><td>å®˜æ–¹å¯è§†åŒ– JVM ç›‘æ§å·¥å…·ï¼Œæ”¯æŒå®æ—¶åˆ†æã€GC æŸ¥çœ‹ã€çº¿ç¨‹çŠ¶æ€ä¸å †è½¬å‚¨æŸ¥çœ‹</td><td>é™„å¸¦äº JDKï¼ˆæˆ–å•ç‹¬å®‰è£…ï¼‰ï¼Œæ‰“å¼€ <code>.hprof</code> æ–‡ä»¶è¿›è¡Œå¯è§†åŒ–åˆ†æ</td></tr><tr><td><strong>JProfiler</strong></td><td>å•†ä¸šçº§ Java æ€§èƒ½åˆ†æå·¥å…·ï¼Œæä¾›å †åˆ†æã€CPU åˆ†æã€çº¿ç¨‹åˆ†æç­‰å…¨å¥—åŠŸèƒ½</td><td>æ”¯æŒæ‰“å¼€ <code>.hprof</code> æ–‡ä»¶ï¼Œä¹Ÿå¯åœ¨è¿è¡Œæ—¶é…åˆä½¿ç”¨ï¼ˆéœ€ä»˜è´¹æˆ–è¯•ç”¨ï¼‰</td></tr><tr><td><strong>YourKit</strong></td><td>å•†ä¸šæ€§èƒ½åˆ†æå·¥å…·ï¼Œç•Œé¢å‹å¥½ï¼Œæ”¯æŒä¸°å¯Œçš„åˆ†æåŠŸèƒ½</td><td>æ”¯æŒå †åˆ†æï¼Œé€‚åˆå†…å­˜æ³„æ¼æ’æŸ¥</td></tr><tr><td><strong>jhat</strong>ï¼ˆè¿‡æ—¶ï¼‰</td><td>JDK é™„å¸¦çš„æ—§å·¥å…·ï¼Œç”¨äºåˆ†æ <code>.hprof</code> æ–‡ä»¶ï¼Œå¼€å¯ Web ç•Œé¢æŸ¥çœ‹ï¼ˆå·²åºŸå¼ƒï¼‰</td><td>å‘½ä»¤ï¼š<code>jhat heapdump.hprof</code>ï¼Œæµè§ˆå™¨è®¿é—® <code>http://localhost:7000</code>ï¼ˆJDK 8 åŠä»¥ä¸‹ï¼‰</td></tr><tr><td><strong>jmap</strong></td><td>ç”¨äºç”Ÿæˆå †è½¬å‚¨æ–‡ä»¶æˆ–æŸ¥çœ‹å †å¯¹è±¡ç»Ÿè®¡ä¿¡æ¯ï¼ˆ<strong>ä¸æ˜¯åˆ†æå·¥å…·æœ¬èº«</strong>ï¼‰</td><td>å‘½ä»¤ï¼š<code>jmap -dump:format=b,file=heap.hprof &lt;pid&gt;</code> ç”Ÿæˆè½¬å‚¨ï¼›é…åˆ MAT ä½¿ç”¨</td></tr><tr><td><strong>jcmd</strong></td><td>æ›´ç°ä»£çš„è¯Šæ–­å‘½ä»¤å·¥å…·ï¼Œå¯ç”Ÿæˆ heap dumpã€æ‰§è¡Œ GCã€æ‰“å° VM çŠ¶æ€ç­‰</td><td>å‘½ä»¤ï¼š<code>jcmd &lt;pid&gt; GC.heap_dump heap.hprof</code></td></tr><tr><td><strong><a href="http://GCEasy.io">GCEasy.io</a></strong></td><td>åœ¨çº¿åˆ†æå·¥å…·ï¼Œæ”¯æŒ <code>.hprof</code> æ–‡ä»¶å’Œ GC æ—¥å¿—ä¸Šä¼ åˆ†æ</td><td>ç½‘ç«™ï¼š<a href="https://gceasy.io">https://gceasy.io</a></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>GCæ—¥å¿—ç›¸å…³å‚æ•°(JDK1.8åŠä»¥ä¸‹)</p></li></ul><table><thead><tr><th>å‚æ•°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>-XX:+PrintGC</code></td><td>æ‰“å°åŸºæœ¬ GC ä¿¡æ¯ï¼ˆå»ºè®®é…åˆ <code>-XX:+PrintGCDetails</code> ä½¿ç”¨ï¼‰,ä¸<code>-verbose:gc</code>ç­‰ä»·</td></tr><tr><td><code>-XX:+PrintGCDetails</code></td><td>æ‰“å°è¯¦ç»†çš„ GC æ—¥å¿—ä¿¡æ¯ï¼ˆå¦‚å„åŒºåŸŸä½¿ç”¨æƒ…å†µã€å¯¹è±¡åˆ†é…ã€æ™‹å‡ç­‰ï¼‰</td></tr><tr><td><code>-XX:+PrintGCDateStamps</code></td><td>åœ¨ GC æ—¥å¿—ä¸­æ·»åŠ æ—¥æœŸæ—¶é—´æˆ³</td></tr><tr><td><code>-XX:+PrintGCTimeStamps</code></td><td>åœ¨ GC æ—¥å¿—ä¸­æ·»åŠ  JVM å¯åŠ¨ä»¥æ¥çš„æ—¶é—´æˆ³</td></tr><tr><td><code>-Xloggc:/var/log/myapp/gc.log</code></td><td>å°† GC æ—¥å¿—è¾“å‡ºåˆ°æŒ‡å®šæ–‡ä»¶</td></tr><tr><td><code>-XX:+UseGCLogFileRotation</code></td><td>å¯ç”¨ GC æ—¥å¿—æ–‡ä»¶è½®è½¬ï¼ˆé€‚ç”¨äºå¤§è§„æ¨¡ç³»ç»Ÿçš„ GC æ—¥å¿—ç®¡ç†ï¼‰</td></tr><tr><td><code>-XX:NumberOfGCLogFiles=5</code></td><td>æœ€å¤šä¿ç•™ 5 ä¸ª GC æ—¥å¿—å†å²æ–‡ä»¶</td></tr><tr><td><code>-XX:GCLogFileSize=10M</code></td><td>æ¯ä¸ª GC æ—¥å¿—æ–‡ä»¶æœ€å¤§ä¸º 10MB</td></tr><tr><td><code>-XX:+PrintGCCause</code></td><td>æ‰“å° GC çš„è§¦å‘åŸå› ï¼ˆå¦‚ Minor GCã€System.gc() ç­‰ï¼‰</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>GCæ—¥å¿—ç›¸å…³å‚æ•°(JDK9+)</p><ul class="lvl-2"><li class="lvl-6"><code>-Xlog</code> æ˜¯ç”¨äºé…ç½® JVM æ—¥å¿—è®°å½•çš„å‚æ•°ï¼Œå®ƒæ˜¯ä» JDK 9 å¼€å§‹å¼•å…¥çš„ç»Ÿä¸€æ—¥å¿—æ¡†æ¶ï¼ˆUnified Loggingï¼‰çš„ä¸€éƒ¨åˆ†ã€‚</li><li class="lvl-6">é€šè¿‡ -Xlog é€‰é¡¹ï¼Œä½ å¯ä»¥æ§åˆ¶æ—¥å¿—çš„ æ ‡ç­¾ï¼ˆtagsï¼‰ã€è¾“å‡ºçº§åˆ«ï¼ˆlevelï¼‰ã€è¾“å‡ºä½ç½®ï¼ˆoutputï¼‰ ç­‰å†…å®¹ã€‚</li><li class="lvl-6">åŸºæœ¬æ ¼å¼</li></ul>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xlog[:[tag1[,tag2...]][[:level][:[output][:[decorators][:rotation]]]]]</span><br></pre></td></tr></table></figure><ul class="lvl-2"><li class="lvl-6">å¸¸è§ Tagsï¼ˆæ ‡ç­¾ï¼‰</li></ul><table><thead><tr><th>ç±»åˆ«</th><th>æ ‡ç­¾</th><th>å«ä¹‰</th><th>ç”¨é€”ç¤ºä¾‹</th></tr></thead><tbody><tr><td><strong>ç±»åŠ è½½</strong></td><td><code>classload</code></td><td>JVM ç±»åŠ è½½æ´»åŠ¨çš„æ€»ä½“ä¿¡æ¯</td><td>è§‚å¯Ÿç±»åŠ è½½å¤±è´¥æˆ–é‡å¤åŠ è½½</td></tr><tr><td></td><td><code>class+load</code></td><td>æ˜¾ç¤ºæ¯ä¸ªç±»åŠ è½½è¿‡ç¨‹ç»†èŠ‚</td><td>å®šä½ç±»åŠ è½½å¼‚å¸¸ã€çƒ­åŠ è½½åˆ†æ</td></tr><tr><td></td><td><code>class+unload</code></td><td>è®°å½•ç±»å¸è½½äº‹ä»¶</td><td>åˆ†æç±»å¸è½½æ—¶æœºæˆ–å†…å­˜é‡Šæ”¾æƒ…å†µ</td></tr><tr><td><strong>åƒåœ¾å›æ”¶</strong></td><td><code>gc</code></td><td>æ€»ä½“ GC æ´»åŠ¨ä¿¡æ¯</td><td>GC è°ƒä¼˜å…¥é—¨ä½¿ç”¨</td></tr><tr><td></td><td><code>gc+start</code></td><td>GC äº‹ä»¶å¼€å§‹æ—¶é—´ä¸ç±»å‹</td><td>æŸ¥çœ‹ GC é¢‘ç‡ä¸è§¦å‘ç‚¹</td></tr><tr><td></td><td><code>gc+heap</code></td><td>GC å‰åçš„å †ä½¿ç”¨æƒ…å†µ</td><td>åˆ†æå †ä½¿ç”¨ä¸åˆ†åŒºå æ¯”</td></tr><tr><td></td><td><code>gc+phases</code></td><td>GC å†…éƒ¨é˜¶æ®µç»†èŠ‚</td><td>G1/ZGC ç­‰è°ƒè¯•ç”¨</td></tr><tr><td></td><td><code>gc+age</code></td><td>å¹´é¾„åˆ†å¸ƒæƒ…å†µ</td><td>åˆ¤æ–­å¯¹è±¡æ™‹å‡è·¯å¾„ã€è€å¹´ä»£å‹åŠ›</td></tr><tr><td></td><td><code>gc+ergo</code></td><td>GC çš„è‡ªé€‚åº”è°ƒæ•´å†³ç­–</td><td>æŸ¥çœ‹çº¿ç¨‹ã€å †å¤§å°è‡ªåŠ¨è°ƒæ•´é€»è¾‘</td></tr><tr><td><strong>JIT ç¼–è¯‘</strong></td><td><code>jit</code></td><td>JIT ç¼–è¯‘æ—¥å¿—å…¥å£</td><td>æ€§èƒ½çƒ­ç‚¹æ–¹æ³•åˆ†æ</td></tr><tr><td></td><td><code>compiler</code></td><td>æ˜¾ç¤ºæ–¹æ³•ç¼–è¯‘ã€æ—¶é—´ç­‰</td><td>åˆ¤æ–­æ˜¯å¦æœ‰æ–¹æ³•æœªè¢«ä¼˜åŒ–</td></tr><tr><td></td><td><code>codecache</code></td><td>å·²ç¼–è¯‘ä»£ç å­˜å‚¨åŒºä½¿ç”¨æƒ…å†µ</td><td>åˆ¤æ–­æ˜¯å¦è¾¾åˆ°ç¼“å­˜ä¸Šé™</td></tr><tr><td></td><td><code>nmethod</code></td><td>JIT ç”Ÿæˆçš„ native æ–¹æ³•ç”Ÿå‘½å‘¨æœŸ</td><td>è§‚å¯Ÿ native ä»£ç ç”Ÿæˆä¸å¸è½½</td></tr><tr><td><strong>å†…å­˜</strong></td><td><code>memory</code></td><td>æ€»ä½“å†…å­˜ä½¿ç”¨æƒ…å†µ</td><td>è¯Šæ–­å†…å­˜æ³„æ¼æˆ–æº¢å‡º</td></tr><tr><td></td><td><code>gc+heap</code></td><td>å †ç»“æ„ä¸å ç”¨æƒ…å†µ</td><td>ä¸ GC è”åˆåˆ†æä½¿ç”¨</td></tr><tr><td></td><td><code>os+memory</code></td><td>JVM ä¸æ“ä½œç³»ç»Ÿé—´çš„å†…å­˜äº¤äº’</td><td>åˆ¤æ–­æ˜¯å¦ç³»ç»Ÿå±‚å†…å­˜ç”³è¯·å¤±è´¥</td></tr><tr><td><strong>çº¿ç¨‹</strong></td><td><code>thread</code></td><td>çº¿ç¨‹çš„åˆ›å»ºã€ç»ˆæ­¢ã€çŠ¶æ€å˜åŒ–</td><td>çº¿ç¨‹æ³„æ¼æˆ–é¢‘ç¹åˆ›å»ºæ’æŸ¥</td></tr><tr><td></td><td><code>safepoint</code></td><td>JVM è¿›å…¥/é€€å‡º safepoint çš„ä¿¡æ¯</td><td>åˆ†æ STW åœé¡¿æ—¶é—´ä¸é¢‘ç‡</td></tr><tr><td><strong>é”ä¸åŒæ­¥</strong></td><td><code>synchronization</code></td><td>é”ç«äº‰ã€è·å–å’Œé‡Šæ”¾ä¿¡æ¯</td><td>åˆ†ææ€§èƒ½ç“¶é¢ˆä¸­çš„é”äº‰ç”¨</td></tr><tr><td></td><td><code>monitorinflation</code></td><td>è½»é‡çº§é”å‡çº§ä¸ºé‡é‡çº§é”è¿‡ç¨‹</td><td>æ’æŸ¥é”è†¨èƒ€å¯¼è‡´çš„å»¶è¿Ÿé—®é¢˜</td></tr><tr><td><strong>æ“ä½œç³»ç»Ÿäº¤äº’</strong></td><td><code>os</code></td><td>JVM ä¸æ“ä½œç³»ç»Ÿäº¤äº’æ—¥å¿—</td><td>å¸¸è§„ç³»ç»Ÿèµ„æºè¯·æ±‚ä¿¡æ¯</td></tr><tr><td></td><td><code>os+thread</code></td><td>OS å±‚çº§çº¿ç¨‹ç®¡ç†ä¿¡æ¯</td><td>é«˜å¹¶å‘æ—¶çº¿ç¨‹ç»‘å®šä¸è°ƒåº¦åˆ†æ</td></tr><tr><td></td><td><code>os+cpu</code></td><td>CPU ä½¿ç”¨ä¸åˆ†å¸ƒæƒ…å†µ</td><td>æ’æŸ¥é«˜ CPU ä½¿ç”¨çš„é—®é¢˜</td></tr><tr><td><strong>ç±»å…ƒæ•°æ®</strong></td><td><code>metaspace</code></td><td>å…ƒç©ºé—´å†…å­˜ä½¿ç”¨ä¸å˜åŒ–</td><td>æ’æŸ¥ Metaspace OOM</td></tr><tr><td></td><td><code>cds</code></td><td>ç±»å…±äº«æ•°æ®ï¼ˆCDSï¼‰æ—¥å¿—</td><td>åˆ†æç±»åŠ è½½åŠ é€Ÿæ˜¯å¦ç”Ÿæ•ˆ</td></tr><tr><td><strong>å®‰å…¨</strong></td><td><code>security</code></td><td>å®‰å…¨ç›¸å…³æ“ä½œæ—¥å¿—</td><td>æƒé™æ£€æŸ¥å¤±è´¥ã€å¯†é’¥åŠ è½½ç­‰è°ƒè¯•</td></tr><tr><td></td><td><code>module</code></td><td>æ¨¡å—ç³»ç»Ÿï¼ˆJPMSï¼‰ç›¸å…³æ—¥å¿—</td><td>æ¨¡å—è®¿é—®æ§åˆ¶å¤±è´¥åˆ†æ</td></tr><tr><td><strong>å…¶ä»–</strong></td><td><code>start</code></td><td>JVM å¯åŠ¨æµç¨‹æ—¥å¿—</td><td>å¯åŠ¨é˜¶æ®µæ…¢ã€å‡ºé”™æ—¶ä½¿ç”¨</td></tr><tr><td></td><td><code>init</code></td><td>å„å­ç³»ç»Ÿåˆå§‹åŒ–è¿‡ç¨‹</td><td>å®šä½å­ç³»ç»Ÿå¯åŠ¨é¡ºåºä¸å¼‚å¸¸</td></tr><tr><td></td><td><code>jni</code></td><td>Java è°ƒç”¨ native æ–¹æ³•æ—¥å¿—</td><td>JNI å´©æºƒã€æ€§èƒ½é—®é¢˜åˆ†æ</td></tr><tr><td></td><td><code>classpath</code></td><td>ç±»è·¯å¾„åŠ è½½è¯¦æƒ…</td><td>ç±»æ‰¾ä¸åˆ°ã€è·¯å¾„å†²çªç­‰é—®é¢˜æ’æŸ¥</td></tr><tr><td></td><td><code>exceptions</code></td><td>å¼‚å¸¸ä¿¡æ¯åŠå †æ ˆæ‰“å°</td><td>æ•è·æœªå¤„ç†å¼‚å¸¸ã€é¢‘ç¹æŠ›é”™åˆ†æ</td></tr></tbody></table><ul class="lvl-2"><li class="lvl-6"><p>Levelï¼ˆçº§åˆ«ï¼‰</p></li></ul><table><thead><tr><th>ç­‰çº§</th><th>å«ä¹‰è¯´æ˜</th><th>ç”¨é€”ç¤ºä¾‹</th></tr></thead><tbody><tr><td><code>off</code></td><td>å…³é—­æ—¥å¿—è®°å½•</td><td>å®Œå…¨ç¦ç”¨æŒ‡å®šæ ‡ç­¾çš„æ—¥å¿—è¾“å‡º</td></tr><tr><td><code>error</code></td><td>ä¸¥é‡é”™è¯¯ï¼Œä»…è®°å½•å½±å“ç³»ç»Ÿè¿è¡Œçš„é”™è¯¯ä¿¡æ¯</td><td>æ•è·å´©æºƒã€ä¸¥é‡æ•…éšœ</td></tr><tr><td><code>warning</code></td><td>æ½œåœ¨é—®é¢˜ï¼Œå¯èƒ½å½±å“ç¨³å®šæ€§</td><td>è®°å½•å¯èƒ½çš„å†…å­˜ã€é…ç½®é—®é¢˜</td></tr><tr><td><code>info</code></td><td>å¸¸è§„ä¿¡æ¯ï¼ˆé»˜è®¤çº§åˆ«ï¼‰</td><td>æ—¥å¸¸è¿è¡Œæ—¥å¿—ï¼Œå¦‚ GC æ¬¡æ•°</td></tr><tr><td><code>debug</code></td><td>æ›´è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼Œé€‚ç”¨äºé—®é¢˜è¯Šæ–­</td><td>è·Ÿè¸ªè¡Œä¸ºå˜åŒ–æˆ–ä»£ç è·¯å¾„</td></tr><tr><td><code>trace</code></td><td>æœ€è¯¦ç»†çš„ä¿¡æ¯ï¼Œè®°å½•å‡ ä¹æ‰€æœ‰ç»†èŠ‚</td><td>æ·±åº¦è°ƒè¯•ï¼Œå¦‚æ–¹æ³•çº§åˆ«è·Ÿè¸ª</td></tr><tr><td><code>all</code></td><td>æ‰“å°æ‰€æœ‰çº§åˆ«çš„æ—¥å¿—ï¼ˆåŒ…æ‹¬ trace åŠä»¥ä¸Šï¼‰</td><td>å…¨é‡æ—¥å¿—è¾“å‡ºï¼Œç”¨äºå®Œå…¨ç›‘æ§</td></tr></tbody></table><ul class="lvl-2"><li class="lvl-6"><p>Outputï¼ˆè¾“å‡ºä½ç½®ï¼‰</p></li></ul><table><thead><tr><th>è¾“å‡ºä½ç½®</th><th>å«ä¹‰è¯´æ˜</th><th>ç¤ºä¾‹ç”¨æ³•</th></tr></thead><tbody><tr><td><code>stdout</code></td><td>æ ‡å‡†è¾“å‡ºï¼ˆé»˜è®¤ï¼‰</td><td><code>-Xlog:gc=info:stdout</code></td></tr><tr><td><code>stderr</code></td><td>æ ‡å‡†é”™è¯¯è¾“å‡º</td><td><code>-Xlog:gc=info:stderr</code></td></tr><tr><td><code>file=è·¯å¾„</code></td><td>è¾“å‡ºåˆ°æŒ‡å®šæ–‡ä»¶è·¯å¾„ï¼ˆè‡ªåŠ¨åˆ›å»ºæ–‡ä»¶ï¼‰</td><td><code>-Xlog:gc:file=gc.log</code></td></tr><tr><td>å¤šä¸ªè¾“å‡ºç”¨é€—å·åˆ†éš”</td><td>å¯åŒæ—¶è¾“å‡ºåˆ°å¤šä¸ªä½ç½®</td><td><code>-Xlog:gc:file=gc.log,stdout</code></td></tr></tbody></table><ul class="lvl-2"><li class="lvl-6"><p>Decoratorsï¼ˆè£…é¥°å™¨ï¼‰</p></li></ul><table><thead><tr><th>è£…é¥°å™¨</th><th>å«ä¹‰è¯´æ˜</th><th>ç¤ºä¾‹è¾“å‡ºç‰‡æ®µï¼ˆå«è¯¥è£…é¥°å™¨æ—¶ï¼‰</th></tr></thead><tbody><tr><td><code>time</code></td><td>æ˜¾ç¤ºå½“å‰ç³»ç»Ÿæ—¶é—´ï¼ˆwall-clock timeï¼‰</td><td><code>2025-05-16T10:45:12.123+0800</code></td></tr><tr><td><code>uptime</code></td><td>æ˜¾ç¤º JVM å¯åŠ¨ä»¥æ¥çš„è¿è¡Œæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</td><td><code>5.123s</code>ï¼ˆè¡¨ç¤ºå·²è¿è¡Œ 5.123 ç§’ï¼‰</td></tr><tr><td><code>level</code></td><td>æ˜¾ç¤ºæ—¥å¿—çº§åˆ«ï¼ˆå¦‚ info, warning ç­‰ï¼‰</td><td><code>[info]</code>, <code>[debug]</code></td></tr><tr><td><code>tags</code></td><td>æ˜¾ç¤ºæ—¥å¿—æ ‡ç­¾</td><td><code>[gc]</code>, <code>[class,load]</code></td></tr><tr><td><code>tid</code></td><td>æ˜¾ç¤ºçº¿ç¨‹ ID</td><td><code>tid=0x00007fddc4012800</code></td></tr><tr><td><code>hostname</code></td><td>æ˜¾ç¤ºä¸»æœºå</td><td><code>host=example.local</code></td></tr><tr><td><code>pid</code></td><td>æ˜¾ç¤ºå½“å‰ JVM è¿›ç¨‹ ID</td><td><code>pid=12345</code></td></tr></tbody></table><ul class="lvl-2"><li class="lvl-6"><p>Rotation (æ—¥å¿—è½®è½¬è®¾ç½®)</p></li></ul><table><thead><tr><th>è®¾ç½®å‚æ•°</th><th>å«ä¹‰è¯´æ˜</th><th>ç¤ºä¾‹å€¼</th></tr></thead><tbody><tr><td><code>filecount=n</code></td><td>ä¿ç•™çš„æ—¥å¿—æ–‡ä»¶æ•°é‡ï¼ˆæœ€å¤§æ–‡ä»¶è½®è½¬æ•°ï¼‰</td><td><code>filecount=5</code></td></tr><tr><td><code>filesize=n</code></td><td>å•ä¸ªæ—¥å¿—æ–‡ä»¶çš„æœ€å¤§å¤§å°ï¼ˆæ”¯æŒå•ä½ï¼šk/m/gï¼‰</td><td><code>filesize=10m</code></td></tr></tbody></table><ul class="lvl-2"><li class="lvl-6"><p>ç¤ºä¾‹ï¼š</p></li></ul>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xlog:gc*:file=/var/log/app/gc.log:time,<span class="built_in">uptime</span>,level,tags:filecount=5,filesize=20M</span><br></pre></td></tr></table></figure><table><thead><tr><th>é¡¹</th><th>å€¼</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td><code>tag</code></td><td><code>gc*</code></td><td>åŒ¹é…æ‰€æœ‰ä»¥ <code>gc</code> å¼€å¤´çš„æ ‡ç­¾ï¼ˆå¦‚ <code>gc+heap</code> ç­‰ï¼‰</td></tr><tr><td><code>level</code></td><td><em>çœç•¥</em></td><td>é»˜è®¤æ˜¯ <code>info</code></td></tr><tr><td><code>output</code></td><td><code>file=/var/log/app/gc.log</code></td><td>æ—¥å¿—å†™å…¥è¯¥æ–‡ä»¶</td></tr><tr><td><code>decorators</code></td><td><code>time,uptime,level,tags</code></td><td>æ—¥å¿—å‰ç¼€åŒ…å«æ—¶é—´ã€å¯åŠ¨æ—¶é—´ã€æ—¥å¿—çº§åˆ«ã€æ ‡ç­¾</td></tr><tr><td><code>rotation</code></td><td><code>filecount=5,filesize=20M</code></td><td>æœ€å¤šä¿ç•™ 5 ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œå•ä¸ªæ–‡ä»¶æœ€å¤§ 20MB</td></tr></tbody></table><ul class="lvl-2"><li class="lvl-6"><p>æ—¥å¿—æ–‡ä»¶ä¸­å¯ä»¥ä½¿ç”¨å˜é‡</p></li></ul>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xlog:gc*:file=gc_%p_%t.log</span><br></pre></td></tr></table></figure><p><strong>å¸¸ç”¨å˜é‡è¡¨</strong></p><table><thead><tr><th>å˜é‡</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>%p</td><td>è¿›ç¨‹IDï¼ˆProcess IDï¼‰</td></tr><tr><td>%t</td><td>æ—¶é—´æˆ³ï¼ˆä»£è¡¨æ—¥å¿—æ–‡ä»¶åˆ›å»ºæ—¶çš„æ—¶é—´æˆ³ï¼‰</td></tr><tr><td>%h</td><td>ä¸»æœºåï¼ˆHostnameï¼‰</td></tr><tr><td>%n</td><td>åºåˆ—å·ï¼Œä»0å¼€å§‹ï¼Œæ¯åˆ›å»ºæ–°æ–‡ä»¶åŠ 1</td></tr><tr><td>%u</td><td>å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºè§£å†³æ–‡ä»¶åå†²çª</td></tr><tr><td>%i</td><td>å½“å¤šä¸ªJVMè¿›ç¨‹ä½¿ç”¨ç›¸åŒçš„æ–‡ä»¶åæ¨¡å¼æ—¶çš„åŒºåˆ†è®¡æ•°å™¨</td></tr></tbody></table><p><strong>æ—¶é—´ç›¸å…³å˜é‡è¡¨</strong></p><table><thead><tr><th>å˜é‡</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>%Y</td><td>å¹´ï¼ˆYearï¼‰</td></tr><tr><td>%m</td><td>æœˆï¼ˆMonthï¼‰</td></tr><tr><td>%d</td><td>æ—¥ï¼ˆDayï¼‰</td></tr><tr><td>%H</td><td>å°æ—¶ï¼ˆHourï¼‰</td></tr><tr><td>%M</td><td>åˆ†é’Ÿï¼ˆMinuteï¼‰</td></tr><tr><td>%S</td><td>ç§’ï¼ˆSecondï¼‰</td></tr></tbody></table>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŸºç¡€é…ç½®</span></span><br><span class="line">-Xlog:gc*:file=gc_%p_%Y%m%d_%H%M%S.<span class="built_in">log</span>:time,<span class="built_in">uptime</span>,level,tags:filecount=5,filesize=20M</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯¦ç»†GCæ—¥å¿—é…ç½®</span></span><br><span class="line">-Xlog:gc*=debug:file=gc_%p_%t.log:time,<span class="built_in">uptime</span>,level,tags:filecount=10,filesize=50M</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤šç›®æ ‡è¾“å‡º</span></span><br><span class="line">-Xlog:gc*=info:file=gc.log::filecount=5,filesize=20M -Xlog:gc*=debug:file=gc_detailed.log</span><br></pre></td></tr></table></figure></li><li class="lvl-2"><p>å¯¹äºGCæ—¥å¿—çš„åˆ†æ<br>äººå·¥åˆ†æè¿˜æ˜¯å¤ªå¤æ‚äº†ï¼Œå¯ä»¥ä½¿ç”¨<a href="https://gceasy.io">GCEasy.io</a>ï¼Œæ¯ä¸ªæœˆå…è´¹5æ¬¡ã€‚</p></li></ul>]]></content>
    
    
    <summary type="html">&lt;!--
 **åŠ ç²—**
 *æ–œä½“*
 ***åŠ ç²—å¹¶æ–œä½“***
 ~~åˆ é™¤çº¿~~
 ==çªå‡ºæ˜¾ç¤º==
 `çªå‡ºæ˜¾ç¤º(æ¨è)`
 ++ä¸‹åˆ’çº¿++
 ~ä¸‹æ ‡~
 ^ä¸Šæ ‡^
 è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.
 å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **ç‚¹å‡»æŠ˜å **
 è¿™æ˜¯è¢«éšè—çš„å†…å®¹
 +++

::: tips success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
:::

% note info % success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
% endnote %

å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}
 å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ
 --&gt;
&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;æœ¬æ–‡ä»‹ç»JVMçš„å†…å­˜æ¨¡å‹ä¸åƒåœ¾å›æ”¶æœºåˆ¶&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.oracle.com/javase/specs/jvms/se8/html/index.html&quot;&gt;JDK8 The JavaÂ® Virtual Machine Specification&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html&quot;&gt;JDK8çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.oracle.com/en/java/javase/17/docs/specs/man/index.html&quot;&gt;JDKâ¼¯å…·å®˜â½¹â½‚æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.oracle.com/en/java/javase/17/docs/specs/man/java.html&quot;&gt;JDK17çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="jvm" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/jvm/"/>
    
    
    <category term="jvm" scheme="https://blog.hanqunfeng.com/tags/jvm/"/>
    
  </entry>
  
  <entry>
    <title>JVM ä¹‹ ç±»åŠ è½½å™¨</title>
    <link href="https://blog.hanqunfeng.com/2025/05/08/jvm-classloader-01/"/>
    <id>https://blog.hanqunfeng.com/2025/05/08/jvm-classloader-01/</id>
    <published>2025-05-08T13:30:05.000Z</published>
    <updated>2025-05-16T14:31:24.513Z</updated>
    
    <content type="html"><![CDATA[<!-- **åŠ ç²—** *æ–œä½“* ***åŠ ç²—å¹¶æ–œä½“*** ~~åˆ é™¤çº¿~~ ==çªå‡ºæ˜¾ç¤º== `çªå‡ºæ˜¾ç¤º(æ¨è)` ++ä¸‹åˆ’çº¿++ ~ä¸‹æ ‡~ ^ä¸Šæ ‡^ è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference. å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **ç‚¹å‡»æŠ˜å ** è¿™æ˜¯è¢«éšè—çš„å†…å®¹ +++::: tips success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹:::% note info % success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹% endnote %å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{} å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ --><h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2"><p>æœ¬æ–‡ä»‹ç»JVMçš„ç±»åŠ è½½å™¨</p></li><li class="lvl-2"><p><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/index.html">JDK8 The JavaÂ® Virtual Machine Specification</a></p></li><li class="lvl-2"><p><a href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html">JDK8çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£</a></p></li><li class="lvl-2"><p><a href="https://docs.oracle.com/en/java/javase/17/docs/specs/man/index.html">JDKâ¼¯å…·å®˜â½¹â½‚æ¡£</a></p></li><li class="lvl-2"><p><a href="https://docs.oracle.com/en/java/javase/17/docs/specs/man/java.html">JDK17çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£</a></p></li></ul><span id="more"></span><h2 id="ç±»åŠ è½½å™¨">ç±»åŠ è½½å™¨</h2><p><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/weBeGe.png" alt="" width="1200" height="400"></p><ul class="lvl-0"><li class="lvl-2"><p>å·¦ä¾§æ˜¯JDKä¸­å®ç°çš„ç±»åŠ è½½å™¨ï¼Œé€šè¿‡<code>parent</code>å±æ€§å½¢æˆâ½—â¼¦å…³ç³»ã€‚åº”â½¤ä¸­â¾ƒå®šä¹‰çš„ç±»åŠ è½½å™¨çš„<code>parent</code>éƒ½æ˜¯<br><code>AppClassLoader</code></p></li><li class="lvl-2"><p>å³ä¾§æ˜¯JDKä¸­çš„ç±»åŠ è½½å™¨å®ç°ç±»ã€‚é€šè¿‡ç±»ç»§æ‰¿çš„æœºåˆ¶å½¢æˆä½“ç³»ã€‚æœªæ¥æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ç»§æ‰¿ç›¸å…³çš„ç±»å®ç°â¾ƒå®šä¹‰ç±»<br>åŠ è½½å™¨ã€‚</p></li><li class="lvl-2"><p>åœ¨ä»£ç ä¸­æŸ¥çœ‹ç±»åŠ è½½å™¨å…³ç³»</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoaderDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">// â½—â¼¦å…³ç³» AppClassLoader &lt;- ExtClassLoader &lt;- BootStrap Classloader</span></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">cl1</span> <span class="operator">=</span> LoaderDemo.class.getClassLoader();</span><br><span class="line">        System.out.println(<span class="string">&quot;cl1 &gt; &quot;</span> + cl1); <span class="comment">// sun.misc.Launcher$AppClassLoader@18b4aac2</span></span><br><span class="line">        System.out.println(<span class="string">&quot;parent of cl1 &gt; &quot;</span> + cl1.getParent()); <span class="comment">// sun.misc.Launcher$ExtClassLoader@1b6d3586</span></span><br><span class="line">        <span class="comment">// BootStrap Classloaderç”±C++å¼€å‘ï¼Œæ˜¯JVMè™šæ‹Ÿæœºçš„â¼€éƒ¨åˆ†ï¼Œæœ¬èº«ä¸æ˜¯JAVAç±»ã€‚</span></span><br><span class="line">        System.out.println(<span class="string">&quot;grant parent of cl1 &gt; &quot;</span> + cl1.getParent().getParent()); <span class="comment">// null</span></span><br><span class="line">        <span class="comment">// String,Intç­‰åŸºç¡€ç±»ç”±BootStrap ClassloaderåŠ è½½ã€‚</span></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">cl2</span> <span class="operator">=</span> String.class.getClassLoader();</span><br><span class="line">        System.out.println(<span class="string">&quot;cl2 &gt; &quot;</span> + cl2); <span class="comment">// null</span></span><br><span class="line">        System.out.println(cl1.loadClass(<span class="string">&quot;java.util.List&quot;</span>).getClass().getClassLoader()); <span class="comment">// null</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åŒäº²å§”æ´¾æœºåˆ¶">åŒäº²å§”æ´¾æœºåˆ¶</h2><ul class="lvl-0"><li class="lvl-2"><p>å½“â¼€ä¸ªç±»åŠ è½½å™¨è¦åŠ è½½â¼€ä¸ªç±»æ—¶ï¼Œæ•´ä½“çš„è¿‡ç¨‹å°±æ˜¯é€šè¿‡åŒäº²å§”æ´¾æœºåˆ¶å‘ä¸Šå§”æ‰˜æŸ¥æ‰¾ï¼Œå¦‚æœæ²¡æœ‰æŸ¥æ‰¾åˆ°ï¼Œå°±å‘ä¸‹å§”æ‰˜åŠ è½½ã€‚</p></li><li class="lvl-2"><p>Java ç±»åŠ è½½æœºåˆ¶ä¸­çš„<code>åŒäº²å§”æ´¾æ¨¡å‹ï¼ˆParent Delegation Modelï¼‰</code>æ˜¯ä¸€ç§ä¿è¯äº†ç±»åŠ è½½å™¨æŒ‰ç…§å±‚æ¬¡ç»“æ„ä»ä¸Šåˆ°ä¸‹æ¥åŠ è½½ç±»çš„ç­–ç•¥ã€‚è¿™ç§å±‚çº§åŒ–çš„åŠ è½½æµç¨‹ç¡®ä¿äº†åº”ç”¨ç¨‹åºèƒ½å¤Ÿå®‰å…¨åœ°åŠ è½½å¹¶ä½¿ç”¨æ¥è‡ªä¸åŒæ¥æºçš„ç±»ï¼ŒåŒæ—¶ä¹Ÿé¿å…äº†å†…å­˜ä¸­å‡ºç°ç›¸åŒç±»çš„å¤šä¸ªæ‹·è´ã€‚</p></li><li class="lvl-2"><p>ä»¥ä¸‹æ˜¯åŒäº²å§”æ´¾æœºåˆ¶çš„å·¥ä½œåŸç†ï¼š</p><ul class="lvl-2"><li class="lvl-4">1.å½“ä¸€ä¸ªç±»åŠ è½½å™¨æ¥æ”¶åˆ°ç±»åŠ è½½è¯·æ±‚æ—¶ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªè¡Œå°è¯•å»å¯»æ‰¾ç±»æ–‡ä»¶ï¼Œè€Œæ˜¯å°†è¿™ä¸ªè¯·æ±‚å§”æ´¾ç»™å®ƒçš„çˆ¶ç±»åŠ è½½å™¨ã€‚</li><li class="lvl-4">2.çˆ¶ç±»åŠ è½½å™¨åŒæ ·éµå¾ªæ­¤è§„åˆ™ï¼Œå®ƒä¼šç»§ç»­æŠŠè¯·æ±‚å‘ä¸Šå§”æ´¾ç»™å®ƒçš„çˆ¶ç±»åŠ è½½å™¨ï¼Œç›´åˆ°è¾¾åˆ°æ ¹ï¼ˆbootstrappï¼‰ç±»åŠ è½½å™¨ä¸ºæ­¢ã€‚</li><li class="lvl-4">3.æ ¹ç±»åŠ è½½å™¨ä¸€èˆ¬ä¼šç›´æ¥è®¿é—®æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿæ¥æŸ¥æ‰¾ç±»æ–‡ä»¶ï¼Œæ¯”å¦‚ JDK è‡ªå¸¦çš„æ ¸å¿ƒç±»åº“ï¼Œæˆ–è€…åœ¨-XbootclasspathæŒ‡å®šçš„è·¯å¾„ä¸‹æŸ¥æ‰¾ã€‚</li><li class="lvl-4">4.å¦‚æœæ ¹ç±»åŠ è½½å™¨æ‰¾åˆ°äº†è¯¥ç±»ï¼Œåˆ™è¿›è¡Œç±»çš„åŠ è½½ï¼›å¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™æŠŠè¿™ä¸ªä»»åŠ¡äº¤å›ç»™å‘å‡ºè¯·æ±‚çš„å­ç±»åŠ è½½å™¨ã€‚</li><li class="lvl-4">5.å­ç±»åŠ è½½å™¨ä¹Ÿé‡å¤æ­¥éª¤ 4ï¼Œè‹¥æ‰¾åˆ°åˆ™åŠ è½½ï¼Œå¦åˆ™ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå­ç±»åŠ è½½å™¨ï¼Œç›´è‡³åŸå§‹æå‡ºè¯·æ±‚çš„ç±»åŠ è½½å™¨ã€‚</li><li class="lvl-4">6.è‹¥æ‰€æœ‰çš„ç±»åŠ è½½å™¨éƒ½æœªèƒ½æ‰¾åˆ°æ‰€éœ€çš„ç±»ï¼Œåˆ™æœ€ç»ˆæŠ›å‡ºClassNotFoundExceptionå¼‚å¸¸ã€‚<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/ftDnCj.png" alt="" width="600" height="800"></li></ul></li><li class="lvl-2"><p>åŒäº²å§”æ´¾æœ‰ä»¥ä¸‹å‡ ä¸ªä¼˜ç‚¹ï¼š</p><ul class="lvl-2"><li class="lvl-4">å®‰å…¨æ€§ï¼šç”±äºç±»åŠ è½½æ˜¯ä»é¡¶å±‚å¼€å§‹ï¼Œè¿™èƒ½é˜²æ­¢æ¶æ„ä»£ç é€šè¿‡åŠ è½½ç›¸åŒçš„åŒ…åå’Œç±»åæ›¿ä»£ç³»ç»Ÿçš„å…³é”®ç±»ã€‚</li><li class="lvl-4">å”¯ä¸€æ€§ï¼šæ¯ä¸ªç±»éƒ½ä¼šè¢«ç‰¹å®šçš„ç±»åŠ è½½å™¨åŠ è½½ä¸€æ¬¡ï¼Œå³ä¾¿æ˜¯åœ¨åˆ†å¸ƒå¼çš„ç¯å¢ƒä¸­ä¹Ÿèƒ½ä¿è¯ç±»çš„ç»Ÿä¸€æ€§ï¼Œé¿å…å› ä¸ºå¤šæ¬¡åŠ è½½å¯¼è‡´çš„é”™è¯¯ã€‚</li><li class="lvl-4">å¯é æ€§ï¼šç”¨æˆ·è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ä¸ç”¨æ‹…å¿ƒåŸºç¡€ç±»å·²ç»è¢«åŠ è½½ï¼Œå®ƒä»¬å¯ä»¥ä¸“å¿ƒäºè‡ªå·±éœ€è¦å¤„ç†çš„éƒ¨åˆ†ã€‚</li></ul></li><li class="lvl-2"><p>ä¾‹å¦‚ï¼Œå½“åº”ç”¨ç¨‹åºè¿è¡Œæ—¶ï¼Œåº”ç”¨ç±»åŠ è½½å™¨ï¼ˆApplication ClassLoaderï¼‰æ¥æ”¶åˆ°å¯¹java.lang.Stringç±»çš„åŠ è½½è¯·æ±‚æ—¶ï¼Œå®ƒä¼šé¦–å…ˆå°†è¯·æ±‚ä¼ é€’ç»™æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension ClassLoaderï¼‰ï¼Œåè€…å†ä¼ é€’ç»™å¼•å¯¼ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰ã€‚å¼•å¯¼ç±»åŠ è½½å™¨ä¼šåœ¨å…¶æœç´¢è·¯å¾„ä¸­æ‰¾åˆ°Stringç±»ï¼Œå¹¶å®ŒæˆåŠ è½½è¿‡ç¨‹ã€‚å¦‚æœåº”ç”¨ç¨‹åºè¯•å›¾æä¾›è‡ªå·±çš„Stringç±»ï¼Œç”±äºåŒäº²å§”æ´¾çš„å­˜åœ¨ï¼Œåº”ç”¨ç¨‹åºæ‰€æŒ‡å®šçš„ç±»å¹¶ä¸ä¼šè¢«åŠ è½½ï¼Œä»è€Œä¿è¯äº†å¹³å°æ ¸å¿ƒ API çš„ä¸€è‡´æ€§ã€‚</p></li><li class="lvl-2"><p>æ€»ä¹‹ï¼ŒåŒäº²å§”æ´¾æœºåˆ¶æ˜¯ Java ç±»åŠ è½½è¿‡ç¨‹ä¸­ä¸€ä¸ªéå¸¸é‡è¦çš„ç‰¹æ€§ï¼Œå®ƒä¸ä»…ç»´æŠ¤äº†ç±»åŠ è½½çš„å®‰å…¨æ€§å’Œä¸€è‡´æ€§ï¼Œä¹Ÿä¸ºå¼€å‘è€…æä¾›äº†çµæ´»å®šåˆ¶ç±»åŠ è½½è§„åˆ™çš„èƒ½åŠ›ã€‚</p></li></ul><h3 id="æ¯ä¸ªç±»åŠ è½½å™¨æŸ¥æ‰¾ç±»çš„é»˜è®¤è·¯å¾„">æ¯ä¸ªç±»åŠ è½½å™¨æŸ¥æ‰¾ç±»çš„é»˜è®¤è·¯å¾„</h3><ul class="lvl-0"><li class="lvl-2"><p>åœ¨ Java ä¸­ï¼Œæ¯ä¸ªç±»åŠ è½½å™¨éƒ½æœ‰è‡ªå·±çš„ç±»è·¯å¾„ï¼ˆClasspathï¼‰å»æŸ¥æ‰¾ç±»æ–‡ä»¶ã€‚ä¸‹é¢æ˜¯å‡ ä¸ªä¸»è¦çš„ç±»åŠ è½½å™¨ä»¥åŠå®ƒä»¬çš„é»˜è®¤æŸ¥æ‰¾è·¯å¾„ï¼š</p></li></ul><table><thead><tr><th>ç±»åŠ è½½å™¨åç§°</th><th>ç±»å / åˆ«å</th><th>çˆ¶ç±»åŠ è½½å™¨</th><th>åŠ è½½å†…å®¹æè¿°</th><th>é»˜è®¤æŸ¥æ‰¾è·¯å¾„ / ç³»ç»Ÿå±æ€§</th></tr></thead><tbody><tr><td><strong>å¯åŠ¨ç±»åŠ è½½å™¨</strong></td><td>BootstrapClassLoader</td><td>æ— </td><td>åŠ è½½ <strong>æ ¸å¿ƒ Java ç±»åº“</strong></td><td><code>&lt;JAVA_HOME&gt;/jre/lib/rt.jar</code>ï¼ˆJDK8 åŠä¹‹å‰ï¼‰æˆ– <code>sun.boot.class.path</code> æŒ‡å®šè·¯å¾„</td></tr><tr><td><strong>æ‰©å±•ç±»åŠ è½½å™¨</strong></td><td>ExtClassLoader</td><td>BootstrapClassLoader</td><td>åŠ è½½ Java å¹³å°æ‰©å±•ç±»åº“</td><td><code>&lt;JAVA_HOME&gt;/jre/lib/ext</code> æˆ–ç”± <code>java.ext.dirs</code> ç³»ç»Ÿå±æ€§æŒ‡å®š</td></tr><tr><td><strong>åº”ç”¨ç±»åŠ è½½å™¨</strong></td><td>AppClassLoader</td><td>ExtClassLoader</td><td>åŠ è½½ <strong>åº”ç”¨ç¨‹åºç±»</strong>ï¼ˆç”¨æˆ·ç¼–å†™çš„ä»£ç ï¼‰</td><td><code>-classpath</code>ã€<code>-cp</code> å‚æ•°ã€<code>CLASSPATH</code> ç¯å¢ƒå˜é‡ã€<code>java.class.path</code> å±æ€§ã€å½“å‰ç›®å½• (.)</td></tr><tr><td><strong>è‡ªå®šä¹‰ç±»åŠ è½½å™¨</strong></td><td>ç”¨æˆ·è‡ªå®šä¹‰</td><td>å¯æŒ‡å®š</td><td>å¯é€šè¿‡ç»§æ‰¿ <code>ClassLoader</code> å¹¶é‡å†™ <code>findClass()</code> æ–¹æ³•å®ç°è‡ªå®šä¹‰ç±»åŠ è½½é€»è¾‘ï¼Œå¦‚ä»ç½‘ç»œã€æ•°æ®åº“ç­‰åŠ è½½ç±»æ–‡ä»¶</td><td>é»˜è®¤ç»§æ‰¿çˆ¶åŠ è½½å™¨æŸ¥æ‰¾è·¯å¾„ï¼Œä¹Ÿå¯è‡ªå®šä¹‰</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé™¤äº† Bootstrap ClassLoader å¤–ï¼Œå…¶ä»–çš„æ‰€æœ‰ç±»åŠ è½½å™¨æœ€ç»ˆéƒ½æ˜¯java.lang.ClassLoaderçš„å­ç±»ï¼Œå¹¶ä¸”æ¯ä¸ªç±»åŠ è½½å™¨å®ä¾‹éƒ½æœ‰ä¸€ä¸ªç›´æ¥çš„çˆ¶ç±»åŠ è½½å™¨ã€‚å¦‚æœä½ åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ç±»åŠ è½½å™¨ï¼Œå®ƒå°†ç»§æ‰¿ Application ClassLoader ä½œä¸ºå®ƒçš„çˆ¶ç±»ï¼Œé™¤éä½ åœ¨åˆ›å»ºæ—¶æŒ‡å®šäº†ä¸åŒçš„çˆ¶ç±»åŠ è½½å™¨ã€‚</p></li><li class="lvl-2"><p>æ­¤å¤–ï¼ŒJava 9 å¼•å…¥äº†æ¨¡å—åŒ–ç³»ç»Ÿåï¼Œç±»åŠ è½½æœºåˆ¶ä¹Ÿæœ‰äº†ä¸€äº›å˜åŒ–ï¼Œå¯¹äºæ¨¡å—è·¯å¾„ä¸Šçš„ç±»åŠ è½½ï¼Œä¼šä½¿ç”¨æ–°çš„å±‚æ¬¡ç»“æ„æ¥å¤„ç†ï¼Œè¿™ä½¿å¾—ç±»åŠ è½½è¿‡ç¨‹æ›´åŠ çµæ´»åŒæ—¶ä¿æŒäº†å‘åçš„å…¼å®¹æ€§ã€‚ä¸è¿‡ï¼Œå¯¹äºä¼ ç»Ÿçš„ç±»è·¯å¾„ä¸Šçš„ç±»åŠ è½½ï¼ŒåŒäº²å§”æ´¾æ¨¡å‹ä»ç„¶é€‚ç”¨ã€‚<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/50fvA9.png" alt="" width="1200" height="400"></p></li></ul><table><thead><tr><th>ç±»åŠ è½½å™¨åç§°</th><th>ç±»å / åˆ«å</th><th>çˆ¶ç±»åŠ è½½å™¨</th><th>åŠ è½½æ¨¡å—èŒƒå›´</th><th>é»˜è®¤æŸ¥æ‰¾è·¯å¾„ / æ¨¡å—æ¥æº</th></tr></thead><tbody><tr><td><strong>å¼•å¯¼ç±»åŠ è½½å™¨</strong></td><td><code>BootstrapClassLoader</code></td><td>æ— </td><td>åŠ è½½ <code>java.*</code> æ¨¡å—ï¼Œä¾‹å¦‚ <code>java.base</code>ï¼ˆåŒ…å« <code>java.lang</code>, <code>java.util</code> ç­‰ï¼‰</td><td><code>$JAVA_HOME/jmods</code> ä¸­çš„æ¨¡å—æ–‡ä»¶ï¼Œæ ¸å¿ƒæ¨¡å—ç”± JVM å¯åŠ¨æ—¶ç›´æ¥åŠ è½½</td></tr><tr><td><strong>å¹³å°ç±»åŠ è½½å™¨</strong></td><td><code>PlatformClassLoader</code></td><td>BootstrapClassLoader</td><td>åŠ è½½ <code>jdk.*</code>ã€<code>javafx.*</code> ç­‰å¹³å°æ‰©å±•æ¨¡å—</td><td><code>$JAVA_HOME/jmods</code>ï¼Œæ¨¡å—åä¸º <code>jdk.*</code>ã€<code>javafx.*</code> ç­‰ï¼›</td></tr><tr><td><strong>åº”ç”¨ç±»åŠ è½½å™¨</strong></td><td><code>AppClassLoader</code></td><td>PlatformClassLoader</td><td>åŠ è½½åº”ç”¨æ¨¡å—ï¼ˆç”¨æˆ·ä»£ç ï¼‰ï¼ŒåŒ…æ‹¬æ¨¡å—è·¯å¾„ <code>--module-path</code> å’Œç±»è·¯å¾„ <code>-classpath</code> ä¸‹çš„ç±»</td><td>åº”ç”¨ç¨‹åºç¼–å†™çš„æ¨¡å—æˆ–ç±»ï¼Œæ¥è‡ªå‘½ä»¤è¡Œ <code>--module-path</code>ã€<code>-classpath</code> å‚æ•°ã€<code>CLASSPATH</code> ç¯å¢ƒå˜é‡ç­‰</td></tr><tr><td><strong>è‡ªå®šä¹‰ç±»åŠ è½½å™¨</strong></td><td>ç”¨æˆ·è‡ªå®šä¹‰</td><td>å¯æŒ‡å®šçˆ¶åŠ è½½å™¨</td><td>åŠ è½½éæ ‡å‡†ä½ç½®çš„ç±»ï¼Œå¯ç”¨äºæ’ä»¶ã€ç½‘ç»œåŠ è½½ã€åŠ å¯†ç±»åŠ è½½ç­‰</td><td>é»˜è®¤éµå¾ªåŒäº²å§”æ´¾ï¼Œå¯é‡å†™ <code>findClass()</code> å®ç°è‡ªå®šä¹‰è·¯å¾„æŸ¥æ‰¾æˆ–å…¶ä»–æ•°æ®æºï¼Œå¦‚ç½‘ç»œã€æ•°æ®åº“ã€åŠ å¯†æ–‡ä»¶ç­‰</td></tr></tbody></table><blockquote><p>jdk9+ä¸­ï¼Œåœ¨å§”æ´¾ç»™çˆ¶åŠ è½½å™¨åŠ è½½å‰ï¼Œå…ˆåˆ¤æ–­è¯¥ç±»æ˜¯å¦èƒ½å¤Ÿå½’å±åˆ°æŸä¸€ä¸ªç³»ç»Ÿæ¨¡å—ä¸­ï¼Œå¦‚æœå¯ä»¥æ‰¾åˆ°è¿™æ ·çš„å½’å±å…³ç³»ï¼Œå°±è¦ä¼˜å…ˆå§”æ´¾ç»™è´Ÿè´£é‚£ä¸ªæ¨¡å—çš„åŠ è½½å™¨å®ŒæˆåŠ è½½ã€‚</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>åœ¨ä»£ç ä¸­æŸ¥çœ‹ç±»åŠ è½½è·¯å¾„</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BootStrap Classloaderï¼ŒåŠ è½½javaåŸºç¡€ç±»ã€‚</span></span><br><span class="line">System.out.println(<span class="string">&quot;BootStrap ClassLoaderåŠ è½½â½¬å½•ï¼š&quot;</span> + System.getProperty(<span class="string">&quot;sun.boot.class.path&quot;</span>));</span><br><span class="line"><span class="comment">// Extention Classloader åŠ è½½â¼€äº›æ‰©å±•ç±»ã€‚ å¯é€šè¿‡-D java.ext.dirså¦â¾æŒ‡å®šâ½¬å½•</span></span><br><span class="line">System.out.println(<span class="string">&quot;Extention ClassLoaderåŠ è½½â½¬å½•ï¼š&quot;</span> + System.getProperty(<span class="string">&quot;java.ext.dirs&quot;</span>));</span><br><span class="line"><span class="comment">// AppClassLoader åŠ è½½CLASSPATHï¼Œåº”â½¤ä¸‹çš„JaråŒ…ã€‚å¯é€šè¿‡-D java.class.pathå¦â¾æŒ‡å®šâ½¬å½•</span></span><br><span class="line">System.out.println(<span class="string">&quot;AppClassLoaderåŠ è½½â½¬å½•ï¼š&quot;</span> + System.getProperty(<span class="string">&quot;java.class.path&quot;</span>));</span><br></pre></td></tr></table></figure><h3 id="åŒäº²å§”æ´¾æœºåˆ¶çš„å®ç°åŸç†">åŒäº²å§”æ´¾æœºåˆ¶çš„å®ç°åŸç†</h3><ul class="lvl-0"><li class="lvl-2"><p>java.lang.ClassLoader ç±»çš„ loadClass æ–¹æ³•æ˜¯åŒäº²å§”æ´¾çš„æ ¸å¿ƒå®ç°</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åŠ è½½æŒ‡å®šåç§°çš„ç±»ï¼Œå¹¶æ ¹æ® resolve å‚æ•°å†³å®šæ˜¯å¦è§£æè¯¥ç±»ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¯¥æ–¹æ³•å®ç°äº†ç±»åŠ è½½çš„åŸºæœ¬é€»è¾‘ï¼ŒåŒ…æ‹¬æ£€æŸ¥ç±»æ˜¯å¦å·²åŠ è½½ã€å§”æ‰˜çˆ¶ç±»åŠ è½½å™¨åŠ è½½ã€</span></span><br><span class="line"><span class="comment"> * è‡ªè¡ŒåŠ è½½ç±»ä»¥åŠè§£æç±»ç­‰æ­¥éª¤ã€‚è¯¥æ–¹æ³•æ˜¯ Java ç±»åŠ è½½æœºåˆ¶çš„æ ¸å¿ƒéƒ¨åˆ†ä¹‹ä¸€ï¼Œ</span></span><br><span class="line"><span class="comment"> * éµå¾ªåŒäº²å§”æ´¾æ¨¡å‹ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> name    è¦åŠ è½½çš„ç±»çš„å…¨é™å®šå</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> resolve å¦‚æœä¸º trueï¼Œåˆ™åœ¨åŠ è½½åè§£æè¯¥ç±»</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> åŠ è½½çš„ Class å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> ClassNotFoundException å¦‚æœæ‰¾ä¸åˆ°æŒ‡å®šçš„ç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// è¿™ä¸ªâ½…æ³•æ˜¯protectedå£°æ˜çš„ï¼Œæ„å‘³ç€ï¼Œæ˜¯å¯ä»¥è¢«â¼¦ç±»è¦†ç›–çš„ï¼Œæ‰€ä»¥ï¼ŒåŒäº²å§”æ´¾æœºåˆ¶ä¹Ÿæ˜¯å¯ä»¥è¢«æ‰“ç ´çš„ï¼Œå¦‚Tomcatâ¼¦ç±»é‡å†™è¿™ä¸ªâ½…æ³•ï¼Œå¹¶ä½¿â½¤è‡ªå·±çš„ç±»åŠ è½½é€»è¾‘ã€‚</span></span><br><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="type">boolean</span> resolve)</span><br><span class="line">        <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ synchronized ç¡®ä¿å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ç±»åŠ è½½çš„åŒæ­¥</span></span><br><span class="line">    <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class="line">        <span class="comment">// First, check if the class has already been loaded</span></span><br><span class="line">        <span class="comment">// æ¯ä¸ªç±»åŠ è½½å™¨å¯¹ä»–åŠ è½½è¿‡çš„ç±»éƒ½æœ‰â¼€ä¸ªç¼“å­˜ï¼Œå…ˆå»ç¼“å­˜ä¸­æŸ¥çœ‹æœ‰æ²¡æœ‰åŠ è½½è¿‡</span></span><br><span class="line">        Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="literal">null</span>) &#123; <span class="comment">//æ²¡æœ‰åŠ è½½è¿‡ï¼Œå°±â¾›åŒäº²å§”æ´¾</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">t0</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// çˆ¶ç±»å­˜åœ¨åˆ™è®©â½—ç±»åŠ è½½å™¨è¿›â¾åŠ è½½</span></span><br><span class="line">                <span class="keyword">if</span> (parent != <span class="literal">null</span>) &#123;</span><br><span class="line">                    c = parent.loadClass(name, <span class="literal">false</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123; <span class="comment">//å¦‚æœçˆ¶ç±»ä¸å­˜åœ¨ï¼Œåˆ™ä»å¼•å¯¼ç±»åŠ è½½å™¨è¿›â¾åŠ è½½</span></span><br><span class="line">                    c = findBootstrapClassOrNull(name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                <span class="comment">// ClassNotFoundException thrown if class not found</span></span><br><span class="line">                <span class="comment">// from the non-null parent class loader</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (c == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// If still not found, then invoke findClass in order</span></span><br><span class="line">                <span class="comment">// to find the class.</span></span><br><span class="line">                <span class="type">long</span> <span class="variable">t1</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">                <span class="comment">// findClass æ–¹æ³•æ˜¯å­ç±»å®ç°çš„ï¼Œç”¨äºåŠ è½½æŒ‡å®šåç§°çš„ç±»</span></span><br><span class="line">                <span class="comment">// â½—ç±»åŠ è½½å™¨æ²¡æœ‰åŠ è½½è¿‡ï¼Œå°±â¾ƒâ¾è§£æclassâ½‚ä»¶åŠ è½½</span></span><br><span class="line">                c = findClass(name);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// this is the defining class loader; record the stats</span></span><br><span class="line">                <span class="comment">// æ€§èƒ½ç»Ÿè®¡ï¼šè®°å½•ç±»åŠ è½½è¿‡ç¨‹ä¸­çš„æ—¶é—´æ¶ˆè€—å’Œè°ƒç”¨æ¬¡æ•°ï¼Œä¾¿äºç›‘æ§å’Œä¼˜åŒ–ã€‚</span></span><br><span class="line">                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);</span><br><span class="line">                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</span><br><span class="line">                sun.misc.PerfCounter.getFindClasses().increment();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é»˜è®¤æƒ…å†µä¸‹ï¼ŒåŒäº²å§”æ´¾æ¨¡å‹åªè¿›â¾äº†éªŒè¯å’Œå‡†å¤‡é˜¶æ®µï¼Œâ½½ä¸è¿›â¾è§£æ(å¦‚é“¾æ¥ã€åˆå§‹åŒ–)</span></span><br><span class="line">        <span class="keyword">if</span> (resolve) &#123;</span><br><span class="line">            resolveClass(c);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>è¯¥æ–¹æ³•å®ç°äº†ç±»åŠ è½½çš„åŸºæœ¬é€»è¾‘ï¼ŒåŒ…æ‹¬æ£€æŸ¥ç±»æ˜¯å¦å·²åŠ è½½ã€å§”æ‰˜çˆ¶ç±»åŠ è½½å™¨åŠ è½½ã€è‡ªè¡ŒåŠ è½½ç±»ä»¥åŠè§£æç±»ç­‰æ­¥éª¤ã€‚è¯¥æ–¹æ³•æ˜¯ Java ç±»åŠ è½½æœºåˆ¶çš„æ ¸å¿ƒéƒ¨åˆ†ä¹‹ä¸€ï¼Œéµå¾ªåŒäº²å§”æ´¾æ¨¡å‹ã€‚</p></li><li class="lvl-2"><p>è¿™ä¸ªâ½…æ³•æ˜¯<code>protected</code>å£°æ˜çš„ï¼Œæ„å‘³ç€ï¼Œæ˜¯å¯ä»¥è¢«â¼¦ç±»è¦†ç›–çš„ï¼Œæ‰€ä»¥ï¼ŒåŒäº²å§”æ´¾æœºåˆ¶ä¹Ÿæ˜¯å¯ä»¥è¢«æ‰“ç ´çš„ï¼Œå¦‚Tomcatâ¼¦ç±»é‡å†™è¿™ä¸ªâ½…æ³•ï¼Œå¹¶ä½¿â½¤è‡ªå·±çš„ç±»åŠ è½½é€»è¾‘ã€‚</p></li></ul><h2 id="æ²™ç®±ä¿æŠ¤æœºåˆ¶">æ²™ç®±ä¿æŠ¤æœºåˆ¶</h2><ul class="lvl-0"><li class="lvl-2"><p>æ²™ç®±ä¿æŠ¤æœºåˆ¶æ˜¯ Java è™šæ‹Ÿæœºæä¾›çš„ä¸€ç§å®‰å…¨æœºåˆ¶ï¼Œç”¨äºä¿æŠ¤åº”ç”¨ç¨‹åºå…å—æ¶æ„ä»£ç çš„æ”»å‡»ã€‚</p></li><li class="lvl-2"><p>java.lang.ClassLoader ç±»çš„ preDefineClass æ–¹æ³•æ˜¯æ²™ç®±ä¿æŠ¤æœºåˆ¶çš„æ ¸å¿ƒå®ç°</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™ä¸ªæ–¹æ³•åœ¨åŒäº²å§”æ´¾æ¨¡å‹ä¹‹å‰è¢«è°ƒç”¨ï¼Œç”¨äºåœ¨åŠ è½½ç±»ä¹‹å‰è¿›è¡Œä¸€äº›é¢„å¤„ç†æ“ä½œã€‚</span></span><br><span class="line"><span class="comment">// å‚æ•°ï¼š</span></span><br><span class="line"><span class="comment">// name: è¦åŠ è½½çš„ç±»çš„å…¨é™å®šåã€‚</span></span><br><span class="line"><span class="comment">// pd: æä¾›çš„ä¿æŠ¤åŸŸä¿¡æ¯ï¼Œå¯èƒ½ä¸º nullã€‚</span></span><br><span class="line"><span class="keyword">private</span> ProtectionDomain <span class="title function_">preDefineClass</span><span class="params">(String name,</span></span><br><span class="line"><span class="params">                                            ProtectionDomain pd)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!checkName(name))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoClassDefFoundError</span>(<span class="string">&quot;IllegalName: &quot;</span> + name);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Note:  Checking logic in java.lang.invoke.MemberName.checkForTypeAlias</span></span><br><span class="line">        <span class="comment">// relies on the fact that spoofing is impossible if a class has a name</span></span><br><span class="line">        <span class="comment">// of the form &quot;java.*&quot;</span></span><br><span class="line">        <span class="keyword">if</span> ((name != <span class="literal">null</span>) &amp;&amp; name.startsWith(<span class="string">&quot;java.&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span></span><br><span class="line">                (<span class="string">&quot;Prohibited package name: &quot;</span> +</span><br><span class="line">                 name.substring(<span class="number">0</span>, name.lastIndexOf(<span class="string">&#x27;.&#x27;</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (pd == <span class="literal">null</span>) &#123;</span><br><span class="line">            pd = defaultDomain;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (name != <span class="literal">null</span>) checkCerts(name, pd.getCodeSource());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> pd;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>è¿™ä¸ªæ–¹æ³• <code>preDefineClass</code> çš„ä½œç”¨æ˜¯åœ¨ç±»è¢«å®šä¹‰ä¹‹å‰è¿›è¡Œä¸€äº›å®‰å…¨æ£€æŸ¥å’Œå‡†å¤‡å·¥ä½œï¼Œç¡®ä¿ç±»çš„åˆæ³•æ€§ä¸å®‰å…¨æ€§ã€‚å®ƒé€šå¸¸ç”¨äºè‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¸­ï¼Œä»¥å¢å¼ºç±»åŠ è½½è¿‡ç¨‹ä¸­çš„å®‰å…¨æ§åˆ¶ã€‚</p></li><li class="lvl-2"><p>æ–¹æ³•ä½œç”¨è¯¦è§£ï¼š</p><ul class="lvl-2"><li class="lvl-4">1.é˜²æ­¢å®šä¹‰éæ³•ç±»åçš„ç±»ï¼ˆå¦‚ java.* åŒ…ä¸‹çš„ç±»ï¼‰ï¼š<ul class="lvl-4"><li class="lvl-6">å¦‚æœå°è¯•åŠ è½½çš„ç±»å±äº java. å¼€å¤´çš„æ ‡å‡†åŒ…ï¼ˆå¦‚ java.lang, java.util ç­‰ï¼‰ï¼Œä¼šæŠ›å‡º SecurityExceptionã€‚</li><li class="lvl-6">è¿™æ˜¯ä¸ºäº†é˜²æ­¢ç”¨æˆ·è‡ªå®šä¹‰ç±»ä¼ªè£…æˆ Java æ ¸å¿ƒç±»åº“ä¸­çš„ç±»ï¼Œä»è€Œé€ æˆå®‰å…¨é£é™©ã€‚</li></ul></li><li class="lvl-4">2.æ ¡éªŒç±»ååˆæ³•æ€§ï¼š<ul class="lvl-4"><li class="lvl-6">è°ƒç”¨ checkName(name) æ£€æŸ¥ç±»åæ˜¯å¦åˆæ³•ï¼ˆä¾‹å¦‚ä¸èƒ½åŒ…å« /ã€éæ³•å­—ç¬¦ç­‰ï¼‰ï¼Œè‹¥ä¸åˆæ³•åˆ™æŠ›å‡º NoClassDefFoundErrorã€‚</li></ul></li><li class="lvl-4">3.è¯ä¹¦ä¸€è‡´æ€§æ ¡éªŒï¼ˆç­¾åä¸€è‡´æ€§æ ¡éªŒï¼‰ï¼š<ul class="lvl-4"><li class="lvl-6">å¦‚æœç±»æœ‰åç§°ä¸”æä¾›äº† ProtectionDomainï¼Œä¼šè°ƒç”¨ checkCerts(name, codeSource) æ¥ç¡®ä¿å½“å‰ç±»çš„ç­¾åä¸å…¶æ‰€åœ¨åŒ…ä¸­å…¶ä»–ç±»çš„ç­¾åä¸€è‡´ã€‚</li><li class="lvl-6">é˜²æ­¢åŒä¸€åŒ…ä¸­æ··å…¥ä¸åŒç­¾åçš„ç±»ï¼Œé¿å…æ½œåœ¨çš„æ¶æ„ç¯¡æ”¹ã€‚</li></ul></li><li class="lvl-4">4.è®¾ç½®é»˜è®¤ä¿æŠ¤åŸŸï¼ˆProtectionDomainï¼‰ï¼š<ul class="lvl-4"><li class="lvl-6">å¦‚æœä¼ å…¥çš„ ProtectionDomain ä¸º nullï¼Œåˆ™ä½¿ç”¨ç±»åŠ è½½å™¨çš„é»˜è®¤åŸŸ defaultDomainã€‚</li></ul></li></ul></li></ul><h2 id="Linkingé“¾æ¥è¿‡ç¨‹">Linkingé“¾æ¥è¿‡ç¨‹</h2><ul class="lvl-0"><li class="lvl-2"><p>åœ¨ClassLoaderçš„<code>loadClass</code>â½…æ³•ä¸­ï¼Œè¿˜æœ‰â¼€ä¸ªä¸èµ·çœ¼çš„æ­¥éª¤ï¼Œ<code>resolveClass</code>ã€‚è¿™æ˜¯â¼€ä¸ª<code>native</code>â½…æ³•ã€‚â½½å…¶å®ç°çš„è¿‡ç¨‹ç§°ä¸º<code>linking-é“¾æ¥</code>ã€‚</p></li><li class="lvl-2"><p>é“¾æ¥è¿‡ç¨‹çš„å®ç°åŠŸèƒ½å¦‚ä¸‹å›¾ï¼š<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/9vkhLN.png" alt="" width="900" height="500"></p></li><li class="lvl-2"><p>å…¶ä¸­å…³äºåŠåˆå§‹åŒ–çŠ¶æ€å°±æ˜¯JDKåœ¨å¤„ç†â¼€ä¸ªç±»çš„staticé™æ€å±æ€§æ—¶ï¼Œä¼šå…ˆç»™è¿™ä¸ªå±æ€§åˆ†é…â¼€ä¸ªé»˜è®¤å€¼ï¼Œä½œâ½¤æ˜¯å ä½å†…å­˜ã€‚ç„¶åç­‰è¿æ¥è¿‡ç¨‹å®Œæˆåï¼Œåœ¨åâ¾¯çš„åˆå§‹åŒ–é˜¶æ®µï¼Œå†å°†é™æ€å±æ€§ä»é»˜è®¤å€¼ä¿®æ”¹ä¸ºæŒ‡å®šçš„åˆå§‹å€¼ã€‚</p></li><li class="lvl-2"><p>ç¬¦å·å¼•â½¤å’Œç›´æ¥å¼•â½¤</p></li></ul><blockquote><p>å¦‚æœAç±»ä¸­æœ‰â¼€ä¸ªé™æ€å±æ€§ï¼Œå¼•â½¤äº†å¦â¼€ä¸ªBç±»ã€‚é‚£ä¹ˆåœ¨å¯¹ç±»è¿›â¾åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œå› ä¸ºAå’ŒBè¿™ä¸¤ä¸ªç±»éƒ½æ²¡æœ‰åˆå§‹åŒ–ï¼ŒJVMå¹¶ä¸çŸ¥é“Aå’ŒBè¿™ä¸¤ä¸ªç±»çš„å…·ä½“åœ°å€ã€‚æ‰€ä»¥è¿™æ—¶ï¼Œåœ¨Aç±»ä¸­ï¼Œåªèƒ½åˆ›å»ºâ¼€ä¸ªä¸çŸ¥é“å…·ä½“åœ°å€çš„å¼•â½¤ï¼ŒæŒ‡å‘Bç±»ã€‚è¿™ä¸ªå¼•â½¤å°±ç§°ä¸ºç¬¦å·å¼•â½¤ã€‚â½½å½“Aç±»å’ŒBç±»éƒ½å®Œæˆåˆå§‹åŒ–åï¼ŒJVMâ¾ƒç„¶å°±éœ€è¦å°†è¿™ä¸ªç¬¦å·å¼•â½¤è½¬â½½æŒ‡å‘Bç±»å…·ä½“çš„å†…å­˜åœ°å€ï¼Œè¿™ä¸ªå¼•â½¤å°±ç§°ä¸ºç›´æ¥å¼•â½¤ã€‚</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>æ¥çœ‹ä¸€ä¸ªæœ‰æ„æ€çš„ç¤ºä¾‹</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Apple</span> &#123;</span><br><span class="line">    <span class="comment">// é™æ€å˜é‡æŒ‰å£°æ˜é¡ºåºåˆå§‹åŒ–</span></span><br><span class="line">    <span class="comment">// æ„é€ æ–¹æ³•åˆå§‹åŒ–appleå¯¹è±¡æ—¶ï¼Œpriceè¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œå¤„äºé“¾æ¥è¿‡ç¨‹ä¸­çš„å‡†å¤‡é˜¶æ®µï¼Œå³åŠåˆå§‹åŒ–çŠ¶æ€ï¼Œæ‰€ä»¥priceä¸ºé»˜è®¤å€¼0.0</span></span><br><span class="line">    <span class="keyword">static</span> <span class="type">Apple</span> <span class="variable">apple</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Apple</span>(<span class="number">10</span>);</span><br><span class="line">    <span class="comment">// è§£å†³æ–¹æ³•æ˜¯å°†priceå£°æ˜åœ¨appleçš„ä¸Šé¢å³å¯</span></span><br><span class="line">    <span class="keyword">static</span> <span class="type">double</span> <span class="variable">price</span> <span class="operator">=</span> <span class="number">20.00</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">double</span> totalpay;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Apple</span><span class="params">(<span class="type">double</span> discount)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;====&quot;</span> + price);</span><br><span class="line">        totalpay = price - discount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PriceTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(Apple.apple.totalpay); <span class="comment">// -10.0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>è¿™é‡Œæœ‰ä¸€ä¸ªæœ‰æ„æ€çš„é—®é¢˜ï¼Œå°±æ˜¯åªæœ‰å½“<code>loadClass</code>æ–¹æ³•ä¸­çš„<code>resolve</code>å‚æ•°ä¸º<code>true</code>æ—¶<code>resolveClass</code>æ–¹æ³•æ‰ä¼šè¢«è°ƒç”¨ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œ<code>resolve</code>å‚æ•°éƒ½æ˜¯<code>false</code>ï¼Œè¿™ä¸æ˜¯å¼ºåˆ¶é™åˆ¶è€Œæ˜¯å‡ºäºä»¥ä¸‹åŸå› ï¼š</p><ul class="lvl-2"><li class="lvl-4"><ol><li class="lvl-7">é¿å…é€’å½’è§£æä¸­å‡ºç°é”™è¯¯æˆ–æ­»å¾ªç¯<br>åœ¨ç±»çš„è§£æè¿‡ç¨‹ä¸­ï¼Œå¦‚æœè¯¥ç±»å¼•ç”¨äº†å¦ä¸€ä¸ªè¿˜æ²¡åŠ è½½çš„ç±»ï¼Œç«‹å³è§£æå¯èƒ½ä¼šå¯¼è‡´æ— é™é€’å½’æˆ–åŠ è½½é¡ºåºé—®é¢˜ã€‚é€šè¿‡å»¶è¿Ÿè§£æï¼Œå¯ä»¥æ›´å¥½åœ°æ§åˆ¶åŠ è½½æµç¨‹ã€‚</li></ol></li><li class="lvl-4"><ol start="2"><li class="lvl-7">æé«˜åŠ è½½æ•ˆç‡<br>åŠ è½½ç±»å¯èƒ½ä¸ä¸€å®šé©¬ä¸Šå°±ç”¨åˆ°æ‰€æœ‰æ–¹æ³•ã€å­—æ®µç­‰ç¬¦å·å¼•ç”¨ï¼Œæ¨è¿Ÿè§£æå¯ä»¥æé«˜æ€§èƒ½ï¼Œå°¤å…¶åœ¨æ‰¹é‡åŠ è½½å¾ˆå¤šç±»æ—¶ã€‚</li></ol></li><li class="lvl-4"><ol start="3"><li class="lvl-7">æ›´çµæ´»åœ°å¤„ç†ç±»çš„ä¾èµ–<br>å¼€å‘è€…å¯ä»¥å…ˆåŠ è½½ç±»ï¼Œç¨åæ ¹æ®éœ€è¦å†è§£æã€‚ä¾‹å¦‚ï¼Œåœ¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¸­ï¼Œå¯èƒ½å…ˆåˆ¤æ–­ç±»æ˜¯å¦å·²ç»å­˜åœ¨ã€æ˜¯å¦éœ€è¦è¢«å¢å¼ºï¼ˆæ¯”å¦‚å­—èŠ‚ç å¢å¼ºï¼‰ï¼Œå†å†³å®šæ˜¯å¦è§£æã€‚</li></ol></li></ul></li></ul><h2 id="é€šè¿‡ç±»åŠ è½½å™¨å¼•â¼Šå¤–éƒ¨JaråŒ…">é€šè¿‡ç±»åŠ è½½å™¨å¼•â¼Šå¤–éƒ¨JaråŒ…</h2><ul class="lvl-0"><li class="lvl-2"><p>è™½ç„¶é€šå¸¸æˆ‘ä»¬ä¼šå°†ä¾èµ–çš„ jar åŒ…ç›´æ¥æ”¾å…¥é¡¹ç›®çš„ classpath ä¸­ï¼ˆæ¯”å¦‚é€šè¿‡æ„å»ºå·¥å…·å¦‚ Maven æˆ– Gradle ç®¡ç†ï¼‰ï¼Œä½†åœ¨æŸäº›ç‰¹å®šåœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬ç¡®å®éœ€è¦åŠ¨æ€åœ°é€šè¿‡ URLClassLoader åŠ è½½å¤–éƒ¨ jar åŒ…ï¼Œè¿™æ˜¯ Java æä¾›çš„ä¸€ç§æ›´çµæ´»çš„ç±»åŠ è½½æœºåˆ¶ã€‚</p></li><li class="lvl-2"><p>ä»¥ä¸‹æ˜¯ä¸€äº›å¿…é¡»æˆ–æ¨èä½¿ç”¨ URLClassLoader çš„å…¸å‹åº”ç”¨åœºæ™¯ï¼š</p></li></ul><h3 id="1-æ’ä»¶æœºåˆ¶ï¼ˆPlugin-Systemï¼‰">1. æ’ä»¶æœºåˆ¶ï¼ˆPlugin Systemï¼‰</h3><ul class="lvl-0"><li class="lvl-2"><p>åœºæ™¯è¯´æ˜ï¼š<br>ç³»ç»Ÿæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰æ’ä»¶ï¼ˆå¦‚ IDE æ’ä»¶ã€æµè§ˆå™¨æ‰©å±•ã€æ¸¸æˆ modï¼‰ï¼Œè¿™äº›æ’ä»¶åœ¨è¿è¡Œæ—¶æ‰åŠ è½½ï¼Œé¡¹ç›®æœ¬èº«åœ¨ç¼–è¯‘æœŸå¹¶ä¸çŸ¥é“æœ‰å“ªäº›æ’ä»¶ã€‚</p></li><li class="lvl-2"><p>ä¸¾ä¾‹ï¼š<br>Eclipse æˆ– IntelliJ çš„æ’ä»¶ç³»ç»Ÿ<br>Minecraft çš„ mod åŠ è½½å™¨<br>Spring Boot Devtools é‡æ–°åŠ è½½æœºåˆ¶</p></li><li class="lvl-2"><p>ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥æ”¾å…¥ classpathï¼Ÿ<br>å› ä¸ºæ’ä»¶æ˜¯åŠ¨æ€å‘ç°å’ŒåŠ è½½çš„ï¼Œä¸æ˜¯ç¼–è¯‘æ—¶ç¡®å®šçš„ã€‚</p></li></ul><h3 id="2-çƒ­éƒ¨ç½²-åŠ¨æ€åŠ è½½ç±»">2. çƒ­éƒ¨ç½² / åŠ¨æ€åŠ è½½ç±»</h3><ul class="lvl-0"><li class="lvl-2"><p>åœºæ™¯è¯´æ˜ï¼š<br>ä½ æƒ³åœ¨åº”ç”¨è¿è¡Œè¿‡ç¨‹ä¸­åŠ è½½æ–°çš„ jar æˆ–ç±»ï¼Œæ¯”å¦‚çƒ­æ›´æ–°ä¸€ä¸ªæ¨¡å—è€Œæ— éœ€é‡å¯æœåŠ¡ã€‚</p></li><li class="lvl-2"><p>ä¸¾ä¾‹ï¼š<br>Web å®¹å™¨ï¼ˆå¦‚ Tomcatï¼‰çš„åº”ç”¨é‡æ–°éƒ¨ç½²<br>ä½¿ç”¨ URLClassLoader åŠ è½½æŸä¸ªæ¨¡å—çš„æ–°ç‰ˆæœ¬ä»¥å®ç°çƒ­æ›¿æ¢</p></li><li class="lvl-2"><p>ä¸ºä»€ä¹ˆä¸èƒ½æ”¾å…¥ classpathï¼Ÿ<br>classpath åœ¨å¯åŠ¨æ—¶å°±å›ºå®šäº†ï¼Œä¸èƒ½åŠ¨æ€æ·»åŠ ï¼›è€Œ URLClassLoader å¯ä»¥è¿è¡Œæ—¶åŠ è½½æ–° jarã€‚</p></li></ul><h3 id="3-å¤šç‰ˆæœ¬éš”ç¦»">3. å¤šç‰ˆæœ¬éš”ç¦»</h3><ul class="lvl-0"><li class="lvl-2"><p>åœºæ™¯è¯´æ˜ï¼š<br>ä½ å¸Œæœ›ä¸åŒçš„æ¨¡å—ä½¿ç”¨åŒä¸€ä¸ªåº“çš„ä¸åŒç‰ˆæœ¬ï¼Œä½† classpath æ— æ³•æ”¯æŒä¸¤ä¸ªç‰ˆæœ¬çš„åŒä¸€ä¸ªç±»ã€‚</p></li><li class="lvl-2"><p>ä¸¾ä¾‹ï¼š<br>ä¸€ä¸ªæœåŠ¡å™¨è¿è¡Œå¤šä¸ªæœåŠ¡å®ä¾‹ï¼Œå®ƒä»¬åˆ†åˆ«ä¾èµ– log4j çš„ä¸åŒç‰ˆæœ¬<br>ä¸€ä¸ªç³»ç»Ÿçš„æ’ä»¶ A ä½¿ç”¨ fastjson 1.xï¼Œæ’ä»¶ B ä½¿ç”¨ fastjson 2.x</p></li><li class="lvl-2"><p>ä¸ºä»€ä¹ˆä¸èƒ½æ”¾å…¥ classpathï¼Ÿ<br>classpath æ˜¯å…±äº«çš„ï¼Œä¼šå‘ç”Ÿç±»å†²çªã€‚ä½¿ç”¨å¤šä¸ª URLClassLoaderï¼Œå¯å®ç°ç±»éš”ç¦»ã€‚</p></li></ul><h3 id="4-è„šæœ¬æˆ–ç”¨æˆ·ä¸Šä¼ ä»£ç æ‰§è¡Œ">4. è„šæœ¬æˆ–ç”¨æˆ·ä¸Šä¼ ä»£ç æ‰§è¡Œ</h3><ul class="lvl-0"><li class="lvl-2"><p>åœºæ™¯è¯´æ˜ï¼š<br>ç³»ç»Ÿå…è®¸ç”¨æˆ·ä¸Šä¼  jar æˆ– class æ–‡ä»¶ï¼Œç„¶ååœ¨æœåŠ¡ç«¯æ‰§è¡Œå…¶ä¸­çš„ç±»é€»è¾‘ã€‚</p></li><li class="lvl-2"><p>ä¸¾ä¾‹ï¼š<br>åœ¨çº¿ç¼–ç¨‹å¹³å°ï¼ˆå¦‚ LeetCode åç«¯ï¼‰<br>ç”¨æˆ·ä¸Šä¼ ç®—æ³• jarï¼Œå¹³å°è¿è¡Œå¹¶è¿”å›ç»“æœ</p></li><li class="lvl-2"><p>ä¸ºä»€ä¹ˆä¸èƒ½æ”¾å…¥ classpathï¼Ÿ<br>ç”¨æˆ·ä¸Šä¼ å†…å®¹æ˜¯åŠ¨æ€çš„ï¼Œç³»ç»Ÿåœ¨è¿è¡Œå‰æ— æ³•é¢„çŸ¥ã€‚</p></li></ul><h3 id="5-å®ç°ç±»çš„å»¶è¿ŸåŠ è½½ï¼ˆèŠ‚çœèµ„æºï¼‰">5. å®ç°ç±»çš„å»¶è¿ŸåŠ è½½ï¼ˆèŠ‚çœèµ„æºï¼‰</h3><ul class="lvl-0"><li class="lvl-2"><p>åœºæ™¯è¯´æ˜ï¼š<br>æŸäº›ç±»/æ¨¡å—ä½“ç§¯è¾ƒå¤§æˆ–ä¾èµ–è¾ƒå¤šï¼Œä¸å¸Œæœ›åœ¨ç¨‹åºå¯åŠ¨æ—¶å°±åŠ è½½ï¼Œåªæœ‰çœŸæ­£ä½¿ç”¨æ—¶å†åŠ è½½ã€‚</p></li><li class="lvl-2"><p>ä¸¾ä¾‹ï¼š<br>å¤§å‹æ¡Œé¢åº”ç”¨ï¼ˆå¦‚ IntelliJï¼‰åœ¨æ‰“å¼€æŸä¸ªåŠŸèƒ½æ¨¡å—æ—¶æ‰åŠ è½½ç›¸åº” jar</p></li></ul><h3 id="æ€»ç»“">æ€»ç»“</h3><table><thead><tr><th>åœºæ™¯</th><th>ä½¿ç”¨ <code>URLClassLoader</code> çš„åŸå› </th></tr></thead><tbody><tr><td>æ’ä»¶ç³»ç»Ÿ</td><td>æ’ä»¶åŠ¨æ€åŠ è½½ï¼Œä¸åœ¨é¡¹ç›®ç¼–è¯‘æ—¶å¯çŸ¥</td></tr><tr><td>çƒ­éƒ¨ç½²</td><td>åŠ¨æ€æ›¿æ¢æ¨¡å—ï¼Œæ— éœ€é‡å¯</td></tr><tr><td>å¤šç‰ˆæœ¬å…±å­˜</td><td>é¿å…ç±»å†²çªï¼Œå®ç°ç±»åŠ è½½éš”ç¦»</td></tr><tr><td>ç”¨æˆ·ä¸Šä¼  jar</td><td>å†…å®¹åŠ¨æ€ç”Ÿæˆï¼Œclasspath æ— æ³•é¢„å…ˆé…ç½®</td></tr><tr><td>å»¶è¿ŸåŠ è½½æ¨¡å—</td><td>å¯åŠ¨æ›´å¿«ï¼ŒèŠ‚çœå†…å­˜</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>å¦‚æœä½ æ˜¯åœ¨åšæ¡†æ¶è®¾è®¡æˆ–éœ€è¦åŠ¨æ€æ‰©å±•èƒ½åŠ›çš„åœºæ™¯ï¼Œç†è§£å¹¶ä½¿ç”¨ URLClassLoader ä¼šéå¸¸æœ‰å¸®åŠ©ã€‚</p></li></ul><h3 id="åœºæ™¯å‡è®¾">åœºæ™¯å‡è®¾</h3><h4 id="è°ƒç”¨å¤–éƒ¨jar">è°ƒç”¨å¤–éƒ¨jar</h4><ul class="lvl-0"><li class="lvl-2"><p>æˆ‘ä»¬æœ‰ä¸€ä¸ªå¤–éƒ¨ jar æ–‡ä»¶ï¼šhello-plugin.jarï¼Œå®ƒåŒ…å«ä¸€ä¸ªç±»ï¼š</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™ä¸ªç±»ç¼–è¯‘åæ‰“åŒ…è¿› hello-plugin.jar</span></span><br><span class="line"><span class="keyword">package</span> com.example.plugin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloPlugin</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello from plugin! :&quot;</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ä¸»ç¨‹åºä½¿ç”¨ URLClassLoader åŠ¨æ€åŠ è½½è¿™ä¸ª jar</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLClassLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PluginLoader</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// å¤–éƒ¨ jar çš„è·¯å¾„</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">jarFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;plugins/hello-plugin.jar&quot;</span>);</span><br><span class="line">        <span class="type">URL</span> <span class="variable">jarUrl</span> <span class="operator">=</span> jarFile.toURI().toURL();</span><br><span class="line">        <span class="comment">// HTTPS jar çš„ URL</span></span><br><span class="line">        <span class="comment">// URL jarUrl = new URL(&quot;https://your-domain.com/libs/hello-plugin.jar&quot;);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ„å»º URLClassLoaderï¼ˆä¹Ÿå¯ä»¥è®¾ç½®çˆ¶åŠ è½½å™¨ï¼‰</span></span><br><span class="line">        <span class="type">URLClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URLClassLoader</span>(<span class="keyword">new</span> <span class="title class_">URL</span>[]&#123;jarUrl&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åŠ è½½æ’ä»¶ç±»</span></span><br><span class="line">        Class&lt;?&gt; clazz = classLoader.loadClass(<span class="string">&quot;com.example.plugin.HelloPlugin&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºå®ä¾‹å¹¶è°ƒç”¨æ–¹æ³•</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">plugin</span> <span class="operator">=</span> clazz.getDeclaredConstructor().newInstance();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">sayHello</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;sayHello&quot;</span>, String.class);</span><br><span class="line">        sayHello.invoke(plugin, <span class="string">&quot;World&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å…³é—­ ClassLoaderï¼ˆJava 7+ æ¨èï¼‰</span></span><br><span class="line">        classLoader.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è¿è¡Œæ—¶åŠ¨æ€ç¼–è¯‘-Java-æºä»£ç ">è¿è¡Œæ—¶åŠ¨æ€ç¼–è¯‘ Java æºä»£ç </h4><ul class="lvl-0"><li class="lvl-2"><p>æˆ‘ä»¬æœ‰ä¸€ä¸ª java ä»£ç ç‰‡æ®µï¼š</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.tools.JavaCompiler;</span><br><span class="line"><span class="keyword">import</span> javax.tools.ToolProvider;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLClassLoader;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicJavaRunner</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> <span class="string">&quot;com.example.dynamic.Hello&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Java æºä»£ç </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">sourceCode</span> <span class="operator">=</span></span><br><span class="line">                <span class="string">&quot;package com.example.dynamic;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;public class Hello &#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;    public void say() &#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        System.out.println(\&quot;Hello from dynamic source!\&quot;);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;&#125;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸´æ—¶ç›®å½•</span></span><br><span class="line">        <span class="type">Path</span> <span class="variable">tempDir</span> <span class="operator">=</span> Files.createTempDirectory(<span class="string">&quot;dynamic-classes&quot;</span>);</span><br><span class="line">        <span class="type">File</span> <span class="variable">outputDir</span> <span class="operator">=</span> tempDir.toFile();</span><br><span class="line">        <span class="comment">// System.out.println(&quot;ä¸´æ—¶ç›®å½•ï¼š&quot; + outputDir.getAbsolutePath());</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»º .java æ–‡ä»¶</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">javaFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(outputDir, <span class="string">&quot;com/example/dynamic/Hello.java&quot;</span>);</span><br><span class="line">        javaFile.getParentFile().mkdirs();</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">FileWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(javaFile)) &#123;</span><br><span class="line">            writer.write(sourceCode);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç¼–è¯‘ Java æ–‡ä»¶</span></span><br><span class="line">        <span class="type">JavaCompiler</span> <span class="variable">compiler</span> <span class="operator">=</span> ToolProvider.getSystemJavaCompiler();</span><br><span class="line">        <span class="keyword">if</span> (compiler == <span class="literal">null</span>) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;è¯·ç”¨ JDK è€Œé JRE è¿è¡Œï¼&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> compiler.run(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, javaFile.getPath());</span><br><span class="line">        <span class="keyword">if</span> (result != <span class="number">0</span>) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;ç¼–è¯‘å¤±è´¥ï¼&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åŠ è½½ç±»å¹¶è°ƒç”¨</span></span><br><span class="line">        <span class="type">URLClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URLClassLoader</span>(<span class="keyword">new</span> <span class="title class_">URL</span>[]&#123;outputDir.toURI().toURL()&#125;);</span><br><span class="line">        Class&lt;?&gt; clazz = classLoader.loadClass(className);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> clazz.getDeclaredConstructor().newInstance();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;say&quot;</span>);</span><br><span class="line">        method.invoke(instance);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¸…ç†ï¼ˆå¯é€‰ï¼‰</span></span><br><span class="line">        classLoader.close();</span><br><span class="line">        <span class="comment">// åˆ é™¤ä¸´æ—¶ç›®å½•</span></span><br><span class="line">        Files.walk(outputDir.toPath())</span><br><span class="line">                .sorted(Comparator.reverseOrder()) <span class="comment">// å…ˆåˆ æ–‡ä»¶ï¼Œå†åˆ ç›®å½•</span></span><br><span class="line">                .map(Path::toFile)</span><br><span class="line">                .forEach(File::delete);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å…³é”®ç‚¹è¯´æ˜</p></li></ul><table><thead><tr><th>æœºåˆ¶</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>JavaCompiler</code></td><td>JDK è‡ªå¸¦çš„ç¼–è¯‘å™¨ï¼ˆ<code>tools.jar</code>ï¼‰</td></tr><tr><td><code>ToolProvider.getSystemJavaCompiler()</code></td><td>åªèƒ½åœ¨ JDK ç¯å¢ƒä¸­å·¥ä½œï¼ŒJRE æ— æ³•ä½¿ç”¨</td></tr><tr><td><code>URLClassLoader</code></td><td>ç”¨äºåŠ è½½ç¼–è¯‘åçš„ .class æ–‡ä»¶</td></tr><tr><td><code>FileWriter</code></td><td>ä¿å­˜ä»£ç ä¸ºä¸´æ—¶ Java æ–‡ä»¶</td></tr></tbody></table><h2 id="è‡ªå®šä¹‰ç±»åŠ è½½å™¨">è‡ªå®šä¹‰ç±»åŠ è½½å™¨</h2><ul class="lvl-0"><li class="lvl-2"><p>è¦è‡ªå®šä¹‰ ClassLoaderï¼Œåªéœ€è¦ç»§æ‰¿äº <code>ClassLoader</code> æˆ–è€… <code>SecureClassLoader</code>ï¼Œå¹¶é‡å†™ <code>findClass()</code> æ–¹æ³•å³å¯</p></li><li class="lvl-2"><p>ç¤ºä¾‹ï¼šæˆ‘ä»¬å¯¹ä¸Šé¢çš„ä»£ç è¿›è¡Œå‡çº§ï¼Œä¸åˆ›å»ºä¸´æ—¶æ–‡ä»¶ï¼Œè€Œæ˜¯åœ¨å†…å­˜ä¸­ç¼–è¯‘ä»£ç ï¼Œå¹¶ä»å†…å­˜ä¸­åŠ è½½å­—èŠ‚ç ï¼Œè€Œä¸ä¾èµ–ç£ç›˜æ–‡ä»¶ï¼Œæ›´é«˜æ•ˆä¹Ÿæ›´é€‚åˆç”Ÿäº§ç¯å¢ƒä¸­åŠ¨æ€ç±»åŠ è½½ï¼ˆå¦‚åœ¨çº¿ä»£ç æ‰§è¡Œã€è„šæœ¬å¼•æ“ç­‰ï¼‰ã€‚</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.tools.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InMemoryJavaRunner</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> <span class="string">&quot;com.example.dynamic.Hello&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sourceCode</span> <span class="operator">=</span></span><br><span class="line">                <span class="string">&quot;package com.example.dynamic;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;public class Hello &#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;    public void say() &#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        System.out.println(\&quot;Hello from memory compiled class!\&quot;);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–ç³»ç»Ÿ Java ç¼–è¯‘å™¨</span></span><br><span class="line">        <span class="type">JavaCompiler</span> <span class="variable">compiler</span> <span class="operator">=</span> ToolProvider.getSystemJavaCompiler();</span><br><span class="line">        <span class="keyword">if</span> (compiler == <span class="literal">null</span>) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;è¯·ä½¿ç”¨ JDK è¿è¡Œæ­¤ç¨‹åºï¼ˆé JREï¼‰&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‡†å¤‡ç¼–è¯‘æºä»£ç ï¼šä¸€ä¸ª JavaFileObject è¡¨ç¤ºæºä»£ç </span></span><br><span class="line">        <span class="type">JavaFileObject</span> <span class="variable">sourceFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JavaSourceFromString</span>(className, sourceCode);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºè‡ªå®šä¹‰çš„å†…å­˜æ–‡ä»¶ç®¡ç†å™¨ï¼ˆæ›¿ä»£æ ‡å‡†çš„ç£ç›˜ç®¡ç†å™¨ï¼‰</span></span><br><span class="line">        <span class="type">StandardJavaFileManager</span> <span class="variable">standardFileManager</span> <span class="operator">=</span> compiler.getStandardFileManager(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">MemoryJavaFileManager</span> <span class="variable">fileManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MemoryJavaFileManager</span>(standardFileManager);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ‰§è¡Œç¼–è¯‘ä»»åŠ¡</span></span><br><span class="line">        JavaCompiler.<span class="type">CompilationTask</span> <span class="variable">task</span> <span class="operator">=</span> compiler.getTask(<span class="literal">null</span>, fileManager, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, Collections.singletonList(sourceFile));</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> task.call();</span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;ç¼–è¯‘å¤±è´¥ï¼&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åŠ è½½ç¼–è¯‘åçš„ç±»</span></span><br><span class="line">        Map&lt;String, <span class="type">byte</span>[]&gt; classBytes = fileManager.getClassBytes();</span><br><span class="line">        <span class="type">InMemoryClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryClassLoader</span>(classBytes);</span><br><span class="line">        Class&lt;?&gt; clazz = classLoader.loadClass(className);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> clazz.getDeclaredConstructor().newInstance();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;say&quot;</span>);</span><br><span class="line">        method.invoke(instance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨äºè¡¨ç¤ºå†…å­˜ä¸­çš„ Java æºä»£ç </span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">JavaSourceFromString</span> <span class="keyword">extends</span> <span class="title class_">SimpleJavaFileObject</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> String code;</span><br><span class="line"></span><br><span class="line">        JavaSourceFromString(String className, String code) &#123;</span><br><span class="line">            <span class="built_in">super</span>(URI.create(<span class="string">&quot;string:///&quot;</span> + className.replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>) + Kind.SOURCE.extension), Kind.SOURCE);</span><br><span class="line">            <span class="built_in">this</span>.code = code;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> CharSequence <span class="title function_">getCharContent</span><span class="params">(<span class="type">boolean</span> ignoreEncodingErrors)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> code;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†ç¼–è¯‘çš„ class æ–‡ä»¶ä¿å­˜åœ¨å†…å­˜ä¸­ï¼ˆä¸æ˜¯æ–‡ä»¶ç³»ç»Ÿï¼‰</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MemoryJavaFileManager</span> <span class="keyword">extends</span> <span class="title class_">ForwardingJavaFileManager</span>&lt;StandardJavaFileManager&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ByteArrayOutputStream&gt; classOutputBuffers = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        MemoryJavaFileManager(StandardJavaFileManager standardManager) &#123;</span><br><span class="line">            <span class="built_in">super</span>(standardManager);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> JavaFileObject <span class="title function_">getJavaFileForOutput</span><span class="params">(Location location, String className,</span></span><br><span class="line"><span class="params">                                                   JavaFileObject.Kind kind, FileObject sibling)</span> &#123;</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            classOutputBuffers.put(className, outputStream);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleJavaFileObject</span>(</span><br><span class="line">                    URI.create(<span class="string">&quot;mem:///&quot;</span> + className.replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>) + kind.extension), kind) &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> OutputStream <span class="title function_">openOutputStream</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> outputStream;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Map&lt;String, <span class="type">byte</span>[]&gt; getClassBytes() &#123;</span><br><span class="line">            Map&lt;String, <span class="type">byte</span>[]&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, ByteArrayOutputStream&gt; entry : classOutputBuffers.entrySet()) &#123;</span><br><span class="line">                result.put(entry.getKey(), entry.getValue().toByteArray());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è‡ªå®šä¹‰ ClassLoaderï¼Œç”¨äºä»å†…å­˜ä¸­åŠ è½½å­—èŠ‚ç </span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">InMemoryClassLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, <span class="type">byte</span>[]&gt; classBytes;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">InMemoryClassLoader</span><span class="params">(Map&lt;String, <span class="type">byte</span>[]&gt; classBytes)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(ClassLoader.getSystemClassLoader());</span><br><span class="line">            <span class="built_in">this</span>.classBytes = classBytes;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">            <span class="comment">// ä»å†…å­˜ä¸­è·å–å­—èŠ‚ç </span></span><br><span class="line">            <span class="type">byte</span>[] bytes = classBytes.get(name);</span><br><span class="line">            <span class="keyword">if</span> (bytes == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">super</span>.findClass(name);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å®šä¹‰ç±»å¹¶è¿”å›ï¼Œä¸€å®šè¦ä½¿ç”¨ defineClass æ–¹æ³•</span></span><br><span class="line">            <span class="keyword">return</span> defineClass(name, bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>è¿›ä¸€æ­¥å‡çº§ï¼šæˆ‘ä»¬ç°åœ¨å°†è¿™ä¸ªç³»ç»Ÿæ‰©å±•ä¸ºæ”¯æŒå¤šä¸ªç±»åŒæ—¶åŠ¨æ€ç¼–è¯‘ã€å†…å­˜åŠ è½½å¹¶æ‰§è¡Œã€‚è¿™å¯¹äºéœ€è¦å¤„ç†å¤šä¸ªç±»ï¼ˆä¾‹å¦‚æ¥å£ + å®ç°ã€å†…éƒ¨ä¾èµ–ç­‰ï¼‰éå¸¸å®ç”¨ã€‚</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.tools.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸»ç±»</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MultiClassInMemoryCompiler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// å‡†å¤‡å¤šä¸ªç±»çš„æºä»£ç </span></span><br><span class="line">        Map&lt;String, String&gt; sources = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        sources.put(<span class="string">&quot;com.example.api.Greeter&quot;</span>,</span><br><span class="line">                <span class="string">&quot;package com.example.api;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;public interface Greeter &#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;    void greet();\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;&#125;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        sources.put(<span class="string">&quot;com.example.impl.EnglishGreeter&quot;</span>,</span><br><span class="line">                <span class="string">&quot;package com.example.impl;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;import com.example.api.Greeter;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;public class EnglishGreeter implements Greeter &#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;    public void greet() &#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        System.out.println(\&quot;Hello from EnglishGreeter!\&quot;);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;&#125;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">entryClassName</span> <span class="operator">=</span> <span class="string">&quot;com.example.impl.EnglishGreeter&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç¼–è¯‘</span></span><br><span class="line">        Map&lt;String, <span class="type">byte</span>[]&gt; compiledClasses = compile(sources);</span><br><span class="line">        <span class="keyword">if</span> (compiledClasses == <span class="literal">null</span>) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;ç¼–è¯‘å¤±è´¥&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åŠ è½½å¹¶æ‰§è¡Œ</span></span><br><span class="line">        <span class="type">InMemoryClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryClassLoader</span>(compiledClasses);</span><br><span class="line">        Class&lt;?&gt; clazz = classLoader.loadClass(entryClassName);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> clazz.getDeclaredConstructor().newInstance();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> clazz.getMethod(<span class="string">&quot;greet&quot;</span>);</span><br><span class="line">        method.invoke(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¼–è¯‘å™¨å…¥å£ï¼Œæ”¯æŒå¤šä¸ªç±»</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, <span class="type">byte</span>[]&gt; compile(Map&lt;String, String&gt; sources) &#123;</span><br><span class="line">        <span class="type">JavaCompiler</span> <span class="variable">compiler</span> <span class="operator">=</span> ToolProvider.getSystemJavaCompiler();</span><br><span class="line">        <span class="keyword">if</span> (compiler == <span class="literal">null</span>) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;è¯·ä½¿ç”¨ JDK è¿è¡Œ&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;JavaFileObject&gt; compilationUnits = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : sources.entrySet()) &#123;</span><br><span class="line">            compilationUnits.add(<span class="keyword">new</span> <span class="title class_">JavaSourceFromString</span>(entry.getKey(), entry.getValue()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">StandardJavaFileManager</span> <span class="variable">stdManager</span> <span class="operator">=</span> compiler.getStandardFileManager(<span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">MemoryJavaFileManager</span> <span class="variable">memManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MemoryJavaFileManager</span>(stdManager);</span><br><span class="line"></span><br><span class="line">        JavaCompiler.<span class="type">CompilationTask</span> <span class="variable">task</span> <span class="operator">=</span> compiler.getTask(<span class="literal">null</span>, memManager, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, compilationUnits);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> task.call();</span><br><span class="line">        <span class="keyword">return</span> success ? memManager.getClassBytes() : <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æºæ–‡ä»¶è¡¨ç¤ºï¼ˆJava ä»£ç ä»¥å­—ç¬¦ä¸²æä¾›ï¼‰</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">JavaSourceFromString</span> <span class="keyword">extends</span> <span class="title class_">SimpleJavaFileObject</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> String code;</span><br><span class="line"></span><br><span class="line">        JavaSourceFromString(String className, String code) &#123;</span><br><span class="line">            <span class="built_in">super</span>(URI.create(<span class="string">&quot;string:///&quot;</span> + className.replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>) + Kind.SOURCE.extension), Kind.SOURCE);</span><br><span class="line">            <span class="built_in">this</span>.code = code;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> CharSequence <span class="title function_">getCharContent</span><span class="params">(<span class="type">boolean</span> ignoreEncodingErrors)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> code;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†…å­˜ä¸­çš„ç¼–è¯‘è¾“å‡ºç®¡ç†å™¨</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MemoryJavaFileManager</span> <span class="keyword">extends</span> <span class="title class_">ForwardingJavaFileManager</span>&lt;StandardJavaFileManager&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ByteArrayOutputStream&gt; classOutputBuffers = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        MemoryJavaFileManager(StandardJavaFileManager standardManager) &#123;</span><br><span class="line">            <span class="built_in">super</span>(standardManager);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> JavaFileObject <span class="title function_">getJavaFileForOutput</span><span class="params">(Location location, String className,</span></span><br><span class="line"><span class="params">                                                   JavaFileObject.Kind kind, FileObject sibling)</span> &#123;</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            classOutputBuffers.put(className, outputStream);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleJavaFileObject</span>(</span><br><span class="line">                    URI.create(<span class="string">&quot;mem:///&quot;</span> + className.replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>) + kind.extension), kind) &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> OutputStream <span class="title function_">openOutputStream</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> outputStream;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Map&lt;String, <span class="type">byte</span>[]&gt; getClassBytes() &#123;</span><br><span class="line">            Map&lt;String, <span class="type">byte</span>[]&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, ByteArrayOutputStream&gt; entry : classOutputBuffers.entrySet()) &#123;</span><br><span class="line">                result.put(entry.getKey(), entry.getValue().toByteArray());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨äºåŠ è½½å†…å­˜ä¸­çš„ class</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">InMemoryClassLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, <span class="type">byte</span>[]&gt; classBytes;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">InMemoryClassLoader</span><span class="params">(Map&lt;String, <span class="type">byte</span>[]&gt; classBytes)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(ClassLoader.getSystemClassLoader());</span><br><span class="line">            <span class="built_in">this</span>.classBytes = classBytes;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">            <span class="type">byte</span>[] bytes = classBytes.get(name);</span><br><span class="line">            <span class="keyword">if</span> (bytes == <span class="literal">null</span>) <span class="keyword">return</span> <span class="built_in">super</span>.findClass(name);</span><br><span class="line">            <span class="keyword">return</span> defineClass(name, bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ‰“ç ´åŒäº²å§”æ´¾ï¼Œå®ç°åŒç±»å¤šç‰ˆæœ¬å…±å­˜">æ‰“ç ´åŒäº²å§”æ´¾ï¼Œå®ç°åŒç±»å¤šç‰ˆæœ¬å…±å­˜</h2><ul class="lvl-0"><li class="lvl-2"><p>å‡è®¾æˆ‘ä»¬æœ‰åŒä¸€ä¸ªjaråŒ…çš„ä¸åŒç‰ˆæœ¬ï¼Œæ¯”å¦‚ï¼š<code>a-1.0.jar</code>å’Œ<code>a-2.0.jar</code>ï¼Œä»–ä»¬å…·æœ‰åŒåçš„ <code>DemoClass</code>ç±» ,ç³»ç»Ÿ<code>classpath</code>ä¸­å¼•å…¥çš„æ˜¯ <code>a-1.0.jar</code>ï¼Œè€Œæ­¤æ—¶æˆ‘ä»¬é€šè¿‡â¾ƒå®šçš„ClassLoaderåŠ è½½ <code>a-2.0.jar</code>ï¼Œå¹¶è°ƒç”¨ <code>DemoClass</code>ç±» ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œâ¾ƒå®šçš„ClassLoaderåŠ è½½çš„ç±»ä¾æ—§æ˜¯ <code>a-1.0.jar</code> ä¸­çš„ç±»ï¼Œè€Œä¸æ˜¯ <code>a-2.0.jar</code> ä¸­çš„ç±»ã€‚</p></li><li class="lvl-2"><p>ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µå‘¢ï¼Ÿè¿™å°±æ˜¯å› ä¸ºJDKçš„åŒäº²å§”æ´¾æœºåˆ¶ã€‚â¾ƒå®šçš„ClassLoaderçš„<code>parent</code>å±æ€§æŒ‡å‘çš„æ˜¯JDKå†…çš„<code>AppClassLoader</code>ï¼Œâ½½ <code>AppClassLoader</code> ä¼šåŠ è½½ç³»ç»Ÿå½“ä¸­çš„æ‰€æœ‰ä»£ç ï¼Œå°±åŒ…æ‹¬ <code>a-1.0.jar</code>ä¸­çš„ <code>DemoClass</code>ç±»ã€‚è¿™æ—¶ï¼Œâ¾ƒå®šçš„ClassLoaderå»åŠ è½½ <code>DemoClass</code>ç±»æ—¶ï¼Œé€šè¿‡åŒäº²å§”æ´¾å‘ä¸ŠæŸ¥æ‰¾ï¼Œâ¾ƒç„¶åŠ è½½å‡ºæ¥çš„å°±æ˜¯APPClassloaderä¸­çš„<code>DemoClass</code>äº†ã€‚</p></li><li class="lvl-2"><p>å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡é‡å†™ <code>loadClass()</code>æ–¹æ³•ï¼Œæ¥æ‰“ç ´åŒäº²å§”æ´¾ï¼Œå®ç°ç±»â½‚ä»¶çš„åŠ è½½ã€‚</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLConnection;</span><br><span class="line"><span class="keyword">import</span> java.security.SecureClassLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomClassLoader</span> <span class="keyword">extends</span> <span class="title class_">SecureClassLoader</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> URL jarUrl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomClassLoader</span><span class="params">(URL jarUrl)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„å­ç±»åŠ è½½å™¨ï¼ŒåªåŠ è½½æŒ‡å®š JAR</span></span><br><span class="line">        <span class="built_in">this</span>.jarUrl = jarUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; loadClass(String name, <span class="type">boolean</span> resolve) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">// æŠŠåŒäº²å§”æ´¾æœºåˆ¶åè¿‡æ¥ï¼Œå…ˆåˆ°â¼¦ç±»åŠ è½½å™¨ä¸­åŠ è½½ï¼ŒåŠ è½½ä¸åˆ°å†å»â½—ç±»åŠ è½½å™¨ä¸­åŠ è½½ã€‚</span></span><br><span class="line">        <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœç±»å·²åŠ è½½ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">            Class&lt;?&gt; loadedClass = findLoadedClass(name);</span><br><span class="line">            <span class="keyword">if</span> (loadedClass == <span class="literal">null</span>) &#123;</span><br><span class="line">                loadedClass = findClass(name);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨</span></span><br><span class="line">                loadedClass = <span class="built_in">super</span>.loadClass(name, resolve);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> loadedClass;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) &#123;</span><br><span class="line">        <span class="type">int</span> code;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è®¿é—®jaråŒ…çš„url</span></span><br><span class="line">            <span class="type">URLConnection</span> <span class="variable">urlConnection</span> <span class="operator">=</span> jarUrl.openConnection();</span><br><span class="line">            urlConnection.setUseCaches(<span class="literal">false</span>);</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> urlConnection.getInputStream();</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="keyword">while</span> ((code = is.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">                bos.write(code);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">byte</span>[] data = bos.toByteArray();</span><br><span class="line">            is.close();</span><br><span class="line">            bos.close();</span><br><span class="line">            <span class="keyword">return</span> defineClass(name, data, <span class="number">0</span>, data.length);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æµ‹è¯•ä»£ç </p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">jarFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;path/to/a-2.0.jar&quot;</span>);</span><br><span class="line">        <span class="type">URL</span> <span class="variable">jarUrl</span> <span class="operator">=</span> jarFile.toURI().toURL();</span><br><span class="line"></span><br><span class="line">        <span class="type">CustomClassLoader</span> <span class="variable">loader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomClassLoader</span>(jarUrl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åŠ è½½ DemoClass</span></span><br><span class="line">        Class&lt;?&gt; clazz = loader.loadClass(<span class="string">&quot;com.example.DemoClass&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> clazz.getDeclaredConstructor().newInstance();</span><br><span class="line">        clazz.getMethod(<span class="string">&quot;print&quot;</span>).invoke(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶çš„å…¸å‹åœºæ™¯">æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶çš„å…¸å‹åœºæ™¯</h3><h4 id="Tomcatç±»åŠ è½½å™¨">Tomcatç±»åŠ è½½å™¨</h4><p><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/eGKhDn.png" alt="" width="550" height="700"></p><ul class="lvl-0"><li class="lvl-2"><p>CommonClassLoaderï¼šTomcatæœ€åŸºæœ¬çš„ç±»åŠ è½½å™¨ï¼ŒåŠ è½½è·¯å¾„ä¸­çš„classå¯ä»¥è¢«Tomcatå®¹å™¨æœ¬èº«ä»¥åŠå„ä¸ªWebappè®¿é—®ï¼›</p></li><li class="lvl-2"><p>CatalinaClassLoaderï¼šTomcatå®¹å™¨ç§æœ‰çš„ç±»åŠ è½½å™¨ï¼ŒåŠ è½½è·¯å¾„ä¸­çš„classå¯¹äºWebappä¸å¯â»…ï¼›</p></li><li class="lvl-2"><p>SharedClassLoaderï¼šå„ä¸ªWebappå…±äº«çš„ç±»åŠ è½½å™¨ï¼ŒåŠ è½½è·¯å¾„ä¸­çš„classå¯¹äºæ‰€æœ‰Webappå¯â»…ï¼Œä½†æ˜¯å¯¹äºTomcatå®¹å™¨ä¸å¯â»…ï¼›</p></li><li class="lvl-2"><p>WebappClassLoaderï¼šå„ä¸ªWebappç§æœ‰çš„ç±»åŠ è½½å™¨ï¼ŒåŠ è½½è·¯å¾„ä¸­çš„classåªå¯¹å½“å‰Webappå¯â»…ï¼Œâ½å¦‚åŠ è½½waråŒ…â¾¥ç›¸å…³çš„ç±»ï¼Œæ¯ä¸ªwaråŒ…åº”â½¤éƒ½æœ‰â¾ƒâ¼°çš„WebappClassLoaderï¼Œå®ç°ç›¸äº’éš”ç¦»ï¼Œâ½å¦‚ä¸åŒwaråŒ…åº”â½¤å¼•â¼Šäº†ä¸åŒçš„springç‰ˆæœ¬ï¼Œè¿™æ ·å®ç°å°±èƒ½åŠ è½½å„â¾ƒçš„springç‰ˆæœ¬ï¼›</p></li><li class="lvl-2"><p>Jspç±»åŠ è½½å™¨ï¼šé’ˆå¯¹æ¯ä¸ªJSPâ»šâ¾¯åˆ›å»ºâ¼€ä¸ªåŠ è½½å™¨ã€‚è¿™ä¸ªåŠ è½½å™¨â½è¾ƒè½»é‡çº§ï¼Œæ‰€ä»¥Tomcatè¿˜å®ç°äº†çƒ­åŠ è½½ï¼Œä¹Ÿå°±æ˜¯JSPåªè¦ä¿®æ”¹äº†ï¼Œå°±åˆ›å»ºâ¼€ä¸ªæ–°çš„åŠ è½½å™¨ï¼Œä»â½½å®ç°äº†JSPâ»šâ¾¯çš„çƒ­æ›´æ–°ã€‚</p></li></ul>]]></content>
    
    
    <summary type="html">&lt;!--
 **åŠ ç²—**
 *æ–œä½“*
 ***åŠ ç²—å¹¶æ–œä½“***
 ~~åˆ é™¤çº¿~~
 ==çªå‡ºæ˜¾ç¤º==
 `çªå‡ºæ˜¾ç¤º(æ¨è)`
 ++ä¸‹åˆ’çº¿++
 ~ä¸‹æ ‡~
 ^ä¸Šæ ‡^
 è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.
 å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **ç‚¹å‡»æŠ˜å **
 è¿™æ˜¯è¢«éšè—çš„å†…å®¹
 +++

::: tips success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
:::

% note info % success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
% endnote %

å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}
 å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ
 --&gt;
&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;æœ¬æ–‡ä»‹ç»JVMçš„ç±»åŠ è½½å™¨&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.oracle.com/javase/specs/jvms/se8/html/index.html&quot;&gt;JDK8 The JavaÂ® Virtual Machine Specification&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html&quot;&gt;JDK8çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.oracle.com/en/java/javase/17/docs/specs/man/index.html&quot;&gt;JDKâ¼¯å…·å®˜â½¹â½‚æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.oracle.com/en/java/javase/17/docs/specs/man/java.html&quot;&gt;JDK17çš„javaæŒ‡ä»¤çš„å®˜â½…â½‚æ¡£&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="jvm" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/jvm/"/>
    
    
    <category term="jvm" scheme="https://blog.hanqunfeng.com/tags/jvm/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch çš„ REST APIs:èšåˆæŸ¥è¯¢</title>
    <link href="https://blog.hanqunfeng.com/2025/04/22/elasticsearch-06-api-aggs/"/>
    <id>https://blog.hanqunfeng.com/2025/04/22/elasticsearch-06-api-aggs/</id>
    <published>2025-04-22T13:30:05.000Z</published>
    <updated>2025-04-24T02:53:13.488Z</updated>
    
    <content type="html"><![CDATA[<!-- **åŠ ç²—** *æ–œä½“* ***åŠ ç²—å¹¶æ–œä½“*** ~~åˆ é™¤çº¿~~ ==çªå‡ºæ˜¾ç¤º== `çªå‡ºæ˜¾ç¤º(æ¨è)` ++ä¸‹åˆ’çº¿++ ~ä¸‹æ ‡~ ^ä¸Šæ ‡^ è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference. å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **ç‚¹å‡»æŠ˜å ** è¿™æ˜¯è¢«éšè—çš„å†…å®¹ +++::: tips success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹:::% note info % success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹% endnote %å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{} å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ --><h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2"><p>æœ¬æ–‡ä»‹ç» Elasticsearch çš„ REST APIsï¼šèšåˆæŸ¥è¯¢</p></li><li class="lvl-2"><p>Elasticsearchç‰ˆæœ¬8.17.3</p></li><li class="lvl-2"><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.17/rest-apis.html">å®˜æ–¹æ–‡æ¡£:REST APIs</a></p></li><li class="lvl-2"><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.17/search-aggregations.html">å®˜æ–¹æ–‡æ¡£:Aggregations</a></p></li><li class="lvl-2"><a href="/2025/04/17/elasticsearch-05-api/" title="Elasticsearch çš„ REST APIs">Elasticsearch çš„ REST APIs</a></li></ul><span id="more"></span><h2 id="èšåˆæŸ¥è¯¢">èšåˆæŸ¥è¯¢</h2><ul class="lvl-0"><li class="lvl-2"><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html">èšåˆæŸ¥è¯¢</a>ï¼Œå¯ä»¥è®©æˆ‘ä»¬æå…¶æ–¹ä¾¿çš„å®ç°å¯¹ç´¢å¼•æ•°æ®çš„ç»Ÿè®¡ã€åˆ†æã€è¿ç®—ç­‰æ“ä½œã€‚</p></li><li class="lvl-2"><p>åŸºæœ¬è¯­æ³•åŒ…æ‹¬ä»¥ä¸‹éƒ¨åˆ†ï¼š</p><ul class="lvl-2"><li class="lvl-4">æŸ¥è¯¢æ¡ä»¶ï¼šæŒ‡å®šéœ€è¦èšåˆçš„æ–‡æ¡£ï¼Œå¯ä»¥ä½¿ç”¨æ ‡å‡†çš„ Elasticsearch æŸ¥è¯¢è¯­æ³•ï¼Œå¦‚ termã€matchã€range ç­‰ç­‰ã€‚</li><li class="lvl-4">èšåˆå‡½æ•°ï¼šæŒ‡å®šè¦æ‰§è¡Œçš„èšåˆæ“ä½œï¼Œå¦‚ sumã€avgã€minã€maxã€termsã€date_histogram ç­‰ç­‰ã€‚æ¯ä¸ªèšåˆå‘½ä»¤éƒ½ä¼šç”Ÿæˆä¸€ä¸ªèšåˆç»“æœã€‚</li><li class="lvl-4">èšåˆåµŒå¥—ï¼šèšåˆå‘½ä»¤å¯ä»¥åµŒå¥—ï¼Œä»¥ä¾¿æ›´ç»†ç²’åº¦åœ°åˆ†ææ•°æ®ã€‚</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET &lt;index_name&gt;/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;&lt;aggs_name&gt;&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;&lt;agg_type&gt;&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;&lt;field_name&gt;&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># è¯´æ˜</span></span><br><span class="line">  <span class="comment"># aggsï¼šèšåˆçš„æ ¹èŠ‚ç‚¹ï¼Œå›ºå®šå†™æ³•</span></span><br><span class="line">  <span class="comment"># aggs_nameï¼šèšåˆå‡½æ•°çš„åç§°ï¼Œè‡ªå·±éšæ„å®šä¹‰</span></span><br><span class="line">  <span class="comment"># agg_typeï¼šèšåˆç§ç±»ï¼Œæ¯”å¦‚æ˜¯æ¡¶èšåˆï¼ˆtermsï¼‰æˆ–è€…æ˜¯æŒ‡æ ‡èšåˆï¼ˆavgã€sumã€minã€maxç­‰ï¼‰</span></span><br><span class="line">  <span class="comment"># field_nameï¼šå­—æ®µåç§°æˆ–è€…å«åŸŸåã€‚</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>èšåˆçš„åˆ†ç±»</p><ul class="lvl-2"><li class="lvl-4">Metric Aggregationï¼šâ€”äº›æ•°å­¦è¿ç®—ï¼Œå¯ä»¥å¯¹æ–‡æ¡£å­—æ®µè¿›è¡Œç»Ÿè®¡åˆ†æï¼Œç±»æ¯”Mysqlä¸­çš„ min(), max(), sum() æ“ä½œã€‚</li><li class="lvl-4">Bucket Aggregationï¼šä¸€äº›æ»¡è¶³ç‰¹å®šæ¡ä»¶çš„æ–‡æ¡£çš„é›†åˆæ”¾ç½®åˆ°ä¸€ä¸ªæ¡¶é‡Œï¼Œæ¯ä¸€ä¸ªæ¡¶å…³è”ä¸€ä¸ªkeyï¼Œç±»æ¯”Mysqlä¸­çš„group byæ“ä½œã€‚</li><li class="lvl-4">Pipeline Aggregationï¼šå¯¹å…¶ä»–çš„èšåˆç»“æœè¿›è¡ŒäºŒæ¬¡èšåˆ</li></ul></li></ul><h2 id="ç¤ºä¾‹æ•°æ®å‡†å¤‡">ç¤ºä¾‹æ•°æ®å‡†å¤‡</h2><ul class="lvl-0"><li class="lvl-2"><p>æˆ‘ä»¬éœ€è¦å…ˆå‡†å¤‡ä¸€äº›æ•°æ®ï¼Œæ‰èƒ½è¿›è¡Œèšåˆåˆ†æã€‚</p></li><li class="lvl-2"><p>åˆ›å»ºç´¢å¼•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¦‚æœå­˜åœ¨å…ˆåˆ é™¤</span></span><br><span class="line">curl -X DELETE -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºç´¢å¼•</span></span><br><span class="line">curl -X PUT -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">    &quot;settings&quot;:&#123;</span></span><br><span class="line"><span class="string">      &quot;number_of_shards&quot;:&quot;1&quot;,</span></span><br><span class="line"><span class="string">      &quot;number_of_replicas&quot;:&quot;2&quot;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;mappings&quot;:&#123;</span></span><br><span class="line"><span class="string">      &quot;properties&quot;:&#123;</span></span><br><span class="line"><span class="string">        &quot;category&quot;:&#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;:&quot;keyword&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;price&quot;:&#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;:&quot;double&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;count&quot;:&#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;:&quot;integer&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;title&quot;:&#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;:&quot;text&quot;,</span></span><br><span class="line"><span class="string">          &quot;analyzer&quot;:&quot;ik_max_word&quot;,</span></span><br><span class="line"><span class="string">          &quot;search_analyzer&quot;:&quot;ik_smart&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;remark&quot;:&#123;</span></span><br><span class="line"><span class="string">        &quot;type&quot;:&quot;text&quot;,</span></span><br><span class="line"><span class="string">        &quot;analyzer&quot;:&quot;ik_max_word&quot;,</span></span><br><span class="line"><span class="string">        &quot;search_analyzer&quot;:&quot;ik_smart&quot;</span></span><br><span class="line"><span class="string">      &#125;,</span></span><br><span class="line"><span class="string">      &quot;address&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;type&quot;: &quot;text&quot;,</span></span><br><span class="line"><span class="string">        &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span></span><br><span class="line"><span class="string">        &quot;fields&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;keyword&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;type&quot;: &quot;keyword&quot;</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;,</span></span><br><span class="line"><span class="string">      &quot;tags&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;type&quot;: &quot;keyword&quot;</span></span><br><span class="line"><span class="string">      &#125;,</span></span><br><span class="line"><span class="string">      &quot;created_at&quot;: &#123;&quot;type&quot;: &quot;date&quot;, &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;&#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ’å…¥æ•°æ®</span></span><br><span class="line">curl -X POST -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/_bulk&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;1&quot; &#125; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 999.99, &quot;count&quot;: 10, &quot;title&quot;: &quot;Smartphone X - 128GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;å¹¿å·å¤©æ²³å…¬å›­&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;2&quot; &#125; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;category&quot;: &quot;fashion&quot;, &quot;price&quot;: 49.99, &quot;count&quot;: 25, &quot;title&quot;: &quot;Designer T-shirt&quot;, &quot;remark&quot;: &quot;Trendy designer T-shirt made with high quality fabric.&quot;, &quot;address&quot;: &quot;å¹¿å·è”æ¹¾å¤§å¦&quot;, &quot;tags&quot;: [&quot;clothing&quot;, &quot;designer&quot;, &quot;style&quot;], &quot;created_at&quot;: &quot;2025-04-21 12:15:00&quot; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;3&quot; &#125; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;category&quot;: &quot;home_appliances&quot;, &quot;price&quot;: 299.99, &quot;count&quot;: 5, &quot;title&quot;: &quot;Robot Vacuum Cleaner&quot;, &quot;remark&quot;: &quot;Efficient robot vacuum cleaner with smart navigation.&quot;, &quot;address&quot;: &quot;å¹¿å·ç™½äº‘å±±å…¬å›­&quot;, &quot;tags&quot;: [&quot;appliances&quot;, &quot;vacuum&quot;, &quot;robot&quot;], &quot;created_at&quot;: &quot;2025-04-20 08:45:30&quot; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;4&quot; &#125; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;category&quot;: &quot;books&quot;, &quot;price&quot;: 19.99, &quot;count&quot;: 100, &quot;title&quot;: &quot;Inspirational Novel&quot;, &quot;remark&quot;: &quot;A gripping novel that inspires and motivates.&quot;, &quot;address&quot;: &quot;321 Book Rd, Shenzhen, China&quot;, &quot;tags&quot;: [&quot;book&quot;, &quot;novel&quot;, &quot;inspiration&quot;], &quot;created_at&quot;: &quot;2025-04-19 10:05:00&quot; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;5&quot; &#125; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;category&quot;: &quot;groceries&quot;, &quot;price&quot;: 3.99, &quot;count&quot;: 200, &quot;title&quot;: &quot;Organic Apples&quot;, &quot;remark&quot;: &quot;Fresh and crispy organic apples.&quot;, &quot;address&quot;: &quot;654 Grocery Ln, Chengdu, China&quot;, &quot;tags&quot;: [&quot;fruit&quot;, &quot;organic&quot;, &quot;healthy&quot;], &quot;created_at&quot;: &quot;2025-04-18 14:30:45&quot; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;6&quot; &#125; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 1999.99, &quot;count&quot;: 15, &quot;title&quot;: &quot;Smartphone X - 256GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;å¹¿å·å¤©æ²³å…¬å›­&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="Metric-Aggregation-æŒ‡æ ‡èšåˆ">Metric Aggregation(æŒ‡æ ‡èšåˆ)</h2><h3 id="å•å€¼åˆ†æï¸°åªè¾“å‡ºä¸€ä¸ªåˆ†æç»“æœ">å•å€¼åˆ†æï¸°åªè¾“å‡ºä¸€ä¸ªåˆ†æç»“æœ</h3><ul class="lvl-0"><li class="lvl-2"><p>min, max, avg, sum</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æœ€å¤§å€¼ã€æœ€å°å€¼ã€å¹³å‡å€¼ã€æ€»å’Œ</span></span><br><span class="line">GET /shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 0,  <span class="comment"># ä¸è¿”å›æ–‡æ¡£ï¼Œåªè¿”å›èšåˆç»“æœ</span></span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;max_price&quot;</span>: &#123; <span class="comment"># è‡ªå®šä¹‰åç§°ï¼Œè¿™é‡Œè¿”å›æœ€å¤§å€¼</span></span><br><span class="line">      <span class="string">&quot;max&quot;</span>: &#123;     <span class="comment"># æŒ‡æ ‡èšåˆå‡½æ•°åç§°</span></span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span> <span class="comment"># æŒ‡æ ‡èšåˆå­—æ®µ</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;min_price&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;min&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;avg_price&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;sum_price&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;sum&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>Cardinalityï¼ˆç±»ä¼¼distinct Count)</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 0, <span class="comment"># ä¸è¿”å›æ–‡æ¡£ï¼Œåªè¿”å›èšåˆç»“æœ</span></span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;cardinality_count&quot;</span>: &#123; <span class="comment"># è‡ªå®šä¹‰åç§°ï¼Œè¿”å›å»é‡åçš„æ•°é‡</span></span><br><span class="line">      <span class="string">&quot;cardinality&quot;</span>: &#123;  <span class="comment"># æŒ‡æ ‡èšåˆå‡½æ•°åç§°ï¼Œcardinalityè¡¨ç¤ºå»é‡</span></span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;category&quot;</span> <span class="comment"># æŒ‡æ ‡èšåˆå­—æ®µï¼Œå»é‡çš„å­—æ®µ</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¤šå€¼åˆ†æ-è¾“å‡ºå¤šä¸ªåˆ†æç»“æœ">å¤šå€¼åˆ†æ:è¾“å‡ºå¤šä¸ªåˆ†æç»“æœ</h3><ul class="lvl-0"><li class="lvl-2"><p>statsï¼ˆç»Ÿè®¡ï¼‰, extended stats</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">GET /shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;stats_price&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;stats&quot;</span>: &#123; <span class="comment"># æŒ‡æ ‡èšåˆå‡½æ•°åç§°ï¼Œstatsè¡¨ç¤ºç»Ÿè®¡ï¼Œä¼šè¿”å›å¤šä¸ªæŒ‡æ ‡</span></span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># ç»“æœ</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;took&quot;</span>: 15,</span><br><span class="line">  <span class="string">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;successful&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;skipped&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;failed&quot;</span>: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;hits&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;value&quot;</span>: 12,</span><br><span class="line">      <span class="string">&quot;relation&quot;</span>: <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;max_score&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;hits&quot;</span>: []     <span class="comment"># å› ä¸ºè®¾ç½®size ä¸º 0ï¼Œæ‰€ä»¥è¿”å›çš„ç»“æœä¸ºç©º</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;aggregations&quot;</span>: &#123; <span class="comment"># èšåˆç»“æœ</span></span><br><span class="line">    <span class="string">&quot;stats_price&quot;</span>: &#123; <span class="comment"># è‡ªå®šä¹‰åç§°ï¼Œè¿”å›å¤šç»„èšåˆç»“æœ</span></span><br><span class="line">      <span class="string">&quot;count&quot;</span>: 12,</span><br><span class="line">      <span class="string">&quot;min&quot;</span>: 3.99,</span><br><span class="line">      <span class="string">&quot;max&quot;</span>: 1999.99,</span><br><span class="line">      <span class="string">&quot;avg&quot;</span>: 562.1666666666666,</span><br><span class="line">      <span class="string">&quot;sum&quot;</span>: 6746</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>percentile ï¼ˆç™¾åˆ†ä½ï¼‰, percentile rank</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET /shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;percentile_price&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;percentiles&quot;</span>: &#123; <span class="comment"># æŒ‡æ ‡èšåˆå‡½æ•°åç§°ï¼Œpercentilesè¡¨ç¤ºç™¾åˆ†ä½æ•°èšåˆè®¡ç®—</span></span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span>, <span class="comment"># æŒ‡æ ‡èšåˆå­—æ®µ</span></span><br><span class="line">        <span class="string">&quot;percents&quot;</span>: [1, 5, 25, 50, 75, 95, 99] <span class="comment"># éœ€è¦è®¡ç®—ç™¾åˆ†ä½æ•°çš„æ•°ç»„</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># ç™¾åˆ†ä½æ•°æ˜¯ä¸€ä¸ªç»Ÿè®¡å­¦æ¦‚å¿µï¼Œç”¨äºæè¿°ä¸€ä¸ªç»™å®šé›†åˆçš„æ’åºå€¼ã€‚ä¾‹å¦‚ï¼š</span></span><br><span class="line"><span class="comment"># ç¬¬ 1 ç™¾åˆ†ä½æ•°è¡¨ç¤ºæ•°æ®ä¸­å°äºè¿™ä¸ªå€¼çš„æ‰€æœ‰æ•°æ®å æ€»æ•°çš„ 1%ã€‚</span></span><br><span class="line"><span class="comment"># ç¬¬ 50 ç™¾åˆ†ä½æ•°ï¼ˆä¸­ä½æ•°ï¼‰è¡¨ç¤ºæ•°æ®ä¸­çš„ä¸€åŠå°äºè¿™ä¸ªå€¼ï¼Œå¦ä¸€åŠå¤§äºè¿™ä¸ªå€¼ã€‚</span></span><br><span class="line"><span class="comment"># ç¬¬ 99 ç™¾åˆ†ä½æ•°è¡¨ç¤ºæ•°æ®ä¸­å°äºè¿™ä¸ªå€¼çš„æ‰€æœ‰æ•°æ®å æ€»æ•°çš„ 99%ã€‚</span></span><br><span class="line"><span class="comment"># é€šè¿‡è®¡ç®—è¿™äº›ç™¾åˆ†ä½æ•°ï¼Œä½ å¯ä»¥äº†è§£ price å­—æ®µåœ¨æ•´ä¸ªshoppingç´¢å¼•ä¸­çš„åˆ†å¸ƒæƒ…å†µï¼Œä»è€Œå¯ä»¥ç”¨äºæ•°æ®åˆ†æã€è¶‹åŠ¿åˆ¤æ–­ç­‰ã€‚</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>top hits(æ’åœ¨å‰é¢çš„ç¤ºä¾‹)</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET /shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;top_hits&quot;</span>: &#123; <span class="comment"># è‡ªå®šä¹‰åç§°ï¼Œè¿”å›æ’åœ¨å‰é¢çš„ç¤ºä¾‹</span></span><br><span class="line">      <span class="string">&quot;top_hits&quot;</span>: &#123; <span class="comment"># æŒ‡æ ‡èšåˆå‡½æ•°åç§°ï¼Œtop_hitsè¡¨ç¤ºè¿”å›æ’åœ¨å‰é¢çš„ç¤ºä¾‹</span></span><br><span class="line">        <span class="string">&quot;sort&quot;</span>: [&#123;<span class="string">&quot;price&quot;</span>: &#123;<span class="string">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span>&#125;&#125;], <span class="comment"># æ’åºï¼ŒæŒ‰ç…§priceå­—æ®µé™åºæ’åº</span></span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 3 <span class="comment"># åªè¿”å›å‰3ä¸ª</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Bucket-Aggregation-æ¡¶èšåˆ">Bucket Aggregation(æ¡¶èšåˆ)</h2><ul class="lvl-0"><li class="lvl-2"><p>æŒ‰ç…§ä¸€å®šçš„è§„åˆ™ï¼Œå°†æ–‡æ¡£åˆ†é…åˆ°ä¸åŒçš„æ¡¶ä¸­ï¼Œä»è€Œè¾¾åˆ°åˆ†ç±»çš„ç›®çš„ã€‚</p></li><li class="lvl-2"><p>ESæä¾›çš„ä¸€äº›å¸¸è§çš„ Bucket Aggregationã€‚</p><ul class="lvl-2"><li class="lvl-4">termsï¼ˆè¯æ¡ï¼‰, rangeï¼ˆèŒƒå›´ï¼‰, date_rangeï¼ˆæ—¥æœŸèŒƒå›´ï¼‰, ip_rangeï¼ˆIPèŒƒå›´ï¼‰, missingï¼ˆç¼ºå¤±ï¼‰, histogramï¼ˆç›´æ–¹å›¾ï¼‰, date_histogramï¼ˆæ—¥æœŸç›´æ–¹å›¾ï¼‰, geo_distanceï¼ˆåœ°ç†è·ç¦»ï¼‰, significant_termsï¼ˆé‡è¦è¯æ¡ï¼‰, compositeï¼ˆç»„åˆï¼‰</li></ul></li><li class="lvl-2"><p>æ¡¶èšåˆå¯ä»¥ç”¨äºå„ç§åœºæ™¯ï¼Œä¾‹å¦‚ï¼š</p><ul class="lvl-2"><li class="lvl-4">å¯¹æ•°æ®è¿›è¡Œåˆ†ç»„ç»Ÿè®¡ï¼Œæ¯”å¦‚æŒ‰ç…§åœ°åŒºã€å¹´é¾„æ®µã€æ€§åˆ«ç­‰å­—æ®µè¿›è¡Œåˆ†ç»„ç»Ÿè®¡ã€‚</li><li class="lvl-4">å¯¹æ—¶é—´åºåˆ—æ•°æ®è¿›è¡Œæ—¶é—´æ®µåˆ†æï¼Œæ¯”å¦‚æŒ‰ç…§æ¯å°æ—¶ã€æ¯å¤©ã€æ¯æœˆã€æ¯å­£åº¦ã€æ¯å¹´ç­‰æ—¶é—´æ®µè¿›è¡Œåˆ†æã€‚</li><li class="lvl-4">å¯¹å„ç§æ ‡ç­¾ä¿¡æ¯åˆ†ç±»ï¼Œå¹¶ç»Ÿè®¡å…¶æ•°é‡ã€‚</li></ul></li></ul><h3 id="termsï¼ˆè¯æ¡ï¼‰">termsï¼ˆè¯æ¡ï¼‰</h3><ul class="lvl-0"><li class="lvl-2"><p>æŒ‰ç…§å­—æ®µçš„å€¼è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªç»„çš„æ•°é‡ã€‚</p></li><li class="lvl-2"><p>ç¤ºä¾‹ï¼šæŒ‰ç…§categoryå­—æ®µè¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªç»„çš„æ•°é‡ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">GET /shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;category_count&quot;</span>: &#123; <span class="comment"># è‡ªå®šä¹‰åç§°ï¼Œè¿”å›æ¯ä¸ªç»„çš„æ•°é‡</span></span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123; <span class="comment"># æ¡¶èšåˆå‡½æ•°åç§°ï¼Œtermsè¡¨ç¤ºæŒ‰ç…§å­—æ®µçš„å€¼è¿›è¡Œåˆ†ç»„</span></span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;category&quot;</span>, <span class="comment"># æŒ‰ç…§categoryå­—æ®µè¿›è¡Œåˆ†ç»„ï¼Œæ³¨æ„ä¸èƒ½æ˜¯textç±»å‹ï¼Œå¦åˆ™ä¼šæŠ¥é”™</span></span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 10, <span class="comment"># åªè¿”å›å‰10ä¸ªï¼Œé»˜è®¤æ˜¯10</span></span><br><span class="line">        <span class="string">&quot;order&quot;</span>: &#123;<span class="string">&quot;_count&quot;</span>: <span class="string">&quot;desc&quot;</span>&#125; <span class="comment"># æŒ‰ç…§æ•°é‡é™åºæ’åºï¼Œé»˜è®¤æ˜¯descï¼ŒBucketèšåˆä¼šç»Ÿè®¡Bucketå†…çš„æ–‡æ¡£æ•°é‡ï¼Œè®°ä¸º_countï¼Œå¹¶ä¸”æŒ‰ç…§_counté™åºæ’åº</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»“æœ</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;took&quot;</span>: 15,</span><br><span class="line">  <span class="string">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;successful&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;skipped&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;failed&quot;</span>: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;hits&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;value&quot;</span>: 12,</span><br><span class="line">      <span class="string">&quot;relation&quot;</span>: <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;max_score&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;hits&quot;</span>: []</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;aggregations&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;category_count&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;doc_count_error_upper_bound&quot;</span>: 0,  <span class="comment"># é”™è¯¯ä¸Šç•Œï¼Œè¡¨ç¤ºåœ¨èšåˆè¿‡ç¨‹ä¸­å¯èƒ½å­˜åœ¨ä¸€äº›é”™è¯¯ï¼Œä½†é”™è¯¯æ•°é‡ä¸ä¼šè¶…è¿‡è¿™ä¸ªå€¼</span></span><br><span class="line">      <span class="string">&quot;sum_other_doc_count&quot;</span>: 0,         <span class="comment"># è¡¨ç¤ºåœ¨èšåˆè¿‡ç¨‹ä¸­ï¼Œé™¤äº†è¿”å›çš„10ä¸ªbucketï¼Œè¿˜æœ‰å…¶ä»–æ•°é‡ï¼Œè¿™ä¸ªæ•°é‡å°±æ˜¯sum_other_doc_count</span></span><br><span class="line">      <span class="string">&quot;buckets&quot;</span>: [                     <span class="comment"># è¿”å›çš„bucket</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;key&quot;</span>: <span class="string">&quot;electronics&quot;</span>,          <span class="comment"># åˆ†ç»„çš„key</span></span><br><span class="line">          <span class="string">&quot;doc_count&quot;</span>: 4                 <span class="comment"># åˆ†ç»„çš„æ•°é‡</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;key&quot;</span>: <span class="string">&quot;books&quot;</span>,</span><br><span class="line">          <span class="string">&quot;doc_count&quot;</span>: 2</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;key&quot;</span>: <span class="string">&quot;fashion&quot;</span>,</span><br><span class="line">          <span class="string">&quot;doc_count&quot;</span>: 2</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;key&quot;</span>: <span class="string">&quot;groceries&quot;</span>,</span><br><span class="line">          <span class="string">&quot;doc_count&quot;</span>: 2</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;key&quot;</span>: <span class="string">&quot;home_appliances&quot;</span>,</span><br><span class="line">          <span class="string">&quot;doc_count&quot;</span>: 2</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>é™å®šèšåˆèŒƒå›´</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">GET /shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;price&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;gte&quot;</span>: 100 <span class="comment"># é™å®šä»·æ ¼èŒƒå›´</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;category_count&quot;</span>: &#123; <span class="comment"># è‡ªå®šä¹‰åç§°ï¼Œè¿”å›æ¯ä¸ªç»„çš„æ•°é‡</span></span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123; <span class="comment"># æ¡¶èšåˆå‡½æ•°åç§°ï¼Œtermsè¡¨ç¤ºæŒ‰ç…§å­—æ®µçš„å€¼è¿›è¡Œåˆ†ç»„</span></span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;category&quot;</span>, <span class="comment"># æŒ‰ç…§categoryå­—æ®µè¿›è¡Œåˆ†ç»„</span></span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 10, <span class="comment"># åªè¿”å›å‰10ä¸ªï¼Œé»˜è®¤æ˜¯10</span></span><br><span class="line">        <span class="string">&quot;order&quot;</span>: &#123;<span class="string">&quot;_count&quot;</span>: <span class="string">&quot;desc&quot;</span>&#125; <span class="comment"># æŒ‰ç…§æ•°é‡é™åºæ’åºï¼Œé»˜è®¤æ˜¯descï¼ŒBucketèšåˆä¼šç»Ÿè®¡Bucketå†…çš„æ–‡æ¡£æ•°é‡ï¼Œè®°ä¸º_countï¼Œå¹¶ä¸”æŒ‰ç…§_counté™åºæ’åº</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="rangeï¼ˆèŒƒå›´ï¼‰">rangeï¼ˆèŒƒå›´ï¼‰</h3><ul class="lvl-0"><li class="lvl-2"><p>æŒ‰ç…§å­—æ®µçš„å€¼è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªç»„çš„æ•°é‡ã€‚</p></li><li class="lvl-2"><p>ç¤ºä¾‹ï¼šæŒ‰ç…§ä»·æ ¼èŒƒå›´è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªç»„çš„æ•°é‡ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">GET /shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;price_range&quot;</span>: &#123; <span class="comment"># è‡ªå®šä¹‰åç§°ï¼Œè¿”å›æ¯ä¸ªç»„çš„æ•°é‡</span></span><br><span class="line">      <span class="string">&quot;range&quot;</span>: &#123; <span class="comment"># æ¡¶èšåˆå‡½æ•°åç§°ï¼Œrangeè¡¨ç¤ºæŒ‰ç…§å­—æ®µçš„å€¼è¿›è¡Œåˆ†ç»„</span></span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span>, <span class="comment"># æŒ‰ç…§priceå­—æ®µè¿›è¡Œåˆ†ç»„</span></span><br><span class="line">        <span class="string">&quot;ranges&quot;</span>: [</span><br><span class="line">          &#123;<span class="string">&quot;to&quot;</span>: 100&#125;, <span class="comment"># å°äº100</span></span><br><span class="line">          &#123;<span class="string">&quot;from&quot;</span>: 100, <span class="string">&quot;to&quot;</span>: 200&#125;, <span class="comment"># 100-200ï¼ŒåŒ…æ‹¬100ï¼Œä¸åŒ…æ‹¬200</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;key&quot;</span>:<span class="string">&quot;&gt;=200&quot;</span>, <span class="comment"># è®¾å®šé”®å€¼ï¼Œç”¨äºåŒºåˆ†ä¸åŒèŒƒå›´</span></span><br><span class="line">            <span class="string">&quot;from&quot;</span>:200 <span class="comment"># å¤§äºç­‰äº200</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># ç»“æœ</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;took&quot;</span>: 5,</span><br><span class="line">  <span class="string">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;successful&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;skipped&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;failed&quot;</span>: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;hits&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;value&quot;</span>: 12,</span><br><span class="line">      <span class="string">&quot;relation&quot;</span>: <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;max_score&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;hits&quot;</span>: []</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;aggregations&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;price_range&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;buckets&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;key&quot;</span>: <span class="string">&quot;*-100.0&quot;</span>,</span><br><span class="line">          <span class="string">&quot;to&quot;</span>: 100,</span><br><span class="line">          <span class="string">&quot;doc_count&quot;</span>: 6</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;key&quot;</span>: <span class="string">&quot;100.0-200.0&quot;</span>,</span><br><span class="line">          <span class="string">&quot;from&quot;</span>: 100,</span><br><span class="line">          <span class="string">&quot;to&quot;</span>: 200,</span><br><span class="line">          <span class="string">&quot;doc_count&quot;</span>: 0</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;key&quot;</span>: <span class="string">&quot;&gt;=200&quot;</span>,</span><br><span class="line">          <span class="string">&quot;from&quot;</span>: 200,</span><br><span class="line">          <span class="string">&quot;doc_count&quot;</span>: 6</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="date-rangeï¼ˆæ—¥æœŸèŒƒå›´ï¼‰">date_rangeï¼ˆæ—¥æœŸèŒƒå›´ï¼‰</h3><ul class="lvl-0"><li class="lvl-2"><p>æŒ‰ç…§å­—æ®µçš„å€¼è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªç»„çš„æ•°é‡ã€‚</p></li><li class="lvl-2"><p>ç¤ºä¾‹ï¼šæŒ‰ç…§æ—¥æœŸèŒƒå›´è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªç»„çš„æ•°é‡ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">GET /shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;date_range&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;date_range&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;created_at&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ranges&quot;</span>: [</span><br><span class="line">          &#123;<span class="string">&quot;to&quot;</span>: <span class="string">&quot;now-3d&quot;</span>&#125;, <span class="comment"># å°äºå½“å‰æ—¶é—´å‡å»3å¤©</span></span><br><span class="line">          &#123;<span class="string">&quot;from&quot;</span>: <span class="string">&quot;now-3d&quot;</span>,<span class="string">&quot;to&quot;</span>: <span class="string">&quot;now-1d&quot;</span>&#125;, <span class="comment"># å¤§äºå½“å‰æ—¶é—´å‡å»3å¤©ï¼ˆåŒ…å«ï¼‰ï¼Œå°äºå½“å‰æ—¶é—´å‡å»1å¤©</span></span><br><span class="line">          &#123;<span class="string">&quot;key&quot;</span>:<span class="string">&quot;now-1d&quot;</span>,<span class="string">&quot;from&quot;</span>: <span class="string">&quot;now-1d&quot;</span>&#125; <span class="comment"># å¤§äºå½“å‰æ—¶é—´å‡å»1å¤©ï¼ˆåŒ…å«ï¼‰ï¼Œå¹¶è®¾ç½®é”®å€¼</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># ç»“æœ</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;took&quot;</span>: 3,</span><br><span class="line">  <span class="string">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;successful&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;skipped&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;failed&quot;</span>: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;hits&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;value&quot;</span>: 12,</span><br><span class="line">      <span class="string">&quot;relation&quot;</span>: <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;max_score&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;hits&quot;</span>: []</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;aggregations&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;date_range&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;buckets&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;key&quot;</span>: <span class="string">&quot;*-2025-04-20 03:14:17&quot;</span>,</span><br><span class="line">          <span class="string">&quot;to&quot;</span>: 1745118857610,</span><br><span class="line">          <span class="string">&quot;to_as_string&quot;</span>: <span class="string">&quot;2025-04-20 03:14:17&quot;</span>,</span><br><span class="line">          <span class="string">&quot;doc_count&quot;</span>: 4</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;key&quot;</span>: <span class="string">&quot;2025-04-20 03:14:17-2025-04-22 03:14:17&quot;</span>,</span><br><span class="line">          <span class="string">&quot;from&quot;</span>: 1745118857610,</span><br><span class="line">          <span class="string">&quot;from_as_string&quot;</span>: <span class="string">&quot;2025-04-20 03:14:17&quot;</span>,</span><br><span class="line">          <span class="string">&quot;to&quot;</span>: 1745291657610,</span><br><span class="line">          <span class="string">&quot;to_as_string&quot;</span>: <span class="string">&quot;2025-04-22 03:14:17&quot;</span>,</span><br><span class="line">          <span class="string">&quot;doc_count&quot;</span>: 4</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;key&quot;</span>: <span class="string">&quot;now-1d&quot;</span>,</span><br><span class="line">          <span class="string">&quot;from&quot;</span>: 1745291657610,</span><br><span class="line">          <span class="string">&quot;from_as_string&quot;</span>: <span class="string">&quot;2025-04-22 03:14:17&quot;</span>,</span><br><span class="line">          <span class="string">&quot;doc_count&quot;</span>: 4</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ—¥æœŸæ ¼å¼</span></span><br><span class="line">GET /shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;date_range&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;date_range&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;created_at&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ranges&quot;</span>: [</span><br><span class="line">          &#123;<span class="string">&quot;to&quot;</span>: <span class="string">&quot;2025-04-20 00:00:00&quot;</span>&#125;, <span class="comment"># æ³¨æ„è¿™é‡Œçš„æ ¼å¼å¿…é¡»ä¸å­—æ®µæ ¼å¼ä¸€è‡´</span></span><br><span class="line">          &#123;<span class="string">&quot;from&quot;</span>: <span class="string">&quot;2025-04-20 00:00:00&quot;</span>,<span class="string">&quot;to&quot;</span>: <span class="string">&quot;2025-04-22 00:00:00&quot;</span>&#125;,</span><br><span class="line">          &#123;<span class="string">&quot;key&quot;</span>:<span class="string">&quot;2025-04-22 00:00:00&quot;</span>,<span class="string">&quot;from&quot;</span>: <span class="string">&quot;2025-04-22 00:00:00&quot;</span>&#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="histogramï¼ˆç›´æ–¹å›¾ï¼‰">histogramï¼ˆç›´æ–¹å›¾ï¼‰</h3><ul class="lvl-0"><li class="lvl-2"><p>æŒ‰ç…§é—´éš”è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªç»„çš„æ•°é‡ã€‚</p></li><li class="lvl-2"><p>ç¤ºä¾‹ï¼šæŒ‰ç…§ä»·æ ¼çš„é—´éš”è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡æ¯ä¸ªç»„çš„æ•°é‡ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">GET /shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;price_histogram&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;histogram&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span>,</span><br><span class="line">        <span class="string">&quot;interval&quot;</span>: 500, <span class="comment"># é—´éš”500</span></span><br><span class="line">        <span class="string">&quot;extended_bounds&quot;</span>:&#123; <span class="comment"># è®¾ç½®è¾¹ç•Œ</span></span><br><span class="line">          <span class="string">&quot;min&quot;</span>:0, <span class="comment"># æœ€å°å€¼0</span></span><br><span class="line">          <span class="string">&quot;max&quot;</span>:2000 <span class="comment"># æœ€å¤§å€¼2000</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># ç»“æœ</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;took&quot;</span>: 2,</span><br><span class="line">  <span class="string">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;successful&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;skipped&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;failed&quot;</span>: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;hits&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;value&quot;</span>: 12,</span><br><span class="line">      <span class="string">&quot;relation&quot;</span>: <span class="string">&quot;eq&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;max_score&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;hits&quot;</span>: []</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;aggregations&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;price_histogram&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;buckets&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;key&quot;</span>: 0,</span><br><span class="line">          <span class="string">&quot;doc_count&quot;</span>: 8</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;key&quot;</span>: 500,</span><br><span class="line">          <span class="string">&quot;doc_count&quot;</span>: 1</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;key&quot;</span>: 1000,</span><br><span class="line">          <span class="string">&quot;doc_count&quot;</span>: 1</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;key&quot;</span>: 1500,</span><br><span class="line">          <span class="string">&quot;doc_count&quot;</span>: 2</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;key&quot;</span>: 2000,</span><br><span class="line">          <span class="string">&quot;doc_count&quot;</span>: 0</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="top-hitsï¼ˆåˆ†æ¡¶å–å‰Næ¡ï¼‰">top_hitsï¼ˆåˆ†æ¡¶å–å‰Næ¡ï¼‰</h3><ul class="lvl-0"><li class="lvl-2"><p>æŒ‰ç…§å­—æ®µçš„å€¼è¿›è¡Œåˆ†ç»„ï¼Œå¹¶è¿”å›æ¯ä¸ªç»„çš„å‰Næ¡æ•°æ®ã€‚</p></li><li class="lvl-2"><p>ç¤ºä¾‹ï¼šæŒ‰ç…§categoryè¿›è¡Œåˆ†ç»„ï¼Œå¹¶è¿”å›æ¯ä¸ªç»„çš„å‰3æ¡æ•°æ®ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET /shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;price_top_hits&quot;</span>: &#123; <span class="comment"># è‡ªå®šä¹‰åç§°</span></span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;category&quot;</span>  <span class="comment"># æŒ‰ç…§categoryå­—æ®µè¿›è¡Œåˆ†ç»„</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;top_hits&quot;</span>: &#123; <span class="comment"># è‡ªå®šä¹‰åç§°</span></span><br><span class="line">          <span class="string">&quot;top_hits&quot;</span>: &#123; <span class="comment"># è¿”å›æ¯ä¸ªç»„çš„å‰3æ¡æ•°æ®</span></span><br><span class="line">            <span class="string">&quot;size&quot;</span>: 3, <span class="comment"># è¿”å›å‰3æ¡æ•°æ®</span></span><br><span class="line">            <span class="string">&quot;sort&quot;</span>: &#123; <span class="comment"># æŒ‰ç…§created_atå­—æ®µè¿›è¡Œæ’åº</span></span><br><span class="line">              <span class="string">&quot;created_at&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span> <span class="comment"># é™åº</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å­èšåˆ">å­èšåˆ</h3><ul class="lvl-0"><li class="lvl-2"><p>å­èšåˆï¼šåœ¨èšåˆå‡½æ•°ä¸­ï¼Œè¿˜å¯ä»¥å†å®šä¹‰ä¸€ä¸ªèšåˆå‡½æ•°ã€‚</p></li><li class="lvl-2"><p>ç¤ºä¾‹ï¼šæŒ‰ç…§categoryè¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡ä»·æ ¼ä¿¡æ¯</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">GET /shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;category_buckets&quot;</span>: &#123; <span class="comment"># è‡ªå®šä¹‰åç§°</span></span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;category&quot;</span>  <span class="comment"># æŒ‰ç…§categoryå­—æ®µè¿›è¡Œåˆ†ç»„</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123; <span class="comment"># å®šä¹‰å­èšåˆ</span></span><br><span class="line">        <span class="string">&quot;price_stats&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;stats&quot;</span>: &#123; <span class="comment"># ç»Ÿè®¡ä»·æ ¼ä¿¡æ¯</span></span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤šå±‚åµŒå¥—</span></span><br><span class="line"><span class="comment"># å…ˆæŒ‰ç…§categoryè¿›è¡Œåˆ†ç»„ï¼Œå†æŒ‰ç…§addressè¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡ä»·æ ¼ä¿¡æ¯</span></span><br><span class="line">GET /shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>:0,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;category_buckets&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>:<span class="string">&quot;category&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;address_buckets&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;terms&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>:<span class="string">&quot;address.keyword&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;price_stats&quot;</span>:&#123;</span><br><span class="line">              <span class="string">&quot;stats&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;field&quot;</span>:<span class="string">&quot;price&quot;</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Pipeline-Aggregation-ç®¡é“èšåˆ">Pipeline Aggregation(ç®¡é“èšåˆ)</h2><ul class="lvl-0"><li class="lvl-2"><p>æ”¯æŒå¯¹èšåˆåˆ†æçš„ç»“æœï¼Œå†æ¬¡è¿›è¡Œèšåˆåˆ†æã€‚</p></li><li class="lvl-2"><p>Pipeline çš„åˆ†æç»“æœä¼šè¾“å‡ºåˆ°åŸç»“æœä¸­ï¼Œæ ¹æ®ä½ç½®çš„ä¸åŒï¼Œåˆ†ä¸ºä¸¤ç±»ï¼š</p><ul class="lvl-2"><li class="lvl-4">Sibling - ç»“æœå’Œç°æœ‰åˆ†æç»“æœåŒçº§<ul class="lvl-4"><li class="lvl-6">Maxï¼Œminï¼ŒAvg &amp; Sum Bucket</li><li class="lvl-6">Statsï¼ŒExtended Status Bucket</li><li class="lvl-6">Percentiles Bucket</li></ul></li><li class="lvl-4">Parent -ç»“æœå†…åµŒåˆ°ç°æœ‰çš„èšåˆåˆ†æç»“æœä¹‹ä¸­<ul class="lvl-4"><li class="lvl-6">Derivative(æ±‚å¯¼)</li><li class="lvl-6">Cumultive Sum(ç´¯è®¡æ±‚å’Œ)</li><li class="lvl-6">Moving Function(ç§»åŠ¨å¹³å‡å€¼)</li></ul></li></ul></li></ul><h3 id="Maxï¼Œminï¼ŒAvg-Sum-Bucket">Maxï¼Œminï¼ŒAvg &amp; Sum Bucket</h3><ul class="lvl-0"><li class="lvl-2"><p>Maxï¼Œminï¼ŒAvg &amp; Sum Bucketï¼šå¯¹èšåˆåˆ†æçš„ç»“æœè¿›è¡Œæœ€å¤§å€¼ã€æœ€å°å€¼ã€å¹³å‡å€¼ã€æ±‚å’Œç­‰æ“ä½œã€‚</p></li><li class="lvl-2"><p>ç¤ºä¾‹ï¼šæŒ‰ç…§categoryè¿›è¡Œåˆ†ç»„æ±‚å‡ºå•†å“çš„å¹³å‡ä»·æ ¼ï¼Œå¹¶æ‰¾å‡ºå¹³å‡ä»·æ ¼æœ€ä½çš„åˆ†ç»„</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">GET /shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>:0,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;category_buckets&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>:<span class="string">&quot;category&quot;</span> <span class="comment"># æŒ‰ç…§categoryå­—æ®µè¿›è¡Œåˆ†ç»„</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;price_avg&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;avg&quot;</span>:&#123; <span class="comment"># æ±‚ä»·æ ¼å¹³å‡å€¼</span></span><br><span class="line">            <span class="string">&quot;field&quot;</span>:<span class="string">&quot;price&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;min_price_in_category&quot;</span>:&#123; <span class="comment"># æ‰¾å‡ºå¹³å‡ä»·æ ¼æœ€ä½çš„åˆ†ç»„</span></span><br><span class="line">      <span class="string">&quot;min_bucket&quot;</span>:&#123; <span class="comment"># å¯¹èšåˆç»“æœè¿›è¡Œæœ€å°å€¼æ“ä½œ</span></span><br><span class="line">        <span class="string">&quot;buckets_path&quot;</span>:<span class="string">&quot;category_buckets&gt;price_avg&quot;</span> <span class="comment"># æŒ‡å®šè·¯å¾„ï¼Œå¯¹category_bucketsèšåˆç»“æœä¸­çš„price_avgå­—æ®µè¿›è¡Œæœ€å°å€¼æ“ä½œ</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Statsï¼ŒExtended-Status-Bucket">Statsï¼ŒExtended Status Bucket</h3><ul class="lvl-0"><li class="lvl-2"><p>Statsï¼ŒExtended Status Bucketï¼šå¯¹èšåˆåˆ†æçš„ç»“æœè¿›è¡Œç»Ÿè®¡æ“ä½œï¼ŒåŒ…æ‹¬æœ€å¤§å€¼ã€æœ€å°å€¼ã€å¹³å‡å€¼ã€æ±‚å’Œã€æ•°é‡ç­‰ã€‚</p></li><li class="lvl-2"><p>ç¤ºä¾‹ï¼šæŒ‰ç…§categoryè¿›è¡Œåˆ†ç»„æ±‚å‡ºå•†å“çš„å¹³å‡ä»·æ ¼ï¼Œå¹¶å¯¹åˆ†ç»„ç»“æœè¿›è¡Œç»Ÿè®¡æ“ä½œ</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">GET /shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;category_buckets&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;category&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 10 <span class="comment"># æŒ‡å®šåˆ†ç»„æ•°é‡</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;avg_price&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;stats_price_by_job&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;stats_bucket&quot;</span>: &#123; <span class="comment"># å¯¹èšåˆç»“æœè¿›è¡Œç»Ÿè®¡æ“ä½œ</span></span><br><span class="line">        <span class="string">&quot;buckets_path&quot;</span>: <span class="string">&quot;category_buckets&gt;avg_price&quot;</span> <span class="comment"># æŒ‡å®šè·¯å¾„ï¼Œå¯¹category_bucketsèšåˆç»“æœä¸­çš„avg_priceå­—æ®µè¿›è¡Œç»Ÿè®¡æ“ä½œ</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Percentiles-Bucket">Percentiles Bucket</h3><ul class="lvl-0"><li class="lvl-2"><p>Percentiles Bucketï¼šå¯¹èšåˆåˆ†æçš„ç»“æœè¿›è¡Œç™¾åˆ†æ¯”æ“ä½œï¼ŒåŒ…æ‹¬ç™¾åˆ†æ¯”ã€ä¸­ä½æ•°ç­‰ã€‚</p></li><li class="lvl-2"><p>ç¤ºä¾‹ï¼šæŒ‰ç…§categoryè¿›è¡Œåˆ†ç»„æ±‚å‡ºå•†å“çš„å¹³å‡ä»·æ ¼ï¼Œå¹¶å¯¹åˆ†ç»„ç»“æœè¿›è¡Œç™¾åˆ†æ¯”æ“ä½œ</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">GET /shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;category_buckets&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;category&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 10</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;avg_price&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;percentiles_price_by_category&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;percentiles_bucket&quot;</span>: &#123; <span class="comment"># å¯¹èšåˆç»“æœè¿›è¡Œç»Ÿè®¡æ“ä½œ</span></span><br><span class="line">        <span class="string">&quot;buckets_path&quot;</span>: <span class="string">&quot;category_buckets&gt;avg_price&quot;</span> <span class="comment"># æŒ‡å®šè·¯å¾„ï¼Œå¯¹category_bucketsèšåˆç»“æœä¸­çš„avg_priceå­—æ®µè¿›è¡Œç»Ÿè®¡æ“ä½œ</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Cumulative-Sum">Cumulative Sum</h3><ul class="lvl-0"><li class="lvl-2"><p>Cumulative Sumï¼šå¯¹èšåˆåˆ†æçš„ç»“æœè¿›è¡Œç´¯è®¡æ±‚å’Œæ“ä½œã€‚</p></li><li class="lvl-2"><p>ç¤ºä¾‹: æŒ‰ç…§ä»·æ ¼è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ç»Ÿè®¡å¹³å‡ä»·æ ¼ä¿¡æ¯ï¼Œå¯¹åˆ†ç»„ç»“æœè¿›è¡Œç´¯è®¡æ±‚å’Œæ“ä½œã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">GET /shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;price_histogram&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;histogram&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span>,</span><br><span class="line">        <span class="string">&quot;interval&quot;</span>: 500, <span class="comment"># é—´éš”500</span></span><br><span class="line">        <span class="string">&quot;extended_bounds&quot;</span>:&#123; <span class="comment"># è®¾ç½®è¾¹ç•Œ</span></span><br><span class="line">          <span class="string">&quot;min&quot;</span>:0, <span class="comment"># æœ€å°å€¼0</span></span><br><span class="line">          <span class="string">&quot;max&quot;</span>:2000 <span class="comment"># æœ€å¤§å€¼2000</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;avg_price&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;cumulative_sum_price&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;cumulative_sum&quot;</span>: &#123; <span class="comment"># å¯¹èšåˆç»“æœè¿›è¡Œç´¯è®¡æ±‚å’Œæ“ä½œ</span></span><br><span class="line">            <span class="string">&quot;buckets_path&quot;</span>: <span class="string">&quot;avg_price&quot;</span> <span class="comment"># æŒ‡å®šè·¯å¾„ï¼Œå¯¹avg_priceå­—æ®µè¿›è¡Œç´¯è®¡æ±‚å’Œæ“ä½œ</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Derivative">Derivative</h3><ul class="lvl-0"><li class="lvl-2"><p>Derivativeï¼šå¯¹èšåˆåˆ†æçš„ç»“æœè¿›è¡Œæ±‚å¯¼æ“ä½œã€‚</p></li><li class="lvl-2"><p>Derivative èšåˆæŸ¥è¯¢æ˜¯ Elasticsearch ä¸­çš„ä¸€ç§é«˜çº§èšåˆç±»å‹ï¼Œç”¨äºè®¡ç®—æŸä¸ªåº¦é‡å€¼éšæ—¶é—´ï¼ˆæˆ–å…¶ä»–é¡ºåºå­—æ®µï¼‰å˜åŒ–çš„é€Ÿç‡ã€‚å®ƒé€šå¸¸ç”¨äºæ—¶é—´åºåˆ—åˆ†æï¼Œä»¥æ­ç¤ºåº¦é‡å€¼çš„å¢å‡è¶‹åŠ¿ã€‚</p></li><li class="lvl-2"><p>ç¤ºä¾‹ï¼šæ˜¾ç¤ºæ¯å¤©çš„å¹³å‡ä»·æ ¼ä»¥åŠå¹³å‡ä»·æ ¼çš„å˜åŒ–è¶‹åŠ¿</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">GET /shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;price_over_time&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;date_histogram&quot;</span>: &#123; <span class="comment"># æŒ‰ç…§æ—¥æœŸè¿›è¡Œåˆ†ç»„</span></span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;created_at&quot;</span>, <span class="comment"># æŒ‡å®šå­—æ®µ</span></span><br><span class="line">        <span class="string">&quot;calendar_interval&quot;</span>: <span class="string">&quot;day&quot;</span> <span class="comment"># æŒ‡å®šæ—¶é—´é—´éš”ï¼Œå¯ç”¨çš„å€¼ï¼šyearã€quarterã€monthã€weekã€dayã€hourã€minuteã€second</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;average_price&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;price_derivative&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;derivative&quot;</span>: &#123; <span class="comment"># å¯¹èšåˆç»“æœè¿›è¡Œæ±‚å¯¼æ“ä½œ</span></span><br><span class="line">            <span class="string">&quot;buckets_path&quot;</span>: <span class="string">&quot;average_price&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Moving-Function">Moving Function</h3><ul class="lvl-0"><li class="lvl-2"><p>Moving Functionï¼šå¯¹èšåˆåˆ†æçš„ç»“æœè¿›è¡Œç§»åŠ¨å¹³å‡å€¼æ“ä½œã€‚</p></li><li class="lvl-2"><p>Moving Function èšåˆæŸ¥è¯¢æ˜¯ Elasticsearch ä¸­çš„ä¸€ç§é«˜çº§èšåˆç±»å‹ï¼Œç”¨äºè®¡ç®—æŸä¸ªåº¦é‡å€¼åœ¨æ—¶é—´çª—å£å†…çš„ç§»åŠ¨å¹³å‡å€¼ã€‚å®ƒé€šå¸¸ç”¨äºæ—¶é—´åºåˆ—åˆ†æï¼Œä»¥äº†è§£åº¦é‡å€¼çš„å˜åŒ–è¶‹åŠ¿ã€‚</p></li><li class="lvl-2"><p>ç¤ºä¾‹ï¼šè®¡ç®— price å­—æ®µçš„ 7 å¤©ç§»åŠ¨å¹³å‡å€¼</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">GET /shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;price_over_time&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;date_histogram&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;created_at&quot;</span>,</span><br><span class="line">        <span class="string">&quot;calendar_interval&quot;</span>: <span class="string">&quot;day&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;daily_avg_price&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;moving_avg_price&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;moving_fn&quot;</span>: &#123; <span class="comment"># å¯¹èšåˆç»“æœè¿›è¡Œç§»åŠ¨å¹³å‡å€¼æ“ä½œ</span></span><br><span class="line">            <span class="string">&quot;buckets_path&quot;</span>: <span class="string">&quot;daily_avg_price&quot;</span>, <span class="comment"># æŒ‡å®šè·¯å¾„ï¼Œå¯¹daily_avg_priceå­—æ®µè¿›è¡Œç§»åŠ¨å¹³å‡å€¼æ“ä½œ</span></span><br><span class="line">            <span class="string">&quot;script&quot;</span>: <span class="string">&quot;MovingFunctions.unweightedAvg(values)&quot;</span>, <span class="comment"># æŒ‡å®šè„šæœ¬ï¼Œè®¡ç®—ç§»åŠ¨å¹³å‡å€¼</span></span><br><span class="line">            <span class="string">&quot;window&quot;</span>: 7, <span class="comment"># çª—å£å¤§å°ï¼Œé»˜è®¤ä¸º 10</span></span><br><span class="line">            <span class="string">&quot;shift&quot;</span>: 0 <span class="comment"># çª—å£åç§»é‡ï¼Œé»˜è®¤ä¸º 0</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ES-èšåˆæ€§èƒ½ä¼˜åŒ–">ES èšåˆæ€§èƒ½ä¼˜åŒ–</h2><h3 id="ç´¢å¼•é¢„æ’åº">ç´¢å¼•é¢„æ’åº</h3><ul class="lvl-0"><li class="lvl-2"><p>å¦‚æœæ˜¯ Elasticsearch 6.X ä¹‹åç‰ˆæœ¬ï¼Œå¯ä»¥åœ¨æ’å…¥æ•°æ®æ—¶å¯¹ç´¢å¼•è¿›è¡Œé¢„æ’åºï¼Œè€Œä¸æ˜¯åœ¨æŸ¥è¯¢æ—¶å†å¯¹ç´¢å¼•è¿›è¡Œæ’åºï¼Œè¿™å°†æé«˜èŒƒå›´æŸ¥è¯¢ï¼ˆrange queryï¼‰å’Œæ’åºæ“ä½œçš„æ€§èƒ½ã€‚</p></li><li class="lvl-2"><p>ä½†é¢„æ’åºå°†å¢åŠ  Elasticsearch å†™å…¥çš„æˆæœ¬ï¼Œå¯¼è‡´å¤§çº¦ 40%-50% çš„å†™æ€§èƒ½ä¸‹é™ï¼Œå¦‚æœåº”ç”¨åœºæ™¯æ˜¯æ›´å…³æ³¨å†™æ€§èƒ½çš„ä¸šåŠ¡ï¼Œå¼€å¯ç´¢å¼•é¢„æ’åºä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;index&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;sort.field&quot;</span>: <span class="string">&quot;create_time&quot;</span>,</span><br><span class="line">      <span class="string">&quot;sort.order&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;create_time&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨åˆ†ç‰‡è¯·æ±‚ç¼“å­˜">ä½¿ç”¨åˆ†ç‰‡è¯·æ±‚ç¼“å­˜</h3><ul class="lvl-0"><li class="lvl-2"><p>èšåˆè¯­å¥ä¸­ï¼Œè®¾ç½®ï¼šsizeï¼š0ï¼Œå°±ä¼šä½¿ç”¨åˆ†ç‰‡è¯·æ±‚ç¼“å­˜ç¼“å­˜ç»“æœã€‚size = 0 çš„å«ä¹‰æ˜¯ï¼šåªè¿”å›èšåˆç»“æœï¼Œä¸è¿”å›æŸ¥è¯¢ç»“æœã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;remark_agg&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;remark.keyword&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ‹†åˆ†èšåˆï¼Œä½¿èšåˆå¹¶è¡ŒåŒ–">æ‹†åˆ†èšåˆï¼Œä½¿èšåˆå¹¶è¡ŒåŒ–</h3><ul class="lvl-0"><li class="lvl-2"><p>Elasticsearch æŸ¥è¯¢æ¡ä»¶ä¸­åŒæ—¶æœ‰å¤šä¸ªæ¡ä»¶èšåˆï¼Œé»˜è®¤æƒ…å†µä¸‹èšåˆä¸æ˜¯å¹¶è¡Œè¿è¡Œçš„ã€‚</p></li><li class="lvl-2"><p>å½“ä¸ºæ¯ä¸ªèšåˆæä¾›è‡ªå·±çš„æŸ¥è¯¢å¹¶æ‰§è¡Œ msearch æ—¶ï¼Œæ€§èƒ½ä¼šæœ‰æ˜¾è‘—æå‡ã€‚</p></li><li class="lvl-2"><p>å› æ­¤ï¼Œåœ¨ CPU èµ„æºä¸æ˜¯ç“¶é¢ˆçš„å‰æä¸‹ï¼Œå¦‚æœæƒ³ç¼©çŸ­å“åº”æ—¶é—´ï¼Œå¯ä»¥å°†å¤šä¸ªèšåˆæ‹†åˆ†ä¸ºå¤šä¸ªæŸ¥è¯¢ï¼Œå€ŸåŠ©ï¼šmsearch å®ç°å¹¶è¡Œèšåˆã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å¸¸è§„çš„å¤šæ¡ä»¶èšåˆå®ç°</span></span><br><span class="line">GET /employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">  <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;job_agg&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;job.keyword&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;max_salary&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;max&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;salary&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># msearch æ‹†åˆ†å¤šä¸ªè¯­å¥çš„èšåˆå®ç°</span></span><br><span class="line">GET _msearch</span><br><span class="line">&#123;<span class="string">&quot;index&quot;</span>:<span class="string">&quot;employees&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;size&quot;</span>:0,<span class="string">&quot;aggs&quot;</span>:&#123;<span class="string">&quot;job_agg&quot;</span>:&#123;<span class="string">&quot;terms&quot;</span>:&#123;<span class="string">&quot;field&quot;</span>: <span class="string">&quot;job.keyword&quot;</span>&#125;&#125;&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;index&quot;</span>:<span class="string">&quot;employees&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;size&quot;</span>:0,<span class="string">&quot;aggs&quot;</span>:&#123;<span class="string">&quot;max_salary&quot;</span>:&#123;<span class="string">&quot;max&quot;</span>:&#123;<span class="string">&quot;field&quot;</span>: <span class="string">&quot;salary&quot;</span>&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **åŠ ç²—**
 *æ–œä½“*
 ***åŠ ç²—å¹¶æ–œä½“***
 ~~åˆ é™¤çº¿~~
 ==çªå‡ºæ˜¾ç¤º==
 `çªå‡ºæ˜¾ç¤º(æ¨è)`
 ++ä¸‹åˆ’çº¿++
 ~ä¸‹æ ‡~
 ^ä¸Šæ ‡^
 è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.
 å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **ç‚¹å‡»æŠ˜å **
 è¿™æ˜¯è¢«éšè—çš„å†…å®¹
 +++

::: tips success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
:::

% note info % success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
% endnote %

å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}
 å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ
 --&gt;
&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;æœ¬æ–‡ä»‹ç» Elasticsearch çš„ REST APIsï¼šèšåˆæŸ¥è¯¢&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;Elasticsearchç‰ˆæœ¬8.17.3&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/8.17/rest-apis.html&quot;&gt;å®˜æ–¹æ–‡æ¡£:REST APIs&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/8.17/search-aggregations.html&quot;&gt;å®˜æ–¹æ–‡æ¡£:Aggregations&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;a href=&quot;/2025/04/17/elasticsearch-05-api/&quot; title=&quot;Elasticsearch çš„ REST APIs&quot;&gt;Elasticsearch çš„ REST APIs&lt;/a&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="elastic" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/elastic/"/>
    
    <category term="elasticsearch" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/elastic/elasticsearch/"/>
    
    
    <category term="elasticsearch" scheme="https://blog.hanqunfeng.com/tags/elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>Elasticsearch çš„ REST APIs</title>
    <link href="https://blog.hanqunfeng.com/2025/04/17/elasticsearch-05-api/"/>
    <id>https://blog.hanqunfeng.com/2025/04/17/elasticsearch-05-api/</id>
    <published>2025-04-17T13:30:05.000Z</published>
    <updated>2025-04-23T02:42:29.434Z</updated>
    
    <content type="html"><![CDATA[<!-- **åŠ ç²—** *æ–œä½“* ***åŠ ç²—å¹¶æ–œä½“*** ~~åˆ é™¤çº¿~~ ==çªå‡ºæ˜¾ç¤º== `çªå‡ºæ˜¾ç¤º(æ¨è)` ++ä¸‹åˆ’çº¿++ ~ä¸‹æ ‡~ ^ä¸Šæ ‡^ è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference. å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **ç‚¹å‡»æŠ˜å ** è¿™æ˜¯è¢«éšè—çš„å†…å®¹ +++::: tips success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹:::% note info % success warning dangerè¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹% endnote %å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{} å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ --><h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2"><p>æœ¬æ–‡ä»‹ç» Elasticsearch çš„ REST APIs</p></li><li class="lvl-2"><p>Elasticsearchç‰ˆæœ¬8.17.3</p></li><li class="lvl-2"><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.17/rest-apis.html">å®˜æ–¹æ–‡æ¡£:REST APIs</a></p></li><li class="lvl-2"><a href="/2025/04/22/elasticsearch-06-api-aggs/" title="Elasticsearch çš„ REST APIs:èšåˆæŸ¥è¯¢">Elasticsearch çš„ REST APIs:èšåˆæŸ¥è¯¢</a></li></ul><span id="more"></span><h2 id="è¿”å›å†…å®¹æ ¼å¼åŒ–">è¿”å›å†…å®¹æ ¼å¼åŒ–</h2><ul class="lvl-0"><li class="lvl-2"><p>è¿”å›jsonä¿¡æ¯æ ¼å¼: <code>?pretty</code> è¾“å‡ºæ ¼å¼åŒ–åçš„jsonï¼Œæ¯”å¦‚ï¼š<code>curl http://localhost:9200/_cluster/health?pretty</code></p></li><li class="lvl-2"><p>è¿”å›è¡Œä¿¡æ¯æ ¼å¼: <code>?v</code> è¾“å‡ºå†…å®¹ä¸Šæ–¹ä¼šåŠ ä¸Šæ ‡é¢˜è¡Œï¼Œæ¯”å¦‚ï¼š<code>curl http://localhost:9200/_cat/health?v</code></p></li></ul><h2 id="CAT-APIs">CAT APIs</h2><ul class="lvl-0"><li class="lvl-2"><p>Elasticsearch æä¾›äº† <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.17/cat.html">CAT APIs</a>ï¼Œå®ƒä»¬æä¾›äº†ä¸€ç§ç®€å•çš„æ–¹å¼æ¥æŸ¥çœ‹é›†ç¾¤çŠ¶æ€å’Œé›†ç¾¤ä¸­çš„å„ç§èµ„æºï¼Œæ¯”å¦‚ç´¢å¼•ã€åˆ†ç‰‡ã€èŠ‚ç‚¹ç­‰ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">GET     /_cat/health             <span class="comment">#æŸ¥çœ‹é›†ç¾¤å½“å‰çŠ¶æ€ï¼šçº¢ã€é»„ã€ç»¿</span></span><br><span class="line">GET     /_cat/master             <span class="comment">#æŸ¥çœ‹masterèŠ‚ç‚¹ä¿¡æ¯</span></span><br><span class="line">GET     /_cat/nodes              <span class="comment">#æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯</span></span><br><span class="line">GET     /_cat/plugins            <span class="comment">#æŸ¥çœ‹é›†ç¾¤å„ä¸ªèŠ‚ç‚¹ä¸Šçš„pluginä¿¡æ¯</span></span><br><span class="line">GET     /_cat/indices            <span class="comment">#æŸ¥çœ‹é›†ç¾¤ä¸­æ‰€æœ‰indexçš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">GET     /_cat/indices/&#123;index&#125;    <span class="comment">#æŸ¥çœ‹é›†ç¾¤ä¸­æŒ‡å®šindexçš„è¯¦ç»†ä¿¡æ¯ï¼Œindexï¼šç´¢å¼•åç§°</span></span><br><span class="line">GET     /_cat/allocation         <span class="comment">#æŸ¥çœ‹å•èŠ‚ç‚¹çš„shardåˆ†é…æ•´ä½“æƒ…å†µ</span></span><br><span class="line">GET     /_cat/shards             <span class="comment">#æŸ¥çœ‹å„shardçš„è¯¦ç»†æƒ…å†µ</span></span><br><span class="line">GET     /_cat/shards/&#123;index&#125;     <span class="comment">#æŸ¥çœ‹æŒ‡å®šåˆ†ç‰‡çš„è¯¦ç»†æƒ…å†µ</span></span><br><span class="line">GET     /_cat/segments           <span class="comment">#æŸ¥çœ‹å„indexçš„segmentè¯¦ç»†ä¿¡æ¯,åŒ…æ‹¬segmentå, æ‰€å±shard, å†…å­˜(ç£ç›˜)å ç”¨å¤§å°, æ˜¯å¦åˆ·ç›˜</span></span><br><span class="line">GET     /_cat/segments/&#123;index&#125;   <span class="comment">#æŸ¥çœ‹æŒ‡å®šindexçš„segmentè¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">GET     /_cat/count              <span class="comment">#æŸ¥çœ‹å½“å‰é›†ç¾¤çš„docæ•°é‡</span></span><br><span class="line">GET     /_cat/count/&#123;index&#125;      <span class="comment">#æŸ¥çœ‹æŒ‡å®šç´¢å¼•çš„docæ•°é‡</span></span><br><span class="line">GET     /_cat/recovery           <span class="comment">#æŸ¥çœ‹é›†ç¾¤å†…æ¯ä¸ªshardçš„recoveryè¿‡ç¨‹.è°ƒæ•´replicaã€‚</span></span><br><span class="line">GET     /_cat/recovery/&#123;index&#125;   <span class="comment">#æŸ¥çœ‹æŒ‡å®šç´¢å¼•shardçš„recoveryè¿‡ç¨‹</span></span><br><span class="line">GET     /_cat/pending_tasks      <span class="comment">#æŸ¥çœ‹å½“å‰é›†ç¾¤çš„pending task</span></span><br><span class="line">GET     /_cat/aliases            <span class="comment">#æŸ¥çœ‹é›†ç¾¤ä¸­æ‰€æœ‰aliasä¿¡æ¯,è·¯ç”±é…ç½®ç­‰</span></span><br><span class="line">GET     /_cat/aliases/&#123;<span class="built_in">alias</span>&#125;    <span class="comment">#æŸ¥çœ‹æŒ‡å®šç´¢å¼•çš„aliasä¿¡æ¯</span></span><br><span class="line">GET     /_cat/thread_pool        <span class="comment">#æŸ¥çœ‹é›†ç¾¤å„èŠ‚ç‚¹å†…éƒ¨ä¸åŒç±»å‹çš„threadpoolçš„ç»Ÿè®¡ä¿¡æ¯,</span></span><br><span class="line">GET     /_cat/fielddata          <span class="comment">#æŸ¥çœ‹å½“å‰é›†ç¾¤å„ä¸ªèŠ‚ç‚¹çš„fielddataå†…å­˜ä½¿ç”¨æƒ…å†µ</span></span><br><span class="line">GET     /_cat/fielddata/&#123;fields&#125; <span class="comment">#æŸ¥çœ‹æŒ‡å®šfieldçš„å†…å­˜ä½¿ç”¨æƒ…å†µ,é‡Œé¢ä¼ fieldå±æ€§å¯¹åº”çš„å€¼</span></span><br><span class="line">GET     /_cat/nodeattrs          <span class="comment">#æŸ¥çœ‹å•èŠ‚ç‚¹çš„è‡ªå®šä¹‰å±æ€§</span></span><br><span class="line">GET     /_cat/repositories       <span class="comment">#è¾“å‡ºé›†ç¾¤ä¸­æ³¨å†Œå¿«ç…§å­˜å‚¨åº“</span></span><br><span class="line">GET     /_cat/templates          <span class="comment">#è¾“å‡ºå½“å‰æ­£åœ¨å­˜åœ¨çš„æ¨¡æ¿ä¿¡æ¯</span></span><br></pre></td></tr></table></figure><h2 id="Cluster-APIs">Cluster APIs</h2><ul class="lvl-0"><li class="lvl-2"><p>Elasticsearch æä¾›äº†ä¸€ç³»åˆ—çš„ <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.17/cluster.html">Cluster APIs</a>ï¼Œå®ƒä»¬æä¾›äº†ç®¡ç†å’Œç›‘æ§é›†ç¾¤çŠ¶æ€çš„åŠŸèƒ½</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET     /_cluster/health            <span class="comment"># è·å–é›†ç¾¤çš„å¥åº·çŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬äº†é›†ç¾¤æ€»ä½“çš„çŠ¶å†µå¦‚statusã€number_of_nodesç­‰ã€‚</span></span><br><span class="line">GET     /_cluster/stats             <span class="comment"># æä¾›æ•´ä¸ªé›†ç¾¤å±‚é¢çš„ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…å«ç´¢å¼•ã€èŠ‚ç‚¹å’Œå…¶ä»–é«˜çº§æŒ‡æ ‡ã€‚</span></span><br><span class="line">GET     /_cluster/state             <span class="comment"># æ˜¾ç¤ºé›†ç¾¤å…ƒæ•°æ®çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬è®¾ç½®ã€å—ã€è·¯ç”±è¡¨åŠå…ƒæ•°æ®ç­‰ï¼Œå…è®¸ç”¨æˆ·æŸ¥çœ‹é›†ç¾¤çš„å½“å‰è§†å›¾ã€‚</span></span><br><span class="line">POST    /_cluster/reroute           <span class="comment"># POSTè¯·æ±‚ï¼Œç”¨äºæ‰‹åŠ¨æ”¹å˜åˆ†ç‰‡åˆ†é…æƒ…å†µï¼Œå¯ä»¥å®ç°å¦‚è¿ç§»åˆ†ç‰‡ã€å–æ¶ˆåˆ†é…ç­‰æ“ä½œã€‚</span></span><br><span class="line">GET     /_cluster/nodes/hot_threads <span class="comment"># è¿”å›é›†ç¾¤ä¸­å„ä¸ªèŠ‚ç‚¹â€œæœ€çƒ­â€çš„çº¿ç¨‹å †æ ˆè·Ÿè¸ªï¼Œé»˜è®¤æ˜¾ç¤ºå‰ä¸‰ä¸ªCPUæ—¶é—´æœ€é•¿çš„çº¿ç¨‹ã€‚</span></span><br><span class="line">GET     /_cluster/allocation/explain <span class="comment"># è§£é‡Šä¸ºä½•æŸä¸ªåˆ†ç‰‡è¢«å¦‚æ­¤åˆ†é…ï¼Œå¹¶æä¾›å¦‚ä½•è°ƒæ•´çš„å»ºè®®ã€‚</span></span><br><span class="line">GET     /_cluster/pending_tasks     <span class="comment"># åˆ—å‡ºæ‰€æœ‰ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡åˆ—è¡¨ã€‚</span></span><br><span class="line">GET     /_cluster/settings          <span class="comment"># æŸ¥çœ‹æ•´ä¸ªé›†ç¾¤çº§åˆ«çš„è®¾ç½®ã€‚</span></span><br><span class="line">PUT     /_cluster/settings          <span class="comment"># æ›´æ–°æ•´ä¸ªé›†ç¾¤çº§åˆ«çš„è®¾ç½®ã€‚</span></span><br></pre></td></tr></table></figure><h2 id="Index-APIs">Index APIs</h2><ul class="lvl-0"><li class="lvl-2"><p>Elasticsearch æä¾›äº† <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.17/indices.html">Index APIs</a>ï¼Œå®ƒä»¬æä¾›äº†å¯¹ç´¢å¼•çš„åˆ›å»ºã€æ›´æ–°ã€æŸ¥è¯¢å’Œåˆ é™¤ç­‰æ“ä½œã€‚</p></li><li class="lvl-2"><p>åˆ›å»ºç´¢å¼•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PUT /&lt;target&gt;</span></span><br><span class="line"><span class="comment"># è¿™é‡Œ shopping ä¸ºç´¢å¼•åç§°ï¼Œä½†æ­¤æ—¶æ²¡æœ‰ä¸ºç´¢å¼•è®¾ç½®åˆ†ç‰‡ç­–ç•¥ï¼Œä¹Ÿæ²¡æœ‰è®¾ç½®å­—æ®µä¿¡æ¯</span></span><br><span class="line">curl -X PUT -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping&#x27;</span></span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">&#123;<span class="string">&quot;acknowledged&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;shards_acknowledged&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;index&quot;</span>:<span class="string">&quot;shopping&quot;</span>&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åˆ›å»ºç´¢å¼•å¹¶è®¾ç½®ç´¢å¼•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PUT /&lt;target&gt;</span></span><br><span class="line">curl -X PUT -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;settings&quot;:&#123;&quot;number_of_shards&quot;:&quot;1&quot;,&quot;number_of_replicas&quot;:&quot;2&quot;&#125;&#125;&#x27;</span></span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">&#123;<span class="string">&quot;acknowledged&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;shards_acknowledged&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;index&quot;</span>:<span class="string">&quot;shopping&quot;</span>&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åˆ›å»ºå¹¶æ˜ å°„ç´¢å¼•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PUT /&lt;target&gt;</span></span><br><span class="line"><span class="comment"># è¿™é‡Œè®¾ç½®ç´¢å¼•åˆ†ç‰‡æ•°é‡ä¸º1ï¼Œå‰¯æœ¬æ•°é‡ä¸º2ï¼Œå¹¶è®¾ç½®å­—æ®µä¿¡æ¯</span></span><br><span class="line">curl -X PUT -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">    &quot;settings&quot;:&#123;</span></span><br><span class="line"><span class="string">      &quot;number_of_shards&quot;:&quot;1&quot;,</span></span><br><span class="line"><span class="string">      &quot;number_of_replicas&quot;:&quot;2&quot;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;mappings&quot;:&#123;</span></span><br><span class="line"><span class="string">      &quot;properties&quot;:&#123;</span></span><br><span class="line"><span class="string">        &quot;title&quot;:&#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;:&quot;text&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;category&quot;:&#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;:&quot;keyword&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;price&quot;:&#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;:&quot;double&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;count&quot;:&#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;:&quot;integer&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å‚æ•°è¯´æ˜</span></span><br><span class="line"><span class="comment">## settings: è¿™ä¸ªå‚æ•°ç”¨äºé…ç½®ç´¢å¼•çš„è®¾ç½®ï¼ŒåŒ…æ‹¬åˆ†ç‰‡æ•°é‡å’Œå‰¯æœ¬æ•°é‡ã€‚</span></span><br><span class="line"><span class="comment">### number_of_shards: è¿™ä¸ªå‚æ•°æŒ‡å®šäº†ç´¢å¼•ä¸­åˆ†ç‰‡çš„æ•°é‡ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œnumber_of_shards è®¾ç½®ä¸º 1ï¼Œæ„å‘³ç€ç´¢å¼•å°†åªæœ‰ä¸€ä¸ªä¸»åˆ†ç‰‡ã€‚</span></span><br><span class="line"><span class="comment">### number_of_replicas: è¿™ä¸ªå‚æ•°æŒ‡å®šäº†æ¯ä¸ªä¸»åˆ†ç‰‡çš„å‰¯æœ¬æ•°é‡ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œnumber_of_replicas è®¾ç½®ä¸º 2ï¼Œæ„å‘³ç€æ¯ä¸ªä¸»åˆ†ç‰‡å°†æœ‰ä¸¤ä¸ªå‰¯æœ¬ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## mappings: è¿™ä¸ªå‚æ•°ç”¨äºå®šä¹‰ç´¢å¼•ä¸­çš„å­—æ®µå’Œå­—æ®µç±»å‹ã€‚</span></span><br><span class="line"><span class="comment">### properties: è¿™ä¸ªå‚æ•°å®šä¹‰äº†ç´¢å¼•ä¸­çš„å­—æ®µå’Œå­—æ®µç±»å‹ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæœ‰å››ä¸ªå­—æ®µï¼štitleã€categoryã€images å’Œ priceã€‚</span></span><br><span class="line"><span class="comment">### title: è¿™ä¸ªå­—æ®µçš„ç±»å‹æ˜¯ textï¼Œè¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªå…¨æ–‡æ£€ç´¢å­—æ®µã€‚text é€‚åˆå­˜å‚¨é•¿æ–‡æœ¬æ•°æ®ï¼Œå¹¶æ”¯æŒå…¨æ–‡æœç´¢ã€‚</span></span><br><span class="line"><span class="comment">### category: è¿™ä¸ªå­—æ®µçš„ç±»å‹æ˜¯ keywordï¼Œè¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªå…³é”®å­—å­—æ®µï¼Œä¸æ”¯æŒå…¨æ–‡æ£€ç´¢ã€‚keyword é€‚åˆå­˜å‚¨ä¸éœ€è¦åˆ†è¯çš„çŸ­æ–‡æœ¬æ•°æ®ï¼ˆå¦‚æ ‡ç­¾ã€ç±»åˆ«ç­‰ï¼‰ï¼Œå¹¶ä¸”å¯ä»¥ç”¨äºèšåˆå’Œè¿‡æ»¤ã€‚</span></span><br><span class="line"><span class="comment">### price: è¿™ä¸ªå­—æ®µçš„ç±»å‹æ˜¯ doubleï¼Œè¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªæ•°å­—å­—æ®µã€‚double è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªåŒç²¾åº¦æµ®ç‚¹æ•°å­—æ®µï¼Œé€‚åˆå­˜å‚¨æ•°å€¼æ•°æ®ï¼Œå¦‚ä»·æ ¼</span></span><br><span class="line"><span class="comment">### count: è¿™ä¸ªå­—æ®µçš„ç±»å‹æ˜¯ integerï¼Œè¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªæ•´æ•°å­—æ®µã€‚integer è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ•´æ•°å­—æ®µï¼Œé€‚åˆå­˜å‚¨æ•´æ•°æ•°æ®ï¼Œå¦‚å•†å“æ•°é‡ç­‰ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">&#123;<span class="string">&quot;acknowledged&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;shards_acknowledged&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;index&quot;</span>:<span class="string">&quot;shopping&quot;</span>&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ›´æ–°ç´¢å¼•æ˜ å°„</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PUT /&lt;target&gt;/_mapping</span></span><br><span class="line"><span class="comment"># æ³¨æ„è¯¥apiåªèƒ½å¢åŠ æ–°çš„å­—æ®µï¼Œä¸èƒ½ä¿®æ”¹å·²æœ‰å­—æ®µï¼Œå¦‚æœè¦ä¿®æ”¹æºå­—æ®µç±»å‹æˆ–è€…åˆ†è¯å™¨ç±»å‹ï¼Œä¸‹æ–‡ä¼šä»‹ç»</span></span><br><span class="line">curl -X PUT -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_mapping&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">    &quot;properties&quot;:&#123;</span></span><br><span class="line"><span class="string">      &quot;remark&quot;:&#123;</span></span><br><span class="line"><span class="string">        &quot;type&quot;:&quot;text&quot;,</span></span><br><span class="line"><span class="string">        &quot;analyzer&quot;:&quot;ik_max_word&quot;,</span></span><br><span class="line"><span class="string">        &quot;search_analyzer&quot;:&quot;ik_smart&quot;</span></span><br><span class="line"><span class="string">      &#125;,</span></span><br><span class="line"><span class="string">      &quot;address&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;type&quot;: &quot;text&quot;,</span></span><br><span class="line"><span class="string">        &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span></span><br><span class="line"><span class="string">        &quot;fields&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;keyword&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;type&quot;: &quot;keyword&quot;</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;,</span></span><br><span class="line"><span class="string">      &quot;tags&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;type&quot;: &quot;keyword&quot;</span></span><br><span class="line"><span class="string">      &#125;,</span></span><br><span class="line"><span class="string">      &quot;created_at&quot;: &#123;&quot;type&quot;: &quot;date&quot;, &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;&#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br><span class="line"><span class="comment"># å‚æ•°è¯´æ˜</span></span><br><span class="line"><span class="comment"># è¿™é‡Œä¸ºç´¢å¼•æ·»åŠ äº†4ä¸ªå­—æ®µ</span></span><br><span class="line"><span class="comment"># remarkï¼šæ–°å¢å­—æ®µï¼Œç±»å‹ä¸ºtextï¼Œåˆ†è¯å™¨ä¸ºik_max_wordï¼Œæœç´¢åˆ†è¯å™¨ä¸ºik_smart</span></span><br><span class="line">  <span class="comment"># analyzer: ç´¢å¼•åˆ†è¯å™¨</span></span><br><span class="line">  <span class="comment"># search_analyzerï¼šæœç´¢åˆ†è¯å™¨</span></span><br><span class="line">  <span class="comment"># ik_max_wordï¼šä¸­æ–‡åˆ†è¯å™¨ï¼Œå°†å¥å­æ‹†åˆ†ä¸ºæœ€å¤šè¯å…ƒï¼Œé€‚åˆé•¿å¥å­</span></span><br><span class="line">  <span class="comment"># ik_smartï¼šä¸­æ–‡åˆ†è¯å™¨ï¼Œå°†å¥å­æ‹†åˆ†ä¸ºæœ€å°‘è¯å…ƒï¼Œé€‚åˆçŸ­å¥å­</span></span><br><span class="line"><span class="comment"># addressï¼šæ–°å¢å­—æ®µï¼Œç±»å‹ä¸ºtextï¼Œåˆ†è¯å™¨ä¸ºik_max_wordï¼Œæœç´¢åˆ†è¯å™¨æœªæŒ‡å®šï¼Œé»˜è®¤ä¸åˆ†è¯å™¨åŒä¸€ä¸ªï¼Œè¿™é‡Œè¿˜ä¸ºaddressæ·»åŠ äº†keywordå­—æ®µï¼Œç”¨äºå­˜å‚¨åŸå§‹æ•°æ®ï¼Œä»¥æ”¯æŒç²¾ç¡®æœç´¢</span></span><br><span class="line"><span class="comment"># tagsï¼šæ–°å¢å­—æ®µï¼Œç±»å‹ä¸ºkeywordï¼Œä¸æ”¯æŒåˆ†è¯ï¼Œé€‚åˆå­˜å‚¨çŸ­æ–‡æœ¬æ•°æ®ï¼ˆå¦‚æ ‡ç­¾ã€ç±»åˆ«ç­‰ï¼‰ï¼Œå¹¶ä¸”å¯ä»¥ç”¨äºèšåˆå’Œè¿‡æ»¤ï¼Œå¯ä»¥å­˜å‚¨æ•°ç»„</span></span><br><span class="line"><span class="comment"># created_atï¼šæ–°å¢å­—æ®µï¼Œç±»å‹ä¸ºdateï¼Œæ ¼å¼ä¸ºyyyy-MM-dd HH:mm:ss</span></span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">&#123;<span class="string">&quot;acknowledged&quot;</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ›´æ–°ç´¢å¼•è®¾ç½®</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PUT /&lt;target&gt;/_settings</span></span><br><span class="line"><span class="comment"># æ³¨æ„è¿™é‡Œä¸èƒ½æ›´æ–°number_of_shards</span></span><br><span class="line">curl -X PUT -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_settings&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;number_of_replicas&quot;:&quot;1&quot;&#125;&#x27;</span></span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">&#123;<span class="string">&quot;acknowledged&quot;</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æŸ¥çœ‹æŒ‡å®šç´¢å¼•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># GET /&lt;target&gt;</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping?pretty&#x27;</span></span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;shopping&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;aliases&quot;</span> : &#123; &#125;,</span><br><span class="line">    <span class="string">&quot;mappings&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;properties&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;address&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;fields&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;keyword&quot;</span> : &#123;</span><br><span class="line">              <span class="string">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;analyzer&quot;</span> : <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;category&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;count&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span> : <span class="string">&quot;integer&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;created_at&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span> : <span class="string">&quot;date&quot;</span>,</span><br><span class="line">          <span class="string">&quot;format&quot;</span> : <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;price&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span> : <span class="string">&quot;double&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;remark&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;analyzer&quot;</span> : <span class="string">&quot;ik_max_word&quot;</span>,</span><br><span class="line">          <span class="string">&quot;search_analyzer&quot;</span> : <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;tags&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;title&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;settings&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;index&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;routing&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;allocation&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;include&quot;</span> : &#123;</span><br><span class="line">              <span class="string">&quot;_tier_preference&quot;</span> : <span class="string">&quot;data_content&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;number_of_shards&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;provided_name&quot;</span> : <span class="string">&quot;shopping&quot;</span>,</span><br><span class="line">        <span class="string">&quot;creation_date&quot;</span> : <span class="string">&quot;1745291743120&quot;</span>,</span><br><span class="line">        <span class="string">&quot;number_of_replicas&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;uuid&quot;</span> : <span class="string">&quot;Y1IWrdlQTUm-CbbIWweSxQ&quot;</span>,</span><br><span class="line">        <span class="string">&quot;version&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;created&quot;</span> : <span class="string">&quot;8525000&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æŸ¥çœ‹ç´¢å¼•è®¾ç½®</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># GET /&lt;target&gt;/_settings</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_settings?pretty&#x27;</span></span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;shopping&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;mappings&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;properties&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;address&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;fields&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;keyword&quot;</span> : &#123;</span><br><span class="line">              <span class="string">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;analyzer&quot;</span> : <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;category&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;count&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span> : <span class="string">&quot;integer&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;created_at&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span> : <span class="string">&quot;date&quot;</span>,</span><br><span class="line">          <span class="string">&quot;format&quot;</span> : <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;price&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span> : <span class="string">&quot;double&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;remark&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="string">&quot;analyzer&quot;</span> : <span class="string">&quot;ik_max_word&quot;</span>,</span><br><span class="line">          <span class="string">&quot;search_analyzer&quot;</span> : <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;tags&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span> : <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;title&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æŸ¥çœ‹å­—æ®µæ˜ å°„</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># GET /&lt;target&gt;/_mapping/field/&lt;field&gt;</span></span><br><span class="line"><span class="comment"># shopping ä¸ºç´¢å¼•åç§°ï¼Œtitle ä¸ºå­—æ®µåç§°</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_mapping/field/title?pretty&#x27;</span></span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;shopping&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;mappings&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;title&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;full_name&quot;</span> : <span class="string">&quot;title&quot;</span>,</span><br><span class="line">        <span class="string">&quot;mapping&quot;</span> : &#123;</span><br><span class="line">          <span class="string">&quot;title&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åˆ¤æ–­ç´¢å¼•æ˜¯å¦å­˜åœ¨</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ -I å‚æ•°æ¥å‘é€ HEAD è¯·æ±‚ï¼Œå¯ä»¥è·å–å“åº”å¤´è€Œä¸å¿…ä¸‹è½½å“åº”ä½“ã€‚</span></span><br><span class="line"><span class="comment"># HEAD /&lt;target&gt;</span></span><br><span class="line">curl -I -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping&#x27;</span></span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">X-elastic-product: Elasticsearch</span><br><span class="line">content-type: application/json</span><br><span class="line">content-length: 603</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿™ä¸ªå‘½ä»¤ä¸ä¼šè¿”å›å“åº”ä½“ï¼Œä½†å®ƒçš„ HTTP å“åº”ä»£ç å¯ä»¥å‘Šè¯‰ä½ ç´¢å¼•çš„å­˜åœ¨æƒ…å†µï¼š</span></span><br><span class="line">  <span class="comment"># 200 OK è¡¨ç¤ºç´¢å¼•å­˜åœ¨ã€‚</span></span><br><span class="line">  <span class="comment"># 404 Not Found è¡¨ç¤ºç´¢å¼•ä¸å­˜åœ¨ã€‚</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åˆ é™¤ç´¢å¼•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DELETE /&lt;target&gt;</span></span><br><span class="line">curl -X DELETE -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping&#x27;</span></span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">&#123;<span class="string">&quot;acknowledged&quot;</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ä¸ºç´¢å¼•åˆ›å»ºåˆ«å</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ³¨æ„ï¼šä¸åŒç´¢å¼•å¯ä»¥æœ‰ç›¸åŒåç§°çš„åˆ«åï¼Œæ‰€ä»¥åœ¨æ•°æ®ç»“æ„ä¸€è‡´çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºä¸åŒçš„ç´¢å¼•åˆ›å»ºç›¸åŒçš„åˆ«åï¼Œç„¶åæ ¹æ®åˆ«åè¿›è¡Œæ•°æ®æŸ¥è¯¢</span></span><br><span class="line"><span class="comment"># POST /&lt;target&gt;/_alias/&lt;alias&gt;</span></span><br><span class="line">curl -X POST -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_alias/shopping_alias&#x27;</span></span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">&#123;<span class="string">&quot;acknowledged&quot;</span>:<span class="literal">true</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹æ³•</span></span><br><span class="line">curl -X POST -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/_aliases&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">    &quot;actions&quot;: [</span></span><br><span class="line"><span class="string">      &#123;</span></span><br><span class="line"><span class="string">        &quot;add&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;index&quot;: &quot;shopping&quot;,</span></span><br><span class="line"><span class="string">          &quot;alias&quot;: &quot;shopping_alias2&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">&#123;<span class="string">&quot;acknowledged&quot;</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æŸ¥çœ‹ç´¢å¼•åˆ«å</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># GET /&lt;target&gt;/_alias/&lt;alias&gt;</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_alias/shopping_alias?pretty&#x27;</span></span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;shopping&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;aliases&quot;</span> : &#123;</span><br><span class="line">      <span class="string">&quot;shopping_alias&quot;</span> : &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å½“å‰ç´¢å¼•çš„æ‰€æœ‰åˆ«å</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_alias?pretty&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ‰€æœ‰ç´¢å¼•çš„åˆ«å</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/_alias?pretty&#x27;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ä¸ºç´¢å¼•åˆ é™¤åˆ«å</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DELETE /&lt;target&gt;/_alias/&lt;alias&gt;</span></span><br><span class="line">curl -X DELETE -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_alias/shopping_alias&#x27;</span></span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">&#123;<span class="string">&quot;acknowledged&quot;</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure><h3 id="å¦‚ä½•ä¿®æ”¹ç´¢å¼•å­—æ®µç±»å‹æˆ–åˆ†è¯å™¨ç±»å‹ï¼Ÿ">å¦‚ä½•ä¿®æ”¹ç´¢å¼•å­—æ®µç±»å‹æˆ–åˆ†è¯å™¨ç±»å‹ï¼Ÿ</h3><ul class="lvl-0"><li class="lvl-2"><p>åˆ›å»ºæ–°çš„ç´¢å¼•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿™é‡Œä¸ºtitleå­—æ®µå¢åŠ åˆ†è¯å™¨</span></span><br><span class="line">curl -X PUT -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping_new&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">    &quot;settings&quot;:&#123;</span></span><br><span class="line"><span class="string">      &quot;number_of_shards&quot;:&quot;1&quot;,</span></span><br><span class="line"><span class="string">      &quot;number_of_replicas&quot;:&quot;2&quot;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;mappings&quot;:&#123;</span></span><br><span class="line"><span class="string">      &quot;properties&quot;:&#123;</span></span><br><span class="line"><span class="string">        &quot;category&quot;:&#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;:&quot;keyword&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;price&quot;:&#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;:&quot;double&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;count&quot;:&#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;:&quot;integer&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;title&quot;:&#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;:&quot;text&quot;,</span></span><br><span class="line"><span class="string">          &quot;analyzer&quot;:&quot;ik_max_word&quot;,</span></span><br><span class="line"><span class="string">          &quot;search_analyzer&quot;:&quot;ik_smart&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;remark&quot;:&#123;</span></span><br><span class="line"><span class="string">        &quot;type&quot;:&quot;text&quot;,</span></span><br><span class="line"><span class="string">        &quot;analyzer&quot;:&quot;ik_max_word&quot;,</span></span><br><span class="line"><span class="string">        &quot;search_analyzer&quot;:&quot;ik_smart&quot;</span></span><br><span class="line"><span class="string">      &#125;,</span></span><br><span class="line"><span class="string">      &quot;address&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;type&quot;: &quot;text&quot;,</span></span><br><span class="line"><span class="string">        &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span></span><br><span class="line"><span class="string">        &quot;fields&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;keyword&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;type&quot;: &quot;keyword&quot;</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;,</span></span><br><span class="line"><span class="string">      &quot;tags&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;type&quot;: &quot;keyword&quot;</span></span><br><span class="line"><span class="string">      &#125;,</span></span><br><span class="line"><span class="string">      &quot;created_at&quot;: &#123;&quot;type&quot;: &quot;date&quot;, &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;&#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å°†åŸç´¢å¼•çš„æ•°æ®è¿ç§»åˆ°æ–°ç´¢å¼•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/_reindex&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;source&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;index&quot;: &quot;shopping&quot;</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;dest&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;index&quot;: &quot;shopping_new&quot;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">&#123;<span class="string">&quot;took&quot;</span>:101,<span class="string">&quot;timed_out&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;total&quot;</span>:2,<span class="string">&quot;updated&quot;</span>:0,<span class="string">&quot;created&quot;</span>:2,<span class="string">&quot;deleted&quot;</span>:0,<span class="string">&quot;batches&quot;</span>:1,<span class="string">&quot;version_conflicts&quot;</span>:0,<span class="string">&quot;noops&quot;</span>:0,<span class="string">&quot;retries&quot;</span>:&#123;<span class="string">&quot;bulk&quot;</span>:0,<span class="string">&quot;search&quot;</span>:0&#125;,<span class="string">&quot;throttled_millis&quot;</span>:0,<span class="string">&quot;requests_per_second&quot;</span>:-1.0,<span class="string">&quot;throttled_until_millis&quot;</span>:0,<span class="string">&quot;failures&quot;</span>:[]&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åˆ é™¤åŸç´¢å¼•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -X DELETE -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping&#x27;</span></span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">&#123;<span class="string">&quot;acknowledged&quot;</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ä¸ºæ–°ç´¢å¼•åˆ›å»ºåˆ«å</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping_new/_alias/shopping&#x27;</span></span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">&#123;<span class="string">&quot;acknowledged&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;errors&quot;</span>:<span class="literal">false</span>&#125;</span><br></pre></td></tr></table></figure><h2 id="æ•°æ®å¢åˆ æ”¹åŸºæœ¬æ“ä½œ">æ•°æ®å¢åˆ æ”¹åŸºæœ¬æ“ä½œ</h2><ul class="lvl-0"><li class="lvl-2"><p>æ–°å¢æ•°æ®</p><ul class="lvl-2"><li class="lvl-4">1.ä¸ºæŒ‡å®šç´¢å¼•æ’å…¥ä¸€æ¡æ•°æ®(_docæ–¹å¼ï¼šä¸æŒ‡å®šidé»˜è®¤éšæœºå­—ç¬¦ä¸²)</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _doc çš„æ–¹å¼åˆ›å»ºç´¢å¼•æ•°æ®æ—¶ï¼Œå¯ä»¥ä¸æŒ‡å®šidï¼Œé»˜è®¤ä¼šåˆ›å»ºæ–°çš„idï¼Œidç±»å‹ä¸ºéšæœºå­—ç¬¦ä¸²</span></span><br><span class="line"><span class="comment"># POST /&lt;target&gt;/_doc</span></span><br><span class="line">curl -X POST -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_doc?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">    &quot;category&quot;: &quot;electronics&quot;,</span></span><br><span class="line"><span class="string">    &quot;price&quot;: 999.99,</span></span><br><span class="line"><span class="string">    &quot;count&quot;: 10,</span></span><br><span class="line"><span class="string">    &quot;title&quot;: &quot;Smartphone X - 128GB&quot;,</span></span><br><span class="line"><span class="string">    &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;,</span></span><br><span class="line"><span class="string">    &quot;address&quot;: &quot;123 Electronic Ave, Beijing, China&quot;,</span></span><br><span class="line"><span class="string">    &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;],</span></span><br><span class="line"><span class="string">    &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot;</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;shopping_new&quot;</span>,</span><br><span class="line">  <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;sImNW5YBmgASmV9McVvI&quot;</span>,</span><br><span class="line">  <span class="string">&quot;_version&quot;</span> : 1,</span><br><span class="line">  <span class="string">&quot;result&quot;</span> : <span class="string">&quot;created&quot;</span>,</span><br><span class="line">  <span class="string">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span> : 3,</span><br><span class="line">    <span class="string">&quot;successful&quot;</span> : 1,</span><br><span class="line">    <span class="string">&quot;failed&quot;</span> : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;_seq_no&quot;</span> : 1,</span><br><span class="line">  <span class="string">&quot;_primary_term&quot;</span> : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-2"><li class="lvl-4">2.ä¸ºæŒ‡å®šç´¢å¼•æ’å…¥ä¸€æ¡æ•°æ®(_docæ–¹å¼ï¼šæŒ‡å®šid)</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _doc çš„æ–¹å¼åˆ›å»ºç´¢å¼•æ•°æ®æ—¶ï¼Œå¦‚æœæŒ‡å®šidï¼Œå†æ¬¡æ‰§è¡Œæ—¶ä¼šå…ˆåˆ é™¤åŸæ•°æ®å†åˆ›å»ºæ–°æ•°æ®ï¼Œæ‰€ä»¥å¿…é¡»å…¨é‡æ›´æ–°æ‰è¡Œã€‚</span></span><br><span class="line"><span class="comment"># PUT /&lt;target&gt;/_doc</span></span><br><span class="line">curl -X PUT -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_doc/100?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">    &quot;category&quot;: &quot;electronics&quot;,</span></span><br><span class="line"><span class="string">    &quot;price&quot;: 999.99,</span></span><br><span class="line"><span class="string">    &quot;count&quot;: 10,</span></span><br><span class="line"><span class="string">    &quot;title&quot;: &quot;Smartphone X - 128GB&quot;,</span></span><br><span class="line"><span class="string">    &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;,</span></span><br><span class="line"><span class="string">    &quot;address&quot;: &quot;123 Electronic Ave, Beijing, China&quot;,</span></span><br><span class="line"><span class="string">    &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;],</span></span><br><span class="line"><span class="string">    &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot;</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;shopping_new&quot;</span>,</span><br><span class="line">  <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;100&quot;</span>,</span><br><span class="line">  <span class="string">&quot;_version&quot;</span> : 1,</span><br><span class="line">  <span class="string">&quot;result&quot;</span> : <span class="string">&quot;created&quot;</span>,</span><br><span class="line">  <span class="string">&quot;_shards&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span> : 3,</span><br><span class="line">    <span class="string">&quot;successful&quot;</span> : 1,</span><br><span class="line">    <span class="string">&quot;failed&quot;</span> : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;_seq_no&quot;</span> : 2,</span><br><span class="line">  <span class="string">&quot;_primary_term&quot;</span> : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-2"><li class="lvl-4"><p>3.ä¸ºæŒ‡å®šç´¢å¼•æ’å…¥ä¸€æ¡æ•°æ®(_createæ–¹å¼ï¼šæŒ‡å®šid)</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _create çš„æ–¹å¼åˆ›å»ºç´¢å¼•æ•°æ®æ—¶ï¼Œå¿…é¡»æŒ‡å®šid,è€Œä¸”åªèƒ½æ‰§è¡Œä¸€æ¬¡ï¼Œå› ä¸ºæ‰§è¡Œè¿‡ä¸€æ¬¡åæŒ‡å®šidçš„æ•°æ®å°±å­˜åœ¨äº†ï¼Œä¸èƒ½å†æ¬¡åˆ›å»º</span></span><br><span class="line"><span class="comment"># POST /&lt;target&gt;/_create/&lt;id&gt;</span></span><br><span class="line">curl -X POST -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_create/1?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">    &quot;category&quot;: &quot;electronics&quot;,</span></span><br><span class="line"><span class="string">    &quot;price&quot;: 999.99,</span></span><br><span class="line"><span class="string">    &quot;count&quot;: 10,</span></span><br><span class="line"><span class="string">    &quot;title&quot;: &quot;Smartphone X - 128GB&quot;,</span></span><br><span class="line"><span class="string">    &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;,</span></span><br><span class="line"><span class="string">    &quot;address&quot;: &quot;123 Electronic Ave, Beijing, China&quot;,</span></span><br><span class="line"><span class="string">    &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;],</span></span><br><span class="line"><span class="string">    &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot;</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure></li><li class="lvl-2"><p>ä¿®æ”¹æ•°æ®</p><ul class="lvl-2"><li class="lvl-4">1.ä¿®æ”¹å…¨éƒ¨æ•°æ®</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># POST /&lt;target&gt;/_doc/&lt;id&gt;</span></span><br><span class="line"><span class="comment"># æ‰§è¡Œæ—¶ä¼šå…ˆåˆ é™¤åŸæ•°æ®å†åˆ›å»ºæ–°æ•°æ®ï¼Œæ‰€ä»¥å¿…é¡»å…¨é‡æ›´æ–°æ‰è¡Œã€‚</span></span><br><span class="line">curl -X POST -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_doc/sImNW5YBmgASmV9McVvI&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">    &quot;category&quot;: &quot;electronics&quot;,</span></span><br><span class="line"><span class="string">    &quot;price&quot;: 999.99,</span></span><br><span class="line"><span class="string">    &quot;count&quot;: 20,</span></span><br><span class="line"><span class="string">    &quot;title&quot;: &quot;Smartphone X - 128GB&quot;,</span></span><br><span class="line"><span class="string">    &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;,</span></span><br><span class="line"><span class="string">    &quot;address&quot;: &quot;123 Electronic Ave, Beijing, China&quot;,</span></span><br><span class="line"><span class="string">    &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;],</span></span><br><span class="line"><span class="string">    &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot;</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure><ul class="lvl-2"><li class="lvl-4">2.ä¿®æ”¹éƒ¨åˆ†æ•°æ®</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># POST /&lt;target&gt;/_update/&lt;id&gt;</span></span><br><span class="line"><span class="comment"># æ‰§è¡Œæ—¶åªä¼šä¿®æ”¹æŒ‡å®šå­—æ®µï¼Œä¸ä¼šåˆ é™¤åŸæ•°æ®ï¼Œæ‰€ä»¥å¯ä»¥éƒ¨åˆ†æ›´æ–°ã€‚</span></span><br><span class="line">curl -X POST -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_update/1&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;doc&quot;:&#123;&quot;count&quot;:100&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure></li><li class="lvl-2"><p>æŸ¥è¯¢æŒ‡å®šç´¢å¼•çš„æŒ‡å®šidçš„æ•°æ®</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># GET /&lt;target&gt;/_doc/&lt;id&gt;</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_doc/100?pretty&#x27;</span></span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;_index&quot;</span> : <span class="string">&quot;shopping_new&quot;</span>,</span><br><span class="line">  <span class="string">&quot;_id&quot;</span> : <span class="string">&quot;100&quot;</span>,</span><br><span class="line">  <span class="string">&quot;_version&quot;</span> : 1,</span><br><span class="line">  <span class="string">&quot;_seq_no&quot;</span> : 2,</span><br><span class="line">  <span class="string">&quot;_primary_term&quot;</span> : 1,</span><br><span class="line">  <span class="string">&quot;found&quot;</span> : <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;_source&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;category&quot;</span> : <span class="string">&quot;electronics&quot;</span>,</span><br><span class="line">    <span class="string">&quot;price&quot;</span> : 999.99,</span><br><span class="line">    <span class="string">&quot;count&quot;</span> : 10,</span><br><span class="line">    <span class="string">&quot;title&quot;</span> : <span class="string">&quot;Smartphone X - 128GB&quot;</span>,</span><br><span class="line">    <span class="string">&quot;remark&quot;</span> : <span class="string">&quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;</span>,</span><br><span class="line">    <span class="string">&quot;address&quot;</span> : <span class="string">&quot;123 Electronic Ave, Beijing, China&quot;</span>,</span><br><span class="line">    <span class="string">&quot;tags&quot;</span> : [</span><br><span class="line">      <span class="string">&quot;latest&quot;</span>,</span><br><span class="line">      <span class="string">&quot;smartphone&quot;</span>,</span><br><span class="line">      <span class="string">&quot;technology&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;created_at&quot;</span> : <span class="string">&quot;2025-04-22 03:30:02&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åˆ é™¤æŒ‡å®šç´¢å¼•çš„æŒ‡å®šidçš„æ•°æ®</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DELETE /&lt;target&gt;/_doc/&lt;id&gt;</span></span><br><span class="line">curl -X DELETE -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_doc/100&#x27;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åˆ é™¤ç´¢å¼•å…¨éƒ¨æ•°æ®</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_delete_by_query?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;query&quot;:&#123;&quot;match_all&quot;:&#123;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="æ‰¹é‡æ“ä½œ">æ‰¹é‡æ“ä½œ</h2><ul class="lvl-0"><li class="lvl-2"><p>æ‰¹é‡æ–°å¢æ•°æ®</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ³¨æ„æ•°æ®è¡Œè¦é¡¶è¡Œå†™ï¼Œå‰é¢ä¸è¦æœ‰ç©ºæ ¼</span></span><br><span class="line"><span class="comment"># POST /_bulk</span></span><br><span class="line">curl -X POST -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/_bulk&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;1&quot; &#125; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 999.99, &quot;count&quot;: 10, &quot;title&quot;: &quot;Smartphone X - 128GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;å¹¿å·å¤©æ²³å…¬å›­&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;2&quot; &#125; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;category&quot;: &quot;fashion&quot;, &quot;price&quot;: 49.99, &quot;count&quot;: 25, &quot;title&quot;: &quot;Designer T-shirt&quot;, &quot;remark&quot;: &quot;Trendy designer T-shirt made with high quality fabric.&quot;, &quot;address&quot;: &quot;å¹¿å·è”æ¹¾å¤§å¦&quot;, &quot;tags&quot;: [&quot;clothing&quot;, &quot;designer&quot;, &quot;style&quot;], &quot;created_at&quot;: &quot;2025-04-21 12:15:00&quot; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;3&quot; &#125; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;category&quot;: &quot;home_appliances&quot;, &quot;price&quot;: 299.99, &quot;count&quot;: 5, &quot;title&quot;: &quot;Robot Vacuum Cleaner&quot;, &quot;remark&quot;: &quot;Efficient robot vacuum cleaner with smart navigation.&quot;, &quot;address&quot;: &quot;å¹¿å·ç™½äº‘å±±å…¬å›­&quot;, &quot;tags&quot;: [&quot;appliances&quot;, &quot;vacuum&quot;, &quot;robot&quot;], &quot;created_at&quot;: &quot;2025-04-20 08:45:30&quot; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;4&quot; &#125; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;category&quot;: &quot;books&quot;, &quot;price&quot;: 19.99, &quot;count&quot;: 100, &quot;title&quot;: &quot;Inspirational Novel&quot;, &quot;remark&quot;: &quot;A gripping novel that inspires and motivates.&quot;, &quot;address&quot;: &quot;321 Book Rd, Shenzhen, China&quot;, &quot;tags&quot;: [&quot;book&quot;, &quot;novel&quot;, &quot;inspiration&quot;], &quot;created_at&quot;: &quot;2025-04-19 10:05:00&quot; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;5&quot; &#125; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;category&quot;: &quot;groceries&quot;, &quot;price&quot;: 3.99, &quot;count&quot;: 200, &quot;title&quot;: &quot;Organic Apples&quot;, &quot;remark&quot;: &quot;Fresh and crispy organic apples.&quot;, &quot;address&quot;: &quot;654 Grocery Ln, Chengdu, China&quot;, &quot;tags&quot;: [&quot;fruit&quot;, &quot;organic&quot;, &quot;healthy&quot;], &quot;created_at&quot;: &quot;2025-04-18 14:30:45&quot; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;index&quot;: &#123; &quot;_index&quot;: &quot;shopping&quot;, &quot;_id&quot;: &quot;6&quot; &#125; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 1999.99, &quot;count&quot;: 15, &quot;title&quot;: &quot;Smartphone X - 256GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;å¹¿å·å¤©æ²³å…¬å›­&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br><span class="line"><span class="comment"># å‚æ•°è¯´æ˜</span></span><br><span class="line"><span class="comment"># index: ç”¨äºåˆ›å»ºæ–°æ–‡æ¡£æˆ–æ›¿æ¢å·²æœ‰æ–‡æ¡£ã€‚</span></span><br><span class="line"><span class="comment"># create: ç”¨äºåˆ›å»ºæ–°æ–‡æ¡£ï¼Œå¦‚æœæ–‡æ¡£å·²å­˜åœ¨ï¼Œåˆ™è¿”å›é”™è¯¯ã€‚</span></span><br><span class="line"><span class="comment"># _index: æŒ‡å®šç´¢å¼•åç§°ã€‚</span></span><br><span class="line"><span class="comment"># _id: æŒ‡å®šæ–‡æ¡£IDã€‚å¦‚æœä¸æŒ‡å®šåˆ™ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªéšæœºçš„IDã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰¹é‡æ–°å¢æ•°æ®æ—¶ä¹Ÿå¯ä»¥åœ¨urlä¸­æŒ‡å®šç´¢å¼•åç§°</span></span><br><span class="line"><span class="comment"># æ­¤æ—¶å¯ä»¥æŒ‡å®šidï¼Œå¦‚æœä¸æŒ‡å®šåˆ™è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªéšæœºå­—ç¬¦ä¸²çš„ID</span></span><br><span class="line"><span class="comment"># POST /&lt;target&gt;/_bulk</span></span><br><span class="line">curl -X POST -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_bulk&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 999.99, &quot;count&quot;: 10, &quot;title&quot;: &quot;Smartphone X - 128GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;å¹¿å·å¤©æ²³å…¬å›­&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;category&quot;: &quot;fashion&quot;, &quot;price&quot;: 49.99, &quot;count&quot;: 25, &quot;title&quot;: &quot;Designer T-shirt&quot;, &quot;remark&quot;: &quot;Trendy designer T-shirt made with high quality fabric.&quot;, &quot;address&quot;: &quot;å¹¿å·è”æ¹¾å¤§å¦&quot;, &quot;tags&quot;: [&quot;clothing&quot;, &quot;designer&quot;, &quot;style&quot;], &quot;created_at&quot;: &quot;2025-04-21 12:15:00&quot; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;category&quot;: &quot;home_appliances&quot;, &quot;price&quot;: 299.99, &quot;count&quot;: 5, &quot;title&quot;: &quot;Robot Vacuum Cleaner&quot;, &quot;remark&quot;: &quot;Efficient robot vacuum cleaner with smart navigation.&quot;, &quot;address&quot;: &quot;å¹¿å·ç™½äº‘å±±å…¬å›­&quot;, &quot;tags&quot;: [&quot;appliances&quot;, &quot;vacuum&quot;, &quot;robot&quot;], &quot;created_at&quot;: &quot;2025-04-20 08:45:30&quot; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;category&quot;: &quot;books&quot;, &quot;price&quot;: 19.99, &quot;count&quot;: 100, &quot;title&quot;: &quot;Inspirational Novel&quot;, &quot;remark&quot;: &quot;A gripping novel that inspires and motivates.&quot;, &quot;address&quot;: &quot;321 Book Rd, Shenzhen, China&quot;, &quot;tags&quot;: [&quot;book&quot;, &quot;novel&quot;, &quot;inspiration&quot;], &quot;created_at&quot;: &quot;2025-04-19 10:05:00&quot; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;category&quot;: &quot;groceries&quot;, &quot;price&quot;: 3.99, &quot;count&quot;: 200, &quot;title&quot;: &quot;Organic Apples&quot;, &quot;remark&quot;: &quot;Fresh and crispy organic apples.&quot;, &quot;address&quot;: &quot;654 Grocery Ln, Chengdu, China&quot;, &quot;tags&quot;: [&quot;fruit&quot;, &quot;organic&quot;, &quot;healthy&quot;], &quot;created_at&quot;: &quot;2025-04-18 14:30:45&quot; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;category&quot;: &quot;electronics&quot;, &quot;price&quot;: 1999.99, &quot;count&quot;: 15, &quot;title&quot;: &quot;Smartphone X - 256GB&quot;, &quot;remark&quot;: &quot;This latest Smartphone X comes with a powerful processor and high-resolution camera.&quot;, &quot;address&quot;: &quot;å¹¿å·å¤©æ²³å…¬å›­&quot;, &quot;tags&quot;: [&quot;latest&quot;, &quot;smartphone&quot;, &quot;technology&quot;], &quot;created_at&quot;: &quot;2025-04-22 03:30:02&quot; &#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ‰¹é‡ä¿®æ”¹æ•°æ®</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ³¨æ„æ•°æ®è¡Œè¦é¡¶è¡Œå†™ï¼Œå‰é¢ä¸è¦æœ‰ç©ºæ ¼</span></span><br><span class="line">curl -X POST -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/_bulk&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;update&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;1&quot;&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&quot;doc&quot;:&#123;&quot;title&quot;:&quot;Smartphone X2 - 128GB&quot;,&quot;price&quot;:1000.11&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&quot;update&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;2&quot;&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&quot;doc&quot;:&#123;&quot;title&quot;:&quot;T-shirt&quot;,&quot;price&quot;:45.99&#125;&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br><span class="line"><span class="comment"># å‚æ•°è¯´æ˜</span></span><br><span class="line"><span class="comment"># update: ç”¨äºæ›´æ–°æ–‡æ¡£ã€‚</span></span><br><span class="line"><span class="comment"># doc: æŒ‡å®šè¦æ›´æ–°çš„å­—æ®µã€‚</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ‰¹é‡åˆ é™¤æ•°æ®</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ³¨æ„æ•°æ®è¡Œè¦é¡¶è¡Œå†™ï¼Œå‰é¢ä¸è¦æœ‰ç©ºæ ¼</span></span><br><span class="line">curl -X POST -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/_bulk&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;1&quot;&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;2&quot;&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;3&quot;&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;shopping&quot;,&quot;_id&quot;:&quot;4&quot;&#125;&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br><span class="line"><span class="comment"># å‚æ•°è¯´æ˜</span></span><br><span class="line"><span class="comment"># delete: ç”¨äºåˆ é™¤æ–‡æ¡£ã€‚</span></span><br></pre></td></tr></table></figure><h2 id="æ¡ä»¶æ›´æ–°">æ¡ä»¶æ›´æ–°</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># POST /&lt;target&gt;/_update_by_query</span></span><br><span class="line"><span class="comment"># è¿™é‡Œå°†categoryä¸ºåä¸ºçš„æ•°æ®ä»·æ ¼æ”¹ä¸º1999</span></span><br><span class="line">curl -X POST -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_update_by_query?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">    &quot;query&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;match&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;category&quot;: &quot;books&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;script&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;source&quot;: &quot;ctx._source.price = 20.99&quot;,</span></span><br><span class="line"><span class="string">      &quot;lang&quot;: &quot;painless&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br><span class="line"><span class="comment"># å‚æ•°è¯´æ˜</span></span><br><span class="line"><span class="comment">## &quot;query&quot;: &#123;&#125;  æŸ¥è¯¢æ¡ä»¶</span></span><br><span class="line"><span class="comment">## &quot;script&quot;: &#123;&#125;  è„šæœ¬</span></span><br><span class="line"><span class="comment">### source: è„šæœ¬å†…å®¹</span></span><br><span class="line"><span class="comment">### lang: è„šæœ¬è¯­è¨€</span></span><br><span class="line"><span class="comment">#### painless æ˜¯ Elasticsearch å®˜æ–¹æä¾›çš„è„šæœ¬è¯­è¨€ï¼Œå®ƒæä¾›äº†è®¸å¤šå†…ç½®å‡½æ•°å’Œå˜é‡ï¼Œå¯ä»¥æ–¹ä¾¿åœ°å®ç°å„ç§å¤æ‚çš„é€»è¾‘æ“ä½œã€‚https://www.elastic.co/guide/en/elasticsearch/painless/current/painless-lang-spec.html</span></span><br></pre></td></tr></table></figure><h2 id="æ¡ä»¶åˆ é™¤">æ¡ä»¶åˆ é™¤</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># POST /&lt;target&gt;/_delete_by_query</span></span><br><span class="line">curl -X POST -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_delete_by_query?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;query&quot;:&#123;&quot;match&quot;:&#123;&quot;category&quot;:&quot;books&quot;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="æ¡ä»¶æŸ¥è¯¢">æ¡ä»¶æŸ¥è¯¢</h2><h3 id="match-all-å…¨éƒ¨åŒ¹é…æŸ¥è¯¢">match_all: å…¨éƒ¨åŒ¹é…æŸ¥è¯¢</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># GET /&lt;target&gt;/_search</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span></span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;query&quot;:&#123;&quot;match_all&quot;:&#123;&#125;&#125;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–è€…ç®€å†™ä¸º</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="term-ç²¾ç¡®åŒ¹é…æŸ¥è¯¢ï¼ˆå…³é”®å­—æŸ¥è¯¢ï¼Œå³ä¸åˆ†è¯ï¼‰">term: ç²¾ç¡®åŒ¹é…æŸ¥è¯¢ï¼ˆå…³é”®å­—æŸ¥è¯¢ï¼Œå³ä¸åˆ†è¯ï¼‰</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;query&quot;:&#123;&quot;term&quot;:&#123;&quot;category&quot;:&quot;electronics&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœå­—æ®µè¢«é¢å¤–è®¾ç½® keyword ç±»å‹ï¼Œåˆ™éœ€è¦åŠ ä¸Š .keyword åç¼€</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;query&quot;:&#123;&quot;term&quot;:&#123;&quot;address.keyword&quot;:&quot;å¹¿å·ç™½äº‘å±±å…¬å›­&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># termå¤„ç†å¤šå€¼å­—æ®µ(æ•°ç»„)æ—¶ï¼ŒtermæŸ¥è¯¢æ˜¯åŒ…å«ï¼Œä¸æ˜¯ç­‰äº</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;query&quot;:&#123;&quot;term&quot;:&#123;&quot;tags&quot;:&quot;technology&quot;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="terms-å¤šå…³é”®å­—ç²¾ç¡®åŒ¹é…æŸ¥è¯¢">terms: å¤šå…³é”®å­—ç²¾ç¡®åŒ¹é…æŸ¥è¯¢</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;query&quot;:&#123;&quot;terms&quot;:&#123;&quot;category&quot;:[&quot;electronics&quot;,&quot;books&quot;]&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="range-èŒƒå›´æŸ¥è¯¢">range: èŒƒå›´æŸ¥è¯¢</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;query&quot;:&#123;&quot;range&quot;:&#123;&quot;price&quot;:&#123;&quot;gte&quot;:20,&quot;lte&quot;:30&#125;&#125;&#125;&#125;&#x27;</span></span><br><span class="line">  <span class="comment"># gte: å¤§äºç­‰äº</span></span><br><span class="line">  <span class="comment"># lte: å°äºç­‰äº</span></span><br><span class="line">  <span class="comment"># gt: å¤§äº</span></span><br><span class="line">  <span class="comment"># lt: å°äº</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ—¶é—´èŒƒå›´æŸ¥è¯¢</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;query&quot;:&#123;&quot;range&quot;:&#123;&quot;created_at&quot;:&#123;&quot;gte&quot;:&quot;2025-04-20 00:00:00&quot;,&quot;lte&quot;:&quot;2025-05-20 23:59:59&quot;&#125;&#125;&#125;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åŸºäºæ—¥æœŸæ•°å­¦è¡¨è¾¾å¼æŸ¥è¯¢</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;query&quot;:&#123;&quot;range&quot;:&#123;&quot;created_at&quot;:&#123;&quot;gte&quot;:&quot;now-1y&quot;&#125;&#125;&#125;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ”¯æŒçš„æ—¥æœŸè¡¨è¾¾å¼</span></span><br><span class="line"><span class="comment"># - nowï¼šå½“å‰æ—¶é—´ç‚¹ã€‚</span></span><br><span class="line"><span class="comment"># - now-1dï¼šä»å½“å‰æ—¶é—´ç‚¹å‘å‰æ¨1å¤©çš„æ—¶é—´ç‚¹ã€‚</span></span><br><span class="line"><span class="comment"># - now-1wï¼šä»å½“å‰æ—¶é—´ç‚¹å‘å‰æ¨1å‘¨çš„æ—¶é—´ç‚¹ã€‚</span></span><br><span class="line"><span class="comment"># - now-1Mï¼šä»å½“å‰æ—¶é—´ç‚¹å‘å‰æ¨1ä¸ªæœˆçš„æ—¶é—´ç‚¹ã€‚</span></span><br><span class="line"><span class="comment"># - now-1yï¼šä»å½“å‰æ—¶é—´ç‚¹å‘å‰æ¨1å¹´çš„æ—¶é—´ç‚¹ã€‚</span></span><br><span class="line"><span class="comment"># - now+1hï¼šä»å½“å‰æ—¶é—´ç‚¹å‘åæ¨1å°æ—¶çš„æ—¶é—´ç‚¹ã€‚</span></span><br></pre></td></tr></table></figure><h3 id="exists-æŸ¥è¯¢å­—æ®µå­˜åœ¨çš„æ•°æ®">exists: æŸ¥è¯¢å­—æ®µå­˜åœ¨çš„æ•°æ®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;query&quot;:&#123;&quot;exists&quot;:&#123;&quot;field&quot;:&quot;title&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class="line">  <span class="comment"># field: æŒ‡å®šè¦æŸ¥è¯¢çš„å­—æ®µ</span></span><br><span class="line">  <span class="comment"># ç¤ºä¾‹ï¼šæŸ¥è¯¢ title å­—æ®µå­˜åœ¨çš„æ–‡æ¡£</span></span><br></pre></td></tr></table></figure><h3 id="ids-æ ¹æ®ä¸€ç»„IDæŸ¥è¯¢">ids: æ ¹æ®ä¸€ç»„IDæŸ¥è¯¢</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;query&quot;:&#123;&quot;ids&quot;:&#123;&quot;values&quot;:[&quot;1&quot;,&quot;2&quot;]&#125;&#125;&#125;&#x27;</span></span><br><span class="line">  <span class="comment"># values: æŒ‡å®šè¦æŸ¥è¯¢çš„IDåˆ—è¡¨</span></span><br><span class="line">  <span class="comment"># ç¤ºä¾‹ï¼šæŸ¥è¯¢IDä¸º1å’Œ2çš„æ–‡æ¡£</span></span><br></pre></td></tr></table></figure><h3 id="prefix-å‰ç¼€æŸ¥è¯¢">prefix: å‰ç¼€æŸ¥è¯¢</h3><ul class="lvl-0"><li class="lvl-2"><p>ä»…é€‚ç”¨äºå…³é”®å­—ç±»å‹(keyword)çš„å­—æ®µ</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;query&quot;:&#123;&quot;prefix&quot;:&#123;&quot;category&quot;:&quot;elec&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»…é€‚ç”¨äºkeywordç±»å‹å­—æ®µï¼Œæ‰€ä»¥ä¸‹é¢è¿™ä¸ªè¯·æ±‚æŸ¥è¯¢ä¸åˆ°æ•°æ®</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;query&quot;:&#123;&quot;prefix&quot;:&#123;&quot;address&quot;:&quot;å¹¿å·ç™½äº‘å±±&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class="line"><span class="comment"># å› ä¸ºaddressè¢«é™„åŠ äº†keywordç±»å‹ï¼Œæ‰€ä»¥éœ€è¦åŠ ä¸Š.keywordåç¼€åå¯ä»¥æŸ¥è¯¢åˆ°æ•°æ®</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;query&quot;:&#123;&quot;prefix&quot;:&#123;&quot;address.keyword&quot;:&quot;å¹¿å·ç™½äº‘å±±&quot;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="wildcard-é€šé…ç¬¦æŸ¥è¯¢">wildcard: é€šé…ç¬¦æŸ¥è¯¢</h3><ul class="lvl-0"><li class="lvl-2"><p>ä»…é€‚ç”¨äºå…³é”®å­—ç±»å‹(keyword)çš„å­—æ®µ</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;query&quot;:&#123;&quot;wildcard&quot;:&#123;&quot;category&quot;:&quot;e?e*&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class="line"><span class="comment"># ?: ä»»æ„å•ä¸ªå­—ç¬¦</span></span><br><span class="line"><span class="comment"># *: ä»»æ„å¤šä¸ªå­—ç¬¦</span></span><br></pre></td></tr></table></figure><h3 id="regexp-æ­£åˆ™è¡¨è¾¾å¼æŸ¥è¯¢">regexp: æ­£åˆ™è¡¨è¾¾å¼æŸ¥è¯¢</h3><ul class="lvl-0"><li class="lvl-2"><p>ä»…é€‚ç”¨äºå…³é”®å­—ç±»å‹(keyword)çš„å­—æ®µ</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;query&quot;:&#123;&quot;regexp&quot;:&#123;&quot;category&quot;:&quot;e.e.*&quot;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="fuzzy-æ”¯æŒç¼–è¾‘è·ç¦»çš„æ¨¡ç³ŠæŸ¥è¯¢">fuzzy: æ”¯æŒç¼–è¾‘è·ç¦»çš„æ¨¡ç³ŠæŸ¥è¯¢</h3><ul class="lvl-0"><li class="lvl-2"><p>ä»…é€‚ç”¨äºå…³é”®å­—ç±»å‹(keyword)çš„å­—æ®µ</p></li><li class="lvl-2"><p>fuzzyæ£€ç´¢æ˜¯ä¸€ç§å¼ºå¤§çš„æœç´¢åŠŸèƒ½ï¼Œå®ƒèƒ½å¤Ÿåœ¨ç”¨æˆ·è¾“å…¥å†…å®¹å­˜åœ¨æ‹¼å†™é”™è¯¯æˆ–ä¸Šä¸‹æ–‡ä¸ä¸€è‡´æ—¶ï¼Œä»ç„¶è¿”å›ä¸æœç´¢è¯ç›¸ä¼¼çš„æ–‡æ¡£ã€‚é€šè¿‡ä½¿ç”¨ç¼–è¾‘è·ç¦»ç®—æ³•æ¥åº¦é‡è¾“å…¥è¯ä¸æ–‡æ¡£ä¸­è¯æ¡çš„ç›¸ä¼¼ç¨‹åº¦ï¼Œæ¨¡ç³ŠæŸ¥è¯¢åœ¨ä¿è¯æœç´¢ç»“æœç›¸å…³æ€§çš„åŒæ—¶ï¼Œæœ‰æ•ˆåœ°æé«˜äº†æœç´¢å®¹é”™èƒ½åŠ›ã€‚</p></li><li class="lvl-2"><p>ç¼–è¾‘è·ç¦»æ˜¯æŒ‡ä»ä¸€ä¸ªå•è¯è½¬æ¢åˆ°å¦ä¸€ä¸ªå•è¯éœ€è¦ç¼–è¾‘å•å­—ç¬¦çš„æ¬¡æ•°ã€‚å¦‚ä¸­æ–‡é›†å›¢åˆ°ä¸­å¨é›†å›¢ç¼–è¾‘è·ç¦»å°±æ˜¯1ï¼Œåªéœ€è¦ä¿®æ”¹ä¸€ä¸ªå­—ç¬¦ï¼›å¦‚æœfuzzinesså€¼åœ¨è¿™é‡Œè®¾ç½®æˆ2ï¼Œä¼šæŠŠç¼–è¾‘è·ç¦»ä¸º2çš„ä¸œä¸œé›†å›¢ä¹ŸæŸ¥å‡ºæ¥ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">      &quot;query&quot;:&#123;</span></span><br><span class="line"><span class="string">        &quot;fuzzy&quot;:&#123;</span></span><br><span class="line"><span class="string">          &quot;category&quot;:&#123;</span></span><br><span class="line"><span class="string">            &quot;value&quot;:&quot;beeks&quot;,</span></span><br><span class="line"><span class="string">            &quot;fuzziness&quot;:&quot;2&quot;,</span></span><br><span class="line"><span class="string">            &quot;prefix_length&quot;:1</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;&#x27;</span></span><br><span class="line"><span class="comment"># fuzzinessï¼šç”¨äºç¼–è¾‘è·ç¦»çš„è®¾ç½®ï¼Œå…¶é»˜è®¤å€¼ä¸ºAUTOï¼Œæ”¯æŒçš„æ•°å€¼ä¸º[0ï¼Œ1ï¼Œ2]ã€‚å¦‚æœå€¼è®¾ç½®è¶Šç•Œä¼šæŠ¥é”™ã€‚</span></span><br><span class="line"><span class="comment"># prefix_length: æœç´¢è¯çš„å‰ç¼€é•¿åº¦ï¼Œåœ¨æ­¤é•¿åº¦å†…ä¸ä¼šåº”ç”¨æ¨¡ç³ŠåŒ¹é…ã€‚é»˜è®¤æ˜¯0ï¼Œå³æ•´ä¸ªè¯éƒ½ä¼šè¢«æ¨¡ç³ŠåŒ¹é…ã€‚</span></span><br></pre></td></tr></table></figure><h3 id="match-å…¨æ–‡æ£€ç´¢-å³åˆ†è¯">match: å…¨æ–‡æ£€ç´¢(å³åˆ†è¯)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;query&quot;:&#123;&quot;match&quot;:&#123;&quot;address&quot;:&quot;å¹¿å·ç™½äº‘å±±å…¬å›­&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å› ä¸º desc çš„ç´¢å¼•åˆ†è¯å™¨æ˜¯ ik_max_wordï¼ŒæŸ¥çœ‹â€œå¹¿å·ç™½äº‘å±±å…¬å›­â€è¢«åˆ†è¯åçš„ç»“æœ</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/_analyze?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">        &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span></span><br><span class="line"><span class="string">        &quot;text&quot;: &quot;å¹¿å·ç™½äº‘å±±å…¬å›­&quot;</span></span><br><span class="line"><span class="string">    &#125;&#x27;</span></span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;tokens&quot;</span> : [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;token&quot;</span> : <span class="string">&quot;å¹¿å·&quot;</span>,</span><br><span class="line">      <span class="string">&quot;start_offset&quot;</span> : 0,</span><br><span class="line">      <span class="string">&quot;end_offset&quot;</span> : 2,</span><br><span class="line">      <span class="string">&quot;type&quot;</span> : <span class="string">&quot;CN_WORD&quot;</span>,</span><br><span class="line">      <span class="string">&quot;position&quot;</span> : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;token&quot;</span> : <span class="string">&quot;ç™½äº‘å±±&quot;</span>,</span><br><span class="line">      <span class="string">&quot;start_offset&quot;</span> : 2,</span><br><span class="line">      <span class="string">&quot;end_offset&quot;</span> : 5,</span><br><span class="line">      <span class="string">&quot;type&quot;</span> : <span class="string">&quot;CN_WORD&quot;</span>,</span><br><span class="line">      <span class="string">&quot;position&quot;</span> : 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;token&quot;</span> : <span class="string">&quot;ç™½äº‘&quot;</span>,</span><br><span class="line">      <span class="string">&quot;start_offset&quot;</span> : 2,</span><br><span class="line">      <span class="string">&quot;end_offset&quot;</span> : 4,</span><br><span class="line">      <span class="string">&quot;type&quot;</span> : <span class="string">&quot;CN_WORD&quot;</span>,</span><br><span class="line">      <span class="string">&quot;position&quot;</span> : 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;token&quot;</span> : <span class="string">&quot;äº‘å±±&quot;</span>,</span><br><span class="line">      <span class="string">&quot;start_offset&quot;</span> : 3,</span><br><span class="line">      <span class="string">&quot;end_offset&quot;</span> : 5,</span><br><span class="line">      <span class="string">&quot;type&quot;</span> : <span class="string">&quot;CN_WORD&quot;</span>,</span><br><span class="line">      <span class="string">&quot;position&quot;</span> : 3</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;token&quot;</span> : <span class="string">&quot;å…¬å›­&quot;</span>,</span><br><span class="line">      <span class="string">&quot;start_offset&quot;</span> : 5,</span><br><span class="line">      <span class="string">&quot;end_offset&quot;</span> : 7,</span><br><span class="line">      <span class="string">&quot;type&quot;</span> : <span class="string">&quot;CN_WORD&quot;</span>,</span><br><span class="line">      <span class="string">&quot;position&quot;</span> : 4</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># æ‰€ä»¥åªè¦descä¸­åŒ…å«å¦‚ä¸Šè¿™äº›å†…å®¹çš„æ•°æ®éƒ½ä¼šè¢«åŒ¹é…ä¸Š</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½†æ˜¯è¿™æ ·åŒ¹é…çš„ç»“æœå°±ä¸å¤Ÿç²¾ç¡®ï¼Œå¦‚ä½•å°½é‡åŒ¹é…æ›´å¤šçš„åˆ†è¯å‘¢ï¼Œå¯ä»¥å¢åŠ  minimum_should_match</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">    &quot;query&quot;:&#123;</span></span><br><span class="line"><span class="string">      &quot;match&quot;:&#123;</span></span><br><span class="line"><span class="string">        &quot;address&quot;:&#123;</span></span><br><span class="line"><span class="string">          &quot;query&quot;: &quot;å¹¿å·ç™½äº‘å±±å…¬å›­&quot;,</span></span><br><span class="line"><span class="string">          &quot;minimum_should_match&quot;: 2</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br><span class="line"><span class="comment"># minimum_should_match: 2 è¡¨ç¤ºè‡³å°‘åŒ¹é…ä¸¤ä¸ª</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœå¸Œæœ›å…¨éƒ¨éƒ½åŒ¹é…å‘¢</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">    &quot;query&quot;:&#123;</span></span><br><span class="line"><span class="string">      &quot;match&quot;:&#123;</span></span><br><span class="line"><span class="string">        &quot;address&quot;:&#123;</span></span><br><span class="line"><span class="string">          &quot;query&quot;: &quot;å¹¿å·ç™½äº‘å±±å…¬å›­&quot;,</span></span><br><span class="line"><span class="string">          &quot;operator&quot;: &quot;and&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br><span class="line"><span class="comment"># operator: and è¡¨ç¤ºå…¨éƒ¨åŒ¹é…ï¼Œæ­¤æ—¶ç›¸å½“äºç²¾ç¡®åŒ¹é…ï¼Œå…¶é»˜è®¤å€¼æ˜¯ or</span></span><br></pre></td></tr></table></figure><h3 id="multi-match-å¤šå­—æ®µæŸ¥è¯¢">multi_match: å¤šå­—æ®µæŸ¥è¯¢</h3><ul class="lvl-0"><li class="lvl-2"><p>multi_matchæŸ¥è¯¢åœ¨Elasticsearchä¸­ç”¨äºåœ¨å¤šä¸ªå­—æ®µä¸Šæ‰§è¡Œç›¸åŒçš„æœç´¢æ“ä½œã€‚å®ƒå¯ä»¥æ¥å—ä¸€ä¸ªæŸ¥è¯¢å­—ç¬¦ä¸²ï¼Œå¹¶åœ¨æŒ‡å®šçš„å­—æ®µé›†åˆä¸­æœç´¢è¿™ä¸ªå­—ç¬¦ä¸²ã€‚multi_matchæŸ¥è¯¢æä¾›äº†çµæ´»çš„åŒ¹é…ç±»å‹å’Œæ“ä½œç¬¦é€‰é¡¹ï¼Œä»¥ä¾¿æ ¹æ®ä¸åŒçš„æœç´¢éœ€æ±‚è°ƒæ•´æœç´¢è¡Œä¸ºã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">    &quot;query&quot;:&#123;</span></span><br><span class="line"><span class="string">      &quot;multi_match&quot;:&#123;</span></span><br><span class="line"><span class="string">        &quot;query&quot;: &quot;å¹¿å·shirt&quot;,</span></span><br><span class="line"><span class="string">        &quot;fields&quot;:[&quot;title&quot;,&quot;address&quot;]</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br><span class="line"><span class="comment"># query: æŸ¥è¯¢æ¡ä»¶</span></span><br><span class="line"><span class="comment"># fields: æŒ‡å®šå¤šä¸ªå­—æ®µè¿›è¡ŒåŒ¹é…</span></span><br></pre></td></tr></table></figure><h3 id="match-phrase-çŸ­è¯­æŸ¥è¯¢">match_phrase: çŸ­è¯­æŸ¥è¯¢</h3><ul class="lvl-0"><li class="lvl-2"><p>match_phraseæŸ¥è¯¢åœ¨Elasticsearchä¸­ç”¨äºæ‰§è¡ŒçŸ­è¯­æœç´¢ï¼Œå®ƒä¸ä»…åŒ¹é…æ•´ä¸ªçŸ­è¯­ï¼Œè€Œä¸”è¿˜è€ƒè™‘äº†çŸ­è¯­ä¸­å„ä¸ªè¯çš„é¡ºåºå’Œä½ç½®ã€‚è¿™ç§æŸ¥è¯¢ç±»å‹å¯¹äºæœç´¢ç²¾ç¡®çŸ­è¯­éå¸¸æœ‰ç”¨ï¼Œå°¤å…¶æ˜¯åœ¨ç”¨æˆ·è¾“å…¥çš„æŸ¥è¯¢ä¸æ–‡æ¡£ä¸­çš„æ–‡æœ¬è¡¨è¾¾æ–¹å¼éœ€è¦ä¸¥æ ¼åŒ¹é…æ—¶ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;:&#123;</span></span><br><span class="line"><span class="string">      &quot;match_phrase&quot;:&#123;</span></span><br><span class="line"><span class="string">        &quot;address&quot;:&#123;</span></span><br><span class="line"><span class="string">          &quot;query&quot;:&quot;å¹¿å·ç™½äº‘å±±&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br><span class="line"><span class="comment"># è¦æ±‚æŸ¥è¯¢ç»“æœä¸­çš„æ•°æ®å¿…é¡»åŒ…å«&quot;å¹¿å·ç™½äº‘å±±&quot;ï¼Œè€Œä¸”â€œå¹¿å·â€å’Œâ€œç™½äº‘å±±â€è¿™ä¸¤ä¸ªè¯æ˜¯ä¸èƒ½åˆ†å¼€çš„ï¼Œå› ä¸º match_phrase åŒ¹é…çš„æ˜¯ç›¸é‚»è¯æ¡</span></span><br></pre></td></tr></table></figure><h3 id="query-string-æ”¯æŒä¸æˆ–éè¡¨è¾¾å¼çš„æŸ¥è¯¢">query_string: æ”¯æŒ<code>ä¸æˆ–é</code>è¡¨è¾¾å¼çš„æŸ¥è¯¢</h3><ul class="lvl-0"><li class="lvl-2"><p>query_stringæŸ¥è¯¢æ˜¯ä¸€ç§çµæ´»çš„æŸ¥è¯¢ç±»å‹ï¼Œå®ƒå…è®¸ä½¿ç”¨LuceneæŸ¥è¯¢è¯­æ³•æ¥æ„å»ºå¤æ‚çš„æœç´¢æŸ¥è¯¢ã€‚è¿™ç§æŸ¥è¯¢ç±»å‹æ”¯æŒå¤šç§é€»è¾‘è¿ç®—ç¬¦ï¼ŒåŒ…æ‹¬ä¸ï¼ˆANDï¼‰ã€æˆ–ï¼ˆORï¼‰å’Œéï¼ˆNOTï¼‰ï¼Œä»¥åŠé€šé…ç¬¦ã€æ¨¡ç³Šæœç´¢å’Œæ­£åˆ™è¡¨è¾¾å¼ç­‰åŠŸèƒ½ã€‚query_stringæŸ¥è¯¢å¯ä»¥åœ¨å•ä¸ªæˆ–å¤šä¸ªå­—æ®µä¸Šè¿›è¡Œæœç´¢ï¼Œå¹¶ä¸”å¯ä»¥å¤„ç†å¤æ‚çš„æŸ¥è¯¢é€»è¾‘ã€‚</p></li><li class="lvl-2"><p>æ³¨æ„: æŸ¥è¯¢å­—æ®µåˆ†è¯å°±å°†æŸ¥è¯¢æ¡ä»¶åˆ†è¯æŸ¥è¯¢ï¼ŒæŸ¥è¯¢å­—æ®µä¸åˆ†è¯å°†æŸ¥è¯¢æ¡ä»¶ä¸åˆ†è¯æŸ¥è¯¢</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥è¯¢æ‰€æœ‰å­—æ®µä¸­åŒ…å« &quot;å…¬å›­&quot;å’Œ &quot;åä¸º&quot; çš„æ–‡æ¡£</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;:&#123;</span></span><br><span class="line"><span class="string">      &quot;query_string&quot;:&#123;</span></span><br><span class="line"><span class="string">        &quot;query&quot;:&quot;å…¬å›­ AND electronics&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šæŸ¥è¯¢çš„å•ä¸ªå­—æ®µ</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;:&#123;</span></span><br><span class="line"><span class="string">      &quot;query_string&quot;:&#123;</span></span><br><span class="line"><span class="string">        &quot;default_field&quot;:&quot;category&quot;,</span></span><br><span class="line"><span class="string">        &quot;query&quot;:&quot;ç™½äº‘å±± OR books&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šæŸ¥è¯¢çš„å¤šä¸ªå­—æ®µ</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;:&#123;</span></span><br><span class="line"><span class="string">      &quot;query_string&quot;:&#123;</span></span><br><span class="line"><span class="string">        &quot;fields&quot;:[&quot;category&quot;,&quot;address&quot;],</span></span><br><span class="line"><span class="string">        &quot;query&quot;:&quot;ç™½äº‘å±± OR (electronics AND shirt)&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="simple-query-string-ç±»ä¼¼-query-stringï¼Œä½†æ˜¯ä¼šå¿½ç•¥é”™è¯¯çš„è¯­æ³•ï¼ŒåŒæ—¶åªæ”¯æŒéƒ¨åˆ†æŸ¥è¯¢è¯­æ³•">simple_query_string: ç±»ä¼¼ <code>query_string</code>ï¼Œä½†æ˜¯ä¼šå¿½ç•¥é”™è¯¯çš„è¯­æ³•ï¼ŒåŒæ—¶åªæ”¯æŒéƒ¨åˆ†æŸ¥è¯¢è¯­æ³•</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;:&#123;</span></span><br><span class="line"><span class="string">      &quot;simple_query_string&quot;:&#123;</span></span><br><span class="line"><span class="string">        &quot;query&quot;:&quot;å¹¿å·å…¬å›­&quot;,</span></span><br><span class="line"><span class="string">        &quot;default_operator&quot;:&quot;AND&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br><span class="line"><span class="comment"># default_operator: é»˜è®¤ä¸º ORï¼Œè®¾ç½®ä¸º AND åˆ™å¿…é¡»åŒæ—¶åŒ¹é…</span></span><br></pre></td></tr></table></figure><div class="tips"><p><em><strong>ESæŸ¥è¯¢ç»“æœå±æ€§å«ä¹‰</strong></em></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;took&quot;</span>:16,          <span class="comment"># è¡¨ç¤ºæŸ¥è¯¢ä»è¯·æ±‚åˆ°å®Œæˆè€—æ—¶ 16 æ¯«ç§’ã€‚</span></span><br><span class="line">  <span class="string">&quot;timed_out&quot;</span>:<span class="literal">false</span>,  <span class="comment"># è¡¨ç¤ºæŸ¥è¯¢åœ¨è§„å®šçš„æ—¶é—´å†…å®Œæˆï¼Œæ²¡æœ‰å‘ç”Ÿè¶…æ—¶ã€‚å¦‚æœä¸º trueï¼Œåˆ™è¡¨ç¤ºæŸ¥è¯¢è¶…æ—¶ã€‚</span></span><br><span class="line">  <span class="string">&quot;_shards&quot;</span>:&#123;         <span class="comment"># æ¶‰åŠåˆ°æŸ¥è¯¢è¿‡ç¨‹ä¸­ä½¿ç”¨çš„åˆ†ç‰‡ä¿¡æ¯</span></span><br><span class="line">    <span class="string">&quot;total&quot;</span>:1,        <span class="comment"># è¡¨ç¤ºæŸ¥è¯¢æ¶‰åŠåˆ°çš„æ€»åˆ†ç‰‡æ•°ä¸º 1</span></span><br><span class="line">    <span class="string">&quot;successful&quot;</span>:1,   <span class="comment"># è¡¨ç¤ºæŸ¥è¯¢æˆåŠŸå®Œæˆçš„åˆ†ç‰‡æ•°ä¸º 1</span></span><br><span class="line">    <span class="string">&quot;skipped&quot;</span>:0,      <span class="comment"># è¡¨ç¤ºæŸ¥è¯¢è¿‡ç¨‹ä¸­è¢«è·³è¿‡çš„åˆ†ç‰‡æ•°ä¸º 0</span></span><br><span class="line">    <span class="string">&quot;failed&quot;</span>:0        <span class="comment"># è¡¨ç¤ºæŸ¥è¯¢è¿‡ç¨‹ä¸­å¤±è´¥çš„åˆ†ç‰‡æ•°ä¸º 0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;hits&quot;</span>:&#123;            <span class="comment"># åŒ…å«æŸ¥è¯¢ç»“æœçš„è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line">    <span class="string">&quot;total&quot;</span>:&#123;         <span class="comment"># åŒ…å«æŸ¥è¯¢ç»“æœçš„æ€»æ•°</span></span><br><span class="line">      <span class="string">&quot;value&quot;</span>:4,      <span class="comment"># è¡¨ç¤ºæŸ¥è¯¢ç»“æœçš„æ€»æ•°ä¸º 4</span></span><br><span class="line">      <span class="string">&quot;relation&quot;</span>:<span class="string">&quot;eq&quot;</span> <span class="comment"># è¡¨ç¤ºè¿”å›çš„æ€»æ•° value æ˜¯ç¡®åˆ‡çš„ï¼ˆequalï¼‰ã€‚å¦‚æœä¸º gteï¼Œåˆ™è¡¨ç¤ºè¿”å›çš„æ€»æ•°æ˜¯ä¸€ä¸ªä¸‹é™å€¼ã€‚</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;max_score&quot;</span>:0.0,  <span class="comment"># è¡¨ç¤ºåŒ¹é…åˆ°çš„æ–‡æ¡£ä¸­æœ€é«˜çš„å¾—åˆ†ã€‚å¦‚æœæ˜¯æ’åºæŸ¥è¯¢ï¼Œè¿™ä¸ªå€¼ä¼šæœ‰æ„ä¹‰ã€‚å½“å‰ç»“æœå› ä¸º size: 0ï¼Œæ²¡æœ‰å®é™…è¿”å›æ–‡æ¡£ï¼Œæ‰€ä»¥å¾—åˆ†ä¸º 0.0</span></span><br><span class="line">    <span class="string">&quot;hits&quot;</span>:[ ]        <span class="comment"># åŒ…å«æŸ¥è¯¢ç»“æœçš„åˆ—è¡¨ï¼Œæ¯ä¸ªç»“æœéƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«æ–‡æ¡£çš„å…ƒæ•°æ®ï¼Œå¦‚ idã€åˆ†æ•°ç­‰ã€‚</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h2 id="bool-æŸ¥è¯¢">bool æŸ¥è¯¢</h2><ul class="lvl-0"><li class="lvl-2"><p>å¸ƒå°”æŸ¥è¯¢å¯ä»¥æŒ‰ç…§å¸ƒå°”é€»è¾‘æ¡ä»¶ç»„ç»‡å¤šæ¡æŸ¥è¯¢è¯­å¥ï¼Œåªæœ‰ç¬¦åˆæ•´ä¸ªå¸ƒå°”æ¡ä»¶çš„æ–‡æ¡£æ‰ä¼šè¢«æœç´¢å‡ºæ¥ã€‚</p></li><li class="lvl-2"><p>åœ¨å¸ƒå°”æ¡ä»¶ä¸­ï¼Œå¯ä»¥åŒ…å«ä¸¤ç§ä¸åŒçš„ä¸Šä¸‹æ–‡ã€‚</p><ul class="lvl-2"><li class="lvl-4">1.æœç´¢ä¸Šä¸‹æ–‡(query context)ï¼šä½¿ç”¨æœç´¢ä¸Šä¸‹æ–‡æ—¶ï¼ŒElasticsearchéœ€è¦è®¡ç®—æ¯ä¸ªæ–‡æ¡£ä¸æœç´¢æ¡ä»¶çš„ç›¸å…³åº¦å¾—åˆ†ï¼Œè¿™ä¸ªå¾—åˆ†çš„è®¡ç®—éœ€ä½¿ç”¨ä¸€å¥—å¤æ‚çš„è®¡ç®—å…¬å¼ï¼Œæœ‰ä¸€å®šçš„æ€§èƒ½å¼€é”€ï¼Œå¸¦æ–‡æœ¬åˆ†æçš„å…¨æ–‡æ£€ç´¢çš„æŸ¥è¯¢è¯­å¥å¾ˆé€‚åˆæ”¾åœ¨æœç´¢ä¸Šä¸‹æ–‡ä¸­ã€‚</li><li class="lvl-4">2.è¿‡æ»¤ä¸Šä¸‹æ–‡(filter context)ï¼šä½¿ç”¨è¿‡æ»¤ä¸Šä¸‹æ–‡æ—¶ï¼ŒElasticsearchåªéœ€è¦åˆ¤æ–­æœç´¢æ¡ä»¶è·Ÿæ–‡æ¡£æ•°æ®æ˜¯å¦åŒ¹é…ï¼Œä¾‹å¦‚ä½¿ç”¨<code>Term query</code>åˆ¤æ–­ä¸€ä¸ªå€¼æ˜¯å¦è·Ÿæœç´¢å†…å®¹ä¸€è‡´ï¼Œä½¿ç”¨<code>Range query</code>åˆ¤æ–­æŸæ•°æ®æ˜¯å¦ä½äºæŸä¸ªåŒºé—´ç­‰ã€‚è¿‡æ»¤ä¸Šä¸‹æ–‡çš„æŸ¥è¯¢ä¸éœ€è¦è¿›è¡Œç›¸å…³åº¦å¾—åˆ†è®¡ç®—ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ç¼“å­˜åŠ å¿«å“åº”é€Ÿåº¦ï¼Œå¾ˆå¤šæœ¯è¯­çº§æŸ¥è¯¢è¯­å¥éƒ½é€‚åˆæ”¾åœ¨è¿‡æ»¤ä¸Šä¸‹æ–‡ä¸­ã€‚</li></ul></li><li class="lvl-2"><p>bool æŸ¥è¯¢åŒ…å« mustã€must_notã€shouldã€filter å››ç§å­å¥ã€‚</p></li></ul><table><thead><tr><th>ç±»å‹</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>must</td><td>å¯åŒ…å«å¤šä¸ªæŸ¥è¯¢æ¡ä»¶ï¼Œæ¯ä¸ªæ¡ä»¶å‡æ»¡è¶³çš„æ–‡æ¡£æ‰èƒ½è¢«æœç´¢åˆ°ï¼Œæ¯æ¬¡æŸ¥è¯¢éœ€è¦è®¡ç®—ç›¸å…³åº¦å¾—åˆ†ï¼Œå±äºæœç´¢ä¸Šä¸‹æ–‡</td></tr><tr><td>should</td><td>å¯åŒ…å«å¤šä¸ªæŸ¥è¯¢æ¡ä»¶ï¼Œä¸å­˜åœ¨mustå’Œfiteræ¡ä»¶æ—¶ï¼Œè‡³å°‘è¦æ»¡è¶³å¤šä¸ªæŸ¥è¯¢æ¡ä»¶ä¸­çš„ä¸€ä¸ªï¼Œæ–‡æ¡£æ‰èƒ½è¢«æœç´¢åˆ°ï¼Œå¦åˆ™éœ€æ»¡è¶³çš„æ¡ä»¶æ•°é‡ä¸å—é™åˆ¶,åŒ¹é…åˆ°çš„æŸ¥è¯¢è¶Šå¤šç›¸å…³åº¦è¶Šé«˜ï¼Œä¹Ÿå±äºæœç´¢ä¸Šä¸‹æ–‡</td></tr><tr><td>filter</td><td>å¯åŒ…å«å¤šä¸ªè¿‡æ»¤æ¡ä»¶ï¼Œæ¯ä¸ªæ¡ä»¶å‡æ»¡è¶³çš„æ–‡æ¡£æ‰èƒ½è¢«æœç´¢åˆ°ï¼Œæ¯ä¸ªè¿‡æ»¤æ¡ä»¶ä¸è®¡ç®—ç›¸å…³åº¦å¾—åˆ†ï¼Œç»“æœåœ¨ä¸€å®šæ¡ä»¶ä¸‹ä¼šè¢«ç¼“å­˜ï¼Œ å±äºè¿‡æ»¤ä¸Šä¸‹æ–‡</td></tr><tr><td>must_not</td><td>å¯åŒ…å«å¤šä¸ªè¿‡æ»¤æ¡ä»¶ï¼Œæ¯ä¸ªæ¡ä»¶å‡ä¸æ»¡è¶³çš„æ–‡æ¡£æ‰èƒ½è¢«æœç´¢åˆ°ï¼Œæ¯ä¸ªè¿‡æ»¤æ¡ä»¶ä¸è®¡ç®—ç›¸å…³åº¦å¾—åˆ†ï¼Œç»“æœåœ¨ä¸€å®šæ¡ä»¶ä¸‹ä¼šè¢«ç¼“å­˜ï¼Œ å±äºè¿‡æ»¤ä¸Šä¸‹æ–‡</td></tr></tbody></table><h3 id="must">must</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸¤ä¸ªæ¡ä»¶éƒ½éœ€è¦æ»¡è¶³</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;:&#123;</span></span><br><span class="line"><span class="string">      &quot;bool&quot;:&#123;</span></span><br><span class="line"><span class="string">        &quot;must&quot;:[</span></span><br><span class="line"><span class="string">          &#123;&quot;match&quot;:&#123;&quot;category&quot;:&quot;electronics&quot;&#125;&#125;,</span></span><br><span class="line"><span class="string">          &#123;&quot;match&quot;:&#123;&quot;desc&quot;:&quot;å…¬å›­&quot;&#125;&#125;</span></span><br><span class="line"><span class="string">        ]</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="must-not">must_not</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸¤ä¸ªæ¡ä»¶éƒ½ä¸æ»¡è¶³</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;:&#123;</span></span><br><span class="line"><span class="string">      &quot;bool&quot;:&#123;</span></span><br><span class="line"><span class="string">        &quot;must_not&quot;:[</span></span><br><span class="line"><span class="string">          &#123;&quot;match&quot;:&#123;&quot;category&quot;:&quot;electronics&quot;&#125;&#125;,</span></span><br><span class="line"><span class="string">          &#123;&quot;match&quot;:&#123;&quot;desc&quot;:&quot;å…¬å›­&quot;&#125;&#125;</span></span><br><span class="line"><span class="string">        ]</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="should">should</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸¤ä¸ªæ¡ä»¶æ»¡è¶³ä¸€ä¸ªå³å¯</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;:&#123;</span></span><br><span class="line"><span class="string">      &quot;bool&quot;:&#123;</span></span><br><span class="line"><span class="string">        &quot;should&quot;:[</span></span><br><span class="line"><span class="string">          &#123;&quot;match&quot;:&#123;&quot;category&quot;:&quot;electronics&quot;&#125;&#125;,</span></span><br><span class="line"><span class="string">          &#123;&quot;match&quot;:&#123;&quot;desc&quot;:&quot;å…¬å›­&quot;&#125;&#125;</span></span><br><span class="line"><span class="string">        ]</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="filter">filter</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># filterä¸­çš„æ¡ä»¶ä¸ºé matchï¼Œå³ä¸èƒ½æ˜¯å…¨æ–‡æ£€ç´¢</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;:&#123;</span></span><br><span class="line"><span class="string">      &quot;bool&quot;:&#123;</span></span><br><span class="line"><span class="string">        &quot;filter&quot;:[</span></span><br><span class="line"><span class="string">          &#123;&quot;term&quot;:&#123;&quot;category&quot;:&quot;electronics&quot;&#125;&#125;,</span></span><br><span class="line"><span class="string">          &#123;&quot;range&quot;:&#123;&quot;price&quot;:&#123;&quot;gte&quot;:20&#125;&#125;&#125;</span></span><br><span class="line"><span class="string">        ]</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="åˆ†é¡µä¸æ’åº">åˆ†é¡µä¸æ’åº</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># from: ä»ç¬¬å‡ æ¡å¼€å§‹ï¼Œé»˜è®¤0</span></span><br><span class="line"><span class="comment"># size: å–å¤šå°‘æ¡</span></span><br><span class="line"><span class="comment"># sort: æ’åºï¼Œé»˜è®¤ä¸ºæŒ‰æ–‡æ¡£idå‡åº</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;query&quot;:&#123;&quot;range&quot;:&#123;&quot;price&quot;:&#123;&quot;gte&quot;:20,&quot;lte&quot;:30&#125;&#125;&#125;,</span></span><br><span class="line"><span class="string">  &quot;sort&quot;:[&#123;&quot;price&quot;:&quot;address&quot;&#125;],</span></span><br><span class="line"><span class="string">  &quot;from&quot;:0,</span></span><br><span class="line"><span class="string">  &quot;size&quot;:5</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="åªè¿”å›éƒ¨åˆ†å­—æ®µ">åªè¿”å›éƒ¨åˆ†å­—æ®µ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _source: æŒ‡å®šè¦è¿”å›çš„å­—æ®µåˆ—è¡¨</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;</span></span><br><span class="line"><span class="string">  &#123;&quot;query&quot;:&#123;&quot;range&quot;:&#123;&quot;price&quot;:&#123;&quot;gte&quot;:20,&quot;lte&quot;:30&#125;&#125;&#125;,</span></span><br><span class="line"><span class="string">  &quot;_source&quot;:[&quot;category&quot;,&quot;title&quot;,&quot;price&quot;]</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="é«˜äº®æ˜¾ç¤º">é«˜äº®æ˜¾ç¤º</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é«˜äº®æ˜¾ç¤ºä»…æ”¯æŒå…¨æ–‡æ£€ç´¢å­—æ®µ</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/shopping/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">    &quot;query&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;multi_match&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;fields&quot;: [&quot;title&quot;,&quot;address&quot;],</span></span><br><span class="line"><span class="string">        &quot;query&quot;: &quot;å…¬å›­shirt&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;highlight&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;post_tags&quot;: [&quot;&lt;/span&gt;&quot;],</span></span><br><span class="line"><span class="string">      &quot;pre_tags&quot;: [&quot;&lt;span style=&#x27;</span>color:red<span class="string">&#x27;&gt;&quot;],</span></span><br><span class="line"><span class="string">      &quot;fields&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;*&quot;:&#123;&#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="åœ°ç†ç©ºé—´ä½ç½®æŸ¥è¯¢">åœ°ç†ç©ºé—´ä½ç½®æŸ¥è¯¢</h2><ul class="lvl-0"><li class="lvl-2"><p>åœ°ç†ç©ºé—´ä½ç½®æŸ¥è¯¢æ˜¯æ•°æ®åº“å’Œæœç´¢ç³»ç»Ÿä¸­çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§ï¼Œç‰¹åˆ«æ˜¯åœ¨åœ°ç†ä¿¡æ¯ç³»ç»Ÿï¼ˆGISï¼‰å’Œä½ç½®æœåŠ¡ä¸­ã€‚å®ƒå…è®¸ç”¨æˆ·åŸºäºåœ°ç†ä½ç½®ä¿¡æ¯æ¥æœç´¢å’Œè¿‡æ»¤æ•°æ®ã€‚åœ¨Elasticsearchè¿™æ ·çš„å…¨æ–‡æœç´¢å¼•æ“ä¸­ï¼Œåœ°ç†ç©ºé—´ä½ç½®æŸ¥è¯¢è¢«å¹¿æ³›åº”ç”¨ï¼Œä¾‹å¦‚åœ¨æ—…è¡Œã€æˆ¿åœ°äº§ã€ç‰©æµå’Œé›¶å”®ç­‰è¡Œä¸šï¼Œç”¨äºæä¾›åŸºäºä½ç½®çš„æœç´¢åŠŸèƒ½ã€‚</p></li><li class="lvl-2"><p>åœ¨Elasticsearchä¸­ï¼Œåœ°ç†ç©ºé—´æ•°æ®é€šå¸¸å­˜å‚¨åœ¨<code>geo_point</code>å­—æ®µç±»å‹ä¸­ã€‚è¿™ç§å­—æ®µç±»å‹å¯ä»¥å­˜å‚¨çº¬åº¦å’Œç»åº¦åæ ‡ï¼Œç”¨äºè¡¨ç¤ºåœ°çƒä¸Šçš„ä¸€ä¸ªç‚¹ã€‚</p></li></ul><h3 id="ç¤ºä¾‹">ç¤ºä¾‹</h3><ul class="lvl-0"><li class="lvl-2"><p>åˆ›å»ºä¸€ä¸ªç´¢å¼•ï¼Œå¹¶æ·»åŠ ä¸€ä¸ª<code>geo_point</code>å­—æ®µï¼š</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/tourist_spots&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">    &quot;mappings&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;properties&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;name&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;: &quot;text&quot;,</span></span><br><span class="line"><span class="string">          &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span></span><br><span class="line"><span class="string">          &quot;search_analyzer&quot;: &quot;ik_max_word&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;location&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;: &quot;geo_point&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ’å…¥æ•°æ®</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/tourist_spots/_bulk&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;index&quot;:&#123;&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&quot;name&quot;:&quot;é›·å³°å¡”&quot;,&quot;location&quot;:&#123;&quot;lat&quot;:30.2615,&quot;lon&quot;:120.1480&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&quot;index&quot;:&#123;&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&quot;name&quot;:&quot;è¥¿æ¹–&quot;,&quot;location&quot;:&#123;&quot;lat&quot;:30.2614,&quot;lon&quot;:120.1479&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&quot;index&quot;:&#123;&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;&quot;name&quot;:&quot;è‹å ¤æ˜¥æ™“&quot;,&quot;location&quot;:&#123;&quot;lat&quot;:30.2624,&quot;lon&quot;:120.1708&#125;&#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br><span class="line"><span class="comment"># lat: çº¬åº¦</span></span><br><span class="line"><span class="comment"># lon: ç»åº¦</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æŸ¥è¯¢æ•°æ®</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥è¯¢æ­å·è¥¿æ¹–5kmé™„è¿‘çš„æ™¯ç‚¹</span></span><br><span class="line"><span class="comment"># é›·å³°å¡” - ä½äºè¥¿æ¹–é™„è¿‘ï¼Œè·ç¦»çº¦2.8å…¬é‡Œã€‚</span></span><br><span class="line"><span class="comment"># è‹å ¤æ˜¥æ™“ - ä½äºè¥¿æ¹–è¾¹ï¼Œè·ç¦»è¥¿æ¹–ä¸­å¿ƒçº¦1å…¬é‡Œã€‚</span></span><br><span class="line">curl -X GET -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/tourist_spots/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">    &quot;query&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;bool&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;must&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;match_all&quot;: &#123;&#125;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;filter&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;geo_distance&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;distance&quot;: &quot;5km&quot;,</span></span><br><span class="line"><span class="string">            &quot;distance_type&quot;: &quot;arc&quot;,</span></span><br><span class="line"><span class="string">            &quot;location&quot;: &#123;</span></span><br><span class="line"><span class="string">              &quot;lat&quot;: 30.2614,</span></span><br><span class="line"><span class="string">              &quot;lon&quot;: 120.1479</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># distance: 5km è¡¨ç¤ºè·ç¦»ä¸º5å…¬é‡Œ</span></span><br><span class="line"><span class="comment"># distance_type: arc, plane, sloppy_arc,</span></span><br><span class="line">  <span class="comment"># arc: é»˜è®¤å€¼ï¼Œä½¿ç”¨haversineå…¬å¼è®¡ç®—è·ç¦»ï¼Œç»“æœæ˜¯ç²¾ç¡®çš„ï¼Œä½†è®¡ç®—é€Ÿåº¦è¾ƒæ…¢ã€‚</span></span><br><span class="line">  <span class="comment"># plane: ä½¿ç”¨å¹³é¢ç›´è§’åæ ‡ç³»è®¡ç®—è·ç¦»ï¼Œç»“æœæ˜¯ç²—ç•¥çš„ï¼Œä½†è®¡ç®—é€Ÿåº¦æ›´å¿«ã€‚</span></span><br><span class="line">  <span class="comment"># sloppy_arc: ä½¿ç”¨haversineå…¬å¼è®¡ç®—è·ç¦»ï¼Œä½†å…è®¸è¯¯å·®ã€‚</span></span><br><span class="line"><span class="comment"># location: æœç´¢æ¡ä»¶</span></span><br></pre></td></tr></table></figure><h2 id="å‘é‡æœç´¢">å‘é‡æœç´¢</h2><ul class="lvl-0"><li class="lvl-2"><p>Elasticsearch 8.x å¼•å…¥äº†ä¸€ä¸ªé‡è¦çš„æ–°ç‰¹æ€§ï¼šå‘é‡æ£€ç´¢ï¼ˆVector Searchï¼‰ï¼Œç‰¹åˆ«æ˜¯é€šè¿‡KNNï¼ˆK-Nearest Neighborsï¼‰ç®—æ³•æ”¯æŒå‘é‡è¿‘é‚»æ£€ç´¢ã€‚è¿™ä¸€ç‰¹æ€§ä½¿å¾—Elasticsearchåœ¨æœºå™¨å­¦ä¹ ã€æ•°æ®åˆ†æå’Œæ¨èç³»ç»Ÿç­‰é¢†åŸŸçš„åº”ç”¨å˜å¾—æ›´åŠ å¹¿æ³›å’Œå¼ºå¤§ã€‚</p></li><li class="lvl-2"><p>å‘é‡æ£€ç´¢çš„åŸºæœ¬æ€è·¯æ˜¯ï¼Œå°†æ–‡æ¡£ï¼ˆæˆ–æ•°æ®é¡¹ï¼‰è¡¨ç¤ºä¸ºé«˜ç»´å‘é‡ï¼Œå¹¶ä½¿ç”¨è¿™äº›å‘é‡æ¥æ‰§è¡Œç›¸ä¼¼æ€§æœç´¢ã€‚åœ¨Elasticsearchä¸­ï¼Œè¿™äº›å‘é‡è¢«å­˜å‚¨åœ¨<code>dense_vector</code>ç±»å‹çš„å­—æ®µä¸­ï¼Œç„¶åä½¿ç”¨KNNç®—æ³•æ¥æ‰¾åˆ°ä¸ç»™å®šå‘é‡æœ€ç›¸ä¼¼çš„å…¶ä»–å‘é‡ã€‚</p></li></ul><h3 id="ç¤ºä¾‹-2">ç¤ºä¾‹</h3><ul class="lvl-0"><li class="lvl-2"><p>åˆ›å»ºç´¢å¼•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/image-index&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">    &quot;mappings&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;properties&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;image-vector&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;: &quot;dense_vector&quot;,</span></span><br><span class="line"><span class="string">          &quot;dims&quot;: 3</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;title&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;: &quot;text&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;file-type&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;: &quot;keyword&quot;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &quot;my_label&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;: &quot;text&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br><span class="line"><span class="comment"># dims: 3  è¡¨ç¤º3ç»´å‘é‡ï¼Œæœ€é«˜æ”¯æŒ2048</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ·»åŠ æ•°æ®</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/image-index/_bulk&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;image-vector&quot;: [-5, 9, -12], &quot;title&quot;: &quot;Image A&quot;, &quot;file-type&quot;: &quot;jpeg&quot;, &quot;my_label&quot;: &quot;red&quot; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;image-vector&quot;: [10, -2, 3], &quot;title&quot;: &quot;Image B&quot;, &quot;file-type&quot;: &quot;png&quot;, &quot;my_label&quot;: &quot;blue&quot; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;index&quot;: &#123;&#125; &#125;</span></span><br><span class="line"><span class="string">&#123; &quot;image-vector&quot;: [4, 0, -1], &quot;title&quot;: &quot;Image C&quot;, &quot;file-type&quot;: &quot;gif&quot;, &quot;my_label&quot;: &quot;red&quot; &#125;</span></span><br><span class="line"><span class="string">&#x27;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å‘é‡æ£€ç´¢</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST -u elastic:123456 -k <span class="string">&#x27;https://127.0.0.1:9200/image-index/_search?pretty&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">    &quot;query&quot;:&#123; &quot;match_all&quot;: &#123;&#125; &#125;,</span></span><br><span class="line"><span class="string">    &quot;knn&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;field&quot;: &quot;image-vector&quot;,</span></span><br><span class="line"><span class="string">      &quot;query_vector&quot;: [-5, 10, -12],</span></span><br><span class="line"><span class="string">      &quot;k&quot;: 10,</span></span><br><span class="line"><span class="string">      &quot;num_candidates&quot;: 100</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;fields&quot;: [ &quot;title&quot;, &quot;file-type&quot; ]</span></span><br><span class="line"><span class="string">  &#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># query: æœç´¢æ¡ä»¶ï¼Œè¿™é‡Œå¯ä»¥ä¸åŠ è¿™ä¸ª</span></span><br><span class="line"><span class="comment"># knn: 8.8.1 ç‰ˆæœ¬å¼€å§‹é»˜è®¤æ”¯æŒ</span></span><br><span class="line"><span class="comment"># field: æœç´¢å‘é‡å­—æ®µ</span></span><br><span class="line"><span class="comment"># query_vector: æœç´¢å‘é‡</span></span><br><span class="line"><span class="comment"># k: æœç´¢ç»“æœæ•°é‡</span></span><br><span class="line"><span class="comment"># num_candidates: æœç´¢å€™é€‰æ•°é‡ï¼Œç”¨äºä¼˜åŒ–æ€§èƒ½</span></span><br><span class="line"><span class="comment"># fields: æœç´¢ç»“æœè¿”å›å­—æ®µ</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **åŠ ç²—**
 *æ–œä½“*
 ***åŠ ç²—å¹¶æ–œä½“***
 ~~åˆ é™¤çº¿~~
 ==çªå‡ºæ˜¾ç¤º==
 `çªå‡ºæ˜¾ç¤º(æ¨è)`
 ++ä¸‹åˆ’çº¿++
 ~ä¸‹æ ‡~
 ^ä¸Šæ ‡^
 è„šæ³¨ï¼Œå‚è€ƒæ–‡çŒ®[^1]ï¼Œç„¶ååœ¨æ–‡æ¡£æœ€ä¸‹æ–¹è¦æ·»åŠ è¿™ä¸ª1å¯¹åº”çš„å†…å®¹ï¼Œå¦‚ï¼š[^1]: My reference.
 å›¾ç‰‡è®¾ç½®å®½åº¦å’Œé«˜åº¦(é€šè¿‡uPicä¸Šä¼ åï¼Œéœ€è¦å°†upicä¿®æ”¹è¿‡ä¸ºblogï¼Œç”¨äºæ·»åŠ æ°´å°) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **ç‚¹å‡»æŠ˜å **
 è¿™æ˜¯è¢«éšè—çš„å†…å®¹
 +++

::: tips success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
:::

% note info % success warning danger
è¿™é‡Œæ˜¯å®¹å™¨å†…çš„å†…å®¹
% endnote %

å¼•ç”¨æœ¬åœ°å…¶å®ƒæ–‡ç« è¿æ¥{}
 å¤§æ‹¬å·å¼€å§‹% post_link æ–‡ä»¶åç§°(ä¸åŒ…å«.md) %å¤§æ‹¬å·ç»“æŸ
 --&gt;
&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;æœ¬æ–‡ä»‹ç» Elasticsearch çš„ REST APIs&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;Elasticsearchç‰ˆæœ¬8.17.3&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/8.17/rest-apis.html&quot;&gt;å®˜æ–¹æ–‡æ¡£:REST APIs&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;a href=&quot;/2025/04/22/elasticsearch-06-api-aggs/&quot; title=&quot;Elasticsearch çš„ REST APIs:èšåˆæŸ¥è¯¢&quot;&gt;Elasticsearch çš„ REST APIs:èšåˆæŸ¥è¯¢&lt;/a&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="elastic" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/elastic/"/>
    
    <category term="elasticsearch" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/elastic/elasticsearch/"/>
    
    
    <category term="elasticsearch" scheme="https://blog.hanqunfeng.com/tags/elasticsearch/"/>
    
  </entry>
  
</feed>
