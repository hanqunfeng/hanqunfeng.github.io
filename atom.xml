<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>飘逸峰的博客</title>
  
  <subtitle>Spring--Java程序员的春天</subtitle>
  <link href="https://blog.hanqunfeng.com/atom.xml" rel="self"/>
  
  <link href="https://blog.hanqunfeng.com/"/>
  <updated>2025-07-22T08:46:03.462Z</updated>
  <id>https://blog.hanqunfeng.com/</id>
  
  <author>
    <name>飘逸峰</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>K8S 之 StorageClass</title>
    <link href="https://blog.hanqunfeng.com/2025/07/22/k8s-storageclass/"/>
    <id>https://blog.hanqunfeng.com/2025/07/22/k8s-storageclass/</id>
    <published>2025-07-22T12:35:15.000Z</published>
    <updated>2025-07-22T08:46:03.462Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote %引用本地其它文章连接{} 大括号开始% post_link 文件名称(不包含.md) %大括号结束 --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍 K8S 的 StorageClass，本文以 CentOS 8 为例。</p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/">K8S官网</a></p></li><li class="lvl-2"><p><a href="https://github.com/kubernetes/kubernetes">k8s Github</a></p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/docs/concepts/storage/storage-classes/">k8s StorageClass 官方文档</a></p></li><li class="lvl-2"><p>本文底层存储卷是 NFS</p></li></ul><span id="more"></span><h2 id="StorageClass-别名sc-介绍">StorageClass(别名sc) 介绍</h2><ul class="lvl-0"><li class="lvl-2"><p>K8s 的存储资源分为两种供应模式：静态供应模式 和 动态供应模式。</p><ul class="lvl-2"><li class="lvl-4">静态模式下，管理员需要预先创建许多PV，等待 PVC  来绑定。</li><li class="lvl-4">动态模式下，Kubernetes 会通过 StorageClass 自动创建 PV，并完成与 PVC 的绑定。</li></ul></li><li class="lvl-2"><p>StorageClass 是 Kubernetes 中用来定义 <code>存储后端类型和配置参数</code> 的资源</p></li><li class="lvl-2"><p>作用： 自动创建 PV（PersistentVolume）的“模板”或“规则”</p></li><li class="lvl-2"><p>使用场景： 配合 PVC 使用时，Kubernetes 可以根据 StorageClass 自动 动态创建 对应的持久卷。</p></li><li class="lvl-2"><p>✅ 核心优势：</p><ul class="lvl-2"><li class="lvl-4">无需手动创建 PV</li><li class="lvl-4">支持多种存储后端（NFS、云盘、Ceph、GlusterFS、iSCSI…）</li></ul></li></ul><p><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/OGGWYb.png" alt=""></p><h2 id="创建-StorageClass">创建 StorageClass</h2><ul class="lvl-0"><li class="lvl-2"><p>一个 NFS 的 StorageClass 的 yaml 示例</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nfs-storage.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-csi</span>                                           <span class="comment"># 存储类名称</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">nfs.csi.k8s.io</span>                               <span class="comment"># 指定存储插件的 CSI 驱动名称，需要安装 nfs-csi-driver</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Delete</span>                                     <span class="comment"># Retain：PVC 删除后，PV 不会被自动删除（数据保留），默认是 Delete,生产环境慎用。</span></span><br><span class="line"><span class="attr">allowVolumeExpansion:</span> <span class="literal">true</span>                                <span class="comment"># 是否允许 PVC 自动扩容，nfs 支持扩容</span></span><br><span class="line"><span class="attr">mountOptions:</span>                                             <span class="comment"># 挂载选项，csi插件不同，选项不同。这里是 nfs的</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">hard</span>                                                  <span class="comment"># 服务器异常时客户端会一直发请求直到挂载成功</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nfsvers=4.1</span>                                           <span class="comment"># nfs版本    nfs4.1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nolock</span>                                                <span class="comment"># 允许多个客户端同时访问</span></span><br><span class="line"><span class="attr">volumeBindingMode:</span> <span class="string">Immediate</span>                              <span class="comment"># 默认值：Immediate: 创建PVC时立即绑定 ,WaitForFirstConsumer：等到 Pod 调度到节点后再分配卷，适合多可用区场景</span></span><br><span class="line"><span class="attr">parameters:</span>                                               <span class="comment"># 参数配置</span></span><br><span class="line">  <span class="attr">server:</span> <span class="number">10.211</span><span class="number">.55</span><span class="number">.88</span>                                    <span class="comment"># nfs服务器地址</span></span><br><span class="line">  <span class="attr">share:</span> <span class="string">/nfs-server/data</span>                                 <span class="comment"># nfs-server上的存储目录</span></span><br></pre></td></tr></table></figure><blockquote><p>csi-driver-nfs 从 v4.x 起，已经支持 Delete reclaimPolicy 和 allowVolumeExpansion 自动扩容。<br>生产环境慎用 Delete reclaimPolicy，因为此时删除 PVC 后，nfs-server 上的存储目录也会被删除。</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>每个 StorageClass 配置中有三个必填的参数：<code>provisioner</code>、<code>parameters</code> 和 <code>reclaimPolicy</code> 字段， 这些字段会在 StorageClass 需要动态制备 PersistentVolume (PV) 以满足 PersistentVolumeClaim (PVC) 时使用到。</p></li></ul><h3 id="provisioner-存储制备器">provisioner: 存储制备器</h3><ul class="lvl-0"><li class="lvl-2"><p>每个 StorageClass 都有一个制备器（Provisioner），用来决定使用哪个卷插件制备 PV。 该字段必须指定。</p></li><li class="lvl-2"><p>比如 NFS 存储制备器：<code>provisioner: nfs.csi.k8s.io</code>，是 K8S 官方维护的 NFS CSI 插件。<a href="https://github.com/kubernetes-csi/csi-driver-nfs">Github</a>。</p></li><li class="lvl-2"><p>安装 NFS CSI 插件：<a href="https://github.com/kubernetes-csi/csi-driver-nfs/blob/master/docs/install-csi-driver-master.md">Install NFS CSI Driver</a></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在线安装</span></span><br><span class="line">curl -skSL https://raw.githubusercontent.com/kubernetes-csi/csi-driver-nfs/master/deploy/install-driver.sh | bash -s master --</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">kubectl -n kube-system get pod -o wide -l app=csi-nfs-controller</span><br><span class="line">kubectl -n kube-system get pod -o wide -l app=csi-nfs-node</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>卸载</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -skSL https://raw.githubusercontent.com/kubernetes-csi/csi-driver-nfs/master/deploy/uninstall-driver.sh | bash -s master --</span><br></pre></td></tr></table></figure><h2 id="示例">示例</h2><ul class="lvl-0"><li class="lvl-2"><p>创建 StorageClass</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f nfs-storage.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看 storageclass</span></span><br><span class="line">$ k get sc</span><br><span class="line">NAME      PROVISIONER      RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</span><br><span class="line">nfs-csi   nfs.csi.k8s.io   Delete          Immediate           <span class="literal">true</span>                   5s</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>创建 PVC 时指定 storageclass，StorageClass 会自动创建 PV</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nfs-pvc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-pvc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs-csi</span>  <span class="comment"># 指定 StorageClass 的名称，如果设置了默认的sc，此处可以删除该配置</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span>          <span class="comment"># 指定访问模式</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">800Mi</span>         <span class="comment"># 申请的容量</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>创建 PVC</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 PVC</span></span><br><span class="line">$ k apply -f nfs-pvc.yaml</span><br><span class="line">persistentvolumeclaim/nfs-pvc created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 PV和PVC，可以看到 PV 自动创建了</span></span><br><span class="line">$ k get pv,pvc</span><br><span class="line">NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM             STORAGECLASS   VOLUMEATTRIBUTESCLASS   REASON   AGE</span><br><span class="line">persistentvolume/pvc-c1d33fec-5e16-4156-8405-1af4fc171907   800Mi      RWX            Delete           Bound    default/nfs-pvc   nfs-csi        &lt;<span class="built_in">unset</span>&gt;                          2m4s</span><br><span class="line"></span><br><span class="line">NAME                            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE</span><br><span class="line">persistentvolumeclaim/nfs-pvc   Bound    pvc-c1d33fec-5e16-4156-8405-1af4fc171907   800Mi      RWX            nfs-csi        &lt;<span class="built_in">unset</span>&gt;                 2m4s</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>自动扩容，修改 PVC 容量到 1Gi</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit pvc nfs-pvc</span><br><span class="line"><span class="comment"># 修改如下</span></span><br><span class="line"><span class="comment"># &quot;storage&quot;:&quot;1Gi&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次查看 PV 和 PVC，可以看到 自动扩容成功</span></span><br><span class="line">$ k get pv,pvc</span><br><span class="line">NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM             STORAGECLASS   VOLUMEATTRIBUTESCLASS   REASON   AGE</span><br><span class="line">persistentvolume/pvc-c1d33fec-5e16-4156-8405-1af4fc171907   1Gi        RWX            Delete           Bound    default/nfs-pvc   nfs-csi        &lt;<span class="built_in">unset</span>&gt;                          4m50s</span><br><span class="line"></span><br><span class="line">NAME                            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE</span><br><span class="line">persistentvolumeclaim/nfs-pvc   Bound    pvc-c1d33fec-5e16-4156-8405-1af4fc171907   1Gi        RWX            nfs-csi        &lt;<span class="built_in">unset</span>&gt;                 4m50s</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>删除PVC，自动删除PV</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pvc nfs-pvc</span><br><span class="line"><span class="comment"># 再次查看 PV 和 PVC，可以看到 PV 已经被自动删除， reclaimPolicy: Delete</span></span><br><span class="line">$ k get pv,pvc</span><br><span class="line">No resources found</span><br><span class="line"><span class="comment"># 此时 nfs-server 的目录下的文件也会被删除，生产环境慎用</span></span><br></pre></td></tr></table></figure><h2 id="设置默认的-StorageClass">设置默认的 StorageClass</h2><ul class="lvl-0"><li class="lvl-2"><p>上面我们创建 PVC 的时候需要指定 StorageClass，如果我们设置一个默认的 StorageClass，那么在PVC里就可以省略掉 StorageClass 的设置。</p></li><li class="lvl-2"><p>K8S 中只能设置一个默认的 StorageClass，如果有多个，那么就会报错。</p></li><li class="lvl-2"><p>设置默认的 StorageClass</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为 sc 添加 `默认` 注解，去掉该注解 或者 设置为 false 就取消默认了。</span></span><br><span class="line">$ kubectl patch storageclass nfs-csi -p <span class="string">&#x27;&#123;&quot;metadata&quot;: &#123;&quot;annotations&quot;:&#123;&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;true&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class="line">storageclass.storage.k8s.io/nfs-csi patched</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看sc，此时看到名称后面多了一个 (default) ，表示这是默认的 StorageClass</span></span><br><span class="line">$ k get sc</span><br><span class="line">NAME                PROVISIONER      RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</span><br><span class="line">nfs-csi (default)   nfs.csi.k8s.io   Delete          Immediate           <span class="literal">true</span>                   14m</span><br></pre></td></tr></table></figure><h2 id="StatefulSet-自动创建-PVC">StatefulSet: 自动创建 PVC</h2><ul class="lvl-0"><li class="lvl-2"><p>上面的方式还是要求我们必须创建 PVC，有什么方法可以不用创建 PVC ，而是在创建控制器的时候就一起把 PVC 创建好呢？</p></li><li class="lvl-2"><p>目前只有 <code>StatefulSet</code>控制器 才支持自动创建 PVC</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># redis-statefulset.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>                  <span class="comment"># 指定使用的 API 版本，这里是 apps/v1，适用于 StatefulSet 资源</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span>                    <span class="comment"># Kubernetes 资源类型，这里是部署（StatefulSet）</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-sts</span>                    <span class="comment"># 资源名称，必须唯一（在同一命名空间下）</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">sts-ns</span></span><br><span class="line"><span class="attr">spec:</span>                                <span class="comment"># 配置项</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span>           <span class="comment"># 保留的历史版本数，默认值为 10，Deployment 和 StatefulSet 都有这个配置项。回滚时有用。</span></span><br><span class="line">  <span class="attr">selector:</span>                          <span class="comment"># 选择器，指定要管理的 Pod</span></span><br><span class="line">    <span class="attr">matchLabels:</span>                     <span class="comment"># 标签选择器</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">redis</span>                     <span class="comment"># 选择器，指定 StatefulSet 管理哪些 Pod（标签必须与 template 中匹配）</span></span><br><span class="line">  <span class="attr">updateStrategy:</span>                    <span class="comment"># 更新策略，这里要注意这个更新策略与Deployment的属性名字不一样</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span>              <span class="comment"># 1.RollingUpdate：这是默认的更新策略。使用 RollingUpdate 更新策略时，在更新 StatefulSet 模板后， 老的 StatefulSet Pod 将被终止，并且将以受控方式自动创建新的 StatefulSet Pod。 更新期间，最多只能有 StatefulSet 的一个 Pod 运行于每个节点上。</span></span><br><span class="line">                                     <span class="comment"># 2.OnDelete：使用 OnDelete 更新策略时，在更新 StatefulSet 模板后，只有当你手动删除老的 StatefulSet Pod 之后，新的 StatefulSet Pod 才会被自动创建。</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span>                   <span class="comment"># 滚动升级的配置</span></span><br><span class="line">      <span class="attr">partition:</span> <span class="number">0</span>                   <span class="comment"># 用于控制从第几个 Pod 开始滚动升级</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">redis-svc</span>             <span class="comment"># 服务名称,sts对象使用无头服务，这个是必填项，需要事先创建好</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span>                        <span class="comment"># 副本数，默认是 1</span></span><br><span class="line">  <span class="attr">template:</span>                          <span class="comment"># 模板，定义 Pod 的内容，具体可以参考 Pod 的配置</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">redis</span>                   <span class="comment"># Pod 的标签，必须与 selector 中的 matchLabels 一致</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">redis:6.2</span>             <span class="comment"># 容器使用的镜像，这里是官方的 redis 镜像</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">redis</span>                  <span class="comment"># 容器的名称</span></span><br><span class="line">        <span class="attr">volumeMounts:</span>                <span class="comment"># 挂载数据卷</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis-data</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/data</span>           <span class="comment"># Redis 持久化数据存储路径，根据实际情况修改</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span>              <span class="comment"># 配置 PVC 模板</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">redis-data</span>               <span class="comment"># PVC 名称</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ReadWriteMany</span>              <span class="comment"># 访问模式：多节点读写</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">500Mi</span>             <span class="comment"># 请求的存储容量，根据实际需求调整</span></span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">nfs-csi</span>      <span class="comment"># 存储类名称，如果使用默认存储类，则不需要指定</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>创建 StatefulSet，并查看 PV,PVC</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 StatefulSet</span></span><br><span class="line">$ kubectl apply -f redis-statefulset.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 PV,PVC</span></span><br><span class="line">$ k get pv,pvc -n sts-ns</span><br><span class="line">NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                           STORAGECLASS   VOLUMEATTRIBUTESCLASS   REASON   AGE</span><br><span class="line">persistentvolume/pvc-748fc0d3-a142-4d08-b5c4-7320daea5618   500Mi      RWX            Delete           Bound    sts-ns/redis-data-redis-sts-1   nfs-csi        &lt;<span class="built_in">unset</span>&gt;                          19s</span><br><span class="line">persistentvolume/pvc-807018bb-ec66-4a5c-87f1-9c11df6f4784   500Mi      RWX            Delete           Bound    sts-ns/redis-data-redis-sts-0   nfs-csi        &lt;<span class="built_in">unset</span>&gt;                          22s</span><br><span class="line"></span><br><span class="line">NAME                                           STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE</span><br><span class="line">persistentvolumeclaim/redis-data-redis-sts-0   Bound    pvc-807018bb-ec66-4a5c-87f1-9c11df6f4784   500Mi      RWX            nfs-csi        &lt;<span class="built_in">unset</span>&gt;                 22s</span><br><span class="line">persistentvolumeclaim/redis-data-redis-sts-1   Bound    pvc-748fc0d3-a142-4d08-b5c4-7320daea5618   500Mi      RWX            nfs-csi        &lt;<span class="built_in">unset</span>&gt;                 20s</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>StatefulSet 的 volumeClaimTemplates 每个 Pod 单独创建 PVC，Pod 和 PVC 一一对应，即有几个副本就创建几个 PVC。PVC 名称是：<code>&lt;volumeClaimTemplates.metadata.name&gt;-&lt;statefulset-name&gt;-&lt;pod-ordinal&gt;</code></p></li><li class="lvl-2"><p>删除 StatefulSet</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f redis-statefulset.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 PV,PVC，发现删除 StatefulSet 后，PV 和 PVC 是不会被自动删除的，需要手动删除 PVC</span></span><br><span class="line">$ k get pv,pvc -n sts-ns</span><br><span class="line">NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                           STORAGECLASS   VOLUMEATTRIBUTESCLASS   REASON   AGE</span><br><span class="line">persistentvolume/pvc-748fc0d3-a142-4d08-b5c4-7320daea5618   500Mi      RWX            Delete           Bound    sts-ns/redis-data-redis-sts-1   nfs-csi        &lt;<span class="built_in">unset</span>&gt;                          6m30s</span><br><span class="line">persistentvolume/pvc-807018bb-ec66-4a5c-87f1-9c11df6f4784   500Mi      RWX            Delete           Bound    sts-ns/redis-data-redis-sts-0   nfs-csi        &lt;<span class="built_in">unset</span>&gt;                          6m33s</span><br><span class="line"></span><br><span class="line">NAME                                           STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE</span><br><span class="line">persistentvolumeclaim/redis-data-redis-sts-0   Bound    pvc-807018bb-ec66-4a5c-87f1-9c11df6f4784   500Mi      RWX            nfs-csi        &lt;<span class="built_in">unset</span>&gt;                 6m33s</span><br><span class="line">persistentvolumeclaim/redis-data-redis-sts-1   Bound    pvc-748fc0d3-a142-4d08-b5c4-7320daea5618   500Mi      RWX            nfs-csi        &lt;<span class="built_in">unset</span>&gt;                 6m31s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 手动删除 PVC，因为sc配置的回收策略为 Delete，所以 PV 也会被删除</span></span><br><span class="line">k delete pvc -n sts-ns redis-data-redis-sts-0</span><br><span class="line">k delete pvc -n sts-ns redis-data-redis-sts-1</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>实际上，无论是删除 statefulset 还是缩容 statefulset，PVC 都不会被自动删除。</p></li></ul>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

引用本地其它文章连接{}
 大括号开始% post_link 文件名称(不包含.md) %大括号结束
 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍 K8S 的 StorageClass，本文以 CentOS 8 为例。&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/&quot;&gt;K8S官网&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/kubernetes/kubernetes&quot;&gt;k8s Github&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/concepts/storage/storage-classes/&quot;&gt;k8s StorageClass 官方文档&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文底层存储卷是 NFS&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="k8s" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/k8s/"/>
    
    
    <category term="K8S" scheme="https://blog.hanqunfeng.com/tags/K8S/"/>
    
  </entry>
  
  <entry>
    <title>K8S 之 持久卷 PV 和 PVC</title>
    <link href="https://blog.hanqunfeng.com/2025/07/21/k8s-storage-pv-pvc/"/>
    <id>https://blog.hanqunfeng.com/2025/07/21/k8s-storage-pv-pvc/</id>
    <published>2025-07-21T15:35:15.000Z</published>
    <updated>2025-07-22T08:52:10.994Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote %引用本地其它文章连接{} 大括号开始% post_link 文件名称(不包含.md) %大括号结束 --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍 K8S 的 持久卷 PV 和 PVC ，本文以 CentOS 8 为例。</p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/">K8S官网</a></p></li><li class="lvl-2"><p><a href="https://github.com/kubernetes/kubernetes">k8s Github</a></p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/docs/concepts/storage/persistent-volumes/">k8s PV/PVC 官方文档</a></p></li><li class="lvl-2"><p>本文底层存储卷是 NFS</p></li></ul><span id="more"></span><h2 id="PV-和-PVC-介绍">PV 和 PVC 介绍</h2><ul class="lvl-0"><li class="lvl-2"><p>PV(PersistentVolume) 是 Kubernetes 中的一种存储资源，用于将底层的物理存储（如 NFS、iSCSI、Ceph、云存储等）抽象成 Kubernetes 资源，供 Pod 使用。它是对存储的一种“声明式”管理，类似于 Pod 声明计算资源。PV 是集群级别的存储资源，不支持 Namespace。</p></li><li class="lvl-2"><p>PVC(PersistentVolumeClaim)，持久卷声明， 是 Kubernetes 中用于申请存储资源的对象。PVC 是 Namespace 级别的资源。</p></li><li class="lvl-2"><p>简而言之：</p><ul class="lvl-2"><li class="lvl-4">PV 是集群中的一块存储，由管理员提前配置或动态创建。</li><li class="lvl-4">PVC（PersistentVolumeClaim） 是用户对存储的申请。</li><li class="lvl-4">Pod 通过 PVC 绑定到 PV，使用持久化存储。</li><li class="lvl-4">开发者用 PVC 来申请存储空间，不关心存储的具体实现方式。</li><li class="lvl-4">PVC 通过 Kubernetes 自动匹配一个合适的 PersistentVolume（PV）进行绑定。</li></ul></li><li class="lvl-2"><p>PV 与 PVC 的基本流程</p><ul class="lvl-2"><li class="lvl-4">管理员创建 PV（或者集群通过 StorageClass 自动创建）。</li><li class="lvl-4">用户提交 PVC，声明自己需要多少容量、什么访问模式。</li><li class="lvl-4">Kubernetes 查找可用的 PV，条件符合（容量、访问模式、StorageClass）就自动绑定。</li><li class="lvl-4">Pod 挂载 PVC，实现持久化存储。</li></ul></li></ul><h2 id="PV-示例">PV 示例</h2><ul class="lvl-0"><li class="lvl-2"><p>一个使用 NFS 存储卷的 PV 示例</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pv-nfs.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv-nfs-1g</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span>                 <span class="comment"># 存储卷模式，默认为 Filesystem</span></span><br><span class="line">  <span class="attr">capacity:</span>                              <span class="comment"># 存储能力</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span>                         <span class="comment"># 容量大小，Gi 或 Mi</span></span><br><span class="line">  <span class="attr">accessModes:</span>                           <span class="comment"># 访问模式</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span>                      <span class="comment"># 访问模式</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span>  <span class="comment"># 回收策略</span></span><br><span class="line">  <span class="attr">nfs:</span>                                   <span class="comment"># 持久卷类型（如 hostPath、nfs、ceph 等）</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfs-server/data/pv-nfs-1g</span>     <span class="comment"># 存储路径要确保已经存在</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">10.211</span><span class="number">.55</span><span class="number">.88</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv-nfs-2g</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span>                              <span class="comment"># 存储能力</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">2Gi</span>                         <span class="comment"># 容量大小，Gi 或 Mi</span></span><br><span class="line">  <span class="attr">accessModes:</span>                           <span class="comment"># 访问模式</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span>                      <span class="comment"># 访问模式</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span>  <span class="comment"># 回收策略</span></span><br><span class="line">  <span class="attr">nfs:</span>                                   <span class="comment"># 存储类型（如 hostPath、nfs、ceph 等）</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfs-server/data/pv-nfs-2g</span>     <span class="comment"># 存储路径要确保已经存在</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">10.211</span><span class="number">.55</span><span class="number">.88</span></span><br></pre></td></tr></table></figure><h3 id="存储卷模式">存储卷模式</h3><ul class="lvl-0"><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/docs/concepts/storage/persistent-volumes/#volume-mode">官网文档:存储卷模式</a></p></li><li class="lvl-2"><p>Kubernetes 支持两种卷模式（volumeModes）：Filesystem（文件系统） 和 Block（块）。</p></li><li class="lvl-2"><p>如果该参数被省略，默认的卷模式是 Filesystem。</p></li><li class="lvl-2"><p>volumeMode 属性设置为 Filesystem 的卷会被 Pod 挂载（Mount） 到某个目录。</p></li></ul><h3 id="持久卷类型">持久卷类型</h3><ul class="lvl-0"><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes">官网文档:持久卷类型</a></p></li><li class="lvl-2"><p>✅ 当前支持的插件</p></li></ul><table><thead><tr><th>插件类型</th><th>描述</th></tr></thead><tbody><tr><td><strong>csi</strong></td><td><strong>容器存储接口（CSI）</strong>，推荐的现代存储接口</td></tr><tr><td><strong>fc</strong></td><td>Fibre Channel 存储</td></tr><tr><td><strong>hostPath</strong></td><td>HostPath 卷（仅供单节点测试使用；多节点不推荐，推荐使用 local 卷替代）</td></tr><tr><td><strong>iscsi</strong></td><td>iSCSI（基于 IP 的 SCSI 存储）</td></tr><tr><td><strong>local</strong></td><td>节点本地存储设备</td></tr><tr><td><strong>nfs</strong></td><td>网络文件系统（NFS）存储</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>⚠️ 已弃用但仍可用（需 CSI 迁移）</p></li></ul><table><thead><tr><th>插件类型</th><th>描述</th><th>CSI 迁移状态</th></tr></thead><tbody><tr><td><strong>awsElasticBlockStore</strong></td><td>AWS EBS 块存储</td><td>从 v1.23 开始默认迁移</td></tr><tr><td><strong>azureDisk</strong></td><td>Azure 磁盘存储</td><td>从 v1.23 开始默认迁移</td></tr><tr><td><strong>azureFile</strong></td><td>Azure 文件存储</td><td>从 v1.24 开始默认迁移</td></tr><tr><td><strong>cinder</strong></td><td>OpenStack 块存储</td><td>从 v1.21 开始默认迁移</td></tr><tr><td><strong>flexVolume</strong></td><td>FlexVolume（无迁移计划，但未计划移除）</td><td>从 v1.23 开始弃用</td></tr><tr><td><strong>gcePersistentDisk</strong></td><td>GCP 持久磁盘</td><td>从 v1.23 开始默认迁移</td></tr><tr><td><strong>portworxVolume</strong></td><td>Portworx 存储卷</td><td>从 v1.31 开始默认迁移</td></tr><tr><td><strong>vsphereVolume</strong></td><td>vSphere VMDK 卷</td><td>从 v1.25 开始默认迁移</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>❌ 已废弃/即将移除的 In-Tree 插件</p></li></ul><table><thead><tr><th>插件类型</th><th>描述</th><th>弃用/移除版本</th></tr></thead><tbody><tr><td><strong>cephfs</strong></td><td>Ceph 文件系统卷</td><td>v1.31 之后不可用</td></tr><tr><td><strong>flocker</strong></td><td>Flocker 存储</td><td>v1.25 之后不可用</td></tr><tr><td><strong>glusterfs</strong></td><td>GlusterFS 存储</td><td>v1.26 之后不可用</td></tr><tr><td><strong>photonPersistentDisk</strong></td><td>Photon 持久磁盘</td><td>v1.15 之后不可用</td></tr><tr><td><strong>quobyte</strong></td><td>Quobyte 卷</td><td>v1.25 之后不可用</td></tr><tr><td><strong>rbd</strong></td><td>Rados 块设备（Ceph RBD）</td><td>v1.31 之后不可用</td></tr><tr><td><strong>scaleIO</strong></td><td>ScaleIO 卷</td><td>v1.21 之后不可用</td></tr><tr><td><strong>storageos</strong></td><td>StorageOS 卷</td><td>v1.25 之后不可用</td></tr></tbody></table><h3 id="accessModes-访问模式">accessModes 访问模式</h3><ul class="lvl-0"><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/docs/concepts/storage/persistent-volumes/#access-modes">官网文档:访问模式</a></p></li></ul><table><thead><tr><th>访问模式</th><th>说明</th><th>是否跨节点挂载</th><th>是否支持多 Pod 挂载</th><th>是否支持读写</th></tr></thead><tbody><tr><td><strong>ReadWriteOnce (RWO)</strong></td><td>卷可以被一个节点以读写方式挂载，同一节点内多个 Pod 可共享使用。</td><td>❌ 否</td><td>✅ 是（同一节点）</td><td>✅ 是</td></tr><tr><td><strong>ReadOnlyMany (ROX)</strong></td><td>卷可以被多个节点以只读方式挂载。</td><td>✅ 是</td><td>✅ 是</td><td>❌ 否（只读）</td></tr><tr><td><strong>ReadWriteMany (RWX)</strong></td><td>卷可以被多个节点以读写方式挂载。</td><td>✅ 是</td><td>✅ 是</td><td>✅ 是</td></tr><tr><td><strong>ReadWriteOncePod (RWOP)</strong></td><td>卷只能被单个 Pod 以读写方式挂载，确保集群中只有一个 Pod 使用该卷（v1.29+稳定）。</td><td>❌ 否</td><td>❌ 否（只能一个 Pod）</td><td>✅ 是</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>NFS 支持前三种访问模式，hostPath 只支持 ReadWriteOnce。</p></li></ul><h3 id="persistentVolumeReclaimPolicy-回收策略">persistentVolumeReclaimPolicy 回收策略</h3><ul class="lvl-0"><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/docs/concepts/storage/persistent-volumes/#reclaim-policy">官方文档:回收策略</a></p></li></ul><table><thead><tr><th>回收策略</th><th>含义</th><th>回收行为</th><th>典型使用场景</th></tr></thead><tbody><tr><td><strong>Retain</strong></td><td><strong>保留</strong>：删除 PVC 后，PV 和后端存储仍然保留</td><td>手动回收，PVC 删除后 PV 状态为 <code>Released</code>，需要手动清理或重新绑定</td><td>重要数据，避免误删；如数据库数据盘</td></tr><tr><td><strong>Delete</strong></td><td><strong>删除</strong>：删除 PVC 后，PV 和后端存储都会被删除</td><td>自动回收，PVC 删除时自动删除 PV 和后端存储资源（如云盘）</td><td>临时数据、不重要的存储</td></tr><tr><td><strong>Recycle</strong></td><td><strong>回收</strong>：简单清空数据</td><td>自动执行 <code>rm -rf /thevolume/*</code>，然后 PV 变回 <code>Available</code> 状态</td><td>旧版本集群的小文件临时存储</td></tr></tbody></table><div class="warning"><ul class="lvl-1"><li class="lvl-2"><p><strong>注意</strong>: 创建 <strong>Recycle</strong> 的 PV 时，会提示如下内容</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Warning: spec.persistentVolumeReclaimPolicy: The Recycle reclaim policy is deprecated. Instead, the recommended approach is to use dynamic provisioning.</span><br></pre></td></tr></table></figure><ul class="lvl-1"><li class="lvl-2"><p>意思就是 <strong>Recycle</strong> 策略已被弃用，建议使用<code>动态供应模式</code>。但<a href="https://kubernetes.io/zh-cn/docs/concepts/storage/persistent-volumes/#reclaim-policy">官方文档</a>中却提示 <code>对于 Kubernetes 1.33 来说，只有 nfs 和 hostPath 卷类型支持回收（Recycle）。</code></p></li><li class="lvl-2"><p>本人在 Kubernetes 1.33.2 中测试，NFS 支持 Recycle，删除 PVC 后 PV 状态会变为 <strong>Available</strong></p></li></ul></div><h3 id="管理-PV">管理 PV</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建</span></span><br><span class="line">kubectl create -f pv-nfs.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">$ k get pv</span><br><span class="line">NAME        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   VOLUMEATTRIBUTESCLASS   REASON   AGE</span><br><span class="line">pv-nfs-1g   1Gi        RWO            Retain           Available                          &lt;<span class="built_in">unset</span>&gt;                          80s</span><br><span class="line">pv-nfs-2g   2Gi        RWX            Retain           Available                          &lt;<span class="built_in">unset</span>&gt;                          80s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除</span></span><br><span class="line">kubectl delete pv pv-nfs-1g</span><br><span class="line">k delete -f pv-nfs.yaml</span><br></pre></td></tr></table></figure><h2 id="PVC-示例">PVC 示例</h2><ul class="lvl-0"><li class="lvl-2"><p>Pod 通过 PVC 向 PV 申请存储空间，如果 PVC 一直无法匹配到 PV，则 PVC 处于 Pending 状态。</p></li><li class="lvl-2"><p>Pod 必须与 PVC 处于同一命名空间。</p></li><li class="lvl-2"><p>PVC 与 PV 是 1:1 的关系。一旦 PV 绑定到 PVC，则 PVC 状态变为 Bound。该 PV 将不再被其他 PVC 绑定。</p></li><li class="lvl-2"><p>PVC 与 PV 匹配的条件</p></li></ul><table><thead><tr><th>匹配条件</th><th>说明</th></tr></thead><tbody><tr><td><strong>容量</strong></td><td><strong>PVC 请求的容量 ≤ PV 提供的容量</strong>。PV 必须至少满足 PVC 的容量请求。</td></tr><tr><td><strong>访问模式</strong></td><td><strong>PV 支持 PVC 请求的访问模式</strong>。PVC 要求的所有访问模式，PV 都必须具备。例如：PVC 要求 <code>ReadWriteOnce</code>，PV 至少要支持 <code>ReadWriteOnce</code>。</td></tr><tr><td><strong>StorageClass</strong></td><td><strong>PVC 和 PV 的 <code>storageClassName</code> 必须一致</strong>。如果 PVC 指定了 <code>storageClassName</code>，只能绑定同名的 PV。</td></tr><tr><td><strong>Selector（可选）</strong></td><td>如果 PVC 有设置 <code>selector</code>（基于标签），PV 的标签也必须匹配。</td></tr></tbody></table><div class="tips"><p><em><strong>小贴士</strong></em></p><ul class="lvl-1"><li class="lvl-2">PV 中声明的 <code>accessModes</code> 仅作为与 PVC 的访问模式进行匹配，实际挂载到 Pod 后，不会限制 Pod 的读写访问</li></ul></div><ul class="lvl-0"><li class="lvl-2"><p>一个简单的 yaml</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pvc.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypvc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span>   <span class="comment"># 申请匹配的访问模式</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">500Mi</span>  <span class="comment"># 申请的容量，实际容量以匹配的 PV 为准</span></span><br><span class="line">  <span class="comment"># selector:         # 匹配的 PV 标签</span></span><br><span class="line">  <span class="comment">#   matchLabels:</span></span><br><span class="line">  <span class="comment">#     pv: nfs-pv1   # pv 的标签，创建 pv 时要指定</span></span><br></pre></td></tr></table></figure><h3 id="管理-PVC">管理 PVC</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 PVC</span></span><br><span class="line">kubectl apply -f pvc.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看PVC，此时看到 pv-nfs-1g 绑定了 PVC</span></span><br><span class="line">$ k get pv,pvc</span><br><span class="line">NAME                         CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM           STORAGECLASS   VOLUMEATTRIBUTESCLASS   REASON   AGE</span><br><span class="line">persistentvolume/pv-nfs-1g   1Gi        RWO            Retain           Available                                  &lt;<span class="built_in">unset</span>&gt;                          16s</span><br><span class="line">persistentvolume/pv-nfs-2g   2Gi        RWX            Retain           Bound       default/mypvc                  &lt;<span class="built_in">unset</span>&gt;                          16s</span><br><span class="line"></span><br><span class="line">NAME                          STATUS   VOLUME      CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE</span><br><span class="line">persistentvolumeclaim/mypvc   Bound    pv-nfs-2g   2Gi        RWX                           &lt;<span class="built_in">unset</span>&gt;                 9s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 PVC</span></span><br><span class="line">kubectl delete pvc mypvc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此时再次查看 PV，pv-nfs-1g 状态变更为 Released，表示已经释放，但是不能再被其它 PVC 绑定了，只能删除重建了</span></span><br><span class="line">$ k get pv</span><br><span class="line">NAME        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM           STORAGECLASS   VOLUMEATTRIBUTESCLASS   REASON   AGE</span><br><span class="line">pv-nfs-1g   1Gi        RWO            Retain           Available                                              &lt;<span class="built_in">unset</span>&gt;                          18m</span><br><span class="line">pv-nfs-2g   2Gi        RWX            Retain           Released     default/mypvc                             &lt;<span class="built_in">unset</span>&gt;                          18m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 PV</span></span><br><span class="line">k delete pv pv-nfs-1g</span><br></pre></td></tr></table></figure><h2 id="Pod-绑定-PVC">Pod 绑定 PVC</h2><ul class="lvl-0"><li class="lvl-2"><p>这里以 nginx deployment 为例</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nginx-pvc-deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-pvc-deployment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span>                              <span class="comment"># 3个 pod会共享一个 PVC</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-pvc</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-pvc</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-storage</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span>  <span class="comment"># 挂载到 nginx 的默认网页目录</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-storage</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span>              <span class="comment"># 指定存储卷类型是 PVC</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">mypvc</span>                  <span class="comment"># 对应你创建的 PVC 名称</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>一个 PVC 对应一个 PV，但是一个 PVC 可以对应多个 Deployment 等控制器。下面我们就再创建一个 Deployment，将 相同的 PVC 挂载到容器中，并且每隔5秒修改一次 PVC 挂载的网页，并通过 nginx 容器查看结果</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># busybox-deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">busybox-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">busybox</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;while true; do echo $(date) &gt; /data/index.html; sleep 5; done&quot;</span>]</span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">shared-volume</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">shared-volume</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">mypvc</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>创建后查看 pod ip</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ k get pod -o wide</span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE     IP               NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">busybox-deployment-d7589665d-dx2rs      1/1     Running   0          2m59s   10.244.126.6     k8s-worker2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-pvc-deployment-775b8c4f8b-89cw7   1/1     Running   0          44s     10.244.126.8     k8s-worker2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-pvc-deployment-775b8c4f8b-fszlf   1/1     Running   0          44s     10.244.194.123   k8s-worker1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-pvc-deployment-775b8c4f8b-w9qkt   1/1     Running   0          44s     10.244.126.7     k8s-worker2   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>访问任意一个 nginx pod</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 此时会看到页面内容在变化</span></span><br><span class="line">watch -n 5 curl 10.244.194.123</span><br></pre></td></tr></table></figure><h2 id="后记">后记</h2><ul class="lvl-0"><li class="lvl-2"><p>为 pod 绑定 pvc时，每次都要先创建 pv 和 pvc，非常麻烦。有什么好的解决方案吗？</p><blockquote><p>使用 StorageClass 实现自动创建 PV，我们下文将介绍如何实现。</p></blockquote></li><li class="lvl-2"><p>如果 PVC 被 Pod 使用，则此时可以删除 PVC 吗？</p><blockquote><p>不可以，PVC 被 Pod 使用，此时只能等待 Pod 删除后才能删除 PVC。<br>若此时执行了删除 PVC 命令，终端会一直等待，ctrl + c 退出后再次查看 PVC 状态，会看到 PVC 状态为 Terminating。但此时不会影响存Pod对储卷的使用。<br>此时一旦Pod 删除，PVC 就会被删除。</p></blockquote></li><li class="lvl-2"><p>如果PV 被 PVC 使用，则此时可以删除 PV 吗？</p><blockquote><p>不可以，PV 被 PVC 使用，此时只能等待 PVC 删除后才能删除 PV。<br>若此时执行了删除 PV 命令，终端会一直等待，ctrl + c 退出后再次查看 PV 状态，会看到 PV 状态为 Terminating。但此时不会影响Pod对存储卷的使用。<br>此时一旦 PVC 删除，PV 就会被删除。</p></blockquote></li></ul>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

引用本地其它文章连接{}
 大括号开始% post_link 文件名称(不包含.md) %大括号结束
 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍 K8S 的 持久卷 PV 和 PVC ，本文以 CentOS 8 为例。&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/&quot;&gt;K8S官网&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/kubernetes/kubernetes&quot;&gt;k8s Github&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/concepts/storage/persistent-volumes/&quot;&gt;k8s PV/PVC 官方文档&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文底层存储卷是 NFS&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="k8s" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/k8s/"/>
    
    
    <category term="K8S" scheme="https://blog.hanqunfeng.com/tags/K8S/"/>
    
  </entry>
  
  <entry>
    <title>K8S 之 存储卷 NFS</title>
    <link href="https://blog.hanqunfeng.com/2025/07/21/k8s-storage-nfs/"/>
    <id>https://blog.hanqunfeng.com/2025/07/21/k8s-storage-nfs/</id>
    <published>2025-07-21T15:34:15.000Z</published>
    <updated>2025-07-21T08:34:49.791Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote %引用本地其它文章连接{} 大括号开始% post_link 文件名称(不包含.md) %大括号结束 --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍 K8S 的 存储卷 NFS ，本文以 CentOS 8 为例。</p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/">K8S官网</a></p></li><li class="lvl-2"><p><a href="https://github.com/kubernetes/kubernetes">k8s Github</a></p></li></ul><span id="more"></span><h2 id="存储卷-NFS-介绍">存储卷 NFS 介绍</h2><ul class="lvl-0"><li class="lvl-2"><p>在 Kubernetes 中，NFS (Network File System) 是一种通过网络将远程存储挂载到 Pod 的方式。它允许多个 Pod 跨节点共享相同的存储目录，常用于 ReadWriteMany（RWX） 场景。</p></li><li class="lvl-2"><p>我们需要准备一个NFS 服务器，并配置 NFS 存储卷。具体可以参考 <a href="/2025/07/21/linux-nfs/" title="Linux 安装 NFS">Linux 安装 NFS</a></p></li><li class="lvl-2"><p>k8s中每个worker节点都需要安装 NFS 客户端，但是不需要挂载 NFS 存储卷，这个会在pod中进行。</p></li></ul><h2 id="示例">示例</h2><ul class="lvl-0"><li class="lvl-2"><p>一个使用 NFS 存储卷的 pod 示例</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nfs-direct-pod.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-direct-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;sleep 3600&quot;</span>]</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-volume</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/data</span>          <span class="comment"># 容器内挂载点</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-volume</span></span><br><span class="line">    <span class="attr">nfs:</span></span><br><span class="line">      <span class="attr">server:</span> <span class="number">10.211</span><span class="number">.55</span><span class="number">.88</span>      <span class="comment"># NFS 服务端地址</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/nfs-server/data</span>    <span class="comment"># NFS 服务端共享目录</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">false</span>           <span class="comment"># 是否只读挂载，false 表示可读写</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>创建 Pod</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f nfs-direct-pod.yaml</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>查看 Pod 挂载点</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看pod部署到哪个节点</span></span><br><span class="line">$ kubectl get pod nfs-direct-pod -o wide</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE   IP               NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">nfs-direct-pod   1/1     Running   0          12m   10.244.194.115   k8s-worker1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录 k8s-worker1 节点，查看 nfs 挂载点，也就是说 创建 pod时会自动在宿主机上挂载 nfs</span></span><br><span class="line">$ <span class="built_in">df</span> -t nfs4</span><br><span class="line">Filesystem                    1K-blocks    Used Available Use% Mounted on</span><br><span class="line">10.211.55.88:/nfs-server/data  42872832 3630080  39242752   9% /var/lib/kubelet/pods/e44786a9-fbd9-4ee8-bb28-84eb074fb7d9/volumes/kubernetes.io~nfs/nfs-volume</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod挂载的目录</span></span><br><span class="line">$ k <span class="built_in">exec</span> -it nfs-direct-pod -- <span class="built_in">df</span> -t nfs4</span><br><span class="line">Filesystem           1K-blocks      Used Available Use% Mounted on</span><br><span class="line">10.211.55.88:/nfs-server/data</span><br><span class="line">                      42872832   3630080  39242752   8% /data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 向nfs挂载目录中写入数据</span></span><br><span class="line">k <span class="built_in">exec</span> -it nfs-direct-pod -- sh -c <span class="string">&#x27;echo &quot;hello world&quot; &gt; /data/test.txt&#x27;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>删除pod</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">k delete pod nfs-direct-pod</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次登录 宿主机节点，发现 nfs 挂载点也被卸载了，但是 nfs-server 中的文件仍然存在</span></span><br><span class="line">$ <span class="built_in">df</span> -t nfs4</span><br><span class="line"><span class="built_in">df</span>: no file systems processed</span><br></pre></td></tr></table></figure><h2 id="存储卷类型-emptyDir、hostPath、NFS-的对比表">存储卷类型 emptyDir、hostPath、NFS 的对比表</h2><table><thead><tr><th>特性</th><th><code>emptyDir</code></th><th><code>hostPath</code></th><th><code>nfs</code></th></tr></thead><tbody><tr><td><strong>数据生命周期</strong></td><td>Pod 生命周期内有效，Pod 删除数据丢失</td><td>绑定节点上的目录，Pod 删了数据仍保留</td><td>存储在远程 NFS Server，Pod 删除数据不丢失</td></tr><tr><td><strong>共享范围</strong></td><td><strong>同一个 Pod 的多个容器可共享</strong></td><td>同一节点上多个 Pod 可共享</td><td>集群内多个 Pod 跨节点可共享</td></tr><tr><td><strong>持久化能力</strong></td><td>❌ 不持久化，随 Pod 生命周期结束消失</td><td>✅ 持久化，只要宿主机目录存在数据就在</td><td>✅ 持久化，NFS 存储独立于 Pod 存在</td></tr><tr><td><strong>跨节点共享</strong></td><td>❌ 不能</td><td>❌ 不能</td><td>✅ 支持跨节点共享</td></tr><tr><td><strong>适用场景</strong></td><td>临时缓存、进程间共享数据</td><td>宿主机特定目录挂载，日志存储、宿主机插件对接</td><td>多副本服务共享存储、持久化数据、共享配置文件</td></tr><tr><td><strong>数据安全性</strong></td><td>随 Pod 删除，<strong>数据易丢失</strong></td><td>容器有权限可修改宿主机文件，存在风险</td><td>依赖 NFS Server 稳定性，配置不当可能被所有节点读写</td></tr><tr><td><strong>典型用例</strong></td><td>Redis 缓存目录、Sidecar 容器共享日志</td><td>挂载宿主机 docker.sock、宿主机日志目录</td><td>跨 Pod 文件共享、Web 静态资源、Tensorflow 多副本训练共享数据</td></tr></tbody></table><h2 id="为什么已经有-NFS，还推荐用-PV-PVC？">为什么已经有 NFS，还推荐用 PV/PVC？</h2><ul class="lvl-0"><li class="lvl-2"><p>✅ 简短回答：PV/PVC 是对底层存储（如 NFS）的抽象和标准化管理。</p></li></ul><table><thead><tr><th>原因</th><th>说明</th></tr></thead><tbody><tr><td>✅ <strong>Kubernetes 标准资源</strong></td><td>用 PVC 声明存储需求，由 K8s 统一调度和管理。</td></tr><tr><td>✅ <strong>存储与 Pod 解耦</strong></td><td>Pod 专注于应用逻辑，PVC 专注于声明“我要一个 10Gi 的 RWX 存储”，背后是 NFS、Ceph 还是别的，开发者无需关心。</td></tr><tr><td>✅ <strong>动态供应</strong></td><td>搭配 StorageClass 可以实现 <strong>自动创建 PV</strong>，不需要手动维护 PV。</td></tr><tr><td>✅ <strong>生命周期管理</strong></td><td>PVC 被删除时可触发 PV 回收、保留或删除策略（<code>Retain</code>、<code>Recycle</code>、<code>Delete</code>）。直接挂载 NFS 没有这些机制。</td></tr><tr><td>✅ <strong>权限隔离</strong></td><td>PV/PVC 可以通过 <code>accessModes</code> 控制访问级别，比如只允许特定 Pod 访问。直接挂载 NFS 容易权限混乱。</td></tr><tr><td>✅ <strong>更好兼容性</strong></td><td>某些工作负载（如 StatefulSet）<strong>只能用 PVC</strong>，不支持直接 <code>nfs</code> 卷。</td></tr><tr><td>✅ <strong>更灵活的切换存储方案</strong></td><td>后期如果换成 Ceph、EBS、GlusterFS，只需改 PV/PVC，不需要改 Pod 配置。</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

引用本地其它文章连接{}
 大括号开始% post_link 文件名称(不包含.md) %大括号结束
 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍 K8S 的 存储卷 NFS ，本文以 CentOS 8 为例。&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/&quot;&gt;K8S官网&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/kubernetes/kubernetes&quot;&gt;k8s Github&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="k8s" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/k8s/"/>
    
    
    <category term="K8S" scheme="https://blog.hanqunfeng.com/tags/K8S/"/>
    
  </entry>
  
  <entry>
    <title>Linux 安装 NFS</title>
    <link href="https://blog.hanqunfeng.com/2025/07/21/linux-nfs/"/>
    <id>https://blog.hanqunfeng.com/2025/07/21/linux-nfs/</id>
    <published>2025-07-21T15:34:05.000Z</published>
    <updated>2025-07-21T07:58:09.351Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote % --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍 linux 下 nfs 文件系统的安装与使用</p></li><li class="lvl-2"><p>本文基于<code>CentOS8(x86_64)</code></p></li></ul><span id="more"></span><h2 id="NFS-简介">NFS 简介</h2><ul class="lvl-0"><li class="lvl-2"><p>NFS（网络文件系统，Network File System）是一个通过网络共享文件的协议，允许不同服务器或客户端像挂载本地磁盘一样访问远端的共享文件目录。</p></li></ul><h2 id="准备一台服务器">准备一台服务器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置 hostname</span></span><br><span class="line">hostnamectl set-hostname nfs-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看网卡</span></span><br><span class="line">ip a</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置IP 分配方式，manual: 手动指定IP，auto: DHCP自动获取，disabled: 关闭IP</span></span><br><span class="line">nmcli con mod enp0s5 ipv4.method manual</span><br><span class="line"><span class="comment"># 设置 IP</span></span><br><span class="line">nmcli con mod enp0s5 ipv4.addresses 10.211.55.88/24</span><br><span class="line"><span class="comment"># 设置 gateway</span></span><br><span class="line">nmcli con mod enp0s5 ipv4.gateway 10.211.55.1</span><br><span class="line"><span class="comment"># 设置 dns</span></span><br><span class="line">nmcli con mod enp0s5 ipv4.dns <span class="string">&quot;10.211.55.1,8.8.8.8&quot;</span></span><br><span class="line"><span class="comment"># 重新启动网卡</span></span><br><span class="line">nmcli con up enp0s5</span><br></pre></td></tr></table></figure><h2 id="NFS-安装：服务端">NFS 安装：服务端</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 nfs-utils 和 rpcbind</span></span><br><span class="line">dnf install rpcbind nfs-utils -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 nfs-server 存储目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /nfs-server/data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 nfs-server，可以添加多个目录</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/nfs-server/data *(insecure,rw,sync,no_root_squash,no_all_squash)&quot;</span> &gt;&gt; /etc/exports</span><br><span class="line"><span class="comment">## 配置项说明</span></span><br><span class="line"><span class="comment"># * ：允许所有客户端访问，也可以指定具体的客户端 IP 地址，比如：192.168.0.0/24(rw,sync,no_root_squash,no_all_squash)</span></span><br><span class="line"><span class="comment"># insecure ：允许任意端口（兼容性好,支持k8s），默认值是 secure：只允许 1024 以下端口，适合传统服务器</span></span><br><span class="line"><span class="comment"># rw ：读写权限，ro：只读权限</span></span><br><span class="line"><span class="comment"># sync ：同步模式，强一致性，async：异步模式，性能高，但存在丢数据风险</span></span><br><span class="line"><span class="comment"># no_root_squash ：允许 root 用户访问，默认情况下，root 用户访问时会被转换成 nobody 用户</span></span><br><span class="line"><span class="comment"># no_all_squash ：允许所有用户访问，默认情况下，所有用户访问时会被转换成 nobody 用户，默认就是这个，可以省略。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 rpcbind、nfs 服务</span></span><br><span class="line">systemctl start rpcbind &amp;&amp; systemctl start nfs-server</span><br><span class="line"><span class="comment"># 开机自启动</span></span><br><span class="line">systemctl <span class="built_in">enable</span> rpcbind &amp;&amp; systemctl <span class="built_in">enable</span> nfs-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改配置文件 /etc/exports，需要重载 nfs 配置</span></span><br><span class="line">systemctl reload nfs-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 nfs 服务状态</span></span><br><span class="line">systemctl status nfs-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 nfs 服务监听的端口，默认为 2049</span></span><br><span class="line">$ rpcinfo -p | grep nfs</span><br><span class="line">    100003    3   tcp   2049  nfs</span><br><span class="line">    100003    4   tcp   2049  nfs</span><br><span class="line">    100227    3   tcp   2049  nfs_acl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查导出的共享目录</span></span><br><span class="line">$ exportfs -v</span><br><span class="line">/nfs-server/data</span><br><span class="line">                &lt;world&gt;(<span class="built_in">sync</span>,wdelay,hide,no_subtree_check,sec=sys,rw,insecure,no_root_squash,no_all_squash)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="开放端口">开放端口</h3><ul class="lvl-0"><li class="lvl-2"><p>查看当前使用的端口</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ rpcinfo -p 10.211.55.88</span><br><span class="line">   program vers proto   port  service</span><br><span class="line">    100000    4   tcp    111  portmapper</span><br><span class="line">    100000    3   tcp    111  portmapper</span><br><span class="line">    100000    2   tcp    111  portmapper</span><br><span class="line">    100000    4   udp    111  portmapper</span><br><span class="line">    100000    3   udp    111  portmapper</span><br><span class="line">    100000    2   udp    111  portmapper</span><br><span class="line">    100024    1   udp  36578  status</span><br><span class="line">    100024    1   tcp  46973  status</span><br><span class="line">    100005    1   udp  20048  mountd</span><br><span class="line">    100005    1   tcp  20048  mountd</span><br><span class="line">    100005    2   udp  20048  mountd</span><br><span class="line">    100005    2   tcp  20048  mountd</span><br><span class="line">    100005    3   udp  20048  mountd</span><br><span class="line">    100005    3   tcp  20048  mountd</span><br><span class="line">    100003    3   tcp   2049  nfs</span><br><span class="line">    100003    4   tcp   2049  nfs</span><br><span class="line">    100227    3   tcp   2049  nfs_acl</span><br><span class="line">    100021    1   udp  36529  nlockmgr</span><br><span class="line">    100021    3   udp  36529  nlockmgr</span><br><span class="line">    100021    4   udp  36529  nlockmgr</span><br><span class="line">    100021    1   tcp  45917  nlockmgr</span><br><span class="line">    100021    3   tcp  45917  nlockmgr</span><br><span class="line">    100021    4   tcp  45917  nlockmgr</span><br></pre></td></tr></table></figure><table><thead><tr><th>Program (编号)</th><th>服务名称</th><th>用途</th><th>端口</th><th>说明</th></tr></thead><tbody><tr><td><code>100000</code></td><td>portmapper</td><td>RPC 服务注册表</td><td>111/tcp, 111/udp</td><td><strong>必须开放</strong>，客户端通过它查找其它服务端口</td></tr><tr><td><code>100024</code></td><td>status (rpc.statd)</td><td>文件锁定状态管理</td><td>36578/udp, 46973/tcp</td><td>常配合 nlockmgr 使用，非必需</td></tr><tr><td><code>100005</code></td><td>mountd</td><td>挂载服务</td><td>20048/tcp, 20048/udp</td><td><strong>挂载时必需</strong></td></tr><tr><td><code>100003</code></td><td>nfs</td><td>NFS 主服务</td><td>2049/tcp</td><td><strong>核心服务，必需</strong></td></tr><tr><td><code>100227</code></td><td>nfs_acl</td><td>NFS 的 ACL 权限控制</td><td>2049/tcp</td><td>通常与 nfs 一起</td></tr><tr><td><code>100021</code></td><td>nlockmgr</td><td>文件锁管理</td><td>36529/udp, 45917/tcp</td><td>Stateful 应用涉及文件锁时需要</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>最小端口要求（基本挂载用）</p></li></ul><table><thead><tr><th>场景</th><th>需要开放的端口</th></tr></thead><tbody><tr><td>✅ <strong>基本 NFS 挂载读写</strong></td><td><code>2049/tcp</code> + <code>111/tcp/udp</code></td></tr><tr><td>✅ <strong>容器或 K8s 挂载</strong></td><td>同上，一般还推荐 <code>20048/tcp/udp</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>开放必须端口</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent --add-port=2049/tcp</span><br><span class="line">firewall-cmd --permanent --add-port=111/tcp</span><br><span class="line">firewall-cmd --permanent --add-port=111/udp</span><br><span class="line">firewall-cmd --permanent --add-port=20048/tcp</span><br><span class="line">firewall-cmd --permanent --add-port=20048/udp</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure><h2 id="NFS-安装：客户端">NFS 安装：客户端</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 nfs-utils 和 rpcbind，安装后不需要启动 nfs-server 服务，只需要启动 rpcbind 服务，所有客户端都要运行</span></span><br><span class="line"><span class="built_in">sudo</span> dnf install rpcbind nfs-utils -y</span><br><span class="line"><span class="built_in">sudo</span> systemctl start rpcbind &amp;&amp; systemctl <span class="built_in">enable</span> rpcbind</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看服务器的共享资源列表</span></span><br><span class="line"><span class="comment"># showmount -e &lt;nfs-server-ip&gt;</span></span><br><span class="line">$ showmount -e 10.211.55.88</span><br><span class="line">Export list <span class="keyword">for</span> 10.211.55.88:</span><br><span class="line">/nfs-server/data *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 客户端挂载目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /nfs/data</span><br><span class="line"><span class="comment"># 挂载</span></span><br><span class="line">mount -t nfs 10.211.55.88:/nfs-server/data /nfs/data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看挂载点</span></span><br><span class="line">$ mount | grep nfs/data</span><br><span class="line">10.211.55.88:/nfs-server/data on /nfs/data <span class="built_in">type</span> nfs4 (rw,relatime,vers=4.2,rsize=524288,wsize=524288,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,clientaddr=10.211.55.11,local_lock=none,addr=10.211.55.88)</span><br><span class="line"><span class="comment"># 查看挂载点信息，这种方式更友好</span></span><br><span class="line">$ <span class="built_in">df</span> -t nfs4</span><br><span class="line">Filesystem                    1K-blocks    Used Available Use% Mounted on</span><br><span class="line">10.211.55.88:/nfs-server/data  42872832 3630080  39242752   9% /nfs/data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置自动挂载</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;10.211.55.88:/nfs-server/data /nfs/data nfs defaults 0 0&quot;</span> &gt;&gt; /etc/fstab</span><br><span class="line"><span class="comment"># 根据 /etc/fstab 文件的配置，尝试挂载所有未挂载的文件系统。修改 /etc/fstab 后执行 mount -a 立即生效</span></span><br><span class="line">mount -a</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>客户端挂载的目录不能删除，需要先卸载</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -f 强制卸载</span></span><br><span class="line">umount -f /nfs/data</span><br><span class="line"></span><br><span class="line">vim /etc/fstab</span><br><span class="line"><span class="comment"># 删除或注释掉对应的 NFS 挂载行</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> -rf /nfs/data</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍 linux 下 nfs 文件系统的安装与使用&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文基于&lt;code&gt;CentOS8(x86_64)&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="linux" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/linux/"/>
    
    <category term="nfs" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/linux/nfs/"/>
    
    
    <category term="linux" scheme="https://blog.hanqunfeng.com/tags/linux/"/>
    
    <category term="nfs" scheme="https://blog.hanqunfeng.com/tags/nfs/"/>
    
  </entry>
  
  <entry>
    <title>K8S 之 存储卷 hostPath</title>
    <link href="https://blog.hanqunfeng.com/2025/07/21/k8s-storage-hostpath/"/>
    <id>https://blog.hanqunfeng.com/2025/07/21/k8s-storage-hostpath/</id>
    <published>2025-07-21T15:33:05.000Z</published>
    <updated>2025-07-21T08:25:15.741Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote %引用本地其它文章连接{} 大括号开始% post_link 文件名称(不包含.md) %大括号结束 --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍 K8S 的 存储卷 hostPath ，本文以 CentOS 8 为例。</p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/">K8S官网</a></p></li><li class="lvl-2"><p><a href="https://github.com/kubernetes/kubernetes">k8s Github</a></p></li></ul><span id="more"></span><h2 id="存储卷-hostPath-介绍">存储卷 hostPath 介绍</h2><ul class="lvl-0"><li class="lvl-2"><p>hostPath 是一种直接把 Node 节点本地文件或目录 挂载到 Pod 容器里的存储卷。</p></li><li class="lvl-2"><p>容易破坏节点环境，不建议生产使用</p></li><li class="lvl-2"><p>同一个 Deployment 的多个 Pod 被调度到同一个节点，并且它们的 hostPath 配置指向相同的宿主机路径，这些 Pod 之间是可以共享该目录中文件的。</p></li><li class="lvl-2"><p>典型使用场景</p></li></ul><table><thead><tr><th>场景</th><th>示例</th></tr></thead><tbody><tr><td>日志收集</td><td>挂载 <code>/var/log</code> 到 Pod 内部</td></tr><tr><td>挂载宿主机配置文件</td><td>如挂载 <code>/etc/hosts</code>、<code>/etc/localtime</code></td></tr><tr><td>使用宿主机 docker.sock</td><td>挂载 <code>/var/run/docker.sock</code> 运行 Docker-in-Docker</td></tr><tr><td>存储调试临时文件</td><td>Pod 调试时访问宿主机特定目录</td></tr></tbody></table><h2 id="示例">示例</h2><ul class="lvl-0"><li class="lvl-2"><p>Pod 内部 /mnt/hostdata 映射到宿主机 /data 目录</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hostpath-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;sleep 3600&quot;</span>]</span><br><span class="line">    <span class="attr">volumeMounts:</span>                   <span class="comment"># 存储卷挂载点</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/mnt/hostdata</span>      <span class="comment"># 挂载点路径，挂载到容器的 /mnt/hostdata 目录</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">myvolume</span>                <span class="comment"># 存储卷名称 ，与 volumes 中定义的 volume 配置名称一致</span></span><br><span class="line">  <span class="attr">volumes:</span>                          <span class="comment"># 存储卷声明</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myvolume</span>                  <span class="comment"># 存储卷名称</span></span><br><span class="line">    <span class="attr">hostPath:</span>                       <span class="comment"># 存储卷类型，这里是 hostPath</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data</span>                   <span class="comment"># 主机目录</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Directory</span>               <span class="comment"># 可选字段，主要用于挂载前验证</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>hostPath.type</code> 可以配置的值如下，默认为 空。</p></li></ul><table><thead><tr><th>type</th><th>含义</th></tr></thead><tbody><tr><td><code>DirectoryOrCreate</code></td><td>如果 <code>/data</code> 不存在则自动创建 ，权限为 0755</td></tr><tr><td><code>Directory</code></td><td>必须存在且为目录</td></tr><tr><td><code>File</code></td><td>必须存在且为文件</td></tr><tr><td><code>Socket</code></td><td>必须是 socket</td></tr><tr><td><code>CharDevice</code></td><td>字符设备</td></tr><tr><td><code>BlockDevice</code></td><td>块设备</td></tr><tr><td><code>FileOrCreate</code></td><td>不存在则自动创建空文件，权限设置为 0644</td></tr><tr><td><code>不设置</code></td><td>默认值是空，主机上的路径无论是文件、目录、甚至不存在，都会直接挂载 ,容易引起预期之外的挂载问题</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>Kubernetes 在删除 Pod 时，不会删除 hostPath 所挂载的宿主机目录或文件</p></li></ul><table><thead><tr><th>存储卷类型</th><th>删除 Pod 后目录会被删除吗？</th><th>说明</th></tr></thead><tbody><tr><td><code>emptyDir</code></td><td>✅ <strong>会被删除</strong></td><td>临时目录，Pod 生命周期结束自动清理</td></tr><tr><td><code>hostPath</code></td><td>❌ <strong>不会删除</strong></td><td>宿主机路径独立于 Pod 生命周期，<strong>不会清理</strong></td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

引用本地其它文章连接{}
 大括号开始% post_link 文件名称(不包含.md) %大括号结束
 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍 K8S 的 存储卷 hostPath ，本文以 CentOS 8 为例。&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/&quot;&gt;K8S官网&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/kubernetes/kubernetes&quot;&gt;k8s Github&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="k8s" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/k8s/"/>
    
    
    <category term="K8S" scheme="https://blog.hanqunfeng.com/tags/K8S/"/>
    
  </entry>
  
  <entry>
    <title>K8S 之 存储卷 emptyDir</title>
    <link href="https://blog.hanqunfeng.com/2025/07/21/k8s-storage-emptydir/"/>
    <id>https://blog.hanqunfeng.com/2025/07/21/k8s-storage-emptydir/</id>
    <published>2025-07-21T15:30:05.000Z</published>
    <updated>2025-07-21T03:30:08.434Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote %引用本地其它文章连接{} 大括号开始% post_link 文件名称(不包含.md) %大括号结束 --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍 K8S 的 存储卷 emptyDir ，本文以 CentOS 8 为例。</p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/">K8S官网</a></p></li><li class="lvl-2"><p><a href="https://github.com/kubernetes/kubernetes">k8s Github</a></p></li></ul><span id="more"></span><h2 id="存储卷-emptyDir-介绍">存储卷 emptyDir 介绍</h2><ul class="lvl-0"><li class="lvl-2"><p>emptyDir 是 Kubernetes 中最简单的一种 Pod 级别的临时存储卷。它的核心特点是：Pod 生命周期内共享临时存储，Pod 删除后数据自动丢弃。</p></li><li class="lvl-2"><p>同一个 Pod 内的多个容器可以通过 emptyDir 共享数据。跨 Pod 不共享，适用于临时数据。</p></li><li class="lvl-2"><p>emptyDir 只能挂载目录。</p></li></ul><h2 id="示例">示例</h2><ul class="lvl-0"><li class="lvl-2"><p>两个容器 app 和 sidecar 通过 /data 共享一个 emptyDir 卷。</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># shared-emptydir-pod.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">shared-emptydir-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.sto:</span> <span class="string">emptydir</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo Hello &gt; /data1/hello; sleep 3600&quot;</span>]</span><br><span class="line">    <span class="attr">volumeMounts:</span>               <span class="comment"># 存储卷挂载点</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">shared-data</span>         <span class="comment"># 挂载点名称，与下面 volumes 中定义的 volume 名称一致</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/data1</span>          <span class="comment"># 挂载点路径，挂载到容器的 /data1 目录</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sidecar</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;sleep 3600&quot;</span>]</span><br><span class="line">    <span class="attr">volumeMounts:</span>               <span class="comment"># 存储卷挂载点</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">shared-data</span>         <span class="comment"># 挂载点名称，与上面容器中的 volume 配置名称一致</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/data2</span>         <span class="comment"># 挂载点路径，挂载到容器的 /data2 目录</span></span><br><span class="line">  <span class="attr">volumes:</span>                      <span class="comment"># 存储卷声明</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">shared-data</span>           <span class="comment"># 存储卷名称</span></span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;                <span class="comment"># 声明为 emptyDir 存储卷</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>创建</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">k apply -f shared-emptydir-pod.yaml</span><br><span class="line"><span class="comment"># 查看pod所在节点</span></span><br><span class="line">$ k get pod -l app.sto=emptydir</span><br><span class="line">NAME                  READY   STATUS    RESTARTS   AGE   IP              NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">shared-emptydir-pod   2/2     Running   0          22m   10.244.126.59   k8s-worker2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"><span class="comment"># 查看 pod-uid</span></span><br><span class="line">$ kubectl get pod shared-emptydir-pod -o jsonpath=<span class="string">&#x27;&#123;.metadata.uid&#125;&#x27;</span></span><br><span class="line">d597b4d7-e6b6-4522-887e-73d3f4c01006</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>emptyDir 存储卷 默认使用节点本地磁盘，路径为 <code>/var/lib/kubelet/pods/&lt;pod-uid&gt;/volumes/kubernetes.io~empty-dir/&lt;volume-name&gt;</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登录 k8s-worker2 节点</span></span><br><span class="line"><span class="built_in">export</span> POD_UID=d597b4d7-e6b6-4522-887e-73d3f4c01006</span><br><span class="line"><span class="built_in">export</span> POD_UID=6ea6636c-4a24-4dc5-af2a-2448825913b6</span><br><span class="line"><span class="built_in">export</span> VOLUME_NAME=shared-data</span><br><span class="line"><span class="built_in">cd</span> /var/lib/kubelet/pods/<span class="variable">$POD_UID</span>/volumes/kubernetes.io~empty-dir/<span class="variable">$VOLUME_NAME</span></span><br><span class="line">$ <span class="built_in">ls</span></span><br><span class="line">hello</span><br><span class="line">$ <span class="built_in">cat</span> hello</span><br><span class="line">Hello</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>进入容器查看存储卷内容</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it shared-emptydir-pod -c app -- <span class="built_in">cat</span> /data1/hello</span><br><span class="line">Hello</span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it shared-emptydir-pod -c sidecar -- <span class="built_in">cat</span> /data2/hello</span><br><span class="line">Hello</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改内容，实际上在容器内部和外部都可以修改存储卷内容，修改后立刻生效</span></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it shared-emptydir-pod -c sidecar -- sh -c <span class="string">&quot;echo &#x27;Hello World&#x27; &gt; /data2/hello&quot;</span></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it shared-emptydir-pod -c app -- <span class="built_in">cat</span> /data1/hello</span><br><span class="line">Hello World</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>删除POD后emptydir存储卷会立刻删除</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod shared-emptydir-pod</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录 k8s-worker2 节点查看 emptydir 存储卷</span></span><br><span class="line">$ <span class="built_in">ls</span> /var/lib/kubelet/pods/<span class="variable">$POD_UID</span></span><br><span class="line"><span class="built_in">ls</span>: cannot access <span class="string">&#x27;/var/lib/kubelet/pods/d597b4d7-e6b6-4522-887e-73d3f4c01006&#x27;</span>: No such file or directory</span><br></pre></td></tr></table></figure><h2 id="将-emptydir-存储卷改用-内存-存储">将 emptydir 存储卷改用 内存 存储</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">emptyDir:</span></span><br><span class="line">  <span class="attr">medium:</span> <span class="string">Memory</span>        <span class="comment"># 使用 内存 存储（tmpfs），适合高 IO 临时缓存</span></span><br><span class="line">  <span class="attr">sizeLimit:</span> <span class="string">512Mi</span>      <span class="comment"># 限制存储大小</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>这里要注意，即使这里使用内存存储，但是 <code>/var/lib/kubelet/pods/&lt;pod-uid&gt;/volumes/kubernetes.io~empty-dir/&lt;volume-name&gt;</code> 依然存在，但它挂载的是 tmpfs 文件系统</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登录pod所在节点查看挂载点</span></span><br><span class="line">$ mount | grep <span class="variable">$POD_UID</span></span><br><span class="line">tmpfs on /var/lib/kubelet/pods/6ea6636c-4a24-4dc5-af2a-2448825913b6/volumes/kubernetes.io~empty-dir/shared-data <span class="built_in">type</span> tmpfs (rw,relatime,size=524288k)</span><br><span class="line">tmpfs on /var/lib/kubelet/pods/6ea6636c-4a24-4dc5-af2a-2448825913b6/volumes/kubernetes.io~projected/kube-api-access-5nk7d <span class="built_in">type</span> tmpfs (rw,relatime,size=3903212k)</span><br></pre></td></tr></table></figure><table><thead><tr><th>卷类型</th><th>来源</th><th>挂载路径</th><th>作用</th></tr></thead><tbody><tr><td>emptyDir</td><td>你配置的</td><td><code>/data1</code>, <code>/data2</code></td><td>Pod 内部容器共享临时内存存储</td></tr><tr><td>projected</td><td>系统自动</td><td><code>/var/run/secrets/kubernetes.io/serviceaccount/</code></td><td>挂载 serviceaccount token，CA 证书</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>查看容器内挂载点</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> shared-emptydir-pod -c app -- mount | grep /data1</span><br><span class="line">tmpfs on /data1 <span class="built_in">type</span> tmpfs (rw,relatime,size=524288k)</span><br><span class="line">$ kubectl <span class="built_in">exec</span> shared-emptydir-pod -c app -- mount | grep serviceaccount</span><br><span class="line">tmpfs on /var/run/secrets/kubernetes.io/serviceaccount <span class="built_in">type</span> tmpfs (ro,relatime,size=3903212k)</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

引用本地其它文章连接{}
 大括号开始% post_link 文件名称(不包含.md) %大括号结束
 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍 K8S 的 存储卷 emptyDir ，本文以 CentOS 8 为例。&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/&quot;&gt;K8S官网&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/kubernetes/kubernetes&quot;&gt;k8s Github&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="k8s" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/k8s/"/>
    
    
    <category term="K8S" scheme="https://blog.hanqunfeng.com/tags/K8S/"/>
    
  </entry>
  
  <entry>
    <title>K8S 之 Statefulset</title>
    <link href="https://blog.hanqunfeng.com/2025/07/20/k8s-statefulset/"/>
    <id>https://blog.hanqunfeng.com/2025/07/20/k8s-statefulset/</id>
    <published>2025-07-20T15:30:05.000Z</published>
    <updated>2025-07-22T08:48:12.925Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote %引用本地其它文章连接{} 大括号开始% post_link 文件名称(不包含.md) %大括号结束 --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍 K8S 的 Statefulset ，本文以 CentOS 8 为例。</p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/">K8S官网</a></p></li><li class="lvl-2"><p><a href="https://github.com/kubernetes/kubernetes">k8s Github</a></p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/statefulset/">k8s Statefulset 介绍</a></p></li></ul><span id="more"></span><h2 id="Statefulset-介绍">Statefulset 介绍</h2><ul class="lvl-0"><li class="lvl-2"><p>Statefulset(缩写为 sts) 是 K8S 官方提供的一种控制器，用于管理有状态应用。例如，数据库应用，消息队列，等等。</p></li><li class="lvl-2"><p>Statefulset(有状态) 与 Deployment(无状态) 的区别是：</p><ul class="lvl-2"><li class="lvl-4">Statefulset 创建的 Pod 会有相同的名称，并且会分配相同的持久卷。</li><li class="lvl-4">Statefulset 创建的 Pod 使用 Headless Service(无头服务，没有ClusterIP)进行通信。</li></ul></li></ul><h2 id="Statefulset-管理">Statefulset 管理</h2><h3 id="Statefulset-创建">Statefulset 创建</h3><ul class="lvl-0"><li class="lvl-2"><p>Statefulset 只能 通过 <code>yaml</code> 创建，不支持 <code>create</code> 创建</p></li><li class="lvl-2"><p>一个简单的 <code>redis-statefulset.yaml</code> 文件说明</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span>                      <span class="comment"># api版本</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span>                       <span class="comment"># 资源类型</span></span><br><span class="line"><span class="attr">metadata:</span>                           <span class="comment"># 元数据</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-svc</span>                   <span class="comment"># service名称</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">sts-ns</span></span><br><span class="line"><span class="attr">spec:</span>                               <span class="comment"># 配置</span></span><br><span class="line">  <span class="attr">ports:</span>                            <span class="comment"># 端口</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">6379</span>                      <span class="comment"># 集群内访问端口，service的端口，一般配置为与 targetPort 一致，但是非必须</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span>                   <span class="comment"># 协议</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">6379</span>                <span class="comment"># 容器端口, pod的端口，这个必须与实际容器端口一致</span></span><br><span class="line">  <span class="attr">selector:</span>                         <span class="comment"># 选择器</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span>                      <span class="comment"># pod的标签，即匹配pod的标签 app=redis</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span>                   <span class="comment"># 集群IP设置为None，即为“Headless Service”</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span>                   <span class="comment"># 服务类型，默认为ClusterIP</span></span><br><span class="line"><span class="string">---</span>                                 <span class="comment"># 分割线</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>                  <span class="comment"># 指定使用的 API 版本，这里是 apps/v1，适用于 StatefulSet 资源</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span>                    <span class="comment"># Kubernetes 资源类型，这里是部署（StatefulSet）</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-sts</span>                    <span class="comment"># 资源名称，必须唯一（在同一命名空间下）</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">sts-ns</span></span><br><span class="line"><span class="attr">spec:</span>                                <span class="comment"># 配置项</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span>           <span class="comment"># 保留的历史版本数，默认值为 10，Deployment 和 StatefulSet 都有这个配置项。回滚时有用。</span></span><br><span class="line">  <span class="attr">selector:</span>                          <span class="comment"># 选择器，指定要管理的 Pod</span></span><br><span class="line">    <span class="attr">matchLabels:</span>                     <span class="comment"># 标签选择器</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">redis</span>                     <span class="comment"># 选择器，指定 StatefulSet 管理哪些 Pod（标签必须与 template 中匹配）</span></span><br><span class="line">  <span class="attr">updateStrategy:</span>                    <span class="comment"># 更新策略，这里要注意这个更新策略与Deployment的属性名字不一样</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span>              <span class="comment"># 1.RollingUpdate：这是默认的更新策略。使用 RollingUpdate 更新策略时，在更新 StatefulSet 模板后， 老的 StatefulSet Pod 将被终止，并且将以受控方式自动创建新的 StatefulSet Pod。 更新期间，最多只能有 StatefulSet 的一个 Pod 运行于每个节点上。</span></span><br><span class="line">                                     <span class="comment"># 2.OnDelete：使用 OnDelete 更新策略时，在更新 StatefulSet 模板后，只有当你手动删除老的 StatefulSet Pod 之后，新的 StatefulSet Pod 才会被自动创建。</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span>                   <span class="comment"># 滚动升级的配置</span></span><br><span class="line">      <span class="attr">partition:</span> <span class="number">0</span>                    <span class="comment"># 用于控制从第几个 Pod 开始滚动升级</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">redis-svc</span>             <span class="comment"># 服务名称,sts对象使用无头服务，这个是必填项</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span>                        <span class="comment"># 副本数，默认是 1</span></span><br><span class="line">  <span class="attr">template:</span>                          <span class="comment"># 模板，定义 Pod 的内容，具体可以参考 Pod 的配置</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">redis</span>                   <span class="comment"># Pod 的标签，必须与 selector 中的 matchLabels 一致</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">redis:6.2</span>             <span class="comment"># 容器使用的镜像，这里是官方的 redis 镜像</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">redis</span>                  <span class="comment"># 容器的名称，实际的名称为 sts-redis-&lt;number&gt;，从 0 开始递增</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>执行创建</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建命名空间</span></span><br><span class="line">kubectl create namespace sts-ns</span><br><span class="line"><span class="comment"># 创建 StatefulSet</span></span><br><span class="line">kubectl apply -f redis-statefulset.yaml</span><br></pre></td></tr></table></figure><h3 id="查看-Statefulset">查看 Statefulset</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ k get all -n sts-ns</span><br><span class="line">NAME              READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/redis-sts-0   1/1     Running   0          40s</span><br><span class="line">pod/redis-sts-1   1/1     Running   0          24s</span><br><span class="line"></span><br><span class="line">NAME                TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">service/redis-svc   ClusterIP   None         &lt;none&gt;        6379/TCP   40s</span><br><span class="line"></span><br><span class="line">NAME                         READY   AGE</span><br><span class="line">statefulset.apps/redis-sts   2/2     40s</span><br></pre></td></tr></table></figure><h3 id="访问pod中的redis服务">访问pod中的redis服务</h3><ul class="lvl-0"><li class="lvl-2"><p>既然是Headless Service，就只能在集群内部访问</p></li><li class="lvl-2"><p>在相同的 namespace 中，可以通过 <code>serviceName</code> 直接访问，访问指定的 pod，可以通过 <code>&lt;pod-name&gt;.&lt;service-name&gt;</code></p></li><li class="lvl-2"><p>在不同的 namespace 中，可以通过 <code>&lt;serviceName&gt;.&lt;namespace&gt;</code> 或者 <code>&lt;serviceName&gt;.&lt;namespace&gt;.svc.cluster.local</code> 访问，访问指定的 pod，可以通过 <code>&lt;pod-name&gt;.&lt;service-name&gt;.&lt;namespace&gt;.svc.cluster.local</code> 访问，因为 pod-name 是固定且唯一的</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ k <span class="built_in">exec</span> -it pod/redis-sts-0 -n sts-ns -- getent hosts redis-svc</span><br><span class="line">10.244.126.55   redis-svc.sts-ns.svc.cluster.local</span><br><span class="line">10.244.194.110  redis-svc.sts-ns.svc.cluster.local</span><br><span class="line"></span><br><span class="line">$ k <span class="built_in">exec</span> -it pod/redis-sts-0 -n sts-ns -- getent hosts redis-sts-1.redis-svc</span><br><span class="line">10.244.126.55   redis-sts-1.redis-svc.sts-ns.svc.cluster.local</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>在集群外部访问，需要创建一个新的 Service，类型为 NodePort 或者 LoadBalancer，将redis服务暴露出去</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span>                      <span class="comment"># api版本</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span>                       <span class="comment"># 资源类型</span></span><br><span class="line"><span class="attr">metadata:</span>                           <span class="comment"># 元数据</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-svc-out</span>               <span class="comment"># service名称</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">sts-ns</span></span><br><span class="line"><span class="attr">spec:</span>                               <span class="comment"># 配置</span></span><br><span class="line">  <span class="attr">ports:</span>                            <span class="comment"># 端口</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">6379</span>                      <span class="comment"># 集群内访问端口，service的端口，一般配置为与 targetPort 一致，但是非必须</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span>                   <span class="comment"># 协议</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">6379</span>                <span class="comment"># 容器端口, pod的端口，这个必须与实际容器端口一致</span></span><br><span class="line">  <span class="attr">selector:</span>                         <span class="comment"># 选择器</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span>                      <span class="comment"># pod的标签，即匹配pod的标签 app=redis</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span>                <span class="comment"># 负载均衡</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>执行</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建</span></span><br><span class="line">$ k create -f redis-svc-out.yaml</span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">$ k get svc -n sts-ns</span><br><span class="line">NAME            TYPE           CLUSTER-IP    EXTERNAL-IP     PORT(S)          AGE</span><br><span class="line">redis-svc       ClusterIP      None          &lt;none&gt;          6379/TCP         70m</span><br><span class="line">redis-svc-out   LoadBalancer   10.96.21.96   10.211.55.202   6379:31806/TCP   54m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在集群外的机器上访问 redis，每次连接会轮询访问各个pod</span></span><br><span class="line">$ redis-cli -h 10.211.55.202 info server | grep redis_version</span><br><span class="line">redis_version:8.0.3</span><br></pre></td></tr></table></figure><h3 id="查看-Statefulset-详情">查看 Statefulset 详情</h3><ul class="lvl-0"><li class="lvl-2"><p>当 Statefulset 运行错误时，可以通过该命令查看 Statefulset 的详情，找到错误原因</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe sts &lt;sts-name&gt;</span><br><span class="line">kubectl describe sts &lt;sts-name&gt; -n &lt;namespace-name&gt;</span><br></pre></td></tr></table></figure><h3 id="删除-Statefulset">删除 Statefulset</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete sts &lt;sts-name&gt;</span><br><span class="line">kubectl delete sts &lt;sts-name&gt; -n &lt;namespace-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过 yaml 文件删除</span></span><br><span class="line">kubectl delete -f &lt;yaml-file&gt;</span><br></pre></td></tr></table></figure><h3 id="查看-Statefulset-日志">查看 Statefulset 日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs sts/&lt;sts-name&gt;</span><br><span class="line">kubectl logs sts/&lt;sts-name&gt; -n &lt;namespace-name&gt;</span><br></pre></td></tr></table></figure><h3 id="滚动升级与回滚-Statefulset">滚动升级与回滚 Statefulset</h3><ul class="lvl-0"><li class="lvl-2"><p>对 <code>RollingUpdate</code> 类型的 <code>Statefulset</code> 的 <code>.spec.template</code> 的任何更新都将触发滚动更新。</p></li><li class="lvl-2"><p>我们修改过 <code>Statefulset</code> 的 <code>.spec.template</code>，并保存后，重新运行 <code>kubectl apply -f &lt;yaml-file&gt;</code>即可触发滚动升级。</p></li><li class="lvl-2"><p>如果只是更新容器的镜像，也可以通过如下命令触发滚动升级</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ k <span class="built_in">exec</span> -it pod/redis-sts-0 -n sts-ns -- redis-server -v</span><br><span class="line">Redis server v=6.2.19 sha=00000000:0 malloc=jemalloc-5.1.0 bits=64 build=c51c65e7ae83f735</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl set image sts/&lt;sts-name&gt; &lt;container-name&gt;=&lt;image&gt;:&lt;tag&gt; --record=true</span></span><br><span class="line">kubectl <span class="built_in">set</span> image sts redis-sts redis=redis:8.0 --record=<span class="literal">true</span> -n sts-ns</span><br><span class="line"></span><br><span class="line">$ k <span class="built_in">exec</span> -it pod/redis-sts-0 -n sts-ns -- redis-server -v</span><br><span class="line">Redis server v=8.0.3 sha=00000000:1 malloc=jemalloc-5.3.0 bits=64 build=d4cb0aa008da4ca9</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>查看滚动升级状态</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl rollout status sts/&lt;sts-name&gt;</span></span><br><span class="line">$ kubectl rollout status sts redis-sts -n sts-ns</span><br><span class="line">partitioned roll out complete: 2 new pods have been updated...</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>查看历史版本</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 前面的序号表示版本号</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> sts redis-sts -n sts-ns</span><br><span class="line"><span class="comment"># 查看指定版本的详情</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> sts redis-sts -n sts-ns --revision=1</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>回滚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 回退到前一个版本</span></span><br><span class="line">kubectl rollout undo sts redis-sts -n sts-ns</span><br><span class="line"><span class="comment"># 回到指定版本，这里 --to-revision=1 表示回到版本1</span></span><br><span class="line">kubectl rollout undo sts redis-sts -n sts-nsx --to-revision=1</span><br></pre></td></tr></table></figure><h2 id="Deployment-和-StatefulSet-的对比总结">Deployment 和 StatefulSet 的对比总结</h2><table><thead><tr><th>特性</th><th><strong>Deployment</strong></th><th><strong>StatefulSet</strong></th></tr></thead><tbody><tr><td><strong>用途</strong></td><td>无状态应用（如 Web 服务、API 服务）</td><td>有状态应用（如数据库、缓存：Redis、MySQL、Kafka）</td></tr><tr><td><strong>Pod 名称</strong></td><td>Pod 名字随机生成，如 <code>nginx-abc123</code></td><td>Pod 名字有序，格式为 <code>name-0</code>、<code>name-1</code>、<code>name-2</code></td></tr><tr><td><strong>稳定的标识</strong></td><td><strong>不提供</strong>，每次重建 Pod 名字可能不同</td><td><strong>提供</strong>，每个 Pod 的名字、网络 ID、存储持久化不变</td></tr><tr><td><strong>存储卷</strong></td><td>通常配合 PVC，但 Pod 重建时挂载卷可能变化</td><td>配置 <code>volumeClaimTemplates</code>，每个 Pod 独立持久卷</td></tr><tr><td><strong>滚动更新策略</strong></td><td>支持 <code>maxSurge</code>、<code>maxUnavailable</code>，可并行更新 Pod</td><td>默认 <strong>逐个顺序更新</strong> Pod（可用 <code>partition</code> 控制分批更新）</td></tr><tr><td><strong>可用性</strong></td><td>通常设计为 <strong>无状态多副本高可用</strong>，不保证 Pod 启动顺序或固定 IP</td><td><strong>有状态且有序部署、删除、更新</strong>，通常单副本逐个维护可用性</td></tr><tr><td><strong>服务访问</strong></td><td>通过 ClusterIP、NodePort、LoadBalancer 访问</td><td>推荐用 <strong>Headless Service (clusterIP: None)</strong>，Pod 有固定 DNS</td></tr><tr><td><strong>典型应用场景</strong></td><td>Web 应用、REST API、无状态微服务</td><td>数据库（MySQL、PostgreSQL）、缓存（Redis）、队列（Kafka、RabbitMQ）</td></tr><tr><td><strong>Pod 伸缩特性</strong></td><td><strong>灵活伸缩</strong>，增加/减少副本无特定顺序</td><td><strong>有序伸缩</strong>，<code>name-0</code> -&gt; <code>name-1</code> -&gt; <code>name-2</code>…</td></tr><tr><td><strong>重建策略</strong></td><td>Pod 崩溃后重建的是新 Pod，无持久存储数据可能丢失</td><td>Pod 崩溃后重建的是相同 Pod 名字，挂载相同 PVC，不丢数据</td></tr></tbody></table><h2 id="后记">后记</h2><ul class="lvl-0"><li class="lvl-2"><p>StatefulSet 类似于 Deployment，同样支持扩缩容（scale 或者 hpa），但因为其是有状态的，所以需谨慎</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># scale</span></span><br><span class="line">kubectl scale sts redis-sts --replicas=5 -n sts-ns</span><br><span class="line"></span><br><span class="line"><span class="comment"># hpa，要求pod配置中有资源限制</span></span><br><span class="line">kubectl autoscale sts redis-sts --name=<span class="string">&quot;hpa-redis&quot;</span> --cpu-percent=50 --min=3 --max=10 -n sts-ns</span><br></pre></td></tr></table></figure><table><thead><tr><th>操作</th><th><strong>可行性</strong></th><th><strong>推荐情况</strong></th></tr></thead><tbody><tr><td><strong>扩容（增加副本数）</strong></td><td>✅ <strong>推荐</strong></td><td>安全，新增 Pod 按序从 N-1 开始创建（<code>sts-name-0</code> -&gt; <code>sts-name-1</code> -&gt; <code>sts-name-2</code>）</td></tr><tr><td><strong>缩容（减少副本数）</strong></td><td>⚠️ <strong>小心使用</strong></td><td>可能导致 Pod 及其关联 PVC 被废弃，<strong>数据可能丢失</strong></td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

引用本地其它文章连接{}
 大括号开始% post_link 文件名称(不包含.md) %大括号结束
 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍 K8S 的 Statefulset ，本文以 CentOS 8 为例。&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/&quot;&gt;K8S官网&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/kubernetes/kubernetes&quot;&gt;k8s Github&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/statefulset/&quot;&gt;k8s Statefulset 介绍&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="k8s" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/k8s/"/>
    
    
    <category term="K8S" scheme="https://blog.hanqunfeng.com/tags/K8S/"/>
    
  </entry>
  
  <entry>
    <title>K8S 之 Horizontal Pod Autoscaler（HPA）</title>
    <link href="https://blog.hanqunfeng.com/2025/07/20/k8s-hpa/"/>
    <id>https://blog.hanqunfeng.com/2025/07/20/k8s-hpa/</id>
    <published>2025-07-20T13:30:05.000Z</published>
    <updated>2025-07-20T15:18:40.692Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote %引用本地其它文章连接{} 大括号开始% post_link 文件名称(不包含.md) %大括号结束 --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍 K8S 中的 Horizontal Pod Autoscaler（HPA），本文以 CentOS 8 为例。</p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/">K8S官网</a></p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/autoscaling/">Autoscaling k8s简介</a></p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/docs/tasks/run-application/horizontal-pod-autoscale/">Horizontal Pod Autoscaler（HPA）</a></p></li></ul><span id="more"></span><h2 id="Horizontal-Pod-Autoscaler（HPA）-简介">Horizontal Pod Autoscaler（HPA） 简介</h2><ul class="lvl-0"><li class="lvl-2"><p>Horizontal Pod Autoscaler（缩写为 hpa）基于资源 CPU 利用率自动调整 deployment、replication controller 或者 replica 中 pod 的数量，这有助于您的应用程序进行扩展以满足增长的需求，或在不需要资源时进行缩减，从而释放出节点用于其他应用程序。当您设置目标 CPU 利用率百分比时，HPA 扩展或缩减应用程序来尝试满足该目标。</p></li><li class="lvl-2"><p>Kubernetes 本身已经包含了 HPA 的 controller，所以不需要额外的安装或部署。</p></li><li class="lvl-2"><p>HPA 需要获取 metrics 信息，metrics 信息需要从 Metrics Server 中获取，所以需要先安装 Metrics Server。</p></li><li class="lvl-2"><p>HPA 会周期性(默认15秒)查询目标资源的使用情况，然后和 HPA 中定义的值做比较，并根据比较结果相应的调整 pod 数量。</p></li><li class="lvl-2"><p>创建pod时，必须为其设定cpu资源，用于与目标值进行比较，目前最新的v2版本的HPA除了支持CPU的对比，还可以设定其它指标，具体参考<a href="https://kubernetes.io/zh-cn/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/">HorizontalPodAutoscaler 演练</a>中的“基于多项度量指标和自定义度量指标自动扩缩”。</p></li><li class="lvl-2"><p>博主之前写过一篇在aws的eks中使用hpa的文章 <a href="/2023/07/17/aws-eks17-hpa/" title="AWS-EKS-17--Horizontal Pod Autoscaler（HPA）">AWS-EKS-17--Horizontal Pod Autoscaler（HPA）</a>，和在自己搭建 k8s集群 中使用 hpa 基本一致，所以本文不再对重复内容进行赘述，建议读者先阅读 <a href="/2023/07/17/aws-eks17-hpa/" title="AWS-EKS-17--Horizontal Pod Autoscaler（HPA）">AWS-EKS-17--Horizontal Pod Autoscaler（HPA）</a>。</p></li></ul><h2 id="安装-Metrics-Server">安装 Metrics Server</h2><ul class="lvl-0"><li class="lvl-2"><p>Kubernetes 的 HPA 是依赖 Metrics API 的，默认并不内置。需要通过 metrics-server 来收集和提供节点/Pod 的资源用量数据（CPU、内存等）。</p></li><li class="lvl-2"><p>安装 <a href="https://github.com/kubernetes-sigs/metrics-server">metrics-server</a></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ curl -L -o metrics-server.yaml https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</span><br><span class="line">$ kubectl apply -f metrics-server.yaml</span><br><span class="line">serviceaccount/metrics-server created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:metrics-server created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created</span><br><span class="line">service/metrics-server created</span><br><span class="line">deployment.apps/metrics-server created</span><br><span class="line">apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>部署后发现pod没有运行成功</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$  k get all -n kube-system -l k8s-app=metrics-server</span><br><span class="line">NAME                                  READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/metrics-server-867d48dc9c-fgdjq   0/1     Running   0          16s</span><br><span class="line"></span><br><span class="line">NAME                     TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/metrics-server   ClusterIP   10.96.91.221   &lt;none&gt;        443/TCP   16s</span><br><span class="line"></span><br><span class="line">NAME                             READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/metrics-server   0/1     1            0           16s</span><br><span class="line"></span><br><span class="line">NAME                                        DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/metrics-server-867d48dc9c   1         1         0       16s</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>检查日志</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ k logs deployment.apps/metrics-server -n kube-system</span><br><span class="line"><span class="comment">## 输出类似于</span></span><br><span class="line">E0703 23:02:38.120831       1 scraper.go:149] <span class="string">&quot;Failed to scrape node&quot;</span> err=<span class="string">&quot;Get \&quot;https://10.211.55.15:10250/metrics/resource\&quot;: tls: failed to verify certificate: x509: cannot validate certificate for 10.211.55.15 because it doesn&#x27;t contain any IP SANs&quot;</span> node=<span class="string">&quot;k8s-worker1&quot;</span></span><br><span class="line">E0703 23:02:38.127774       1 scraper.go:149] <span class="string">&quot;Failed to scrape node&quot;</span> err=<span class="string">&quot;Get \&quot;https://10.211.55.16:10250/metrics/resource\&quot;: tls: failed to verify certificate: x509: cannot validate certificate for 10.211.55.16 because it doesn&#x27;t contain any IP SANs&quot;</span> node=<span class="string">&quot;k8s-worker2&quot;</span></span><br><span class="line">E0703 23:02:38.140583       1 scraper.go:149] <span class="string">&quot;Failed to scrape node&quot;</span> err=<span class="string">&quot;Get \&quot;https://10.211.55.11:10250/metrics/resource\&quot;: tls: failed to verify certificate: x509: cannot validate certificate for 10.211.55.11 because it doesn&#x27;t contain any IP SANs&quot;</span> node=<span class="string">&quot;k8s-master&quot;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>意思是 metrics-server 在通过 https://<node-ip>:10250 请求 kubelet 的时候，发现 kubelet 的证书不包含该 IP 的 Subject Alternative Name (SAN)，因此 TLS 校验失败。</p></li><li class="lvl-2"><p>解决方案: 添加 --kubelet-insecure-tls 参数，跳过 kubelet 的 TLS 证书校验(metrics-server 本身权限有限，风险可控，kubelet 自签证书维护成本高)</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit deployment metrics-server -n kube-system</span><br><span class="line"><span class="comment">## 在 args 中添加 --kubelet-insecure-tls</span></span><br><span class="line">  spec:</span><br><span class="line">    containers:</span><br><span class="line">    - args:</span><br><span class="line">      - --cert-dir=/tmp</span><br><span class="line">      - --secure-port=10250</span><br><span class="line">      - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span><br><span class="line">      - --kubelet-use-node-status-port</span><br><span class="line">      - --metric-resolution=15s</span><br><span class="line">      - --kubelet-insecure-tls   <span class="comment"># 添加此行</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>wq</code>保存后，等一会再次查看所有资源均已正常</p></li><li class="lvl-2"><p>查看所有 node 的资源</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ k top nodes</span><br><span class="line">NAME          CPU(cores)   CPU(%)   MEMORY(bytes)   MEMORY(%)</span><br><span class="line">k8s-master    216m         10%      1712Mi          44%</span><br><span class="line">k8s-worker1   79m          3%       1025Mi          26%</span><br><span class="line">k8s-worker2   82m          4%       982Mi           25%</span><br></pre></td></tr></table></figure><table><thead><tr><th>字段</th><th>说明</th></tr></thead><tbody><tr><td><strong>NAME</strong></td><td>节点名称，Kubernetes 集群的节点名字。</td></tr><tr><td><strong>CPU(cores)</strong></td><td>当前节点 CPU 的瞬时使用量，单位是核心数（Core），比如 <code>216m</code> = 0.216 核心。<code>m</code> = <strong>millicores</strong>，1000m = 1核。</td></tr><tr><td><strong>CPU(%)</strong></td><td>当前 CPU 使用率，相对于该节点 CPU 总核数的百分比。比如 <code>10%</code> 表示节点 CPU 的 10% 被使用。</td></tr><tr><td><strong>MEMORY(bytes)</strong></td><td>节点当前使用的内存，单位是字节（例如 <code>1712Mi</code> = 1712 Mebibytes ≈ 1.7 GB）。</td></tr><tr><td><strong>MEMORY(%)</strong></td><td>节点内存使用率，占总内存的百分比。比如 <code>44%</code> 表示该节点内存使用了 44%。</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>查看所有 pod 的资源</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ k top pods -A</span><br><span class="line">NAMESPACE     NAME                                       CPU(cores)   MEMORY(bytes)</span><br><span class="line">default       nginx-5869d7778c-5682r                     0m           9Mi</span><br><span class="line">default       nginx-5869d7778c-thw8f                     0m           4Mi</span><br><span class="line">kube-system   calico-kube-controllers-7bfdc5b57c-q5xwp   6m           35Mi</span><br><span class="line">kube-system   calico-node-7pbbq                          42m          281Mi</span><br><span class="line">kube-system   calico-node-v4hzr                          47m          260Mi</span><br><span class="line">kube-system   calico-node-w47qq                          40m          263Mi</span><br><span class="line">kube-system   coredns-674b8bbfcf-2tvld                   2m           23Mi</span><br><span class="line">kube-system   coredns-674b8bbfcf-h6kx7                   2m           22Mi</span><br><span class="line">kube-system   etcd-k8s-master                            27m          85Mi</span><br><span class="line">kube-system   kube-apiserver-k8s-master                  49m          404Mi</span><br><span class="line">kube-system   kube-controller-manager-k8s-master         28m          100Mi</span><br><span class="line">kube-system   kube-proxy-nkbns                           1m           41Mi</span><br><span class="line">kube-system   kube-proxy-plqw8                           1m           25Mi</span><br><span class="line">kube-system   kube-proxy-sbgh6                           1m           34Mi</span><br><span class="line">kube-system   kube-scheduler-k8s-master                  8m           38Mi</span><br><span class="line">kube-system   metrics-server-56fb9549f4-rtt7n            4m           21Mi</span><br></pre></td></tr></table></figure><h2 id="创建-HPA">创建 HPA</h2><ul class="lvl-0"><li class="lvl-2"><p>前面的文章中多次使用 nginx 镜像创建了 deployment，但是都没有配置过资源，为了测试 hpa，需要为其指定资源</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 直接修改 deployment，改变 spec.template，Pod 会被重建。保存后立刻生效</span></span><br><span class="line">kubectl edit deployment nginx</span><br><span class="line"><span class="comment"># 增加资源限制</span></span><br><span class="line">spec:</span><br><span class="line">  replicas: 1   <span class="comment"># 修改副本数位 1，仅改变 replicas，Pod 不会被重建</span></span><br><span class="line">  template:     <span class="comment"># 修改 template，Pod 会被重建</span></span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 500m</span><br><span class="line">            memory: 500Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 200m</span><br><span class="line">            memory: 200Mi</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>命令行创建 HPA</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建了一个叫“hpa-nginx”的 HPA，默认与 deployment 的名称相同，可以用 --name=&#x27;hpa-nginx&#x27; 指定hpa的名称</span></span><br><span class="line"><span class="comment"># replicas 变动范围是最小 3，最大 10</span></span><br><span class="line"><span class="comment"># 目标cpu利用率为 50%，上面我们设定 CPU request 值为 100m，所以当平均cpu值为 100m 时就会触发 autoscale</span></span><br><span class="line"><span class="comment"># 这里说平均cpu，是指所有pod的cpu利用率的平均值</span></span><br><span class="line">$ k autoscale deployment nginx --name=<span class="string">&quot;hpa-nginx&quot;</span> --cpu-percent=50 --min=3 --max=10</span><br><span class="line">horizontalpodautoscaler.autoscaling/hpa-nginx autoscaled</span><br><span class="line"><span class="comment"># 观察，大约 15秒后，hpa-nginx 发现 replicas 值为1，30秒的时候自动扩容到3个，因为我们设置的hpa的replicas最小值为3，并且采集到了cpu使用率</span></span><br><span class="line">$ k get hpa -w</span><br><span class="line">NAME        REFERENCE          TARGETS              MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">hpa-nginx   Deployment/nginx   cpu: &lt;unknown&gt;/50%   3         10        0          0s</span><br><span class="line">hpa-nginx   Deployment/nginx   cpu: &lt;unknown&gt;/50%   3         10        1          15s</span><br><span class="line">hpa-nginx   Deployment/nginx   cpu: 0%/50%          3         10        3          30s</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ymal文件创建 HPA</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2</span>    <span class="comment"># api版本，这里设置为 v2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span> <span class="comment"># 资源类型</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hpa-nginx</span>             <span class="comment"># hpa资源名称</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span>          <span class="comment"># 命名空间</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">10</span>             <span class="comment"># 最大副本数</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">1</span>              <span class="comment"># 最小副本数</span></span><br><span class="line">  <span class="attr">metrics:</span>                    <span class="comment"># 指标设定</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span>            <span class="comment"># 资源类型，可以配置为 Resource/Object/Pods</span></span><br><span class="line">    <span class="attr">resource:</span>                 <span class="comment"># 资源对象</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cpu</span>               <span class="comment"># 资源名称 cpu/memory</span></span><br><span class="line">      <span class="attr">target:</span>                 <span class="comment"># 目标对象</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">Utilization</span>     <span class="comment"># 目标类型，可以配置为 Utilization/AverageValue/Value</span></span><br><span class="line">        <span class="attr">averageUtilization:</span> <span class="number">50</span> <span class="comment"># 目标值，这里是平均使用率的百分比</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span>             <span class="comment"># 指定要自动伸缩的资源对象</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span>          <span class="comment"># 资源类型为 Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span>               <span class="comment"># 资源名称为 nginx</span></span><br></pre></td></tr></table></figure><h2 id="HPA-支持的监控指标类型">HPA 支持的监控指标类型</h2><table><thead><tr><th>类型</th><th>字段名</th><th>说明</th><th>常见用途</th></tr></thead><tbody><tr><td><strong>Resource</strong></td><td><code>resource</code></td><td>基于 Pod 资源使用情况（CPU、内存），最常用</td><td>按 CPU 利用率自动扩缩容</td></tr><tr><td><strong>Pods</strong></td><td><code>pods</code></td><td>基于每个 Pod 的自定义度量指标的平均值，需要第三方监控系统提供，比如 Prometheus</td><td>按业务指标（如请求数、队列长度）扩缩容</td></tr><tr><td><strong>Object</strong></td><td><code>object</code></td><td>基于单个 Kubernetes 对象（如 Service、Ingress）的指标，，比如 Prometheus</td><td>按某个对象的指标扩缩容，例如队列长度</td></tr></tbody></table><h3 id="Resource-资源指标（CPU-内存）">Resource 资源指标（CPU/内存）</h3><ul class="lvl-0"><li class="lvl-2"><p>Utilization: 利用率百分比</p></li><li class="lvl-2"><p>Utilization 不关心 limits，只看 requests。</p></li><li class="lvl-2"><p>如果 resources.requests 没有设置，HPA Utilization 会报错（除非 AverageValue）。</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">metrics:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">  <span class="attr">resource:</span>                   <span class="comment"># 资源 指标</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cpu</span>                 <span class="comment"># cpu</span></span><br><span class="line">    <span class="attr">target:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Utilization</span>       <span class="comment"># 利用率百分比</span></span><br><span class="line">      <span class="attr">averageUtilization:</span> <span class="number">50</span>  <span class="comment"># 50%</span></span><br></pre></td></tr></table></figure><blockquote><p>当前有 3 个 Pod：</p></blockquote><table><thead><tr><th>Pod</th><th>CPU 实际使用</th><th>CPU requests</th></tr></thead><tbody><tr><td>pod-1</td><td>150m</td><td>200m</td></tr><tr><td>pod-2</td><td>100m</td><td>200m</td></tr><tr><td>pod-3</td><td>50m</td><td>200m</td></tr><tr><td>合计</td><td>400m</td><td>600m</td></tr><tr><td><strong>平均</strong></td><td><strong>400m ÷ 600m × 100% ≈ 66.7%</strong></td><td></td></tr></tbody></table><blockquote><p>由于 66.7% &gt; 50%，会扩容；如果小于 50%，HPA 会缩容。</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>AverageValue: 指定资源使用平均值</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">metrics:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">  <span class="attr">resource:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">memory</span>                <span class="comment"># 监控资源类型为 memory（内存）</span></span><br><span class="line">    <span class="attr">target:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">AverageValue</span>        <span class="comment"># 指标类型为 AverageValue，表示每个 Pod 平均使用多少</span></span><br><span class="line">      <span class="attr">averageValue:</span> <span class="string">400Mi</span>       <span class="comment"># 目标值：平均每个 Pod 使用 400Mi 内存</span></span><br></pre></td></tr></table></figure><blockquote><p>假设当前部署了 3 个副本，内存使用情况如下：</p></blockquote><table><thead><tr><th>Pod</th><th>当前内存使用</th></tr></thead><tbody><tr><td>pod-1</td><td>450Mi</td></tr><tr><td>pod-2</td><td>400Mi</td></tr><tr><td>pod-3</td><td>300Mi</td></tr><tr><td><strong>平均</strong></td><td><strong>(450+400+300)/3 = 383.3Mi</strong></td></tr></tbody></table><blockquote><p>因为 383.3Mi &lt; 400Mi，不触发扩容。如果将来平均使用超过 400Mi，HPA 就会扩容，反之缩容。</p></blockquote><h2 id="HPA-扩缩容速度配置">HPA 扩缩容速度配置</h2><ul class="lvl-0"><li class="lvl-2"><p>HPA 的扩缩容速度是可以控制的，通过 behavior 字段来自定义扩缩容的速度和策略。</p></li><li class="lvl-2"><p>以下是默认策略</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">behavior:</span></span><br><span class="line">  <span class="attr">scaleUp:</span>                                  <span class="comment"># ⬆️ 扩容策略</span></span><br><span class="line">    <span class="attr">tolerance:</span> <span class="number">0.1</span>                          <span class="comment"># 容忍阈值，默认0.1(10%)，表示每次扩容时，pod使用率超过1.1倍目标值时才会进行扩容</span></span><br><span class="line">    <span class="attr">stabilizationWindowSeconds:</span> <span class="number">0</span>           <span class="comment"># 默认0，即增加或减少pod数量后保持不变的时间，单位为秒</span></span><br><span class="line">    <span class="attr">policies:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Percent</span>                         <span class="comment"># 扩容速度按百分比限制</span></span><br><span class="line">      <span class="attr">value:</span> <span class="number">100</span>                            <span class="comment"># 每 15 秒最多扩容 100% 的副本数</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">15</span>                     <span class="comment"># 每 15 秒计算一次是否可以扩容，默认 15 秒</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Pods</span>                            <span class="comment"># 按固定 Pod 数量限制扩容速度</span></span><br><span class="line">      <span class="attr">value:</span> <span class="number">4</span>                              <span class="comment"># 每 15 秒最多扩容 4 个 Pod</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">15</span>                     <span class="comment"># 同样 15 秒计算一次，默认 15 秒</span></span><br><span class="line">    <span class="attr">selectPolicy:</span> <span class="string">Max</span>                       <span class="comment"># 多个 policy 同时存在时，取 Percent 和 Pods 的最大值。Min 取最小值</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">scaleDown:</span>                                <span class="comment"># ⬇️ 缩容策略</span></span><br><span class="line">    <span class="comment"># selectPolicy: Disabled                  # 禁用缩容</span></span><br><span class="line">    <span class="attr">stabilizationWindowSeconds:</span> <span class="number">300</span>         <span class="comment"># 默认 300，即增加或减少pod数量后保持不变的时间，单位为秒，防止快速缩容（平滑策略）</span></span><br><span class="line">    <span class="attr">policies:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Percent</span>                         <span class="comment"># 缩容速度按百分比限制</span></span><br><span class="line">      <span class="attr">value:</span> <span class="number">100</span>                            <span class="comment"># 每 15 秒最多缩容 100% 的副本数</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">15</span>                     <span class="comment"># 每 15 秒评估一次是否可以缩容</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>完整的 HPA 配置文件示例(一般情况下，我们无需修改扩缩容速度的配置，默认策略满足大部分场景)</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2</span>                    <span class="comment"># api版本，使用 v2 版本支持 behavior 扩缩容策略</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span>                 <span class="comment"># 资源类型为 HPA</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hpa-nginx</span>                             <span class="comment"># HPA 资源的名称</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span>                          <span class="comment"># 命名空间，设置为 default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">10</span>                             <span class="comment"># HPA 自动扩容的最大副本数</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">1</span>                              <span class="comment"># HPA 自动缩容的最小副本数</span></span><br><span class="line">  <span class="attr">metrics:</span>                                    <span class="comment"># 自动伸缩的指标配置</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span>                            <span class="comment"># 指标类型为 Resource（资源型）</span></span><br><span class="line">    <span class="attr">resource:</span>                                 <span class="comment"># 资源指标对象</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cpu</span>                               <span class="comment"># 资源名称为 cpu，也可以设置为 memory</span></span><br><span class="line">      <span class="attr">target:</span>                                 <span class="comment"># 目标指标对象</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">Utilization</span>                     <span class="comment"># 指标类型为 Utilization（利用率百分比）</span></span><br><span class="line">        <span class="attr">averageUtilization:</span> <span class="number">50</span>                <span class="comment"># CPU 平均使用率达到 50% 时进行扩缩容</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span>                             <span class="comment"># HPA 绑定的目标资源对象</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span>                          <span class="comment"># 目标类型为 Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span>                               <span class="comment"># 目标 Deployment 名称为 nginx</span></span><br><span class="line">  <span class="attr">behavior:</span>                                   <span class="comment"># ⬇️ 扩缩容行为控制</span></span><br><span class="line">    <span class="attr">scaleUp:</span>                                  <span class="comment"># 扩容策略</span></span><br><span class="line">      <span class="attr">stabilizationWindowSeconds:</span> <span class="number">30</span>          <span class="comment"># 扩容平滑窗口为 30 秒，防止短时间抖动频繁扩容</span></span><br><span class="line">      <span class="attr">policies:</span>                               <span class="comment"># 扩容速度限制策略</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Percent</span>                         <span class="comment"># 按百分比计算</span></span><br><span class="line">        <span class="attr">value:</span> <span class="number">100</span>                            <span class="comment"># 每 15 秒内最多扩容 100%</span></span><br><span class="line">        <span class="attr">periodSeconds:</span> <span class="number">15</span>                     <span class="comment"># 每 15 秒评估一次扩容速率</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Pods</span>                            <span class="comment"># 按固定 Pod 数量计算</span></span><br><span class="line">        <span class="attr">value:</span> <span class="number">4</span>                              <span class="comment"># 每 15 秒最多扩容 4 个 Pod</span></span><br><span class="line">        <span class="attr">periodSeconds:</span> <span class="number">15</span>                     <span class="comment"># 每 15 秒评估一次扩容速率</span></span><br><span class="line">      <span class="attr">selectPolicy:</span> <span class="string">Max</span>                       <span class="comment"># 如果多个 policy 同时满足，取最大值（更激进的扩容）</span></span><br><span class="line">    <span class="attr">scaleDown:</span>                                <span class="comment"># 缩容策略</span></span><br><span class="line">      <span class="attr">stabilizationWindowSeconds:</span> <span class="number">300</span>         <span class="comment"># 缩容平滑窗口为 300 秒（5 分钟），避免短时流量降低快速缩容</span></span><br><span class="line">      <span class="attr">policies:</span>                               <span class="comment"># 缩容速度限制策略</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Percent</span>                         <span class="comment"># 按百分比缩容</span></span><br><span class="line">        <span class="attr">value:</span> <span class="number">30</span>                             <span class="comment"># 每 60 秒最多缩容 30%</span></span><br><span class="line">        <span class="attr">periodSeconds:</span> <span class="number">60</span>                     <span class="comment"># 每 60 秒评估一次缩容速率</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

引用本地其它文章连接{}
 大括号开始% post_link 文件名称(不包含.md) %大括号结束
 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍 K8S 中的 Horizontal Pod Autoscaler（HPA），本文以 CentOS 8 为例。&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/&quot;&gt;K8S官网&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/concepts/workloads/autoscaling/&quot;&gt;Autoscaling k8s简介&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/tasks/run-application/horizontal-pod-autoscale/&quot;&gt;Horizontal Pod Autoscaler（HPA）&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="k8s" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/k8s/"/>
    
    
    <category term="K8S" scheme="https://blog.hanqunfeng.com/tags/K8S/"/>
    
  </entry>
  
  <entry>
    <title>K8S 之 Ingress Nginx</title>
    <link href="https://blog.hanqunfeng.com/2025/07/19/k8s-ingress-nginx/"/>
    <id>https://blog.hanqunfeng.com/2025/07/19/k8s-ingress-nginx/</id>
    <published>2025-07-19T13:30:05.000Z</published>
    <updated>2025-07-20T13:48:31.217Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote %引用本地其它文章连接{} 大括号开始% post_link 文件名称(不包含.md) %大括号结束 --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍 K8S 安装及使用 Ingress Nginx，本文以 CentOS 8 为例。</p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/">K8S官网</a></p></li><li class="lvl-2"><p><a href="https://kubernetes.github.io/ingress-nginx/">ingress-nginx 官网</a></p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/">ingress-nginx k8s简介</a></p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers/">k8s支持的 ingress controller</a></p></li></ul><span id="more"></span><h2 id="Ingress-简介">Ingress 简介</h2><ul class="lvl-0"><li class="lvl-2"><p>Ingress(缩写为 ing) 提供从集群外部到集群内服务的 HTTP 和 HTTPS 路由(7层)。 流量路由由 Ingress 资源所定义的规则来控制。</p></li><li class="lvl-2"><p>实际上 Ingress-Nginx 内置了 nginx，由 nginx 其负责接收请求并转发给后端服务。</p></li><li class="lvl-2"><p>下面是 Ingress 的一个简单示例，可将所有流量都发送到同一 Service<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/jVrIUP.png" alt=""></p></li></ul><h2 id="安装-Ingress-Nginx">安装 Ingress-Nginx</h2><ul class="lvl-0"><li class="lvl-2"><p>安装时要注意 ingress-nginx 的版本和 Kubernetes 的版本兼容性，参考 Github:<a href="https://github.com/kubernetes/ingress-nginx">ingress-nginx</a>。</p></li><li class="lvl-2"><p>获取对应版本的yaml文件</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载最新的 v1.13.0 版本，其支持 Kubernetes 1.33 版本</span></span><br><span class="line"><span class="built_in">export</span> INGRESS_NGINX_VERSION=v1.13.0</span><br><span class="line">curl -L -o ingress-nginx-controller.yaml https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-<span class="variable">$&#123;INGRESS_NGINX_VERSION&#125;</span>/deploy/static/provider/cloud/deploy.yaml</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>安装 ingress-nginx</p></li></ul><blockquote><p>这里要注意，ingress-nginx 的 <code>service/ingress-nginx-controller</code> 默认使用 LoadBalancer 类型，所以需要先使 k8s 集群支持 LoadBalancer 类型，可以参考 <a href="/2025/07/18/k8s-service/" title="K8S 之 Service">K8S 之 Service</a> 中 LoadBalancer 部分。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f ingress-nginx-controller.yaml</span><br><span class="line">namespace/ingress-nginx created</span><br><span class="line">serviceaccount/ingress-nginx created</span><br><span class="line">serviceaccount/ingress-nginx-admission created</span><br><span class="line">role.rbac.authorization.k8s.io/ingress-nginx created</span><br><span class="line">role.rbac.authorization.k8s.io/ingress-nginx-admission created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/ingress-nginx created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/ingress-nginx-admission created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/ingress-nginx created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created</span><br><span class="line">configmap/ingress-nginx-controller created</span><br><span class="line">service/ingress-nginx-controller created</span><br><span class="line">service/ingress-nginx-controller-admission created</span><br><span class="line">deployment.apps/ingress-nginx-controller created</span><br><span class="line">job.batch/ingress-nginx-admission-create created</span><br><span class="line">job.batch/ingress-nginx-admission-patch created</span><br><span class="line">ingressclass.networking.k8s.io/nginx created</span><br><span class="line">validatingwebhookconfiguration.admissionregistration.k8s.io/ingress-nginx-admission created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看ingress-nginx资源</span></span><br><span class="line">$ k get all -n ingress-nginx</span><br><span class="line">NAME                                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/ingress-nginx-controller-95f6586c6-nznwq   1/1     Running   0          2m46s</span><br><span class="line"></span><br><span class="line">NAME                                         TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)                      AGE</span><br><span class="line">service/ingress-nginx-controller             LoadBalancer   10.96.112.234   10.211.55.201   80:30168/TCP,443:30600/TCP   2m46s</span><br><span class="line">service/ingress-nginx-controller-admission   ClusterIP      10.96.245.155   &lt;none&gt;          443/TCP                      2m46s</span><br><span class="line"></span><br><span class="line">NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/ingress-nginx-controller   1/1     1            1           2m46s</span><br><span class="line"></span><br><span class="line">NAME                                                 DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/ingress-nginx-controller-95f6586c6   1         1         1       2m46s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 IngressClass 资源</span></span><br><span class="line">$ k get ingressclasses.networking.k8s.io</span><br><span class="line">NAME    CONTROLLER             PARAMETERS   AGE</span><br><span class="line">nginx   k8s.io/ingress-nginx   &lt;none&gt;       14m</span><br></pre></td></tr></table></figure><h2 id="创建-Ingress-资源">创建 Ingress 资源</h2><ul class="lvl-0"><li class="lvl-2"><p>ingress-demo.yaml</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span>                   <span class="comment"># Ingress 资源</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web-ingress</span>             <span class="comment"># Ingress 名称</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span>            <span class="comment"># Ingress 所在的命名空间</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span>       <span class="comment"># Ingress 使用的 IngressClass</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">nginx.hanqunfeng.com</span>  <span class="comment"># 转发域名，支持通配符 *.hanqunfeng.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">pathType:</span> <span class="string">Prefix</span>        <span class="comment"># 路径匹配规则, 前缀匹配</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/</span>                 <span class="comment"># 路径</span></span><br><span class="line">        <span class="attr">backend:</span>                <span class="comment"># 后端服务</span></span><br><span class="line">          <span class="attr">service:</span>              <span class="comment"># 声明后端是一个 service</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">nginx</span>         <span class="comment"># service名称，提前创建好 service，类型可以是ClusterIP、NodePort、LoadBalancer任意，推荐ClusterIP，因为使用 ingress 的话，就没必要创建其它类型的 service 了</span></span><br><span class="line">            <span class="attr">port:</span>               <span class="comment"># 端口</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span>        <span class="comment"># service的端口</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>查看 ingress 资源</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ k get ing -n ns1</span><br><span class="line">NAME          CLASS   HOSTS                  ADDRESS         PORTS   AGE</span><br><span class="line">web-ingress   nginx   nginx.hanqunfeng.com   10.211.55.201   80      80s</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>访问 web-ingress</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将域名 nginx.hanqunfeng.com 解析到 10.211.55.201，如果是内部域名可以通过 hosts 文件添加解析</span></span><br><span class="line"><span class="comment"># 只能通过 nginx.hanqunfeng.com 访问，不能通过 10.211.55.201 访问</span></span><br><span class="line">curl http://nginx.hanqunfeng.com</span><br></pre></td></tr></table></figure><h2 id="让-Ingress-支持-HTTPS-访问">让 Ingress 支持 HTTPS 访问</h2><ul class="lvl-0"><li class="lvl-2"><p>创建证书，可以在阿里云上申请一个免费的证书</p></li><li class="lvl-2"><p>创建 secret</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret tls nginx-tls \</span><br><span class="line">    --key=nginx.hanqunfeng.com.key \</span><br><span class="line">    --cert=nginx.hanqunfeng.com.pem \</span><br><span class="line">    -n default</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>也可以通过yaml创建</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-tls</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">tls.crt:</span> <span class="string">base64</span> <span class="string">编码的证书，而非文件路径</span></span><br><span class="line">  <span class="attr">tls.key:</span> <span class="string">base64</span> <span class="string">编码的私钥，而非文件路径</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">kubernetes.io/tls</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>你的 Ingress 资源需要增加 tls 字段，引用一个 Secret 存储的 TLS 证书。</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span>                   <span class="comment"># Ingress 资源</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web-ingress</span>             <span class="comment"># Ingress 名称</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span>            <span class="comment"># Ingress 所在的命名空间</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span>       <span class="comment"># Ingress 使用的 IngressClass</span></span><br><span class="line">  <span class="attr">tls:</span>                          <span class="comment"># 配置 TLS</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span>                      <span class="comment"># 域名列表</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nginx.hanqunfeng.com</span>      <span class="comment"># 域名</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">nginx-tls</span>       <span class="comment"># 存放证书的 Secret</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">nginx.hanqunfeng.com</span>  <span class="comment">#转发域名</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">pathType:</span> <span class="string">Prefix</span>        <span class="comment"># 路径匹配规则, 前缀匹配</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/</span>                 <span class="comment"># 路径</span></span><br><span class="line">        <span class="attr">backend:</span>                <span class="comment"># 后端服务</span></span><br><span class="line">          <span class="attr">service:</span>              <span class="comment"># service</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">nginx</span>         <span class="comment"># service名称</span></span><br><span class="line">            <span class="attr">port:</span>               <span class="comment"># 端口</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span>        <span class="comment"># service的端口</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重新运行ingress</span></span><br><span class="line">k apply -f nginx-ingress.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看ingress，此时多了一个 443 端口</span></span><br><span class="line">$ k get ing</span><br><span class="line">NAME          CLASS   HOSTS                  ADDRESS         PORTS     AGE</span><br><span class="line">web-ingress   nginx   nginx.hanqunfeng.com   10.211.55.201   80, 443   51s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问https，但此时 80 端口访问不了，需要配置 80 端口重定向到 443</span></span><br><span class="line">curl https://nginx.hanqunfeng.com</span><br></pre></td></tr></table></figure><h2 id="80端口重定向到443">80端口重定向到443</h2><ul class="lvl-0"><li class="lvl-2"><p><code>nginx ingress controller</code>，它内置支持重定向，你可以在 Ingress 上添加 annotation</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/force-ssl-redirect:</span> <span class="string">&quot;true&quot;</span>  <span class="comment"># 80 重定向到 443</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>完整的yaml</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/force-ssl-redirect:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nginx.hanqunfeng.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">nginx-tls</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">nginx.hanqunfeng.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>访问测试</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重新运行ingress</span></span><br><span class="line">k apply -f nginx-ingress.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认情况下 curl 不会自动跳转，使用浏览器访问会自动重定向，308 表示永久重定向</span></span><br><span class="line">$ curl http://nginx.hanqunfeng.com</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;&lt;title&gt;308 Permanent Redirect&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;308 Permanent Redirect&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加 -L 参数，curl 会自动跳转</span></span><br><span class="line">$ curl -L http://nginx.hanqunfeng.com</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">html &#123; color-scheme: light dark; &#125;</span><br><span class="line">body &#123; width: 35em; margin: 0 auto;</span><br><span class="line">font-family: Tahoma, Verdana, Arial, sans-serif; &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.org/&quot;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">&quot;http://nginx.com/&quot;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><h2 id="后记">后记</h2><h3 id="ssl-证书过期怎么办？">ssl 证书过期怎么办？</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># apply 会直接更新 Secret，而不是删除重建</span></span><br><span class="line">kubectl create secret tls nginx-tls \</span><br><span class="line">    --key=新的.key \</span><br><span class="line">    --cert=新的.pem \</span><br><span class="line">    -n default --dry-run=client -o yaml | kubectl apply -f -</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>Ingress Controller（如 nginx-ingress）通常会自动监听 Secret 变化，大概 30 秒 ~ 1 分钟内自动热加载新证书，无需重启 Pod。</p></li></ul><h3 id="pathType-可以设置哪些值？">pathType 可以设置哪些值？</h3><ul class="lvl-0"><li class="lvl-2"><p>在 Kubernetes Ingress 的 pathType 字段中，一共可以设置以下三种值</p></li></ul><table><thead><tr><th><strong>pathType 值</strong></th><th><strong>含义</strong></th><th><strong>匹配规则说明</strong></th></tr></thead><tbody><tr><td><strong>Exact</strong></td><td>精确匹配</td><td>路径必须<strong>完全匹配</strong></td></tr><tr><td><strong>Prefix</strong></td><td>前缀匹配</td><td>以指定路径为<strong>前缀</strong>即可匹配</td></tr><tr><td><strong>ImplementationSpecific</strong></td><td>由 Ingress Controller 自己决定</td><td>nginx 常常表现为前缀匹配</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>Exact 精确匹配，且区分大小写</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只匹配 http://example.com/foo</span></span><br><span class="line"><span class="comment"># 不会匹配 /foo/abc 或 /foo/</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">pathType:</span> <span class="string">Exact</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/foo</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>Prefix 前缀匹配，且区分大小写</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 匹配所有以 /foo 开头的路径：</span></span><br><span class="line"><span class="comment">#   /foo</span></span><br><span class="line"><span class="comment">#   /foo/   # 会忽略尾部的 /</span></span><br><span class="line"><span class="comment">#   /foo/abc</span></span><br><span class="line"><span class="comment">#   /foo/bar/test</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/foo</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ImplementationSpecific 控制器自定义（不推荐）</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 匹配规则由 Ingress Controller 决定；</span></span><br><span class="line"><span class="comment"># 在 nginx-ingress 中通常行为类似于 Prefix，但不保证兼容性；</span></span><br><span class="line"><span class="comment"># Kubernetes 官方不推荐生产使用，建议显式使用 Prefix 或 Exact。</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/foo</span></span><br></pre></td></tr></table></figure><h3 id="设置缺省的-ingressclass">设置缺省的 ingressclass</h3><ul class="lvl-0"><li class="lvl-2"><p>我们可以设置一个缺省的 ingressclass 为默认值，这样，当创建ingress时，如果未指定ingressclass，则使用缺省值</p></li><li class="lvl-2"><p>可以通过 kubectl patch 为 ingressclass 直接打上默认标识(通过 k edit ingressclass ingressclass-name 为其添加注解也可以)</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 ingressclasses</span></span><br><span class="line">$ k get ingressclasses</span><br><span class="line">NAME    CONTROLLER             PARAMETERS   AGE</span><br><span class="line">nginx   k8s.io/ingress-nginx   &lt;none&gt;       3h3m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置 nginx 为默认 ingressclass，就是为其加上如下注解</span></span><br><span class="line">$ kubectl patch ingressclass nginx -p <span class="string">&#x27;&#123;&quot;metadata&quot;: &#123;&quot;annotations&quot;:&#123;&quot;ingressclass.kubernetes.io/is-default-class&quot;:&quot;true&quot;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="ingerss-nginx-应用示例">ingerss-nginx 应用示例</h3><ul class="lvl-0"><li class="lvl-2"><p>同一域名不同路径<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/s1XbqM.png" alt=""></p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">simple-fanout-example</span></span><br><span class="line"><span class="attr">spec:</span>                       <span class="comment"># 未指定 ingressClassName ,则使用 上文中设置的默认 ingressClassName</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">foo.bar.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/foo</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">service1</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">4200</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/bar</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">service2</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>不同域名的服务<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/sBhmbR.png" alt=""></p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">name-virtual-host-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">foo.bar.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">service1</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">bar.foo.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">service2</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>通过如下命令对 ingress 进行修改，修改保存(:wq)后会立刻生效</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit ingress web-ingress</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

引用本地其它文章连接{}
 大括号开始% post_link 文件名称(不包含.md) %大括号结束
 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍 K8S 安装及使用 Ingress Nginx，本文以 CentOS 8 为例。&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/&quot;&gt;K8S官网&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.github.io/ingress-nginx/&quot;&gt;ingress-nginx 官网&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/&quot;&gt;ingress-nginx k8s简介&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress-controllers/&quot;&gt;k8s支持的 ingress controller&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="k8s" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/k8s/"/>
    
    
    <category term="K8S" scheme="https://blog.hanqunfeng.com/tags/K8S/"/>
    
  </entry>
  
  <entry>
    <title>K8S 之 Service</title>
    <link href="https://blog.hanqunfeng.com/2025/07/18/k8s-service/"/>
    <id>https://blog.hanqunfeng.com/2025/07/18/k8s-service/</id>
    <published>2025-07-18T14:30:05.000Z</published>
    <updated>2025-07-20T13:49:29.985Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote %引用本地其它文章连接{} 大括号开始% post_link 文件名称(不包含.md) %大括号结束 --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍 K8S 的 Service ，本文以 CentOS 8 为例。</p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/">K8S官网</a></p></li><li class="lvl-2"><p><a href="https://github.com/kubernetes/kubernetes">k8s Github</a></p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/">k8s Service 介绍</a></p></li></ul><span id="more"></span><h2 id="Service-介绍">Service 介绍</h2><ul class="lvl-0"><li class="lvl-2"><p>Service(缩写为 svc)是一个抽象层，它定义了一组Pod的逻辑集，并为这些Pod支持外部流量暴露、负载均衡和服务发现。</p></li><li class="lvl-2"><p>尽管每个Pod 都有一个唯一的IP地址，但是如果没有Service，这些IP不会暴露在群集外部。</p></li><li class="lvl-2"><p>Service允许您的应用程序接收流量。</p></li><li class="lvl-2"><p>Service也可以用在ServiceSpec标记type的方式暴露，type类型如下：</p><ul class="lvl-2"><li class="lvl-4">ClusterIP（默认）：在集群的内部IP上公开Service。这种类型使得Service只能从集群内访问。</li><li class="lvl-4">NodePort：使用NAT在集群中每个选定Node的相同端口上公开Service。使用 <NodeIP>:<NodePort> 从集群外部访问Service。是ClusterIP的超集。</li><li class="lvl-4">LoadBalancer：在当前云中创建一个外部负载均衡器(如果支持的话)，并为Service分配一个固定的外部IP。是NodePort的超集。</li><li class="lvl-4">ExternalName：通过返回带有该名称的CNAME记录，使用任意名称（由spec中的externalName指定）公开Service。不使用代理。</li></ul></li></ul><h2 id="创建Service">创建Service</h2><h3 id="ClusterIP">ClusterIP</h3><ul class="lvl-0"><li class="lvl-2"><p>只能在集群内部访问</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先创建deployment，此时会为每个pod添加一个label app=nginx</span></span><br><span class="line">kubectl create deployment nginx --image=nginx --replicas=2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建service，，将deployment的pod暴露出来，暴露类型为ClusterIP</span></span><br><span class="line">kubectl expose deployment nginx --<span class="built_in">type</span>=ClusterIP --port=80</span><br><span class="line">$ kubectl get svc nginx</span><br><span class="line">NAME    TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">nginx   ClusterIP   10.96.14.90   &lt;none&gt;        80/TCP    60s</span><br></pre></td></tr></table></figure><h3 id="NodePort">NodePort</h3><ul class="lvl-0"><li class="lvl-2"><p>暴露宿主机的端口，供外部访问</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建service，将deployment的pod暴露出来，暴露类型为NodePort</span></span><br><span class="line">kubectl expose deployment nginx --<span class="built_in">type</span>=NodePort --port=80</span><br><span class="line"><span class="comment"># 查看service，此时可以看到service的端口和节点的端口，与 ClusterIP 的区别就是是否暴露在节点上的端口</span></span><br><span class="line">$ kubectl get svc nginx</span><br><span class="line">NAME    TYPE       CLUSTER-IP   EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">nginx   NodePort   10.96.7.8    &lt;none&gt;        80:32691/TCP   31s</span><br></pre></td></tr></table></figure><h3 id="yaml文件创建service">yaml文件创建service</h3><ul class="lvl-0"><li class="lvl-2"><p>yaml文件格式</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span>      <span class="comment"># api版本</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span>       <span class="comment"># 资源类型</span></span><br><span class="line"><span class="attr">metadata:</span>           <span class="comment"># 元数据</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span>       <span class="comment"># service名称</span></span><br><span class="line"><span class="attr">spec:</span>               <span class="comment"># 配置</span></span><br><span class="line">  <span class="attr">ports:</span>            <span class="comment"># 端口</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span>        <span class="comment"># 集群内访问端口，service的端口，一般配置为与 targetPort 一致，但是非必须</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span>   <span class="comment"># 协议</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span>  <span class="comment"># 容器端口, pod的端口，这个必须与实际容器端口一致</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30080</span> <span class="comment"># node暴露的端口，service类型为 NodePort 时使用，默认范围在 30000-32767 之间</span></span><br><span class="line">  <span class="attr">selector:</span>         <span class="comment"># 选择器</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span>      <span class="comment"># pod的标签，即匹配pod的标签 app=nginx</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span>    <span class="comment"># service类型</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>这里有个问题需要注意，service 默认是通过<code>标签</code>来匹配pod的，所以创建service的时候，一定要保证pod的标签是存在的，否则service无法匹配pod，另外虽然我们通过命令行创建service时是通过<code>kubectl expose deployment nginx --type=NodePort --port=80</code>创建的，但也并不表示service只会匹配这个deployment创建的pod，而是会匹配所有具有指定标签的pod（app=nginx）。</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取service的 selector</span></span><br><span class="line">$ k get svc -owide</span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)        AGE    SELECTOR</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP        4d5h   &lt;none&gt;</span><br><span class="line">nginx        NodePort    10.96.9.77   &lt;none&gt;        80:30080/TCP   8s     app=nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里有个名称为 kubernetes 的 service，其作用是为了方便集群内部的 Pod 调用 API Server 的统一入口</span></span><br><span class="line"><span class="comment"># 无论 API Server 实际运行在哪个节点哪个 IP，集群内部只要访问如下地址就能访问 API Server。</span></span><br><span class="line"><span class="comment"># https://kubernetes.default.svc</span></span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line"><span class="comment"># https://10.96.0.1</span></span><br><span class="line"><span class="comment"># 这个 Service 是 系统自带的，不建议删除或修改。</span></span><br></pre></td></tr></table></figure><h3 id="ExternalName">ExternalName</h3><ul class="lvl-0"><li class="lvl-2"><p>可以将其它 namespace 的 service 别名到 当前 namespace，这样访问 service 时就不需要加上命名空间名称了</p></li><li class="lvl-2"><p>ExternalName Service 是纯 DNS CNAME 映射，我们不经可以映射集群内容服务，也可以映射集群外部服务。</p></li><li class="lvl-2"><p>原先的 service 访问方式：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在不同命名空间下创建service</span></span><br><span class="line"><span class="comment"># 创建两个命名空间以及下面的资源</span></span><br><span class="line"><span class="comment">## ns1</span></span><br><span class="line">kubectl create namespace ns1</span><br><span class="line">kubectl create deployment alpine-demo -n ns1 --image=alpine/curl --replicas=1 -- /bin/sh -c <span class="string">&quot;sleep infinity&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## ns2</span></span><br><span class="line">kubectl create namespace ns2</span><br><span class="line">kubectl create deployment nginx-demo -n ns2 --image=nginx --replicas=1</span><br><span class="line">kubectl expose deployment nginx-demo -n ns2 --<span class="built_in">type</span>=ClusterIP --port=80 --name=nginx-service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入 ns1 中的 pod 访问 ns2 中的 nginx-service</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it -n ns1 alpine-demo-66895487c8-sk4t4 -- /bin/sh</span><br><span class="line">curl nginx-service.ns2.svc.cluster.local</span><br><span class="line">curl nginx-service.ns2</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ExternalName 访问</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 ns1 中创建 externalName 类型的 service，--external-name 指定 ns2 中的 nginx-service</span></span><br><span class="line">kubectl create service externalname nginx-service -n ns1 --external-name=nginx-service.ns2.svc.cluster.local</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>也可以通过 yaml 创建</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service</span>                               <span class="comment"># service 名称</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ns1</span>                                    <span class="comment"># 指定命名空间 为 ns1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">externalName:</span> <span class="string">nginx-service.ns2.svc.cluster.local</span> <span class="comment"># 指定外部服务名，比如 www.baidu.com</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ExternalName</span>                                <span class="comment"># 指定为 ExternalName 类型</span></span><br><span class="line">  <span class="attr">selector:</span>                                         <span class="comment"># 不需要配置 selector</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx-service</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>查看 service</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ k get svc -n ns1</span><br><span class="line">NAME            TYPE           CLUSTER-IP   EXTERNAL-IP                           PORT(S)   AGE</span><br><span class="line">nginx-service   ExternalName   &lt;none&gt;       nginx-service.ns2.svc.cluster.local   &lt;none&gt;    16s</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>此时再次进入 ns1 中的 pod 访问 ns2 中的 nginx-service 服务</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it -n ns1 alpine-demo-66895487c8-sk4t4 -- /bin/sh</span><br><span class="line"><span class="comment"># 此时就不需要加上 ns2 的 namespace 了</span></span><br><span class="line">curl nginx-service</span><br></pre></td></tr></table></figure><h3 id="LoadBalancer">LoadBalancer</h3><ul class="lvl-0"><li class="lvl-2"><p>LoadBalancer 是 Kubernetes Service 的一种类型，用于自动申请一个云厂商的负载均衡器（如 AWS ELB、GCP LB、阿里云 SLB），将外部流量转发到 Kubernetes 集群内部的 Pod 上。</p></li><li class="lvl-2"><p>在私有云上，需要借助第三方负载均衡器来实现，比如 <a href="https://metallb.io">MetalLB</a>，<a href="https://github.com/metallb/metallb">github</a></p></li></ul><h4 id="安装-MetallB">安装 MetallB</h4><ul class="lvl-0"><li class="lvl-2"><p>如果您在IPVS模式下使用kube代理，从Kubernetes v1.14.2开始，您必须启用严格的ARP模式。请注意，如果您使用kube-router作为服务代理，则不需要这个，因为它默认启用了严格的ARP。</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看将要产生的变更，如果有变更则返回非零状态码</span></span><br><span class="line">kubectl get configmap kube-proxy -n kube-system -o yaml | \</span><br><span class="line">sed -e <span class="string">&quot;s/strictARP: false/strictARP: true/&quot;</span> | \</span><br><span class="line">kubectl diff -f - -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实际应用变更，只有发生错误时才返回非零状态码</span></span><br><span class="line">kubectl get configmap kube-proxy -n kube-system -o yaml | \</span><br><span class="line">sed -e <span class="string">&quot;s/strictARP: false/strictARP: true/&quot;</span> | \</span><br><span class="line">kubectl apply -f - -n kube-system</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>安装MetalLB</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> METLB_VERSION=v0.15.2</span><br><span class="line">curl -L -o metallb.yaml https://raw.githubusercontent.com/metallb/metallb/<span class="variable">$&#123;METLB_VERSION&#125;</span>/config/manifests/metallb-native.yaml</span><br><span class="line">kubectl apply -f metallb.yaml</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>查看MetalLB资源</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ k get all -n metallb-system -owide</span><br><span class="line">NAME                              READY   STATUS    RESTARTS      AGE     IP               NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">pod/controller-58fdf44d87-bsp4z   1/1     Running   0             4m13s   10.244.194.104   k8s-worker1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod/speaker-sjvq5                 1/1     Running   0             4m13s   10.211.55.15     k8s-worker1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod/speaker-srpp4                 1/1     Running   0             4m13s   10.211.55.16     k8s-worker2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod/speaker-tbnls                 1/1     Running   2 (98s ago)   4m13s   10.211.55.11     k8s-master    &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">NAME                              TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE     SELECTOR</span><br><span class="line">service/metallb-webhook-service   ClusterIP   10.96.233.8   &lt;none&gt;        443/TCP   4m14s   component=controller</span><br><span class="line"></span><br><span class="line">NAME                     DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE     CONTAINERS   IMAGES                            SELECTOR</span><br><span class="line">daemonset.apps/speaker   3         3         3       3            3           kubernetes.io/os=linux   4m13s   speaker      quay.io/metallb/speaker:v0.15.2   app=metallb,component=speaker</span><br><span class="line"></span><br><span class="line">NAME                         READY   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS   IMAGES                               SELECTOR</span><br><span class="line">deployment.apps/controller   1/1     1            1           4m14s   controller   quay.io/metallb/controller:v0.15.2   app=metallb,component=controller</span><br><span class="line"></span><br><span class="line">NAME                                    DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES                               SELECTOR</span><br><span class="line">replicaset.apps/controller-58fdf44d87   1         1         1       4m13s   controller   quay.io/metallb/controller:v0.15.2   app=metallb,component=controller,pod-template-hash=58fdf44d87</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>配置地址池:metallb-pool.yaml</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">metallb.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IPAddressPool</span>                 <span class="comment"># 地址池类型</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metallb-pool</span>                <span class="comment"># 地址池名称</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">metallb-system</span>         <span class="comment"># 命名空间</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">addresses:</span>                        <span class="comment"># 配置地址池</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">10.211</span><span class="number">.55</span><span class="number">.200</span><span class="number">-10.211</span><span class="number">.55</span><span class="number">.250</span>     <span class="comment"># 与 节点 相同的网段，负载均衡器可以分配的IP范围</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f metallb-pool.yaml</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>配置地址池的二级公告:metallb-advertisement.yaml</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">metallb.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">L2Advertisement</span>               <span class="comment"># 地址池二级公告类型</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metallb-advertisement</span>       <span class="comment"># 公告名称</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">metallb-system</span>         <span class="comment"># 命名空间</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ipAddressPools:</span>                   <span class="comment"># 地址池名称列表，只有被公告的地址池才会被使用</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">metallb-pool</span>                    <span class="comment"># 地址池名称</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f metallb-advertisement.yaml</span><br></pre></td></tr></table></figure><h4 id="创建-LoadBalancer-类型的-service">创建 LoadBalancer 类型的 service</h4><ul class="lvl-0"><li class="lvl-2"><p>metallb-service.yaml</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>                  <span class="comment"># 指定使用的 API 版本，这里是 apps/v1，适用于 Deployment 资源</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span>                     <span class="comment"># Kubernetes 资源类型，这里是部署（Deployment）</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span>                       <span class="comment"># 标签，用于标识资源，可与 selector 匹配</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span>                        <span class="comment"># 资源名称，必须唯一（在同一命名空间下）</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ns1</span>                     <span class="comment"># 命名空间，默认为 default</span></span><br><span class="line"><span class="attr">spec:</span>                                <span class="comment"># 配置项</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span>                        <span class="comment"># 副本数，表示希望运行多少个 Pod 实例</span></span><br><span class="line">  <span class="attr">selector:</span>                          <span class="comment"># 选择器，指定要管理的 Pod</span></span><br><span class="line">    <span class="attr">matchLabels:</span>                     <span class="comment"># 标签选择器</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span>                     <span class="comment"># 选择器，指定 Deployment 管理哪些 Pod（标签必须与 template 中匹配）</span></span><br><span class="line">  <span class="attr">template:</span>                          <span class="comment"># 模板，定义 Pod 的内容，具体可以参考 Pod 的配置</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span>                   <span class="comment"># Pod 的标签，必须与 selector 中的 matchLabels 一致</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span>                 <span class="comment"># 容器使用的镜像，这里是官方的 nginx 镜像</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span>                  <span class="comment"># 容器的名称</span></span><br><span class="line"><span class="string">---</span>                                  <span class="comment"># 分割线</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span>                       <span class="comment"># api版本</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span>                        <span class="comment"># 资源类型</span></span><br><span class="line"><span class="attr">metadata:</span>                            <span class="comment"># 元数据</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span>                        <span class="comment"># service名称</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ns1</span>                     <span class="comment"># 命名空间</span></span><br><span class="line"><span class="attr">spec:</span>                                <span class="comment"># 配置</span></span><br><span class="line">  <span class="attr">ports:</span>                             <span class="comment"># 端口</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span>                         <span class="comment"># 集群内访问端口，service的端口，一般配置为与 targetPort 一致，但是非必须</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span>                    <span class="comment"># 协议</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span>                   <span class="comment"># 容器端口, pod的端口，这个必须与实际容器端口一致</span></span><br><span class="line">  <span class="attr">selector:</span>                          <span class="comment"># 选择器</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span>                       <span class="comment"># pod的标签，即匹配pod的标签 app=nginx</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span>                 <span class="comment"># service类型</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ k apply -f metallb-service.yaml</span><br><span class="line">deployment.apps/nginx created</span><br><span class="line">service/nginx created</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>查看service</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以看到 service 的类型为 LoadBalancer，并分配了 EXTERNAL-IP，这里还开放了nodePort 30613</span></span><br><span class="line">$ kubectl get svc -n ns1</span><br><span class="line">NAME         TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)        AGE</span><br><span class="line">nginx        LoadBalancer   10.96.210.244   10.211.55.200   80:30613/TCP   52s</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>访问service</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过 service 的 port 访问，这里是 80</span></span><br><span class="line">curl 10.211.55.200</span><br><span class="line"><span class="comment"># 同样可以基于 nodeIP+nodePort 访问</span></span><br><span class="line">curl 10.211.55.11:30613</span><br></pre></td></tr></table></figure><h2 id="访问service，轮询pod">访问service，轮询pod</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 在集群内</span></span><br><span class="line"><span class="comment"># 在相同的 namespace 中，可以通过 serviceName 直接访问</span></span><br><span class="line">curl nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以通过 CLUSTER-IP 访问</span></span><br><span class="line">curl 10.96.9.77</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在不同的 namespace 中，可以通过 &lt;serviceName&gt;.&lt;namespace&gt; 或者 &lt;serviceName&gt;.&lt;namespace&gt;.svc.cluster.local 访问，比如本示例为</span></span><br><span class="line">curl nginx.default</span><br><span class="line">curl nginx.default.svc.cluster.local</span><br><span class="line"><span class="comment"># 这是因为在创建 service前，我们是不知道 service 的 IP 地址的，所以在其它pod中就可以预先使用 &lt;serviceName&gt;.&lt;namespace&gt; 占位，k8s会自动将其解析为 service 的 CLUSTER-IP</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 在集群外</span></span><br><span class="line"><span class="comment"># 通过 NODE-IP:NODE-PORT 访问</span></span><br><span class="line">curl 10.211.55.16:30080</span><br></pre></td></tr></table></figure><h2 id="管理service">管理service</h2><ul class="lvl-0"><li class="lvl-2"><p>查看service</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看service</span></span><br><span class="line">kubectl get svc</span><br><span class="line"><span class="comment"># 查看指定namespace下的service</span></span><br><span class="line">kubectl get svc -n kube-system</span><br><span class="line"><span class="comment"># 查看全部service</span></span><br><span class="line">kubectl get svc -A</span><br><span class="line"><span class="comment"># 查看service详情</span></span><br><span class="line">kubectl get svc nginx -o yaml</span><br><span class="line">kubectl describe svc nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line">k logs svc/nginx</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>编辑service，保存（:wq）后生效，不需要额外 apply 或 restart</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit svc nginx</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>删除service</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete svc nginx</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

引用本地其它文章连接{}
 大括号开始% post_link 文件名称(不包含.md) %大括号结束
 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍 K8S 的 Service ，本文以 CentOS 8 为例。&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/&quot;&gt;K8S官网&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/kubernetes/kubernetes&quot;&gt;k8s Github&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/&quot;&gt;k8s Service 介绍&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="k8s" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/k8s/"/>
    
    
    <category term="K8S" scheme="https://blog.hanqunfeng.com/tags/K8S/"/>
    
  </entry>
  
  <entry>
    <title>acme.sh 自动申请并续签 SSL 证书的工具</title>
    <link href="https://blog.hanqunfeng.com/2025/07/17/acme/"/>
    <id>https://blog.hanqunfeng.com/2025/07/17/acme/</id>
    <published>2025-07-17T14:30:05.000Z</published>
    <updated>2025-07-19T07:00:35.350Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote %引用本地其它文章连接{} 大括号开始% post_link 文件名称(不包含.md) %大括号结束 --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍自动申请并续签 SSL 证书的工具: <a href="http://acme.sh">acme.sh</a></p></li><li class="lvl-2"><p><a href="https://github.com/acmesh-official/acme.sh">acme.sh Github</a></p></li></ul><span id="more"></span><h2 id="acme-sh-介绍"><a href="http://acme.sh">acme.sh</a> 介绍</h2><ul class="lvl-0"><li class="lvl-2"><p><a href="http://acme.sh">acme.sh</a> 实现了 acme 协议，可以从 ZeroSSL，Let’s Encrypt 等 CA 生成免费的证书。</p></li><li class="lvl-2"><p>适用场景：shell脚本方式，几乎无依赖，极简，适合不想安装Python环境的人。</p></li><li class="lvl-2"><p>特点：</p><ul class="lvl-2"><li class="lvl-4">纯 Shell 脚本，单文件运行</li><li class="lvl-4">支持 100+ DNS API 自动续签（如 Cloudflare、阿里云、腾讯云等）</li><li class="lvl-4">支持通配符证书</li></ul></li></ul><h2 id="acme-sh-安装"><a href="http://acme.sh">acme.sh</a> 安装</h2><ul class="lvl-0"><li class="lvl-2"><p>需要先安装 crontab</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 crontab</span></span><br><span class="line"><span class="built_in">sudo</span> dnf install cronie -y</span><br><span class="line"><span class="comment"># 启动 crond</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> --now crond</span><br><span class="line"><span class="comment"># 查看 crond 状态</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl status crond</span><br><span class="line"><span class="comment"># 查看 crontab 是否正常</span></span><br><span class="line">crontab -l</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>安装 <a href="http://acme.sh">acme.sh</a></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装成功后会自动安装到 ~/.acme.sh/ 目录下，证书也会生成在该目录下</span></span><br><span class="line">curl https://get.acme.sh | sh -s email=qunfeng_han@aliyun.com</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;alias acme.sh=~/.acme.sh/acme.sh&#x27;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装成功后会自动在 crontab 中添加了定时任务，每天检查一次证书是否到达下次更新日期，如果到期则自动更新</span></span><br><span class="line"><span class="comment"># 证书有效期默认为 90 天，还剩 30 天时会触发自动更新</span></span><br><span class="line">crontab -l</span><br><span class="line"><span class="comment"># 输出类似于 以下内容</span></span><br><span class="line">48 1 * * * <span class="string">&quot;/root/.acme.sh&quot;</span>/acme.sh --cron --home <span class="string">&quot;/root/.acme.sh&quot;</span> &gt; /dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看帮助</span></span><br><span class="line">acme.sh -h</span><br><span class="line"><span class="comment"># 查看版本</span></span><br><span class="line">acme.sh -v</span><br></pre></td></tr></table></figure><h2 id="升级-acme-sh">升级 <a href="http://acme.sh">acme.sh</a></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 升级 acme.sh 到最新版</span></span><br><span class="line">acme.sh --upgrade</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启自动升级</span></span><br><span class="line">acme.sh --upgrade --auto-upgrade</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以随时关闭自动更新</span></span><br><span class="line">acme.sh --upgrade --auto-upgrade  0</span><br></pre></td></tr></table></figure><h2 id="卸载-acme-sh">卸载 <a href="http://acme.sh">acme.sh</a></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">acme.sh --uninstall</span><br><span class="line"><span class="built_in">rm</span> -rf ~/.acme.sh</span><br></pre></td></tr></table></figure><h2 id="生成证书">生成证书</h2><ul class="lvl-0"><li class="lvl-2"><p><a href="http://acme.sh">acme.sh</a> 实现了 acme 协议支持的所有验证协议。</p></li><li class="lvl-2"><p>证书创建后会保存在 ~/.acme.sh/目录下，比如我的域名是 <code>acme.hanqunfeng.com</code>，则证书保存在 <code>~/.acme.sh/acme.hanqunfeng.com_ecc/</code>目录下</p></li><li class="lvl-2"><p>创建证书时一般有两种方式验证: HTTP 和 DNS 验证。</p></li></ul><h3 id="HTTP-验证">HTTP 验证</h3><ul class="lvl-0"><li class="lvl-2"><p>只支持单个子域名的证书生成，不支持通配符域名</p></li><li class="lvl-2"><p>需要提前将域名解析到本机的IP地址</p></li></ul><h4 id="直接签发">直接签发</h4><ul class="lvl-0"><li class="lvl-2"><p>只需要指定域名，并指定域名所在的网站根目录. <a href="http://acme.sh">acme.sh</a> 会全自动的生成验证文件，并放到网站的根目录，验证完成后会聪明的删除验证文件，整个过程没有任何副作用。</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -d 指定域名，可以添加多个，--webroot 指定网站根目录</span></span><br><span class="line">acme.sh --issue -d acme.hanqunfeng.com -d www.hanqunfeng.com --webroot /home/wwwroot/mydomain.com/</span><br><span class="line"></span><br><span class="line"><span class="comment"># --server 指定 acme.sh 使用的 CA 服务商为 Let&#x27;s Encrypt，默认使用 ZeroSSL</span></span><br><span class="line">acme.sh --issue -d acme.hanqunfeng.com -d www.hanqunfeng.com --webroot /home/wwwroot/mydomain.com/ --server letsencrypt</span><br></pre></td></tr></table></figure><h4 id="使用-Nginx-Apache-模式">使用 Nginx/Apache 模式</h4><ul class="lvl-0"><li class="lvl-2"><p>如果你用的 Nginx/Apache 服务器，或者反代，<a href="http://acme.sh">acme.sh</a> 还可以智能的从 Nginx/Apache 的配置中自动完成验证，你不需要指定网站根目录</p></li><li class="lvl-2"><p>nginx 或 httpd 命令要在系统Path中</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -d 域名，可以添加多个, --nginx 告诉 acme.sh 使用 Nginx 模式</span></span><br><span class="line">acme.sh --issue --nginx -d acme.hanqunfeng.com -d www.hanqunfeng.com</span><br><span class="line"><span class="comment"># -d 域名，可以添加多个, --apache 告诉 acme.sh 使用 Apache 模式</span></span><br><span class="line">acme.sh --issue --apache -d acme.hanqunfeng.com -d www.hanqunfeng.com</span><br></pre></td></tr></table></figure><h4 id="使用独立服务模式">使用独立服务模式</h4><ul class="lvl-0"><li class="lvl-2"><p>如果服务器上没有运行任何 Web 服务，80 端口是空闲的，那么 <a href="http://acme.sh">acme.sh</a> 还能假装自己是一个 WebServer，临时监听 80 端口，完成验证</p></li><li class="lvl-2"><p>需要先安装 socat 命令，socat 常用于临时开启 TCP/UDP 监听端口</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dnf install socat -y</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>生成证书，要求80端口空闲，否则会失败</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --standalone 独立服务模式</span></span><br><span class="line">acme.sh --issue --standalone -d acme.hanqunfeng.com -d www.hanqunfeng.com</span><br></pre></td></tr></table></figure><h3 id="DNS-验证">DNS 验证</h3><ul class="lvl-0"><li class="lvl-2"><p>如果你没有服务器，没有公网 IP，只需要 DNS 的解析记录即可完成验证。</p></li><li class="lvl-2"><p>支持通配符域名</p></li></ul><h4 id="手动验证">手动验证</h4><ul class="lvl-0"><li class="lvl-2"><p>这需要你手动在域名上添加一条 TXT 解析记录，验证域名所有权。</p></li><li class="lvl-2"><p>注意，如果使用手动验证，<a href="http://acme.sh">acme.sh</a> 将无法自动更新证书，每次都需要手动添加解析来验证域名所有权。如果有自动更新证书的需求，请使用自动验证（DNS API）。</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 需要加上 --yes-I-know-dns-manual-mode-enough-go-ahead-please 选项</span></span><br><span class="line">acme.sh --issue --dns -d acme.hanqunfeng.com -d www.hanqunfeng.com --yes-I-know-dns-manual-mode-enough-go-ahead-please</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>然后，<a href="http://acme.sh">acme.sh</a> 会生成相应的解析记录显示出来，你只需要在你的域名管理面板中添加这条 TXT 记录即可。</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Add the following txt record:</span><br><span class="line">Domain:_acme-challenge.acme.hanqunfeng.com</span><br><span class="line">Txt value:mUWNg9kuQ9hwOkqYFQ_DFMQ4Eu0CEaxxxxxxxxxxx</span><br><span class="line"></span><br><span class="line">Add the following txt record:</span><br><span class="line">Domain:_acme-challenge.www.hanqunfeng.com</span><br><span class="line">Txt value:vLwDR48eHcmcScOwHrDjaFZo-yw_f9xxxxxxxxxxx</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>等待解析完成之后，执行以下命令重新生成证书：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意这里现在用的是 --renew 参数</span></span><br><span class="line">acme.sh --renew -d acme.hanqunfeng.com -d www.hanqunfeng.com</span><br></pre></td></tr></table></figure><h4 id="自动验证（DNS-API）">自动验证（DNS API）</h4><ul class="lvl-0"><li class="lvl-2"><p>DNS 方式的真正强大之处在于可以使用域名解析商提供的 API 自动添加 TXT 记录，且在完成验证后删除对应的记录。</p></li><li class="lvl-2"><p><a href="http://acme.sh">acme.sh</a> 目前支持<a href="https://github.com/acmesh-official/acme.sh/wiki/dnsapi">超过一百家的 DNS API</a>。</p></li><li class="lvl-2"><p>以阿里云为例，登录阿里云帐号，获取 AccessKey 和 SecretKey，并设置环境变量：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只需要命令行执行一次，运行生成证书命令时会保存在 ~/.acme.sh/account.conf 中，并在需要时自动获取，无需手动再设置</span></span><br><span class="line"><span class="built_in">export</span> Ali_Key=<span class="string">&quot;&lt;key&gt;&quot;</span></span><br><span class="line"><span class="built_in">export</span> Ali_Secret=<span class="string">&quot;&lt;secret&gt;&quot;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>生成证书</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --dns dns_ali 指定阿里云的DNS API</span></span><br><span class="line">acme.sh --issue -d acme.hanqunfeng.com -d *.hanqunfeng.com --dns dns_ali</span><br></pre></td></tr></table></figure><h2 id="生成证书的其它说明">生成证书的其它说明</h2><ul class="lvl-0"><li class="lvl-2"><p><a href="http://acme.sh">acme.sh</a> 脚本默认 CA 服务商是 ZeroSSL，<a href="https://github.com/acmesh-official/acme.sh/wiki/Server">acme.sh 支持的CA 服务商及其使用方法</a>，可以在命令行中通过 --server 指定</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这里使用 Let&#x27;s Encrypt 的 CA 服务商</span></span><br><span class="line">acme.sh --issue -d acme.hanqunfeng.com -d *.hanqunfeng.com --dns dns_ali --server letsencrypt</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>也可以设置全局默认的 CA 服务商，这样就不需要每次都指定 --server</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">acme.sh --set-default-ca --server letsencrypt</span><br></pre></td></tr></table></figure><div class="tips"><p><em><strong>小贴士</strong></em></p><ul class="lvl-1"><li class="lvl-2"><a href="http://acme.sh">acme.sh</a> 官网说 默认的 CA 服务商 ZeroSSL 不是很稳定，有时可能会导致获取证书的时候一直出现：<code>Pending，The CA is processing your order，please just wait.</code>， 此时只需要把 CA 服务器改成 Let’s Encrypt 即可，虽然更改以后还是有概率出现 pending，但基本 2-3 次即可成功。</li><li class="lvl-2">但是 Let’s Encrypt 获取的证书，不支持比较旧的设备，比如 Android 5.0 以下的设备，如果有这方面的需要还是推荐使用 ZeroSSL。</li><li class="lvl-2">常见根证书表</li></ul><table><thead><tr><th>根证书（CN）</th><th>Android 5.0</th><th>常见签发方</th></tr></thead><tbody><tr><td><strong>ISRG Root X1</strong></td><td>❌ 不兼容</td><td>Let’s Encrypt</td></tr><tr><td><strong>DST Root CA X3</strong></td><td>✅ 兼容（2021年过期）</td><td>Let’s Encrypt 老版本</td></tr><tr><td><strong>GlobalSign Root R1</strong></td><td>✅ 兼容</td><td>GlobalSign</td></tr><tr><td><strong>USERTrust RSA Certification Authority</strong></td><td>✅ 兼容</td><td>ZeroSSL, Sectigo</td></tr><tr><td><strong>Starfield Root CA - G2</strong></td><td>❌ 不兼容</td><td>GoDaddy 新版</td></tr><tr><td><strong>Starfield Root CA - G1</strong></td><td>✅ 兼容</td><td>GoDaddy 老版</td></tr><tr><td><strong>GTS Root R1/R3</strong></td><td>❌ 不兼容</td><td>Google Trust Services</td></tr><tr><td><strong>Amazon Root CA 1</strong></td><td>❌ 不兼容</td><td>Amazon Trust</td></tr></tbody></table><ul class="lvl-1"><li class="lvl-2"><p>可以用在线工具直接查看证书链：<a href="https://www.ssllabs.com/ssltest/">https://www.ssllabs.com/ssltest/</a> ，它会显示完整证书链和各种设备的兼容性</p></li></ul></div><ul class="lvl-0"><li class="lvl-2"><p>查看已经生成的证书</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ acme.sh --list</span><br><span class="line">Main_Domain          KeyLength  SAN_Domains  CA           Created               Renew</span><br><span class="line">acme.hanqunfeng.com  <span class="string">&quot;ec-256&quot;</span>   no           ZeroSSL.com  2025-07-17T03:31:30Z  2025-09-14T03:31:30Z</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>如果生成证书时失败，可以通过添加 --debug 参数查看详细错误信息</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">acme.sh --issue -d acme.hanqunfeng.com -d *.hanqunfeng.com --dns dns_ali --server letsencrypt --debug</span><br><span class="line"><span class="comment"># --debug 2 输出更为详细的信息</span></span><br><span class="line">acme.sh --issue -d acme.hanqunfeng.com -d *.hanqunfeng.com --dns dns_ali --server letsencrypt --debug 2</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>目前证书每 60 天自动更新，你无需任何操作。但是你也可以强制续签证书：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意这里要将 --issue 改为 --renew，--issue 只有第一次生成正式时才会使用。同时加上 --force，未到更新时间强制重新生成证书。</span></span><br><span class="line">acme.sh --renew -d acme.hanqunfeng.com -d *.hanqunfeng.com --dns dns_ali --server letsencrypt --force</span><br></pre></td></tr></table></figure><h2 id="生成证书后自动部署和更新">生成证书后自动部署和更新</h2><ul class="lvl-0"><li class="lvl-2"><p>上面无论是 http 还是 dns 模式，生成证书后，都会在 ~/.acme.sh/acme.hanqunfeng.com_ecc/ 目录下生成以下文件：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">├── acme.hanqunfeng.com.cer</span><br><span class="line">├── acme.hanqunfeng.com.conf</span><br><span class="line">├── acme.hanqunfeng.com.csr</span><br><span class="line">├── acme.hanqunfeng.com.csr.conf</span><br><span class="line">├── acme.hanqunfeng.com.key</span><br><span class="line">├── ca.cer</span><br><span class="line">└── fullchain.cer</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>我们可以手动将证书拷贝到真正使用证书的目录下，如果我们使用nginx或者apache，可以让 <a href="http://acme.sh">acme.sh</a> 帮我们自动将证书拷贝到正确的目录下，并重启服务使证书生效，我们只需要通过如下命令进行设置即可，只需要运行一次命令，后续会通过 crontab 进行自动更新证书并完成部署。</p></li><li class="lvl-2"><p>Nginx</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">acme.sh --install-cert \</span><br><span class="line">-d acme.hanqunfeng.com \                               <span class="comment"># 生成证书时指定的域名</span></span><br><span class="line">--key-file /path/to/keyfile/in/nginx/key.pem \    <span class="comment"># nginx 中配置的 key 文件路径</span></span><br><span class="line">--fullchain-file /path/to/fullchain/nginx/cert.pem \  <span class="comment"># nginx 中配置的证书文件路径</span></span><br><span class="line">--reloadcmd <span class="string">&quot;systemctl reload nginx&quot;</span>                   <span class="comment"># nginx 重载命令，也可以使用 nginx -s reload</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>文件对应关系</p></li></ul><table><thead><tr><th><a href="http://acme.sh">acme.sh</a> 文件</th><th>含义</th><th>你配置的目标文件</th></tr></thead><tbody><tr><td><code>acme.hanqunfeng.com.key</code></td><td><strong>私钥 (Private Key)</strong></td><td><code>/path/to/keyfile/in/nginx/key.pem</code></td></tr><tr><td><code>fullchain.cer</code></td><td><strong>证书 + 中间证书链 (Fullchain)</strong></td><td><code>/path/to/fullchain/nginx/cert.pem</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>Apache</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">acme.sh --install-cert \</span><br><span class="line">-d acme.hanqunfeng.com \</span><br><span class="line">--cert-file      /path/to/certfile/in/apache/cert.pem  \ <span class="comment"># apache 证书文件</span></span><br><span class="line">--key-file       /path/to/keyfile/in/apache/key.pem  \   <span class="comment"># apache 密钥文件</span></span><br><span class="line">--fullchain-file /path/to/fullchain/certfile/apache/fullchain.pem \ <span class="comment"># apache 全链文件</span></span><br><span class="line">--reloadcmd     <span class="string">&quot;systemctl reload httpd&quot;</span>  <span class="comment"># apache 重载命令</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>文件对应关系</p></li></ul><table><thead><tr><th><a href="http://acme.sh">acme.sh</a> 文件</th><th>含义</th><th>你配置的目标文件</th></tr></thead><tbody><tr><td><code>acme.hanqunfeng.com.key</code></td><td><strong>私钥 (Private Key)</strong></td><td><code>/path/to/keyfile/in/apache/key.pem</code></td></tr><tr><td><code>acme.hanqunfeng.com.cer</code></td><td><strong>仅域名证书 (Certificate)</strong></td><td><code>/path/to/certfile/in/apache/cert.pem</code></td></tr><tr><td><code>fullchain.cer</code></td><td><strong>证书 + 中间证书链 (Fullchain)</strong></td><td><code>/path/to/fullchain/certfile/apache/fullchain.pem</code></td></tr></tbody></table><h2 id="停止自动更新并删除证书">停止自动更新并删除证书</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 停止自动更新</span></span><br><span class="line">acme.sh --remove -d acme.hanqunfeng.com --ecc</span><br><span class="line"><span class="comment"># 删除证书</span></span><br><span class="line"><span class="built_in">rm</span> -rf ~/.acme.sh/acme.hanqunfeng.com_ecc</span><br></pre></td></tr></table></figure><h2 id="其它ssl自动续签工具">其它ssl自动续签工具</h2><table><thead><tr><th>工具</th><th>推荐场景</th><th>官网地址</th><th>依赖</th></tr></thead><tbody><tr><td>Certbot</td><td>传统服务器、Nginx/Apache</td><td><a href="https://certbot.eff.org/">https://certbot.eff.org/</a></td><td>Python</td></tr><tr><td>Lego</td><td>静态二进制、K8s</td><td><a href="https://github.com/go-acme/lego">https://github.com/go-acme/lego</a></td><td>无依赖</td></tr><tr><td>cert-manager</td><td>K8s 集群</td><td><a href="https://cert-manager.io/">https://cert-manager.io/</a></td><td>K8s CRD</td></tr><tr><td>Caddy</td><td>简单站点自动HTTPS</td><td><a href="https://caddyserver.com/">https://caddyserver.com/</a></td><td>无需单独工具</td></tr><tr><td>Traefik</td><td>微服务网关</td><td><a href="https://traefik.io/">https://traefik.io/</a></td><td>Docker/K8s</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

引用本地其它文章连接{}
 大括号开始% post_link 文件名称(不包含.md) %大括号结束
 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍自动申请并续签 SSL 证书的工具: &lt;a href=&quot;http://acme.sh&quot;&gt;acme.sh&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/acmesh-official/acme.sh&quot;&gt;acme.sh Github&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="acme" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/acme/"/>
    
    <category term="ssl" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/acme/ssl/"/>
    
    <category term="certificate" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/acme/ssl/certificate/"/>
    
    
    <category term="ssl" scheme="https://blog.hanqunfeng.com/tags/ssl/"/>
    
    <category term="acme" scheme="https://blog.hanqunfeng.com/tags/acme/"/>
    
  </entry>
  
  <entry>
    <title>K8S 镜像拉取 之 toomanyrequests 的解决方法</title>
    <link href="https://blog.hanqunfeng.com/2025/07/16/k8s-toomanyrequests/"/>
    <id>https://blog.hanqunfeng.com/2025/07/16/k8s-toomanyrequests/</id>
    <published>2025-07-16T15:30:05.000Z</published>
    <updated>2025-07-18T03:02:52.603Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote %引用本地其它文章连接{} 大括号开始% post_link 文件名称(不包含.md) %大括号结束 --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍 K8S 镜像拉取 的 <code>toomanyrequests</code> 的解决方法 ，本文以 CentOS 8 为例。</p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/">K8S官网</a></p></li><li class="lvl-2"><p><a href="https://github.com/kubernetes/kubernetes">k8s Github</a></p></li></ul><span id="more"></span><h2 id="toomanyrequests-介绍">toomanyrequests 介绍</h2><ul class="lvl-0"><li class="lvl-2"><p>当我们通过k8s创建pod时需要从 dockerhub 上拉取镜像，但是 dockerhub 的api请求是有限制的，未认证用户限制为100/6h，如果超过这个限制就会返回<code>429 Too Many Requests响应</code>。<a href="https://docs.docker.com/docker-hub/usage/">Docker Hub的使用和限制</a></p></li><li class="lvl-2"><p>我们可以进行用户认证，这样可以将限制提高到2000/6h。如果还需要进一步提高请求限制，可以申请dockerhub的pro plan。</p></li></ul><h2 id="dockerhub-认证">dockerhub 认证</h2><ul class="lvl-0"><li class="lvl-2"><p>创建 Docker Registry Secret</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定 namespace， 默认命名空间是 default</span></span><br><span class="line">kubectl create secret docker-registry \</span><br><span class="line">  dockerhub-secret \                            <span class="comment"># 创建 secret 名称</span></span><br><span class="line">  --namespace=你的命名空间 \                      <span class="comment"># 创建 secret 所在的命名空间</span></span><br><span class="line">  --docker-server=https://index.docker.io/v1/ \ <span class="comment"># 指定 docker registry 地址，默认就是这个，其它仓库或私服请更改为对应的url</span></span><br><span class="line">  --docker-username=你的用户名 \                  <span class="comment"># 仓库 的用户名</span></span><br><span class="line">  --docker-password=你的密码或访问令牌 \           <span class="comment"># 仓库 的密码或访问令牌</span></span><br><span class="line">  --docker-email=你的邮箱                        <span class="comment"># 仓库 的邮箱</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 secret</span></span><br><span class="line">kubectl get secret dockerhub-secret -o yaml -n &lt;namespace&gt;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>可以在创建 pod 或 deployment 时指定凭证</p></li></ul><blockquote><p>pod</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">username/repository:tag</span></span><br><span class="line">  <span class="attr">imagePullSecrets:</span>                         <span class="comment"># 添加凭证</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dockerhub-secret</span></span><br></pre></td></tr></table></figure><blockquote><p>deployment</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">username/repository:tag</span></span><br><span class="line">      <span class="attr">imagePullSecrets:</span>                       <span class="comment"># 添加凭证</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dockerhub-secret</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>将 Secret 添加到 ServiceAccount，这样 Pod 创建的时候，会自动将 Secret 挂载到 Pod 中</p></li></ul><blockquote><p>每个 namespace 下 都有一个 名称为 default 的 ServiceAccount</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 pod 的 ServiceAccount</span></span><br><span class="line">$ k describe pod pi-n65gn | grep <span class="string">&quot;Service Account&quot;</span></span><br><span class="line">Service Account:  default</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定 namespace 下的 Pod 使用这个凭证</span></span><br><span class="line">kubectl patch serviceaccount default -p <span class="string">&#x27;&#123;&quot;imagePullSecrets&quot;: [&#123;&quot;name&quot;: &quot;dockerhub-secret&quot;&#125;]&#125;&#x27;</span> -n &lt;namespace&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加多个凭证，这会覆盖之前的设置，多个 secret 按顺序生效，k8s 会逐个尝试去拉取镜像</span></span><br><span class="line">kubectl patch serviceaccount default -p <span class="string">&#x27;&#123;&quot;imagePullSecrets&quot;: [&#123;&quot;name&quot;: &quot;dockerhub-secret&quot;&#125;, &#123;&quot;name&quot;: &quot;harbor-secret&quot;&#125;, &#123;&quot;name&quot;: &quot;aliyun-secret&quot;&#125;]&#125;&#x27;</span> -n &lt;namespace&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 追加一个凭证，不会覆盖原有的设置</span></span><br><span class="line">kubectl patch serviceaccount default --<span class="built_in">type</span>=<span class="string">&#x27;json&#x27;</span> -p=<span class="string">&#x27;[&#123;&quot;op&quot;: &quot;add&quot;, &quot;path&quot;: &quot;/imagePullSecrets/-&quot;, &quot;value&quot;: &#123;&quot;name&quot;: &quot;new-secret&quot;&#125;&#125;]&#x27;</span> -n &lt;namespace&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前 imagePullSecrets 的索引，以下命令会输出凭证的名称，索引从 0 开始</span></span><br><span class="line">kubectl get sa default -o jsonpath=<span class="string">&#x27;&#123;.imagePullSecrets[*].name&#125;&#x27;</span> -n &lt;namespace&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除一个凭证: 删除 index 为 1 的凭证</span></span><br><span class="line">kubectl patch serviceaccount default --<span class="built_in">type</span>=json -p=<span class="string">&#x27;[&#123;&quot;op&quot;: &quot;remove&quot;, &quot;path&quot;: &quot;/imagePullSecrets/1&quot;&#125;]&#x27;</span> -n &lt;namespace&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清空所有凭证</span></span><br><span class="line">kubectl patch sa default -p <span class="string">&#x27;&#123;&quot;imagePullSecrets&quot;: []&#125;&#x27;</span> -n &lt;namespace&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 为所有 namespace 下的 Pod 添加凭证</span></span><br><span class="line"><span class="keyword">for</span> ns <span class="keyword">in</span> $(kubectl get ns -o jsonpath=<span class="string">&#x27;&#123;.items[*].metadata.name&#125;&#x27;</span>); <span class="keyword">do</span></span><br><span class="line">  kubectl patch serviceaccount default -n <span class="variable">$ns</span> \</span><br><span class="line">    --<span class="built_in">type</span>=merge \</span><br><span class="line">    -p <span class="string">&#x27;&#123;&quot;imagePullSecrets&quot;: [&#123;&quot;name&quot;: &quot;dockerhub-secret&quot;&#125;]&#125;&#x27;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 ServiceAccount</span></span><br><span class="line">$ kubectl get serviceaccount default -o yaml -n &lt;namespace&gt;</span><br><span class="line">apiVersion: v1</span><br><span class="line">imagePullSecrets:</span><br><span class="line">- name: dockerhub-secret</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: <span class="string">&quot;2025-06-29T14:41:35Z&quot;</span></span><br><span class="line">  name: default</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: <span class="string">&quot;361001&quot;</span></span><br><span class="line">  uid: cb3a0f99-5804-4f21-816a-70533cc3d29d</span><br></pre></td></tr></table></figure><h2 id="提高下载频率的其他建议">提高下载频率的其他建议</h2><ul class="lvl-0"><li class="lvl-2"><p>1.使用镜像缓存:</p><ul class="lvl-2"><li class="lvl-4">设置集群内镜像缓存（如 Harbor, Nexus Registry）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改集群的镜像仓库配置（vim）</span></span><br><span class="line">kubectl edit configmap -n kube-system</span><br><span class="line"><span class="comment"># 找到 imageRepository: 替换为你的仓库地址</span></span><br></pre></td></tr></table></figure><ul class="lvl-2"><li class="lvl-4">使用 Docker Hub 镜像加速器（如果在中国大陆）<ul class="lvl-4"><li class="lvl-6">如果 k8s 使用的是 docker，则在<code>/etc/docker/daemon.json</code>添加镜像加速器配置</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /etc/docker</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;https://docker.1ms.run&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://docker.xuanyuan.me&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://docker.m.daocloud.io&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line"><span class="built_in">sudo</span> systemctl restart docker</span><br></pre></td></tr></table></figure><ul class="lvl-4"><li class="lvl-6">如果 k8s 使用的是 containerd，则在<code>/etc/containerd/config.toml</code>添加镜像加速器配置</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> vi /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 找到 registry.mirrors 字段，添加加速器，比如：</span></span><br><span class="line">[plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors]</span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors.<span class="string">&quot;docker.io&quot;</span>]</span><br><span class="line">    endpoint = [<span class="string">&quot;https://docker.1ms.run&quot;</span>, <span class="string">&quot;https://docker.xuanyuan.me&quot;</span>, <span class="string">&quot;https://docker.m.daocloud.io&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改后重启 containerd</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl restart containerd</span><br></pre></td></tr></table></figure></li></ul></li><li class="lvl-2"><p>2.升级 Docker Hub 订阅:</p><ul class="lvl-2"><li class="lvl-4">免费账户：200 pulls/6小时（匿名用户100 pulls/6小时）</li><li class="lvl-4">Pro/Team 账户：无限制拉取</li></ul></li><li class="lvl-2"><p>3.使用多个账户:</p><ul class="lvl-2"><li class="lvl-4">为不同节点配置不同的 Docker Hub 凭证</li></ul></li><li class="lvl-2"><p>4.减少不必要的拉取:</p><ul class="lvl-2"><li class="lvl-4">使用 imagePullPolicy: IfNotPresent</li><li class="lvl-4">尽量使用固定版本标签而非 latest</li></ul></li></ul>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

引用本地其它文章连接{}
 大括号开始% post_link 文件名称(不包含.md) %大括号结束
 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍 K8S 镜像拉取 的 &lt;code&gt;toomanyrequests&lt;/code&gt; 的解决方法 ，本文以 CentOS 8 为例。&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/&quot;&gt;K8S官网&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/kubernetes/kubernetes&quot;&gt;k8s Github&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="k8s" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/k8s/"/>
    
    
    <category term="K8S" scheme="https://blog.hanqunfeng.com/tags/K8S/"/>
    
  </entry>
  
  <entry>
    <title>K8S 之 Job/CronJob</title>
    <link href="https://blog.hanqunfeng.com/2025/07/16/k8s-job-cornjob/"/>
    <id>https://blog.hanqunfeng.com/2025/07/16/k8s-job-cornjob/</id>
    <published>2025-07-16T14:30:05.000Z</published>
    <updated>2025-07-20T13:50:48.012Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote %引用本地其它文章连接{} 大括号开始% post_link 文件名称(不包含.md) %大括号结束 --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍 K8S 的 Job/CronJob ，本文以 CentOS 8 为例。</p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/">K8S官网</a></p></li><li class="lvl-2"><p><a href="https://github.com/kubernetes/kubernetes">k8s Github</a></p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/job/">k8s Job 介绍</a></p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/cron-jobs/">k8s CronJob 介绍</a></p></li></ul><span id="more"></span><h2 id="Job-介绍">Job 介绍</h2><ul class="lvl-0"><li class="lvl-2"><p>Job 表示一次性任务，运行完成后就会停止。</p></li><li class="lvl-2"><p>Job 会创建一个或者多个 Pod，并将继续重试 Pod 的执行，直到指定数量的 Pod 成功终止。</p></li><li class="lvl-2"><p>随着 Pod 成功结束，Job 跟踪记录成功完成的 Pod 个数。 当数量达到指定的成功个数阈值时，任务（即 Job）结束。</p></li><li class="lvl-2"><p>删除 Job 的操作会清除所创建的全部 Pod。 挂起 Job 的操作会删除 Job 的所有活跃 Pod，直到 Job 被再次恢复执行。</p></li></ul><h3 id="Job-创建">Job 创建</h3><ul class="lvl-0"><li class="lvl-2"><p>yaml 文件: job.yaml</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span>                      <span class="comment"># API 版本，这里使用 batch/v1，适用于 Job 资源</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span>                                 <span class="comment"># 资源类型，Job 用于一次性任务，完成后自动退出</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pi</span>                                <span class="comment"># Job 的名称，这里命名为 pi</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ttlSecondsAfterFinished:</span> <span class="number">100</span>            <span class="comment"># Job 完成后，自动删除job的延迟时间，单位为秒。默认不删除</span></span><br><span class="line">  <span class="attr">parallelism:</span> <span class="number">1</span>                          <span class="comment"># Job 的并发数，默认为1，即一次只能启动一个 Pod</span></span><br><span class="line">  <span class="attr">template:</span>                               <span class="comment"># Pod 模板，定义 Job 创建的 Pod 的规范</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span>                         <span class="comment"># Pod 内的容器列表</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pi</span>                          <span class="comment"># 容器名称，用户自定义的名字</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">perl:5.34.0</span>                <span class="comment"># 使用的镜像，这里是 Perl 5.34.0 官方镜像</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;perl&quot;</span>,  <span class="string">&quot;-Mbignum=bpi&quot;</span>, <span class="string">&quot;-wle&quot;</span>, <span class="string">&quot;print bpi(2000)&quot;</span>]  <span class="comment"># 容器启动时执行的命令，计算并输出圆周率的 2000 位小数</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Never</span>                <span class="comment"># 重启策略，设置为 Never，表示 Pod 失败时不会自动重启</span></span><br><span class="line">  <span class="attr">backoffLimit:</span> <span class="number">4</span>                         <span class="comment"># Job 重试次数上限，若失败超过 4 次，则不再重试，Job 状态将标记为 Failed。默认为 6</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>启动Job</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f job.yaml</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>查看 Job</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 Job</span></span><br><span class="line">kubectl get <span class="built_in">jobs</span></span><br><span class="line"><span class="comment"># 查看日志，此时会看到输出 圆周率值</span></span><br><span class="line">kubectl logs <span class="built_in">jobs</span>/pi</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>删除 Job</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete <span class="built_in">jobs</span>/pi</span><br><span class="line"></span><br><span class="line"><span class="comment"># yaml 删除</span></span><br><span class="line">kubectl delete -f job.yaml</span><br></pre></td></tr></table></figure><h2 id="CronJob-介绍">CronJob 介绍</h2><ul class="lvl-0"><li class="lvl-2"><p>CronJob(缩写为 cj) 通过重复调度启动一次性的 Job。</p></li><li class="lvl-2"><p>CronJob 用于执行排期操作，例如备份、生成报告等。</p></li><li class="lvl-2"><p>一个 CronJob 对象就像 Unix 系统上的 crontab（cron table）文件中的一行。 它用 Cron 格式进行编写， 并周期性地在给定的调度时间执行 Job。</p></li></ul><h3 id="CronJob-示例：">CronJob 示例：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: batch/v1</span><br><span class="line">kind: CronJob                               <span class="comment"># 创建CronJob</span></span><br><span class="line">metadata:</span><br><span class="line">  name: hello</span><br><span class="line">spec:</span><br><span class="line">  schedule: <span class="string">&quot;* * * * *&quot;</span>                     <span class="comment"># 每分钟执行一次，不支持时区设置</span></span><br><span class="line">  successfulJobsHistoryLimit: 3             <span class="comment"># 指定要保留多少成功完成的 Job。默认值为 3</span></span><br><span class="line">  failedJobsHistoryLimit: 1                 <span class="comment"># 指定要保留多少失败完成的 Job。默认值为 1</span></span><br><span class="line">  concurrencyPolicy: Allow                  <span class="comment"># 默认值为 Allow：允许多个 Job 同时运行</span></span><br><span class="line">                                            <span class="comment"># Forbid：不允许多个 Job 同时运行。如果新 Job 的执行时间到了而老 Job 没有执行完，CronJob 会忽略新 Job 的执行。 另请注意，当老 Job 执行完成时，仍然会考虑 .spec.startingDeadlineSeconds，可能会导致新的 Job 执行。</span></span><br><span class="line">                                            <span class="comment"># Replace：如果新 Job 的执行时间到了而老 Job 没有执行完，CronJob 会用新 Job 替换当前正在运行的 Job。</span></span><br><span class="line">  jobTemplate:</span><br><span class="line">    spec:</span><br><span class="line">      template:</span><br><span class="line">        spec:</span><br><span class="line">          containers:</span><br><span class="line">          - name: hello</span><br><span class="line">            image: busybox:1.28</span><br><span class="line">            imagePullPolicy: IfNotPresent</span><br><span class="line">            <span class="built_in">command</span>:</span><br><span class="line">            - /bin/sh</span><br><span class="line">            - -c</span><br><span class="line">            - <span class="built_in">date</span>; <span class="built_in">echo</span> Hello from the Kubernetes cluster</span><br><span class="line">          restartPolicy: OnFailure</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>.spec.schedule</code> 字段是必需的。该字段的值遵循 Cron 语法：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ┌───────────── 分钟 (0 - 59)</span></span><br><span class="line"><span class="comment"># │ ┌───────────── 小时 (0 - 23)</span></span><br><span class="line"><span class="comment"># │ │ ┌───────────── 月的某天 (1 - 31)</span></span><br><span class="line"><span class="comment"># │ │ │ ┌───────────── 月份 (1 - 12)</span></span><br><span class="line"><span class="comment"># │ │ │ │ ┌───────────── 周的某天 (0 - 6)（周日到周六）</span></span><br><span class="line"><span class="comment"># │ │ │ │ │                          或者是 sun，mon，tue，web，thu，fri，sat</span></span><br><span class="line"><span class="comment"># │ │ │ │ │</span></span><br><span class="line"><span class="comment"># │ │ │ │ │</span></span><br><span class="line"><span class="comment"># * * * * *</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 时间表中的问号 (?) 和星号 * 含义相同，它们用来表示给定字段的任何可用值。</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>除了标准语法，还可以使用一些类似 @monthly 的宏</p></li></ul><table><thead><tr><th><strong>输入</strong></th><th><strong>描述</strong></th><th><strong>等价 Cron 表达式</strong></th></tr></thead><tbody><tr><td><code>@yearly</code> 或 <code>@annually</code></td><td>每年 1 月 1 日的午夜运行一次</td><td><code>0 0 1 1 *</code></td></tr><tr><td><code>@monthly</code></td><td>每月第一天的午夜运行一次</td><td><code>0 0 1 * *</code></td></tr><tr><td><code>@weekly</code></td><td>每周的周日午夜运行一次</td><td><code>0 0 * * 0</code></td></tr><tr><td><code>@daily</code> 或 <code>@midnight</code></td><td>每天午夜运行一次</td><td><code>0 0 * * *</code></td></tr><tr><td><code>@hourly</code></td><td>每小时的开始运行一次</td><td><code>0 * * * *</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>管理cronjob</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建cronjob</span></span><br><span class="line">kubectl create -f cronjob.yaml</span><br><span class="line"><span class="comment"># 查看cronjob</span></span><br><span class="line">kubectl get cronjob hello -o yaml</span><br><span class="line"><span class="comment"># 删除cronjob</span></span><br><span class="line">kubectl delete cronjob hello</span><br><span class="line">k delete -f cronjob.yaml</span><br></pre></td></tr></table></figure><h2 id="以下是-Kubernetes-中-Job-和-CronJob-的对比表">以下是 Kubernetes 中 Job 和 CronJob 的对比表</h2><table><thead><tr><th>特性</th><th>Job</th><th>CronJob</th></tr></thead><tbody><tr><td><strong>用途</strong></td><td>一次性任务，完成即结束</td><td>定时周期性任务，按照时间计划定时运行</td></tr><tr><td><strong>调度方式</strong></td><td>手动创建或由控制器触发</td><td>按照 Cron 表达式自动周期性调度</td></tr><tr><td><strong>常用场景</strong></td><td>数据批处理、数据库迁移、一次性任务</td><td>每天备份、定时报告生成、周期性检查</td></tr><tr><td><strong>配置关键字段</strong></td><td><code>spec.template</code></td><td><code>spec.schedule</code>（Cron 表达式） + <code>spec.jobTemplate</code></td></tr><tr><td><strong>启动频率</strong></td><td>创建后立刻启动一次</td><td>根据 <code>schedule</code> 定期启动</td></tr><tr><td><strong>并发控制</strong></td><td>不支持并发策略</td><td>支持 <code>concurrencyPolicy</code>（Allow、Forbid、Replace）</td></tr><tr><td><strong>保留历史任务</strong></td><td>无保留，任务完成后直接终结</td><td>可配置保留成功或失败任务数：<code>successfulJobsHistoryLimit</code>、<code>failedJobsHistoryLimit</code></td></tr><tr><td><strong>失败重试机制</strong></td><td>支持 <code>backoffLimit</code>、<code>restartPolicy</code></td><td>同样支持，作用于每次周期性运行产生的 Job 上</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

引用本地其它文章连接{}
 大括号开始% post_link 文件名称(不包含.md) %大括号结束
 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍 K8S 的 Job/CronJob ，本文以 CentOS 8 为例。&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/&quot;&gt;K8S官网&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/kubernetes/kubernetes&quot;&gt;k8s Github&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/job/&quot;&gt;k8s Job 介绍&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/cron-jobs/&quot;&gt;k8s CronJob 介绍&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="k8s" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/k8s/"/>
    
    
    <category term="K8S" scheme="https://blog.hanqunfeng.com/tags/K8S/"/>
    
  </entry>
  
  <entry>
    <title>K8S 之 DaemonSet</title>
    <link href="https://blog.hanqunfeng.com/2025/07/15/k8s-daemonset/"/>
    <id>https://blog.hanqunfeng.com/2025/07/15/k8s-daemonset/</id>
    <published>2025-07-15T14:30:05.000Z</published>
    <updated>2025-07-20T13:47:46.590Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote %引用本地其它文章连接{} 大括号开始% post_link 文件名称(不包含.md) %大括号结束 --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍 K8S 的 DaemonSet ，本文以 CentOS 8 为例。</p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/">K8S官网</a></p></li><li class="lvl-2"><p><a href="https://github.com/kubernetes/kubernetes">k8s Github</a></p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/daemonset/">k8s DaemonSet 介绍</a></p></li></ul><span id="more"></span><h2 id="DaemonSet-介绍">DaemonSet 介绍</h2><ul class="lvl-0"><li class="lvl-2"><p>DaemonSet(缩写为 ds) 定义了提供节点本地设施的 Pod。这些设施可能对于集群的运行至关重要，例如网络辅助工具，或者作为 add-on 的一部分。</p></li><li class="lvl-2"><p>DaemonSet 确保全部（或者某些）节点上运行一个 Pod 的副本。 当有节点加入集群时， 也会为他们新增一个 Pod 。 当有节点从集群移除时，这些 Pod 也会被回收。删除 DaemonSet 将会删除它创建的所有 Pod。</p></li><li class="lvl-2"><p>DaemonSet 的一些典型用法：</p><ul class="lvl-2"><li class="lvl-4">在每个节点上运行集群守护进程</li><li class="lvl-4">在每个节点上运行日志收集守护进程</li><li class="lvl-4">在每个节点上运行监控守护进程</li></ul></li><li class="lvl-2"><p>DaemonSet 与 Deployment 的主要区别是：</p><ul class="lvl-2"><li class="lvl-4">无法自定义副本数量</li><li class="lvl-4">每个node上都会运行且只允许运行一个 Pod</li><li class="lvl-4">当有新Node加入集群时，会自动在其上部署并运行Pod副本，当Node从集群移除时，这些Pod也会被回收</li></ul></li></ul><h2 id="DaemonSet-管理">DaemonSet 管理</h2><h3 id="DaemonSet-创建">DaemonSet 创建</h3><ul class="lvl-0"><li class="lvl-2"><p>DaemonSet 只能 通过 <code>yaml</code> 创建，不支持 <code>create</code> 创建</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过 yaml 文件创建</span></span><br><span class="line">kubectl apply -f daemonset.yaml</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>一个简单的 <code>daemonset.yaml</code> 文件说明</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>                  <span class="comment"># 指定使用的 API 版本，这里是 apps/v1，适用于 DaemonSet 资源</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span>                     <span class="comment"># Kubernetes 资源类型，这里是部署（DaemonSet）</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span>                       <span class="comment"># 标签，用于标识资源，可与 selector 匹配</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span>                        <span class="comment"># 资源名称，必须唯一（在同一命名空间下）</span></span><br><span class="line"><span class="attr">spec:</span>                                <span class="comment"># 配置项</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span>           <span class="comment"># 保留的历史版本数，默认值为 10，Deployment 和 StatefulSet 都有这个配置项。回滚时有用。</span></span><br><span class="line">  <span class="attr">selector:</span>                          <span class="comment"># 选择器，指定要管理的 Pod</span></span><br><span class="line">    <span class="attr">matchLabels:</span>                     <span class="comment"># 标签选择器</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span>                     <span class="comment"># 选择器，指定 DaemonSet 管理哪些 Pod（标签必须与 template 中匹配）</span></span><br><span class="line">  <span class="attr">updateStrategy:</span>                    <span class="comment"># 更新策略，这里要注意这个更新策略与Deployment的属性名字不一样</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span>              <span class="comment"># 1.RollingUpdate：这是默认的更新策略。使用 RollingUpdate 更新策略时，在更新 DaemonSet 模板后， 老的 DaemonSet Pod 将被终止，并且将以受控方式自动创建新的 DaemonSet Pod。 更新期间，最多只能有 DaemonSet 的一个 Pod 运行于每个节点上。</span></span><br><span class="line">                                     <span class="comment"># 2.OnDelete：使用 OnDelete 更新策略时，在更新 DaemonSet 模板后，只有当你手动删除老的 DaemonSet Pod 之后，新的 DaemonSet Pod 才会被自动创建。</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span>                   <span class="comment"># 滚动升级的配置</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">0</span>                    <span class="comment"># 可以超出现有 DaemonSet Pod 的最大数或最大百分比，默认是 0。与 maxUnavailable 不能同时为 0</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">1</span>              <span class="comment"># 更新期间不可用的 DaemonSet Pod 的最大数或最大百分比，默认是 1。与 maxSurge 不能同时为 0</span></span><br><span class="line">  <span class="attr">template:</span>                          <span class="comment"># 模板，定义 Pod 的内容，具体可以参考 Pod 的配置</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span>                   <span class="comment"># Pod 的标签，必须与 selector 中的 matchLabels 一致</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span>                 <span class="comment"># 容器使用的镜像，这里是官方的 nginx 镜像</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span>                  <span class="comment"># 容器的名称</span></span><br></pre></td></tr></table></figure><h3 id="查看-DaemonSet">查看 DaemonSet</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 DaemonSet ，默认显示 default 命名空间下的 DaemonSet</span></span><br><span class="line">kubectl get daemonsets</span><br><span class="line">kubectl get ds <span class="comment"># 简称</span></span><br><span class="line"><span class="comment"># 查看 kube-system 命名空间下的 DaemonSet</span></span><br><span class="line">kubectl get ds -n kube-system</span><br><span class="line"><span class="comment"># 查看所有命名空间下的 DaemonSet</span></span><br><span class="line">kubectl get ds -A</span><br><span class="line"><span class="comment"># -o wide: 显示 deploy 的详细信息</span></span><br><span class="line">kubectl get ds -o wide</span><br><span class="line"><span class="comment"># 显示 DaemonSet 的标签</span></span><br><span class="line">kubectl get ds --show-labels</span><br><span class="line"><span class="comment"># 按 DaemonSet 的标签进程查询</span></span><br><span class="line">kubectl get ds -l &lt;label_name&gt;=&lt;label_value&gt;</span><br><span class="line"><span class="comment"># 持续查看 DaemonSet 的状态，当 DaemonSet 状态发生改变时，会实时显示</span></span><br><span class="line">kubectl get ds -w</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 pod、ds 的详细信息</span></span><br><span class="line">$ k get pod,ds -owide</span><br><span class="line">NAME              READY   STATUS    RESTARTS   AGE    IP              NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">pod/nginx-6g8j8   1/1     Running   0          9m3s   10.244.126.18   k8s-worker2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod/nginx-tnvhn   1/1     Running   0          9m3s   10.244.194.89   k8s-worker1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">NAME                   DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE    CONTAINERS   IMAGES   SELECTOR</span><br><span class="line">daemonset.apps/nginx   2         2         2       2            2           &lt;none&gt;          9m3s   nginx        nginx    app=nginx</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="允许-master-节点运行-pod">允许 master 节点运行 pod</h3><ul class="lvl-0"><li class="lvl-2"><p>上面看到pod只在worker1和worker2上运行,而没有在master节点上运行</p></li><li class="lvl-2"><p>默认情况下，Kubernetes 不允许在 master 节点上运行 Pod，这是因为master节点有污点</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe node k8s-master | grep Taints</span><br><span class="line">Taints:             node-role.kubernetes.io/control-plane:NoSchedule</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>为了能让pod运行在具有污点的节点上，我们需要为pod指定容忍度(tolerations)，实际上 DaemonSet 控制器会自动将一组容忍度添加到 DaemonSet Pod</p></li></ul><table><thead><tr><th>容忍度键名</th><th>效果</th><th>操作</th><th>描述</th></tr></thead><tbody><tr><td><code>node.kubernetes.io/not-ready</code></td><td><code>NoExecute</code></td><td>Exists</td><td>DaemonSet Pod 可以被调度到不健康或未就绪的节点上，且不会被驱逐。</td></tr><tr><td><code>node.kubernetes.io/unreachable</code></td><td><code>NoExecute</code></td><td>Exists</td><td>DaemonSet Pod 可以被调度到不可达的节点上，且不会被驱逐。</td></tr><tr><td><code>node.kubernetes.io/disk-pressure</code></td><td><code>NoSchedule</code></td><td>Exists</td><td>DaemonSet Pod 可以被调度到存在磁盘压力的节点上。</td></tr><tr><td><code>node.kubernetes.io/memory-pressure</code></td><td><code>NoSchedule</code></td><td>Exists</td><td>DaemonSet Pod 可以被调度到存在内存压力的节点上。</td></tr><tr><td><code>node.kubernetes.io/pid-pressure</code></td><td><code>NoSchedule</code></td><td>Exists</td><td>DaemonSet Pod 可以被调度到存在进程数压力的节点上。</td></tr><tr><td><code>node.kubernetes.io/unschedulable</code></td><td><code>NoSchedule</code></td><td>Exists</td><td>DaemonSet Pod 可以被调度到标记为不可调度的节点上。</td></tr><tr><td><code>node.kubernetes.io/network-unavailable</code></td><td><code>NoSchedule</code></td><td>Exists</td><td>针对 <code>spec.hostNetwork: true</code> 的 Pod，可以被调度到网络不可用的节点上。</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>增加可以运行在 master 节点的容忍度</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">tolerations:</span>                                   <span class="comment"># 增加容忍度</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;node-role.kubernetes.io/control-plane&quot;</span> <span class="comment"># 容忍控制平面节点</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span>                           <span class="comment"># 操作符</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span>                         <span class="comment"># 污点标签</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>增加容忍度后重新运行</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f daemonset.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">$ k get pod,ds -o wide</span><br><span class="line">NAME              READY   STATUS    RESTARTS   AGE   IP               NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">pod/nginx-4gxwh   1/1     Running   0          79m   10.244.235.205   k8s-master    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod/nginx-gx7tf   1/1     Running   0          78m   10.244.126.21    k8s-worker2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod/nginx-sl8cc   1/1     Running   0          78m   10.244.194.92    k8s-worker1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">NAME                   DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE     CONTAINERS   IMAGES   SELECTOR</span><br><span class="line">daemonset.apps/nginx   3         3         3       3            3           &lt;none&gt;          3h42m   nginx        nginx    app=nginx</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>实际上 daemonset 创建的 pod 同样支持 nodeName，nodeSelector,affinity 等调度策略</p></li></ul><h3 id="访问pod中的nginx服务">访问pod中的nginx服务</h3><ul class="lvl-0"><li class="lvl-2"><p>此时我们还没有创建 <code>Service</code>(后面章节会介绍)，所以只能通过 Pod 的 IP 访问</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 任意pod的IP，端口80</span></span><br><span class="line">curl http://10.244.194.92</span><br></pre></td></tr></table></figure><h3 id="查看-DaemonSet-详情">查看 DaemonSet 详情</h3><ul class="lvl-0"><li class="lvl-2"><p>当 DaemonSet 运行错误时，可以通过该命令查看 DaemonSet 的详情，找到错误原因</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe ds &lt;ds-name&gt;</span><br><span class="line">kubectl describe ds &lt;ds-name&gt; -n &lt;namespace-name&gt;</span><br></pre></td></tr></table></figure><h3 id="删除-DaemonSet">删除 DaemonSet</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete ds &lt;ds-name&gt;</span><br><span class="line">kubectl delete ds &lt;ds-name&gt; -n &lt;namespace-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过 yaml 文件删除</span></span><br><span class="line">kubectl delete -f &lt;yaml-file&gt;</span><br></pre></td></tr></table></figure><h3 id="查看-DaemonSet-日志">查看 DaemonSet 日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs ds/&lt;ds-name&gt;</span><br><span class="line">kubectl logs ds/&lt;ds-name&gt; -n &lt;namespace-name&gt;</span><br></pre></td></tr></table></figure><h3 id="滚动升级与回滚-DaemonSet">滚动升级与回滚 DaemonSet</h3><ul class="lvl-0"><li class="lvl-2"><p>对 <code>RollingUpdate</code> 类型的 <code>DaemonSet</code> 的 <code>.spec.template</code> 的任何更新都将触发滚动更新。</p></li><li class="lvl-2"><p>我们修改过 <code>DaemonSet</code> 的 <code>.spec.template</code>，并保存后，重新运行 <code>kubectl apply -f &lt;yaml-file&gt;</code>即可触发滚动升级。</p></li><li class="lvl-2"><p>如果只是更新容器的镜像，也可以通过如下命令触发滚动升级</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl set image ds/&lt;ds-name&gt; &lt;container-name&gt;=&lt;image&gt;:&lt;tag&gt; --record=true</span></span><br><span class="line">kubectl <span class="built_in">set</span> image ds nginx nginx=nginx:1.9.1 --record=<span class="literal">true</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>查看滚动升级状态</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl rollout status ds/&lt;ds-name&gt;</span></span><br><span class="line">kubectl rollout status ds nginx</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>查看历史版本</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 前面的序号表示版本号</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> ds nginx</span><br><span class="line"><span class="comment"># 查看指定版本的详情</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> ds nginx --revision=1</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>回滚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 回退到前一个版本</span></span><br><span class="line">kubectl rollout undo ds nginx</span><br><span class="line"><span class="comment"># 回到指定版本，这里 --to-revision=1 表示回到版本1</span></span><br><span class="line">kubectl rollout undo ds nginx --to-revision=1</span><br></pre></td></tr></table></figure><h2 id="Deployment-和-DaemonSet-的对比总结">Deployment 和 DaemonSet 的对比总结</h2><table><thead><tr><th>特性</th><th><strong>Deployment</strong></th><th><strong>DaemonSet</strong></th></tr></thead><tbody><tr><td><strong>用途</strong></td><td>管理一组可水平扩展的 Pod，按需副本数运行</td><td>在每个（或特定）节点上运行 <strong>一个副本</strong> 的 Pod</td></tr><tr><td><strong>常见场景</strong></td><td>无状态服务、Web 服务、API、后端服务</td><td>日志采集（如 fluentd）、监控（如 node-exporter）、系统守护进程</td></tr><tr><td><strong>副本控制</strong></td><td>可通过 <code>spec.replicas</code> 灵活控制副本数</td><td>每个匹配的节点自动运行一个 Pod，无需设置 <code>replicas</code></td></tr><tr><td><strong>节点分布</strong></td><td>Pod 分布随机，调度器选择可用节点</td><td>Pod 分布固定，<strong>每个匹配节点必跑一个 Pod</strong></td></tr><tr><td><strong>更新策略</strong></td><td><code>RollingUpdate</code>（默认）、<code>Recreate</code>，支持回滚</td><td><code>RollingUpdate</code>（默认从 Kubernetes 1.6 起支持）</td></tr><tr><td><strong>伸缩方式</strong></td><td><code>kubectl scale deployment</code> 可以水平扩缩容</td><td><strong>不支持手动伸缩</strong>，跟随节点变化自动伸缩</td></tr><tr><td><strong>Pod 更新行为</strong></td><td>按策略滚动更新全部副本</td><td>每个节点上的 Pod 逐个滚动更新</td></tr><tr><td><strong>调度策略</strong></td><td>通过调度器分配节点，可搭配 <code>affinity</code> 使用</td><td>默认调度所有节点，可用 <code>nodeSelector</code>、<code>affinity</code>、<code>taints</code> 控制</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

引用本地其它文章连接{}
 大括号开始% post_link 文件名称(不包含.md) %大括号结束
 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍 K8S 的 DaemonSet ，本文以 CentOS 8 为例。&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/&quot;&gt;K8S官网&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/kubernetes/kubernetes&quot;&gt;k8s Github&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/daemonset/&quot;&gt;k8s DaemonSet 介绍&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="k8s" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/k8s/"/>
    
    
    <category term="K8S" scheme="https://blog.hanqunfeng.com/tags/K8S/"/>
    
  </entry>
  
  <entry>
    <title>K8S 之 Deployment</title>
    <link href="https://blog.hanqunfeng.com/2025/07/14/k8s-deployment/"/>
    <id>https://blog.hanqunfeng.com/2025/07/14/k8s-deployment/</id>
    <published>2025-07-14T14:30:05.000Z</published>
    <updated>2025-07-20T13:46:29.512Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote %引用本地其它文章连接{} 大括号开始% post_link 文件名称(不包含.md) %大括号结束 --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍 K8S 的 Deployment，本文以 CentOS 8 为例。</p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/">K8S官网</a></p></li><li class="lvl-2"><p><a href="https://github.com/kubernetes/kubernetes">k8s Github</a></p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/">k8s Deployment 介绍</a></p></li></ul><span id="more"></span><h2 id="Deployment-缩写为-deploy-介绍">Deployment(缩写为 deploy) 介绍</h2><ul class="lvl-0"><li class="lvl-2"><p>在使用k8s创建容器时，我们一般不会直接创建pod，而是创建 deployment，daemonSet，StatefulSet等等。</p></li><li class="lvl-2"><p>Deployment 用于管理运行一个应用负载的一组 Pod，通常适用于不保持状态的负载。</p></li><li class="lvl-2"><p>Deployment 是最常用的无状态服务控制器，由Deployment、ReplicaSet、Pod组成、支持集群扩容缩容、滚动、更新、自动维护Pod可用性及副本数量等功能，<a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/replicaset/">ReplicaSet</a>和Pod由Deployment自动管理，用户无需干预，也就是说，创建一个Deployment后，K8S会自动创建ReplicaSet，并创建指定数量的Pod。<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/Tcj2Px.png" alt="" width="1200" height="600"></p></li></ul><h2 id="Deployment-管理">Deployment 管理</h2><h3 id="Deployment-创建">Deployment 创建</h3><ul class="lvl-0"><li class="lvl-2"><p><code>create</code> 创建</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 deployment</span></span><br><span class="line">kubectl create deployment nginx --image=nginx</span><br><span class="line"><span class="comment"># 多副本，--replicas=3 创建3个副本</span></span><br><span class="line">kubectl create deployment nginx --image=nginx --replicas=3</span><br><span class="line"><span class="comment"># -o 生成 yaml 文件, --dry-run: 不真的执行创建</span></span><br><span class="line">kubectl create deployment nginx --image=nginx --replicas=3 --dry-run=client -o yaml &gt; deployment.yaml</span><br><span class="line"><span class="comment"># 通过 yaml 文件创建</span></span><br><span class="line">kubectl apply -f deployment.yaml</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>一个简单的 <code>deployment.yaml</code> 文件说明</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span>                  <span class="comment"># 指定使用的 API 版本，这里是 apps/v1，适用于 Deployment 资源</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span>                     <span class="comment"># Kubernetes 资源类型，这里是部署（Deployment）</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span>                       <span class="comment"># 标签，用于标识资源，可与 selector 匹配</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span>                        <span class="comment"># 资源名称，必须唯一（在同一命名空间下）</span></span><br><span class="line"><span class="attr">spec:</span>                                <span class="comment"># 配置项</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span>                        <span class="comment"># 副本数，表示希望运行多少个 Pod 实例</span></span><br><span class="line">  <span class="attr">selector:</span>                          <span class="comment"># 选择器，指定要管理的 Pod</span></span><br><span class="line">    <span class="attr">matchLabels:</span>                     <span class="comment"># 标签选择器</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span>                     <span class="comment"># 选择器，指定 Deployment 管理哪些 Pod（标签必须与 template 中匹配）</span></span><br><span class="line">  <span class="attr">strategy:</span>                          <span class="comment"># 用新Pod替换现有Pod的部署策略，可省略，默认就是滚动更新</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span>              <span class="comment"># 默认为滚动更新策略，还可以设置为 Recreate：在创建新pod之前，先删除所有现有的pod</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span>                   <span class="comment"># 滚动更新方式，type: RollingUpdate 时有效</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">30</span><span class="string">%</span>                  <span class="comment"># 最大额外可以存在的副本数，可以为百分比，也可以为整数，默认为 25%</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">30</span><span class="string">%</span>            <span class="comment"># 最大不可用状态的 Pod 的最大值，可以为百分比，也可以为整数，默认为 25%</span></span><br><span class="line">  <span class="attr">template:</span>                          <span class="comment"># 模板，定义 Pod 的内容，具体可以参考 Pod 的配置</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span>                   <span class="comment"># Pod 的标签，必须与 selector 中的 matchLabels 一致</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span>                 <span class="comment"># 容器使用的镜像，这里是官方的 nginx 镜像</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span>                  <span class="comment"># 容器的名称</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要新了解的配置项就是spec下面几个选项：</span></span><br><span class="line"><span class="comment"># replicas：指定副本数量，其实就是当前rs创建出来的pod的数量，默认为1</span></span><br><span class="line"><span class="comment"># selector：选择器，它的作用是建立pod控制器和pod之间的关联关系，采用的Label Selector机制，在pod模板上定义label，在控制器上定义选择器，就可以表明当前控制器能管理哪些pod了</span></span><br><span class="line"><span class="comment"># template：模板，就是当前控制器创建pod所使用的模板，里面其实就是前一章学过的pod的定义</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>获取 deployment 的 yaml 文件配置项帮助</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 比如，这里查看用新Pod替换现有Pod的部署策略</span></span><br><span class="line">$ kubectl explain deployment.spec.strategy</span><br><span class="line"><span class="comment">## 输出结果</span></span><br><span class="line">DESCRIPTION:</span><br><span class="line">    The deployment strategy to use to replace existing pods with new ones.</span><br><span class="line">    DeploymentStrategy describes how to replace existing pods with new ones.</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">  rollingUpdate&lt;RollingUpdateDeployment&gt;</span><br><span class="line">    Rolling update config params. Present only <span class="keyword">if</span> DeploymentStrategyType =</span><br><span class="line">    RollingUpdate.</span><br><span class="line"></span><br><span class="line">  <span class="built_in">type</span>&lt;string&gt;</span><br><span class="line">  enum: Recreate, RollingUpdate</span><br><span class="line">    Type of deployment. Can be <span class="string">&quot;Recreate&quot;</span> or <span class="string">&quot;RollingUpdate&quot;</span>. Default is</span><br><span class="line">        RollingUpdate.</span><br><span class="line"></span><br><span class="line">        Possible enum values:</span><br><span class="line">        <span class="comment"># 在创建新pod之前，先删除所有现有的pod</span></span><br><span class="line">        - `<span class="string">&quot;Recreate&quot;</span>` Kill all existing pods before creating new ones.</span><br><span class="line">        <span class="comment"># 使用滚动更新方式用新的 ReplicaSet 替换旧的 ReplicaSet更新，即逐步缩减旧的ReplicaSet并扩大新的ReplicaSet</span></span><br><span class="line">        - `<span class="string">&quot;RollingUpdate&quot;</span>` Replace the old ReplicaSets by new one using rolling update i.e gradually scale down the old ReplicaSets and scale up the new one.</span><br></pre></td></tr></table></figure><div class="tips"><p><em><strong>小贴士</strong></em></p><ul class="lvl-1"><li class="lvl-2">yaml 文件中，出现了 <code>metadata.labels</code>,<code>spec.selector.matchLabels</code> 以及 <code>template.metadata.labels</code>，三者是什么关系？</li></ul><ol><li class="lvl-3">metadata.labels（Deployment 的标签）</li></ol><blockquote><p>给 Deployment 本身 打的标签, 和 Pod 没有直接管理关系<br>常用于资源分组、查找（比如：kubectl get deploy -l app=nginx）</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span>   <span class="comment"># 属于这个 Deployment 的“标签”，只是标识它自己</span></span><br></pre></td></tr></table></figure><ol start="2"><li class="lvl-3"><p>spec.selector.matchLabels（选择器）</p></li></ol><blockquote><p>指定 Deployment 要管理哪些 Pod<br>必须精确匹配 Pod 的标签<br>决定 Deployment 会不会“接管”某些 Pod</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure><ol start="3"><li class="lvl-3"><p>template.metadata.labels（模板中的 Pod 标签）</p></li></ol><blockquote><p>Pod 模板中定义的标签<br>Deployment 按这个模板创建 Pod<br>必须与 matchLabels 完全一致，否则会报错</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">template:</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span>   <span class="comment"># Pod 的标签，必须与 selector 匹配！</span></span><br></pre></td></tr></table></figure><p>🔁 关系图示意：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Deployment</span></span><br><span class="line"><span class="string">│</span></span><br><span class="line"><span class="string">├─</span> <span class="string">metadata.labels</span>                <span class="string">←</span> <span class="string">Deployment</span> <span class="string">本身的标签（非关键）</span></span><br><span class="line"><span class="string">│</span></span><br><span class="line"><span class="string">├─</span> <span class="string">spec.selector.matchLabels</span> <span class="string">─┐</span></span><br><span class="line"><span class="string">│</span>                             <span class="string">│</span></span><br><span class="line"><span class="string">└─</span> <span class="string">spec.template.metadata.labels</span> <span class="string">←</span> <span class="string">必须匹配</span> <span class="string">selector，才能让</span> <span class="string">Pod</span> <span class="string">被</span> <span class="string">Deployment</span> <span class="string">管理</span></span><br></pre></td></tr></table></figure></div><h3 id="Deployment-扩缩容">Deployment 扩缩容</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 扩容到5个，原先有3个，这里会再创建2个</span></span><br><span class="line">kubectl scale deployment nginx --replicas=5</span><br><span class="line"><span class="comment"># 缩容到3个，原先有5个，这里会删除2个</span></span><br><span class="line">kubectl scale deployment nginx --replicas=3</span><br></pre></td></tr></table></figure><h3 id="查看-Deployment">查看 Deployment</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 Deployment ，默认显示 default 命名空间下的 deployments</span></span><br><span class="line">kubectl get deployments</span><br><span class="line">kubectl get deploy <span class="comment"># 简称</span></span><br><span class="line"><span class="comment"># 查看 kube-system 命名空间下的 Deployment</span></span><br><span class="line">kubectl get deploy -n kube-system</span><br><span class="line"><span class="comment"># 查看所有命名空间下的 Deployment</span></span><br><span class="line">kubectl get deploy -A</span><br><span class="line"><span class="comment"># -o wide: 显示 deploy 的详细信息</span></span><br><span class="line">kubectl get deployments -o wide</span><br><span class="line"><span class="comment"># 显示 Deployment 的标签</span></span><br><span class="line">kubectl get deploy --show-labels</span><br><span class="line"><span class="comment"># 按 Deployment 的标签进程查询</span></span><br><span class="line">kubectl get deploy -l &lt;label_name&gt;=&lt;label_value&gt;</span><br><span class="line"><span class="comment"># 持续查看 Deployment 的状态，当 Deployment 状态发生改变时，会实时显示</span></span><br><span class="line">kubectl get deploy -w</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 pod、deploy、replicaset</span></span><br><span class="line">$ k get pod,deploy,rs -owide</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE    IP              NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">pod/nginx-5869d7778c-4sqwf   1/1     Running   0          105s   10.244.126.11   k8s-worker2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod/nginx-5869d7778c-kn6pg   1/1     Running   0          105s   10.244.126.12   k8s-worker2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod/nginx-5869d7778c-zkwkd   1/1     Running   0          18m    10.244.194.82   k8s-worker1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">NAME                    READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES   SELECTOR</span><br><span class="line">deployment.apps/nginx   3/3     3            3           18m   nginx        nginx    app=nginx</span><br><span class="line"></span><br><span class="line">NAME                               DESIRED   CURRENT   READY   AGE   CONTAINERS   IMAGES   SELECTOR</span><br><span class="line">replicaset.apps/nginx-5869d7778c   3         3         3       18m   nginx        nginx    app=nginx,pod-template-hash=5869d7778c</span><br></pre></td></tr></table></figure><h3 id="访问pod中的nginx服务">访问pod中的nginx服务</h3><ul class="lvl-0"><li class="lvl-2"><p>此时我们还没有创建 <code>Service</code>(后面章节会介绍)，所以只能通过 Pod 的 IP 访问</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 任意pod的IP，端口80</span></span><br><span class="line">curl http://10.244.194.82</span><br></pre></td></tr></table></figure><h3 id="查看-Deployment-详情">查看 Deployment 详情</h3><ul class="lvl-0"><li class="lvl-2"><p>当 Deployment 运行错误时，可以通过该命令查看 Deployment 的详情，找到错误原因</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe deploy &lt;deploy-name&gt;</span><br><span class="line">kubectl describe deploy &lt;deploy-name&gt; -n &lt;namespace-name&gt;</span><br></pre></td></tr></table></figure><h3 id="删除-Deployment">删除 Deployment</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete deploy &lt;deploy-name&gt;</span><br><span class="line">kubectl delete deploy &lt;deploy-name&gt; -n &lt;namespace-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过 yaml 文件删除</span></span><br><span class="line">kubectl delete -f &lt;yaml-file&gt;</span><br></pre></td></tr></table></figure><h3 id="查看-Deployment-日志">查看 Deployment 日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs deploy/&lt;deploy-name&gt;</span><br><span class="line">kubectl logs deploy/&lt;deploy-name&gt; -n &lt;namespace-name&gt;</span><br></pre></td></tr></table></figure><h3 id="滚动升级与回滚-Deployment">滚动升级与回滚 Deployment</h3><ul class="lvl-0"><li class="lvl-2"><p>对 <code>RollingUpdate</code> 类型的 <code>Deployment</code> 的 <code>.spec.template</code> 的任何更新都将触发滚动更新。</p></li><li class="lvl-2"><p>我们修改过 <code>Deployment</code> 的 <code>.spec.template</code>，并保存后，重新运行 <code>kubectl apply -f &lt;yaml-file&gt;</code>即可触发滚动升级。</p></li><li class="lvl-2"><p>通过<code>kubectl edit deploy &lt;deploy-name&gt;</code>修改<code>.spec.template</code>，也会触发滚动升级。</p></li><li class="lvl-2"><p>如果只是更新容器的镜像，也可以通过如下命令触发滚动升级</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set image: 这里表示要改变的是镜像， --record=true 表示记录此次操作</span></span><br><span class="line"><span class="comment"># kubectl set image deploy &lt;deploy-name&gt; &lt;container-name&gt;=&lt;image-name&gt;:&lt;tag&gt;</span></span><br><span class="line">kubectl <span class="built_in">set</span> image deploy nginx nginx=nginx:1.9.1 --record=<span class="literal">true</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>查看历史版本</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 前面的序号表示版本号</span></span><br><span class="line">$ kubectl rollout <span class="built_in">history</span> deploy nginx</span><br><span class="line">deployment.apps/nginx</span><br><span class="line">REVISION  CHANGE-CAUSE</span><br><span class="line">1         &lt;none&gt;</span><br><span class="line">2         kubectl <span class="built_in">set</span> image deploy nginx nginx=nginx:1.9.1 --record=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看指定版本的详情</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> deploy nginx --revision=1</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>查看更新状态</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout status deploy nginx</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>回滚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 回退到前一个版本</span></span><br><span class="line">kubectl rollout undo deploy nginx</span><br><span class="line"><span class="comment"># 回到指定版本，这里 --to-revision=1 表示回到版本1</span></span><br><span class="line">kubectl rollout undo deploy nginx --to-revision=1</span><br></pre></td></tr></table></figure><h3 id="重启-Deployment">重启 Deployment</h3><ul class="lvl-0"><li class="lvl-2"><p>滚动重启</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl rollout restart deployment &lt;deployment-name&gt; -n &lt;namespace&gt;</span></span><br><span class="line">kubectl rollout restart deploy nginx</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

引用本地其它文章连接{}
 大括号开始% post_link 文件名称(不包含.md) %大括号结束
 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍 K8S 的 Deployment，本文以 CentOS 8 为例。&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/&quot;&gt;K8S官网&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/kubernetes/kubernetes&quot;&gt;k8s Github&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/&quot;&gt;k8s Deployment 介绍&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="k8s" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/k8s/"/>
    
    
    <category term="K8S" scheme="https://blog.hanqunfeng.com/tags/K8S/"/>
    
  </entry>
  
  <entry>
    <title>K8S 之 Pod</title>
    <link href="https://blog.hanqunfeng.com/2025/07/04/k8s-pod/"/>
    <id>https://blog.hanqunfeng.com/2025/07/04/k8s-pod/</id>
    <published>2025-07-04T14:30:05.000Z</published>
    <updated>2025-07-20T13:50:08.506Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote %引用本地其它文章连接{} 大括号开始% post_link 文件名称(不包含.md) %大括号结束 --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍 K8S 的 Pod，本文以 CentOS 8 为例。</p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/">K8S官网</a></p></li><li class="lvl-2"><p><a href="https://github.com/kubernetes/kubernetes">k8s Github</a></p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/">k8s Pod 介绍</a></p></li></ul><span id="more"></span><h2 id="Pod-介绍">Pod 介绍</h2><ul class="lvl-0"><li class="lvl-2"><p>Pod(缩写为 po) 是可以在 Kubernetes 中创建和管理的、最小的可部署的计算单元。</p></li><li class="lvl-2"><p>Pod（就像在豌豆荚中）是一组（一个或多个） 容器，这些容器共享存储、网络、以及怎样运行这些容器的规约。</p></li><li class="lvl-2"><p>Pod 中的内容总是并置（colocated）的并且一同调度，在共享的上下文中运行。</p></li><li class="lvl-2"><p>Kubernetes 集群中的 Pod 主要有两种用法：</p><ul class="lvl-2"><li class="lvl-4">运行单个容器的 Pod: &quot;每个 Pod 一个容器&quot;模型是最常见的 Kubernetes 用例，在这种情况下，可以将 Pod 看作单个容器的包装器，并且 Kubernetes 直接管理 Pod，而不是容器。</li><li class="lvl-4">运行多个协同工作的容器的 Pod: Pod 可以封装由紧密耦合且需要共享资源的多个并置容器组成的应用，这些位于同一位置的容器构成一个内聚单元。<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/nLmg0X.png" alt=""></li></ul></li></ul><h2 id="Pod-管理">Pod 管理</h2><h3 id="Pod-创建">Pod 创建</h3><ul class="lvl-0"><li class="lvl-2"><p><code>run</code> 创建</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl run nginx --image=nginx</span><br><span class="line"><span class="comment"># 输出 yaml</span></span><br><span class="line">kubectl run nginx --image=nginx --dry-run=client -o yaml &gt; pod.yaml</span><br><span class="line"><span class="comment"># 通过 yaml 文件创建</span></span><br><span class="line">kubectl apply -f pod.yaml</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>pod 中至少包含两个容器，一个是业务容器，比如这里的 nginx，另一个是 <code>pause</code> 容器，负责共享容器的网络，进程，存储等资源。</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过 crictl ps 是看不到 pause 容器的，我们可以使用 ctr 命令查看，ctr 是 containerd 的命令行工具</span></span><br><span class="line">ctr --namespace=k8s.io c <span class="built_in">ls</span></span><br><span class="line"><span class="comment"># 查看容器所属的pod</span></span><br><span class="line">ctr --namespace=k8s.io c info &lt;container-id&gt; | grep <span class="string">&#x27;pod.name&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="pod-yaml-文件说明"><code>pod.yaml</code> 文件说明</h3><ul class="lvl-0"><li class="lvl-2"><p>因为 Pod 不支持扩缩容，所以日常使用时一般不会直接创建 Pod，而是创建 <code>Deployment</code>, <code>DaemonSet</code>等这些工作负载资源，这些后面会介绍到。</p></li><li class="lvl-2"><p>但我们这里还是要重点介绍一下 Pod 的 yaml 文件格式，因为它是后面所有资源创建的基础。</p></li><li class="lvl-2"><p>一个最基础的 Pod 配置如下：</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span>                   <span class="comment"># 必填。指定使用的 API 版本，Pod 是核心资源，使用 v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span>                        <span class="comment"># 必填。资源类型：Pod</span></span><br><span class="line"><span class="attr">metadata:</span>                        <span class="comment"># 必填。元数据，包含 Pod 的名称、命名空间、标签、注解等信息</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span>                    <span class="comment"># 必填。Pod 的名称，命名空间中唯一</span></span><br><span class="line"><span class="attr">spec:</span>                            <span class="comment"># 必填。资源的特性描述（规约），定义Pod具体行为的部分</span></span><br><span class="line">  <span class="attr">containers:</span>                    <span class="comment"># 必填。容器列表</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span>                 <span class="comment"># 必填。容器使用的镜像</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span>                  <span class="comment"># 必填。容器名称，在同一个 Pod 内必须唯一</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>Pod是用来配置容器的，我们在学习docker时知道，容器有非常多的配置项，比如端口、网络、存储等，而 pod 的配置项更丰富。</p></li><li class="lvl-2"><p>一个Pod的配置主要包含两大部分：<code>metadata</code> 和 <code>spec</code>，每一项中包含的配置项非常多，这里只对常用的配置项进行说明，若要查看每个配置项的说明可以通过如下命令获取：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pod开头，配置项以 . 连接，例如：</span></span><br><span class="line">kubectl explain pod.metadata</span><br><span class="line">kubectl explain pod.metadata.labels</span><br><span class="line">kubectl explain pod.spec</span><br><span class="line">kubectl explain pod.spec.containers</span><br><span class="line">kubectl explain pod.spec.containers.ports</span><br></pre></td></tr></table></figure><h4 id="metadata">metadata</h4><ul class="lvl-0"><li class="lvl-2"><p>metadata 是 Pod 的元数据，比如 Pod 的名称、命名空间、标签、注解等。</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">metadata:</span>                 <span class="comment"># 元数据部分</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-pod</span>         <span class="comment"># Pod 的名称</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span>      <span class="comment"># Pod 所在的命名空间，默认是 default</span></span><br><span class="line">  <span class="attr">labels:</span>                 <span class="comment"># 标签，用于选择器、管理、分组</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">annotations:</span>            <span class="comment"># 注解，用于添加非结构化元信息</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">&quot;A sample pod for demonstration&quot;</span></span><br></pre></td></tr></table></figure><h4 id="spec">spec</h4><ul class="lvl-0"><li class="lvl-2"><p>spec 描述了 Pod 的配置信息，包括 Pod 的容器、存储、网络、资源限制、调度策略等</p></li></ul><h5 id="spec-containers">spec.containers</h5><ul class="lvl-0"><li class="lvl-2"><p>containers 描述了 Pod 中容器的配置信息，包括镜像、启动命令、环境变量、资源限制、卷挂载等</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span>                      <span class="comment">#必选，Pod中容器的详细定义</span></span><br><span class="line">  <span class="attr">containers:</span>              <span class="comment">#必选，Pod中容器列表</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span>           <span class="comment">#必选，容器名称</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">string</span>          <span class="comment">#必选，容器的镜像名称</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> [ <span class="string">Always|Never|IfNotPresent</span> ]   <span class="comment">#获取镜像的策略，当镜像标签为 latest 时默认值为 Always，否则为 IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">string</span>]      <span class="comment">#容器的启动命令列表，如不指定，使用打包时使用的启动命令</span></span><br><span class="line">    <span class="attr">args:</span> [<span class="string">string</span>]         <span class="comment">#容器的启动命令参数列表</span></span><br><span class="line">    <span class="attr">workingDir:</span> <span class="string">string</span>     <span class="comment">#容器的工作目录，如果为指定，则默认为镜像中的配置</span></span><br><span class="line">    <span class="attr">volumeMounts:</span>          <span class="comment">#挂载到容器内部的存储卷配置</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span>         <span class="comment">#引用pod定义的共享存储卷的名称，需用volumes[]部分定义的的卷名</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">string</span>    <span class="comment">#存储卷在容器内mount的绝对路径，应少于512字符</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="string">boolean</span>    <span class="comment">#是否为只读模式</span></span><br><span class="line">    <span class="attr">ports:</span>                 <span class="comment">#需要暴露的端口库号列表</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span>         <span class="comment">#端口的名称</span></span><br><span class="line">      <span class="attr">containerPort:</span> <span class="number">80</span>    <span class="comment">#容器需要监听的端口号</span></span><br><span class="line">      <span class="attr">hostPort:</span> <span class="string">int</span>        <span class="comment">#容器所在主机需要监听的端口号，默认与Container相同</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">string</span>     <span class="comment">#端口协议，支持TCP和UDP，默认TCP</span></span><br><span class="line">    <span class="attr">env:</span>                   <span class="comment">#容器运行前需设置的环境变量列表</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span>         <span class="comment">#环境变量名称</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">string</span>        <span class="comment">#环境变量的值</span></span><br><span class="line">    <span class="attr">resources:</span>             <span class="comment">#资源限制和请求的设置</span></span><br><span class="line">      <span class="attr">limits:</span>              <span class="comment">#资源限制的设置(上限)</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">string</span>        <span class="comment">#Cpu的限制，单位为core数，将用于docker run --cpu-shares参数</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">string</span>     <span class="comment">#内存限制，单位可以为Mib/Gib，将用于docker run --memory参数</span></span><br><span class="line">      <span class="attr">requests:</span>            <span class="comment">#资源请求的设置(下限)</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">string</span>        <span class="comment">#Cpu请求，容器启动的初始可用数量</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">string</span>     <span class="comment">#内存请求,容器启动的初始可用数量</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>示例</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span>                         <span class="comment"># Pod 的具体规范</span></span><br><span class="line">  <span class="attr">containers:</span>                 <span class="comment"># Pod 中的容器数组，可以有多个容器</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp-container</span>   <span class="comment"># 容器名称</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:1.25</span>       <span class="comment"># 使用的镜像</span></span><br><span class="line">      <span class="attr">ports:</span>                  <span class="comment"># 容器开放的端口</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span>   <span class="comment"># 容器内部端口，只是声明性的字段，不具有决定作用</span></span><br><span class="line">      <span class="attr">env:</span>                    <span class="comment"># 环境变量配置</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ENVIRONMENT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">production</span></span><br><span class="line">      <span class="attr">resources:</span>              <span class="comment"># 资源限制和请求</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">&quot;512Mi&quot;</span>     <span class="comment"># 最大内存限制</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span>            <span class="comment"># 最大 CPU 核心数，这里是 1 核</span></span><br><span class="line">          <span class="comment"># cpu: 1000m        # 1000m = 1 核</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">&quot;256Mi&quot;</span>     <span class="comment"># 初始分配内存</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">&quot;0.5&quot;</span>          <span class="comment"># 初始分配 CPU, 这里0.5 表示 0.5 核</span></span><br><span class="line">          <span class="comment"># cpu: 500m           # 500 毫核，也就是 0.5 核</span></span><br><span class="line">      <span class="attr">volumeMounts:</span>           <span class="comment"># 挂载到容器的卷</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app-storage</span>   <span class="comment"># 卷名称，需要和 volumes 中定义的卷名称一致</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span> <span class="comment"># 挂载到容器的目录</span></span><br></pre></td></tr></table></figure><h5 id="spec-containers-command-args">spec.containers.command | args</h5><ul class="lvl-0"><li class="lvl-2"><p>容器启动时执行的命令</p></li><li class="lvl-2"><p>默认情况下，容器启动时，会从镜像中获取命令并执行，如果这里配置了命令，则容器启动时，会执行这里的命令，而不是镜像中的命令</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:1.36</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;while true; do echo hello; sleep 10;done&quot;</span>]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>或者</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:1.36</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&quot;while true; do echo hello; sleep 10;done&quot;</span>]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>或者</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox:1.36</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">|</span>                  <span class="comment"># 使用 | 符号，表示多行输入</span></span><br><span class="line">        <span class="string">while</span> <span class="literal">true</span><span class="string">;</span> <span class="string">do</span></span><br><span class="line">          <span class="string">echo</span> <span class="string">&quot;hello world&quot;</span></span><br><span class="line">          <span class="string">sleep</span> <span class="number">5</span></span><br><span class="line">        <span class="string">done</span></span><br></pre></td></tr></table></figure><h5 id="spec-restartPolicy">spec.restartPolicy</h5><ul class="lvl-0"><li class="lvl-2"><p>指在系统发生故障或意外停机时，系统或应用程序如何处理和恢复的策略</p><ul class="lvl-2"><li class="lvl-4">Always：总是重启</li><li class="lvl-4">OnFailure：失败时重启</li><li class="lvl-4">Never：不重启</li></ul></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span> <span class="comment">#失败时重启</span></span><br></pre></td></tr></table></figure><h4 id="spec-terminationGracePeriodSeconds">spec.terminationGracePeriodSeconds</h4><ul class="lvl-0"><li class="lvl-2"><p>Pod 删除时，系统给 Pod 留的时间，用于完成清理工作</p></li><li class="lvl-2"><p>宽限期为避免服务突然中断,造成事物不一致的问题,当容器运行完自己的任务后,会等待一段时间,然后优雅的退出</p></li><li class="lvl-2"><p>默认值为 30s，单位为秒</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">60</span></span><br></pre></td></tr></table></figure><h4 id="spec-volumes">spec.volumes</h4><ul class="lvl-0"><li class="lvl-2"><p>Kubernetes 中的卷（volumes）是为了在容器之间共享数据，或将数据从容器持久化到外部存储。</p></li></ul><h5 id="emptyDir（最简单，Pod-生命周期内有效）">emptyDir（最简单，Pod 生命周期内有效）</h5><ul class="lvl-0"><li class="lvl-2"><p>emptyDir 卷是一个没有名字的临时目录，Pod 创建时创建，Pod 删除时删除。</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">html-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html-volume</span></span><br><span class="line">      <span class="attr">emptyDir:</span> &#123;&#125;  <span class="comment"># 表示一个空目录，在 Pod 生命周期内有效</span></span><br></pre></td></tr></table></figure><h5 id="hostPath（挂载宿主机路径）">hostPath（挂载宿主机路径）</h5><ul class="lvl-0"><li class="lvl-2"><p>用于测试或非常了解宿主机结构的场景。生产不推荐。</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mydata</span></span><br><span class="line">      <span class="attr">hostPath:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/tmp/data</span>        <span class="comment"># 宿主机路径</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span>  <span class="comment"># 如果目录不存在就创建</span></span><br></pre></td></tr></table></figure><h5 id="configMap（挂载配置文件）">configMap（挂载配置文件）</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">configMap:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">my-configmap</span>   <span class="comment"># 需提前创建 ConfigMap，这个后面会介绍</span></span><br></pre></td></tr></table></figure><h5 id="使用-PVC（挂载持久化存储）">使用 PVC（挂载持久化存储）</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">persistent-storage</span></span><br><span class="line">      <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">        <span class="attr">claimName:</span> <span class="string">mypvc</span>  <span class="comment"># PVC 名称，需要提前创建，这个后面会介绍</span></span><br></pre></td></tr></table></figure><h4 id="spec-tolerations-Pod容忍策略">spec.tolerations: Pod容忍策略</h4><ul class="lvl-0"><li class="lvl-2"><p>tolerations 是 Kubernetes Pod 中用来“容忍”某些 Node 节点的污点（Taints） 的字段。它允许 Pod 被调度到带有相应 Taint 的节点上。</p></li><li class="lvl-2"><p>默认情况下，Pod 会因为 Node 节点的 Taint 而不被调度。</p></li><li class="lvl-2"><p>比如一个 Node 有 NoSchedule 类型的 taint，而 Pod 没有设置对应的 toleration，该 Pod 就不会被调度到这个 Node 上。</p></li><li class="lvl-2"><p>示例： 容忍 key=value:NoSchedule 的 Taint</p></li><li class="lvl-2"><p>假设某节点打了如下污点（Taint）：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes node1 key=value:NoSchedule</span><br><span class="line"><span class="comment"># NoSchedule不调度到该节点，除非容忍策略显式允许</span></span><br><span class="line"><span class="comment"># PreferNoSchedule尽量不调度到该节点，但非强制，即可能会被调度</span></span><br><span class="line"><span class="comment"># NoExecute不仅不调度到该节点，还会把现有 Pod 驱逐出去，除非设置容忍时间</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># key=value 是用来 区分不同类型的污点的。比如：</span></span><br><span class="line"><span class="comment">#   你可能给 node1 设置 env=prod:NoSchedule</span></span><br><span class="line"><span class="comment">#   给 node2 设置 gpu=true:NoSchedule</span></span><br><span class="line"><span class="comment">#   给 node3 设置 arch=arm64:NoSchedule</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这些都属于不同的“原因”或“标签”，这样你可以：</span></span><br><span class="line"><span class="comment">#   用不同的 toleration 来容忍不同的 taint；</span></span><br><span class="line"><span class="comment">#   精准控制某些 Pod 只能被调度到符合条件的节点。</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>容忍该 Taint</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tolerate-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sleep&quot;</span>, <span class="string">&quot;3600&quot;</span>]</span><br><span class="line">  <span class="attr">tolerations:</span>        <span class="comment"># 定义容忍策略</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span> <span class="comment"># 匹配方式，必选（Equal:精确匹配 key 和 value。Exists:只匹配 key 是否存在，不关心 value 是什么）</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">&quot;key&quot;</span>        <span class="comment"># 设置键值对的key，为空代表任意键值对</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;value&quot;</span>    <span class="comment"># 设置values的值，</span></span><br><span class="line">    <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span> <span class="comment"># 设置容忍的标签，为空代表所有污点标签</span></span><br><span class="line">    <span class="attr">tolerationSeconds:</span> <span class="number">60</span> <span class="comment"># 容忍时间，这里Pod 最多可停留 60 秒，之后仍会被驱逐，不设置表示永久容忍</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>在 Kubernetes 中，effect 有 三个可选值：</p></li></ul><table><thead><tr><th><code>effect</code> 值</th><th>含义</th><th>常见用途</th></tr></thead><tbody><tr><td><code>NoSchedule</code></td><td>节点上的污点会阻止 Pod 被调度到该节点，除非 Pod 有相应的 toleration。</td><td><strong>最常用</strong>，例如 Master 节点的容忍。</td></tr><tr><td><code>PreferNoSchedule</code></td><td><strong>倾向于不调度</strong> 到该节点，但不是强制性的，调度器会尽量避免把 Pod 安排到该节点。</td><td>用于软约束，尽量不调度。</td></tr><tr><td><code>NoExecute</code></td><td>不仅不调度新 Pod 到该节点，还会把当前节点上没有相应容忍度的 Pod 驱逐出去（<code>eviction</code>）。</td><td>节点异常自动驱逐，比如 not-ready。</td></tr></tbody></table><h4 id="spec-resources">spec.resources</h4><ul class="lvl-0"><li class="lvl-2"><p>Pod资源配额可以限制命名空间或项目中Pod使用的CPU、内存、存储等资源用量</p></li><li class="lvl-2"><p>CPU资源的约束和请求以豪核（m）为单位。在k8s中1m是最小的调度单元，CPU的一个核心可以看作1000m</p></li></ul><blockquote><p>如果你有2颗cpu，且每CPU为4核心，那么你的CPU资源总量就是8000</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span>                     <span class="comment"># Pod 的具体规范</span></span><br><span class="line">  <span class="attr">containers:</span>             <span class="comment"># Pod 中的容器数组，可以有多个容器</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp-container</span>    <span class="comment"># 容器名称</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:1.25</span>        <span class="comment"># 使用的镜像</span></span><br><span class="line">      <span class="attr">resources:</span>              <span class="comment"># 资源限制和请求</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">&quot;512Mi&quot;</span>     <span class="comment"># 最大内存限制</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span>            <span class="comment"># 最大 CPU 核心数，这里是 1 核</span></span><br><span class="line">          <span class="comment"># cpu: 1000m          # 1000m = 1 核</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">&quot;256Mi&quot;</span>     <span class="comment"># 初始分配内存</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">&quot;0.5&quot;</span>          <span class="comment"># 初始分配 CPU, 这里0.5 表示 0.5 核</span></span><br><span class="line">          <span class="comment"># cpu: 500m           # 500 毫核，也就是 0.5 核</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>如果有大量的容器需要设置资源配额，为每个Pod设置资源配额策略不方便且不好管理</p></li><li class="lvl-2"><p>可以以名称空间为单位（namespace），限制其资源的使用与创建，在该名称空间中创建的容器都会受到规则的限制。</p></li></ul><h5 id="LimitRange">LimitRange</h5><ul class="lvl-0"><li class="lvl-2"><p>对单个Pod内存、CPU进行配额</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mem-cpu-limit-range</span>          <span class="comment"># LimitRange 的名称</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span>                    <span class="comment"># 生效的命名空间</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Container</span>                  <span class="comment"># 表示限制的是每个容器（也可设置为 Pod）</span></span><br><span class="line">    <span class="attr">default:</span>                         <span class="comment"># 容器未指定 resources.limits 时使用的默认值</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">500m</span>                      <span class="comment"># 默认限制 CPU 为 0.5 核</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">512Mi</span>                  <span class="comment"># 默认限制内存为 512 MiB</span></span><br><span class="line">    <span class="attr">defaultRequest:</span>                  <span class="comment"># 容器未指定 resources.requests 时使用的默认请求值，初始值</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">100m</span>                      <span class="comment"># 默认请求 CPU 为 0.1 核</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">128Mi</span>                  <span class="comment"># 默认请求内存为 128 MiB</span></span><br><span class="line">    <span class="attr">max:</span>                             <span class="comment"># 容器可设置的最大限制值，即 容器中指定的 resources.limits 的最大允许值</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&quot;1&quot;</span>                       <span class="comment"># 最大可使用 CPU 为 1 核</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">1Gi</span>                    <span class="comment"># 最大可使用内存为 1 GiB</span></span><br><span class="line">    <span class="attr">min:</span>                             <span class="comment"># 容器可设置的最小请求值，，即 容器中指定的 resources.requests 的最小允许值</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">50m</span>                       <span class="comment"># 最小请求 CPU 为 0.05 核</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">64Mi</span>                   <span class="comment"># 最小请求内存为 64 MiB</span></span><br></pre></td></tr></table></figure><h5 id="ResourceQuota">ResourceQuota</h5><ul class="lvl-0"><li class="lvl-2"><p>限制整个 namespace 的资源总量</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">compute-resources</span>           <span class="comment"># ResourceQuota 的名称</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">demo</span>                   <span class="comment"># 生效的命名空间</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span>                             <span class="comment"># 定义各类资源的总配额上限</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;10&quot;</span>                      <span class="comment"># 该命名空间最多允许创建 10 个 Pod</span></span><br><span class="line">    <span class="attr">requests.cpu:</span> <span class="string">&quot;2&quot;</span>               <span class="comment"># 所有 Pod 的 requests.cpu 总和最多为 2 核</span></span><br><span class="line">    <span class="attr">requests.memory:</span> <span class="string">4Gi</span>            <span class="comment"># 所有 Pod 的 requests.memory 总和最多为 4 GiB</span></span><br><span class="line">    <span class="attr">limits.cpu:</span> <span class="string">&quot;4&quot;</span>                 <span class="comment"># 所有 Pod 的 limits.cpu 总和最多为 4 核</span></span><br><span class="line">    <span class="attr">limits.memory:</span> <span class="string">8Gi</span>              <span class="comment"># 所有 Pod 的 limits.memory 总和最多为 8 GiB</span></span><br></pre></td></tr></table></figure><h4 id="spec-priorityClassName">spec.priorityClassName</h4><ul class="lvl-0"><li class="lvl-2"><p>Pod 的优先级，优先级就是为了保证重要的Pod被优先调度并运行</p></li><li class="lvl-2"><p>优先级策略：</p><ul class="lvl-2"><li class="lvl-4">非抢占优先：指的是在调度阶段优先进行调度分配，一旦容器调度完成就不可以抢占，资源不足时，只能等待</li><li class="lvl-4">抢占优先：强制调度一个Pod，如果资源不足无法被调度，调度程序会抢占（删除）较低优先级的Pod的资 源，来保证高优先级Pod的运行</li></ul></li><li class="lvl-2"><p>创建优先级</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PriorityClass</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">scheduling.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">high-non</span> <span class="comment"># 优先级名称</span></span><br><span class="line"><span class="attr">preemptionPolicy:</span> <span class="string">Never</span> <span class="comment"># 策略：非抢占，PreemptLowerPriority:抢占（删除）较低优先级的Pod的资源，保证高优先级Pod的运行</span></span><br><span class="line"><span class="attr">value:</span> <span class="number">1000</span> <span class="comment"># 优先级，可以设置小于10亿的整数值，值越大，优先级越高，默认优先级0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">kubernetes.io/hostname:</span> <span class="string">node01</span> <span class="comment"># 指定匹配具有当前标签的节点</span></span><br><span class="line">  <span class="attr">priorityClassName:</span> <span class="string">high-non</span> <span class="comment"># 优先级名称</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-nginx</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure><h4 id="spec-nodeName-nodeSelector-Pod调度策略">spec.nodeName | nodeSelector :Pod调度策略</h4><ul class="lvl-0"><li class="lvl-2"><p>在k8s中，调度是将Pod分配到合适的节点并运行的过程，kube-scheduler是默认调度器，是集群的核心组件。</p></li><li class="lvl-2"><p>调度器通过k8s的监测（Watch）机制来发现集群中尚未被调度到节点上的Pod，调度器依据调度原则将Pod分配到一个合适的节点上运行。</p></li><li class="lvl-2"><p>调度器给一个pod做调度包含两个步骤： 过滤 和 打分</p><ul class="lvl-2"><li class="lvl-4">过滤：首先要筛选出满足Pod所有的资源请求的节点，这里包含计算资源、内存、存储、网络、端口号等等，如果没有节点能满足Pod的需求，Pod将一直停留在Pending状态，直到调度器能够找到合适的节点运行它</li><li class="lvl-4">打分：调度器将节点按照打分规则进行打分，然后按照分数进行排序，将分数最高的节点作为Pod的运行节点。如果存在多个得分最高的节点，调度器会从中随机选取一个。</li></ul></li><li class="lvl-2"><p>Pod 支持两种调度策略：<code>nodeName</code> 和 <code>nodeSelector</code></p></li></ul><h5 id="spec-nodeName">spec.nodeName</h5><ul class="lvl-0"><li class="lvl-2"><p>指定 Pod 运行在指定名称的节点上</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">node-1</span> <span class="comment"># 基于节点名进行调度</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apache</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myos:httpd</span></span><br></pre></td></tr></table></figure><h5 id="spec-nodeSelector">spec.nodeSelector</h5><ul class="lvl-0"><li class="lvl-2"><p>节点选择器，基于节点的标签进行调度</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeSelector:</span>         <span class="comment"># 基于节点标签进行调度</span></span><br><span class="line">    <span class="attr">kubernetes.io/hostname:</span> <span class="string">node-2</span>  <span class="comment"># 标签</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">apache</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myos:httpd</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>为节点设置标签</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有资源都可以设置标签，语法为： kubectl label &lt;资源&gt; &lt;资源名称&gt; &lt;标签key&gt;=&lt;标签value&gt;</span></span><br><span class="line">kubectl label nodes node-2 kubernetes.io/hostname=node-2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除标签，语法为： kubectl label &lt;资源&gt; &lt;资源名称&gt; &lt;标签key&gt;-</span></span><br><span class="line"><span class="comment"># 这里注意，删除标签就是在标签key后加上 - 符号</span></span><br><span class="line">kubectl label nodes node-2 kubernetes.io/hostname-</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看资源标签：kubectl get &lt;资源&gt; --show-labels</span></span><br><span class="line">kubectl get nodes --show-labels</span><br><span class="line"><span class="comment"># 查看指定节点的标签</span></span><br><span class="line">kubectl get nodes node-2 --show-labels</span><br></pre></td></tr></table></figure><h4 id="spec-affinity">spec.affinity</h4><ul class="lvl-0"><li class="lvl-2"><p>节点亲和性，用于控制 Pod 调度到具有特定标签的节点上，是 nodeSelector 的增强版本</p></li></ul><table><thead><tr><th>类型</th><th>功能</th><th>示例用途</th></tr></thead><tbody><tr><td>Node Affinity</td><td>控制调度到有指定标签的节点</td><td>SSD、高内存节点</td></tr><tr><td>Pod Affinity</td><td>调度到和某些 Pod 一起的节点</td><td>微服务协同部署</td></tr><tr><td>Pod Anti-Affinity</td><td>避免和某些 Pod 一起的节点</td><td>高可用副本分散部署</td></tr></tbody></table><h5 id="节点亲和性-Node-Affinity">节点亲和性(Node Affinity)</h5><ul class="lvl-0"><li class="lvl-2"><p>Pod 只能调度到具有标签 <code>disktype=ssd</code> 的节点上</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-affinity-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">affinity:</span>   <span class="comment"># 亲和性配置</span></span><br><span class="line">    <span class="attr">nodeAffinity:</span> <span class="comment"># 节点亲和性</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span> <span class="comment"># 在调度期间必须满足，运行中忽略变化（即调度后标签变了不会驱逐 Pod）。也可以设置为 preferredDuringSchedulingIgnoredDuringExecution，表示节点亲和性优先级高，但不强制要求必须满足</span></span><br><span class="line">        <span class="attr">nodeSelectorTerms:</span> <span class="comment"># 节点选择器</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span> <span class="comment"># 匹配表达式，支持复杂逻辑，比如 In、NotIn、Exists、DoesNotExist、Gt、Lt。</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">disktype</span> <span class="comment"># 键</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span> <span class="comment"># 操作符</span></span><br><span class="line">            <span class="attr">values:</span> <span class="comment"># 值</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">ssd</span></span><br></pre></td></tr></table></figure><h5 id="Pod-亲和性-Pod-Affinity">Pod 亲和性(Pod Affinity)</h5><ul class="lvl-0"><li class="lvl-2"><p>Pod 会被调度到 与标签为 app=web 的 Pod 所在同一节点（或拓扑层）上。</p></li></ul><blockquote><p>通常用于需要紧密协作的服务部署在一起（如同一机器内通信）。</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-affinity-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sleep&quot;</span>, <span class="string">&quot;3600&quot;</span>]</span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">podAffinity:</span>  <span class="comment"># pod 亲和性</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">labelSelector:</span>  <span class="comment"># 标签选择器</span></span><br><span class="line">          <span class="attr">matchExpressions:</span> <span class="comment"># 标签选择条件</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span> <span class="comment"># 键</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span> <span class="comment"># 操作符</span></span><br><span class="line">            <span class="attr">values:</span>  <span class="comment"># 值</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">&quot;kubernetes.io/hostname&quot;</span> <span class="comment"># 拓扑键，表示“同一主机”</span></span><br></pre></td></tr></table></figure><h5 id="Pod-反亲和性-Pod-Anti-Affinity">Pod 反亲和性(Pod Anti-Affinity)</h5><ul class="lvl-0"><li class="lvl-2"><p>表示不能和 app=web 的 Pod 在同一节点上</p></li></ul><blockquote><p>常用于高可用部署，避免多个副本部署在同一个节点。</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-anti-affinity-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sleep&quot;</span>, <span class="string">&quot;3600&quot;</span>]</span><br><span class="line">  <span class="attr">affinity:</span></span><br><span class="line">    <span class="attr">podAntiAffinity:</span> <span class="comment"># Pod 反亲和性</span></span><br><span class="line">      <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">          <span class="attr">matchExpressions:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">            <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">            <span class="attr">values:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">        <span class="attr">topologyKey:</span> <span class="string">&quot;kubernetes.io/hostname&quot;</span></span><br></pre></td></tr></table></figure><h5 id="节点亲和性-Node-Affinity-两种策略的对比">节点亲和性 (Node Affinity) 两种策略的对比</h5><table><thead><tr><th>策略字段</th><th>含义</th><th>行为特点</th><th>场景适用</th><th>是否强制</th></tr></thead><tbody><tr><td><code>requiredDuringSchedulingIgnoredDuringExecution</code></td><td><strong>“必须满足”亲和性规则</strong></td><td>Pod <strong>调度时必须满足条件</strong>，不满足则不调度；调度后节点变化不触发驱逐</td><td>硬性约束，比如必须调度到有 GPU 的节点</td><td>✅ 强制</td></tr><tr><td><code>preferredDuringSchedulingIgnoredDuringExecution</code></td><td><strong>“尽量满足”亲和性规则</strong></td><td>Pod <strong>调度时优先考虑满足条件的节点</strong>，但条件不满足时仍然可以调度到其他节点；调度后同样不会强制迁移</td><td>软性倾向，比如尽量调度到 SSD 节点，但实在没有也可调度</td><td>❌ 非强制</td></tr></tbody></table><h4 id="spec-securityContext-设置安全上下文">spec.securityContext: 设置安全上下文</h4><h5 id="runAsUser-设置运行用户">runAsUser: 设置运行用户</h5><ul class="lvl-0"><li class="lvl-2"><p>默认情况下容器都是以root用户运行的，但是很多应用需要以非root用户运行，比如 Elasticsearch 。</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">centos1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">centos:v1</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;while true; do echo hello; sleep 10;done&quot;</span>]</span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">runAsUser:</span> <span class="number">1000</span>   <span class="comment"># 设置运行用户，这个UID可以不存在</span></span><br></pre></td></tr></table></figure><h5 id="privileged-是否以特权方式运行">privileged: 是否以特权方式运行</h5><ul class="lvl-0"><li class="lvl-2"><p>容器与宿主机是共享内核的，默认情况下，容器用户是不允许修改内核参数的，但是可以通过设置 <code>privileged: true</code> 来允许容器以特权方式运行。</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">centos1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">centos:v1</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;while true; do echo hello; sleep 10;done&quot;</span>]</span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">privileged:</span> <span class="literal">true</span>   <span class="comment"># 特权方式运行，默认为 false</span></span><br></pre></td></tr></table></figure><h5 id="allowPrivilegeEscalation-是否可以提权（SUID）">allowPrivilegeEscalation: 是否可以提权（SUID）</h5><ul class="lvl-0"><li class="lvl-2"><p>s位：当某可执行命令的所有者的位置上有s位时，那么当普通用户执行这个命令时将具有所有者的权限。</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">centos1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">centos:v1</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;while true; do echo hello; sleep 10;done&quot;</span>]</span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">true</span>   <span class="comment"># 提权运行，可以使用suid，默认为 false</span></span><br></pre></td></tr></table></figure><h3 id="查看-Pod">查看 Pod</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 Pod，默认显示 default 命名空间下的 Pod</span></span><br><span class="line">kubectl get pods</span><br><span class="line"><span class="comment"># 查看 kube-system 命名空间下的 Pod</span></span><br><span class="line">kubectl get pods -n kube-system</span><br><span class="line"><span class="comment"># 查看所有命名空间下的 Pod</span></span><br><span class="line">kubectl get pods -A</span><br><span class="line"><span class="comment"># -o wide: 显示 Pod 的详细信息，此时会看到 pod 的 IP 地址、节点名称等信息</span></span><br><span class="line">kubectl get pods -o wide</span><br><span class="line"><span class="comment"># 显示 Pod 的详细信息，输出为 json/yaml 格式</span></span><br><span class="line">kubectl get pods -o json/yaml</span><br><span class="line"><span class="comment"># 显示 Pod 的标签</span></span><br><span class="line">kubectl get pod --show-labels</span><br><span class="line"><span class="comment"># 按 Pod 的标签进程查询</span></span><br><span class="line">kubectl get pod -l &lt;label_name&gt;=&lt;label_value&gt;</span><br><span class="line"><span class="comment"># 持续查看 Pod 的状态，当 pod 状态发生改变时，会实时显示</span></span><br><span class="line">kubectl get pods -w</span><br><span class="line"><span class="comment">## 状态类型</span></span><br><span class="line">- Pending: Pod 尚未就绪</span><br><span class="line">- ContainerCreating: Pod 正在创建容器</span><br><span class="line">- Running: Pod 正在运行</span><br><span class="line">- Error: Pod 运行错误</span><br><span class="line">- Terminating: Pod 正在删除</span><br><span class="line">- Completed: Pod 执行完成</span><br><span class="line">- Failed: Pod中的所有容器至少有一个容器退出是非0状态</span><br><span class="line">- Unkown: 无法正常获取Pod对象的状态信息</span><br></pre></td></tr></table></figure><h3 id="查看-Pod-详情">查看 Pod 详情</h3><ul class="lvl-0"><li class="lvl-2"><p>当 pod 运行错误时，可以通过该命令查看 pod 的详情，找到错误原因</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe pod &lt;pod-name&gt;</span><br><span class="line">kubectl describe pod &lt;pod-name&gt; -n &lt;namespace-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 排查原因时主要观察最后的 Events，从上到下就是 Pod 的运行过程</span></span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age        From               Message</span><br><span class="line">  ----    ------     ----       ----               -------</span><br><span class="line">  <span class="comment"># 被调度器分配到 k8s-worker2 节点</span></span><br><span class="line">  Normal  Scheduled  4s         default-scheduler  Successfully assigned default/nginx to k8s-worker2</span><br><span class="line">  <span class="comment"># 开始拉取镜像</span></span><br><span class="line">  Normal  Pulling    &lt;invalid&gt;  kubelet            Pulling image <span class="string">&quot;nginx&quot;</span></span><br><span class="line">  <span class="comment"># 镜像拉取成功</span></span><br><span class="line">  Normal  Pulled     &lt;invalid&gt;  kubelet            Successfully pulled image <span class="string">&quot;nginx&quot;</span> <span class="keyword">in</span> 2.067s (2.067s including waiting). Image size: 72225394 bytes.</span><br><span class="line">  <span class="comment"># 开始创建容器</span></span><br><span class="line">  Normal  Created    &lt;invalid&gt;  kubelet            Created container: nginx</span><br><span class="line">  <span class="comment"># 容器启动成功</span></span><br><span class="line">  Normal  Started    &lt;invalid&gt;  kubelet            Started container nginx</span><br></pre></td></tr></table></figure><h3 id="进入容器">进入容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl exec -it &lt;pod-name&gt; -n &lt;namespace-name&gt; -- &lt;command&gt;</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it nginx  -- /bin/bash</span><br></pre></td></tr></table></figure><h3 id="删除-Pod">删除 Pod</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod &lt;pod-name&gt;</span><br><span class="line">kubectl delete pod &lt;pod-name&gt; -n &lt;namespace-name&gt;</span><br></pre></td></tr></table></figure><h3 id="查看-Pod-日志">查看 Pod 日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs &lt;pod-name&gt;</span><br><span class="line">kubectl logs pod/&lt;pod-name&gt;</span><br><span class="line">kubectl logs pod/&lt;pod-name&gt; -n &lt;namespace-name&gt;</span><br></pre></td></tr></table></figure><h3 id="访问-Pod">访问 Pod</h3><ul class="lvl-0"><li class="lvl-2"><p>我们刚刚创建了一个nginx的pod，该如何访问呢？</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取pod的ip</span></span><br><span class="line">$ k get pod -o wide</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE   IP             NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx   1/1     Running   0          12m   10.244.126.8   k8s-worker2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在任意节点上访问，nginx 默认端口是80</span></span><br><span class="line">$ curl 10.244.126.8</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>暂时我们还不能通过节点的 IP 访问 Pod，因为 Pod 运行在容器网络中，等我后面讲解 deployment 和 service 之后，会介绍如何通过 service 访问</p></li></ul><h3 id="一个-Pod-运行多个容器">一个 Pod 运行多个容器</h3><ul class="lvl-0"><li class="lvl-2"><p>yaml 文件</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">multi-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">shareProcessNamespace:</span> <span class="literal">true</span> <span class="comment"># 允许相同pod中多个容器共享进程空间，即在一个容器里可以看到另一个容器中的进程，默认值为 false</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tomcat</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">tomcat</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>运行 pod</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f multi_pod.yaml</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>查看运行结果</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这里看到，READY 里有两个，表示两个容器都运行成功</span></span><br><span class="line">$ kubectl get pods -owide</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE    IP              NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">multi-pod   2/2     Running   0          118s   10.244.194.81   k8s-worker1   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>访问nginx和tomcat</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 访问nginx，ngxin默认端口是80</span></span><br><span class="line">curl http://10.244.194.81</span><br><span class="line"><span class="comment"># 访问tomcat，tomcat默认端口是8080，因为tomcat的webapp是空的，所以看到404就说明正常</span></span><br><span class="line">curl http://10.244.194.81:8080</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>进入容器执行命令</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入nginx容器，-c 指定容器名称</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it multi-pod -c nginx -- /bin/bash</span><br><span class="line"><span class="comment">## 进入nginx容器后访问tomcat可以正常访问，说明同一个pod中的容器共享网络和存储</span></span><br><span class="line">curl http://localhost:8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入tomcat容器</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it multi-pod -c tomcat -- /bin/bash</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

引用本地其它文章连接{}
 大括号开始% post_link 文件名称(不包含.md) %大括号结束
 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍 K8S 的 Pod，本文以 CentOS 8 为例。&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/&quot;&gt;K8S官网&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/kubernetes/kubernetes&quot;&gt;k8s Github&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/&quot;&gt;k8s Pod 介绍&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="k8s" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/k8s/"/>
    
    
    <category term="K8S" scheme="https://blog.hanqunfeng.com/tags/K8S/"/>
    
  </entry>
  
  <entry>
    <title>K8S 之 Namespace</title>
    <link href="https://blog.hanqunfeng.com/2025/07/02/k8s-namespace/"/>
    <id>https://blog.hanqunfeng.com/2025/07/02/k8s-namespace/</id>
    <published>2025-07-02T13:30:05.000Z</published>
    <updated>2025-07-20T13:49:05.053Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote %引用本地其它文章连接{} 大括号开始% post_link 文件名称(不包含.md) %大括号结束 --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍 K8S 的 Namespace，本文以 CentOS 8 为例。</p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/">K8S官网</a></p></li><li class="lvl-2"><p><a href="https://github.com/kubernetes/kubernetes">k8s Github</a></p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/namespaces/">k8s Namespace 介绍</a></p></li></ul><span id="more"></span><h2 id="命名空间-Namespace-介绍">命名空间(Namespace) 介绍</h2><ul class="lvl-0"><li class="lvl-2"><p>在 Kubernetes 中，命名空间提供了一种在单个集群中隔离资源组的机制。资源名称在命名空间内需要唯一，但不需要跨命名空间唯一。</p></li><li class="lvl-2"><p>基于命名空间的作用域仅适用于命名空间对象 （例如，Deployments、Services 等），而不适用于集群范围的对象（例如 StorageClass、Nodes、PersistentVolumes 等）。</p></li><li class="lvl-2"><p>Namespace(缩写为 ns) 是在多个用户之间划分集群资源的一种方法，适用于跨多个团队或项目的场景，Namespace 不能相互嵌套，每个 Kubernetes 资源只能在一个 Namespace 中。</p></li><li class="lvl-2"><p>避免使用前缀 <code>kube-</code> 创建 Namespace，因为它是为 Kubernetes 系统 Namespace 保留的。</p></li><li class="lvl-2"><p>Kubernetes 启动时会创建四个初始 Namespace：</p></li></ul><table><thead><tr><th>名称空间名称</th><th>说明</th></tr></thead><tbody><tr><td><code>default</code></td><td>默认命名空间，供用户开始使用新集群时直接部署资源，无需额外创建命名空间。</td></tr><tr><td><code>kube-node-lease</code></td><td>存放与各个 Node 关联的 Lease（租约）对象，用于 Kubelet 发送心跳，帮助控制平面检测节点健康状态。</td></tr><tr><td><code>kube-public</code></td><td>所有客户端（包括匿名用户）都可以读取，主要用于集群范围内需要公开访问的资源。公共属性是一种使用约定。</td></tr><tr><td><code>kube-system</code></td><td>Kubernetes 系统组件（如 kube-dns、kube-proxy 等）运行所在的命名空间。由系统自动管理。</td></tr></tbody></table><h2 id="查看集群中的命名空间">查看集群中的命名空间</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># namespace 可以简写为 ns</span></span><br><span class="line">kubectl get namespace</span><br><span class="line">kubectl get ns</span><br></pre></td></tr></table></figure><h2 id="创建命名空间">创建命名空间</h2><ul class="lvl-0"><li class="lvl-2"><p>命令行方式</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create namespace &lt;namespace-name&gt;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>yaml 方式</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span>  <span class="comment"># API 版本，可以通过 kubectl api-resources | grep Namespace 获取</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span> <span class="comment"># 资源类型</span></span><br><span class="line"><span class="attr">metadata:</span>       <span class="comment"># 元数据</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&lt;namespace-name&gt;</span> <span class="comment"># 命名空间名称</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f &lt;namespace.yaml&gt;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>通过命令行直接生成yaml文件</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># --dry-run=client: 本地模拟运行命令，不会真的执行，-o yaml: 输出yaml格式</span></span><br><span class="line">kubectl create namespace &lt;namespace-name&gt; --dry-run=client -o yaml &gt; &lt;namespace.yaml&gt;</span><br></pre></td></tr></table></figure><h2 id="删除命名空间">删除命名空间</h2><ul class="lvl-0"><li class="lvl-2"><p>命令行方式</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete namespace &lt;namespace-name&gt;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>yaml 方式</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f &lt;namespace.yaml&gt;</span><br></pre></td></tr></table></figure><h2 id="设置名字空间偏好">设置名字空间偏好</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认为 default，即我们在执行 &#x27;kubbectl get pod&#x27; 时，默认会查看 default 这个名字空间下的所有 Pod</span></span><br><span class="line">kubectl config set-context --current --namespace=&lt;namespace-name&gt;</span><br></pre></td></tr></table></figure><h2 id="查看资源时指定命名空间">查看资源时指定命名空间</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -n &lt;namespace-name&gt;</span><br><span class="line">kubectl get service -n &lt;namespace-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有命名空间下的资源，-A, --all-namespaces</span></span><br><span class="line">kubectl get pod -A</span><br><span class="line">kubectl get service -A</span><br></pre></td></tr></table></figure><h2 id="并非所有对象都在名字空间中">并非所有对象都在名字空间中</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 位于名字空间中的资源</span></span><br><span class="line">kubectl api-resources --namespaced=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 不在名字空间中的资源</span></span><br><span class="line">kubectl api-resources --namespaced=<span class="literal">false</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>kubectl api-resources</code> 这个命令很有用，我们可以通过该命令获取所有资源的 <code>简写</code>，也可以获取资源的 <code>apiVersion</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl api-resources</span><br><span class="line">NAME: 资源名称</span><br><span class="line">SHORTNAMES: 简写</span><br><span class="line">APIVERSION: apiVersion</span><br><span class="line">NAMESPACED: 是否在名字空间中</span><br><span class="line">KIND: 资源类型</span><br></pre></td></tr></table></figure><h2 id="Kubernetes-中关于-命名空间（namespace）与-DNS-的机制">Kubernetes 中关于 命名空间（namespace）与 DNS 的机制</h2><ul class="lvl-0"><li class="lvl-2"><p>Kubernetes 服务有自动的 DNS 名称，它和命名空间有关。默认是能在本命名空间内直接访问；跨命名空间访问需要写完整域名（FQDN）。</p></li><li class="lvl-2"><p>命名空间名字不能重复，且命名空间名字不能乱起，尤其不要用公共互联网域名名词（如 com、org、net、cn 等）。</p></li></ul><h3 id="举个例子说明服务-DNS-是怎么工作的">举个例子说明服务 DNS 是怎么工作的</h3><ul class="lvl-0"><li class="lvl-2"><p>场景：你在两个命名空间中部署了两个 nginx 服务</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 命名空间 dev 中创建服务 nginx</span></span><br><span class="line">kubectl create ns dev</span><br><span class="line">kubectl create deployment nginx --image=nginx --replicas=2 -n dev</span><br><span class="line">kubectl expose deployment nginx --port=80 --<span class="built_in">type</span>=NodePort -n dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># 命名空间 prod 中也创建服务 nginx</span></span><br><span class="line">kubectl create ns prod</span><br><span class="line">kubectl create deployment nginx --image=nginx --replicas=2 -n prod</span><br><span class="line">kubectl expose deployment nginx --port=80 --<span class="built_in">type</span>=NodePort -n prod</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>1️⃣ 如果你在 dev 命名空间的 Pod 里访问如下请求，它实际解析的 DNS 是 <code>nginx.dev.svc.cluster.local</code>，也就是 <code>&lt;服务名&gt;.&lt;命名空间&gt;.svc.cluster.local</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://nginx</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>2️⃣ 如果你想从 dev 命名空间访问 prod 命名空间的 nginx 服务，你必须这样访问</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://nginx.prod.svc.cluster.local</span><br></pre></td></tr></table></figure><h2 id="快速生成-k8s-资源的yaml模板">快速生成 k8s 资源的yaml模板</h2><ul class="lvl-0"><li class="lvl-2"><p>安装 vscode 插件：YAML(Red Hat)，Kubernetes Templates(lunuan)</p></li><li class="lvl-2"><p>使用时打开一个yaml文件，或者将文件格式切换为yaml，然后输入关键字 pod、deploy、service 等等 k8s 资源名称，就会弹出模板选择，选择后回车就会生成模板</p></li></ul>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

引用本地其它文章连接{}
 大括号开始% post_link 文件名称(不包含.md) %大括号结束
 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍 K8S 的 Namespace，本文以 CentOS 8 为例。&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/&quot;&gt;K8S官网&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/kubernetes/kubernetes&quot;&gt;k8s Github&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/namespaces/&quot;&gt;k8s Namespace 介绍&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="k8s" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/k8s/"/>
    
    
    <category term="K8S" scheme="https://blog.hanqunfeng.com/tags/K8S/"/>
    
  </entry>
  
  <entry>
    <title>Linux 安装 K8S 之 sealos</title>
    <link href="https://blog.hanqunfeng.com/2025/07/01/k8s-install-sealos/"/>
    <id>https://blog.hanqunfeng.com/2025/07/01/k8s-install-sealos/</id>
    <published>2025-07-01T13:30:05.000Z</published>
    <updated>2025-07-02T03:14:34.095Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote %引用本地其它文章连接{} 大括号开始% post_link 文件名称(不包含.md) %大括号结束 --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍 Linux 下 使用 sealos 安装 K8S 的方法，本文以 CentOS 8 为例。</p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/">K8S官网</a></p></li><li class="lvl-2"><p><a href="https://github.com/kubernetes/kubernetes">k8s Github</a></p></li><li class="lvl-2"><p><a href="https://sealos.run/docs/k8s/quick-start/deploy-kubernetes">sealos官网</a></p></li><li class="lvl-2"><p><a href="https://github.com/labring/sealos">sealos Github</a></p></li></ul><span id="more"></span><h2 id="安装前设置-所有节点">安装前设置(所有节点)</h2><ul class="lvl-0"><li class="lvl-2"><p>准备三台可以连接外网的主机，不要安装docker,k8s等，如已安装需先卸载</p></li><li class="lvl-2"><p>(推荐)升级系统内核，本文中非必须，升级内核方法参看 <a href="/2025/06/29/k8s-install-kubeadm/" title="Linux 安装 K8S 之 kubeadm">Linux 安装 K8S 之 kubeadm</a></p></li></ul><h3 id="每个集群节点应该有不同的主机名，主机名不要带下划线">每个集群节点应该有不同的主机名，主机名不要带下划线</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加主机名映射: vi /etc/hosts</span></span><br><span class="line">10.211.55.12 k8s-m1</span><br><span class="line">10.211.55.13 k8s-w1</span><br><span class="line">10.211.55.14 k8s-w2</span><br></pre></td></tr></table></figure><h3 id="修正系统的时间">修正系统的时间</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装chrony</span></span><br><span class="line"><span class="built_in">sudo</span> dnf install chrony -y</span><br><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> --now chronyd</span><br><span class="line"><span class="comment"># 修正时间</span></span><br><span class="line"><span class="built_in">sudo</span> chronyc makestep</span><br><span class="line"><span class="comment"># 查看时间</span></span><br><span class="line"><span class="built_in">date</span></span><br></pre></td></tr></table></figure><h3 id="安装-sealos">安装 sealos</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载</span></span><br><span class="line">wget https://github.com/labring/sealos/releases/download/v5.0.1/sealos_5.0.1_linux_amd64.rpm</span><br><span class="line"><span class="comment"># 安装</span></span><br><span class="line">yum install -y sealos_5.0.1_linux_amd64.rpm</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>安装 sealos 的自动补全</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;source &lt;(sealos completion bash)&#x27;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure><h2 id="创建k8s集群-master">创建k8s集群(master)</h2><ul class="lvl-0"><li class="lvl-2"><p>创建集群: 使用sealos创建集群只需要一行命令，目前官网示例中的k8s版本为v1.29.9(小版本号越高越稳定)</p></li><li class="lvl-2"><p>可以在<a href="https://hub.docker.com">docker hub</a>上查询，或者使用 <a href="https://explore.ggcr.dev/">Registry Explorer</a> 查看如下镜像的所有版本，不建议使用太高的版本，有可能安装失败。</p></li><li class="lvl-2"><p>注意 sealos 与 kubernetes 的版本有对应关系，目前 <code>Sealos &gt;=v5.0.0</code> 对应的 <code>K8s &gt;=1.28</code>，具体可以从<a href="https://sealos.run/docs/k8s/quick-start/deploy-kubernetes">sealos官网</a>查询</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 国内可以在镜像前面加上 registry.cn-shanghai.aliyuncs.com/</span></span><br><span class="line"><span class="comment"># sealos 推荐的网络接口是 cilium</span></span><br><span class="line">$ sealos run labring/kubernetes:v1.29.9 labring/helm:v3.9.4 labring/cilium:v1.13.4 \</span><br><span class="line">     --masters 10.211.55.12 \</span><br><span class="line">     --nodes 10.211.55.13,10.211.55.14 -p [your-ssh-passwd]</span><br><span class="line"></span><br><span class="line"><span class="comment">## 参数说明</span></span><br><span class="line"><span class="comment"># -masters: 指定 master 节点的 IP 地址，多个节点之间用逗号隔开，但必须是奇数</span></span><br><span class="line"><span class="comment"># -nodes: 指定 worker 节点的 IP 地址，多个节点之间用逗号隔开。</span></span><br><span class="line"><span class="comment"># -p, --passwd: 指定 SSH 登录密码</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 安装成功会显示如下内容</span></span><br><span class="line">ℹ️  Using Cilium version 1.13.4</span><br><span class="line">🔮 Auto-detected cluster name: kubernetes</span><br><span class="line">🔮 Auto-detected datapath mode: tunnel</span><br><span class="line">🔮 Auto-detected kube-proxy has been installed</span><br><span class="line">2025-07-01T16:59:27 info succeeded <span class="keyword">in</span> creating a new cluster, enjoy it!</span><br><span class="line">2025-07-01T16:59:27 info</span><br><span class="line">      ___           ___           ___           ___       ___           ___</span><br><span class="line">     /\  \         /\  \         /\  \         /\__\     /\  \         /\  \</span><br><span class="line">    /::\  \       /::\  \       /::\  \       /:/  /    /::\  \       /::\  \</span><br><span class="line">   /:/\ \  \     /:/\:\  \     /:/\:\  \     /:/  /    /:/\:\  \     /:/\ \  \</span><br><span class="line">  _\:\~\ \  \   /::\~\:\  \   /::\~\:\  \   /:/  /    /:/  \:\  \   _\:\~\ \  \</span><br><span class="line"> /\ \:\ \ \__\ /:/\:\ \:\__\ /:/\:\ \:\__\ /:/__/    /:/__/ \:\__\ /\ \:\ \ \__\</span><br><span class="line"> \:\ \:\ \/__/ \:\~\:\ \/__/ \/__\:\/:/  / \:\  \    \:\  \ /:/  / \:\ \:\ \/__/</span><br><span class="line">  \:\ \:\__\    \:\ \:\__\        \::/  /   \:\  \    \:\  /:/  /   \:\ \:\__\</span><br><span class="line">   \:\/:/  /     \:\ \/__/        /:/  /     \:\  \    \:\/:/  /     \:\/:/  /</span><br><span class="line">    \::/  /       \:\__\         /:/  /       \:\__\    \::/  /       \::/  /</span><br><span class="line">     \/__/         \/__/         \/__/         \/__/     \/__/         \/__/</span><br><span class="line"></span><br><span class="line">                  Website: https://www.sealos.io/</span><br><span class="line">                  Address: github.com/labring/sealos</span><br><span class="line">                  Version: 5.0.1-2b74a1281</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>启用 shell 自动补全功能</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.安装 bash-completion</span></span><br><span class="line"><span class="comment"># 1.1 检查bash-completion是否已安装，有输出说明已经安装</span></span><br><span class="line">$ <span class="built_in">type</span> _init_completion</span><br><span class="line"><span class="comment"># 1.2 安装bash-completion，安装后会创建文件 /usr/share/bash-completion/bash_completion</span></span><br><span class="line">$ dnf install bash-completion</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.安装 kubectl 的自动补全功能</span></span><br><span class="line"><span class="comment"># 2.1 当前用户</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;source &lt;(kubectl completion bash)&#x27;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="comment"># 2.2 所有用户</span></span><br><span class="line">kubectl completion bash | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/bash_completion.d/kubectl &gt; /dev/null</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> a+r /etc/bash_completion.d/kubectl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3 如果 kubectl 有关联的别名，你可以扩展 Shell 补全来适配此别名</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;alias k=kubectl&#x27;</span> &gt;&gt;~/.bashrc</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;complete -o default -F __start_kubectl k&#x27;</span> &gt;&gt;~/.bashrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.刷新配置文件</span></span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>创建集群成功后，查看集群状态</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看版本</span></span><br><span class="line">$ kubectl version</span><br><span class="line">Client Version: v1.29.9</span><br><span class="line">Kustomize Version: v5.0.4-0.20230601165947-6ce0bf390ce3</span><br><span class="line">Server Version: v1.29.9</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看节点</span></span><br><span class="line">$ kubectl get nodes -owide</span><br><span class="line">NAME     STATUS   ROLES           AGE     VERSION   INTERNAL-IP    EXTERNAL-IP   OS-IMAGE                            KERNEL-VERSION             CONTAINER-RUNTIME</span><br><span class="line">k8s-m1   Ready    control-plane   3m11s   v1.29.9   10.211.55.12   &lt;none&gt;        Rocky Linux 8.10 (Green Obsidian)   4.18.0-553.el8_10.x86_64   containerd://1.7.27</span><br><span class="line">k8s-w1   Ready    &lt;none&gt;          2m52s   v1.29.9   10.211.55.13   &lt;none&gt;        Rocky Linux 8.10 (Green Obsidian)   4.18.0-553.el8_10.x86_64   containerd://1.7.27</span><br><span class="line">k8s-w2   Ready    &lt;none&gt;          2m55s   v1.29.9   10.211.55.14   &lt;none&gt;        Rocky Linux 8.10 (Green Obsidian)   4.18.0-553.el8_10.x86_64   containerd://1.7.27</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看资源</span></span><br><span class="line">$ kubectl get all -A -owide</span><br><span class="line">NAMESPACE     NAME                                   READY   STATUS    RESTARTS   AGE     IP             NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">kube-system   pod/cilium-bbbdl                       1/1     Running   0          3m47s   10.211.55.13   k8s-w1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   pod/cilium-cz47k                       1/1     Running   0          3m47s   10.211.55.14   k8s-w2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   pod/cilium-operator-6946ccbcc5-cxnn4   1/1     Running   0          3m47s   10.211.55.13   k8s-w1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   pod/cilium-vfc22                       1/1     Running   0          3m47s   10.211.55.12   k8s-m1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   pod/coredns-76f75df574-2ln5x           1/1     Running   0          3m54s   10.0.0.74      k8s-w1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   pod/coredns-76f75df574-plsds           1/1     Running   0          3m54s   10.0.0.146     k8s-w1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   pod/etcd-k8s-m1                        1/1     Running   0          4m6s    10.211.55.12   k8s-m1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   pod/kube-apiserver-k8s-m1              1/1     Running   0          4m6s    10.211.55.12   k8s-m1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   pod/kube-controller-manager-k8s-m1     1/1     Running   0          4m6s    10.211.55.12   k8s-m1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   pod/kube-proxy-4xbzt                   1/1     Running   0          3m51s   10.211.55.13   k8s-w1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   pod/kube-proxy-rjs8h                   1/1     Running   0          3m54s   10.211.55.14   k8s-w2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   pod/kube-proxy-xv4fg                   1/1     Running   0          3m55s   10.211.55.12   k8s-m1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   pod/kube-scheduler-k8s-m1              1/1     Running   0          4m6s    10.211.55.12   k8s-m1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   pod/kube-sealos-lvscare-k8s-w1         1/1     Running   0          3m31s   10.211.55.13   k8s-w1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   pod/kube-sealos-lvscare-k8s-w2         1/1     Running   0          3m34s   10.211.55.14   k8s-w2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">NAMESPACE     NAME                  TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE     SELECTOR</span><br><span class="line">default       service/kubernetes    ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP                  4m8s    &lt;none&gt;</span><br><span class="line">kube-system   service/hubble-peer   ClusterIP   10.96.1.9    &lt;none&gt;        443/TCP                  3m47s   k8s-app=cilium</span><br><span class="line">kube-system   service/kube-dns      ClusterIP   10.96.0.10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   4m7s    k8s-app=kube-dns</span><br><span class="line"></span><br><span class="line">NAMESPACE     NAME                        DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE     CONTAINERS     IMAGES                               SELECTOR</span><br><span class="line">kube-system   daemonset.apps/cilium       3         3         3       3            3           kubernetes.io/os=linux   3m47s   cilium-agent   quay.io/cilium/cilium:v1.13.4        k8s-app=cilium</span><br><span class="line">kube-system   daemonset.apps/kube-proxy   3         3         3       3            3           kubernetes.io/os=linux   4m7s    kube-proxy     registry.k8s.io/kube-proxy:v1.29.9   k8s-app=kube-proxy</span><br><span class="line"></span><br><span class="line">NAMESPACE     NAME                              READY   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS        IMAGES                                    SELECTOR</span><br><span class="line">kube-system   deployment.apps/cilium-operator   1/1     1            1           3m47s   cilium-operator   quay.io/cilium/operator:v1.13.4           io.cilium/app=operator,name=cilium-operator</span><br><span class="line">kube-system   deployment.apps/coredns           2/2     2            2           4m7s    coredns           registry.k8s.io/coredns/coredns:v1.11.1   k8s-app=kube-dns</span><br><span class="line"></span><br><span class="line">NAMESPACE     NAME                                         DESIRED   CURRENT   READY   AGE     CONTAINERS        IMAGES                                    SELECTOR</span><br><span class="line">kube-system   replicaset.apps/cilium-operator-6946ccbcc5   1         1         1       3m47s   cilium-operator   quay.io/cilium/operator:v1.13.4           io.cilium/app=operator,name=cilium-operator,pod-template-hash=6946ccbcc5</span><br><span class="line">kube-system   replicaset.apps/coredns-76f75df574           2         2         2       3m54s   coredns           registry.k8s.io/coredns/coredns:v1.11.1   k8s-app=kube-dns,pod-template-hash=76f75df574</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="测试：用K8S部署Nginx">测试：用K8S部署Nginx</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建deployment</span></span><br><span class="line">kubectl create deployment nginx --image=nginx</span><br><span class="line"><span class="comment"># 创建service，--type指定为NodePort，其含义为将deployment的80端口映射到Node的随机端口</span></span><br><span class="line">kubectl expose deployment nginx --<span class="built_in">type</span>=NodePort --port=80</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod和service，不加 -n 参数，默认查看的是default命名空间</span></span><br><span class="line">$ k get pods,svc -owide</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE   IP           NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">pod/nginx-7854ff8877-wgfxc   1/1     Running   0          19s   10.0.1.204   k8s-w2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)        AGE   SELECTOR</span><br><span class="line">service/kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP        44m   &lt;none&gt;</span><br><span class="line">service/nginx        NodePort    10.96.2.54   &lt;none&gt;        80:31044/TCP   5s    app=nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 浏览器访问任意nodeIP:31044</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除测试资源</span></span><br><span class="line"><span class="comment">## 删除deployment</span></span><br><span class="line">kubectl delete deployment nginx</span><br><span class="line"><span class="comment">## 删除service</span></span><br><span class="line">kubectl delete service nginx</span><br></pre></td></tr></table></figure><h2 id="sealos-命令">sealos 命令</h2><ul class="lvl-0"><li class="lvl-2"><p>sealos 命令概览</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">Cluster Management Commands:</span><br><span class="line">  apply         使用 Clusterfile 在 Kubernetes 集群中运行云镜像</span><br><span class="line">  cert          更新 Kubernetes API Server 的证书</span><br><span class="line">  run           轻松运行云原生应用，可用于已有或新建集群</span><br><span class="line">  reset         重置集群中的所有内容</span><br><span class="line">  status        查看 sealos 的状态</span><br><span class="line"></span><br><span class="line">Node Management Commands:</span><br><span class="line">  add           向集群中添加节点</span><br><span class="line">  delete        从集群中移除节点</span><br><span class="line"></span><br><span class="line">Remote Operation Commands:</span><br><span class="line">  <span class="built_in">exec</span>          在指定节点上执行 shell 命令或脚本</span><br><span class="line">  scp           将文件复制到指定节点的远程主机上</span><br><span class="line"></span><br><span class="line">Experimental Commands:</span><br><span class="line">  registry      与镜像仓库相关的实验性功能</span><br><span class="line"></span><br><span class="line">Container and Image Commands:</span><br><span class="line">  build         根据 Containerfile 或 Kubefile 构建镜像</span><br><span class="line">  create        创建集群但不执行命令，用于检查镜像</span><br><span class="line">  diff          查看对象文件系统的更改</span><br><span class="line">  inspect       检查容器或镜像的配置信息</span><br><span class="line">  images        列出本地存储中的镜像</span><br><span class="line">  load          从归档文件加载镜像</span><br><span class="line">  login         登录到容器镜像仓库</span><br><span class="line">  <span class="built_in">logout</span>        登出容器镜像仓库</span><br><span class="line">  manifest      操作 manifest 列表和镜像索引</span><br><span class="line">  merge         合并多个镜像为一个</span><br><span class="line">  pull          从指定位置拉取镜像</span><br><span class="line">  push          将镜像推送到指定目标</span><br><span class="line">  rmi           从本地删除一个或多个镜像</span><br><span class="line">  save          将镜像保存为归档文件</span><br><span class="line">  tag           为本地镜像添加额外的名称标签</span><br><span class="line"></span><br><span class="line">Other Commands:</span><br><span class="line">  completion    生成指定 shell 的自动补全脚本</span><br><span class="line">  docs          生成 API 参考文档</span><br><span class="line">  <span class="built_in">env</span>           输出 sealos 使用的所有环境变量信息</span><br><span class="line">  gen           生成包含默认设置的 Clusterfile</span><br><span class="line">  version       打印版本信息</span><br></pre></td></tr></table></figure><h3 id="集群管理-master节点执行命令">集群管理(master节点执行命令)</h3><ul class="lvl-0"><li class="lvl-2"><p>创建集群</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sealos run labring/kubernetes:v1.29.9 labring/helm:v3.9.4 labring/cilium:v1.13.4 \</span><br><span class="line">     --masters 10.211.55.12 \</span><br><span class="line">     --nodes 10.211.55.13,10.211.55.14 -p [your-ssh-passwd]</span><br><span class="line"></span><br><span class="line"><span class="comment">## 参数说明</span></span><br><span class="line">-masters: 指定 master 节点的 IP 地址，多个节点之间用逗号隔开，但必须是奇数</span><br><span class="line">-nodes: 指定 worker 节点的 IP 地址，多个节点之间用逗号隔开。</span><br><span class="line">-p, --passwd: 指定 SSH 登录密码</span><br><span class="line">-u, --user: 登录用户名，默认为 root</span><br><span class="line">-i, --pk=<span class="string">&#x27;/root/.ssh/id_rsa&#x27;</span>: 指定 SSH 密钥文件路径</span><br><span class="line">--port: 指定 SSH 端口，默认为 22</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>Clusterfile 方式创建集群</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成集群配置文件，Clusterfile就是一个yaml文件，里面包含集群的配置信息</span></span><br><span class="line">sealos gen labring/kubernetes:v1.29.9 labring/helm:v3.9.4 labring/cilium:v1.13.4 \</span><br><span class="line">     --masters 10.211.55.12 \</span><br><span class="line">     --nodes 10.211.55.13,10.211.55.14 -p [your-ssh-passwd] &gt; Clusterfile</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行配置文件</span></span><br><span class="line">sealos apply -f Clusterfile</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>查看集群状态</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sealos status</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>清除K8s集群</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sealos reset</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>更新 Kubernetes API 服务器的证书</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sealos 创建的证书存放在 /etc/kubernetes/pki/ 下，默认证书有效期为 100 年</span></span><br><span class="line"><span class="comment"># 更新证书一般只会在添加新的访问ip或域名时才需要</span></span><br><span class="line">sealos cert --alt-names apiserver.cluster.local,10.211.55.12,127.0.0.1,localhost</span><br><span class="line"><span class="comment"># 参数说明</span></span><br><span class="line"><span class="comment"># --alt-names: 添加新的访问ip或域名，多个逗号分隔</span></span><br><span class="line"><span class="comment"># -c, --cluster=&#x27;default&#x27;: 要执行 exec 操作的集群的名称。默认为 default。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新证书后，你可以使用以下命令进行校验：</span></span><br><span class="line">kubectl -n kube-system get cm kubeadm-config -o yaml</span><br><span class="line">openssl x509 -<span class="keyword">in</span> /etc/kubernetes/pki/apiserver.crt -text</span><br></pre></td></tr></table></figure><blockquote><p>在执行此操作之前，你最好先备份旧的证书。<br>执行 sealos cert 命令后，会更新集群 API 服务器的证书，你无需手动重启 API 服务器，sealos会自动帮你重启服务。</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>查看环境变量</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -v 显示变量的说明</span></span><br><span class="line">sealos <span class="built_in">env</span> -v</span><br><span class="line"><span class="comment">## 说明</span></span><br><span class="line">SEALOS_PROMPT=enabled <span class="comment"># 是否启用终端中的交互提示功能。</span></span><br><span class="line">SEALOS_RUNTIME_ROOT=/root/.sealos <span class="comment"># Sealos 的运行时根目录，用于持久化运行相关的操作或配置。</span></span><br><span class="line">SEALOS_DATA_ROOT=/var/lib/sealos  <span class="comment"># 集群在远程节点上的根目录路径，用于存储集群相关的数据。</span></span><br><span class="line">BUILDAH_FORMAT=oci <span class="comment"># 镜像构建时使用的格式，`oci` 表示符合 OCI 镜像规范。</span></span><br><span class="line">BUILDAH_LOG_LEVEL= <span class="comment"># buildah 模块中使用的日志级别，可以是 &quot;trace&quot;, &quot;debug&quot;, &quot;info&quot;, &quot;warn&quot;, &quot;error&quot;, &quot;fatal&quot;, 或 &quot;panic&quot;。</span></span><br><span class="line">CONTAINERS_STORAGE_CONF= <span class="comment"># 容器存储配置文件的路径，设置这个变量可以覆盖默认的配置位置。</span></span><br><span class="line">SEALOS_SYNC_WORKDIR=<span class="literal">true</span> <span class="comment"># 是否将运行时根目录（SEALOS_RUNTIME_ROOT）同步到所有 master 节点，作为备份用途。</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>在集群中执行命令</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sealos exec &quot;shell command or script&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在所有节点上执行命令</span></span><br><span class="line">sealos <span class="built_in">exec</span> <span class="string">&quot;cat /etc/hosts&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在指定的节点上执行命令，--ips: 参数指定要执行的节点IP，多个节点之间用逗号分隔</span></span><br><span class="line">sealos <span class="built_in">exec</span> <span class="string">&quot;cat /etc/hosts&quot;</span> --ips=10.211.55.13,10.211.55.14</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>在集群间拷贝文件</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sealos scp &quot;source file path&quot; &quot;destination file path&quot;</span></span><br><span class="line"><span class="comment"># 在所有节点上执行命令</span></span><br><span class="line">sealos scp ~/Clusterfile /tmp/Clusterfile</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在指定的节点上执行命令，--ips: 参数指定要执行的节点IP，多个节点之间用逗号分隔</span></span><br><span class="line">sealos scp ~/Clusterfile /tmp/Clusterfile --ips=10.211.55.13,10.211.55.14</span><br></pre></td></tr></table></figure><h3 id="节点管理-master节点执行命令">节点管理(master节点执行命令)</h3><ul class="lvl-0"><li class="lvl-2"><p>添加 master 节点</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加 master 节点后，总的 master 节点个数必须为奇数，否则会报错</span></span><br><span class="line">sealos add --masters 10.211.55.18,10.211.55.19</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>添加 worker 节点</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加 worker 节点，多个都会分隔</span></span><br><span class="line">sealos add --nodes 10.211.55.20,10.211.55.21</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>删除 master 节点</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除 master 节点后，剩余的 master 节点个数必须为奇数，否则会报错</span></span><br><span class="line">sealos delete --masters 10.211.55.18,10.211.55.19</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>删除 worker 节点</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sealos delete --nodes 10.211.55.20,10.211.55.21</span><br></pre></td></tr></table></figure><h3 id="镜像管理">镜像管理</h3><ul class="lvl-0"><li class="lvl-2"><p>查看所有镜像</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sealos images</span><br><span class="line">REPOSITORY                                                 TAG        IMAGE ID       CREATED         SIZE</span><br><span class="line">docker.io/labring/kubernetes                               v1.29.9    bca192f35556   2 months ago    669 MB</span><br><span class="line">docker.io/labring/cilium                                   v1.13.4    71aa52ad0a11   23 months ago   483 MB</span><br><span class="line">docker.io/labring/helm                                     v3.9.4     3376f6822067   2 years ago     46.4 MB</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>删除镜像</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sealos rmi [image_id] | [image_name]</span></span><br><span class="line">sealos rmi docker.io/labring/kubernetes:v1.29.9</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>拉取镜像</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sealos pull docker.io/labring/kubernetes:v1.29.9</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>登录镜像仓库，建议登录仓库，这样可以提高拉取镜像的次数，避免拉取镜像失败</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker.io 官方dockerhub镜像仓库</span></span><br><span class="line">sealos login docker.io -u [username] -p [password]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>为镜像打tag</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sealos tag docker.io/labring/kubernetes:v1.29.9 docker.io/hanqunfeng/kubernetes:v1.29.9</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>推送镜像</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sealos push docker.io/hanqunfeng/kubernetes:v1.29.9</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>查看镜像详情</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sealos inspect [image_id] | [image_name]</span></span><br><span class="line">sealos inspect docker.io/labring/kubernetes:v1.29.9</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>登出镜像仓库</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登出指定的仓库</span></span><br><span class="line">sealos <span class="built_in">logout</span> docker.io</span><br><span class="line"><span class="comment"># 登出所有仓库</span></span><br><span class="line">sealos <span class="built_in">logout</span> --all</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>通过 Dockerfile 构建镜像</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 与 docker build 类似，构建好的镜像会增加前缀 localhost/</span></span><br><span class="line">sealos build -t myapp:v1.0.0 -f Dockerfile .</span><br></pre></td></tr></table></figure><h3 id="容器管理">容器管理</h3><ul class="lvl-0"><li class="lvl-2"><p>查看所有容器</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sealos ps</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>查看容器详情</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sealos inspect [container_id] | [container_name]</span></span><br><span class="line">sealos inspect bca192f35556</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

引用本地其它文章连接{}
 大括号开始% post_link 文件名称(不包含.md) %大括号结束
 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍 Linux 下 使用 sealos 安装 K8S 的方法，本文以 CentOS 8 为例。&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/&quot;&gt;K8S官网&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/kubernetes/kubernetes&quot;&gt;k8s Github&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://sealos.run/docs/k8s/quick-start/deploy-kubernetes&quot;&gt;sealos官网&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/labring/sealos&quot;&gt;sealos Github&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="k8s" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/k8s/"/>
    
    
    <category term="K8S" scheme="https://blog.hanqunfeng.com/tags/K8S/"/>
    
  </entry>
  
  <entry>
    <title>Linux 安装 K8S 之 kubeadm</title>
    <link href="https://blog.hanqunfeng.com/2025/06/29/k8s-install-kubeadm/"/>
    <id>https://blog.hanqunfeng.com/2025/06/29/k8s-install-kubeadm/</id>
    <published>2025-06-29T14:30:05.000Z</published>
    <updated>2025-07-20T03:10:41.428Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote %引用本地其它文章连接{} 大括号开始% post_link 文件名称(不包含.md) %大括号结束 --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍 Linux 下 使用 kubeadm 安装 K8S 的方法，本文以 CentOS 8 为例。</p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/">K8S官网</a></p></li><li class="lvl-2"><p><a href="https://github.com/kubernetes/kubernetes">k8s Github</a></p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/">使用 kubeadm 引导集群</a></p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/docs/reference/setup-tools/kubeadm/">kubeadm 命令指南</a></p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/">用 kubeadm 进行管理</a></p></li></ul><span id="more"></span><h2 id="安装前设置-所有节点">安装前设置(所有节点)</h2><h3 id="修正系统的时间">修正系统的时间</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装chrony</span></span><br><span class="line"><span class="built_in">sudo</span> dnf install chrony -y</span><br><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> --now chronyd</span><br><span class="line"><span class="comment"># 修正时间</span></span><br><span class="line"><span class="built_in">sudo</span> chronyc makestep</span><br><span class="line"><span class="comment"># 查看时间</span></span><br><span class="line"><span class="built_in">date</span></span><br></pre></td></tr></table></figure><h3 id="安装-docker-可选">安装 <code>docker</code>(可选)</h3><ul class="lvl-0"><li class="lvl-2"><p>k8s 使用<code>docker</code>作为容器运行时才需要安装，安装方法参见 <a href="/2025/05/20/docker-install/" title="Linux 安装 Docker">Linux 安装 Docker</a></p></li></ul><h3 id="创建用户">创建用户</h3><ul class="lvl-0"><li class="lvl-2"><p>避免使用root用户，这里创建一个 <code>centos</code> 用户，要求该用户具有<code>sudo</code>权限，如果使用<code>docker</code>运行时，则需要将该用户添加到<code>docker</code>用户组</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.创建用户</span></span><br><span class="line">$ <span class="built_in">sudo</span> useradd -m -s /bin/bash centos</span><br><span class="line"><span class="comment"># 2.添加到docker用户组</span></span><br><span class="line">$ <span class="built_in">sudo</span> usermod -aG docker centos</span><br><span class="line"><span class="comment"># 3.将用户添加到 sudo（管理员）组，说明：wheel 是 CentOS 中允许使用 sudo 权限的用户组。具体可以通过 visudo 命令查看</span></span><br><span class="line">$ <span class="built_in">sudo</span> usermod -aG wheel centos</span><br><span class="line"><span class="comment">## 这种添加方式使用sudo时需要输入密码，如果不希望输入密码，可以通过 visudo 命令修改，将 wheel 组改为 %wheel ALL=(ALL) NOPASSWD: ALL 的形式</span></span><br><span class="line"><span class="comment"># 4.切换用户，以下操作均在该用户下进行</span></span><br><span class="line">$ su - centos</span><br></pre></td></tr></table></figure><h3 id="升级内核">升级内核</h3><ul class="lvl-0"><li class="lvl-2"><p>由 kubeadm 创建的 Kubernetes 集群依赖于使用内核特性的相关软件。</p></li><li class="lvl-3"><p>Kubernetes 集群的节点对于使用 Linux 内核版本要求参加<a href="https://kubernetes.io/zh-cn/docs/reference/node/kernel-version-requirements/">Linux 内核版本要求</a></p></li><li class="lvl-3"><p>kubeadm 项目支持 LTS 内核。参阅 <a href="https://www.kernel.org/category/releases.html">LTS 内核列表</a>。</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前内核版本，可以看到当前内核版本为 4.18.0</span></span><br><span class="line">$ <span class="built_in">uname</span> -r</span><br><span class="line">4.18.0-553.el8_10.x86_64</span><br><span class="line"><span class="comment">#查看 yum 中可升级的内核版本</span></span><br><span class="line">$ <span class="built_in">sudo</span> yum list kernel --showduplicates</span><br><span class="line"><span class="comment">#如果list中有需要的版本可以直接执行 update 升级，多数是没有的，所以要按以下步骤操作</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#导入ELRepo软件仓库的公共秘钥</span></span><br><span class="line">$ <span class="built_in">sudo</span> rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span><br><span class="line"></span><br><span class="line"><span class="comment">#Centos7系统安装ELRepo</span></span><br><span class="line"><span class="comment"># $sudo yum install https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm</span></span><br><span class="line"><span class="comment">#Centos8系统安装ELRepo</span></span><br><span class="line">$ <span class="built_in">sudo</span> yum install https://www.elrepo.org/elrepo-release-8.el8.elrepo.noarch.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看ELRepo提供的内核版本</span></span><br><span class="line">$ <span class="built_in">sudo</span> yum --disablerepo=<span class="string">&quot;*&quot;</span> --enablerepo=<span class="string">&quot;elrepo-kernel&quot;</span> list available</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#kernel-lt：表示longterm，即长期支持的内核，当前lt内核版本为 5.4.295</span></span><br><span class="line"><span class="comment">#kernel-ml：表示mainline，即当前主线的内核，当前ml内核版本为 6.15.4，笔者测试安装该版本内核最后创建集群时会失败</span></span><br><span class="line"><span class="comment">#安装lt内核</span></span><br><span class="line">$ <span class="built_in">sudo</span> yum --enablerepo=elrepo-kernel install kernel-lt.x86_64</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看已安装的内核版本，可以看到 刚刚安装的 5.4.295 内核版本的两个文件</span></span><br><span class="line">$ <span class="built_in">ls</span> -lh /boot/vmlinuz-* /boot/initramfs-* | grep <span class="string">&quot;5.4&quot;</span></span><br><span class="line">-rw-------  1 root root  29M 6月  29 17:15 /boot/initramfs-5.4.295-1.el8.elrepo.x86_64.img</span><br><span class="line">-rwxr-xr-x  1 root root 9.5M 6月  28 01:21 /boot/vmlinuz-5.4.295-1.el8.elrepo.x86_64</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看可以使用的内核</span></span><br><span class="line">$ <span class="built_in">sudo</span> grubby --info=ALL | grep ^kernel</span><br><span class="line">kernel=<span class="string">&quot;/boot/vmlinuz-5.4.295-1.el8.elrepo.x86_64&quot;</span></span><br><span class="line">kernel=<span class="string">&quot;/boot/vmlinuz-4.18.0-553.el8_10.x86_64&quot;</span></span><br><span class="line">kernel=<span class="string">&quot;/boot/vmlinuz-0-rescue-88f75739047993488aacc30b9cd25ca0&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看默认内核，默认情况下，系统会自动将新安装的内核设置为默认启动内核</span></span><br><span class="line">$ <span class="built_in">sudo</span> grubby --default-kernel</span><br><span class="line">/boot/vmlinuz-5.4.295-1.el8.elrepo.x86_64</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果没有自动启用，则通过该命令设置默认内核</span></span><br><span class="line">$ <span class="built_in">sudo</span> grubby --set-default /boot/vmlinuz-5.4.295-1.el8.elrepo.x86_64</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启系统</span></span><br><span class="line">$ <span class="built_in">sudo</span> reboot</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启登录后验证内核版本</span></span><br><span class="line">$ <span class="built_in">uname</span> -r</span><br><span class="line">5.4.295-1.el8.elrepo.x86_64</span><br></pre></td></tr></table></figure><h3 id="将-SELinux-设置为-permissive-模式（相当于将其禁用）">将 SELinux 设置为 permissive 模式（相当于将其禁用）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> setenforce 0</span><br><span class="line">$ <span class="built_in">sudo</span> sed -i <span class="string">&#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27;</span> /etc/selinux/config</span><br></pre></td></tr></table></figure><h3 id="禁用Firewalld">禁用Firewalld</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为了方便，这里可以禁用 firewalld</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl stop firewalld</span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure><h4 id="不关-Firewalld-应该开放哪些端口？-实测还是会遇到各种各样的问题">不关 Firewalld 应该开放哪些端口？(实测还是会遇到各种各样的问题)</h4><ul class="lvl-0"><li class="lvl-2"><p>Master 节点需要开放的端口</p></li></ul><table><thead><tr><th>端口</th><th>协议</th><th>说明</th></tr></thead><tbody><tr><td><strong>6443</strong></td><td>TCP</td><td>kube-apiserver，用于 kubectl 与集群通信</td></tr><tr><td><strong>2379-2380</strong></td><td>TCP</td><td>etcd 集群通信（仅在你自己部署 etcd 时）</td></tr><tr><td><strong>10250</strong></td><td>TCP</td><td>kubelet 监听端口，供 apiserver 与节点通信</td></tr><tr><td><strong>10259</strong></td><td>TCP</td><td>kube-scheduler</td></tr><tr><td><strong>10257</strong></td><td>TCP</td><td>kube-controller-manager</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>Worker 节点需要开放的端口</p></li></ul><table><thead><tr><th>端口</th><th>协议</th><th>说明</th></tr></thead><tbody><tr><td><strong>10250</strong></td><td>TCP</td><td>kubelet 与 apiserver 通信</td></tr><tr><td><strong>30000-32767</strong></td><td>TCP</td><td>NodePort 服务默认端口范围</td></tr><tr><td><strong>10255</strong></td><td>TCP</td><td>kubelet 只读端口（默认关闭，可不开放）</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>如果你使用的是 Calico 网络插件</p></li></ul><table><thead><tr><th>端口</th><th>协议</th><th>说明</th></tr></thead><tbody><tr><td><strong>179</strong></td><td>TCP</td><td>BGP 通信端口，用于 Calico 节点间路由（若使用 BGP 模式）</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>如果你使用的是 Flannel（VXLAN 模式）</p></li></ul><table><thead><tr><th>端口</th><th>协议</th><th>说明</th></tr></thead><tbody><tr><td><strong>8472</strong></td><td>UDP</td><td>VXLAN 数据通信</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>Ingress 控制器（比如 NGINX Ingress）</p></li></ul><table><thead><tr><th>端口</th><th>协议</th><th>说明</th></tr></thead><tbody><tr><td><strong>80</strong> / <strong>443</strong></td><td>TCP</td><td>提供 HTTP/HTTPS 服务访问（Ingress 服务）</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>示例命令：使用 firewall-cmd 开放端口</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动 firewalld</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl start firewalld</span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> firewalld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例：开放常用端口</span></span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --permanent --add-port=6443/tcp</span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --permanent --add-port=2379-2380/tcp</span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --permanent --add-port=10250/tcp</span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --permanent --add-port=10259/tcp</span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --permanent --add-port=10257/tcp</span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --permanent --add-port=30000-32767/tcp</span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --permanent --add-port=179/tcp       <span class="comment"># 如果用 Calico</span></span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --permanent --add-port=8472/udp      <span class="comment"># 如果用 Flannel</span></span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --permanent --add-port=80/tcp        <span class="comment"># Ingress</span></span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --permanent --add-port=443/tcp       <span class="comment"># Ingress</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许 Calico 的封装协议 IPIP ,允许 IPIP 协议（协议号 4）</span></span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --permanent --direct --add-rule ipv4 filter INPUT 0 -p 4 -j ACCEPT</span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --permanent --direct --add-rule ipv4 filter OUTPUT 0 -p 4 -j ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果 Calico 使用 VXLAN 模式，则需要开放 4789 端口</span></span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --permanent --add-port=4789/udp</span><br><span class="line"><span class="comment"># Calico Typha 网络</span></span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --permanent --add-port=5473/tcp</span><br><span class="line"></span><br><span class="line"><span class="comment"># Calico WireGuard（IPv4 和 IPv6）</span></span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --permanent --add-port=51820/udp</span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --permanent --add-port=51821/udp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用更改</span></span><br><span class="line"><span class="built_in">sudo</span> firewall-cmd --reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看开放的端口</span></span><br><span class="line">$ <span class="built_in">sudo</span> firewall-cmd --list-ports</span><br><span class="line">80/tcp 179/tcp 443/tcp 2377/tcp 2379-2380/tcp 6443/tcp 7946/tcp 10250/tcp 10257/tcp 10259/tcp 30000-32767/tcp 4789/udp 7946/udp 8472/udp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看开放的直接规则</span></span><br><span class="line">$ <span class="built_in">sudo</span> firewall-cmd --direct --get-all-rules</span><br><span class="line">ipv4 filter INPUT 0 -p 4 -j ACCEPT</span><br></pre></td></tr></table></figure><h3 id="关闭swap">关闭swap</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> swapoff -a</span><br><span class="line"><span class="built_in">sudo</span> sed -i <span class="string">&#x27;/ swap / s/^/#/&#x27;</span> /etc/fstab</span><br></pre></td></tr></table></figure><h3 id="加载内核模块">加载内核模块</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> modprobe overlay</span><br><span class="line"><span class="built_in">sudo</span> modprobe br_netfilter</span><br></pre></td></tr></table></figure><h3 id="设置内核参数">设置内核参数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/sysctl.d/kubernetes.conf</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> sysctl --system</span><br></pre></td></tr></table></figure><h3 id="安装containerd">安装containerd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line"><span class="built_in">sudo</span> yum config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"><span class="built_in">sudo</span> yum install -y containerd.io</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /etc/containerd</span><br><span class="line"><span class="built_in">sudo</span> containerd config default | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置Systemd为cgroup driver</span></span><br><span class="line"><span class="built_in">sudo</span> sed -i <span class="string">&#x27;s/SystemdCgroup = false/SystemdCgroup = true/&#x27;</span> /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动并设置开机启动</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> --now containerd</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>如果是国内环境，可以在<code>/etc/containerd/config.toml</code>添加镜像加速器配置</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> vim /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 找到 registry.mirrors 字段，添加加速器，比如：</span></span><br><span class="line">[plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors]</span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors.<span class="string">&quot;docker.io&quot;</span>]</span><br><span class="line">    endpoint = [<span class="string">&quot;https://docker.1ms.run&quot;</span>, <span class="string">&quot;https://docker.xuanyuan.me&quot;</span>, <span class="string">&quot;https://docker.m.daocloud.io&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改后重启 containerd</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl restart containerd</span><br></pre></td></tr></table></figure><h3 id="安装cri-dockerd-可选">安装cri-dockerd(可选)</h3><ul class="lvl-0"><li class="lvl-2"><p>如果使用 containerd，则不需要安装 cri-dockerd</p></li><li class="lvl-2"><p>Kubernetes 1.24+ 默认移除了 dockershim，所以你必须安装 cri-dockerd 才能继续使用 Docker</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载并安装 cri-dockerd RPM，目前最新版是 0.3.19，fc35: Fedora 35 构建，适配 RHEL/CentOS 8 系统的 glibc 和 libstdc++</span></span><br><span class="line">$ curl -LO https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.19/cri-dockerd-0.3.19-3.fc35.x86_64.rpm</span><br><span class="line"><span class="comment"># 安装时报错：cri-dockerd-0.3.19-3.fc35.x86_64.rpm 依赖 GLIBC ≥ 2.32 和 2.34，但 CentOS 8 系统只提供 GLIBC 2.28。</span></span><br><span class="line">$ <span class="built_in">sudo</span> dnf install -y ./cri-dockerd-0.3.19-3.fc35.x86_64.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新下载一个兼容的版本即可，这里选择：cri-dockerd-0.3.14-3.el8.x86_64.rpm</span></span><br><span class="line">$ curl -LO https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.14/cri-dockerd-0.3.14-3.el8.x86_64.rpm</span><br><span class="line">$ <span class="built_in">sudo</span> dnf install -y ./cri-dockerd-0.3.14-3.el8.x86_64.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新加载服务</span></span><br><span class="line">$ <span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line"><span class="comment"># 加入开机启动并立刻启动</span></span><br><span class="line">$ <span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> --now cri-docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后面的 kubeadm 命令 都要加上 --cri-socket unix:///var/run/cri-dockerd.sock</span></span><br></pre></td></tr></table></figure><h3 id="安装-kubelet-kubeadm-kubectl">安装 kubelet, kubeadm, kubectl</h3><ul class="lvl-0"><li class="lvl-2"><p>添加 Kubernetes YUM 源，k8s 的版本从<a href="https://kubernetes.io/zh-cn/docs/home/supported-doc-versions/">官网</a>获取</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://pkgs.k8s.io/core:/stable:/v1.33/rpm/</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">repo_gpgcheck=1</span></span><br><span class="line"><span class="string">gpgkey=https://pkgs.k8s.io/core:/stable:/v1.33/rpm/repodata/repomd.xml.key</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理yum缓存并重新建立缓存</span></span><br><span class="line">$ <span class="built_in">sudo</span> yum clean all &amp;&amp; <span class="built_in">sudo</span> yum makecache</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>安装 kubelet, kubeadm, kubectl</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看kubeadm有什么版本</span></span><br><span class="line">$ <span class="built_in">sudo</span> yum list --showduplicates  kubeadm</span><br><span class="line"><span class="comment"># 不指定版本默认那种最新版</span></span><br><span class="line">$ <span class="built_in">sudo</span> yum install -y kubelet kubeadm kubectl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用kubelet</span></span><br><span class="line">$ <span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> --now kubelet</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定容器运行时为containerd，这里通过 crictl 指定容器运行时为 containerd</span></span><br><span class="line"><span class="comment"># 配置文件：/etc/crictl.yaml</span></span><br><span class="line">$ <span class="built_in">sudo</span> crictl config runtime-endpoint /run/containerd/containerd.sock</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查</span></span><br><span class="line">$ kubeadm version</span><br><span class="line">$ kubelet --version</span><br><span class="line">$ kubectl version --client</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>启用 shell 自动补全功能</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.安装 bash-completion</span></span><br><span class="line"><span class="comment"># 1.1 检查bash-completion是否已安装，有输出说明已经安装</span></span><br><span class="line">$ <span class="built_in">type</span> _init_completion</span><br><span class="line"><span class="comment"># 1.2 安装bash-completion，安装后会创建文件 /usr/share/bash-completion/bash_completion</span></span><br><span class="line">$ dnf install bash-completion</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.安装 kubectl 的自动补全功能</span></span><br><span class="line"><span class="comment"># 2.1 当前用户</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;source &lt;(kubectl completion bash)&#x27;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="comment"># 2.2 所有用户</span></span><br><span class="line">$ kubectl completion bash | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/bash_completion.d/kubectl &gt; /dev/null</span><br><span class="line">$ <span class="built_in">sudo</span> <span class="built_in">chmod</span> a+r /etc/bash_completion.d/kubectl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3 如果 kubectl 有关联的别名，你可以扩展 Shell 补全来适配此别名</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;alias k=kubectl&#x27;</span> &gt;&gt;~/.bashrc</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;complete -o default -F __start_kubectl k&#x27;</span> &gt;&gt;~/.bashrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.刷新配置文件</span></span><br><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure><h2 id="创建集群-master节点">创建集群(master节点)</h2><ul class="lvl-0"><li class="lvl-2"><p>master节点: [hostname: k8s-master, IP: 10.211.55.11]</p></li><li class="lvl-2"><p>初始化master节点的控制面板，容器运行时基于 <code>containerd</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubeadm init --help可以查看命令的具体参数用法</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在master节点执行初始化（node节点不用执行）</span></span><br><span class="line"><span class="comment"># --apiserver-advertise-address  指定apiserver的IP，即master节点的IP</span></span><br><span class="line"><span class="comment"># --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers 设置镜像仓库为国内镜像仓库</span></span><br><span class="line"><span class="comment"># --kubernetes-version  设置k8s的版本，跟kubeadm版本一致</span></span><br><span class="line"><span class="comment"># --service-cidr  这是设置node节点的网络的，暂时这样设置</span></span><br><span class="line"><span class="comment"># --pod-network-cidr  这是设置node节点的网络的，暂时这样设置</span></span><br><span class="line"><span class="comment"># --cri-socket unix:///var/run/cri-dockerd.sock  设置cri使用cri-dockerd</span></span><br><span class="line"><span class="comment"># --ignore-preflight-errors=all  忽略所有预检错误（Preflight Errors）。这会跳过对系统状态的某些检查，例如是否启用了 swap、CPU 核心数、系统配置等。不推荐用于生产，只用于调试或测试环境。</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">sudo</span> kubeadm init \</span><br><span class="line">--apiserver-advertise-address=10.211.55.11 \</span><br><span class="line">--kubernetes-version v1.33.2 \</span><br><span class="line">--service-cidr=10.96.0.0/16 \</span><br><span class="line">--pod-network-cidr=10.244.0.0/16</span><br><span class="line"><span class="comment">## 安装成功会打印如下信息</span></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  <span class="built_in">sudo</span> <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  <span class="built_in">sudo</span> <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">Alternatively, <span class="keyword">if</span> you are the root user, you can run:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can <span class="built_in">join</span> any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm <span class="built_in">join</span> 10.211.55.11:6443 --token sqwk6v.lxlnf0ibtbgr4i27 \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:c43f8b6d0e7081a76ab1d8ca8d3c5fb1ef3b21afcd81874566d7840167809412</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>查看集群状态</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 集群信息</span></span><br><span class="line">$ k cluster-info</span><br><span class="line">Kubernetes control plane is running at https://10.211.55.11:6443</span><br><span class="line">CoreDNS is running at https://10.211.55.11:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span><br><span class="line"><span class="comment"># 查看组件状态</span></span><br><span class="line">$ k get cs</span><br><span class="line">Warning: v1 ComponentStatus is deprecated <span class="keyword">in</span> v1.19+</span><br><span class="line">NAME                 STATUS    MESSAGE   ERROR</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">etcd-0               Healthy   ok</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>为当前用户授予连接集群的权限</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">$ <span class="built_in">sudo</span> <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">$ <span class="built_in">sudo</span> <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>安装网络插件：<a href="https://kubernetes.io/zh-cn/docs/concepts/cluster-administration/addons/">k8s支持的网络插件</a>，</p></li><li class="lvl-2"><p><a href="https://www.tigera.io/project-calico/">calico官网</a></p></li><li class="lvl-2"><p><a href="https://github.com/projectcalico/calico">calico GitHub</a>]</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装calico前查看pod，-A 查看所有命名空间</span></span><br><span class="line">$ kubectl get pods -A</span><br><span class="line">NAMESPACE     NAME                          READY   STATUS    RESTARTS      AGE</span><br><span class="line">kube-system   coredns-674b8bbfcf-8xllc      0/1     Pending   0             116m</span><br><span class="line">kube-system   coredns-674b8bbfcf-w2sxz      0/1     Pending   0             116m</span><br><span class="line">kube-system   etcd-k8s                      1/1     Running   2 (74m ago)   116m</span><br><span class="line">kube-system   kube-apiserver-k8s            1/1     Running   2 (74m ago)   116m</span><br><span class="line">kube-system   kube-controller-manager-k8s   1/1     Running   2 (74m ago)   116m</span><br><span class="line">kube-system   kube-proxy-94zqw              1/1     Running   1 (74m ago)   116m</span><br><span class="line">kube-system   kube-scheduler-k8s            1/1     Running   2 (74m ago)   116m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载yaml文件，目前最新版为 v3.30.2</span></span><br><span class="line">$ curl -LO https://raw.githubusercontent.com/projectcalico/calico/v3.30.2/manifests/calico.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建</span></span><br><span class="line">$ kubectl apply -f calico.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装calico后查看pod，在安装 Calico 之前 CoreDNS 是 Pending 状态，现在已经变成 Running</span></span><br><span class="line"><span class="comment"># -o wide: 显示pod的详细信息</span></span><br><span class="line">$ kubectl get pods -A -o wide</span><br><span class="line">NAMESPACE     NAME                                       READY   STATUS    RESTARTS      AGE     IP             NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">kube-system   calico-kube-controllers-7bfdc5b57c-9qv9m   1/1     Running   0             6m23s   10.244.77.1    k8s    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   calico-node-m7wc5                          1/1     Running   0             6m23s   10.211.55.11   k8s    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   coredns-674b8bbfcf-8xllc                   1/1     Running   0             123m    10.244.77.3    k8s    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   coredns-674b8bbfcf-w2sxz                   1/1     Running   0             123m    10.244.77.2    k8s    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   etcd-k8s                                   1/1     Running   2 (82m ago)   123m    10.211.55.11   k8s    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-apiserver-k8s                         1/1     Running   2 (82m ago)   123m    10.211.55.11   k8s    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-controller-manager-k8s                1/1     Running   2 (82m ago)   123m    10.211.55.11   k8s    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-94zqw                           1/1     Running   1 (82m ago)   123m    10.211.55.11   k8s    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-scheduler-k8s                         1/1     Running   2 (82m ago)   123m    10.211.55.11   k8s    &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><blockquote><p>calica 安装后可能出现不正常的情况，比如 <code>calico-node-xxx</code> 的pod始终无法正常运行，此时可以尝试重新安装 calica</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除 calico</span></span><br><span class="line">$ kubectl delete -f calico.yaml</span><br><span class="line"><span class="comment">#如果是重装calico，需要先清除旧的配置</span></span><br><span class="line">$ <span class="built_in">sudo</span> <span class="built_in">rm</span> -rf /etc/cni/net.d/</span><br><span class="line">$ <span class="built_in">sudo</span> <span class="built_in">rm</span> -rf /var/lib/calico</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新安装 calico</span></span><br><span class="line">$ kubectl apply -f calico.yaml</span><br></pre></td></tr></table></figure><h2 id="添加节点-worker节点">添加节点(worker节点)</h2><ul class="lvl-0"><li class="lvl-2"><p>worker节点: [hostname: k8s-worker1, IP: 10.211.55.15]</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在待加入的节点上执行如下命令，如果忘记token，则使用下文的命令重新获取</span></span><br><span class="line">$ <span class="built_in">sudo</span> kubeadm <span class="built_in">join</span> 10.211.55.11:6443 --token sqwk6v.lxlnf0ibtbgr4i27 --discovery-token-ca-cert-hash sha256:c43f8b6d0e7081a76ab1d8ca8d3c5fb1ef3b21afcd81874566d7840167809412</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">        [WARNING SystemVerification]: cgroups v1 support is <span class="keyword">in</span> maintenance mode, please migrate to cgroups v2</span><br><span class="line">[preflight] Reading configuration from the <span class="string">&quot;kubeadm-config&quot;</span> ConfigMap <span class="keyword">in</span> namespace <span class="string">&quot;kube-system&quot;</span>...</span><br><span class="line">[preflight] Use <span class="string">&#x27;kubeadm init phase upload-config --config your-config-file&#x27;</span> to re-upload it.</span><br><span class="line">[kubelet-start] Writing kubelet configuration to file <span class="string">&quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class="line">[kubelet-start] Writing kubelet environment file with flags to file <span class="string">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class="line">[kubelet-start] Starting the kubelet</span><br><span class="line">[kubelet-check] Waiting <span class="keyword">for</span> a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s</span><br><span class="line">[kubelet-check] The kubelet is healthy after 1.004135788s</span><br><span class="line">[kubelet-start] Waiting <span class="keyword">for</span> the kubelet to perform the TLS Bootstrap</span><br><span class="line"></span><br><span class="line">This node has joined the cluster:</span><br><span class="line">* Certificate signing request was sent to apiserver and a response was received.</span><br><span class="line">* The Kubelet was informed of the new secure connection details.</span><br><span class="line"></span><br><span class="line">Run <span class="string">&#x27;kubectl get nodes&#x27;</span> on the control-plane to see this node <span class="built_in">join</span> the cluster.</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>如果上面的令牌忘记了，或者新的 worker 节点加入，在 master 上执行下面的命令，生成新的令牌</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm token create --print-join-command</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line">kubeadm <span class="built_in">join</span> 10.211.55.11:6443 --token 5o3p2i.gj95aopph0xbrcig --discovery-token-ca-cert-hash sha256:c43f8b6d0e7081a76ab1d8ca8d3c5fb1ef3b21afcd81874566d7840167809412</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>在 master 节点上查看新创建的资源，默认情况下 work 节点不支持管理 k8s</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看节点</span></span><br><span class="line">$ kubectl get nodes</span><br><span class="line">NAME          STATUS     ROLES           AGE     VERSION</span><br><span class="line">k8s           Ready      control-plane   3h33m   v1.33.2</span><br><span class="line">k8s-worker1   Ready      &lt;none&gt;          115s    v1.33.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod list</span></span><br><span class="line">$ kubectl get pods -A -o wide</span><br><span class="line">NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE     IP               NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">kube-system   calico-kube-controllers-7bfdc5b57c-q5xwp   1/1     Running   0          37m     10.244.235.193   k8s-master    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   calico-node-7pbbq                          1/1     Running   0          4m51s   10.211.55.15     k8s-worker1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   calico-node-w47qq                          1/1     Running   0          37m     10.211.55.11     k8s-master    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   coredns-674b8bbfcf-2tvld                   1/1     Running   0          37m     10.244.235.195   k8s-master    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   coredns-674b8bbfcf-h6kx7                   1/1     Running   0          37m     10.244.235.194   k8s-master    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   etcd-k8s-master                            1/1     Running   2          37m     10.211.55.11     k8s-master    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-apiserver-k8s-master                  1/1     Running   4          37m     10.211.55.11     k8s-master    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-controller-manager-k8s-master         1/1     Running   4          37m     10.211.55.11     k8s-master    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-nkbns                           1/1     Running   0          4m51s   10.211.55.15     k8s-worker1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-plqw8                           1/1     Running   0          37m     10.211.55.11     k8s-master    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-scheduler-k8s-master                  1/1     Running   4          38m     10.211.55.11     k8s-master    &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>使 work 节点支持管理 k8s(可选)：远程管理</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 master 节点中的 ~/.kube/config 复制到 work 节点的 ~/.kube/config 即可</span></span><br><span class="line"><span class="comment"># 在 master 节点执行</span></span><br><span class="line">scp ~/.kube/config k8s-work1:/tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 work 节点执行</span></span><br><span class="line"><span class="built_in">mkdir</span> -p ~/.kube</span><br><span class="line"><span class="built_in">mv</span> /tmp/config ~/.kube/config</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>删除work节点</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># master, 删除节点前先清空节点上的所有 Pod，使其调度到其他节点</span></span><br><span class="line">$ kubectl drain k8s-worker1 --ignore-daemonsets</span><br><span class="line"></span><br><span class="line"><span class="comment"># worker节点上执行如下命令</span></span><br><span class="line"><span class="comment">## 在移除节点之前，请重置 kubeadm 安装的状态</span></span><br><span class="line">$ <span class="built_in">sudo</span> kubeadm reset</span><br><span class="line"><span class="comment">## 重置过程不会重置或清除 iptables 规则或 IPVS 表。如果你希望重置 iptables，则必须手动进行</span></span><br><span class="line">$ iptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -X</span><br><span class="line"></span><br><span class="line"><span class="comment"># master 节点上删除节点</span></span><br><span class="line">$ kubectl delete node k8s-worker1</span><br></pre></td></tr></table></figure><h2 id="测试：用K8S部署Nginx">测试：用K8S部署Nginx</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建deployment</span></span><br><span class="line">kubectl create deployment nginx --image=nginx</span><br><span class="line"><span class="comment"># 创建service，--type指定为NodePort，其含义为将deployment的80端口映射到Node的随机端口</span></span><br><span class="line">kubectl expose deployment nginx --<span class="built_in">type</span>=NodePort --port=80</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod和service，不加 -n 参数，默认查看的是default命名空间</span></span><br><span class="line">$ kubectl get pod,svc -o wide</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE   IP              NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">pod/nginx-5869d7778c-95z74   1/1     Running   0          19m   10.244.194.65   k8s-worker1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE   SELECTOR</span><br><span class="line">service/kubernetes   ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP        61m   &lt;none&gt;</span><br><span class="line">service/nginx        NodePort    10.96.48.156   &lt;none&gt;        80:30291/TCP   14m   app=nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 浏览器访问任意nodeIP:30291</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除测试资源</span></span><br><span class="line"><span class="comment">## 删除deployment</span></span><br><span class="line">kubectl delete deployment nginx</span><br><span class="line"><span class="comment">## 删除service</span></span><br><span class="line">kubectl delete service nginx</span><br></pre></td></tr></table></figure><h2 id="通过-kubeadm-卸载-Kubernetes">通过 kubeadm 卸载 Kubernetes</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 停止 kubelet 相关组件,删除 /etc/kubernetes 配置,清除证书、状态目录等,取消 iptables 规则,清除容器运行时中的 Pod、镜像信息等</span></span><br><span class="line">$ <span class="built_in">sudo</span> kubeadm reset</span><br><span class="line"><span class="comment"># 虽然 kubeadm reset 已经会清除大部分内容，但以下文件和配置可能依然存在，建议一并手动清理</span></span><br><span class="line"><span class="comment">## 删除 kubeconfig 文件（本地 kubectl 配置）</span></span><br><span class="line"><span class="built_in">rm</span> -rf <span class="variable">$HOME</span>/.kube</span><br><span class="line"><span class="comment">## 清理 etcd 数据（如你启用了本地 etcd）</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> -rf /var/lib/etcd</span><br><span class="line"><span class="comment">## 清理 CNI 网络配置和状态</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> -rf /etc/cni/net.d</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> -rf /var/lib/cni/</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> -rf /var/lib/kubelet/*</span><br><span class="line"><span class="comment"># 清理 Calico</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> -rf /var/lib/calico</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理 iptables</span></span><br><span class="line"><span class="built_in">sudo</span> iptables -F</span><br><span class="line"><span class="built_in">sudo</span> iptables -X</span><br><span class="line"><span class="built_in">sudo</span> iptables -t nat -F</span><br><span class="line"><span class="built_in">sudo</span> iptables -t nat -X</span><br><span class="line"><span class="built_in">sudo</span> iptables -t mangle -F</span><br><span class="line"><span class="built_in">sudo</span> iptables -t mangle -X</span><br><span class="line"><span class="built_in">sudo</span> iptables -P INPUT ACCEPT</span><br><span class="line"><span class="built_in">sudo</span> iptables -P FORWARD ACCEPT</span><br><span class="line"><span class="built_in">sudo</span> iptables -P OUTPUT ACCEPT</span><br></pre></td></tr></table></figure><h2 id="停止和禁用-kubelet-服务">停止和禁用 kubelet 服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl stop kubelet</span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">disable</span> kubelet</span><br></pre></td></tr></table></figure><h2 id="升级-kubeadm-集群">升级 kubeadm 集群</h2><ul class="lvl-0"><li class="lvl-2"><p>将 kubeadm 创建的 Kubernetes 集群从 1.32.x 版本 升级到 1.33.x 版本以及从 1.33.x 升级到 1.33.y（其中 y &gt; x），略过次版本号的升级是 不被支持的。</p></li></ul><h3 id="升级步骤">升级步骤</h3><h4 id="升级-master-节点">升级 master 节点</h4><ul class="lvl-0"><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/">升级 master 节点</a></p></li><li class="lvl-2"><p>如果要从 <code>v1.33</code> 升级到 <code>v1.34</code>，则需要先修改 Kubernetes YUM 源，因为我上面配置 yum 源时配置的是 <code>v1.33</code></p></li><li class="lvl-2"><p>如果只是从 <code>v1.33.2</code> 升级到 <code>v1.33.3</code>，则不需要修改 Kubernetes YUM 源</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 kubeadm 可以升级的版本</span></span><br><span class="line">$ <span class="built_in">sudo</span> yum list --showduplicates kubeadm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定要升级的版本，比如这里要升级到 1.33.3</span></span><br><span class="line"><span class="built_in">sudo</span> yum install -y kubeadm-1.33.3</span><br><span class="line"><span class="comment"># 查看升级后的版本</span></span><br><span class="line">kubeadm version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证升级计划: 此命令检查你的集群是否可被升级，并取回你要升级的目标版本。 命令也会显示一个包含组件配置版本状态的表格。</span></span><br><span class="line">$ <span class="built_in">sudo</span> kubeadm upgrade plan</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级 master 节点: 这一步会升级 kube-apiserver、controller-manager、scheduler 等静态 Pod。</span></span><br><span class="line">$ <span class="built_in">sudo</span> kubeadm upgrade apply v1.33.3</span><br><span class="line"><span class="comment">## 一旦该命令结束，你应该会看到：</span></span><br><span class="line"> [upgrade/successful] SUCCESS! Your cluster was upgraded to <span class="string">&quot;v1.33.3&quot;</span>. Enjoy!</span><br><span class="line"></span><br><span class="line"> [upgrade/kubelet] Now that your control plane is upgraded, please proceed with upgrading your kubelets <span class="keyword">if</span> you haven<span class="string">&#x27;t already done so.</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>手动升级你的 CNI 驱动插件，比如 Calico</p></li><li class="lvl-2"><p>升级 kubelet 和 kubectl</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装指定的版本</span></span><br><span class="line"><span class="built_in">sudo</span> yum install -y kubelet-1.33.3 kubectl-1.33.3</span><br><span class="line"><span class="comment"># 重启 kubelet</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line"><span class="built_in">sudo</span> systemctl restart kubelet</span><br></pre></td></tr></table></figure><h4 id="升级-worker-节点">升级 worker 节点</h4><ul class="lvl-0"><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/upgrading-linux-nodes/">升级 worker 节点</a></p></li><li class="lvl-2"><p>如果要从 <code>v1.33</code> 升级到 <code>v1.34</code>，则需要先修改 Kubernetes YUM 源，因为我上面配置 yum 源时配置的是 <code>v1.33</code></p></li><li class="lvl-2"><p>如果只是从 <code>v1.33.2</code> 升级到 <code>v1.33.3</code>，则不需要修改 Kubernetes YUM 源</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 kubeadm 可以升级的版本</span></span><br><span class="line">$ <span class="built_in">sudo</span> yum list --showduplicates kubeadm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定要升级的版本，比如这里要升级到 1.33.3</span></span><br><span class="line">$ <span class="built_in">sudo</span> yum install -y kubeadm-1.33.3</span><br><span class="line"><span class="comment"># 查看升级后的版本</span></span><br><span class="line">$ kubeadm version</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>腾空节点：如果有多个 worker 节点，可以选择先腾空节点。如果只有一个 worker 节点，则不需要。</p></li></ul><blockquote><p>drain 是为了在升级期间 避免该节点上正在运行的业务容器受到影响</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在控制平面节点上执行此命令</span></span><br><span class="line"><span class="comment"># 将 &lt;node-to-drain&gt; 替换为你正腾空的节点的名称</span></span><br><span class="line">$ kubectl drain &lt;node-to-drain&gt; --ignore-daemonsets</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>升级 node 节点</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> kubeadm upgrade node</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>升级 kubelet 和 kubectl</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装指定的版本</span></span><br><span class="line">$ <span class="built_in">sudo</span> yum install -y kubelet-1.33.3 kubectl-1.33.3</span><br><span class="line"><span class="comment"># 重启 kubelet</span></span><br><span class="line">$ <span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line">$ <span class="built_in">sudo</span> systemctl restart kubelet</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>如果前面对节点做了 腾空节点 操作，则需要取消对节点的保护，将节点标记为可调度，让节点重新上线</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在控制平面节点上执行此命令</span></span><br><span class="line"><span class="comment"># 将 &lt;node-to-uncordon&gt; 替换为你的节点名称</span></span><br><span class="line">$ kubectl uncordon &lt;node-to-uncordon&gt;</span><br></pre></td></tr></table></figure><h2 id="更新证书">更新证书</h2><ul class="lvl-0"><li class="lvl-2"><p>kubeadm 创建的证书存放在 <code>/etc/kubernetes/pki/</code> 下，默认客户端证书有效期为 1 年</p></li><li class="lvl-2"><p>可以通过如下命令查看证书信息</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get cm kubeadm-config -o yaml</span><br><span class="line">openssl x509 -<span class="keyword">in</span> /etc/kubernetes/pki/apiserver.crt -text</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>查看证书到期时间</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> kubeadm certs check-expiration</span><br><span class="line"><span class="comment">## 输出结果</span></span><br><span class="line"><span class="comment">## 可以看到 客户端 的证书的过期时间，默认值为 1 年</span></span><br><span class="line">CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED</span><br><span class="line">admin.conf                 Jun 29, 2026 14:41 UTC   363d            ca                      no</span><br><span class="line">apiserver                  Jun 29, 2026 14:41 UTC   363d            ca                      no</span><br><span class="line">apiserver-etcd-client      Jun 29, 2026 14:41 UTC   363d            etcd-ca                 no</span><br><span class="line">apiserver-kubelet-client   Jun 29, 2026 14:41 UTC   363d            ca                      no</span><br><span class="line">controller-manager.conf    Jun 29, 2026 14:41 UTC   363d            ca                      no</span><br><span class="line">etcd-healthcheck-client    Jun 29, 2026 14:41 UTC   363d            etcd-ca                 no</span><br><span class="line">etcd-peer                  Jun 29, 2026 14:41 UTC   363d            etcd-ca                 no</span><br><span class="line">etcd-server                Jun 29, 2026 14:41 UTC   363d            etcd-ca                 no</span><br><span class="line">front-proxy-client         Jun 29, 2026 14:41 UTC   363d            front-proxy-ca          no</span><br><span class="line">scheduler.conf             Jun 29, 2026 14:41 UTC   363d            ca                      no</span><br><span class="line">super-admin.conf           Jun 29, 2026 14:41 UTC   363d            ca                      no</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根证书默认有效期为 10 年</span></span><br><span class="line">CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED</span><br><span class="line">ca                      Jun 27, 2035 14:41 UTC   9y              no</span><br><span class="line">etcd-ca                 Jun 27, 2035 14:41 UTC   9y              no</span><br><span class="line">front-proxy-ca          Jun 27, 2035 14:41 UTC   9y              no</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>更新客户端证书</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更新前备份</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> -rf /etc/kubernetes/ /etc/kubernetes.bak</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> -rf /var/lib/etcd/ /var/lib/etcd.bak</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以更新单个客户端证书</span></span><br><span class="line"><span class="comment"># sudo kubeadm certs renew admin.conf</span></span><br><span class="line"><span class="comment"># sudo kubeadm certs renew apiserver</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级全部客户端证书，也只能续期1年</span></span><br><span class="line"><span class="built_in">sudo</span> kubeadm certs renew all</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line">[renew] Reading configuration from the <span class="string">&quot;kubeadm-config&quot;</span> ConfigMap <span class="keyword">in</span> namespace <span class="string">&quot;kube-system&quot;</span>...</span><br><span class="line">[renew] Use <span class="string">&#x27;kubeadm init phase upload-config --config your-config-file&#x27;</span> to re-upload it.</span><br><span class="line"></span><br><span class="line">certificate embedded <span class="keyword">in</span> the kubeconfig file <span class="keyword">for</span> the admin to use and <span class="keyword">for</span> kubeadm itself renewed</span><br><span class="line">certificate <span class="keyword">for</span> serving the Kubernetes API renewed</span><br><span class="line">certificate the apiserver uses to access etcd renewed</span><br><span class="line">certificate <span class="keyword">for</span> the API server to connect to kubelet renewed</span><br><span class="line">certificate embedded <span class="keyword">in</span> the kubeconfig file <span class="keyword">for</span> the controller manager to use renewed</span><br><span class="line">certificate <span class="keyword">for</span> liveness probes to healthcheck etcd renewed</span><br><span class="line">certificate <span class="keyword">for</span> etcd nodes to communicate with each other renewed</span><br><span class="line">certificate <span class="keyword">for</span> serving etcd renewed</span><br><span class="line">certificate <span class="keyword">for</span> the front proxy client renewed</span><br><span class="line">certificate embedded <span class="keyword">in</span> the kubeconfig file <span class="keyword">for</span> the scheduler manager to use renewed</span><br><span class="line">certificate embedded <span class="keyword">in</span> the kubeconfig file <span class="keyword">for</span> the super-admin renewed</span><br><span class="line"></span><br><span class="line">Done renewing certificates. You must restart the kube-apiserver, kube-controller-manager, kube-scheduler and etcd, so that they can use the new certificates.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要根据输出提示重启 kube-apiserver, kube-controller-manager, kube-scheduler 和 etcd</span></span><br><span class="line"><span class="comment"># 这几个组件是通过pod 启动的，可以通过 kubectl get pod -n kube-system 查看</span></span><br><span class="line">$ kubectl get pods -n kube-system</span><br><span class="line">NAME                                       READY   STATUS    RESTARTS        AGE</span><br><span class="line">calico-kube-controllers-7bfdc5b57c-q5xwp   1/1     Running   3 (5h37m ago)   41h</span><br><span class="line">calico-node-7pbbq                          1/1     Running   3 (5h36m ago)   41h</span><br><span class="line">calico-node-v4hzr                          1/1     Running   2 (5h37m ago)   19h</span><br><span class="line">calico-node-w47qq                          1/1     Running   3 (5h37m ago)   41h</span><br><span class="line">coredns-674b8bbfcf-2tvld                   1/1     Running   3 (5h37m ago)   41h</span><br><span class="line">coredns-674b8bbfcf-h6kx7                   1/1     Running   3 (5h37m ago)   41h</span><br><span class="line">etcd-k8s-master                            1/1     Running   5 (5h37m ago)   41h</span><br><span class="line">kube-apiserver-k8s-master                  1/1     Running   7 (5h37m ago)   41h</span><br><span class="line">kube-controller-manager-k8s-master         1/1     Running   7 (5h37m ago)   41h</span><br><span class="line">kube-proxy-nkbns                           1/1     Running   3 (5h36m ago)   41h</span><br><span class="line">kube-proxy-plqw8                           1/1     Running   3 (5h37m ago)   41h</span><br><span class="line">kube-proxy-sbgh6                           1/1     Running   2 (5h37m ago)   19h</span><br><span class="line">kube-scheduler-k8s-master                  1/1     Running   7 (5h37m ago)   41h</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除指定的pod就会自动重启</span></span><br><span class="line">kubectl delete pod -n kube-system kube-apiserver-k8s-master kube-controller-manager-k8s-master  kube-scheduler-k8s-master etcd-k8s-master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启成功后再次查看证书信息，就会看到更新后的到期时间为1年</span></span><br><span class="line"><span class="built_in">sudo</span> kubeadm certs check-expiration</span><br></pre></td></tr></table></figure><h2 id="Kubernetes-节点组件">Kubernetes 节点组件</h2><table><thead><tr><th>角色</th><th>组件名</th><th>说明</th></tr></thead><tbody><tr><td><strong>Master Node</strong></td><td><code>kube-apiserver</code></td><td>Kubernetes 的 API 请求入口，处理所有 REST 请求，协调各组件。</td></tr><tr><td></td><td><code>kube-scheduler</code></td><td>调度器，决定将 Pod 调度到哪个合适的 Node。</td></tr><tr><td></td><td><code>kube-controller-manager</code></td><td>包含多个控制器（如 NodeController、ReplicationController、DeploymentController 等），用于控制和调整集群状态。</td></tr><tr><td></td><td><code>etcd</code></td><td>分布式 KV 存储系统，存储 Kubernetes 所有状态数据。只有 API Server 能直接访问。</td></tr><tr><td><strong>Worker Node</strong></td><td><code>kubelet</code></td><td>负责与 Master 通信，执行其下发的 Pod 管理任务，控制容器生命周期。</td></tr><tr><td></td><td><code>kube-proxy</code></td><td>负责维护 Node 上的网络规则，支持服务负载均衡和网络通信。</td></tr><tr><td></td><td><code>container runtime</code></td><td>容器运行时，比如 Docker、containerd、CRI-O，负责实际运行容器。</td></tr></tbody></table><h2 id="crictl-命令">crictl 命令</h2><ul class="lvl-0"><li class="lvl-2"><p><code>crictl</code> 是k8s官方出品的一个命令行工具，用于与 containerd 进行通信。</p></li><li class="lvl-2"><p><code>crictl</code> 命令默认需要 sudo 权限，如果不想每次都加 sudo，可以将用户加入 containerd 的 socket 权限组</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># containerd 的默认 socket 是 /var/run/containerd/containerd.sock</span></span><br><span class="line">$ <span class="built_in">ls</span> -l /var/run/containerd/containerd.sock</span><br><span class="line">srw-rw---- 1 root root 0 7月   1 10:57 /var/run/containerd/containerd.sock</span><br><span class="line"><span class="comment"># 如果 group 是 root：你可以改为其它组，比如 docker</span></span><br><span class="line"><span class="comment"># 如果 docker 组不存在则创建</span></span><br><span class="line"><span class="built_in">sudo</span> groupadd docker</span><br><span class="line"><span class="comment"># 修改文件所属组为 docker</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chgrp</span> docker /var/run/containerd/containerd.sock</span><br><span class="line"><span class="comment"># 为组添加读写权限</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> g+rw /var/run/containerd/containerd.sock</span><br><span class="line"><span class="comment"># 添加用户到 docker 组</span></span><br><span class="line"><span class="built_in">sudo</span> usermod -aG docker <span class="variable">$USER</span></span><br><span class="line"><span class="comment"># 刷新权限</span></span><br><span class="line">newgrp docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此时虽然已经可以不用 sudo 了，但是一旦重启 containerd 就会重新回到 root 权限，因此需要添加如下配置</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /etc/systemd/system/containerd.service.d/</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/systemd/system/containerd.service.d/override.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">ExecStartPost=/bin/bash -c &#x27;chmod 660 /run/containerd/containerd.sock &amp;&amp; chgrp docker /run/containerd/containerd.sock&#x27;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line"><span class="built_in">sudo</span> systemctl restart containerd</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>crictl</code> 命令的使用方式比较类似<code>docker</code>命令</p></li></ul><table><thead><tr><th>操作</th><th><code>docker</code> 命令</th><th><code>crictl</code> 命令</th><th>说明</th></tr></thead><tbody><tr><td>查看正在运行的容器</td><td><code>docker ps</code></td><td><code>crictl ps</code></td><td></td></tr><tr><td>查看所有容器（包括已停止）</td><td><code>docker ps -a</code></td><td><code>crictl ps -a</code></td><td></td></tr><tr><td>查看镜像</td><td><code>docker images</code></td><td><code>crictl images</code></td><td></td></tr><tr><td>查看容器日志</td><td><code>docker logs &lt;container_id&gt;</code></td><td><code>crictl logs &lt;container_id&gt;</code></td><td></td></tr><tr><td>进入容器交互</td><td><code>docker exec -it &lt;id&gt; sh</code></td><td><code>crictl exec -it &lt;id&gt; sh</code></td><td></td></tr><tr><td>查看容器详细信息</td><td><code>docker inspect &lt;container_id&gt;</code></td><td><code>crictl inspect &lt;container_id&gt;</code></td><td></td></tr><tr><td>查看 Pod 详细信息</td><td>❌（不支持）</td><td><code>crictl inspectp &lt;pod_id&gt;</code></td><td>K8s 专属</td></tr><tr><td>删除容器</td><td><code>docker rm &lt;container_id&gt;</code></td><td><code>crictl rm &lt;container_id&gt;</code></td><td></td></tr><tr><td>删除镜像</td><td><code>docker rmi &lt;image_id&gt;</code></td><td><code>crictl rmi &lt;image_id&gt;</code></td><td></td></tr><tr><td>拉取镜像</td><td><code>docker pull nginx</code></td><td><code>crictl pull nginx</code></td><td></td></tr><tr><td>运行容器（非 K8s 场景）</td><td><code>docker run -it nginx</code></td><td>❌（不支持）</td><td><code>crictl</code> 不运行容器，仅调试现有容器</td></tr><tr><td>列出容器运行时信息</td><td><code>docker info</code></td><td><code>crictl info</code></td><td></td></tr><tr><td>查看容器运行状态</td><td><code>docker stats</code></td><td><code>crictl stats</code></td><td>简要版</td></tr><tr><td>设置配置文件</td><td><code>~/.docker/config.json</code></td><td><code>/etc/crictl.yaml</code></td><td>如设置 endpoint</td></tr></tbody></table><h2 id="nerdctl">nerdctl</h2><ul class="lvl-0"><li class="lvl-2"><p><a href="https://github.com/containerd/nerdctl">nerdctl</a> 是一个 兼容 Docker CLI 的容器命令行工具，用于管理 containerd 容器运行时。</p></li><li class="lvl-2"><p>它是 containerd 官方子项目，由 CNCF 维护，其命令语法与 Docker CLI 兼容，目标是让习惯 Docker 的用户也能轻松使用 containerd。</p></li><li class="lvl-2"><p>安装 nerdctl</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 下载最新版本</span></span><br><span class="line">VERSION=2.1.3</span><br><span class="line">wget https://github.com/containerd/nerdctl/releases/download/v<span class="variable">$&#123;VERSION&#125;</span>/nerdctl-<span class="variable">$&#123;VERSION&#125;</span>-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 解压</span></span><br><span class="line">tar -xvf nerdctl-<span class="variable">$&#123;VERSION&#125;</span>-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 移动到系统 PATH</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mv</span> nerdctl /usr/local/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># nerdctl 需要 sudo 权限</span></span><br><span class="line"><span class="comment">## 为 sudo 添加 PATH</span></span><br><span class="line"><span class="built_in">sudo</span> visudo</span><br><span class="line"><span class="comment">## 找到这一行</span></span><br><span class="line">Defaults    secure_path = /sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line"><span class="comment">## 修改为，即将 nerdctl 所在的目录加入 PATH</span></span><br><span class="line">Defaults    secure_path = /sbin:/bin:/usr/sbin:/usr/bin:/usr/local/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.测试</span></span><br><span class="line"><span class="comment">## 查看版本</span></span><br><span class="line"><span class="built_in">sudo</span> nerdctl version</span><br><span class="line"><span class="comment">## 列出容器，--namespace k8s.io 表示查看 k8s 中的容器</span></span><br><span class="line"><span class="built_in">sudo</span> nerdctl ps --namespace k8s.io</span><br><span class="line"></span><br><span class="line"><span class="comment">## 如果不想每次都加上 --namespace k8s.io，可以设置别名</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;alias kps=&#x27;sudo nerdctl --namespace=k8s.io ps&#x27;&quot;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br><span class="line"><span class="comment">## 测试</span></span><br><span class="line">kps</span><br></pre></td></tr></table></figure><h2 id="远程连接-k8s-集群">远程连接 k8s 集群</h2><h3 id="本地不存在-kubeconfig-文件">本地不存在 kubeconfig 文件</h3><ul class="lvl-0"><li class="lvl-2"><p>获取 kubeconfig 文件，位于 Master 节点：/etc/kubernetes/admin.conf，将其拷贝到本地</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp k8s-master:/etc/kubernetes/admin.conf ~/.kube/config</span><br></pre></td></tr></table></figure><h3 id="本地已存在-kubeconfig-文件">本地已存在 kubeconfig 文件</h3><ul class="lvl-0"><li class="lvl-2"><p>已经配置了一个集群的连接，还想再添加一个集群，可以通过通过合并的方式添加</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将新集群的 kubeconfig 文件拷贝到本地</span></span><br><span class="line">scp k8s-master:/etc/kubernetes/admin.conf ~/.kube/new-cluster.conf</span><br><span class="line"><span class="comment"># 合并</span></span><br><span class="line">KUBECONFIG=~/.kube/config:new-cluster.conf kubectl config view --flatten &gt; merged-config.yaml</span><br><span class="line"><span class="comment"># 替换</span></span><br><span class="line"><span class="built_in">mv</span> merged-config.yaml ~/.kube/config</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>获取集群配置相关命令</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取所有集群配置</span></span><br><span class="line">kubectl config get-contexts</span><br><span class="line"><span class="comment"># 查看当前默认的 context</span></span><br><span class="line">kubectl config current-context</span><br><span class="line"><span class="comment"># 切换 context</span></span><br><span class="line">kubectl config use-context &lt;context_name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取集群名称</span></span><br><span class="line">kubectl config get-clusters</span><br><span class="line"><span class="comment"># 获取用户名称</span></span><br><span class="line">kubectl config get-users</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>测试</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>删除集群配置</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除 context</span></span><br><span class="line">kubectl config delete-context &lt;context_name&gt;</span><br><span class="line"><span class="comment"># 删除 cluster</span></span><br><span class="line">kubectl config delete-cluster &lt;cluster_name&gt;</span><br><span class="line"><span class="comment"># 删除 user</span></span><br><span class="line">kubectl config delete-user &lt;user_name&gt;</span><br></pre></td></tr></table></figure><blockquote><p>也可以直接编辑 kubeconfig（~/.kube/config） 文件，添加或删除不需要的集群、用户、上下文等信息</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

引用本地其它文章连接{}
 大括号开始% post_link 文件名称(不包含.md) %大括号结束
 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍 Linux 下 使用 kubeadm 安装 K8S 的方法，本文以 CentOS 8 为例。&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/&quot;&gt;K8S官网&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/kubernetes/kubernetes&quot;&gt;k8s Github&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/&quot;&gt;使用 kubeadm 引导集群&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/reference/setup-tools/kubeadm/&quot;&gt;kubeadm 命令指南&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/&quot;&gt;用 kubeadm 进行管理&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="k8s" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/k8s/"/>
    
    
    <category term="K8S" scheme="https://blog.hanqunfeng.com/tags/K8S/"/>
    
  </entry>
  
  <entry>
    <title>Linux 安装 K8S 之 minikube</title>
    <link href="https://blog.hanqunfeng.com/2025/06/28/k8s-install-minikube/"/>
    <id>https://blog.hanqunfeng.com/2025/06/28/k8s-install-minikube/</id>
    <published>2025-06-28T13:30:05.000Z</published>
    <updated>2025-06-30T05:56:30.873Z</updated>
    
    <content type="html"><![CDATA[<!-- **加粗** *斜体* ***加粗并斜体*** ~~删除线~~ ==突出显示== `突出显示(推荐)` ++下划线++ ~下标~ ^上标^ 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference. 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600) +++ **点击折叠** 这是被隐藏的内容 +++::: tips success warning danger这里是容器内的内容:::% note info % success warning danger这里是容器内的内容% endnote %引用本地其它文章连接{} 大括号开始% post_link 文件名称(不包含.md) %大括号结束 --><h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2"><p>本文介绍 Linux 下 使用 minikube 安装 K8S 的方法，本文以 CentOS 8 为例。</p></li><li class="lvl-2"><p><a href="https://kubernetes.io/zh-cn/">K8S官网</a></p></li><li class="lvl-2"><p><a href="https://github.com/kubernetes/kubernetes">k8s Github</a></p></li><li class="lvl-2"><p><a href="https://minikube.sigs.k8s.io/docs/">minikube官网</a></p></li></ul><span id="more"></span><h2 id="安装前设置">安装前设置</h2><h3 id="修正系统的时间">修正系统的时间</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装chrony</span></span><br><span class="line"><span class="built_in">sudo</span> dnf install chrony -y</span><br><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> --now chronyd</span><br><span class="line"><span class="comment"># 修正时间</span></span><br><span class="line"><span class="built_in">sudo</span> chronyc makestep</span><br><span class="line"><span class="comment"># 查看时间</span></span><br><span class="line"><span class="built_in">date</span></span><br></pre></td></tr></table></figure><h3 id="安装-docker">安装 <code>docker</code></h3><ul class="lvl-0"><li class="lvl-2"><p>安装方法参见 <a href="/2025/05/20/docker-install/" title="Linux 安装 Docker">Linux 安装 Docker</a></p></li></ul><h3 id="创建用户">创建用户</h3><ul class="lvl-0"><li class="lvl-2"><p>避免使用root用户，这里创建一个 <code>centos</code> 用户，要求该用户具有<code>sudo</code>权限，如果使用<code>docker</code>运行时，则需要将该用户添加到<code>docker</code>用户组</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.创建用户</span></span><br><span class="line">$ <span class="built_in">sudo</span> useradd -m -s /bin/bash centos</span><br><span class="line"><span class="comment"># 2.添加到docker用户组</span></span><br><span class="line">$ <span class="built_in">sudo</span> usermod -aG docker centos</span><br><span class="line"><span class="comment"># 3.将用户添加到 sudo（管理员）组，说明：wheel 是 CentOS 中允许使用 sudo 权限的用户组。具体可以通过 visudo 命令查看</span></span><br><span class="line">$ <span class="built_in">sudo</span> usermod -aG wheel centos</span><br><span class="line"><span class="comment">## 这种添加方式使用sudo时需要输入密码，如果不希望输入密码，可以通过 visudo 命令修改，将 wheel 组改为 %wheel ALL=(ALL) NOPASSWD: ALL 的形式</span></span><br><span class="line"><span class="comment"># 4.切换用户，以下操作均在该用户下进行</span></span><br><span class="line">$ su - centos</span><br></pre></td></tr></table></figure><h3 id="安装-kubectl">安装 <code>kubectl</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.下载 kubectl</span></span><br><span class="line">$ curl -LO <span class="string">&quot;https://dl.k8s.io/release/<span class="subst">$(curl -L -s https://dl.k8s.io/release/stable.txt)</span>/bin/linux/amd64/kubectl&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.验证下载(可选)</span></span><br><span class="line">$ curl -LO <span class="string">&quot;https://dl.k8s.io/release/<span class="subst">$(curl -L -s https://dl.k8s.io/release/stable.txt)</span>/bin/linux/amd64/kubectl.sha256&quot;</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(cat kubectl.sha256)</span>  kubectl&quot;</span> | <span class="built_in">sha256sum</span> --check</span><br><span class="line"><span class="comment">## 验证通过输出</span></span><br><span class="line">kubectl: 成功</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.安装 kubectl</span></span><br><span class="line">$ <span class="built_in">sudo</span> install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.查看安装的版本</span></span><br><span class="line">$ kubectl version --client</span><br><span class="line">Client Version: v1.33.2</span><br><span class="line">Kustomize Version: v5.6.0</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>启用 shell 自动补全功能</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.安装 bash-completion</span></span><br><span class="line"><span class="comment"># 1.1 检查bash-completion是否已安装，有输出说明已经安装</span></span><br><span class="line">$ <span class="built_in">type</span> _init_completion</span><br><span class="line"><span class="comment"># 1.2 安装bash-completion，安装后会创建文件 /usr/share/bash-completion/bash_completion</span></span><br><span class="line">$ dnf install bash-completion</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.安装 kubectl 的自动补全功能</span></span><br><span class="line"><span class="comment"># 2.1 当前用户</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;source &lt;(kubectl completion bash)&#x27;</span> &gt;&gt;~/.bashrc</span><br><span class="line"><span class="comment"># 2.2 所有用户</span></span><br><span class="line">$ kubectl completion bash | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/bash_completion.d/kubectl &gt; /dev/null</span><br><span class="line">$ <span class="built_in">sudo</span> <span class="built_in">chmod</span> a+r /etc/bash_completion.d/kubectl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3 如果 kubectl 有关联的别名，你可以扩展 Shell 补全来适配此别名</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;alias k=kubectl&#x27;</span> &gt;&gt;~/.bashrc</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;complete -o default -F __start_kubectl k&#x27;</span> &gt;&gt;~/.bashrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.刷新配置文件</span></span><br><span class="line">$ <span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure><h2 id="使用-minikube-创建-K8S-集群">使用 minikube 创建 K8S 集群</h2><ul class="lvl-0"><li class="lvl-2"><p>该工具只适合在本机进行开发和测试时使用，其原理是在本机的docker环境中创建一个<code>minikube</code>容器作为<code>k8s</code>的节点机。</p></li></ul><h3 id="安装-minikube">安装 minikube</h3><ul class="lvl-0"><li class="lvl-2"><p><a href="https://minikube.sigs.k8s.io/docs/start/?arch=%2Flinux%2Fx86-64%2Fstable%2Fbinary+download">minikube安装说明</a></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.下载</span></span><br><span class="line">$ curl -LO https://github.com/kubernetes/minikube/releases/latest/download/minikube-linux-amd64</span><br><span class="line"><span class="comment"># 2.安装</span></span><br><span class="line">$ <span class="built_in">sudo</span> install minikube-linux-amd64 /usr/local/bin/minikube &amp;&amp; <span class="built_in">rm</span> minikube-linux-amd64</span><br><span class="line"><span class="comment"># 3.验证</span></span><br><span class="line">$ minikube version</span><br><span class="line"><span class="comment"># 4.查看帮助</span></span><br><span class="line">$ minikube --<span class="built_in">help</span></span><br></pre></td></tr></table></figure><h3 id="创建集群">创建集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建集群，注意不能使用 root 用户，要求该用户具有 docker 权限，并且具有sudo权限，否则会报错</span></span><br><span class="line"><span class="comment"># 系统内存至少 4G，以保证稳定性</span></span><br><span class="line"><span class="comment"># 默认使用docker驱动 --driver=docker，minikube 支持的驱动：https://minikube.sigs.k8s.io/docs/drivers/</span></span><br><span class="line">$ minikube start</span><br><span class="line">😄  Rocky 8.10 (amd64) 上的 minikube v1.36.0</span><br><span class="line">✨  根据现有的配置文件使用 docker 驱动程序</span><br><span class="line">👍  在集群中 <span class="string">&quot;minikube&quot;</span> 启动节点 <span class="string">&quot;minikube&quot;</span> primary control-plane</span><br><span class="line">🚜  正在拉取基础镜像 v0.0.47 ...</span><br><span class="line">    &gt; index.docker.io/kicbase/sta...:  502.26 MiB / 502.26 MiB  100.00% 27.50 M</span><br><span class="line">❗  minikube was unable to download gcr.io/k8s-minikube/kicbase:v0.0.47, but successfully downloaded docker.io/kicbase/stable:v0.0.47@sha256:6ed579c9292b4370177b7ef3c42cc4b4a6dcd0735a1814916cbc22c8bf38412b as a fallback image</span><br><span class="line">🔥  创建 docker container（CPU=2，内存=2200MB）...</span><br><span class="line">🐳  正在 Docker 28.1.1 中准备 Kubernetes v1.33.1…</span><br><span class="line">    ▪ 正在生成证书和密钥...</span><br><span class="line">    ▪ 正在启动控制平面...</span><br><span class="line">    ▪ 配置 RBAC 规则 ...</span><br><span class="line">🔗  配置 bridge CNI (Container Networking Interface) ...</span><br><span class="line">🔎  正在验证 Kubernetes 组件...</span><br><span class="line">    ▪ 正在使用镜像 gcr.io/k8s-minikube/storage-provisioner:v5</span><br><span class="line">🌟  启用插件： default-storageclass, storage-provisioner</span><br><span class="line">🏄  完成！kubectl 现在已配置，默认使用<span class="string">&quot;minikube&quot;</span>集群和<span class="string">&quot;default&quot;</span>命名空间</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>Minikube 允许你创建多个独立的 Kubernetes 集群，每个 profile 是一个单独的 minikube 实例，互不干扰。</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -p 是 --profile 的缩写，表示 指定使用哪个 Minikube 集群（Profile）,默认 profile 名是 minikube</span></span><br><span class="line">minikube start -p dev</span><br><span class="line">minikube start -p <span class="built_in">test</span></span><br><span class="line">minikube start -p prod</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>获取集群状态</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes</span><br><span class="line">NAME       STATUS   ROLES           AGE   VERSION</span><br><span class="line">minikube   Ready    control-plane   27s   v1.33.1</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>查看本机容器，k8s 集群就在这个容器中</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps</span><br><span class="line">CONTAINER ID   IMAGE                    COMMAND                   CREATED          STATUS          PORTS                                                                                                                                  NAMES</span><br><span class="line">4e7eaad73934   kicbase/stable:v0.0.47   <span class="string">&quot;/usr/local/bin/entr…&quot;</span>   47 minutes ago   Up 47 minutes   127.0.0.1:32772-&gt;22/tcp, 127.0.0.1:32771-&gt;2376/tcp, 127.0.0.1:32770-&gt;5000/tcp, 127.0.0.1:32769-&gt;8443/tcp, 127.0.0.1:32768-&gt;32443/tcp   minikube</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看该容器中的docker容器</span></span><br><span class="line">$ docker <span class="built_in">exec</span> -it minikube docker ps</span><br><span class="line">CONTAINER ID   IMAGE                        COMMAND                  CREATED         STATUS         PORTS     NAMES</span><br><span class="line">c25bcc3cb76c   1cf5f116067c                 <span class="string">&quot;/coredns -conf /etc…&quot;</span>   2 minutes ago   Up 2 minutes             k8s_coredns_coredns-674b8bbfcf-8jrx4_kube-system_bc7a83c7-31e7-495c-820a-a29414099387_0</span><br><span class="line">a22714ccfce2   b79c189b052c                 <span class="string">&quot;/usr/local/bin/kube…&quot;</span>   2 minutes ago   Up 2 minutes             k8s_kube-proxy_kube-proxy-5dkt4_kube-system_8ad25d8e-b023-4383-9441-0ddbb5159c9b_0</span><br><span class="line">a368d902aef9   registry.k8s.io/pause:3.10   <span class="string">&quot;/pause&quot;</span>                 2 minutes ago   Up 2 minutes             k8s_POD_kube-proxy-5dkt4_kube-system_8ad25d8e-b023-4383-9441-0ddbb5159c9b_0</span><br><span class="line">973caed86b2c   registry.k8s.io/pause:3.10   <span class="string">&quot;/pause&quot;</span>                 2 minutes ago   Up 2 minutes             k8s_POD_coredns-674b8bbfcf-8jrx4_kube-system_bc7a83c7-31e7-495c-820a-a29414099387_0</span><br><span class="line">9db7567143a2   6e38f40d628d                 <span class="string">&quot;/storage-provisioner&quot;</span>   2 minutes ago   Up 2 minutes             k8s_storage-provisioner_storage-provisioner_kube-system_4e82402e-ba65-4061-920e-988a71cb529b_0</span><br><span class="line">ba39fe88ad59   registry.k8s.io/pause:3.10   <span class="string">&quot;/pause&quot;</span>                 2 minutes ago   Up 2 minutes             k8s_POD_storage-provisioner_kube-system_4e82402e-ba65-4061-920e-988a71cb529b_0</span><br><span class="line">ef0733df95b4   ef43894fa110                 <span class="string">&quot;kube-controller-man…&quot;</span>   2 minutes ago   Up 2 minutes             k8s_kube-controller-manager_kube-controller-manager-minikube_kube-system_0378f173c980f85a71d36305bacb0ad1_0</span><br><span class="line">852828a600d5   c6ab243b29f8                 <span class="string">&quot;kube-apiserver --ad…&quot;</span>   2 minutes ago   Up 2 minutes             k8s_kube-apiserver_kube-apiserver-minikube_kube-system_78e1292e1d47cc7d09b2c6f5826fa624_0</span><br><span class="line">97efb54702cd   499038711c08                 <span class="string">&quot;etcd --advertise-cl…&quot;</span>   2 minutes ago   Up 2 minutes             k8s_etcd_etcd-minikube_kube-system_3924ef3609584191d8d09190210d2d78_0</span><br><span class="line">a3dd2c2817f1   398c985c0d95                 <span class="string">&quot;kube-scheduler --au…&quot;</span>   2 minutes ago   Up 2 minutes             k8s_kube-scheduler_kube-scheduler-minikube_kube-system_feee622ba49882ef945e2406d3ba86df_0</span><br><span class="line">927ebc63cf80   registry.k8s.io/pause:3.10   <span class="string">&quot;/pause&quot;</span>                 2 minutes ago   Up 2 minutes             k8s_POD_kube-scheduler-minikube_kube-system_feee622ba49882ef945e2406d3ba86df_0</span><br><span class="line">744d4c6e3571   registry.k8s.io/pause:3.10   <span class="string">&quot;/pause&quot;</span>                 2 minutes ago   Up 2 minutes             k8s_POD_kube-controller-manager-minikube_kube-system_0378f173c980f85a71d36305bacb0ad1_0</span><br><span class="line">4ae6bdc25908   registry.k8s.io/pause:3.10   <span class="string">&quot;/pause&quot;</span>                 2 minutes ago   Up 2 minutes             k8s_POD_kube-apiserver-minikube_kube-system_78e1292e1d47cc7d09b2c6f5826fa624_0</span><br><span class="line">dff641d8672a   registry.k8s.io/pause:3.10   <span class="string">&quot;/pause&quot;</span>                 2 minutes ago   Up 2 minutes             k8s_POD_etcd-minikube_kube-system_3924ef3609584191d8d09190210d2d78_0</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-3"><p>配置你的终端，让 Docker CLI 指向 minikube 内部的 Docker 守护进程（就是通过 docker 远程连接的方式）</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看docker远程的环境变量，我们可以将其配置到宿主机的环境变量中</span></span><br><span class="line">$ minikube docker-env</span><br><span class="line"><span class="built_in">export</span> DOCKER_TLS_VERIFY=<span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="built_in">export</span> DOCKER_HOST=<span class="string">&quot;tcp://192.168.49.2:2376&quot;</span></span><br><span class="line"><span class="built_in">export</span> DOCKER_CERT_PATH=<span class="string">&quot;/home/centos/.minikube/certs&quot;</span></span><br><span class="line"><span class="built_in">export</span> MINIKUBE_ACTIVE_DOCKERD=<span class="string">&quot;minikube&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># To point your shell to minikube&#x27;s docker-daemon, run:</span></span><br><span class="line"><span class="comment"># eval $(minikube -p minikube docker-env)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 临时配置宿主机环境变量，此时我们再执行docker命令，就会使用minikube的docker-daemon</span></span><br><span class="line">$ <span class="built_in">eval</span> $(minikube -p minikube docker-env)</span><br><span class="line"><span class="comment"># 取消临时配置,-u 是 --unset 的缩写</span></span><br><span class="line">$ <span class="built_in">eval</span> $(minikube -p minikube docker-env -u)</span><br></pre></td></tr></table></figure><h3 id="minikube-命令">minikube 命令</h3><ul class="lvl-0"><li class="lvl-2"><p>登录到 minikube 环境（用于调试）</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 实际上就是进入minikube容器的shell</span></span><br><span class="line">$ minikube ssh</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>运行 kubectl 命令</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看支持的命令</span></span><br><span class="line">$ minikube kubectl -- --<span class="built_in">help</span></span><br><span class="line"><span class="comment"># 运行 kubectl 命令，这里注意 minikube kubectl -- 前面有空格</span></span><br><span class="line">$ minikube kubectl -- get pods --namespace kube-system</span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-674b8bbfcf-8jrx4           1/1     Running   0          45m</span><br><span class="line">etcd-minikube                      1/1     Running   0          45m</span><br><span class="line">kube-apiserver-minikube            1/1     Running   0          45m</span><br><span class="line">kube-controller-manager-minikube   1/1     Running   0          45m</span><br><span class="line">kube-proxy-5dkt4                   1/1     Running   0          45m</span><br><span class="line">kube-scheduler-minikube            1/1     Running   0          45m</span><br><span class="line">storage-provisioner                1/1     Running   0          45m</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>node节点管理</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加一个worker节点，此时就是又启动了一个minikube容器</span></span><br><span class="line">$ minikube node add</span><br><span class="line">😄  将节点 m02 作为 [worker] 添加到集群 minikube</span><br><span class="line">❗  在没有任何 CNI 的情况下创建集群，向其中添加节点可能会导致网络中断。</span><br><span class="line">👍  在集群中 <span class="string">&quot;minikube&quot;</span> 启动节点 <span class="string">&quot;minikube-m02&quot;</span> worker</span><br><span class="line">🚜  正在拉取基础镜像 v0.0.47 ...</span><br><span class="line">🔥  创建 docker container（CPU=2，内存=2200MB）...</span><br><span class="line">🐳  正在 Docker 28.1.1 中准备 Kubernetes v1.33.1…</span><br><span class="line">🔎  正在验证 Kubernetes 组件...</span><br><span class="line">🏄  已成功将 m02 添加到 minikube！</span><br><span class="line"></span><br><span class="line">$ docker ps</span><br><span class="line">CONTAINER ID   IMAGE                    COMMAND                   CREATED             STATUS             PORTS                                                                                                                                  NAMES</span><br><span class="line">ce5431e994c3   kicbase/stable:v0.0.47   <span class="string">&quot;/usr/local/bin/entr…&quot;</span>   24 minutes ago      Up 24 minutes      127.0.0.1:32792-&gt;22/tcp, 127.0.0.1:32791-&gt;2376/tcp, 127.0.0.1:32790-&gt;5000/tcp, 127.0.0.1:32789-&gt;8443/tcp, 127.0.0.1:32788-&gt;32443/tcp   minikube-m02</span><br><span class="line">2739aa21a085   kicbase/stable:v0.0.47   <span class="string">&quot;/usr/local/bin/entr…&quot;</span>   About an hour ago   Up About an hour   127.0.0.1:32777-&gt;22/tcp, 127.0.0.1:32776-&gt;2376/tcp, 127.0.0.1:32775-&gt;5000/tcp, 127.0.0.1:32774-&gt;8443/tcp, 127.0.0.1:32773-&gt;32443/tcp   minikube</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看节点</span></span><br><span class="line">$ kubectl get nodes</span><br><span class="line">NAME           STATUS   ROLES           AGE   VERSION</span><br><span class="line">minikube       Ready    control-plane   55m   v1.33.1</span><br><span class="line">minikube-m02   Ready    &lt;none&gt;          70s   v1.33.1</span><br><span class="line"></span><br><span class="line">$ minikube node list</span><br><span class="line">minikube        192.168.49.2</span><br><span class="line">minikube-m02    192.168.49.3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止节点</span></span><br><span class="line">$ minikube node stop minikube-m02</span><br><span class="line">✋  正在停止节点 <span class="string">&quot;minikube-m02&quot;</span> ...</span><br><span class="line">🛑  正在通过 SSH 关闭“minikube-m02”…</span><br><span class="line">🛑  成功停止节点 minikube-m02</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动节点</span></span><br><span class="line">$ minikube node start minikube-m02</span><br><span class="line">👍  在集群中 <span class="string">&quot;minikube&quot;</span> 启动节点 <span class="string">&quot;minikube-m02&quot;</span> worker</span><br><span class="line">🚜  正在拉取基础镜像 v0.0.47 ...</span><br><span class="line">🔄  正在为<span class="string">&quot;minikube-m02&quot;</span>重启现有的 docker container ...</span><br><span class="line">🐳  正在 Docker 28.1.1 中准备 Kubernetes v1.33.1…</span><br><span class="line">🔎  正在验证 Kubernetes 组件...</span><br><span class="line">🌟  启用插件：</span><br><span class="line">😄  成功启动节点 minikube-m02！</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除节点</span></span><br><span class="line">$ minikube node delete minikube-m02</span><br><span class="line">🔥  正在从集群 minikube 中删除节点 minikube-m02</span><br><span class="line">✋  正在停止节点 <span class="string">&quot;minikube-m02&quot;</span> ...</span><br><span class="line">🛑  正在通过 SSH 关闭“minikube-m02”…</span><br><span class="line">🔥  正在删除 docker 中的“minikube-m02”…</span><br><span class="line">💀  节点 minikube-m02 已成功删除。</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>停止集群: 此时只是停止容器</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ minikube stop</span><br><span class="line">✋  正在停止节点 <span class="string">&quot;minikube&quot;</span> ...</span><br><span class="line">🛑  正在通过 SSH 关闭“minikube”…</span><br><span class="line">🛑  1 个节点已停止</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>删除集群: 删除容器及其配置</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ minikube delete</span><br><span class="line">🔥  正在删除 docker 中的“minikube”…</span><br><span class="line">🔥  正在删除容器 <span class="string">&quot;minikube&quot;</span> ...</span><br><span class="line">🔥  正在移除 /home/centos/.minikube/machines/minikube…</span><br><span class="line">💀  已删除所有关于 <span class="string">&quot;minikube&quot;</span> 集群的痕迹。</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>具体的使用方法参考<a href="https://kubernetes.io/zh-cn/docs/tutorials/hello-minikube/">https://kubernetes.io/zh-cn/docs/tutorials/hello-minikube/</a></p></li></ul>]]></content>
    
    
    <summary type="html">&lt;!--
 **加粗**
 *斜体*
 ***加粗并斜体***
 ~~删除线~~
 ==突出显示==
 `突出显示(推荐)`
 ++下划线++
 ~下标~
 ^上标^
 脚注，参考文献[^1]，然后在文档最下方要添加这个1对应的内容，如：[^1]: My reference.
 图片设置宽度和高度(通过uPic上传后，需要将upic修改过为blog，用于添加水印) ![](https://upic-oss.oss-cn-beijing.aliyuncs.com/blog/innodb_buffer_pool.png =900x600)

 +++ **点击折叠**
 这是被隐藏的内容
 +++

::: tips success warning danger
这里是容器内的内容
:::

% note info % success warning danger
这里是容器内的内容
% endnote %

引用本地其它文章连接{}
 大括号开始% post_link 文件名称(不包含.md) %大括号结束
 --&gt;
&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;本文介绍 Linux 下 使用 minikube 安装 K8S 的方法，本文以 CentOS 8 为例。&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/&quot;&gt;K8S官网&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/kubernetes/kubernetes&quot;&gt;k8s Github&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://minikube.sigs.k8s.io/docs/&quot;&gt;minikube官网&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="k8s" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/k8s/"/>
    
    
    <category term="K8S" scheme="https://blog.hanqunfeng.com/tags/K8S/"/>
    
  </entry>
  
</feed>
