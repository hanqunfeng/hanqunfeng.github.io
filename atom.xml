<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>飘逸峰的博客</title>
  
  <subtitle>Spring--Java程序员的春天</subtitle>
  <link href="https://blog.hanqunfeng.com/atom.xml" rel="self"/>
  
  <link href="https://blog.hanqunfeng.com/"/>
  <updated>2026-01-08T09:36:30.364Z</updated>
  <id>https://blog.hanqunfeng.com/</id>
  
  <author>
    <name>飘逸峰</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Redis 命令及数据类型 -- RoaringBitmap</title>
    <link href="https://blog.hanqunfeng.com/2026/01/08/redis7-datatype-19-RoaringBitmap/"/>
    <id>https://blog.hanqunfeng.com/2026/01/08/redis7-datatype-19-RoaringBitmap/</id>
    <published>2026-01-08T14:30:05.000Z</published>
    <updated>2026-01-08T09:36:30.364Z</updated>
    
    <content type="html"><![CDATA[<h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2">本文介绍 Redis 扩展模块 – RedisRoaring 中 RoaringBitmap 数据类型</li><li class="lvl-2">本文基于<code>redis-7.4.7</code>，<code>springboot-3.5.8</code></li><li class="lvl-2">操作系统：<code>Amazon Linux 2023(内核 6.1)</code></li><li class="lvl-2">Redis官网：<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis 命令文档：<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li><li class="lvl-2">RedisRoaring 的安装参见 <a href="/2026/01/08/redis7-module-RedisRoaring/" title="Redis 扩展模块 -- RedisRoaring 的安装方法">Redis 扩展模块 -- RedisRoaring 的安装方法</a></li></ul><span id="more"></span><h2 id="RoaringBitmap-命令">RoaringBitmap 命令</h2><ul class="lvl-0"><li class="lvl-2"><p>可以在 redis-cli 中执行 <code>help @module</code>，找出所有 <code>R.*</code> 和 <code>R64.*</code> 的命令说明</p></li><li class="lvl-2"><p>R.*：操作的是 32 位无符号整数（最大约 2^32-1）</p></li><li class="lvl-2"><p>R64.*：操作的是 64 位无符号整数（最大约 2^64-1），适合超大 ID 空间，如 Snowflake / 时间戳映射</p><blockquote><p>R64.* 支持的整数理论上是 0 ~ 2⁶⁴-1（约 1.84e19），但工程上应谨慎使用超大 offset，避免稀疏爆炸和性能退化。</p></blockquote> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">high 32 bits  -&gt; container key 大桶</span><br><span class="line">low  32 bits  -&gt; container offset 小桶</span><br><span class="line"></span><br><span class="line">当你写入一个非常大的值，例如 10^18</span><br><span class="line">   虽然 Roaring 只为存在数据的 container 分配内存。</span><br><span class="line">   但 container 的 key 本身是一个 map / array 索引结构。</span><br><span class="line">   极端稀疏、超大 offset 会增加索引管理成本，会导致某些命令操作会变得很慢。</span><br><span class="line">   另外，一个容器至少要 几十字节 ~ 几百字节级别，容器的数量过多，单机内存也无法满足</span><br><span class="line">   如果你创建 10 亿个 container，假设每个 container 占用 100 字节，那么内存占用为：</span><br><span class="line">   10^9 containers × 100 bytes ≈ 100 GB 内存</span><br></pre></td></tr></table></figure></li><li class="lvl-2"><p>两者语义完全一致，仅支持的 offset 范围不同，以下示例以 R.* 为主。</p></li><li class="lvl-2"><p>对比 R 与 R64</p></li></ul><table><thead><tr><th>维度</th><th>R.*</th><th>R64.*</th></tr></thead><tbody><tr><td>Offset 类型</td><td>uint32</td><td>uint64</td></tr><tr><td>最大值</td><td>4,294,967,295 (~4.29e9)</td><td>18,446,744,073,709,551,615 (~1.84e19)</td></tr><tr><td>可表达规模</td><td>十亿级</td><td>万亿亿级</td></tr><tr><td>典型用途</td><td>用户ID、索引</td><td>时间戳、雪花ID、全局唯一ID</td></tr></tbody></table><h3 id="一、数据写入-修改类">一、数据写入 / 修改类</h3><table><thead><tr><th>命令</th><th>功能</th><th>典型用途</th><th>示例</th></tr></thead><tbody><tr><td>R.SETBIT</td><td>设置单个 bit（0/1），返回旧值</td><td>单点标记</td><td><code>R.SETBIT users 1001 1</code></td></tr><tr><td>R.SETRANGE</td><td>批量设置区间 bit=1</td><td>连续区间打标</td><td><code>R.SETRANGE users 3000 3999</code>，不包含3999</td></tr><tr><td>R.APPENDINTARRAY</td><td>追加多个整数（bit=1）</td><td>批量插入 ID</td><td><code>R.APPENDINTARRAY users 1001 1002 1003</code></td></tr><tr><td>R.SETINTARRAY</td><td>用整数数组重建 bitmap</td><td>初始化数据</td><td><code>R.SETINTARRAY users 1 3 5 7</code></td></tr><tr><td>R.SETBITARRAY</td><td>用 bit 字符串重建 bitmap</td><td>外部导入</td><td><code>R.SETBITARRAY users &quot;101001&quot;</code></td></tr><tr><td>R.DELETEINTARRAY</td><td>删除多个整数（bit=0）</td><td>批量删除</td><td><code>R.DELETEINTARRAY users 1002 2000</code></td></tr><tr><td>R.CLEARBITS</td><td>清除指定 offset</td><td>精确清理</td><td><code>R.CLEARBITS users 1001 1003</code></td></tr><tr><td>R.SETFULL</td><td>填充整个 bitmap</td><td>全量初始化</td><td><code>R.SETFULL users</code></td></tr><tr><td>R.CLEAR</td><td>删除整个 bitmap</td><td>释放资源</td><td><code>R.CLEAR users</code></td></tr></tbody></table><h3 id="二、数据读取-查询类">二、数据读取 / 查询类</h3><table><thead><tr><th>命令</th><th>功能</th><th>典型用途</th><th>示例</th></tr></thead><tbody><tr><td>R.GETBIT</td><td>获取单个 bit</td><td>判断是否存在</td><td><code>R.GETBIT users 1001</code></td></tr><tr><td>R.GETBITS</td><td>批量获取 bit</td><td>多点查询</td><td><code>R.GETBITS users 1001 1002 1003</code></td></tr><tr><td>R.GETBITARRAY</td><td>返回完整 bit 字符串</td><td>调试 / 导出</td><td><code>R.GETBITARRAY users</code></td></tr><tr><td>R.GETINTARRAY</td><td>返回所有为 1 的整数</td><td>全量遍历</td><td><code>R.GETINTARRAY users</code></td></tr><tr><td>R.RANGEINTARRAY</td><td>返回区间内整数，注意这里参数是<code>索引下标</code>，不是<code>数值</code></td><td>分页扫描</td><td><code>R.RANGEINTARRAY users 1 5</code></td></tr><tr><td>R.MIN</td><td>最小 offset</td><td>最小 ID 查询</td><td><code>R.MIN users</code></td></tr><tr><td>R.MAX</td><td>最大 offset</td><td>最大 ID 查询</td><td><code>R.MAX users</code></td></tr></tbody></table><h3 id="三、统计类">三、统计类</h3><table><thead><tr><th>命令</th><th>功能</th><th>典型用途</th><th>示例</th></tr></thead><tbody><tr><td>R.BITCOUNT</td><td>bit=1 数量统计</td><td>集合基数</td><td><code>R.BITCOUNT users</code></td></tr><tr><td>R.BITPOS</td><td>查找第一个 1 或 0</td><td>稀疏分析</td><td><code>R.BITPOS users 1</code></td></tr><tr><td>R.MIN</td><td>最小 bit 位置</td><td>边界检测</td><td><code>R.MIN users</code></td></tr><tr><td>R.MAX</td><td>最大 bit 位置</td><td>边界检测</td><td><code>R.MAX users</code></td></tr><tr><td>R.STAT</td><td>容器 / 内存统计</td><td>性能调优</td><td><code>R.STAT users TEXT</code></td></tr></tbody></table><h3 id="四、集合运算类">四、集合运算类</h3><table><thead><tr><th>命令</th><th>功能</th><th>集合语义</th><th>示例</th></tr></thead><tbody><tr><td>R.BITOP AND</td><td>位图交集</td><td>A ∩ B</td><td><code>R.BITOP AND res a b</code></td></tr><tr><td>R.BITOP OR</td><td>位图并集</td><td>A ∪ B</td><td><code>R.BITOP OR res a b</code></td></tr><tr><td>R.BITOP XOR</td><td>对称差集</td><td>A ⊕ B</td><td><code>R.BITOP XOR res a b</code></td></tr><tr><td>R.DIFF</td><td>差集</td><td>A - B</td><td><code>R.DIFF res a b</code></td></tr><tr><td>R.CONTAINS</td><td>包含关系判断</td><td>子集检测</td><td><code>R.CONTAINS a b ALL</code></td></tr><tr><td>R.JACCARD</td><td>相似度计算</td><td>J(A,B)</td><td><code>R.JACCARD a b</code></td></tr></tbody></table><h3 id="五、维护-优化类">五、维护 / 优化类</h3><table><thead><tr><th>命令</th><th>功能</th><th>典型用途</th><th>示例</th></tr></thead><tbody><tr><td>R.OPTIMIZE</td><td>容器重整 / 压缩</td><td>降低内存</td><td><code>R.OPTIMIZE users MEM</code></td></tr><tr><td>R.CLEAR</td><td>清理 bitmap</td><td>回收资源</td><td><code>R.CLEAR users</code></td></tr></tbody></table><h3 id="六、R-R64-对照表（含示例）">六、R / R64 对照表（含示例）</h3><table><thead><tr><th>功能</th><th>R (32bit)</th><th>R64 (64bit)</th><th>示例</th></tr></thead><tbody><tr><td>设置 bit</td><td>R.SETBIT</td><td>R64.SETBIT</td><td><code>R64.SETBIT users64 90000000000 1</code></td></tr><tr><td>批量插入</td><td>R.APPENDINTARRAY</td><td>R64.APPENDINTARRAY</td><td><code>R64.APPENDINTARRAY users64 90000000001 90000000002</code></td></tr><tr><td>查询 bit</td><td>R.GETBIT</td><td>R64.GETBIT</td><td><code>R64.GETBIT users64 90000000001</code></td></tr><tr><td>统计</td><td>R.BITCOUNT</td><td>R64.BITCOUNT</td><td><code>R64.BITCOUNT users64</code></td></tr><tr><td>集合运算</td><td>R.BITOP</td><td>R64.BITOP</td><td><code>R64.BITOP OR res64 a64 b64</code></td></tr><tr><td>优化</td><td>R.OPTIMIZE</td><td>R64.OPTIMIZE</td><td><code>R64.OPTIMIZE users64 MEM</code></td></tr></tbody></table><h2 id="真实案例">真实案例</h2><ul class="lvl-0"><li class="lvl-2"><p>场景说明</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">假设我们有一个电商平台，需要统计以下指标：</span><br><span class="line">   VIP 用户（购买金额超过 1000 的用户）</span><br><span class="line">   付费用户（至少购买一次的用户）</span><br><span class="line">   最近活跃用户（过去 7 天内登录过的用户）</span><br><span class="line"></span><br><span class="line">我们想要计算：</span><br><span class="line">   VIP 用户人数</span><br><span class="line">   VIP 且最近活跃的用户人数</span><br><span class="line">   VIP 且付费用户且最近活跃的人数</span><br><span class="line">   付费用户与最近活跃用户的 Jaccard 相似度</span><br><span class="line"></span><br><span class="line">假设用户 ID 为整数（最大值 &lt; 2^32，使用 R.* 即可）。</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><ol><li class="lvl-5">写入数据（模拟）</li></ol></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># VIP 用户</span></span><br><span class="line">R.APPENDINTARRAY vip_users 1001 1002 1003 1004 1005</span><br><span class="line"></span><br><span class="line"><span class="comment"># 付费用户</span></span><br><span class="line">R.APPENDINTARRAY paid_users 1002 1003 1005 1006 1007</span><br><span class="line"></span><br><span class="line"><span class="comment"># 最近活跃用户</span></span><br><span class="line">R.APPENDINTARRAY active_users 1001 1003 1005 1008</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看数据类型</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">type</span> active_users</span><br><span class="line">reroaring</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><ol start="2"><li class="lvl-5">查询基础统计</li></ol></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># VIP 用户人数</span></span><br><span class="line">R.BITCOUNT vip_users</span><br><span class="line"><span class="comment"># 返回 5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 最近活跃用户人数</span></span><br><span class="line">R.BITCOUNT active_users</span><br><span class="line"><span class="comment"># 返回 4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 付费用户人数</span></span><br><span class="line">R.BITCOUNT paid_users</span><br><span class="line"><span class="comment"># 返回 5</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><ol start="3"><li class="lvl-5">计算交集 / 子集</li></ol></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.VIP 且最近活跃用户</span></span><br><span class="line">R.BITOP AND vip_active vip_users active_users</span><br><span class="line">R.BITCOUNT vip_active</span><br><span class="line"><span class="comment"># 返回 3</span></span><br><span class="line"><span class="comment"># 解释：用户 1001, 1003, 1005 同时是 VIP 且最近活跃。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.VIP 且付费用户且最近活跃</span></span><br><span class="line"><span class="comment"># 先计算 VIP 与付费交集</span></span><br><span class="line">R.BITOP AND vip_paid vip_users paid_users</span><br><span class="line"><span class="comment"># 再计算 vip_paid 与活跃用户交集</span></span><br><span class="line">R.BITOP AND vip_paid_active vip_paid active_users</span><br><span class="line">R.BITCOUNT vip_paid_active</span><br><span class="line"><span class="comment"># 返回 2</span></span><br><span class="line"><span class="comment"># 解释：用户 1003, 1005 同时满足三条件。</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><ol start="4"><li class="lvl-5">计算 Jaccard 相似度</li></ol></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 计算 付费用户 与 最近活跃用户 的相似度</span></span><br><span class="line">R.JACCARD paid_users active_users</span><br><span class="line"><span class="comment"># 返回 &quot;0.2857142857142857&quot;</span></span><br><span class="line"><span class="comment"># Jaccard 相似度计算公式：</span></span><br><span class="line">   J(A, B) = |A ∩ B| / |A ∪ B| = 交集 / 并集</span><br><span class="line">   0.2857142857142857 = |1003, 1005| / |1001, 1002, 1003, 1005, 1006, 1007, 1008| = 2 / 7 = 0.2857142857142857</span><br></pre></td></tr></table></figure><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>J</mi><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>B</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi mathvariant="normal">∣</mi><mi>A</mi><mo>∩</mo><mi>B</mi><mi mathvariant="normal">∣</mi></mrow><mrow><mi mathvariant="normal">∣</mi><mi>A</mi><mo>∪</mo><mi>B</mi><mi mathvariant="normal">∣</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">J(A, B) = \frac{|A \cap B|}{|A \cup B|}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.363em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">∣</span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∪</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord">∣</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">∣</span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∩</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord">∣</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><ul class="lvl-0"><li class="lvl-2"><ol start="5"><li class="lvl-5">范围 / ID 查询</li></ol></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.获取 VIP 用户 ID 列表</span></span><br><span class="line">R.GETINTARRAY vip_users</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 1001  <span class="comment"># 1 是索引，1001 是值</span></span><br><span class="line">2) (<span class="built_in">integer</span>) 1002</span><br><span class="line">3) (<span class="built_in">integer</span>) 1003</span><br><span class="line">4) (<span class="built_in">integer</span>) 1004</span><br><span class="line">5) (<span class="built_in">integer</span>) 1005</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.获取最近活跃用户 ID，索引范围 在 1~3 范围，注意这里的索引是 R.GETINTARRAY 返回的索引下标，不是值。</span></span><br><span class="line">R.RANGEINTARRAY active_users 1 3</span><br><span class="line"><span class="comment"># 返回 1003, 1005, 1008</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 1003</span><br><span class="line">2) (<span class="built_in">integer</span>) 1005</span><br><span class="line">3) (<span class="built_in">integer</span>) 1008</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><ol start="6"><li class="lvl-5">优化存储</li></ol></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果数据量非常大，可以优化内存</span></span><br><span class="line">R.OPTIMIZE vip_users MEM</span><br><span class="line">R.OPTIMIZE paid_users MEM</span><br><span class="line">R.OPTIMIZE active_users MEM</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文介绍 Redis 扩展模块 – RedisRoaring 中 RoaringBitmap 数据类型&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文基于&lt;code&gt;redis-7.4.7&lt;/code&gt;，&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;操作系统：&lt;code&gt;Amazon Linux 2023(内核 6.1)&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis官网：&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis 命令文档：&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;RedisRoaring 的安装参见 &lt;a href=&quot;/2026/01/08/redis7-module-RedisRoaring/&quot; title=&quot;Redis 扩展模块 -- RedisRoaring 的安装方法&quot;&gt;Redis 扩展模块 -- RedisRoaring 的安装方法&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis 扩展模块 -- RedisRoaring 的安装方法</title>
    <link href="https://blog.hanqunfeng.com/2026/01/08/redis7-module-RedisRoaring/"/>
    <id>https://blog.hanqunfeng.com/2026/01/08/redis7-module-RedisRoaring/</id>
    <published>2026-01-08T13:30:05.000Z</published>
    <updated>2026-01-08T09:44:21.470Z</updated>
    
    <content type="html"><![CDATA[<h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2">本文介绍 Redis 扩展模块 – RedisRoaring 的安装方法</li><li class="lvl-2">本文基于<code>redis-7.4.7</code>，<code>springboot-3.5.8</code></li><li class="lvl-2">操作系统：<code>Amazon Linux 2023(内核 6.1)</code></li><li class="lvl-2">Redis官网：<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis 命令文档：<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li></ul><span id="more"></span><h2 id="RedisRoaring-简介">RedisRoaring 简介</h2><ul class="lvl-0"><li class="lvl-2"><p><a href="https://github.com/aviggiano/redis-roaring">RedisRoaring</a>是一个开源的 Redis 模块（Redis Module），由 Antonio Guilherme Ferreira Viggiano 维护，目的是将 Roaring Bitmap 数据结构原生集成到 Redis 中作为新的数据类型与命令集。</p></li><li class="lvl-2"><p>它基于 CRoaring 库实现压缩位图（Roaring Bitmap）功能，这是一种高效、压缩的位图数据结构，适合处理大规模整数集合。</p></li><li class="lvl-2"><p>兼容 Redis 6.0 及以上版本，在不同版本中对命令元数据、ACL 分类等功能有自动适配支持。</p></li></ul><h2 id="原生的redis-bitmap有哪些问题">原生的<code>redis bitmap</code>有哪些问题?</h2><ul class="lvl-0"><li class="lvl-2"><p>结论先行：Redis 原生 Bitmap 的核心问题是「空间不可控 + 大规模位运算性能随最大偏移线性增长」，而 redis-roaring 通过 Roaring Bitmap 解决了稀疏数据内存浪费和大范围扫描效率问题。</p></li><li class="lvl-2"><p>Bitmap 是连续数组，不支持稀疏压缩， 其必须 从 0 到最大 bit offset 全部连续分配内存。你只要设置了 bit=1 的最大下标是 N，那么 Redis 至少要分配 N/8 字节内存。</p></li><li class="lvl-2"><p>假设你要存储用户ID集合，但是存储的ID范围较大，比如 1-2000000000，那么就会导致Bitmap的bit offset非常大，导致Bitmap的存储空间非常大。</p></li><li class="lvl-2"><p>另外如果数据比较稀疏，极端情况下只存储了2个ID，ID1:1，ID2:2000000000，那么Bitmap就要按照最大的 offset进行分配空间，导致Bitmap的存储空间非常大，但是中间的空间又被浪费了。</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SETBIT user:bitmap 1 1</span><br><span class="line">SETBIT user:bitmap 2000000000 1</span><br><span class="line"><span class="comment"># 2_000_000_000 bits ≈ 250 MB</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Redis 内部必须扫描：0 ... max_offset，即使只有 2 个 bit 为 1，也必须扫描 250MB 内存。</span></span><br><span class="line">BITCOUNT user:bitmap</span><br></pre></td></tr></table></figure><h2 id="Roaring-Bitmap实现思路">Roaring Bitmap实现思路</h2><ul class="lvl-0"><li class="lvl-2"><p>将32位的int类型数据进行<code>高16位</code>、<code>低16位</code>划分，高16位就被划分成<code>2^16=65536个大桶（容器）</code>，低16位最多被划分成<code>2^16=65536个小桶（元素）</code></p></li><li class="lvl-2"><p>把要统计的数字拆分位高16位和低16位，高16位用作容器的索引、用于定位数字在哪个容器；低16位用作容器内元素的索引、用作定位数字在容器内的位置。</p></li><li class="lvl-2"><p>高16位和低16位的计算</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">公式：x = high * 2^16 + low</span><br><span class="line">对一个整数 x：</span><br><span class="line">高 16 位（High） = x / 2^16（整数除法）</span><br><span class="line">低 16 位（Low） = x % 2^16</span><br><span class="line"></span><br><span class="line">高 16 位用于定位“容器（container）”，低 16 位用于定位容器内部的位置。</span><br><span class="line"></span><br><span class="line">假设一个 32 位整数：x = 305419896 = 0x12345678 （十六进制）</span><br><span class="line">高 16 位（High） = x / 2^16 = 305419896 / 65536 = 4660</span><br><span class="line">低 16 位（Low） = x % 2^16  = 305419896 % 65536 = 22136</span><br><span class="line">属于：container 4660, offset 22136</span><br><span class="line"></span><br><span class="line">转为二进制（32 位）进行验证：</span><br><span class="line">0001 0010 0011 0100 | 0101 0110 0111 1000</span><br><span class="line">   ↑ 高 16 位       |    ↑ 低 16 位</span><br><span class="line"></span><br><span class="line">| 部分   | 二进制              | 十六进制   | 十进制   |</span><br><span class="line">| ---- | ------------------- | ------ | ----- |</span><br><span class="line">| 高16位 | 0001 0010 0011 0100 | 0x1234 | 4660  |</span><br><span class="line">| 低16位 | 0101 0110 0111 1000 | 0x5678 | 22136 |</span><br><span class="line"></span><br><span class="line">边界例子（容器切换点）</span><br><span class="line">x = 65535</span><br><span class="line">high = 65535 / 65536 = 0</span><br><span class="line">low  = 65535 % 65536 = 65535</span><br><span class="line">属于：container 0, offset 65535 （容器0的最后一个位置）</span><br><span class="line"></span><br><span class="line">x = 65536</span><br><span class="line">high = 65536 / 65536 = 1</span><br><span class="line">low  = 65536 % 65536 = 0</span><br><span class="line">属于：container 1, offset 0 （容器1的第一个位置）</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>容器有三种不同类型: <code>ArrayContainer</code>、<code>BitmapContainer</code>和<code>RunContainer</code>，根据要统计的数字的数量和数字的连续性自动选择合适的容器。</p></li></ul><table><thead><tr><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>ArrayContainer</td><td>稀疏（少量整数），元素为short类型的有序数组<br>最多存储 65536 个 short 元素，占用 128 KB 内存</td></tr><tr><td>BitmapContainer</td><td>密集 ，使用bitmap存储数据，固定占用 8kB 内存</td></tr><tr><td>RunContainer</td><td>连续区间，使用Run-Length Encoding方式压缩存储的元素，对连续数据的压缩效果特别好。<br>它的原理是，对于连续出现的数字，只记录初始数字和后续数量。即：<br>对于数据集：5，会压缩为5, 0<br>对于数据集：5, 6, 7, 8, 9, 10，会压缩为5, 5<br>对于数据集：5, 7, 9, 11, 12，会压缩为5, 0, 7, 0, 9, 0, 11, 1 <br>最好情况：全部是连续数字，只会存储 2 个 short ，占用 4 bytes<br>最坏情况：0~65535的范围内填充所有的奇数位或偶数位，需要 65536 个short，占用 128 KB</td></tr></tbody></table><h3 id="容器的使用及容器之间的转换">容器的使用及容器之间的转换</h3><ul class="lvl-0"><li class="lvl-2"><p>Roaring 的目标是：在保证操作性能的前提下，使内存占用最小。</p></li><li class="lvl-2"><p>因此：插入、删除、合并、运算后，会评估当前 container 的“最优类型”，必要时自动转换</p></li><li class="lvl-2"><p>✅ Array → Bitmap，触发条件：容器中元素数量 &gt; 4096</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">原因：</span><br><span class="line">   Array 每个元素占 2 bytes</span><br><span class="line">   4096 × 2 = 8192 bytes</span><br><span class="line">   Bitmap 固定 8192 bytes</span><br><span class="line"></span><br><span class="line">超过这个点，Bitmap 更省内存 + 查询更快。</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>✅ Bitmap → Array，触发条件：容器中元素数量 &lt;= 4096，一般在大量删除或 AND 运算后触发。</p></li><li class="lvl-2"><p>✅ RunContainer ↔ Array / Bitmap，Run 没有固定阈值，而是 动态评估内存模型，基于如下三个指标：</p><ul class="lvl-2"><li class="lvl-5">run_count : 当前 RunContainer 中有多少个连续区间</li></ul> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">例如集合：&#123;1,2,3,4,5,  10,11,12,  100&#125;</span><br><span class="line">连续区间：[1..5], [10..12], [100..100]</span><br><span class="line">因此：run_count = 3</span><br></pre></td></tr></table></figure></li></ul><table><thead><tr><th>run_count</th><th>数据形态</th><th>适合 Run 吗</th></tr></thead><tbody><tr><td>很小（1~几十）</td><td>大段连续</td><td>极其适合</td></tr><tr><td>中等（几百）</td><td>稍碎</td><td>可能适合</td></tr><tr><td>很大（上千）</td><td>高度碎片化</td><td>不适合</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-5"><p>run_total_coverage : run 覆盖的总元素数量(本质就是元素的数量)</p></li></ul>   <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[1..5]  → 5 个</span><br><span class="line">[10..12] → 3 个</span><br><span class="line">[100..100] → 1 个</span><br><span class="line"></span><br><span class="line">run_total_coverage = 9</span><br><span class="line"></span><br><span class="line">实际上更重要的指标是 平均 run 长度</span><br><span class="line">平均 run 长度 = run_total_coverage / run_count = 9 / 3 = 3</span><br></pre></td></tr></table></figure><table><thead><tr><th>run_count</th><th>coverage</th><th>平均长度</th><th>形态</th><th>适合 Run 吗</th></tr></thead><tbody><tr><td>1</td><td>60,000</td><td>60,000</td><td>超长连续</td><td>极适合</td></tr><tr><td>10</td><td>50,000</td><td>5,000</td><td>大段连续</td><td>适合</td></tr><tr><td>5,000</td><td>50,000</td><td>10</td><td>碎片连续</td><td>非常不适合</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-5"><p>estimated_memory : 估算内存占用，这是核心决策指标</p></li></ul>   <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">memory_run: 如果用 RunContainer，需要多少内存， ≈ run_count × RUN_ENTRY_SIZE(4 bytes)</span><br><span class="line">memory_array: 如果用 ArrayContainer，需要多少内存， ≈ 元素数量 × 2 bytes</span><br><span class="line">memory_bitmap: 如果用 BitmapContainer，需要多少内存，固定内存 = 8192 bytes</span><br><span class="line"></span><br><span class="line">▶ 选择逻辑（简化）</span><br><span class="line"><span class="keyword">if</span> memory_run &lt; min(memory_array, memory_bitmap):</span><br><span class="line">   use RunContainer</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> memory_array &lt; memory_bitmap:</span><br><span class="line">   use ArrayContainer</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">   use BitmapContainer</span><br></pre></td></tr></table></figure><table><thead><tr><th>转换方向</th><th>触发条件</th></tr></thead><tbody><tr><td>Array → Bitmap</td><td>元素数量 &gt; 4096</td></tr><tr><td>Bitmap → Array</td><td>元素数量 ≤ 4096</td></tr><tr><td>任意 → Run</td><td>连续区间压缩明显</td></tr><tr><td>Run → Array / Bitmap</td><td>run 碎片化或内存劣化</td></tr><tr><td>批量运算</td><td>根据结果自动选择</td></tr><tr><td>optimize</td><td>强制重新评估</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>✅ 在 Roaring 的自动选择机制下，正常情况下单个 container 的内存占用会被控制在 ≈ 8KB 左右或更小，在“理论极限完全填满65535个 container”情况下，大约占 520 MB 内存(除了数据本身还有一些元数据)</p></li></ul><table><thead><tr><th>项目</th><th>估算</th></tr></thead><tbody><tr><td>Bitmap 数据</td><td>~512 MB</td></tr><tr><td>Container 元数据</td><td>~4 MB</td></tr><tr><td>索引结构</td><td>~1 MB</td></tr><tr><td>Redis Key 自身</td><td>~0.1 MB</td></tr><tr><td><strong>合计</strong></td><td><strong>约 517 MB</strong></td></tr></tbody></table><p><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/Vw540M.png" alt="" width="1000" height="500"></p><ul class="lvl-0"><li class="lvl-2"><p>直观对比表</p></li></ul><table><thead><tr><th>维度</th><th>Redis Bitmap</th><th>redis-roaring</th></tr></thead><tbody><tr><td>存储结构</td><td>连续 bit array</td><td>压缩 bitmap（分块）</td></tr><tr><td>稀疏数据内存</td><td>极差</td><td>极优</td></tr><tr><td>最大 offset</td><td>越大内存越爆</td><td>几乎无影响</td></tr><tr><td>BITCOUNT / BITOP</td><td>扫描整个 bitmap</td><td>只扫描有效 container</td></tr><tr><td>扩容成本</td><td>可能大规模 realloc</td><td>局部 container 扩展</td></tr><tr><td>单 bit 读写</td><td>极快</td><td>略慢（结构层）</td></tr><tr><td>模块依赖</td><td>原生</td><td>Redis Module</td></tr><tr><td>运维复杂度</td><td>最低</td><td>稍高</td></tr></tbody></table><h2 id="RedisRoaring核心价值与优势">RedisRoaring核心价值与优势</h2><ul class="lvl-0"><li class="lvl-2"><ol><li class="lvl-5">内存效率更高</li></ol><ul class="lvl-2"><li class="lvl-5">Roaring Bitmap 会根据数据稀疏/密集自动选择最优表示方式（数组、位图或运行长度编码），显著减少内存占用，相比传统 Redis Bitmap 在稀疏数据上能节省大量空间。</li></ul></li><li class="lvl-2"><ol start="2"><li class="lvl-5">高性能位操作</li></ol><ul class="lvl-2"><li class="lvl-5">对单个位的操作保持 O(1) 性能，与 Redis 原生位图操作一致。</li><li class="lvl-5">对于大规模操作（例如 BITOP AND/OR/XOR）性能显著优于原生位图，某些操作可达到 8 倍性能提升。</li></ul></li><li class="lvl-2"><ol start="3"><li class="lvl-5">结构丰富的命令集</li></ol><ul class="lvl-2"><li class="lvl-5">除了传统位图命令之外，redis-roaring 提供更丰富的数据操作命令，支持批量和分析型用例。</li></ul></li></ul><h2 id="安装-RedisRoaring">安装 RedisRoaring</h2><blockquote><p>安装时需要科学上网，主要是安装依赖时需要从海外网下载，如果要部署在国内服务器，可能会连接失败。<br>可以在海外的<code>相同配置</code>的服务器上进行编译，之后将编译好的<code>redistimeseries.so</code>上传到国内服务器即可。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /usr/local/soft/modules/</span><br><span class="line"><span class="built_in">cd</span> /usr/local/soft/modules</span><br><span class="line"><span class="comment"># clone 代码</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/aviggiano/redis-roaring.git</span><br><span class="line"><span class="built_in">cd</span> redis-roaring/</span><br><span class="line"><span class="comment"># 推荐切换到稳定的release版本</span></span><br><span class="line">git checkout v1.7.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译构建，作者将下载子模块、编译安装等命令都封装到一个脚本中，这里直接执行脚本即可</span></span><br><span class="line">./configure.sh</span><br><span class="line"><span class="comment"># 如果没有错误，则说明编译成功，输出: dist/libredis-roaring.so</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>实际上<code>redis-roaring</code>在构建后会在<code>dist</code>目录下生成好 Redis 相关命令和配置文件，如果没有安装Redis则可以直接使用。<code>v1.7.1</code>版本提供的Redis的版本为<code>8.2.1</code>，但此时是不带 Stack 相关模块的。</p></li></ul><h2 id="Redis-启用模块">Redis 启用模块</h2><ul class="lvl-0"><li class="lvl-2"><p>将生成的 <code>libredis-roaring.so</code> 拷贝到 redis 的 modules 目录下（非必须），目录不存在则创建</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意 .so 文件需要包含可执行权限</span></span><br><span class="line"><span class="built_in">cp</span> dist/libredis-roaring.so /usr/local/soft/redis-7.4.7/modules/libredis-roaring.so</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>本文采用 <code>loadmodule</code> 加载模块</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 libredis-roaring.so 添加到 redis.conf 中，需要重启 redis</span></span><br><span class="line">loadmodule /usr/local/soft/redis-7.4.7/modules/libredis-roaring.so</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动redis</span></span><br><span class="line">redis-server redis.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录测试</span></span><br><span class="line">redis-cli --user admin --pass 123456</span><br><span class="line"><span class="comment"># 查看模块</span></span><br><span class="line">127.0.0.1:6379&gt; MODULE LIST</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">1) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;ReJSON&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 20816</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/local/soft/redis-7.4.7/modules/rejson.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">2) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;timeseries&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 11209</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/local/soft/redis-7.4.7/modules/redistimeseries.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">3) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;search&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 21025</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/local/soft/redis-7.4.7/modules/redisearch.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">4) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;bf&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 20817</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/local/soft/redis-7.4.7/modules/redisbloom.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">5) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;REDIS-ROARING&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 10700</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/local/soft/redis-7.4.7/modules/libredis-roaring.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文介绍 Redis 扩展模块 – RedisRoaring 的安装方法&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文基于&lt;code&gt;redis-7.4.7&lt;/code&gt;，&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;操作系统：&lt;code&gt;Amazon Linux 2023(内核 6.1)&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis官网：&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis 命令文档：&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis 命令及数据类型 -- TimeSeries</title>
    <link href="https://blog.hanqunfeng.com/2026/01/07/redis7-datatype-18-TimeSeries/"/>
    <id>https://blog.hanqunfeng.com/2026/01/07/redis7-datatype-18-TimeSeries/</id>
    <published>2026-01-07T14:30:05.000Z</published>
    <updated>2026-01-07T10:32:15.918Z</updated>
    
    <content type="html"><![CDATA[<h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2">本文介绍 Redis 扩展模块 – RedisTimeSeries 中 TimeSeries 数据类型</li><li class="lvl-2">本文基于<code>redis-7.4.7</code>，<code>springboot-3.5.8</code></li><li class="lvl-2">操作系统：<code>Amazon Linux 2023(内核 6.1)</code></li><li class="lvl-2">Redis官网：<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis 命令文档：<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li><li class="lvl-2">RedisTimeSeries 的安装参见 <a href="/2026/01/07/redis7-module-RedisTimeSeries/" title="Redis 扩展模块 -- RedisTimeSeries 的安装方法">Redis 扩展模块 -- RedisTimeSeries 的安装方法</a></li></ul><span id="more"></span><h2 id="TimeSeries-简介">TimeSeries 简介</h2><ul class="lvl-0"><li class="lvl-2"><p>TimeSeries 是 Redis 的一个扩展模块，用于处理时间序列数据，<a href="https://redis.io/modules/redis-timeseries/?utm_source=chatgpt.com">RedisTimeSeries | A NoSQL Time Series Database</a></p></li><li class="lvl-2"><p>核心设计与数据模型</p></li></ul><blockquote><p>一个 Redis 时间序列（Time Series） 是有序的一系列采样数据点：</p></blockquote><table><thead><tr><th>组成部分</th><th>说明</th></tr></thead><tbody><tr><td><strong>时间戳（timestamp）</strong></td><td>毫秒级时间标签，可客户端指定或由服务器填充</td></tr><tr><td><strong>值（value）</strong></td><td>64 位浮点数</td></tr><tr><td><strong>元数据（labels）</strong></td><td>一组键值对，可用于过滤与聚合查询</td></tr><tr><td><strong>保留策略（retention）</strong></td><td>数据生命周期控制，过期自动丢弃</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>主要功能与特性</p></li></ul><table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>高吞吐写入</strong></td><td>支持每秒接收大量数据点，延迟极低</td></tr><tr><td><strong>区间查询</strong></td><td>可按时间范围检索数据，如 <code>TS.RANGE</code> / <code>TS.MRANGE</code></td></tr><tr><td><strong>聚合查询</strong></td><td>内建 min、max、avg、sum、count、first、last 等聚合功能</td></tr><tr><td><strong>自动下采样 &amp; 累积规则</strong></td><td>通过 aggregation rules 自动生成更粗粒度指标</td></tr><tr><td><strong>保留策略（Retention）</strong></td><td>设置最大保存时间或样本数量</td></tr><tr><td><strong>标签索引（Labels）</strong></td><td>支持基于标签的跨序列查询</td></tr><tr><td><strong>高效存储</strong></td><td>使用压缩与内存结构优化空间成本</td></tr><tr><td><strong>工具整合</strong></td><td>支持 Grafana、Prometheus、Telegraf 等生态集成</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>应用场景</p></li></ul><table><thead><tr><th>场景</th><th>描述</th></tr></thead><tbody><tr><td><strong>物联网（IoT）监控</strong></td><td>温度、湿度、设备状态等</td></tr><tr><td><strong>系统监控与指标收集</strong></td><td>CPU、内存、网络指标的实时存储与分析</td></tr><tr><td><strong>业务指标分析</strong></td><td>每日/每小时活跃用户数量、请求延迟等</td></tr><tr><td><strong>金融时间序列</strong></td><td>股票价格、交易量的快速写入和分析</td></tr><tr><td><strong>实时告警</strong></td><td>数据越界时触发告警逻辑</td></tr></tbody></table><h2 id="TimeSeries-命令说明">TimeSeries 命令说明</h2><ul class="lvl-0"><li class="lvl-2"><p>按“生命周期”视角的快速索引</p></li></ul><table><thead><tr><th>阶段</th><th>对应命令</th></tr></thead><tbody><tr><td>创建</td><td>TS.CREATE</td></tr><tr><td>修改结构</td><td>TS.ALTER</td></tr><tr><td>建立聚合</td><td>TS.CREATERULE / TS.DELETERULE</td></tr><tr><td>写入</td><td>TS.ADD / TS.MADD / TS.INCRBY / TS.DECRBY</td></tr><tr><td>查询单序列</td><td>TS.GET / TS.RANGE / TS.REVRANGE</td></tr><tr><td>查询多序列</td><td>TS.MGET / TS.MRANGE / TS.MREVRANGE / TS.QUERYINDEX</td></tr><tr><td>清理数据</td><td>TS.DEL</td></tr><tr><td>查看状态</td><td><a href="http://TS.INFO">TS.INFO</a></td></tr></tbody></table><h3 id="一、时间序列创建与结构管理类">一、时间序列创建与结构管理类</h3><table><thead><tr><th>命令</th><th>功能说明</th><th>典型使用场景</th></tr></thead><tbody><tr><td><strong>TS.CREATE</strong></td><td>创建一个新的时间序列（可指定保留策略、标签、chunk 大小等）</td><td>初始化指标，如创建 CPU、QPS、延迟等指标序列</td></tr><tr><td><strong>TS.ALTER</strong></td><td>修改已有时间序列的配置（retention、chunk size、duplicate policy、labels）</td><td>动态调整数据保留周期、标签信息</td></tr><tr><td><strong>TS.CREATERULE</strong></td><td>创建压缩 / 聚合规则（从 source series 自动聚合到 dest series）</td><td>原始数据 → 按分钟 / 小时聚合</td></tr><tr><td><strong>TS.DELETERULE</strong></td><td>删除已有的压缩 / 聚合规则</td><td>停止某条自动聚合规则</td></tr></tbody></table><h4 id="1️⃣-TS-CREATE-创建时间序列">1️⃣ TS.CREATE : 创建时间序列</h4><ul class="lvl-0"><li class="lvl-2"><p>语法：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">TS.CREATE key</span><br><span class="line">  [RETENTION retentionPeriod]</span><br><span class="line">  [ENCODING &lt;COMPRESSED|UNCOMPRESSED&gt;]</span><br><span class="line">  [CHUNK_SIZE size]</span><br><span class="line">  [DUPLICATE_POLICY policy]</span><br><span class="line">  [IGNORE ignoreMaxTimediff ignoreMaxValDiff]</span><br><span class="line">  [LABELS [label value ...]]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>参数说明：</p></li></ul><table><thead><tr><th>参数</th><th>作用</th><th>可选值 / 约束</th><th>默认值</th><th>典型使用建议</th></tr></thead><tbody><tr><td><strong>key</strong></td><td>时间序列的 Redis Key</td><td>任意合法 Redis key</td><td>无</td><td>建议包含业务语义，如 <code>ts:cpu:node1</code></td></tr><tr><td><strong>RETENTION</strong></td><td>数据保留时长（毫秒），超过自动删除</td><td>≥ 0，0 表示永久保留</td><td>0</td><td>高频指标必须设置，避免内存无限增长</td></tr><tr><td><strong>ENCODING</strong></td><td>数据存储编码方式</td><td><code>COMPRESSED</code>: 内存占用低，CPU 有轻微开销<br>  <code>UNCOMPRESSED</code>:查询快，占用内存高</td><td><code>COMPRESSED</code></td><td>绝大多数场景保持默认</td></tr><tr><td><strong>CHUNK_SIZE</strong></td><td>每个数据块的大小（字节），影响内存碎片与压缩效率</td><td>≥ 128 bytes（通常 1KB–64KB）</td><td>4096</td><td>写入频繁时适当调大</td></tr><tr><td><strong>DUPLICATE_POLICY</strong></td><td>同一 timestamp 重复写入时的处理策略</td><td>见下表</td><td>全局配置</td><td>明确指定，避免默认行为变化</td></tr><tr><td><strong>IGNORE</strong></td><td>忽略与上一点差异过小的数据</td><td><code>ignoreMaxTimediff</code>: 最大允许时间差（毫秒）<br> <code>ignoreMaxValDiff</code>: 最大允许的数值差</td><td>关闭</td><td>用于降噪和降采样 <br>示例：<code>IGNORE 1000 0.01</code>： 1 秒内，变化小于 0.01 的数据将被忽略</td></tr><tr><td><strong>LABELS</strong></td><td>标签键值对，用于索引和过滤</td><td>任意字符串对<br><code>LABELS key1 value1 key2 value2 ... </code></td><td>无</td><td>强烈建议用于查询</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>DUPLICATE_POLICY（重复时间戳策略）</p></li></ul><blockquote><p>当同一个 timestamp 被多次写入时生效</p></blockquote><table><thead><tr><th>策略</th><th>处理逻辑</th></tr></thead><tbody><tr><td><strong>BLOCK</strong></td><td>默认，重复时间戳直接失败</td></tr><tr><td><strong>FIRST</strong></td><td>保留已有值，忽略新值</td></tr><tr><td><strong>LAST</strong></td><td>覆盖已有值，用新值替代</td></tr><tr><td><strong>MIN</strong></td><td>仅当新值更小才覆盖</td></tr><tr><td><strong>MAX</strong></td><td>仅当新值更大才覆盖</td></tr><tr><td><strong>SUM</strong></td><td>累加值（已有值 + 新值）</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>示例: 创建一个 CPU 指标时间序列，自动过期 1 小时之前的数据</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">TS.CREATE ts:cpu:server1</span><br><span class="line">  RETENTION 3600000</span><br><span class="line">  ENCODING COMPRESSED</span><br><span class="line">  CHUNK_SIZE 8192</span><br><span class="line">  DUPLICATE_POLICY LAST</span><br><span class="line">  IGNORE 1000 0.1</span><br><span class="line">  LABELS host server1 metric cpu</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看数据类型</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">type</span> ts:cpu:server1</span><br><span class="line">TSDB-TYPE</span><br></pre></td></tr></table></figure><h4 id="2️⃣-TS-ALTER-修改时间序列配置">2️⃣ TS.ALTER : 修改时间序列配置</h4><ul class="lvl-0"><li class="lvl-2"><p>语法：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TS.ALTER key</span><br><span class="line">  [RETENTION retentionPeriod]</span><br><span class="line">  [CHUNK_SIZE size]</span><br><span class="line">  [DUPLICATE_POLICY policy]</span><br><span class="line">  [LABELS [label value ...]]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>示例：修改保留周期和标签</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TS.ALTER ts:cpu:server1</span><br><span class="line">  RETENTION 7200000</span><br><span class="line">  LABELS host server1 metric cpu <span class="built_in">env</span> prod</span><br></pre></td></tr></table></figure><h4 id="3️⃣-TS-CREATERULE-创建自动聚合规则">3️⃣ TS.CREATERULE : 创建自动聚合规则</h4><ul class="lvl-0"><li class="lvl-2"><p>场景说明</p><ul class="lvl-2"><li class="lvl-6">原始序列：ts:cpu:server1（秒级数据）</li><li class="lvl-6">聚合目标：ts:cpu:server1:avg1m（按 1 分钟平均值聚合）</li></ul></li><li class="lvl-2"><p>语法：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TS.CREATERULE sourceKey destKey</span><br><span class="line">  AGGREGATION aggregator bucketDuration</span><br><span class="line">  [alignTimestamp]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>参数说明</p></li></ul><table><thead><tr><th>参数</th><th>作用</th><th>可选值 / 约束</th><th>是否必填</th><th>行为说明</th><th>使用注意事项</th></tr></thead><tbody><tr><td><strong>sourceKey</strong></td><td>源时间序列 Key</td><td>必须是已存在的 TS key</td><td>是</td><td>新写入数据从该序列触发聚合</td><td>必须先创建</td></tr><tr><td><strong>destKey</strong></td><td>目标聚合时间序列 Key</td><td>必须是已存在的 TS key</td><td>是</td><td>聚合结果写入该序列</td><td>通常 retention 更长</td></tr><tr><td><strong>aggregator</strong></td><td>聚合函数</td><td>见下表</td><td>是</td><td>定义每个 bucket 内如何计算</td><td>不同函数计算成本不同</td></tr><tr><td><strong>bucketDuration</strong></td><td>聚合时间桶宽度（毫秒）</td><td>&gt; 0</td><td>是</td><td>控制聚合粒度</td><td>决定数据降采样程度</td></tr><tr><td><strong>alignTimestamp</strong></td><td>对齐时间戳基准</td><td>毫秒时间戳</td><td>否</td><td>控制 bucket 起始对齐方式</td><td>跨系统对齐时非常重要</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>aggregator（聚合函数）</p></li></ul><table><thead><tr><th>聚合器</th><th>说明</th></tr></thead><tbody><tr><td><strong>AVG</strong></td><td>平均值</td></tr><tr><td><strong>SUM</strong></td><td>求和</td></tr><tr><td><strong>MIN</strong></td><td>最小值</td></tr><tr><td><strong>MAX</strong></td><td>最大值</td></tr><tr><td><strong>COUNT</strong></td><td>样本数量</td></tr><tr><td><strong>FIRST</strong></td><td>第一个样本</td></tr><tr><td><strong>LAST</strong></td><td>最后一个样本</td></tr><tr><td><strong>RANGE</strong></td><td>MAX - MIN</td></tr><tr><td><strong>STD.P</strong></td><td>总体标准差</td></tr><tr><td><strong>STD.S</strong></td><td>样本标准差</td></tr><tr><td><strong>VAR.P</strong></td><td>总体方差</td></tr><tr><td><strong>VAR.S</strong></td><td>样本方差</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>alignTimestamp（对齐时间戳基准）</p></li></ul><table><thead><tr><th>类型</th><th>示例值</th><th>含义</th></tr></thead><tbody><tr><td><strong>0（Unix Epoch）</strong>（推荐做法）</td><td><code>0</code></td><td>从 1970-01-01 00:00:00 UTC 对齐</td></tr><tr><td><strong>任意固定时间戳</strong></td><td><code>1700000000000</code></td><td>从指定时间点对齐</td></tr><tr><td><strong>当前时间戳</strong></td><td><code>$(date +%s%3N)</code></td><td>从创建规则时刻对齐</td></tr><tr><td><strong>业务时间边界</strong></td><td>某天 00:00 的毫秒值</td><td>对齐到业务周期</td></tr><tr><td><strong>不指定</strong></td><td>（参数省略）</td><td>自动使用首条写入时间</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>示例: 每 60,000ms（1分钟）做一次平均聚合</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.创建目标聚合序列</span></span><br><span class="line">TS.CREATE ts:cpu:server1:avg1m</span><br><span class="line">  RETENTION 86400000</span><br><span class="line">  LABELS host server1 metric cpu_1m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.创建自动聚合规则</span></span><br><span class="line">TS.CREATERULE ts:cpu:server1 ts:cpu:server1:avg1m</span><br><span class="line">  AGGREGATION AVG 60000</span><br><span class="line"><span class="comment">## 如果未设置 alignTimestamp，则以创建的第一条记录的时间为基准</span></span><br><span class="line"><span class="comment">## 比如第一条记录的时间为：12:00:23</span></span><br><span class="line"><span class="comment">## bucket 会对齐到:</span></span><br><span class="line">    <span class="comment"># 12:00:23 ~ 12:01:23</span></span><br><span class="line">    <span class="comment"># 12:01:23 ~ 12:02:23</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定 alignTimestamp 对齐到整分钟</span></span><br><span class="line">TS.CREATERULE ts:cpu:server1 ts:cpu:server1:avg1m</span><br><span class="line">  AGGREGATION AVG 60000 0</span><br><span class="line"><span class="comment">## bucket 会严格对齐:</span></span><br><span class="line">    <span class="comment"># 12:00:00 ~ 12:01:00</span></span><br><span class="line">    <span class="comment"># 12:01:00 ~ 12:02:00</span></span><br></pre></td></tr></table></figure><h4 id="4️⃣-TS-DELETERULE-删除自动聚合规则">4️⃣ TS.DELETERULE : 删除自动聚合规则</h4><ul class="lvl-0"><li class="lvl-2"><p>语法：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TS.DELETERULE sourceKey destKey</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>示例：删除自动聚合规则</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TS.DELETERULE ts:cpu:server1 ts:cpu:server1:avg1m</span><br></pre></td></tr></table></figure><h3 id="二、数据写入与更新类">二、数据写入与更新类</h3><table><thead><tr><th>命令</th><th>功能说明</th><th>典型使用场景</th></tr></thead><tbody><tr><td><strong>TS.ADD</strong></td><td>向时间序列追加一个样本点（timestamp, value）</td><td>实时写入监控数据</td></tr><tr><td><strong>TS.MADD</strong></td><td>批量向多个时间序列追加样本</td><td>高吞吐场景，减少网络 RTT</td></tr><tr><td><strong>TS.INCRBY</strong></td><td>对最新时间戳的值做自增（不存在则创建新样本）</td><td>计数器、累计指标</td></tr><tr><td><strong>TS.DECRBY</strong></td><td>对最新时间戳的值做自减（不存在则创建新样本）</td><td>库存、余额类递减指标</td></tr></tbody></table><h4 id="1️⃣-TS-ADD-向时间序列追加一个样本点">1️⃣ TS.ADD : 向时间序列追加一个样本点</h4><ul class="lvl-0"><li class="lvl-2"><p>语法：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">TS.ADD key timestamp value</span><br><span class="line">  [RETENTION retentionPeriod]</span><br><span class="line">  [ENCODING &lt;COMPRESSED|UNCOMPRESSED&gt;]</span><br><span class="line">  [CHUNK_SIZE size]</span><br><span class="line">  [DUPLICATE_POLICY policy]</span><br><span class="line">  [ON_DUPLICATE policy_ovr]</span><br><span class="line">  [IGNORE ignoreMaxTimediff ignoreMaxValDiff]</span><br><span class="line">  [LABELS [label value ...]]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>如果 key 不存在，TS.ADD 会 隐式创建时间序列（类似 TS.CREATE）。</p></li><li class="lvl-2"><p>参数说明</p></li></ul><table><thead><tr><th>参数</th><th>作用</th><th>可选值 / 约束</th><th>是否覆盖已有配置</th><th>生效范围</th><th>使用注意事项</th></tr></thead><tbody><tr><td><strong>key</strong></td><td>时间序列 Key</td><td>合法 Redis key</td><td>—</td><td>—</td><td>不存在时自动创建</td></tr><tr><td><strong>timestamp</strong></td><td>样本时间戳</td><td>毫秒整数 / <code>*</code></td><td>—</td><td>当前写入</td><td><code>*</code> 表示服务器当前时间</td></tr><tr><td><strong>value</strong></td><td>样本值</td><td>浮点数</td><td>—</td><td>当前写入</td><td>NaN / Inf 不允许</td></tr><tr><td><strong>RETENTION</strong></td><td>设置保留周期</td><td>≥ 0（毫秒）</td><td>仅首次创建生效</td><td>序列级</td><td>已存在 key 不会被修改</td></tr><tr><td><strong>ENCODING</strong></td><td>存储编码</td><td>COMPRESSED / UNCOMPRESSED</td><td>仅首次创建生效</td><td>序列级</td><td>生产推荐 COMPRESSED</td></tr><tr><td><strong>CHUNK_SIZE</strong></td><td>数据块大小</td><td>≥ 128 bytes</td><td>仅首次创建生效</td><td>序列级</td><td>不影响已有 chunk</td></tr><tr><td><strong>DUPLICATE_POLICY</strong></td><td>设置默认重复策略</td><td>BLOCK / FIRST / LAST / MIN / MAX / SUM</td><td>仅首次创建生效</td><td>序列级</td><td>与 ON_DUPLICATE 有优先级关系</td></tr><tr><td><strong>ON_DUPLICATE</strong></td><td>本次写入的重复策略</td><td>同上</td><td>覆盖序列级策略</td><td>当前写入</td><td>推荐用于临时覆盖</td></tr><tr><td><strong>IGNORE</strong></td><td>忽略微小变化写入</td><td>两个阈值</td><td>仅首次创建生效</td><td>序列级</td><td>用于降噪</td></tr><tr><td><strong>LABELS</strong></td><td>设置标签</td><td>键值对</td><td>仅首次创建生效</td><td>序列级</td><td>已存在 key 不会修改</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>示例：写入一个时间序列</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TS.ADD ts:cpu:server1 * 80.5</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line">(<span class="built_in">integer</span>) 1767777655255 <span class="comment"># 当前时间戳</span></span><br></pre></td></tr></table></figure><h4 id="2️⃣-TS-MADD-批量向多个时间序列追加样本">2️⃣ TS.MADD : 批量向多个时间序列追加样本</h4><ul class="lvl-0"><li class="lvl-2"><p>语法</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TS.MADD key timestamp value [key timestamp value ...]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>示例：批量写入多个时间序列</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 批量写入三个时间序列，时间序列必须存在</span></span><br><span class="line">TS.MADD ts:cpu:server1 * 80.5 ts:cpu:server2 * 90.5 ts:cpu:server3 * 70.5</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 1767777807933</span><br><span class="line">2) (<span class="built_in">integer</span>) 1767777807933</span><br><span class="line">3) (<span class="built_in">integer</span>) 1767777807933</span><br></pre></td></tr></table></figure><h4 id="3️⃣-TS-INCRBY-对最新时间戳的值做自增（不存在则创建新样本）">3️⃣ TS.INCRBY : 对最新时间戳的值做自增（不存在则创建新样本）</h4><ul class="lvl-0"><li class="lvl-2"><p>语法：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">TS.INCRBY key addend</span><br><span class="line">  [TIMESTAMP timestamp]</span><br><span class="line">  [RETENTION retentionPeriod]</span><br><span class="line">  [ENCODING &lt;COMPRESSED|UNCOMPRESSED&gt;]</span><br><span class="line">  [CHUNK_SIZE size]</span><br><span class="line">  [DUPLICATE_POLICY policy]</span><br><span class="line">  [IGNORE ignoreMaxTimediff ignoreMaxValDiff]</span><br><span class="line">  [LABELS [label value ...]]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>参数说明</p></li></ul><table><thead><tr><th>参数</th><th>作用</th><th>可选值 / 约束</th><th>是否覆盖已有配置</th><th>生效范围</th><th>使用注意事项</th></tr></thead><tbody><tr><td><strong>key</strong></td><td>时间序列 Key</td><td>合法 Redis key</td><td>—</td><td>—</td><td>不存在会自动创建</td></tr><tr><td><strong>addend</strong></td><td>增量值</td><td>浮点数</td><td>—</td><td>当前写入</td><td>支持负数（等价 DECR）</td></tr><tr><td><strong>TIMESTAMP</strong></td><td>指定写入时间戳</td><td>毫秒整数</td><td>—</td><td>当前写入</td><td>默认使用服务器时间</td></tr><tr><td><strong>RETENTION</strong></td><td>设置保留周期</td><td>≥ 0（毫秒）</td><td>仅首次创建生效</td><td>序列级</td><td>已存在 key 不生效</td></tr><tr><td><strong>ENCODING</strong></td><td>存储编码</td><td>COMPRESSED / UNCOMPRESSED</td><td>仅首次创建生效</td><td>序列级</td><td>推荐 COMPRESSED</td></tr><tr><td><strong>CHUNK_SIZE</strong></td><td>数据块大小</td><td>≥ 128 bytes</td><td>仅首次创建生效</td><td>序列级</td><td>高频写入可调大</td></tr><tr><td><strong>DUPLICATE_POLICY</strong></td><td>默认重复时间戳策略</td><td>BLOCK / FIRST / LAST / MIN / MAX / SUM</td><td>仅首次创建生效</td><td>序列级</td><td>对计数器通常设 SUM</td></tr><tr><td><strong>IGNORE</strong></td><td>忽略微小变化</td><td>两个阈值</td><td>仅首次创建生效</td><td>序列级</td><td>计数器一般不使用</td></tr><tr><td><strong>LABELS</strong></td><td>标签</td><td>键值对</td><td>仅首次创建生效</td><td>序列级</td><td>用于 MGET / MRANGE</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>如果 key 不存在，TS.INCRBY 会 隐式创建时间序列。</p></li><li class="lvl-2"><p>如果没有指定 TIMESTAMP，则自动使用服务器当前时间。</p></li><li class="lvl-2"><p>写入逻辑等价于：读取最新值 + addend → 写回一个新样本。</p></li><li class="lvl-2"><p>示例</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 对最新时间戳的值做自增</span></span><br><span class="line">TS.INCRBY ts:cpu:server1 10</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line">(<span class="built_in">integer</span>) 1767778308125</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定时间戳，TIMESTAMP 必须大于或等于当前时间序列中最大的时间戳</span></span><br><span class="line">TS.INCRBY ts:cpu:server1 5 TIMESTAMP 1767778308126</span><br></pre></td></tr></table></figure><h4 id="4️⃣-TS-DECRBY-对最新时间戳的值做自减（不存在则创建新样本）">4️⃣ TS.DECRBY : 对最新时间戳的值做自减（不存在则创建新样本）</h4><ul class="lvl-0"><li class="lvl-2"><p>与 <code>TS.INCRBY</code> 相似，不再赘述。</p></li><li class="lvl-2"><p>实际上 <code>TS.INCRBY</code> 中设置 <code>addend</code> 为负数 就是 <code>TS.DECR</code></p></li></ul><h3 id="三、数据查询（单序列）类">三、数据查询（单序列）类</h3><table><thead><tr><th>命令</th><th>功能说明</th><th>典型使用场景</th></tr></thead><tbody><tr><td><strong>TS.GET</strong></td><td>获取某个时间序列最新（最大 timestamp）的样本</td><td>获取当前最新指标值</td></tr><tr><td><strong>TS.RANGE</strong></td><td>按时间正序查询一个时间序列的区间数据</td><td>绘图、趋势分析</td></tr><tr><td><strong>TS.REVRANGE</strong></td><td>按时间逆序查询一个时间序列的区间数据</td><td>获取最近 N 条数据</td></tr></tbody></table><h4 id="1️⃣-TS-GET-获取某个时间序列最新（最大-timestamp）的样本">1️⃣ TS.GET : 获取某个时间序列最新（最大 timestamp）的样本</h4><ul class="lvl-0"><li class="lvl-2"><p>语法：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TS.GET key [LATEST]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>参数说明：</p></li></ul><table><thead><tr><th>参数</th><th>作用</th></tr></thead><tbody><tr><td><strong>key</strong></td><td>时间序列 Key</td></tr><tr><td><strong>LATEST</strong></td><td>获取最新样本</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>LATEST 说明</p><ul class="lvl-2"><li class="lvl-6">当一个时间序列是经过聚合（compaction）处理的时，LATEST 参数会生效。使用 LATEST 时，TS.GET 会返回最新（可能是部分的）桶的聚合值。不使用 LATEST 时，TS.GET 不会返回最新（可能是部分的）桶的值。当时间序列不是聚合的时，LATEST 会被忽略。</li><li class="lvl-6">最新桶中的数据可能是不完整的。只有当有新的样本到来并开启一个新的最新桶时，原桶才会被关闭并进行聚合。然而，在某些情况下，也需要获取最新（可能是部分的）桶的聚合值，此时就可以使用 LATEST。</li></ul></li><li class="lvl-2"><p>示例：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TS.GET ts:cpu:server1 LATEST</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 1767778308126</span><br><span class="line">2) 115.5</span><br></pre></td></tr></table></figure><h4 id="2️⃣-TS-RANGE-按时间正序查询一个时间序列的区间数据">2️⃣ TS.RANGE : 按时间正序查询一个时间序列的区间数据</h4><ul class="lvl-0"><li class="lvl-2"><p>语法：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">TS.RANGE key fromTimestamp toTimestamp</span><br><span class="line">  [LATEST]</span><br><span class="line">  [FILTER_BY_TS ts...]</span><br><span class="line">  [FILTER_BY_VALUE min max]</span><br><span class="line">  [COUNT count]</span><br><span class="line">  [[ALIGN align] AGGREGATION aggregator bucketDuration [BUCKETTIMESTAMP bt] [EMPTY]]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>参数说明：</p></li></ul><table><thead><tr><th>参数</th><th>类型</th><th>说明</th><th>可选值 / 说明</th></tr></thead><tbody><tr><td><code>key</code></td><td>string</td><td>时间序列的键名</td><td>必选</td></tr><tr><td><code>fromTimestamp</code></td><td>integer</td><td>查询起始时间戳，<code>-</code>: 最小值</td><td>必选</td></tr><tr><td><code>toTimestamp</code></td><td>integer</td><td>查询结束时间戳 ，<code>+</code>: 最大值</td><td>必选</td></tr><tr><td><code>LATEST</code></td><td>flag</td><td>当时间序列是 compaction 时，返回最新（可能部分）的桶的聚合值</td><td>可选</td></tr><tr><td><code>FILTER_BY_TS ts...</code></td><td>list of integers</td><td>只返回指定时间戳的样本</td><td>可选</td></tr><tr><td><code>FILTER_BY_VALUE min max</code></td><td>range</td><td>只返回值在 <code>[min, max]</code> 区间的样本</td><td>可选</td></tr><tr><td><code>COUNT count</code></td><td>integer</td><td>限制返回的样本数量（最多 <code>count</code> 个）</td><td>可选</td></tr><tr><td><code>ALIGN align</code></td><td>string</td><td>对齐聚合桶的时间戳（如 <code>start</code>、<code>end</code>、自定义时间戳）</td><td>可选，需与 <code>AGGREGATION</code> 一起使用</td></tr><tr><td><code>AGGREGATION aggregator bucketDuration</code></td><td>aggregation</td><td>对数据进行聚合计算，<code>aggregator</code> 为聚合函数（如 <code>avg</code>, <code>sum</code>, <code>min</code>, <code>max</code> 等），<code>bucketDuration</code> 为桶的时长</td><td>可选</td></tr><tr><td><code>BUCKETTIMESTAMP bt</code></td><td>string</td><td>聚合桶时间戳选择，<code>bt</code> 可为 <code>start</code> 或 <code>end</code></td><td>可选</td></tr><tr><td><code>EMPTY</code></td><td>flag</td><td>即使桶为空也返回结果</td><td>可选</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>示例：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询时间序列 ts:cpu:server1 的区间数据</span></span><br><span class="line">TS.RANGE ts:cpu:server1 0 1767778308126</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line">1) 1) (<span class="built_in">integer</span>) 1767777655255</span><br><span class="line">   2) 80.5</span><br><span class="line">2) 1) (<span class="built_in">integer</span>) 1767777807933</span><br><span class="line">   2) 70.5</span><br><span class="line">3) 1) (<span class="built_in">integer</span>) 1767777873866</span><br><span class="line">   2) 80.5</span><br><span class="line">4) 1) (<span class="built_in">integer</span>) 1767777965870</span><br><span class="line">   2) 80.5</span><br><span class="line">5) 1) (<span class="built_in">integer</span>) 1767778300909</span><br><span class="line">   2) 90.5</span><br><span class="line">6) 1) (<span class="built_in">integer</span>) 1767778308125</span><br><span class="line">   2) 105.5</span><br><span class="line">7) 1) (<span class="built_in">integer</span>) 1767778308126</span><br><span class="line">   2) 115.5</span><br><span class="line"><span class="comment"># 查询时间序列 ts:cpu:server1 的区间数据，并返回聚合结果，求1000ms内平均值</span></span><br><span class="line">TS.RANGE ts:cpu:server1 - + AGGREGATION avg 1000</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line">1) 1) (<span class="built_in">integer</span>) 1767777655000</span><br><span class="line">   2) 80.5</span><br><span class="line">2) 1) (<span class="built_in">integer</span>) 1767777807000</span><br><span class="line">   2) 70.5</span><br><span class="line">3) 1) (<span class="built_in">integer</span>) 1767777873000</span><br><span class="line">   2) 80.5</span><br><span class="line">4) 1) (<span class="built_in">integer</span>) 1767777965000</span><br><span class="line">   2) 80.5</span><br><span class="line">5) 1) (<span class="built_in">integer</span>) 1767778300000</span><br><span class="line">   2) 90.5</span><br><span class="line">6) 1) (<span class="built_in">integer</span>) 1767778308000</span><br><span class="line">   2) 110.5</span><br></pre></td></tr></table></figure><h4 id="3️⃣-TS-REVRANGE-按时间逆序查询一个时间序列的区间数据">3️⃣ TS.REVRANGE : 按时间逆序查询一个时间序列的区间数据</h4><ul class="lvl-0"><li class="lvl-2"><p>与 TS.RANGE 类似，只是返回结果是倒序的</p></li><li class="lvl-2"><p>示例</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">TS.REVRANGE ts:cpu:server1 0 1767778308126</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line">1) 1) (<span class="built_in">integer</span>) 1767778308126</span><br><span class="line">   2) 115.5</span><br><span class="line">2) 1) (<span class="built_in">integer</span>) 1767778308125</span><br><span class="line">   2) 105.5</span><br><span class="line">3) 1) (<span class="built_in">integer</span>) 1767778300909</span><br><span class="line">   2) 90.5</span><br><span class="line">4) 1) (<span class="built_in">integer</span>) 1767777965870</span><br><span class="line">   2) 80.5</span><br><span class="line">5) 1) (<span class="built_in">integer</span>) 1767777873866</span><br><span class="line">   2) 80.5</span><br><span class="line">6) 1) (<span class="built_in">integer</span>) 1767777807933</span><br><span class="line">   2) 70.5</span><br><span class="line">7) 1) (<span class="built_in">integer</span>) 1767777655255</span><br><span class="line">   2) 80.5</span><br></pre></td></tr></table></figure><h3 id="四、数据查询（多序列-聚合）类">四、数据查询（多序列 / 聚合）类</h3><table><thead><tr><th>命令</th><th>功能说明</th><th>典型使用场景</th></tr></thead><tbody><tr><td><strong>TS.MGET</strong></td><td>根据标签过滤，获取多个时间序列的最新值</td><td>批量获取多个实例的当前指标</td></tr><tr><td><strong>TS.MRANGE</strong></td><td>按标签过滤，正序查询多个时间序列的区间数据</td><td>多维指标分析、聚合</td></tr><tr><td><strong>TS.MREVRANGE</strong></td><td>按标签过滤，逆序查询多个时间序列的区间数据</td><td>最近数据聚合分析</td></tr><tr><td><strong>TS.QUERYINDEX</strong></td><td>根据标签过滤，返回匹配的时间序列 key 列表</td><td>发现有哪些指标符合条件</td></tr></tbody></table><h4 id="1️⃣-TS-MGET-根据标签过滤，获取多个时间序列的最新值">1️⃣ TS.MGET : 根据标签过滤，获取多个时间序列的最新值</h4><ul class="lvl-0"><li class="lvl-2"><p>语法：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TS.MGET [LATEST] [WITHLABELS | &lt;SELECTED_LABELS label...&gt;] FILTER filterExpr...</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>参数说明：</p></li></ul><table><thead><tr><th>参数</th><th>类型</th><th>说明</th><th>可选值 / 说明</th></tr></thead><tbody><tr><td><code>LATEST</code></td><td>flag</td><td>对 compaction 类型的时间序列，返回最新（可能部分）的样本值</td><td>可选</td></tr><tr><td><code>WITHLABELS</code></td><td>flag</td><td>返回样本的同时附带时间序列的所有标签</td><td>可选</td></tr><tr><td><code>&lt;SELECTED_LABELS label...&gt;</code></td><td>list</td><td>返回样本时只附带指定标签</td><td>可选，不能与 <code>WITHLABELS</code> 一起使用</td></tr><tr><td><code>FILTER filterExpr...</code></td><td>list of expressions</td><td>过滤时间序列，根据标签匹配规则筛选出符合条件的序列</td><td>必选，支持标签匹配表达式，如 <code>sensor=temperature</code> 或 <code>region=*</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>示例：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取所有时间序列的最新值，根据标签过滤</span></span><br><span class="line">TS.MGET WITHLABELS FILTER metric=cpu</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line">1) 1) <span class="string">&quot;ts:cpu:server1&quot;</span></span><br><span class="line">   2) 1) 1) <span class="string">&quot;host&quot;</span></span><br><span class="line">         2) <span class="string">&quot;server1&quot;</span></span><br><span class="line">      2) 1) <span class="string">&quot;metric&quot;</span></span><br><span class="line">         2) <span class="string">&quot;cpu&quot;</span></span><br><span class="line">      3) 1) <span class="string">&quot;env&quot;</span></span><br><span class="line">         2) <span class="string">&quot;prod&quot;</span></span><br><span class="line">   3) 1) (<span class="built_in">integer</span>) 1767778308126</span><br><span class="line">      2) 115.5</span><br><span class="line">2) 1) <span class="string">&quot;ts:cpu:server2&quot;</span></span><br><span class="line">   2) 1) 1) <span class="string">&quot;host&quot;</span></span><br><span class="line">         2) <span class="string">&quot;server1&quot;</span></span><br><span class="line">      2) 1) <span class="string">&quot;metric&quot;</span></span><br><span class="line">         2) <span class="string">&quot;cpu&quot;</span></span><br><span class="line">   3) 1) (<span class="built_in">integer</span>) 1767777965870</span><br><span class="line">      2) 90.5</span><br><span class="line">3) 1) <span class="string">&quot;ts:cpu:server3&quot;</span></span><br><span class="line">   2) 1) 1) <span class="string">&quot;host&quot;</span></span><br><span class="line">         2) <span class="string">&quot;server1&quot;</span></span><br><span class="line">      2) 1) <span class="string">&quot;metric&quot;</span></span><br><span class="line">         2) <span class="string">&quot;cpu&quot;</span></span><br><span class="line">   3) 1) (<span class="built_in">integer</span>) 1767777965870</span><br><span class="line">      2) 70.5</span><br></pre></td></tr></table></figure><h4 id="2️⃣-TS-MRANGE-按标签过滤，正序查询多个时间序列的区间数据">2️⃣ TS.MRANGE : 按标签过滤，正序查询多个时间序列的区间数据</h4><ul class="lvl-0"><li class="lvl-2"><p>语法：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">TS.MRANGE fromTimestamp toTimestamp</span><br><span class="line">  [LATEST]</span><br><span class="line">  [FILTER_BY_TS ts...]</span><br><span class="line">  [FILTER_BY_VALUE min max]</span><br><span class="line">  [WITHLABELS | &lt;SELECTED_LABELS label...&gt;]</span><br><span class="line">  [COUNT count]</span><br><span class="line">  [[ALIGN align] AGGREGATION aggregator bucketDuration [BUCKETTIMESTAMP bt] [EMPTY]]</span><br><span class="line">  FILTER filterExpr...</span><br><span class="line">  [GROUPBY label REDUCE reducer]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>参数说明：</p></li></ul><table><thead><tr><th>参数</th><th>类型</th><th>说明</th><th>可选值 / 说明</th></tr></thead><tbody><tr><td><code>fromTimestamp</code></td><td>integer</td><td>查询起始时间戳，<code>-</code>: 最小值</td><td>必选</td></tr><tr><td><code>toTimestamp</code></td><td>integer</td><td>查询结束时间戳，<code>+</code>: 最大值</td><td>必选</td></tr><tr><td><code>LATEST</code></td><td>flag</td><td>对 compaction 类型的时间序列，返回最新（可能部分）的桶的聚合值</td><td>可选</td></tr><tr><td><code>FILTER_BY_TS ts...</code></td><td>list of integers</td><td>只返回指定时间戳的样本</td><td>可选</td></tr><tr><td><code>FILTER_BY_VALUE min max</code></td><td>range</td><td>只返回值在 <code>[min, max]</code> 区间的样本</td><td>可选</td></tr><tr><td><code>WITHLABELS</code></td><td>flag</td><td>返回样本的同时附带时间序列的所有标签</td><td>可选</td></tr><tr><td><code>&lt;SELECTED_LABELS label...&gt;</code></td><td>list</td><td>返回样本时只附带指定标签</td><td>可选，不能与 <code>WITHLABELS</code> 一起使用</td></tr><tr><td><code>COUNT count</code></td><td>integer</td><td>限制返回的样本数量（最多 <code>count</code> 个）</td><td>可选</td></tr><tr><td><code>ALIGN align</code></td><td>string</td><td>对齐聚合桶的时间戳（如 <code>start</code>、<code>end</code> 或自定义时间戳）</td><td>可选，需与 <code>AGGREGATION</code> 一起使用</td></tr><tr><td><code>AGGREGATION aggregator bucketDuration</code></td><td>aggregation</td><td>对数据进行聚合计算，<code>aggregator</code> 为聚合函数（如 <code>avg</code>, <code>sum</code>, <code>min</code>, <code>max</code> 等），<code>bucketDuration</code> 为桶的时长</td><td>可选</td></tr><tr><td><code>BUCKETTIMESTAMP bt</code></td><td>string</td><td>聚合桶时间戳选择，<code>bt</code> 可为 <code>start</code> 或 <code>end</code></td><td>可选</td></tr><tr><td><code>EMPTY</code></td><td>flag</td><td>即使桶为空也返回结果</td><td>可选</td></tr><tr><td><code>FILTER filterExpr...</code></td><td>list of expressions</td><td>过滤时间序列，根据标签匹配规则筛选出符合条件的序列</td><td>必选</td></tr><tr><td><code>GROUPBY label REDUCE reducer</code></td><td>aggregation</td><td>对返回结果按指定标签分组并应用 reducer 聚合函数（如 <code>SUM</code>, <code>MIN</code>, <code>MAX</code> 等）</td><td>可选</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>示例：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">TS.MRANGE - + FILTER metric=cpu</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line">1) 1) <span class="string">&quot;ts:cpu:server1&quot;</span></span><br><span class="line">   2) (empty array)</span><br><span class="line">   3) 1) 1) (<span class="built_in">integer</span>) 1767777655255</span><br><span class="line">         2) 80.5</span><br><span class="line">      2) 1) (<span class="built_in">integer</span>) 1767777807933</span><br><span class="line">         2) 70.5</span><br><span class="line">      3) 1) (<span class="built_in">integer</span>) 1767777873866</span><br><span class="line">         2) 80.5</span><br><span class="line">      4) 1) (<span class="built_in">integer</span>) 1767777965870</span><br><span class="line">         2) 80.5</span><br><span class="line">      5) 1) (<span class="built_in">integer</span>) 1767778300909</span><br><span class="line">         2) 90.5</span><br><span class="line">      6) 1) (<span class="built_in">integer</span>) 1767778308125</span><br><span class="line">         2) 105.5</span><br><span class="line">      7) 1) (<span class="built_in">integer</span>) 1767778308126</span><br><span class="line">         2) 115.5</span><br><span class="line">2) 1) <span class="string">&quot;ts:cpu:server2&quot;</span></span><br><span class="line">   2) (empty array)</span><br><span class="line">   3) 1) 1) (<span class="built_in">integer</span>) 1767777965870</span><br><span class="line">         2) 90.5</span><br><span class="line">3) 1) <span class="string">&quot;ts:cpu:server3&quot;</span></span><br><span class="line">   2) (empty array)</span><br><span class="line">   3) 1) 1) (<span class="built_in">integer</span>) 1767777965870</span><br><span class="line">         2) 70.5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按标签聚合</span></span><br><span class="line">TS.MRANGE - +</span><br><span class="line">    AGGREGATION avg 1000</span><br><span class="line">    FILTER metric=cpu</span><br><span class="line">    GROUPBY host REDUCE avg</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line">1) 1) <span class="string">&quot;host=server1&quot;</span></span><br><span class="line">   2) (empty array)</span><br><span class="line">   3) 1) 1) (<span class="built_in">integer</span>) 1767777655000</span><br><span class="line">         2) 80.5</span><br><span class="line">      2) 1) (<span class="built_in">integer</span>) 1767777807000</span><br><span class="line">         2) 70.5</span><br><span class="line">      3) 1) (<span class="built_in">integer</span>) 1767777873000</span><br><span class="line">         2) 80.5</span><br><span class="line">      4) 1) (<span class="built_in">integer</span>) 1767777965000</span><br><span class="line">         2) 80.5</span><br><span class="line">      5) 1) (<span class="built_in">integer</span>) 1767778300000</span><br><span class="line">         2) 90.5</span><br><span class="line">      6) 1) (<span class="built_in">integer</span>) 1767778308000</span><br><span class="line">         2) 110.5</span><br></pre></td></tr></table></figure><h4 id="3️⃣-TS-MREVRANGE-按标签过滤，逆序查询多个时间序列的区间数据">3️⃣ TS.MREVRANGE : 按标签过滤，逆序查询多个时间序列的区间数据</h4><ul class="lvl-0"><li class="lvl-2"><p>与 TS.MRANGE 类似，只是查询结果是逆序的</p></li></ul><h4 id="4️⃣-TS-QUERYINDEX-根据标签过滤，返回匹配的时间序列-key-列表">4️⃣ TS.QUERYINDEX : 根据标签过滤，返回匹配的时间序列 key 列表</h4><ul class="lvl-0"><li class="lvl-2"><p>语法：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">S.QUERYINDEX filterExpr...</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>示例：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TS.QUERYINDEX metric=cpu host=server1</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line">1) <span class="string">&quot;ts:cpu:server1&quot;</span></span><br><span class="line">2) <span class="string">&quot;ts:cpu:server2&quot;</span></span><br><span class="line">3) <span class="string">&quot;ts:cpu:server3&quot;</span></span><br></pre></td></tr></table></figure><h3 id="五、数据删除与维护类">五、数据删除与维护类</h3><table><thead><tr><th>命令</th><th>功能说明</th><th>典型使用场景</th></tr></thead><tbody><tr><td><strong>TS.DEL</strong></td><td>删除某个时间序列在指定时间范围内的样本</td><td>清理异常数据、历史数据修正</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>语法</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TS.DEL key fromTimestamp toTimestamp</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>示例：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TS.DEL ts:cpu:server1 0 1767777965870</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line">(<span class="built_in">integer</span>) 4 <span class="comment"># 删除了 4 个样本</span></span><br></pre></td></tr></table></figure><h3 id="六、元数据与状态查询类">六、元数据与状态查询类</h3><table><thead><tr><th>命令</th><th>功能说明</th><th>典型使用场景</th></tr></thead><tbody><tr><td><strong><a href="http://TS.INFO">TS.INFO</a></strong></td><td>返回时间序列的元信息与统计信息</td><td>排查问题、容量评估、监控状态</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>语法</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TS.INFO key [DEBUG]</span><br><span class="line"><span class="comment"># DEBUG: 显示更为详细的信息</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>示例：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">TS.INFO ts:cpu:server1</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line">1) totalSamples</span><br><span class="line"> 2) (<span class="built_in">integer</span>) 3</span><br><span class="line"> 3) memoryUsage</span><br><span class="line"> 4) (<span class="built_in">integer</span>) 9184</span><br><span class="line"> 5) firstTimestamp</span><br><span class="line"> 6) (<span class="built_in">integer</span>) 1767778300909</span><br><span class="line"> 7) lastTimestamp</span><br><span class="line"> 8) (<span class="built_in">integer</span>) 1767778308126</span><br><span class="line"> 9) retentionTime</span><br><span class="line">10) (<span class="built_in">integer</span>) 7200000</span><br><span class="line">11) chunkCount</span><br><span class="line">12) (<span class="built_in">integer</span>) 1</span><br><span class="line">13) chunkSize</span><br><span class="line">14) (<span class="built_in">integer</span>) 8192</span><br><span class="line">15) chunkType</span><br><span class="line">16) compressed</span><br><span class="line">17) duplicatePolicy</span><br><span class="line">18) last</span><br><span class="line">19) labels</span><br><span class="line">20) 1) 1) <span class="string">&quot;host&quot;</span></span><br><span class="line">       2) <span class="string">&quot;server1&quot;</span></span><br><span class="line">    2) 1) <span class="string">&quot;metric&quot;</span></span><br><span class="line">       2) <span class="string">&quot;cpu&quot;</span></span><br><span class="line">    3) 1) <span class="string">&quot;env&quot;</span></span><br><span class="line">       2) <span class="string">&quot;prod&quot;</span></span><br><span class="line">21) sourceKey</span><br><span class="line">22) (nil)</span><br><span class="line">23) rules</span><br><span class="line">24) (empty array)</span><br><span class="line">25) ignoreMaxTimeDiff</span><br><span class="line">26) (<span class="built_in">integer</span>) 1000</span><br><span class="line">27) ignoreMaxValDiff</span><br><span class="line">28) <span class="string">&quot;0.1&quot;</span></span><br></pre></td></tr></table></figure><h2 id="真实案例">真实案例</h2><h3 id="场景说明">场景说明</h3><ul class="lvl-0"><li class="lvl-2"><p>假设我们有一个 IoT 设备监控系统，每台设备每分钟会上报一次温度和湿度数据。我们希望：</p><ul class="lvl-2"><li class="lvl-6">存储每台设备的时间序列数据。</li><li class="lvl-6">查询最近一小时的数据。</li><li class="lvl-6">统计每 5 分钟的平均温度和湿度。</li><li class="lvl-6">获取最新的温度值。</li></ul></li></ul><h3 id="步骤">步骤</h3><ul class="lvl-0"><li class="lvl-2"><ol><li class="lvl-5">创建时间序列</li></ol></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建设备 device:1001 的温度时间序列</span></span><br><span class="line">TS.CREATE device:1001:temperature RETENTION 86400000 LABELS device_id 1001 <span class="built_in">type</span> temperature</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建设备 device:1001 的湿度时间序列</span></span><br><span class="line">TS.CREATE device:1001:humidity RETENTION 86400000 LABELS device_id 1001 <span class="built_in">type</span> humidity</span><br><span class="line"></span><br><span class="line"><span class="comment">## 说明：</span></span><br><span class="line">    <span class="comment"># RETENTION 86400000：数据保留 24 小时（单位毫秒）。</span></span><br><span class="line">    <span class="comment"># LABELS：方便后续按标签聚合查询。</span></span><br><span class="line">    <span class="comment"># TS.CREATE 用于创建时间序列 key。</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><ol start="2"><li class="lvl-5">插入数据</li></ol></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 假设时间戳为当前毫秒</span></span><br><span class="line">TS.ADD device:1001:temperature * 26.5</span><br><span class="line">TS.ADD device:1001:humidity * 60.2</span><br><span class="line"><span class="comment"># 此处假设会每分钟插入一次数据</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><ol start="3"><li class="lvl-5">查询时间范围数据</li></ol></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取 过去一小时的温度数据：</span></span><br><span class="line"><span class="comment"># 过去一小时的时间戳可以这样获得</span></span><br><span class="line">EVAL <span class="string">&quot;return redis.call(&#x27;TIME&#x27;)[1]*1000 - 3600000&quot;</span> 0</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line">(<span class="built_in">integer</span>) 1767777794000</span><br><span class="line"></span><br><span class="line">TS.RANGE device:1001:temperature 1767777794000 +</span><br><span class="line"><span class="comment">## 说明</span></span><br><span class="line">    <span class="comment"># -3600000 表示一小时前。</span></span><br><span class="line">    <span class="comment"># + 表示到现在。</span></span><br><span class="line">    <span class="comment"># 返回结果为 [timestamp, value] 数组。</span></span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line">1) 1) (<span class="built_in">integer</span>) 1767781256846</span><br><span class="line">   2) 26.5</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><ol start="4"><li class="lvl-5">聚合查询（Downsampling）</li></ol></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 统计 每 5 分钟平均温度：</span></span><br><span class="line">TS.RANGE device:1001:temperature 1767777794000 + AGGREGATION avg 300000</span><br><span class="line"><span class="comment"># 说明：</span></span><br><span class="line">    <span class="comment"># AGGREGATION avg 300000 表示每 300,000 ms（5 分钟）聚合一次。</span></span><br><span class="line">    <span class="comment"># RedisTimeSeries 支持多种聚合函数：avg, sum, min, max, count。</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><ol start="5"><li class="lvl-5">获取最新值</li></ol></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取最新的温度值：</span></span><br><span class="line">TS.GET device:1001:temperature</span><br><span class="line"><span class="comment"># 说明</span></span><br><span class="line">    <span class="comment"># TS.GET 会返回最新一个数据点 [timestamp, value]。</span></span><br><span class="line">    <span class="comment"># 如果使用了压缩策略 LATEST，返回的值可能是当前聚合桶的值。</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><ol start="6"><li class="lvl-5">按标签查询</li></ol></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果我们想获取 所有设备的温度平均值（假设有很多设备）：</span></span><br><span class="line">TS.MRANGE - + AGGREGATION avg 300000 FILTER <span class="built_in">type</span>=temperature</span><br><span class="line"><span class="comment"># 说明：</span></span><br><span class="line">    <span class="comment"># TS.MRANGE 支持多 key 查询，并且可以按标签过滤。</span></span><br><span class="line">    <span class="comment"># 聚合函数可以对每个匹配 key 单独计算。</span></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">1) 1) <span class="string">&quot;device:1001:temperature&quot;</span></span><br><span class="line">   2) (empty array)</span><br><span class="line">   3) 1) 1) (<span class="built_in">integer</span>) 1767781200000</span><br><span class="line">         2) 26.5</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文介绍 Redis 扩展模块 – RedisTimeSeries 中 TimeSeries 数据类型&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文基于&lt;code&gt;redis-7.4.7&lt;/code&gt;，&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;操作系统：&lt;code&gt;Amazon Linux 2023(内核 6.1)&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis官网：&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis 命令文档：&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;RedisTimeSeries 的安装参见 &lt;a href=&quot;/2026/01/07/redis7-module-RedisTimeSeries/&quot; title=&quot;Redis 扩展模块 -- RedisTimeSeries 的安装方法&quot;&gt;Redis 扩展模块 -- RedisTimeSeries 的安装方法&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis 扩展模块 -- RedisTimeSeries 的安装方法</title>
    <link href="https://blog.hanqunfeng.com/2026/01/07/redis7-module-RedisTimeSeries/"/>
    <id>https://blog.hanqunfeng.com/2026/01/07/redis7-module-RedisTimeSeries/</id>
    <published>2026-01-07T13:30:05.000Z</published>
    <updated>2026-01-07T06:46:17.065Z</updated>
    
    <content type="html"><![CDATA[<h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2">本文介绍 Redis 扩展模块 – RedisTimeSeries 的安装方法</li><li class="lvl-2">本文基于<code>redis-7.4.7</code>，<code>springboot-3.5.8</code></li><li class="lvl-2">操作系统：<code>Amazon Linux 2023(内核 6.1)</code></li><li class="lvl-2">Redis官网：<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis 命令文档：<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li></ul><span id="more"></span><h2 id="RedisTimeSeries-简介">RedisTimeSeries 简介</h2><ul class="lvl-0"><li class="lvl-2"><p><a href="https://github.com/RedisTimeSeries/RedisTimeSeries">RedisTimeSeries</a> 是 Redis 官方提供的一个 时序数据模块（Time Series Module），用于高效地存储、查询和分析时间序列数据。它可以作为 Redis 的一个模块加载使用（在 Redis Stack 中内置支持），将时序数据建模、存储和聚合能力扩展到 Redis 之外。</p></li><li class="lvl-2"><p>该模块以 <code>Redis Module</code> 方式加载，可无缝集成到现有 Redis 实例中。</p></li><li class="lvl-2"><p>Redis8+，RedisTimeSeries 已经内置在 Redis 中，可以在安装redis同时安装全部 Stack 模块。</p></li></ul><h2 id="安装-RedisTimeSeries">安装 RedisTimeSeries</h2><ul class="lvl-0"><li class="lvl-2"><p>虽然<a href="https://cloud.redis.io">Redis Cloud</a>的<code>Download Center</code>中提供了所有Redis模块编译后的<code>.so</code>文件，但是并不保证一定兼容，所以最稳妥的方式是通过源码自己编译。</p></li></ul><blockquote><p>安装时需要科学上网，主要是安装依赖时需要从海外网下载，如果要部署在国内服务器，可能会连接失败。<br>可以在海外的<code>相同配置</code>的服务器上进行编译，之后将编译好的<code>redistimeseries.so</code>上传到国内服务器即可。</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>安装依赖</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dnf install -y \</span><br><span class="line">  gcc \</span><br><span class="line">  gcc-c++ \</span><br><span class="line">  make \</span><br><span class="line">  cmake \</span><br><span class="line">  autoconf \</span><br><span class="line">  automake \</span><br><span class="line">  libtool \</span><br><span class="line">  pkgconfig \</span><br><span class="line">  openssl-devel</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>编译 RedisTimeSeries</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /usr/local/soft/modules/</span><br><span class="line"><span class="built_in">cd</span> /usr/local/soft/modules</span><br><span class="line"><span class="comment"># clone 代码，这里 --recursive 是为了拉取子模块</span></span><br><span class="line">git <span class="built_in">clone</span> --recursive https://github.com/RedisTimeSeries/RedisTimeSeries.git</span><br><span class="line"><span class="built_in">cd</span> RedisTimeSeries</span><br><span class="line"><span class="comment"># 推荐切换到稳定的release版本</span></span><br><span class="line">git checkout v1.12.9</span><br><span class="line"><span class="comment"># 更新子模块，非必须，如果上面 clone 时没有加上 --recursive ，这个步骤就不能省略</span></span><br><span class="line">git submodule update --init --recursive</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查并安装需要的依赖</span></span><br><span class="line">./sbin/setup</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line"><span class="comment"># readies version: af92230</span></span><br><span class="line">dnf install -q -y ca-certificates</span><br><span class="line">dnf install -q -y wget unzip</span><br><span class="line">dnf install -q -y git jq</span><br><span class="line">/usr/local/soft/modules/RedisTimeSeries/deps/readies/bin/enable-utf8</span><br><span class="line">dnf install -q -y autoconf libtool m4 automake</span><br><span class="line">dnf install -q -y openssl</span><br><span class="line">dnf install -q -y <span class="built_in">which</span></span><br><span class="line">/usr/local/soft/modules/RedisTimeSeries/deps/readies/bin/getepel</span><br><span class="line">dnf install -q -y openssl-devel</span><br><span class="line">/usr/local/soft/modules/RedisTimeSeries/deps/readies/bin/getgcc --modern</span><br><span class="line">dnf install -q -y valgrind</span><br><span class="line">/usr/bin/python3 /usr/local/soft/modules/RedisTimeSeries/deps/readies/bin/getcmake --usr</span><br><span class="line">dnf install -q -y lcov</span><br><span class="line">/usr/local/soft/modules/RedisTimeSeries/deps/readies/bin/getaws</span><br><span class="line">/usr/bin/python3 /usr/local/soft/modules/RedisTimeSeries/deps/readies/bin/getrmpytools --reinstall --modern</span><br><span class="line">/usr/bin/python3 -m pip install --disable-pip-version-check --user  -r /usr/local/soft/modules/RedisTimeSeries/tests/flow/requirements.txt</span><br><span class="line">NO_PY2=1 /usr/local/soft/modules/RedisTimeSeries/deps/readies/bin/getpudb</span><br><span class="line">amazon_linux_2023</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译 RedisTimeSeries</span></span><br><span class="line">make</span><br><span class="line"><span class="comment"># 编译过程未报错说明编译成功，编译后的文件位于 `bin/linux-x64-release/redistimeseries.so`</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><div class="tips"><p><em><strong><code>./sbin/setup</code> 报错</strong></em></p><ul class="lvl-1"><li class="lvl-2">本人使用的是 Amazon Linux 2023(内核 6.1)，即 <code>EL9</code>，类似于CentOS 9，第一次运行会报错，大致报错信息如下：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">./sbin/setup</span><br><span class="line"><span class="comment">## 错误信息</span></span><br><span class="line">……</span><br><span class="line">Status code: 403 <span class="keyword">for</span> https://dyn.su/el9/base/x86_64/raven-release.el9.noarch.rpm (IP: 172.67.157.246)</span><br><span class="line"></span><br><span class="line">In /usr/local/soft/modules/RedisTimeSeries/deps/readies/bin/getepel:</span><br><span class="line">346      <span class="comment"># xinstall --allowerasing https://dl.fedoraproject.org/pub/epel/epel-release-latest-$&#123;EPEL&#125;.noarch.rpm</span></span><br><span class="line">347      <span class="keyword">fi</span></span><br><span class="line">348</span><br><span class="line">349  &gt;&gt;&gt; install_raven</span><br><span class="line">350      install_remi</span><br><span class="line">351      <span class="comment"># install_centos_stream_repos</span></span><br><span class="line">352</span><br><span class="line"></span><br><span class="line"><span class="built_in">command</span> failed: /usr/local/soft/modules/RedisTimeSeries/deps/readies/bin/getepel</span><br><span class="line"></span><br><span class="line">In /usr/local/soft/modules/RedisTimeSeries/sbin/setup:</span><br><span class="line">18       python3 -m pip list</span><br><span class="line">19       <span class="keyword">fi</span></span><br><span class="line">20</span><br><span class="line">21   &gt;&gt;&gt; <span class="variable">$ROOT</span>/sbin/system-setup.py <span class="variable">$SETUP_ARGS</span></span><br><span class="line">22       <span class="keyword">if</span> [[ <span class="variable">$VERBOSE</span> == 1 ]]; <span class="keyword">then</span></span><br><span class="line">23       python3 -m pip list</span><br><span class="line">24       <span class="keyword">fi</span></span><br></pre></td></tr></table></figure><ul class="lvl-1"><li class="lvl-2">错误分析与解决方法：<ul class="lvl-3"><li class="lvl-6">这个错误与安装 RedisBloom 时一样，禁用掉 <code>install_raven</code> 即可，具体参见 <a href="/2025/12/21/redis7-module-RedisBloom/" title="Redis 扩展模块 -- RedisBloom 的安装方法">Redis 扩展模块 -- RedisBloom 的安装方法</a> 进行修改。</li></ul></li></ul></div><h2 id="Redis-启用模块">Redis 启用模块</h2><ul class="lvl-0"><li class="lvl-2"><p>将生成的 <code>redistimeseries.so</code> 拷贝到 redis 的 modules 目录下（非必须），目录不存在则创建</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意 .so 文件需要包含可执行权限</span></span><br><span class="line"><span class="built_in">cp</span> bin/linux-x64-release/redistimeseries.so /usr/local/soft/redis-7.4.7/modules/redistimeseries.so</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>本文采用 <code>loadmodule</code> 加载模块</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 redistimeseries.so 添加到 redis.conf 中，需要重启 redis</span></span><br><span class="line">loadmodule /usr/local/soft/redis-7.4.7/modules/redistimeseries.so</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动redis</span></span><br><span class="line">redis-server redis.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录测试</span></span><br><span class="line">redis-cli --user admin --pass 123456</span><br><span class="line"><span class="comment"># 查看模块</span></span><br><span class="line">127.0.0.1:6379&gt; MODULE LIST</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">1) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;timeseries&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 11209</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/local/soft/redis-7.4.7/modules/redistimeseries.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">2) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;ReJSON&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 20816</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/local/soft/redis-7.4.7/modules/rejson.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">3) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;bf&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 20817</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/local/soft/redis-7.4.7/modules/redisbloom.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">4) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;search&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 21025</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/local/soft/redis-7.4.7/modules/redisearch.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文介绍 Redis 扩展模块 – RedisTimeSeries 的安装方法&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文基于&lt;code&gt;redis-7.4.7&lt;/code&gt;，&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;操作系统：&lt;code&gt;Amazon Linux 2023(内核 6.1)&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis官网：&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis 命令文档：&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis 命令及数据类型 -- AutoSuggest</title>
    <link href="https://blog.hanqunfeng.com/2026/01/06/redis7-datatype-17-AutoSuggest/"/>
    <id>https://blog.hanqunfeng.com/2026/01/06/redis7-datatype-17-AutoSuggest/</id>
    <published>2026-01-06T13:30:05.000Z</published>
    <updated>2026-01-07T07:42:03.485Z</updated>
    
    <content type="html"><![CDATA[<h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2">本文介绍 Redis 扩展模块 – RediSearch 中 AutoSuggest 数据类型</li><li class="lvl-2">本文基于<code>redis-7.4.7</code>，<code>springboot-3.5.8</code></li><li class="lvl-2">操作系统：<code>Amazon Linux 2023(内核 6.1)</code></li><li class="lvl-2">Redis官网：<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis 命令文档：<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li><li class="lvl-2">RediSearch 的安装参见 <a href="/2025/12/26/redis7-module-RediSearch/" title="Redis 扩展模块 -- RediSearch 的安装方法">Redis 扩展模块 -- RediSearch 的安装方法</a></li><li class="lvl-2">示例代码：<a href="https://github.com/hanqunfeng/springbootchapter/tree/master/springboot3-demo/redis-demo/redisson-demo">GitHub</a></li></ul><span id="more"></span><h2 id="AutoSuggest-搜索建议（自动补全）">AutoSuggest 搜索建议（自动补全）</h2><ul class="lvl-0"><li class="lvl-2"><p>Suggest 本质解决的问题：“当用户只输入部分前缀时，如何高性能地给出候选词，而不是全文搜索结果。”</p></li><li class="lvl-2"><p>Suggest 能解决什么业务问题?</p></li></ul><table><thead><tr><th>业务痛点</th><th>传统方案问题</th><th>Suggest 的价值</th></tr></thead><tbody><tr><td>搜索框自动补全</td><td>LIKE / 模糊查询性能差</td><td>O(logN) 级前缀匹配</td></tr><tr><td>热门词推荐</td><td>需要额外统计系统</td><td>内置 score 排序</td></tr><tr><td>拼写不准确</td><td>普通前缀无法命中</td><td>FUZZY 模糊匹配</td></tr><tr><td>联想提示</td><td>搜索索引过重</td><td>Suggest 独立结构，轻量</td></tr><tr><td>高并发提示</td><td>数据库压力大</td><td>Redis 内存级吞吐</td></tr><tr><td>实时更新</td><td>离线词库复杂</td><td>动态增删</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>Suggest 命令与使用场景对照表</p></li></ul><table><thead><tr><th>命令</th><th>作用</th><th>典型使用场景</th><th>是否高频</th></tr></thead><tbody><tr><td><strong>FT.SUGADD</strong></td><td>添加 / 更新补全词</td><td>构建词库、动态热词更新</td><td>⭐⭐⭐⭐</td></tr><tr><td><strong>FT.SUGGET</strong></td><td>查询补全建议</td><td>用户输入联想提示</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>FT.SUGDEL</strong></td><td>删除补全词</td><td>词下架、清理脏数据</td><td>⭐⭐</td></tr><tr><td><strong>FT.SUGLEN</strong></td><td>统计补全词数量</td><td>监控、容量评估</td><td>⭐</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>场景 → 命令映射总结表（推荐收藏）</p></li></ul><table><thead><tr><th>业务目标</th><th>推荐命令组合</th><th>说明</th></tr></thead><tbody><tr><td>自动补全</td><td>SUGADD + SUGGET</td><td>基础能力</td></tr><tr><td>热词排行</td><td>SUGADD(INCR) + SUGGET(WITHSCORES)</td><td>权重驱动</td></tr><tr><td>拼写纠错</td><td>SUGGET(FUZZY)</td><td>容错</td></tr><tr><td>分类推荐</td><td>SUGADD(PAYLOAD) + SUGGET(WITHPAYLOADS)</td><td>携带业务信息</td></tr><tr><td>词库治理</td><td>SUGDEL + SUGLEN</td><td>运维</td></tr><tr><td>容量监控</td><td>SUGLEN</td><td>规模评估</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>👉 原则：输入框提示用 Suggest，搜索结果用 FT.SEARCH。</p></li></ul><h3 id="1️⃣-FT-SUGADD-——-添加-更新补全词">1️⃣ FT.SUGADD —— 添加 / 更新补全词</h3><ul class="lvl-0"><li class="lvl-2"><p>向补全词库中添加一个候选词</p></li><li class="lvl-2"><p>可设置 权重、payload</p></li><li class="lvl-2"><p>可用于 热词排序</p></li><li class="lvl-2"><p>语法</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FT.SUGADD key string score</span><br><span class="line">  [INCR]</span><br><span class="line">  [PAYLOAD payload]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>参数说明</p></li></ul><table><thead><tr><th>参数</th><th>含义</th></tr></thead><tbody><tr><td><code>key</code></td><td>Suggestion 词库 Key，索引名称</td></tr><tr><td><code>string</code></td><td>补全文本</td></tr><tr><td><code>score</code></td><td>权重（越大越靠前）</td></tr><tr><td><code>INCR</code></td><td>递增，累加权重</td></tr><tr><td><code>PAYLOAD</code></td><td>附加元数据</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>示例</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FT.SUGADD sug:search <span class="string">&quot;iphone&quot;</span> 100</span><br><span class="line">FT.SUGADD sug:search <span class="string">&quot;iphone 15&quot;</span> 200</span><br><span class="line">FT.SUGADD sug:search <span class="string">&quot;ipad&quot;</span> 50 PAYLOAD <span class="string">&quot;category=tablet&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看类型</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">type</span> sug:search</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line">trietype0</span><br></pre></td></tr></table></figure><h3 id="2️⃣-FT-SUGGET-——-获取补全建议">2️⃣ FT.SUGGET —— 获取补全建议</h3><ul class="lvl-0"><li class="lvl-2"><p>根据 前缀 返回最相关的候选词</p></li><li class="lvl-2"><p>支持模糊匹配</p></li><li class="lvl-2"><p>可返回 payload / score</p></li><li class="lvl-2"><p>可用于 搜索框输入联想、拼写纠错</p></li><li class="lvl-2"><p>语法</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FT.SUGGET key prefix</span><br><span class="line">  [FUZZY]</span><br><span class="line">  [WITHSCORES]</span><br><span class="line">  [WITHPAYLOADS]</span><br><span class="line">  [MAX num]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>参数说明</p></li></ul><table><thead><tr><th>参数</th><th>含义</th></tr></thead><tbody><tr><td><code>prefix</code></td><td>用户输入前缀</td></tr><tr><td><code>FUZZY</code></td><td>模糊匹配（允许拼写错误）</td></tr><tr><td><code>WITHSCORES</code></td><td>返回权重</td></tr><tr><td><code>WITHPAYLOADS</code></td><td>返回 payload</td></tr><tr><td><code>MAX</code></td><td>最大返回数量</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>示例</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">FT.SUGGET sug:search <span class="string">&quot;ip&quot;</span> MAX 5</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line">1) <span class="string">&quot;iphone 15&quot;</span></span><br><span class="line">2) <span class="string">&quot;iphone&quot;</span></span><br><span class="line">3) <span class="string">&quot;ipad&quot;</span></span><br><span class="line"></span><br><span class="line">FT.SUGGET sug:search <span class="string">&quot;iphne&quot;</span> FUZZY</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line">1) <span class="string">&quot;iphone 15&quot;</span></span><br><span class="line">2) <span class="string">&quot;iphone&quot;</span></span><br><span class="line"></span><br><span class="line">FT.SUGGET sug:search <span class="string">&quot;ip&quot;</span> WITHSCORES WITHPAYLOADS</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line">1) <span class="string">&quot;iphone 15&quot;</span></span><br><span class="line">2) <span class="string">&quot;70.71067810058594&quot;</span></span><br><span class="line">3) (nil)</span><br><span class="line">4) <span class="string">&quot;iphone&quot;</span></span><br><span class="line">5) <span class="string">&quot;44.72135925292969&quot;</span></span><br><span class="line">6) (nil)</span><br><span class="line">7) <span class="string">&quot;ipad&quot;</span></span><br><span class="line">8) <span class="string">&quot;28.86751365661621&quot;</span></span><br><span class="line">9) <span class="string">&quot;category=tablet&quot;</span></span><br></pre></td></tr></table></figure><h3 id="3️⃣-FT-SUGDEL-——-删除补全词">3️⃣ FT.SUGDEL —— 删除补全词</h3><ul class="lvl-0"><li class="lvl-2"><p>从补全词库中移除指定词条</p></li><li class="lvl-2"><p>可用于 商品下架、敏感词移除、过期关键词清理</p></li><li class="lvl-2"><p>语法</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FT.SUGDEL key string</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>示例</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FT.SUGDEL sug:search <span class="string">&quot;iphone&quot;</span></span><br></pre></td></tr></table></figure><h3 id="4️⃣-FT-SUGLEN-——-查看词库规模">4️⃣ FT.SUGLEN —— 查看词库规模</h3><ul class="lvl-0"><li class="lvl-2"><p>获取当前词库的词条数量</p></li><li class="lvl-2"><p>语法</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FT.SUGLEN key</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>示例</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FT.SUGLEN sug:search</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br></pre></td></tr></table></figure><h2 id="示例代码">示例代码</h2><ul class="lvl-0"><li class="lvl-2"><p>SpringBoot 的 RedisTemplate 中没有提供对<code>AutoSuggest</code>的封装，需要自己封装，我这里封装了一个简易的<code>RedisSuggestTool</code></p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.redissug;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 补全建议工具类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisSuggestTool</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> &lt;T&gt; T <span class="title function_">executeLua</span><span class="params">(String script, List&lt;String&gt; keys, Object... args)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (T) stringRedisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Object.class),</span><br><span class="line">                keys,</span><br><span class="line">                Arrays.stream(args)</span><br><span class="line">                        .map(String::valueOf)</span><br><span class="line">                        .toArray(String[]::<span class="keyword">new</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加 / 更新补全词</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * FT.SUGADD key string score</span></span><br><span class="line"><span class="comment">     * [INCR]</span></span><br><span class="line"><span class="comment">     * [PAYLOAD payload]</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key     索引名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value   补全文本</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> score   分数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> incr    是否递增，默认为false</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payload 补全词的附加信息，默认为空</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">sugAdd</span><span class="params">(String key,</span></span><br><span class="line"><span class="params">                       String value,</span></span><br><span class="line"><span class="params">                       <span class="type">double</span> score,</span></span><br><span class="line"><span class="params">                       <span class="type">boolean</span> incr,</span></span><br><span class="line"><span class="params">                       String payload)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">lua</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                local args = &#123;&#x27;FT.SUGADD&#x27;, KEYS[1], ARGV[1], ARGV[2]&#125;</span></span><br><span class="line"><span class="string">                if ARGV[3] == &#x27;1&#x27; then table.insert(args, &#x27;INCR&#x27;) end</span></span><br><span class="line"><span class="string">                if ARGV[4] ~= &#x27;&#x27; then table.insert(args, &#x27;PAYLOAD&#x27;); table.insert(args, ARGV[4]) end</span></span><br><span class="line"><span class="string">                return redis.call(unpack(args))</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> executeLua(</span><br><span class="line">                lua,</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                value,</span><br><span class="line">                score,</span><br><span class="line">                incr ? <span class="string">&quot;1&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">                payload == <span class="literal">null</span> ? <span class="string">&quot;&quot;</span> : payload</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">sugAdd</span><span class="params">(String key,</span></span><br><span class="line"><span class="params">                       String value,</span></span><br><span class="line"><span class="params">                       <span class="type">double</span> score)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sugAdd(key, value, score, <span class="literal">false</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询补全建议</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * FT.SUGGET key prefix</span></span><br><span class="line"><span class="comment">     * [FUZZY]</span></span><br><span class="line"><span class="comment">     * [WITHSCORES]</span></span><br><span class="line"><span class="comment">     * [WITHPAYLOADS]</span></span><br><span class="line"><span class="comment">     * [MAX num]</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key          索引名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> prefix       前缀</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fuzzy        是否模糊匹配，默认为false</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> withScores   是否返回分数，默认为false</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> withPayloads 是否返回附加信息，默认为false</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> max           最大返回数量，默认为5</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Suggestion&gt; <span class="title function_">sugGet</span><span class="params">(String key,</span></span><br><span class="line"><span class="params">                                   String prefix,</span></span><br><span class="line"><span class="params">                                   <span class="type">boolean</span> fuzzy,</span></span><br><span class="line"><span class="params">                                   <span class="type">boolean</span> withScores,</span></span><br><span class="line"><span class="params">                                   <span class="type">boolean</span> withPayloads,</span></span><br><span class="line"><span class="params">                                   <span class="type">int</span> max)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">lua</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                local args = &#123;&#x27;FT.SUGGET&#x27;, KEYS[1], ARGV[1]&#125;</span></span><br><span class="line"><span class="string">                if ARGV[2] == &#x27;1&#x27; then table.insert(args, &#x27;FUZZY&#x27;) end</span></span><br><span class="line"><span class="string">                if ARGV[3] == &#x27;1&#x27; then table.insert(args, &#x27;WITHSCORES&#x27;) end</span></span><br><span class="line"><span class="string">                if ARGV[4] == &#x27;1&#x27; then table.insert(args, &#x27;WITHPAYLOADS&#x27;) end</span></span><br><span class="line"><span class="string">                if tonumber(ARGV[5]) &gt; 0 then table.insert(args, &#x27;MAX&#x27;); table.insert(args, ARGV[5]) end</span></span><br><span class="line"><span class="string">                return redis.call(unpack(args))</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        List&lt;Object&gt; raw = executeLua(</span><br><span class="line">                lua,</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                prefix,</span><br><span class="line">                fuzzy ? <span class="string">&quot;1&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">                withScores ? <span class="string">&quot;1&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">                withPayloads ? <span class="string">&quot;1&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">                max</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> parseSuggestionResult(raw, withScores, withPayloads);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 结果解析器</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Suggestion&gt; <span class="title function_">parseSuggestionResult</span><span class="params">(List&lt;Object&gt; raw,</span></span><br><span class="line"><span class="params">                                                   <span class="type">boolean</span> withScores,</span></span><br><span class="line"><span class="params">                                                   <span class="type">boolean</span> withPayloads)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (raw == <span class="literal">null</span> || raw.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;Suggestion&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">step</span> <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">                + (withScores ? <span class="number">1</span> : <span class="number">0</span>)</span><br><span class="line">                + (withPayloads ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; raw.size(); i += step) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> i;</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> String.valueOf(raw.get(idx++));</span><br><span class="line">            <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> withScores ? Double.valueOf(String.valueOf(raw.get(idx++))) : <span class="literal">null</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> withPayloads ? String.valueOf(raw.get(idx++)) : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            list.add(<span class="keyword">new</span> <span class="title class_">Suggestion</span>(value, score, payload));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除补全词</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * FT.SUGDEL key string</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   索引名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 补全词</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">sugDel</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">lua</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;FT.SUGDEL&#x27;, KEYS[1], ARGV[1])&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> executeLua(</span><br><span class="line">                lua,</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                value</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Long.valueOf(<span class="number">1</span>).equals(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取补全词数量</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * FT.SUGLEN key</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 索引名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">sugLen</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">lua</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;FT.SUGLEN&#x27;, KEYS[1])&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> executeLua(</span><br><span class="line">                lua,</span><br><span class="line">                Collections.singletonList(key)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Suggestion</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String value;</span><br><span class="line">    <span class="keyword">private</span> Double score;</span><br><span class="line">    <span class="keyword">private</span> String payload;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文介绍 Redis 扩展模块 – RediSearch 中 AutoSuggest 数据类型&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文基于&lt;code&gt;redis-7.4.7&lt;/code&gt;，&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;操作系统：&lt;code&gt;Amazon Linux 2023(内核 6.1)&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis官网：&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis 命令文档：&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;RediSearch 的安装参见 &lt;a href=&quot;/2025/12/26/redis7-module-RediSearch/&quot; title=&quot;Redis 扩展模块 -- RediSearch 的安装方法&quot;&gt;Redis 扩展模块 -- RediSearch 的安装方法&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;示例代码：&lt;a href=&quot;https://github.com/hanqunfeng/springbootchapter/tree/master/springboot3-demo/redis-demo/redisson-demo&quot;&gt;GitHub&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>RediSearch 开发实战</title>
    <link href="https://blog.hanqunfeng.com/2026/01/05/redis7-module-RediSearch-study/"/>
    <id>https://blog.hanqunfeng.com/2026/01/05/redis7-module-RediSearch-study/</id>
    <published>2026-01-05T13:30:05.000Z</published>
    <updated>2026-01-07T07:30:53.062Z</updated>
    
    <content type="html"><![CDATA[<h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2">本文介绍 Redis 扩展模块 – RediSearch 的使用方法</li><li class="lvl-2">本文基于<code>redis-7.4.7</code>，<code>springboot-3.5.8</code></li><li class="lvl-2">操作系统：<code>Amazon Linux 2023(内核 6.1)</code></li><li class="lvl-2">Redis官网：<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis 命令文档：<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li><li class="lvl-2">RediSearch 的安装参见 <a href="/2025/12/26/redis7-module-RediSearch/" title="Redis 扩展模块 -- RediSearch 的安装方法">Redis 扩展模块 -- RediSearch 的安装方法</a></li><li class="lvl-2">示例代码：<a href="https://github.com/hanqunfeng/springbootchapter/tree/master/springboot3-demo/redis-demo/redisson-demo">GitHub</a></li></ul><span id="more"></span><h2 id="RediSearch-命令">RediSearch 命令</h2><ul class="lvl-0"><li class="lvl-2"><p>为了展示命令的使用方法，这里以JSON文档进行索引，初始化数据如下：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">JSON.SET user:10001 $ <span class="string">&#x27;&#123;&quot;name&quot;:&quot;Alice Bob&quot;,&quot;age&quot;:28,&quot;vip&quot;:&quot;yes&quot;,&quot;orders&quot;:[&#123;&quot;amount&quot;:199.99,&quot;status&quot;:&quot;PAID&quot;&#125;,&#123;&quot;amount&quot;:59.9,&quot;status&quot;:&quot;CREATED&quot;&#125;],&quot;comment&quot;: &quot;I have a phone&quot;,&quot;items&quot;:[&quot;SpringCloud技术指南&quot;,&quot;Shell脚本基础&quot;]&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">JSON.SET user:10002 $ <span class="string">&#x27;&#123;&quot;name&quot;:&quot;Bob Frank&quot;,&quot;age&quot;:35,&quot;vip&quot;:&quot;no&quot;,&quot;orders&quot;:[&#123;&quot;amount&quot;:899.0,&quot;status&quot;:&quot;PAID&quot;&#125;],&quot;comment&quot;: &quot;I have a iphone&quot;,&quot;items&quot;:[&quot;Linux必知必会&quot;,&quot;Java多线程详解&quot;]&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">JSON.SET user:10003 $ <span class="string">&#x27;&#123;&quot;name&quot;:&quot;Carol&quot;,&quot;age&quot;:22,&quot;vip&quot;:&quot;no&quot;,&quot;orders&quot;:[&#123;&quot;amount&quot;:19.9,&quot;status&quot;:&quot;CANCELLED&quot;&#125;],&quot;comment&quot;: &quot;I have a mobile&quot;,&quot;items&quot;:[&quot;MySQL从删库到跑路&quot;,&quot;Oracle开发实践&quot;]&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">JSON.SET user:10004 $ <span class="string">&#x27;&#123;&quot;name&quot;:&quot;David Bob&quot;,&quot;age&quot;:41,&quot;vip&quot;:&quot;yes&quot;,&quot;orders&quot;:[&#123;&quot;amount&quot;:1200,&quot;status&quot;:&quot;PAID&quot;&#125;,&#123;&quot;amount&quot;:300,&quot;status&quot;:&quot;PAID&quot;&#125;],&quot;comment&quot;: &quot;I have a car&quot;,&quot;items&quot;:[&quot;Spring技术指南&quot;,&quot;RocketMQ由浅入深&quot;]&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">JSON.SET user:10005 $ <span class="string">&#x27;&#123;&quot;name&quot;:&quot;Eve&quot;,&quot;age&quot;:30,&quot;vip&quot;:&quot;no&quot;,&quot;orders&quot;:[&#123;&quot;amount&quot;:88.8,&quot;status&quot;:&quot;CREATED&quot;&#125;],&quot;comment&quot;: &quot;I have a pencil&quot;,&quot;items&quot;:[&quot;Kafka从零开始&quot;,&quot;Java由浅入深&quot;]&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">JSON.SET user:10006 $ <span class="string">&#x27;&#123;&quot;name&quot;:&quot;Frank&quot;,&quot;age&quot;:27,&quot;vip&quot;:&quot;no&quot;,&quot;orders&quot;:[&#123;&quot;amount&quot;:499,&quot;status&quot;:&quot;PAID&quot;&#125;,&#123;&quot;amount&quot;:129,&quot;status&quot;:&quot;CREATED&quot;&#125;],&quot;comment&quot;: &quot;I have a phone&quot;,&quot;items&quot;:[&quot;Redis开发实战&quot;,&quot;MongoDB从入门到实战&quot;]&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">JSON.SET user:10007 $ <span class="string">&#x27;&#123;&quot;name&quot;:&quot;Grace&quot;,&quot;age&quot;:33,&quot;vip&quot;:&quot;yes&quot;,&quot;orders&quot;:[&#123;&quot;amount&quot;:999.9,&quot;status&quot;:&quot;PAID&quot;&#125;],&quot;comment&quot;: &quot;I have a book&quot;,&quot;items&quot;:[&quot;Android开发手册&quot;,&quot;Gradle从零开始&quot;]&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">JSON.SET user:10008 $ <span class="string">&#x27;&#123;&quot;name&quot;:&quot;Henry&quot;,&quot;age&quot;:45,&quot;vip&quot;:&quot;no&quot;,&quot;orders&quot;:[&#123;&quot;amount&quot;:59.9,&quot;status&quot;:&quot;CANCELLED&quot;&#125;],&quot;comment&quot;: &quot;I have a macbook&quot;,&quot;items&quot;:[&quot;SpringBoot技术指南&quot;,&quot;Maven由浅入深&quot;]&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">JSON.SET user:10009 $ <span class="string">&#x27;&#123;&quot;name&quot;:&quot;Ivy&quot;,&quot;age&quot;:26,&quot;vip&quot;:&quot;yes&quot;,&quot;orders&quot;:[&#123;&quot;amount&quot;:299,&quot;status&quot;:&quot;PAID&quot;&#125;,&#123;&quot;amount&quot;:199,&quot;status&quot;:&quot;PAID&quot;&#125;],&quot;comment&quot;: &quot;I have a watch&quot;,&quot;items&quot;:[&quot;Spring融会贵通&quot;,&quot;Java技术开发指南&quot;]&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">JSON.SET user:10010 $ <span class="string">&#x27;&#123;&quot;name&quot;:&quot;Jack&quot;,&quot;age&quot;:38,&quot;vip&quot;:&quot;no&quot;,&quot;orders&quot;:[&#123;&quot;amount&quot;:150,&quot;status&quot;:&quot;CREATED&quot;&#125;],&quot;comment&quot;: &quot;I have a apple&quot;,&quot;items&quot;:[&quot;Spring技术指南&quot;,&quot;Java由浅入深&quot;]&#125;&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>SpringBoot暂时没有支持 RediSearch ，你可以编写Lua脚本来实现相应的功能，另外 <a href="https://redisson.pro/docs/data-and-services/services/#redisearch-service">Redisson</a>已经提供了对 RediSearch 的支持，下面结合命令给出代码示例。</p></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 引入 Redisson ，这里要注意，现在最新版是 4.0.0，需要 springboot 4.x --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.52.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>通用代码</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="type">RSearch</span> <span class="variable">rSearch</span> <span class="operator">=</span> redissonClient.getSearch(StringCodec.INSTANCE);</span><br></pre></td></tr></table></figure><h3 id="一、索引生命周期管理类">一、索引生命周期管理类</h3><table><thead><tr><th>命令</th><th>作用</th><th>核心参数</th><th>示例</th></tr></thead><tbody><tr><td><code>FT.CREATE</code></td><td>创建索引</td><td>索引名、ON、PREFIX、SCHEMA</td><td>见下</td></tr><tr><td><code>FT.ALTER</code></td><td>给已有索引新增字段</td><td>索引名、SCHEMA ADD</td><td>见下</td></tr><tr><td><code>FT.DROPINDEX</code></td><td>删除索引</td><td>索引名、DD</td><td>见下</td></tr><tr><td><code>FT.INFO</code></td><td>查看索引信息</td><td>索引名</td><td>见下</td></tr><tr><td><code>FT._LIST</code></td><td>列出所有索引</td><td>无</td><td>见下</td></tr></tbody></table><h4 id="1️⃣-FT-CREATE">1️⃣ FT.CREATE</h4><ul class="lvl-0"><li class="lvl-2"><p>FT.CREATE 基本语法</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">FT.CREATE index_name</span><br><span class="line">[ON HASH | JSON]</span><br><span class="line">[PREFIX count prefix ...]</span><br><span class="line">[FILTER filter]</span><br><span class="line">[LANGUAGE default_lang]</span><br><span class="line">[LANGUAGE_FIELD lang_attribute]</span><br><span class="line">[SCORE default_score]</span><br><span class="line">[SCORE_FIELD score_attribute]</span><br><span class="line">[PAYLOAD_FIELD payload_attribute]</span><br><span class="line">[MAXTEXTFIELDS]</span><br><span class="line">[TEMPORARY seconds]</span><br><span class="line">[NOOFFSETS] [NOHL] [NOFIELDS] [NOFREQS]</span><br><span class="line">[STOPWORDS count stopword ...]</span><br><span class="line">[SKIPINITIALSCAN]</span><br><span class="line">SCHEMA</span><br><span class="line">  field_name [AS <span class="built_in">alias</span>] TEXT | TAG | NUMERIC | GEO | VECTOR</span><br><span class="line">  [SORTABLE [UNF]]</span><br><span class="line">  [NOINDEX]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>FT.CREATE 参数说明表</p></li></ul><table><thead><tr><th>参数</th><th>作用说明</th></tr></thead><tbody><tr><td><code>index_name</code></td><td>索引名称</td></tr><tr><td><code>ON HASH | JSON</code></td><td>指定索引数据来源类型，默认 <code>HASH</code></td></tr><tr><td><code>PREFIX count prefix...</code></td><td>指定索引 Key 前缀</td></tr><tr><td><code>FILTER filter</code></td><td>对索引数据设置过滤表达式</td></tr><tr><td><code>LANGUAGE</code></td><td>指定默认分词语言（默认 english，中文是 chinese）</td></tr><tr><td><code>LANGUAGE_FIELD</code></td><td>指定文档中的语言字段</td></tr><tr><td><code>SCORE</code></td><td>设置文档默认评分</td></tr><tr><td><code>SCORE_FIELD</code></td><td>从字段中读取评分</td></tr><tr><td><code>PAYLOAD_FIELD</code></td><td>指定存储的二进制负载字段</td></tr><tr><td><code>MAXTEXTFIELDS</code></td><td>允许更多 TEXT 字段（消耗更多内存）</td></tr><tr><td><code>TEMPORARY seconds</code></td><td>创建临时索引，超时后自动删除</td></tr><tr><td><code>NOOFFSETS</code></td><td>不存储文本偏移量（节省内存）</td></tr><tr><td><code>NOHL</code></td><td>禁用高亮</td></tr><tr><td><code>NOFIELDS</code></td><td>不保存字段内容</td></tr><tr><td><code>NOFREQS</code></td><td>不保存词频信息</td></tr><tr><td><code>STOPWORDS count ...</code></td><td>指定停用词</td></tr><tr><td><code>SKIPINITIALSCAN</code></td><td>创建索引时不扫描已有数据</td></tr><tr><td><code>SCHEMA</code></td><td>索引字段定义起始</td></tr><tr><td><code>AS alias</code></td><td>字段别名</td></tr><tr><td><code>TEXT</code></td><td>全文索引字段</td></tr><tr><td><code>TAG</code></td><td>精确匹配字段</td></tr><tr><td><code>NUMERIC</code></td><td>数值字段</td></tr><tr><td><code>GEO</code></td><td>地理位置字段</td></tr><tr><td><code>VECTOR</code></td><td>向量字段</td></tr><tr><td><code>SORTABLE</code></td><td>允许排序</td></tr><tr><td><code>UNF</code></td><td>不规范化排序</td></tr><tr><td><code>NOINDEX</code></td><td>字段不参与索引</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>FT.CREATE 的核心语法</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FT.CREATE &lt;index&gt;</span><br><span class="line">[ON HASH | JSON]</span><br><span class="line">[PREFIX count prefix ...]</span><br><span class="line">[LANGUAGE default_lang]</span><br><span class="line">SCHEMA</span><br><span class="line">  field_name [AS <span class="built_in">alias</span>] TEXT | TAG | NUMERIC | GEO | VECTOR</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>创建索引示例</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">FT.CREATE idx:user</span><br><span class="line">  ON JSON</span><br><span class="line">  PREFIX 1 user:</span><br><span class="line">  LANGUAGE chinese</span><br><span class="line">  SCHEMA</span><br><span class="line">    $.name AS name TEXT</span><br><span class="line">    $.age AS age NUMERIC SORTABLE</span><br><span class="line">    $.orders[*].amount AS amount NUMERIC</span><br><span class="line">    $.orders[*].status AS status TAG</span><br><span class="line">    $.comment AS comment TEXT</span><br><span class="line">    $.items[*] AS items TEXT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数说明</span></span><br><span class="line">  <span class="comment"># idx:user：索引名</span></span><br><span class="line">  <span class="comment"># ON JSON：索引 JSON 文档，RediSearch 仅支持对 HASH 和 JSON 进行索引</span></span><br><span class="line">  <span class="comment"># PREFIX 1 user: ：索引指定 key 前缀，1 表示索引一个，user: 表示索引的 key 前缀，如果索引两个：PREFIX 2 user: order:</span></span><br><span class="line">  <span class="comment"># LANGUAGE chinese：指定默认分词语言，默认是英文 english，中文是 chinese，如果索引中有中文，则必须指定 LANGUAGE 为 chinese</span></span><br><span class="line">  <span class="comment"># SCHEMA：索引字段</span></span><br><span class="line">  <span class="comment"># $.name AS name TEXT：索引字段 $.name(注意：JSON类型以 $. 开头，Hash类型就不需要了)，字段别名为 name，字段类型为 TEXT</span></span><br><span class="line">  <span class="comment"># AS：字段别名（查询时使用）</span></span><br><span class="line">  <span class="comment"># TEXT / NUMERIC / TAG：字段类型，这几个是最常用的</span></span><br><span class="line">  <span class="comment"># SORTABLE：NUMERIC、TAG、TEXT 或 GEO 类型的字段可以带有一个可选的 SORTABLE 参数，表示为字段建立专门的排序数据结构（类似列式存储），从而避免在查询阶段对大量结果进行临时排序。</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">rSearch.createIndex(</span><br><span class="line">    <span class="string">&quot;idx:user&quot;</span>,</span><br><span class="line">    IndexOptions.defaults()</span><br><span class="line">            .on(IndexType.JSON)</span><br><span class="line">            .prefix(List.of(<span class="string">&quot;user:&quot;</span>))</span><br><span class="line">            .language(<span class="string">&quot;chinese&quot;</span>),</span><br><span class="line">    FieldIndex.text(<span class="string">&quot;$.name&quot;</span>).as(<span class="string">&quot;name&quot;</span>),</span><br><span class="line">    FieldIndex.numeric(<span class="string">&quot;$.age&quot;</span>).as(<span class="string">&quot;age&quot;</span>),</span><br><span class="line">    FieldIndex.numeric(<span class="string">&quot;$.orders[*].amount&quot;</span>).as(<span class="string">&quot;amount&quot;</span>),</span><br><span class="line">    FieldIndex.tag(<span class="string">&quot;$.orders[*].status&quot;</span>).as(<span class="string">&quot;status&quot;</span>),</span><br><span class="line">    FieldIndex.text(<span class="string">&quot;$.comment&quot;</span>).as(<span class="string">&quot;comment&quot;</span>),</span><br><span class="line">    FieldIndex.text(<span class="string">&quot;$.items[*]&quot;</span>).as(<span class="string">&quot;items&quot;</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>索引字段的类型</p></li></ul><table><thead><tr><th>字段类型</th><th>中文名称</th><th>功能说明</th><th>典型使用场景</th><th>备注 / 限制</th></tr></thead><tbody><tr><td><strong>TEXT</strong></td><td>全文文本字段</td><td>支持对字段值进行全文检索（分词、相关度计算、模糊匹配等）</td><td>文章内容、用户名、描述信息</td><td>支持权重（WEIGHT）、排序（SORTABLE）等选项</td></tr><tr><td><strong>TAG</strong></td><td>标签字段 / 精确匹配字段</td><td>支持精确匹配查询，适用于枚举值或离散分类</td><td>分类、状态、主键、类型字段</td><td>不分词；可自定义分隔符</td></tr><tr><td><strong>NUMERIC</strong></td><td>数值字段</td><td>支持数值范围查询</td><td>年龄、价格、分数、时间戳</td><td>支持区间查询（<code>[min max]</code>）</td></tr><tr><td><strong>GEO</strong></td><td>地理位置字段（点）</td><td>支持以“点”为中心的半径范围查询</td><td>门店位置、用户位置</td><td>值格式必须为 <code>&quot;经度,纬度&quot;</code></td></tr><tr><td><strong>VECTOR</strong></td><td>向量字段</td><td>支持向量相似度搜索（KNN 等）</td><td>语义搜索、推荐系统、Embedding 向量</td><td>需要 <strong>Query Dialect ≥ 2</strong>（RediSearch ≥ 2.4）</td></tr><tr><td><strong>GEOSHAPE</strong></td><td>地理形状字段（多边形）</td><td>支持多边形空间查询</td><td>行政区、商圈、地图区域</td><td>使用 WKT 格式；不支持 JSON 多值和 SORTABLE</td></tr></tbody></table><blockquote><p>GEOSHAPE 字段补充说明</p></blockquote><table><thead><tr><th>项目</th><th>说明</th></tr></thead><tbody><tr><td>数据格式</td><td>WKT（Well-Known Text）格式，如：<code>POLYGON((x1 y1, x2 y2, ...))</code></td></tr><tr><td>坐标系统</td><td><code>SPHERICAL</code>（球面坐标，经纬度）<br><code>FLAT</code>（平面坐标，笛卡尔 X/Y）</td></tr><tr><td>默认坐标系统</td><td><code>SPHERICAL</code></td></tr><tr><td>当前限制</td><td>❌ 不支持 JSON 多值<br>❌ 不支持 <code>SORTABLE</code> 选项</td></tr></tbody></table><blockquote><p>索引字段类型选型建议</p></blockquote><table><thead><tr><th>使用场景</th><th>推荐字段类型</th><th>说明</th></tr></thead><tbody><tr><td>全文检索</td><td><strong>TEXT</strong></td><td>支持分词、相关度计算、模糊匹配等全文搜索能力</td></tr><tr><td>精确过滤 / 分类</td><td><strong>TAG</strong></td><td>精确匹配，不分词，适合枚举值、状态、类型等字段</td></tr><tr><td>区间筛选 / 排序</td><td><strong>NUMERIC</strong></td><td>支持数值区间查询与排序，适合价格、时间、分数等</td></tr><tr><td>附近的人 / 门店</td><td><strong>GEO</strong></td><td>基于经纬度点进行半径范围查询</td></tr><tr><td>语义搜索 / 向量召回</td><td><strong>VECTOR</strong></td><td>基于向量相似度（KNN）的语义搜索，需要 Dialect ≥ 2</td></tr><tr><td>复杂地理区域判断</td><td><strong>GEOSHAPE</strong></td><td>支持多边形（Polygon）区域查询，适合行政区、商圈等</td></tr></tbody></table><blockquote><p>哪些字段适合使用 SORTABLE</p></blockquote><table><thead><tr><th>字段类型</th><th>是否适合 SORTABLE</th><th>原因</th></tr></thead><tbody><tr><td>NUMERIC</td><td>✅ 强烈推荐</td><td>数值排序最常见，如价格、时间、评分</td></tr><tr><td>TAG</td><td>⚠️ 视情况</td><td>一般用于过滤，排序意义不大</td></tr><tr><td>TEXT</td><td>⚠️ 谨慎</td><td>文本可能很大，内存开销高</td></tr><tr><td>GEO</td><td>⚠️ 特殊场景</td><td>通常按距离排序，更多依赖 <code>GEOFILTER</code></td></tr></tbody></table><div class="tips"><p><em><strong>小贴士：如何在redis终端输入多行的命令？</strong></em></p><ul class="lvl-1"><li class="lvl-2">先说结论：redis终端 不支持多行输入，但可以通过如下方式输入多行命令：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">redis-cli &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">HSET user:1 \</span></span><br><span class="line"><span class="string">name Tom \</span></span><br><span class="line"><span class="string">age 18 \</span></span><br><span class="line"><span class="string">city Beijing</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><ul class="lvl-1"><li class="lvl-2">这种方法是利用了 Bash 的能力，即 <code>&lt;&lt;EOF</code> 后面的内容会作为标准输入，直到 <code>EOF</code> 为止，并通过 <code>\</code> 符换行。</li><li class="lvl-2">如果在VSCode中，可以选中要合并的多行内容，然后通过 <code>Ctrl + Shift + J</code> 快捷键将多行合并到一行。</li></ul></div><h4 id="2️⃣-FT-ALTER">2️⃣ FT.ALTER</h4><blockquote><p>⚠️ 只能 新增字段，不能修改或删除已有字段</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FT.ALTER idx:user SCHEMA ADD $.vip AS vip TAG</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rSearch.alter(</span><br><span class="line">        <span class="string">&quot;idx:user&quot;</span>,</span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        FieldIndex.tag(<span class="string">&quot;$.vip&quot;</span>).as(<span class="string">&quot;vip&quot;</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h4 id="3️⃣-FT-DROPINDEX">3️⃣ FT.DROPINDEX</h4><blockquote><p>⚠️ 删除索引</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FT.DROPINDEX idx:user</span><br><span class="line"><span class="comment"># ⚠️ DD：删除索引的同时删除被索引数据，谨慎使用</span></span><br><span class="line">FT.DROPINDEX idx:user DD</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rSearch.dropIndex(<span class="string">&quot;idx:user&quot;</span>);</span><br><span class="line">rSearch.dropIndexAndDocuments(<span class="string">&quot;idx:user&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="4️⃣-FT-INFO">4️⃣ <a href="http://FT.INFO">FT.INFO</a></h4><blockquote><p>查看索引信息</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FT.INFO idx:user</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">IndexInfo</span> <span class="variable">info</span> <span class="operator">=</span> rSearch.info(<span class="string">&quot;idx:user&quot;</span>);</span><br></pre></td></tr></table></figure><blockquote><p>重点关注字段</p></blockquote><table><thead><tr><th>字段</th><th>含义</th><th>解释</th></tr></thead><tbody><tr><td><code>num_docs</code></td><td><strong>当前被索引、可被搜索的文档数量</strong></td><td>user:10001 ~ user:10010，10条文档</td></tr><tr><td><code>num_terms</code></td><td><strong>词典中唯一词项 term 的数量</strong><br><strong>主要来源于 TEXT（name） 和 TAG（vip, status） 字段去重之后的数量</strong></td><td>name: alice, bob, carol, …<br>vip: yes, no<br>status: PAID, CREATED, CANCELLED<br></td></tr><tr><td><code>num_records</code></td><td><strong>倒排索引中的记录条目总数</strong><br><strong>所有 term 在所有文档中的出现次数之和</strong></td><td>JSON 数组字段 orders[],每个 order 都会生成独立的索引 entry<br>多值字段 × 多文档 = record 爆炸式增长<br><br>num_records 真正影响：内存、查询速度、聚合成本</td></tr></tbody></table><h4 id="5️⃣-FT-LIST">5️⃣ FT._LIST</h4><blockquote><p>列出所有索引</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FT._LIST</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; indexes = rSearch.getIndexes();</span><br></pre></td></tr></table></figure><h3 id="二、查询类（核心）">二、查询类（核心）</h3><table><thead><tr><th>命令</th><th>作用</th><th>适用场景</th></tr></thead><tbody><tr><td><code>FT.SEARCH</code></td><td>标准搜索</td><td>90% 场景</td></tr><tr><td><code>FT.AGGREGATE</code></td><td>分组 / 统计 / 聚合</td><td>报表、分析</td></tr><tr><td><code>FT.HYBRID</code></td><td>文本 + 向量混合</td><td>向量搜索</td></tr><tr><td><code>FT.EXPLAIN</code></td><td>查询执行计划</td><td>调优</td></tr><tr><td><code>FT.EXPLAINCLI</code></td><td>CLI 可读执行计划</td><td>调试</td></tr><tr><td><code>FT.PROFILE</code></td><td>性能分析</td><td>慢查询</td></tr></tbody></table><h4 id="1️⃣-FT-SEARCH">1️⃣ FT.SEARCH</h4><ul class="lvl-0"><li class="lvl-2"><p>FT.SEARCH 基本语法</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">FT.SEARCH index query</span><br><span class="line">[NOCOENTENT] [VERBATIM] [NOSTOPWORDS]</span><br><span class="line">[WITHSCORES] [WITHPAYLOADS] [WITHSORTKEYS]</span><br><span class="line">[FILTER numeric_field min max ...]</span><br><span class="line">[GEOFILTER geo_field lon lat radius m|km|mi|ft]</span><br><span class="line">[INKEYS count key ...]</span><br><span class="line">[INFIELDS count field ...]</span><br><span class="line">[RETURN count identifier [AS property] ...]</span><br><span class="line">[SUMMARIZE FIELDS count field ... FRAGS num LEN fragsize SEPARATOR sep]</span><br><span class="line">[HIGHLIGHT FIELDS count field ... TAGS open close]</span><br><span class="line">[SLOP slop] [TIMEOUT <span class="built_in">timeout</span>] [INORDER]</span><br><span class="line">[LANGUAGE language]</span><br><span class="line">[EXPANDER expander]</span><br><span class="line">[SCORER scorer]</span><br><span class="line">[EXPLAINSCORE]</span><br><span class="line">[PAYLOAD payload]</span><br><span class="line">[SORTBY sortby ASC|DESC]</span><br><span class="line">[LIMIT offset num]</span><br><span class="line">[PARAMS nargs name value ...]</span><br><span class="line">[DIALECT dialect]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>FT.SEARCH 参数说明表</p></li></ul><table><thead><tr><th>参数</th><th>作用说明</th></tr></thead><tbody><tr><td><code>index</code></td><td>索引名称</td></tr><tr><td><code>query</code></td><td>查询条件（类似 SQL WHERE）</td></tr><tr><td><code>NOCONTENT</code></td><td>仅返回文档 ID，不返回内容</td></tr><tr><td><code>VERBATIM</code></td><td>禁用查询优化，完全按原查询执行</td></tr><tr><td><code>NOSTOPWORDS</code></td><td>查询时不忽略停用词</td></tr><tr><td><code>WITHSCORES</code></td><td>返回匹配文档的相关性评分</td></tr><tr><td><code>WITHPAYLOADS</code></td><td>返回文档的 payload 数据</td></tr><tr><td><code>WITHSORTKEYS</code></td><td>返回排序使用的 key</td></tr><tr><td><code>FILTER</code></td><td>数值字段过滤（范围查询）</td></tr><tr><td><code>GEOFILTER</code></td><td>地理位置范围查询</td></tr><tr><td><code>INKEYS</code></td><td>仅在指定的 key 集合中搜索</td></tr><tr><td><code>INFIELDS</code></td><td>仅在指定字段中搜索</td></tr><tr><td><code>RETURN</code></td><td>指定返回的字段</td></tr><tr><td><code>SUMMARIZE</code></td><td>返回字段内容摘要</td></tr><tr><td><code>HIGHLIGHT</code></td><td>高亮匹配的关键词</td></tr><tr><td><code>SLOP</code></td><td>设置短语查询中允许的词距</td></tr><tr><td><code>TIMEOUT</code></td><td>设置查询超时时间</td></tr><tr><td><code>INORDER</code></td><td>短语必须按顺序匹配</td></tr><tr><td><code>LANGUAGE</code></td><td>指定查询语言</td></tr><tr><td><code>EXPANDER</code></td><td>使用自定义查询扩展器</td></tr><tr><td><code>SCORER</code></td><td>使用自定义评分函数</td></tr><tr><td><code>EXPLAINSCORE</code></td><td>返回评分计算详情</td></tr><tr><td><code>PAYLOAD</code></td><td>给评分函数传入自定义参数</td></tr><tr><td><code>SORTBY</code></td><td>按指定字段排序</td></tr><tr><td><code>ASC / DESC</code></td><td>排序方向</td></tr><tr><td><code>LIMIT</code></td><td>分页控制</td></tr><tr><td><code>PARAMS</code></td><td>参数化查询</td></tr><tr><td><code>DIALECT</code></td><td>指定查询语法版本</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>FT.SEARCH 核心语法</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FT.SEARCH index</span><br><span class="line">query</span><br><span class="line">[RETURN count identifier [AS property] ...]</span><br><span class="line">[SORTBY sortby ASC|DESC]</span><br><span class="line">[LIMIT offset num]</span><br></pre></td></tr></table></figure><blockquote><p>标准搜索</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">FT.SEARCH idx:user</span><br><span class="line">  <span class="string">&#x27;@status:&#123;PAID&#125; @amount:[50 +inf]&#x27;</span></span><br><span class="line">  RETURN 3 name status amount</span><br><span class="line">  SORTBY amount DESC</span><br><span class="line">  LIMIT 0 10</span><br><span class="line"><span class="comment">## 参数说明</span></span><br><span class="line">  <span class="comment"># 查询条件：&#x27;@status:&#123;PAID&#125; @amount:[50 +inf]&#x27;</span></span><br><span class="line">  <span class="comment"># 查询条件语法：</span></span><br><span class="line">  <span class="comment"># &#x27;xxx&#x27;: 全文检索包含 xxx 的数据，会从 TEXT 字段中匹配</span></span><br><span class="line">  <span class="comment"># &#x27;@field:value&#x27;: 匹配字段 field 的值是 value，要求 field 的类型为 TEXT，全文检索</span></span><br><span class="line">  <span class="comment"># &#x27;@field:&#123;xxx&#125;&#x27;:精确匹配，&#123;xxx*&#125;:匹配前缀，&#123;xxx|yyy&#125;:匹配任意一个，要求 field 的类型为 TAG</span></span><br><span class="line">  <span class="comment"># &#x27;@field:[min max]&#x27;: 范围匹配，这里 +inf 表示正无穷大，要求 field 的类型为 NUMERIC</span></span><br><span class="line">  <span class="comment"># 多个条件空格分隔</span></span><br><span class="line">  <span class="comment"># 模糊匹配：* 表示任意字符，即匹配所有</span></span><br><span class="line"><span class="comment"># RETURN 3 name status amount 返回字段，3:表示返回 3 个字段</span></span><br><span class="line"><span class="comment"># LIMIT 0 10 分页，0:表示从第 0 条开始，10:表示返回 10 条数据</span></span><br><span class="line"><span class="comment"># SORTBY amount DESC 排序，amount:表示排序字段，DESC:表示降序</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SearchResult</span> <span class="variable">result</span> <span class="operator">=</span> rSearch.search(</span><br><span class="line">        <span class="string">&quot;idx:user&quot;</span>,</span><br><span class="line">        <span class="string">&quot;@status:&#123;PAID&#125; @amount:[50 +inf]&quot;</span>,</span><br><span class="line">        QueryOptions.defaults()</span><br><span class="line">        .returnAttributes(<span class="keyword">new</span> <span class="title class_">ReturnAttribute</span>(<span class="string">&quot;name&quot;</span>), <span class="keyword">new</span> <span class="title class_">ReturnAttribute</span>(<span class="string">&quot;status&quot;</span>),<span class="keyword">new</span> <span class="title class_">ReturnAttribute</span>(<span class="string">&quot;amount&quot;</span>))</span><br><span class="line">                .sortBy(<span class="string">&quot;amount&quot;</span>)</span><br><span class="line">                .sortOrder(SortOrder.DESC)</span><br><span class="line">                .limit(<span class="number">0</span>, <span class="number">10</span>));</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> result.getTotal();</span><br><span class="line">System.out.println(<span class="string">&quot;total = &quot;</span> + total);</span><br><span class="line">List&lt;Document&gt; docs = result.getDocuments();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (Document doc: docs) &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> doc.getId();</span><br><span class="line">    Map&lt;String, Object&gt; attrs = doc.getAttributes();</span><br><span class="line">    System.out.println(<span class="string">&quot;id = &quot;</span> + id + <span class="string">&quot; attrs = &quot;</span> + attrs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全文检索，从 所有 TEXT 字段中匹配，不区分大小写，即 phone/Phone/PHONE 都匹配</span></span><br><span class="line">FT.SEARCH idx:user <span class="string">&#x27;phone&#x27;</span></span><br><span class="line"><span class="comment">## 示例结果</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 2</span><br><span class="line">2) <span class="string">&quot;user:10006&quot;</span></span><br><span class="line">3) 1) <span class="string">&quot;$&quot;</span></span><br><span class="line">   2) <span class="string">&quot;&#123;\&quot;name\&quot;:\&quot;Frank\&quot;,\&quot;age\&quot;:27,\&quot;vip\&quot;:\&quot;no\&quot;,\&quot;orders\&quot;:[&#123;\&quot;amount\&quot;:499,\&quot;status\&quot;:\&quot;PAID\&quot;&#125;,&#123;\&quot;amount\&quot;:129,\&quot;status\&quot;:\&quot;CREATED\&quot;&#125;],\&quot;comment\&quot;:\&quot;I have a phone\&quot;,\&quot;items\&quot;:[\&quot;Redis\xe5\xbc\x80\xe5\x8f\x91\xe5\xae\x9e\xe6\x88\x98\&quot;,\&quot;MongoDB\xe4\xbb\x8e\xe5\x85\xa5\xe9\x97\xa8\xe5\x88\xb0\xe5\xae\x9e\xe6\x88\x98\&quot;]&#125;&quot;</span></span><br><span class="line">4) <span class="string">&quot;user:10001&quot;</span></span><br><span class="line">5) 1) <span class="string">&quot;$&quot;</span></span><br><span class="line">   2) <span class="string">&quot;&#123;\&quot;name\&quot;:\&quot;Alice Bob\&quot;,\&quot;age\&quot;:28,\&quot;vip\&quot;:\&quot;yes\&quot;,\&quot;orders\&quot;:[&#123;\&quot;amount\&quot;:199.99,\&quot;status\&quot;:\&quot;PAID\&quot;&#125;,&#123;\&quot;amount\&quot;:59.9,\&quot;status\&quot;:\&quot;CREATED\&quot;&#125;],\&quot;comment\&quot;:\&quot;I have a phone\&quot;,\&quot;items\&quot;:[\&quot;SpringCloud\xe6\x8a\x80\xe6\x9c\xaf\xe6\x8c\x87\xe5\x8d\x97\&quot;,\&quot;Shell\xe8\x84\x9a\xe6\x9c\xac\xe5\x9f\xba\xe7\xa1\x80\&quot;]&#125;&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SearchResult</span> <span class="variable">result</span> <span class="operator">=</span> rSearch.search(</span><br><span class="line">        <span class="string">&quot;idx:user&quot;</span>,</span><br><span class="line">        <span class="string">&quot;phone&quot;</span>,</span><br><span class="line">        QueryOptions.defaults()</span><br><span class="line">);</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 中文检索</span></span><br><span class="line">FT.SEARCH idx:user <span class="string">&#x27;开始&#x27;</span></span><br><span class="line"><span class="comment">## 示例结果</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 2</span><br><span class="line">2) <span class="string">&quot;user:10005&quot;</span></span><br><span class="line">3) 1) <span class="string">&quot;$&quot;</span></span><br><span class="line">   2) <span class="string">&quot;&#123;\&quot;name\&quot;:\&quot;Eve\&quot;,\&quot;age\&quot;:30,\&quot;vip\&quot;:\&quot;no\&quot;,\&quot;orders\&quot;:[&#123;\&quot;amount\&quot;:88.8,\&quot;status\&quot;:\&quot;CREATED\&quot;&#125;],\&quot;comment\&quot;:\&quot;I have a pencil\&quot;,\&quot;items\&quot;:[\&quot;Kafka\xe4\xbb\x8e\xe9\x9b\xb6\xe5\xbc\x80\xe5\xa7\x8b\&quot;,\&quot;Java\xe7\x94\xb1\xe6\xb5\x85\xe5\x85\xa5\xe6\xb7\xb1\&quot;]&#125;&quot;</span></span><br><span class="line">4) <span class="string">&quot;user:10007&quot;</span></span><br><span class="line">5) 1) <span class="string">&quot;$&quot;</span></span><br><span class="line">   2) <span class="string">&quot;&#123;\&quot;name\&quot;:\&quot;Grace\&quot;,\&quot;age\&quot;:33,\&quot;vip\&quot;:\&quot;yes\&quot;,\&quot;orders\&quot;:[&#123;\&quot;amount\&quot;:999.9,\&quot;status\&quot;:\&quot;PAID\&quot;&#125;],\&quot;comment\&quot;:\&quot;I have a book\&quot;,\&quot;items\&quot;:[\&quot;Android\xe5\xbc\x80\xe5\x8f\x91\xe6\x89\x8b\xe5\x86\x8c\&quot;,\&quot;Gradle\xe4\xbb\x8e\xe9\x9b\xb6\xe5\xbc\x80\xe5\xa7\x8b\&quot;]&#125;&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SearchResult</span> <span class="variable">result</span> <span class="operator">=</span> rSearch.search(</span><br><span class="line">        <span class="string">&quot;idx:user&quot;</span>,</span><br><span class="line">        <span class="string">&quot;开始&quot;</span>,</span><br><span class="line">        QueryOptions.defaults()</span><br><span class="line">);</span><br></pre></td></tr></table></figure><div class="tips"><p><em><strong>小贴士</strong></em></p><ul class="lvl-1"><li class="lvl-2">看到中文输出是乱码，可以在登录客户端时加上 --raw</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --user admin -a 123456 --raw</span><br><span class="line">127.0.0.1:6379&gt; FT.SEARCH idx:user <span class="string">&#x27;开始&#x27;</span></span><br><span class="line">2</span><br><span class="line">user:10005</span><br><span class="line">$</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;Eve&quot;</span>,<span class="string">&quot;age&quot;</span>:30,<span class="string">&quot;vip&quot;</span>:<span class="string">&quot;no&quot;</span>,<span class="string">&quot;orders&quot;</span>:[&#123;<span class="string">&quot;amount&quot;</span>:88.8,<span class="string">&quot;status&quot;</span>:<span class="string">&quot;CREATED&quot;</span>&#125;],<span class="string">&quot;comment&quot;</span>:<span class="string">&quot;I have a pencil&quot;</span>,<span class="string">&quot;items&quot;</span>:[<span class="string">&quot;Kafka从零开始&quot;</span>,<span class="string">&quot;Java由浅入深&quot;</span>]&#125;</span><br><span class="line">user:10007</span><br><span class="line">$</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;Grace&quot;</span>,<span class="string">&quot;age&quot;</span>:33,<span class="string">&quot;vip&quot;</span>:<span class="string">&quot;yes&quot;</span>,<span class="string">&quot;orders&quot;</span>:[&#123;<span class="string">&quot;amount&quot;</span>:999.9,<span class="string">&quot;status&quot;</span>:<span class="string">&quot;PAID&quot;</span>&#125;],<span class="string">&quot;comment&quot;</span>:<span class="string">&quot;I have a book&quot;</span>,<span class="string">&quot;items&quot;</span>:[<span class="string">&quot;Android开发手册&quot;</span>,<span class="string">&quot;Gradle从零开始&quot;</span>]&#125;</span><br></pre></td></tr></table></figure></div><h5 id="SQL-WHERE-与-RediSearch-查询语法对照表">SQL WHERE 与 RediSearch 查询语法对照表</h5><ul class="lvl-0"><li class="lvl-2"><p><code>x/y/name</code> → <code>TEXT/TAG(要加上&#123;&#125;)</code> 字段，<code>num</code>→<code>NUMERIC</code> 字段，查询语法用于 <code>FT.SEARCH</code>/<code>FT.AGGREGATE</code> 的查询字符串部分</p></li></ul><table><thead><tr><th>ID</th><th>SQL 条件</th><th>RediSearch 对等写法</th><th>说明</th></tr></thead><tbody><tr><td>1</td><td><code>WHERE x = 'book' AND y = 'phone'</code></td><td><code>@x:book @y:phone</code></td><td>AND 为默认关系（空格）</td></tr><tr><td>2</td><td><code>WHERE x = 'book' AND y != 'phone'</code></td><td><code>@x:book -@y:phone</code></td><td><code>-</code> 表示 NOT</td></tr><tr><td>3</td><td><code>WHERE x = 'book' OR y = 'phone'</code></td><td><code>(@x:book) | (@y:phone)</code></td><td>OR 必须显式写 <code>|</code></td></tr><tr><td>4</td><td><code>WHERE x IN ('book','phone','hello world')</code></td><td><code>@x:(book|phone|&quot;hello world&quot;)</code></td><td>多值 OR，短语需加引号</td></tr><tr><td>5</td><td><code>WHERE y='book' AND x NOT IN ('book','phone')</code></td><td><code>@y:book -(@x:book|@x:phone)</code></td><td>NOT IN = NOT + OR</td></tr><tr><td>6</td><td><code>WHERE x NOT IN ('book','phone')</code></td><td><code>-@x:(book|phone)</code></td><td>整体否定</td></tr><tr><td>7</td><td><code>WHERE num BETWEEN 10 AND 20</code></td><td><code>@num:[10 20]</code></td><td>数值区间（闭区间）</td></tr><tr><td>8</td><td><code>WHERE num &gt;= 10</code></td><td><code>@num:[10 +inf]</code></td><td><code>+inf</code> 表示正无穷</td></tr><tr><td>9</td><td><code>WHERE num &gt; 10</code></td><td><code>@num:[(10 +inf]</code></td><td><code>(</code> 表示不包含</td></tr><tr><td>10</td><td><code>WHERE num &lt; 10</code></td><td><code>@num:[-inf (10]</code></td><td>小于（不含 10）</td></tr><tr><td>11</td><td><code>WHERE num &lt;= 10</code></td><td><code>@num:[-inf 10]</code></td><td>小于等于</td></tr><tr><td>12</td><td><code>WHERE num &lt; 10 OR num &gt; 20</code></td><td><code>@num:[-inf (10] | @num:[(20 +inf]</code></td><td>数值 OR</td></tr><tr><td>13</td><td><code>WHERE name LIKE 'Li%'</code></td><td><code>@name:Li*</code></td><td>前缀匹配</td></tr></tbody></table><h4 id="2️⃣-FT-AGGREGATE">2️⃣ FT.AGGREGATE</h4><blockquote><p>分组 / 统计 / 聚合，语法</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>FT.AGGREGATE 基本语法</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">FT.AGGREGATE index query</span><br><span class="line">[VERBATIM]</span><br><span class="line">[LOAD count field ... | LOAD *]</span><br><span class="line">[TIMEOUT <span class="built_in">timeout</span>]</span><br><span class="line">[GROUPBY nargs property ...</span><br><span class="line">   REDUCE <span class="keyword">function</span> nargs arg ... [AS name] ...]</span><br><span class="line">[SORTBY nargs property ASC|DESC ... [MAX num]]</span><br><span class="line">[APPLY expression AS name]</span><br><span class="line">[LIMIT offset num]</span><br><span class="line">[FILTER filter]</span><br><span class="line">[WITHCURSOR [COUNT read_size]]</span><br><span class="line">[MAXIDLE idle_time]</span><br><span class="line">[PARAMS nargs name value ...]</span><br><span class="line">[DIALECT dialect]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>FT.AGGREGATE 参数说明表</p></li></ul><table><thead><tr><th>参数</th><th>作用说明</th></tr></thead><tbody><tr><td><code>index</code></td><td>索引名称</td></tr><tr><td><code>query</code></td><td>查询条件（类似 WHERE）</td></tr><tr><td><code>VERBATIM</code></td><td>禁用查询优化</td></tr><tr><td><code>LOAD</code></td><td>加载原始字段</td></tr><tr><td><code>TIMEOUT</code></td><td>查询超时时间</td></tr><tr><td><code>GROUPBY</code></td><td>分组字段（类似 SQL GROUP BY）</td></tr><tr><td><code>REDUCE</code></td><td>聚合函数（COUNT / SUM / AVG / MIN / MAX 等）</td></tr><tr><td><code>AS</code></td><td>聚合结果别名</td></tr><tr><td><code>SORTBY</code></td><td>对聚合结果排序</td></tr><tr><td><code>ASC / DESC</code></td><td>排序方向</td></tr><tr><td><code>MAX</code></td><td>最大返回条数</td></tr><tr><td><code>APPLY</code></td><td>对结果字段进行表达式计算</td></tr><tr><td><code>LIMIT</code></td><td>分页控制</td></tr><tr><td><code>FILTER</code></td><td>结果过滤（WHERE / HAVING）</td></tr><tr><td><code>WITHCURSOR</code></td><td>使用游标（大结果集）</td></tr><tr><td><code>COUNT</code></td><td>每次读取数量</td></tr><tr><td><code>MAXIDLE</code></td><td>游标最大空闲时间</td></tr><tr><td><code>PARAMS</code></td><td>参数化查询</td></tr><tr><td><code>DIALECT</code></td><td>查询语法版本</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>FT.AGGREGATE 的核心语法</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FT.AGGREGATE &lt;index&gt; &lt;query&gt;</span><br><span class="line">  [GROUPBY ...]</span><br><span class="line">  [REDUCE ...]</span><br><span class="line">  [SORTBY ...]</span><br><span class="line">  [LIMIT ...]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>示例 1：按 status 分组统计数量</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">FT.AGGREGATE idx:user</span><br><span class="line">  <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  GROUPBY 1 @status</span><br><span class="line">  REDUCE COUNT 0 AS cnt</span><br><span class="line"><span class="comment">## 参数说明</span></span><br><span class="line"><span class="comment"># *: 查询条件，* 表示匹配索引中的 所有文档，也可以是 FT.SEARCH 中的查询条件，比如：&#x27;@status:&#123;PAID&#125; @amount:[50 +inf]&#x27;</span></span><br><span class="line"><span class="comment"># GROUPBY 1 @status: 分组字段</span></span><br><span class="line">  <span class="comment"># 1:表示分组字段数量</span></span><br><span class="line">  <span class="comment"># @status:表示分组字段</span></span><br><span class="line"><span class="comment"># REDUCE COUNT 0 AS cnt: 聚合字段</span></span><br><span class="line">  <span class="comment"># COUNT:聚合函数：计数</span></span><br><span class="line">  <span class="comment"># 0:参数个数（COUNT 不需要参数）</span></span><br><span class="line">  <span class="comment"># AS cnt:表示聚合字段别名</span></span><br><span class="line"><span class="comment">## 返回结果示例</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 3</span><br><span class="line">2) 1) <span class="string">&quot;status&quot;</span></span><br><span class="line">   2) <span class="string">&quot;CANCELLED&quot;</span></span><br><span class="line">   3) <span class="string">&quot;cnt&quot;</span></span><br><span class="line">   4) <span class="string">&quot;2&quot;</span></span><br><span class="line">3) 1) <span class="string">&quot;status&quot;</span></span><br><span class="line">   2) <span class="string">&quot;PAID&quot;</span></span><br><span class="line">   3) <span class="string">&quot;cnt&quot;</span></span><br><span class="line">   4) <span class="string">&quot;6&quot;</span></span><br><span class="line">4) 1) <span class="string">&quot;status&quot;</span></span><br><span class="line">   2) <span class="string">&quot;CREATED&quot;</span></span><br><span class="line">   3) <span class="string">&quot;cnt&quot;</span></span><br><span class="line">   4) <span class="string">&quot;2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对应SQL 语句：</span></span><br><span class="line">SELECT status, COUNT(*) AS cnt</span><br><span class="line">  FROM user</span><br><span class="line">  GROUP BY status;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AggregationResult</span> <span class="variable">result</span> <span class="operator">=</span> rSearch.aggregate(</span><br><span class="line">        <span class="string">&quot;idx:user&quot;</span>,</span><br><span class="line">        <span class="string">&quot;*&quot;</span>,</span><br><span class="line">        AggregationOptions.defaults()</span><br><span class="line">                .groupBy(GroupBy.fieldNames(<span class="string">&quot;@status&quot;</span>).reducers(Reducer.count().as(<span class="string">&quot;cnt&quot;</span>)))</span><br><span class="line">);</span><br><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> result.getTotal();</span><br><span class="line">System.out.println(<span class="string">&quot;total = &quot;</span> + total);</span><br><span class="line"><span class="keyword">final</span> List&lt;Map&lt;String, Object&gt;&gt; attributes = result.getAttributes();</span><br><span class="line"><span class="keyword">for</span> (Map&lt;String, Object&gt; attribute : attributes) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;attribute = &quot;</span> + attribute);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>示例 2：按 status 分组统计金额总和</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">FT.AGGREGATE idx:user <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  GROUPBY 1 @status</span><br><span class="line">  REDUCE SUM 1 @amount AS total_amount</span><br><span class="line">  SORTBY 2 @total_amount DESC</span><br><span class="line">  LIMIT 0 3</span><br><span class="line"></span><br><span class="line"><span class="comment">## 参数说明</span></span><br><span class="line"><span class="comment"># SUM:聚合函数：求和</span></span><br><span class="line"><span class="comment"># 1:参数个数</span></span><br><span class="line"><span class="comment"># @amount:要参与求和的字段</span></span><br><span class="line"><span class="comment"># total_amount:表示聚合字段别名</span></span><br><span class="line"><span class="comment"># SORTBY 2 @total_amount DESC: 排序</span></span><br><span class="line">  <span class="comment"># 2: 表示后面跟 2 个参数（字段 + 排序方向）</span></span><br><span class="line">  <span class="comment"># @total_amount: 表示排序字段（REDUCE 产生的别名），DESC:表示降序</span></span><br><span class="line"><span class="comment"># LIMIT 0 3: 分页，0:表示从第 0 条开始，3:表示返回 3 条数据</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 示例结果</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 3</span><br><span class="line">2) 1) <span class="string">&quot;status&quot;</span></span><br><span class="line">   2) <span class="string">&quot;PAID&quot;</span></span><br><span class="line">   3) <span class="string">&quot;total_amount&quot;</span></span><br><span class="line">   4) <span class="string">&quot;4096.89&quot;</span></span><br><span class="line">3) 1) <span class="string">&quot;status&quot;</span></span><br><span class="line">   2) <span class="string">&quot;CREATED&quot;</span></span><br><span class="line">   3) <span class="string">&quot;total_amount&quot;</span></span><br><span class="line">   4) <span class="string">&quot;238.8&quot;</span></span><br><span class="line">4) 1) <span class="string">&quot;status&quot;</span></span><br><span class="line">   2) <span class="string">&quot;CANCELLED&quot;</span></span><br><span class="line">   3) <span class="string">&quot;total_amount&quot;</span></span><br><span class="line">   4) <span class="string">&quot;79.8&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对应SQL 语句：</span></span><br><span class="line">SELECT status, SUM(amount) AS total_amount</span><br><span class="line">  FROM user</span><br><span class="line">  GROUP BY status</span><br><span class="line">  ORDER BY total_amount DESC</span><br><span class="line">  LIMIT 0 3;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AggregationResult</span> <span class="variable">result</span> <span class="operator">=</span> rSearch.aggregate(</span><br><span class="line">        <span class="string">&quot;idx:user&quot;</span>,</span><br><span class="line">        <span class="string">&quot;*&quot;</span>,</span><br><span class="line">        AggregationOptions.defaults()</span><br><span class="line">                .groupBy(GroupBy.fieldNames(<span class="string">&quot;@status&quot;</span>)</span><br><span class="line">                        .reducers(</span><br><span class="line">                                Reducer.sum(<span class="string">&quot;@amount&quot;</span>).as(<span class="string">&quot;total_amount&quot;</span>)</span><br><span class="line">                        )</span><br><span class="line">                )</span><br><span class="line">                .sortBy(<span class="keyword">new</span> <span class="title class_">SortedField</span>(<span class="string">&quot;@total_amount&quot;</span>, SortOrder.DESC))</span><br><span class="line">                .limit(<span class="number">0</span>, <span class="number">3</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>示例 3：同时输出数量 + 金额，并按金额降序，数量升序</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">FT.AGGREGATE idx:user <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  GROUPBY 1 @status</span><br><span class="line">  REDUCE COUNT 0 AS cnt</span><br><span class="line">  REDUCE SUM 1 @amount AS total_amount</span><br><span class="line">  SORTBY 4 @total_amount DESC @cnt ASC</span><br><span class="line"></span><br><span class="line"><span class="comment">## 示例结果</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 3</span><br><span class="line">2) 1) <span class="string">&quot;status&quot;</span></span><br><span class="line">   2) <span class="string">&quot;PAID&quot;</span></span><br><span class="line">   3) <span class="string">&quot;cnt&quot;</span></span><br><span class="line">   4) <span class="string">&quot;6&quot;</span></span><br><span class="line">   5) <span class="string">&quot;total_amount&quot;</span></span><br><span class="line">   6) <span class="string">&quot;4096.89&quot;</span></span><br><span class="line">3) 1) <span class="string">&quot;status&quot;</span></span><br><span class="line">   2) <span class="string">&quot;CREATED&quot;</span></span><br><span class="line">   3) <span class="string">&quot;cnt&quot;</span></span><br><span class="line">   4) <span class="string">&quot;2&quot;</span></span><br><span class="line">   5) <span class="string">&quot;total_amount&quot;</span></span><br><span class="line">   6) <span class="string">&quot;238.8&quot;</span></span><br><span class="line">4) 1) <span class="string">&quot;status&quot;</span></span><br><span class="line">   2) <span class="string">&quot;CANCELLED&quot;</span></span><br><span class="line">   3) <span class="string">&quot;cnt&quot;</span></span><br><span class="line">   4) <span class="string">&quot;2&quot;</span></span><br><span class="line">   5) <span class="string">&quot;total_amount&quot;</span></span><br><span class="line">   6) <span class="string">&quot;79.8&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AggregationResult</span> <span class="variable">result</span> <span class="operator">=</span> rSearch.aggregate(</span><br><span class="line">        <span class="string">&quot;idx:user&quot;</span>,</span><br><span class="line">        <span class="string">&quot;*&quot;</span>,</span><br><span class="line">        AggregationOptions.defaults()</span><br><span class="line">                .groupBy(GroupBy.fieldNames(<span class="string">&quot;@status&quot;</span>)</span><br><span class="line">                        .reducers(</span><br><span class="line">                                Reducer.count().as(<span class="string">&quot;cnt&quot;</span>),</span><br><span class="line">                                Reducer.sum(<span class="string">&quot;@amount&quot;</span>).as(<span class="string">&quot;total_amount&quot;</span>)</span><br><span class="line">                        )</span><br><span class="line">                )</span><br><span class="line">                .sortBy(<span class="keyword">new</span> <span class="title class_">SortedField</span>(<span class="string">&quot;@total_amount&quot;</span>, SortOrder.DESC))</span><br><span class="line">                .sortBy(<span class="keyword">new</span> <span class="title class_">SortedField</span>(<span class="string">&quot;@cnt&quot;</span>, SortOrder.ASC))</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>示例 4：按状态分组，筛选总金额 &gt; 200</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FT.AGGREGATE idx:user <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  GROUPBY 1 @status</span><br><span class="line">  REDUCE SUM 1 @amount AS total_amount</span><br><span class="line">  FILTER @total_amount &gt; 200</span><br><span class="line">  SORTBY 2 @total_amount DESC</span><br><span class="line"><span class="comment">## 参数说明</span></span><br><span class="line"><span class="comment"># FILTER: 过滤器，作用在 GROUPBY + REDUCE 之后，语义等价于 SQL 的：HAVING SUM(amount) &gt; 1000</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AggregationResult</span> <span class="variable">result</span> <span class="operator">=</span> rSearch.aggregate(</span><br><span class="line">        <span class="string">&quot;idx:user&quot;</span>,</span><br><span class="line">        <span class="string">&quot;*&quot;</span>,</span><br><span class="line">        AggregationOptions.defaults()</span><br><span class="line">                .groupBy(GroupBy.fieldNames(<span class="string">&quot;@status&quot;</span>)</span><br><span class="line">                        .reducers(</span><br><span class="line">                                Reducer.sum(<span class="string">&quot;@amount&quot;</span>).as(<span class="string">&quot;total_amount&quot;</span>)</span><br><span class="line">                        )</span><br><span class="line">                )</span><br><span class="line">                .filter(<span class="string">&quot;@total_amount &gt; 200&quot;</span>)</span><br><span class="line">                .sortBy(<span class="keyword">new</span> <span class="title class_">SortedField</span>(<span class="string">&quot;@total_amount&quot;</span>, SortOrder.DESC))</span><br><span class="line">);</span><br></pre></td></tr></table></figure><blockquote><p>语义执行顺序： SCAN → GROUPBY → REDUCE → FILTER (HAVING) → SORTBY → LIMIT</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>常见可用 REDUCE 函数</p></li></ul><table><thead><tr><th>函数</th><th>用途</th></tr></thead><tbody><tr><td>COUNT</td><td>行数</td></tr><tr><td>SUM</td><td>求和</td></tr><tr><td>AVG</td><td>平均</td></tr><tr><td>MIN / MAX</td><td>极值</td></tr><tr><td>TO_LIST</td><td>收集字段</td></tr></tbody></table><h4 id="3️⃣-FT-EXPLAIN-FT-EXPLAINCLI">3️⃣ FT.EXPLAIN/FT.EXPLAINCLI</h4><blockquote><p>查询执行计划， 不会考虑分组聚合，只看查询条件，它的定位是：看“会不会用索引、怎么用索引”，而不是看“跑得慢不慢”。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">FT.EXPLAINCLI idx:user <span class="string">&#x27;@status:&#123;PAID&#125;  @amount:[100 +inf]&#x27;</span></span><br><span class="line"><span class="comment">## 示例结果</span></span><br><span class="line">1) INTERSECT &#123;</span><br><span class="line">2)   TAG:@status &#123;</span><br><span class="line">3)     paid</span><br><span class="line">4)   &#125;</span><br><span class="line">5)   NUMERIC &#123;100.000000 &lt;= @amount &lt;= inf&#125;</span><br><span class="line">6) &#125;</span><br><span class="line">7)</span><br></pre></td></tr></table></figure><h4 id="4️⃣-FT-PROFILE">4️⃣ FT.PROFILE</h4><blockquote><p>性能分析，看“跑得慢不慢”。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FT.PROFILE idx:user</span><br><span class="line">  SEARCH</span><br><span class="line">  QUERY <span class="string">&#x27;@status:&#123;PAID&#125;  @amount:[100 +inf]&#x27;</span></span><br><span class="line"><span class="comment">## 参数说明</span></span><br><span class="line"><span class="comment"># SEARCH: 标准查询，AGGREGATE: 聚合查询</span></span><br><span class="line"><span class="comment"># QUERY: 查询条件</span></span><br><span class="line"></span><br><span class="line">FT.PROFILE idx:user</span><br><span class="line">  AGGREGATE</span><br><span class="line">  QUERY <span class="string">&quot;@status:&#123;PAID&#125; @amount:[100 +inf]&quot;</span></span><br><span class="line">  GROUPBY 1 @status</span><br><span class="line">  REDUCE SUM 1 @amount AS total_amount</span><br></pre></td></tr></table></figure><h5 id="关注指标">关注指标</h5><ul class="lvl-0"><li class="lvl-2"><p>第一优先级指标（直接决定查询是否慢）</p></li></ul><table><thead><tr><th>指标</th><th>所在位置</th><th>含义</th><th>健康阈值</th><th>需要警惕</th><th>常见优化手段</th></tr></thead><tbody><tr><td><strong>Total profile time</strong></td><td>Shards → Total profile time</td><td>查询在搜索引擎层面的总耗时（不含网络）</td><td><strong>&lt; 1 ms：优秀</strong><br>1–10 ms：可接受</td><td>&gt; 20 ms：需要优化<br>&gt; 50 ms：结构性问题</td><td>减少结果集、拆分查询、优化索引字段</td></tr><tr><td><strong>Iterator Type</strong></td><td>Iterators profile → Type</td><td>查询执行策略</td><td><strong>INTERSECT / UNION</strong></td><td><strong>SCAN / WILDCARD</strong></td><td>增加可索引字段、避免模糊前缀</td></tr><tr><td><strong>Estimated number of matches</strong></td><td>Child iterators</td><td>索引层估算的候选文档数</td><td><strong>&lt; 1k：理想</strong><br>1k–10k：可接受</td><td>&gt; 50k：过滤条件过宽</td><td>改用 TAG / NUMERIC / 冗余字段</td></tr><tr><td><strong>Loader Time</strong></td><td>Result processors → Loader</td><td>从 Redis 加载并反序列化文档</td><td>&lt; 30% Total time</td><td>&gt; 40% Total time</td><td>RETURN 精简字段、NOCONTENT、缩小 JSON</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>第二优先级指标（判断索引或模型是否合理）</p></li></ul><table><thead><tr><th>指标</th><th>所在位置</th><th>含义</th><th>健康阈值</th><th>需要警惕</th><th>常见优化手段</th></tr></thead><tbody><tr><td><strong>Number of reading operations</strong></td><td>Iterators profile</td><td>实际扫描的倒排表条目数</td><td>≈ Estimated matches</td><td>明显大于结果数</td><td>提高字段选择性、拆分条件</td></tr><tr><td><strong>Estimated matches vs 实际结果数</strong></td><td>Iterator + Result</td><td>索引估算精度</td><td>估算值略大于实际</td><td>估算 &gt;&gt; 实际（10x+）</td><td>调整 schema，避免低基数字段</td></tr><tr><td><strong>Parsing time</strong></td><td>Shards → Parsing time</td><td>查询语法解析耗时</td><td>&lt; 0.1 ms</td><td>&gt; 1 ms</td><td>减少动态拼接、简化语法</td></tr><tr><td><strong>Pipeline creation time</strong></td><td>Shards → Pipeline creation</td><td>执行计划构建时间</td><td>&lt; 0.05 ms</td><td>&gt; 0.5 ms</td><td>减少子句、避免复杂嵌套</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>经验型“红线判断”速查表（非常实用）</p></li></ul><table><thead><tr><th>现象</th><th>含义</th><th>是否必须处理</th></tr></thead><tbody><tr><td>Estimated matches &gt; 100k</td><td>索引字段选择错误</td><td>必须</td></tr><tr><td>Iterator Type = SCAN</td><td>全表扫描</td><td>必须</td></tr><tr><td>Loader &gt; 50% 总耗时</td><td>返回数据过重</td><td>强烈建议</td></tr><tr><td>reading ops ≫ results</td><td>倒排效率低</td><td>建议</td></tr><tr><td>Total time &gt; 20 ms</td><td>在线查询风险</td><td>必须</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>核心执行策略型 Iterator（最重要）</p></li></ul><table><thead><tr><th>Type</th><th>语义</th><th>典型触发场景</th><th>性能特征</th><th>调优结论</th></tr></thead><tbody><tr><td><strong>INTERSECT</strong></td><td>多条件取交集（AND）</td><td><code>@a:&#123;x&#125; @b:[1 10]</code></td><td>基于最小倒排表，效率最高</td><td><strong>理想状态，优先使用</strong></td></tr><tr><td><strong>UNION</strong></td><td>多条件取并集（OR）</td><td><code>@a:&#123;x|y&#125;</code></td><td>候选集扩大，随 OR 数量线性增长</td><td>可接受，避免过多 OR</td></tr><tr><td><strong>SCAN</strong></td><td>全量扫描</td><td>字段未索引 / JSON Path 不可索引</td><td>O(N)，文档越多越慢</td><td><strong>必须消灭</strong></td></tr><tr><td><strong>WILDCARD</strong></td><td>无过滤条件</td><td><code>&quot;*&quot;</code>、<code>@field:*</code></td><td>候选集=全部文档</td><td>仅限分析，线上慎用</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>索引访问型 Iterator（INTERSECT / UNION 的子节点）</p></li></ul><table><thead><tr><th>Type</th><th>对应字段类型</th><th>示例查询</th><th>性能特征</th><th>备注</th></tr></thead><tbody><tr><td><strong>TAG</strong></td><td>TAG</td><td><code>@status:&#123;PAID&#125;</code></td><td>哈希倒排，最快</td><td>强烈推荐</td></tr><tr><td><strong>NUMERIC</strong></td><td>NUMERIC</td><td><code>@amount:[100 +inf]</code></td><td>跳表范围扫描</td><td>范围越窄越快</td></tr><tr><td><strong>TEXT</strong></td><td>TEXT</td><td><code>@name:alice</code></td><td>分词匹配</td><td>分词数影响性能</td></tr><tr><td><strong>GEO</strong></td><td>GEO</td><td><code>@loc:[13.4 52.5 10 km]</code></td><td>空间索引</td><td>半径影响结果数</td></tr><tr><td><strong>VECTOR</strong></td><td>VECTOR</td><td><code>=&gt;[KNN 10 @v $q]</code></td><td>向量搜索</td><td>常与 FILTER 联用</td></tr><tr><td><strong>IDLIST</strong></td><td>内部</td><td>小结果集</td><td>枚举 ID</td><td>自动优化</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>逻辑 / 结构型 Iterator</p></li></ul><table><thead><tr><th>Type</th><th>含义</th><th>触发示例</th><th>性能影响</th><th>是否常见</th></tr></thead><tbody><tr><td><strong>NOT</strong></td><td>取反</td><td><code>-@status:&#123;PAID&#125;</code></td><td>依赖全集</td><td>较少</td></tr><tr><td><strong>OPTIONAL</strong></td><td>可选子句</td><td><code>( @a:&#123;x&#125; )?</code></td><td>增加候选集</td><td>少见</td></tr><tr><td><strong>EMPTY</strong></td><td>无匹配</td><td>条件不可能满足</td><td>极快</td><td>偶发</td></tr><tr><td><strong>PHRASE</strong></td><td>短语匹配</td><td><code>&quot;hello world&quot;</code></td><td>比 TEXT 慢</td><td>低频</td></tr><tr><td><strong>PREFIX</strong></td><td>前缀匹配</td><td><code>abc*</code></td><td>可能退化</td><td>需谨慎</td></tr></tbody></table><h3 id="三、别名管理（生产必备）">三、别名管理（生产必备）</h3><table><thead><tr><th>命令</th><th>作用</th></tr></thead><tbody><tr><td><code>FT.ALIASADD</code></td><td>添加别名</td></tr><tr><td><code>FT.ALIASDEL</code></td><td>删除别名</td></tr><tr><td><code>FT.ALIASUPDATE</code></td><td>更新别名指向</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>一个索引可以有多个别名，一旦创建别名，所有 FT.SEARCH / FT.AGGREGATE / <a href="http://FT.INFO">FT.INFO</a> 等命令都可以直接使用 alias</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加别名: FT.ALIASADD alias index</span></span><br><span class="line">FT.ALIASADD <span class="built_in">alias</span>:user idx:user</span><br><span class="line"><span class="comment"># 更新别名指向: FT.ALIASUPDATE alias index</span></span><br><span class="line">FT.ALIASUPDATE <span class="built_in">alias</span>:user idx:user:v2</span><br><span class="line"><span class="comment"># 删除别名: FT.ALIASDEL alias</span></span><br><span class="line">FT.ALIASDEL <span class="built_in">alias</span>:user</span><br><span class="line"><span class="comment"># 判断索引名称是否为别名</span></span><br><span class="line">FT.INFO <span class="built_in">alias</span>:user</span><br><span class="line"> 1) index_name</span><br><span class="line"> 2) idx:user  <span class="comment"># 真实索引名称</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rSearch.addAlias(<span class="string">&quot;alias:user&quot;</span>, <span class="string">&quot;idx:user&quot;</span>);</span><br><span class="line">rSearch.updateAlias(<span class="string">&quot;alias:user&quot;</span>, <span class="string">&quot;idx:user:v2&quot;</span>);</span><br><span class="line">rSearch.delAlias(<span class="string">&quot;alias:user&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="索引别名的核心价值">索引别名的核心价值</h4><ul class="lvl-0"><li class="lvl-2"><ol><li class="lvl-5">索引无损重建（最典型场景）</li></ol><ul class="lvl-2"><li class="lvl-4">RediSearch 不支持在线修改 schema，字段变更通常需要重建索引，索引重建时业务将不可用。</li><li class="lvl-4">有了别名，我们可以创建一个新的索引，创建好后将别名指向新的索引，旧索引不再使用，业务无影响。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1. 旧索引</span><br><span class="line"> FT.ALIASADD user_idx user_idx_v1</span><br><span class="line"></span><br><span class="line">2. 新建索引</span><br><span class="line">  FT.CREATE user_idx_v2 ...</span><br><span class="line"></span><br><span class="line">3. 数据回填完成后，原子切换</span><br><span class="line">  FT.ALIASUPDATE user_idx user_idx_v2</span><br><span class="line"></span><br><span class="line">4. 删除旧索引（可选）</span><br><span class="line">  FT.DROPINDEX user_idx_v1</span><br></pre></td></tr></table></figure></li><li class="lvl-2"><ol start="2"><li class="lvl-5">灰度 / 多版本并存</li></ol><ul class="lvl-2"><li class="lvl-4">不同环境（dev / staging / prod）</li><li class="lvl-4">不同 schema 版本</li></ul></li><li class="lvl-2"><ol start="3"><li class="lvl-5">运维与发布规范化（强烈推荐）</li></ol><ul class="lvl-2"><li class="lvl-4">在生产环境中：永远不要让业务代码直接使用物理索引名</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">索引真实名: 业务名_版本_时间戳</span><br><span class="line">索引别名 : 业务名</span><br></pre></td></tr></table></figure></li></ul><h3 id="四、游标（大结果集）">四、游标（大结果集）</h3><table><thead><tr><th>命令</th><th>作用</th></tr></thead><tbody><tr><td><code>FT.CURSOR READ</code></td><td>分批读取</td></tr><tr><td><code>FT.CURSOR DEL</code></td><td>删除游标</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>游标用于聚合查询（AGGREGATE）的大结果集分页/分批拉取，典型场景包括：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GROUPBY / REDUCE 后结果集很大</span><br><span class="line">需要流式处理聚合结果，避免一次性返回占用大量内存</span><br><span class="line">客户端按批消费结果（类似数据库的 server-side cursor）</span><br><span class="line">注意：游标主要用于 FT.AGGREGATE，普通 FT.SEARCH 不支持游标分页。</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>通过 <code>FT.AGGREGATE ... WITHCURSOR</code> 创建游标，通过 <code>FT.CURSOR READ</code> 获取结果。</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">FT.AGGREGATE idx:user <span class="string">&quot;*&quot;</span></span><br><span class="line">  GROUPBY 1 @status</span><br><span class="line">  REDUCE SUM 1 @amount AS total_amount</span><br><span class="line">  WITHCURSOR COUNT 2 MAXIDLE 60000</span><br><span class="line"><span class="comment">## 参数说明</span></span><br><span class="line"><span class="comment"># WITHCURSOR : 启用游标</span></span><br><span class="line"><span class="comment"># COUNT 2 : 每次从游标中返回的行数（批大小）</span></span><br><span class="line"><span class="comment"># MAXIDLE 60000 : 游标最大空闲时间（毫秒），超时后自动销毁</span></span><br><span class="line"><span class="comment">## 返回结果</span></span><br><span class="line">1) 1) (<span class="built_in">integer</span>) 3   <span class="comment"># GROUP BY 后，一共会产生 3 行聚合结果，这里返回的是实际查询的总行数，不受COUNT 参数限制</span></span><br><span class="line">   2) 1) <span class="string">&quot;status&quot;</span></span><br><span class="line">      2) <span class="string">&quot;CANCELLED&quot;</span></span><br><span class="line">      3) <span class="string">&quot;total_amount&quot;</span></span><br><span class="line">      4) <span class="string">&quot;79.8&quot;</span></span><br><span class="line">   3) 1) <span class="string">&quot;status&quot;</span></span><br><span class="line">      2) <span class="string">&quot;PAID&quot;</span></span><br><span class="line">      3) <span class="string">&quot;total_amount&quot;</span></span><br><span class="line">      4) <span class="string">&quot;4096.89&quot;</span></span><br><span class="line">2) (<span class="built_in">integer</span>) 116452546  <span class="comment"># 游标ID</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取游标</span></span><br><span class="line">FT.CURSOR READ idx:user 116452546 COUNT 2</span><br><span class="line"><span class="comment"># 参数说明</span></span><br><span class="line"><span class="comment"># 116452546 : 游标ID</span></span><br><span class="line"><span class="comment"># COUNT 2 : 每次从游标中返回的行数(可覆盖初始游标中的 COUNT）</span></span><br><span class="line"><span class="comment">## 返回结果</span></span><br><span class="line">1) 1) (<span class="built_in">integer</span>) 0   <span class="comment"># 当前游标中“剩余可读的行数”为 0</span></span><br><span class="line">   2) 1) <span class="string">&quot;status&quot;</span></span><br><span class="line">      2) <span class="string">&quot;CREATED&quot;</span></span><br><span class="line">      3) <span class="string">&quot;total_amount&quot;</span></span><br><span class="line">      4) <span class="string">&quot;238.8&quot;</span></span><br><span class="line">2) (<span class="built_in">integer</span>) 0 <span class="comment"># 0 表示没有更多结果</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 销毁游标，如果设置了 MAXIDLE 参数，则该游标在 MAXIDLE 时间内自动销毁，所以无需手工销毁</span></span><br><span class="line">FT.CURSOR DEL idx:user 116452546</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AggregationResult</span> <span class="variable">result</span> <span class="operator">=</span> rSearch.aggregate(</span><br><span class="line">        <span class="string">&quot;idx:user&quot;</span>,</span><br><span class="line">        <span class="string">&quot;*&quot;</span>,</span><br><span class="line">        AggregationOptions.defaults()</span><br><span class="line">                .groupBy(GroupBy.fieldNames(<span class="string">&quot;@status&quot;</span>)</span><br><span class="line">                        .reducers(</span><br><span class="line">                                Reducer.sum(<span class="string">&quot;@amount&quot;</span>).as(<span class="string">&quot;total_amount&quot;</span>)</span><br><span class="line">                        )</span><br><span class="line">                )</span><br><span class="line">                .withCursor(<span class="number">2</span>, <span class="number">60000</span>)</span><br><span class="line">);</span><br><span class="line"><span class="type">long</span> total;</span><br><span class="line"><span class="type">long</span> cursorId;</span><br><span class="line">List&lt;Map&lt;String, Object&gt;&gt; attributes;</span><br><span class="line"></span><br><span class="line">total = result.getTotal();</span><br><span class="line">cursorId = result.getCursorId();</span><br><span class="line">System.out.println(<span class="string">&quot;total = &quot;</span> + total);</span><br><span class="line">System.out.println(<span class="string">&quot;cursorId = &quot;</span> + cursorId);</span><br><span class="line">attributes = result.getAttributes();</span><br><span class="line"><span class="keyword">for</span> (Map&lt;String, Object&gt; attribute : attributes) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;attribute = &quot;</span> + attribute);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (cursorId != <span class="number">0</span>) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;===============================================&quot;</span>);</span><br><span class="line">    <span class="comment">// 游标读取，Redisson的readCursor方法有bug，无法继续读取游标数据</span></span><br><span class="line">    <span class="comment">// result = rSearch.readCursor(&quot;idx:user&quot;, cursorId, 2);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里游标读取可以自己编写一个基于Lua 的实现</span></span><br><span class="line">    result = readCursor(<span class="string">&quot;idx:user&quot;</span>, cursorId, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    total = result.getTotal();</span><br><span class="line">    cursorId = result.getCursorId();</span><br><span class="line">    System.out.println(<span class="string">&quot;total = &quot;</span> + total);</span><br><span class="line">    System.out.println(<span class="string">&quot;cursorId = &quot;</span> + cursorId);</span><br><span class="line">    attributes = result.getAttributes();</span><br><span class="line">    <span class="keyword">for</span> (Map&lt;String, Object&gt; attribute : attributes) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;attribute = &quot;</span> + attribute);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// cursorId=0 或 到期 时会自动删除游标，此处无需删除</span></span><br><span class="line"><span class="comment">// rSearch.delCursor(&quot;idx:user&quot;, cursorId);</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> AggregationResult <span class="title function_">readCursor</span><span class="params">(String indexName, <span class="type">long</span> cursorId, <span class="type">int</span> count)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;FT.CURSOR&#x27;, &#x27;READ&#x27;, KEYS[1], ARGV[1], &#x27;COUNT&#x27;, ARGV[2])&quot;</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;Object&gt; results = stringRedisTemplate.execute(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, List.class),</span><br><span class="line">            Collections.singletonList(indexName),</span><br><span class="line">            String.valueOf(cursorId),</span><br><span class="line">            String.valueOf(count)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    cursorId = (<span class="type">long</span>) results.get(<span class="number">1</span>);</span><br><span class="line">    List&lt;Object&gt; lo = (List) results.get(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AggregationResult</span>(</span><br><span class="line">            (<span class="type">long</span>) lo.get(<span class="number">0</span>),</span><br><span class="line">            toListOfMap(lo),</span><br><span class="line">            cursorId</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">toListOfMap</span><span class="params">(List&lt;Object&gt; lo)</span> &#123;</span><br><span class="line">    List&lt;Map&lt;String, Object&gt;&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lo == <span class="literal">null</span> || lo.size() &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从索引 1 开始，跳过聚合总数</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; lo.size(); i++) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">rowObj</span> <span class="operator">=</span> lo.get(i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(rowObj <span class="keyword">instanceof</span> List&lt;?&gt; row)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; row.size() - <span class="number">1</span>; j += <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> String.valueOf(row.get(j));</span><br><span class="line">            <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> row.get(j + <span class="number">1</span>);</span><br><span class="line">            map.put(key, value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        result.add(map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>完整生命周期总结</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FT.AGGREGATE ... WITHCURSOR      <span class="comment"># 创建游标（并返回第一批 + cursorId）</span></span><br><span class="line">        ↓</span><br><span class="line">FT.CURSOR READ                  <span class="comment"># 读取第 N 批</span></span><br><span class="line">        ↓</span><br><span class="line">FT.CURSOR READ                  <span class="comment"># 继续读取</span></span><br><span class="line">        ↓</span><br><span class="line">FT.CURSOR DEL（可选）           <span class="comment"># 提前释放资源</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>游标与 OFFSET/LIMIT 的区别</p></li></ul><table><thead><tr><th>对比项</th><th>游标</th><th>OFFSET / LIMIT</th></tr></thead><tbody><tr><td>性能</td><td>高（流式）</td><td>大 OFFSET 性能差</td></tr><tr><td>适合大结果集</td><td>是</td><td>否</td></tr><tr><td>服务器状态</td><td>有</td><td>无</td></tr><tr><td>适用命令</td><td>FT.AGGREGATE</td><td>FT.SEARCH</td></tr></tbody></table><h3 id="五、词典-同义词（搜索增强）">五、词典 &amp; 同义词（搜索增强）</h3><ul class="lvl-0"><li class="lvl-2"><p>词典（DICT）和同义词（SYNONYM）只对 TEXT / TAG 搜索生效</p></li><li class="lvl-2"><p>与 <code>FT.AGGREGATE</code> 无关，但与 <code>FT.SEARCH</code> 强相关。</p></li></ul><table><thead><tr><th>命令</th><th>作用</th></tr></thead><tbody><tr><td><code>FT.DICTADD</code></td><td>添加词</td></tr><tr><td><code>FT.DICTDEL</code></td><td>删除词</td></tr><tr><td><code>FT.DICTDUMP</code></td><td>查看词典</td></tr><tr><td><code>FT.SYNUPDATE</code></td><td>更新同义词</td></tr><tr><td><code>FT.SYNDUMP</code></td><td>查看同义词</td></tr></tbody></table><h4 id="词典">词典</h4><ul class="lvl-0"><li class="lvl-2"><p>词典作用：控制“合法搜索词”，比如将词典的内容发送给用户，让用户只能搜索这些词。</p><ul class="lvl-2"><li class="lvl-4">⚠️ 词典本身不参与搜索匹配</li><li class="lvl-4">⚠️ 只是为搜索增强提供数据来源</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 示例：添加商品相关词</span></span><br><span class="line">FT.DICTADD product_dict iphone mobile phone android huawei</span><br><span class="line"><span class="comment"># 查看词典内容（FT.DICTDUMP）</span></span><br><span class="line">FT.DICTDUMP product_dict</span><br><span class="line"><span class="comment"># 删除词典中的词（FT.DICTDEL）</span></span><br><span class="line">FT.DICTDEL product_dict iphone</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rSearch.addDict(<span class="string">&quot;product_dict&quot;</span>, <span class="string">&quot;iphone&quot;</span>, <span class="string">&quot;mobile&quot;</span>,<span class="string">&quot;phone&quot;</span>,<span class="string">&quot;android&quot;</span>,<span class="string">&quot;huawei&quot;</span>);</span><br><span class="line">List&lt;String&gt; productDict = rSearch.dumpDict(<span class="string">&quot;product_dict&quot;</span>);</span><br><span class="line">rSearch.delDict(<span class="string">&quot;product_dict&quot;</span>, <span class="string">&quot;iphone&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="同义词">同义词</h4><ul class="lvl-0"><li class="lvl-2"><p>同义词的作用: 让不同的搜索词 命中同一批文档</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">例如：</span><br><span class="line">  搜 iphone</span><br><span class="line">  搜 mobile</span><br><span class="line">  搜 phone</span><br><span class="line"></span><br><span class="line">  👉 命中同一批订单</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>添加 / 更新同义词（FT.SYNUPDATE）</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义“手机”的同义词集合，注意同义词是绑定到 索引 的</span></span><br><span class="line">FT.SYNUPDATE idx:user</span><br><span class="line">  phone_group</span><br><span class="line">  iphone mobile phone</span><br><span class="line"><span class="comment">## 参数说明</span></span><br><span class="line"><span class="comment"># phone_group: 同义词集合名称（你自己定义）</span></span><br><span class="line"><span class="comment"># iphone mobile phone: 添加同义词，多个词用空格隔开</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看同义词集合</span></span><br><span class="line">FT.SYNDUMP idx:user</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line">1) <span class="string">&quot;phone&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;phone_group&quot;</span></span><br><span class="line">3) <span class="string">&quot;iphone&quot;</span></span><br><span class="line">4) 1) <span class="string">&quot;phone_group&quot;</span></span><br><span class="line">5) <span class="string">&quot;mobile&quot;</span></span><br><span class="line">6) 1) <span class="string">&quot;phone_group&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rSearch.updateSynonyms(<span class="string">&quot;idx:user&quot;</span>, <span class="string">&quot;phone_group&quot;</span>, <span class="string">&quot;iphone&quot;</span>, <span class="string">&quot;mobile&quot;</span>, <span class="string">&quot;phone&quot;</span>);</span><br><span class="line">Map&lt;String, List&lt;String&gt;&gt; synonyms = rSearch.dumpSynonyms(<span class="string">&quot;idx:user&quot;</span>);</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>此时我们再进行搜索，就会命中所有同义词</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">FT.SEARCH idx:user <span class="string">&#x27;phone&#x27;</span></span><br><span class="line"><span class="comment"># 搜索结果</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 4</span><br><span class="line">2) <span class="string">&quot;user:10001&quot;</span></span><br><span class="line">3) 1) <span class="string">&quot;$&quot;</span></span><br><span class="line">   2) <span class="string">&quot;&#123;\&quot;name\&quot;:\&quot;Alice Bob\&quot;,\&quot;age\&quot;:28,\&quot;vip\&quot;:\&quot;yes\&quot;,\&quot;orders\&quot;:[&#123;\&quot;amount\&quot;:199.99,\&quot;status\&quot;:\&quot;PAID\&quot;&#125;,&#123;\&quot;amount\&quot;:59.9,\&quot;status\&quot;:\&quot;CREATED\&quot;&#125;],\&quot;comment\&quot;:\&quot;I have a phone\&quot;,\&quot;items\&quot;:[\&quot;SpringCloud\xe6\x8a\x80\xe6\x9c\xaf\xe6\x8c\x87\xe5\x8d\x97\&quot;,\&quot;Shell\xe8\x84\x9a\xe6\x9c\xac\xe5\x9f\xba\xe7\xa1\x80\&quot;]&#125;&quot;</span></span><br><span class="line">4) <span class="string">&quot;user:10006&quot;</span></span><br><span class="line">5) 1) <span class="string">&quot;$&quot;</span></span><br><span class="line">   2) <span class="string">&quot;&#123;\&quot;name\&quot;:\&quot;Frank\&quot;,\&quot;age\&quot;:27,\&quot;vip\&quot;:\&quot;no\&quot;,\&quot;orders\&quot;:[&#123;\&quot;amount\&quot;:499,\&quot;status\&quot;:\&quot;PAID\&quot;&#125;,&#123;\&quot;amount\&quot;:129,\&quot;status\&quot;:\&quot;CREATED\&quot;&#125;],\&quot;comment\&quot;:\&quot;I have a phone\&quot;,\&quot;items\&quot;:[\&quot;Redis\xe5\xbc\x80\xe5\x8f\x91\xe5\xae\x9e\xe6\x88\x98\&quot;,\&quot;MongoDB\xe4\xbb\x8e\xe5\x85\xa5\xe9\x97\xa8\xe5\x88\xb0\xe5\xae\x9e\xe6\x88\x98\&quot;]&#125;&quot;</span></span><br><span class="line">6) <span class="string">&quot;user:10002&quot;</span></span><br><span class="line">7) 1) <span class="string">&quot;$&quot;</span></span><br><span class="line">   2) <span class="string">&quot;&#123;\&quot;name\&quot;:\&quot;Bob Frank\&quot;,\&quot;age\&quot;:35,\&quot;vip\&quot;:\&quot;no\&quot;,\&quot;orders\&quot;:[&#123;\&quot;amount\&quot;:899.0,\&quot;status\&quot;:\&quot;PAID\&quot;&#125;],\&quot;comment\&quot;:\&quot;I have a iphone\&quot;,\&quot;items\&quot;:[\&quot;Linux\xe5\xbf\x85\xe7\x9f\xa5\xe5\xbf\x85\xe4\xbc\x9a\&quot;,\&quot;Java\xe5\xa4\x9a\xe7\xba\xbf\xe7\xa8\x8b\xe8\xaf\xa6\xe8\xa7\xa3\&quot;]&#125;&quot;</span></span><br><span class="line">8) <span class="string">&quot;user:10003&quot;</span></span><br><span class="line">9) 1) <span class="string">&quot;$&quot;</span></span><br><span class="line">   2) <span class="string">&quot;&#123;\&quot;name\&quot;:\&quot;Carol\&quot;,\&quot;age\&quot;:22,\&quot;vip\&quot;:\&quot;no\&quot;,\&quot;orders\&quot;:[&#123;\&quot;amount\&quot;:19.9,\&quot;status\&quot;:\&quot;CANCELLED\&quot;&#125;],\&quot;comment\&quot;:\&quot;I have a mobile\&quot;,\&quot;items\&quot;:[\&quot;MySQL\xe4\xbb\x8e\xe5\x88\xa0\xe5\xba\x93\xe5\x88\xb0\xe8\xb7\x91\xe8\xb7\xaf\&quot;,\&quot;Oracle\xe5\xbc\x80\xe5\x8f\x91\xe5\xae\x9e\xe8\xb7\xb5\&quot;]&#125;&quot;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>词典 + 同义词的组合使用</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. 用户输入: 手机</span><br><span class="line">2. 前端 / 服务端 → 从 product_dict 给提示</span><br><span class="line">3. 搜索请求 → FT.SEARCH</span><br><span class="line">4. RediSearch → 同义词扩展</span><br><span class="line">5. 返回统一结果</span><br></pre></td></tr></table></figure><h3 id="六、FT-SPELLCHECK（拼写纠错）">六、FT.SPELLCHECK（拼写纠错）</h3><ul class="lvl-0"><li class="lvl-2"><p>FT.SPELLCHECK 用于对用户输入的搜索词进行拼写纠错与相似词推荐</p></li><li class="lvl-2"><p>它并不会真正执行搜索，而是：<br>✅ 分析输入词是否存在于索引词典<br>✅ 如果不存在，基于编辑距离（Levenshtein）给出候选纠错词<br>✅ 支持自定义词典（Dictionary）增强效果</p></li><li class="lvl-2"><p>🎯 核心目标</p></li></ul><table><thead><tr><th>能力</th><th>说明</th></tr></thead><tbody><tr><td>拼写纠错</td><td>iphone → ipohne</td></tr><tr><td>模糊推荐</td><td>用户拼错关键词</td></tr><tr><td>搜索前置纠错</td><td>提升召回率</td></tr><tr><td>自动学习索引词</td><td>自动从索引词库构建词典</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>基本语法</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FT.SPELLCHECK index query</span><br><span class="line">  [DISTANCE maxDistance]</span><br><span class="line">  [TERMS &#123;INCLUDE | EXCLUDE&#125; dictionary ...]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>参数说明表</p></li></ul><table><thead><tr><th>参数</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td>index</td><td>索引名称</td><td>必填</td></tr><tr><td>query</td><td>用户输入词</td><td>必填</td></tr><tr><td>DISTANCE</td><td>最大编辑距离（1~4）</td><td>1</td></tr><tr><td>TERMS INCLUDE</td><td>仅使用指定词典</td><td>全部</td></tr><tr><td>TERMS EXCLUDE</td><td>排除指定词典</td><td>无</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>示例</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">FT.SPELLCHECK idx:user <span class="string">&#x27;iphnoe&#x27;</span> DISTANCE 2</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">1) 1) TERM         <span class="comment"># 固定标识，表示这是一个被分析的词</span></span><br><span class="line">   2) <span class="string">&quot;iphnoe&quot;</span>     <span class="comment"># 用户输入词</span></span><br><span class="line">   3) 1) 1) <span class="string">&quot;0.4&quot;</span>  <span class="comment"># 相似度评分，越小越相似</span></span><br><span class="line">         2) <span class="string">&quot;iphone&quot;</span> <span class="comment"># 推荐词，建议替换词</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索多个词</span></span><br><span class="line">FT.SPELLCHECK idx:user <span class="string">&#x27;iphnoe linu&#x27;</span> DISTANCE 2</span><br><span class="line">1) 1) TERM</span><br><span class="line">   2) <span class="string">&quot;iphnoe&quot;</span></span><br><span class="line">   3) 1) 1) <span class="string">&quot;0.4&quot;</span></span><br><span class="line">         2) <span class="string">&quot;iphone&quot;</span></span><br><span class="line">2) 1) TERM</span><br><span class="line">   2) <span class="string">&quot;linu&quot;</span></span><br><span class="line">   3) 1) 1) <span class="string">&quot;0.4&quot;</span></span><br><span class="line">         2) <span class="string">&quot;linux&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加编辑距离会显示更多的候选词</span></span><br><span class="line">FT.SPELLCHECK idx:user <span class="string">&#x27;phnoe&#x27;</span> DISTANCE 3</span><br><span class="line">1) 1) TERM</span><br><span class="line">   2) <span class="string">&quot;phnoe&quot;</span></span><br><span class="line">   3) 1) 1) <span class="string">&quot;4&quot;</span></span><br><span class="line">         2) <span class="string">&quot;have&quot;</span></span><br><span class="line">      2) 1) <span class="string">&quot;0.8&quot;</span></span><br><span class="line">         2) <span class="string">&quot;phone&quot;</span></span><br><span class="line">      3) 1) <span class="string">&quot;0.4&quot;</span></span><br><span class="line">         2) <span class="string">&quot;iphone&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Map&lt;String, Double&gt;&gt; spellcheck = rSearch.spellcheck(</span><br><span class="line">        <span class="string">&quot;idx:user&quot;</span>,</span><br><span class="line">        <span class="string">&quot;iphnoe linu&quot;</span>,</span><br><span class="line">        SpellcheckOptions.defaults().distance(<span class="number">2</span>));</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>score = 编辑距离 / max(len(用户输入词), len(候选词))，但并不是总是这样</p></li></ul><table><thead><tr><th>输入</th><th>候选</th><th>编辑距离</th><th>maxLen</th><th>score</th></tr></thead><tbody><tr><td>phnoe</td><td>iphone</td><td>2</td><td>6</td><td>2/6 = 0.333 ≈ 0.4</td></tr><tr><td>phnoe</td><td>phone</td><td>1</td><td>5</td><td>0.2 → ~0.8（内部权重可能反转或调整）</td></tr><tr><td>phnoe</td><td>have</td><td></td><td></td><td>“4” → 表示 phnoe 与 have 的编辑距离是 4</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">phnoe → have</span><br><span class="line">p → h (1)</span><br><span class="line">h → a (2)</span><br><span class="line">n → v (3)</span><br><span class="line">o → e (4)</span><br><span class="line">e → (删除) (5)   （不同算法可能计为 4 或 5）</span><br><span class="line">该词明显是低质量候选，只是 DISTANCE=3/4 时被勉强收录。</span><br><span class="line"></span><br><span class="line">业务侧做合理过滤</span><br><span class="line">如果 score &gt;= 2     → 直接丢弃（明显噪声）</span><br><span class="line">如果 score &lt;= 1.0   → 可信候选</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>建议策略</p></li></ul><table><thead><tr><th>场景</th><th>建议</th></tr></thead><tbody><tr><td>搜索框实时提示</td><td>1</td></tr><tr><td>搜索提交后纠错</td><td>2</td></tr><tr><td>模糊容错系统</td><td>2~3</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>词典增强（Dictionary Integration）</p></li></ul><blockquote><p>通过 FT.DICTADD / FT.DICTDEL 人工维护一个或多个词典，把“业务词汇”主动注入到 SpellCheck 的候选词空间中。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">默认情况下：</span><br><span class="line">SpellCheck 只能从 索引倒排词典（Inverted Index Terms） 中生成候选词。</span><br><span class="line"></span><br><span class="line">如果某些词：</span><br><span class="line">  不在索引里</span><br><span class="line">  出现频率极低</span><br><span class="line">  属于专有名词</span><br><span class="line">  新词、品牌词</span><br><span class="line">那么 SpellCheck 很可能无法正确纠错。</span><br><span class="line"></span><br><span class="line">词典增强解决的正是这个问题。</span><br><span class="line"></span><br><span class="line">用户输入 → Tokenizer → 拆词 →</span><br><span class="line">  ↓</span><br><span class="line">候选源合并：</span><br><span class="line">  - 倒排索引词典</span><br><span class="line">  - 自定义词典（FT.DICTADD）</span><br><span class="line">  ↓</span><br><span class="line">编辑距离计算</span><br><span class="line">  ↓</span><br><span class="line">候选排序</span><br><span class="line">  ↓</span><br><span class="line">返回纠错词</span><br><span class="line"></span><br><span class="line">✅ SpellCheck 的候选空间被人为扩大。</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">FT.DICTADD dict:tech iphone ipad macbook airpods</span><br><span class="line"><span class="comment"># 使用指定词典纠错，白名单</span></span><br><span class="line">FT.SPELLCHECK idx:user <span class="string">&quot;macboo&quot;</span> TERMS INCLUDE dict:tech</span><br><span class="line">1) 1) TERM</span><br><span class="line">   2) <span class="string">&quot;macboo&quot;</span></span><br><span class="line">   3) 1) 1) <span class="string">&quot;0.4&quot;</span></span><br><span class="line">         2) <span class="string">&quot;macbook&quot;</span></span><br><span class="line"><span class="comment"># 排除词典，黑名单</span></span><br><span class="line">FT.SPELLCHECK idx:user <span class="string">&quot;iphnoe&quot;</span> TERMS EXCLUDE dict:noise</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Map&lt;String, Double&gt;&gt; spellcheck = rSearch.spellcheck(</span><br><span class="line">        <span class="string">&quot;idx:user&quot;</span>,</span><br><span class="line">        <span class="string">&quot;macboo&quot;</span>,</span><br><span class="line">        SpellcheckOptions.defaults()</span><br><span class="line">                .distance(<span class="number">2</span>)</span><br><span class="line">                .includedTerms(<span class="string">&quot;dict:tech&quot;</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>FT.SPELLCHECK 与 Suggest 的差异对比（关键）</p></li></ul><table><thead><tr><th>维度</th><th>FT.SPELLCHECK</th><th>FT.SUGGET</th></tr></thead><tbody><tr><td>目标</td><td>拼写纠错</td><td>前缀联想</td></tr><tr><td>输入</td><td>完整词</td><td>前缀</td></tr><tr><td>返回</td><td>相似词</td><td>补全词</td></tr><tr><td>数据来源</td><td>索引词典</td><td>独立 Trie</td></tr><tr><td>是否排序</td><td>否（距离优先）</td><td>是（score）</td></tr><tr><td>是否模糊</td><td>编辑距离</td><td>前缀 + FUZZY</td></tr><tr><td>使用阶段</td><td>搜索前修正</td><td>输入过程中</td></tr></tbody></table><h3 id="已废弃命令（不建议使用）">已废弃命令（不建议使用）</h3><table><thead><tr><th>命令</th><th>状态</th><th>说明</th></tr></thead><tbody><tr><td><code>FT.CONFIG GET</code></td><td>Reids8 将其标记为 Deprecated</td><td>使用 <code>CONFIG GET search-*</code></td></tr><tr><td><code>FT.CONFIG SET</code></td><td>Reids8 将其标记为 Deprecated</td><td>同上</td></tr><tr><td><code>FT.TAGVALS</code></td><td>已经标记为 Deprecated</td><td>改用 AGGREGATE</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>⚠️ 这里要注意，只有 <code>Redis 8.0.0</code> 以上版本支持 <code>CONFIG GET search-*</code>。</p></li></ul><h4 id="FT-CONFIG-GET-和-CONFIG-GET-search-对应参数整理"><code>FT.CONFIG GET *</code> 和 <code>CONFIG GET search-*</code> 对应参数整理</h4><ul class="lvl-0"><li class="lvl-2"><p>1️⃣ 索引基本 / 文档表配置</p></li></ul><table><thead><tr><th>FT.CONFIG 参数</th><th>FT.CONFIG 值</th><th>CONFIG search-* 参数</th><th>CONFIG 值</th><th>说明</th></tr></thead><tbody><tr><td>MINPREFIX</td><td>2</td><td>search-min-prefix</td><td>2</td><td>自动补全最小前缀长度</td></tr><tr><td>MINSTEMLEN</td><td>4</td><td>search-min-stem-len</td><td>4</td><td>最小词干长度</td></tr><tr><td>MAXDOCTABLESIZE</td><td>1000000</td><td>search-max-doctablesize</td><td>1000000</td><td>最大文档表大小</td></tr><tr><td>MAXSEARCHRESULTS</td><td>1000000</td><td>search-max-search-results</td><td>1000000</td><td>搜索结果限制</td></tr><tr><td>MAXAGGREGATERESULTS</td><td>unlimited</td><td>search-max-aggregate-results</td><td>2147483648</td><td>聚合结果限制</td></tr><tr><td>MAXEXPANSIONS</td><td>200</td><td>search-max-prefix-expansions</td><td>200</td><td>前缀扩展限制</td></tr><tr><td>MAXPREFIXEXPANSIONS</td><td>200</td><td>search-max-prefix-expansions</td><td>200</td><td>前缀扩展限制（兼容）</td></tr><tr><td>RAW_DOCID_ENCODING</td><td>false</td><td>search-raw-docid-encoding</td><td>no</td><td>文档ID是否原始编码</td></tr><tr><td>UPGRADE_INDEX</td><td>Upgrade config for upgrading</td><td>N/A</td><td>N/A</td><td>升级索引配置提示</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>2️⃣ 查询 / 评分相关配置</p></li></ul><table><thead><tr><th>FT.CONFIG 参数</th><th>FT.CONFIG 值</th><th>CONFIG search-* 参数</th><th>CONFIG 值</th><th>说明</th></tr></thead><tbody><tr><td>TIMEOUT</td><td>500</td><td>search-timeout</td><td>500</td><td>查询超时（ms）</td></tr><tr><td>ON_TIMEOUT</td><td>return</td><td>search-on-timeout</td><td>return</td><td>超时策略</td></tr><tr><td>DEFAULT_SCORER</td><td>TFIDF</td><td>search-default-scorer</td><td>BM25STD</td><td>默认评分算法</td></tr><tr><td>BM25STD_TANH_FACTOR</td><td>4</td><td>search-bm25std-tanh-factor</td><td>4</td><td>BM25 调整因子</td></tr><tr><td>MULTI_TEXT_SLOP</td><td>100</td><td>search-multi-text-slop</td><td>100</td><td>多字段查询 slop</td></tr><tr><td>DEFAULT_DIALECT</td><td>1</td><td>search-default-dialect</td><td>1</td><td>查询方言</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>3️⃣ GC / 后台索引配置</p></li></ul><table><thead><tr><th>FT.CONFIG 参数</th><th>FT.CONFIG 值</th><th>CONFIG search-* 参数</th><th>CONFIG 值</th><th>说明</th></tr></thead><tbody><tr><td>NOGC</td><td>false</td><td>search-no-gc</td><td>no</td><td>禁用 GC</td></tr><tr><td>GC_POLICY</td><td>fork</td><td>search-fork-gc-policy (implicit)</td><td>fork</td><td>GC 策略</td></tr><tr><td>FORKGC_SLEEP_BEFORE_EXIT</td><td>0</td><td>search-fork-gc-sleep-before-exit</td><td>0</td><td>fork GC 退出前睡眠</td></tr><tr><td>FORK_GC_RUN_INTERVAL</td><td>30</td><td>search-fork-gc-run-interval</td><td>30</td><td>fork GC 执行间隔（秒）</td></tr><tr><td>FORK_GC_CLEAN_THRESHOLD</td><td>100</td><td>search-fork-gc-clean-threshold</td><td>100</td><td>fork GC 清理阈值</td></tr><tr><td>FORK_GC_RETRY_INTERVAL</td><td>5</td><td>search-fork-gc-retry-interval</td><td>5</td><td>fork GC 重试间隔</td></tr><tr><td>FORK_GC_CLEAN_NUMERIC_EMPTY_NODES</td><td>true</td><td>search-_numeric-compress</td><td>no</td><td>清理空数值节点</td></tr><tr><td>GCSCANSIZE</td><td>100</td><td>search-gc-scan-size</td><td>100</td><td>GC 每次扫描大小</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>4️⃣ 游标 / 线程 / 并发配置</p></li></ul><table><thead><tr><th>FT.CONFIG 参数</th><th>FT.CONFIG 值</th><th>CONFIG search-* 参数</th><th>CONFIG 值</th><th>说明</th></tr></thead><tbody><tr><td>CURSOR_MAX_IDLE</td><td>300000</td><td>search-cursor-max-idle</td><td>300000</td><td>游标最大空闲时间</td></tr><tr><td>INDEX_CURSOR_LIMIT</td><td>128</td><td>search-index-cursor-limit</td><td>128</td><td>单索引游标限制</td></tr><tr><td>UNION_ITERATOR_HEAP</td><td>20</td><td>search-union-iterator-heap</td><td>20</td><td>UNION 查询堆大小</td></tr><tr><td>NO_MEM_POOLS</td><td>false</td><td>search-no-mem-pools</td><td>no</td><td>禁用内存池</td></tr><tr><td>_FREE_RESOURCE_ON_THREAD</td><td>true</td><td>search-_free-resource-on-thread</td><td>yes</td><td>线程释放资源</td></tr><tr><td>search_min_operation_workers</td><td>N/A</td><td>search-min-operation-workers</td><td>4</td><td>最小操作线程数</td></tr><tr><td>search-workers</td><td>N/A</td><td>search-workers</td><td>0</td><td>工作线程数</td></tr><tr><td>search-workers-priority-bias-threshold</td><td>N/A</td><td>search-workers-priority-bias-threshold</td><td>1</td><td>线程优先级偏置</td></tr><tr><td>INDEXER_YIELD_EVERY_OPS</td><td>1000</td><td>search-indexer-yield-every-ops</td><td>1000</td><td>索引器 yield 每操作数</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>5️⃣ 实验 / 内部 /其他</p></li></ul><table><thead><tr><th>FT.CONFIG 参数</th><th>FT.CONFIG 值</th><th>CONFIG search-* 参数</th><th>CONFIG 值</th><th>说明</th></tr></thead><tbody><tr><td>EXTLOAD</td><td>nil</td><td>search-ext-load</td><td>“”</td><td>外部加载模块</td></tr><tr><td>FRISOINI</td><td>nil</td><td>search-friso-ini</td><td>“”</td><td>中文分词初始化</td></tr><tr><td>ENABLE_UNSTABLE_FEATURES</td><td>false</td><td>search-enable-unstable-features</td><td>no</td><td>启用实验特性</td></tr><tr><td>_PRINT_PROFILE_CLOCK</td><td>true</td><td>search-_print-profile-clock</td><td>yes</td><td>Profiling 开关</td></tr><tr><td>_NUMERIC_RANGES_PARENTS</td><td>0</td><td>search-_numeric-ranges-parents</td><td>0</td><td>数值范围父节点数</td></tr><tr><td>VSS_MAX_RESIZE</td><td>0</td><td>search-vss-max-resize</td><td>1024</td><td>向量索引最大重分配</td></tr><tr><td>PARTIAL_INDEXED_DOCS</td><td>false</td><td>search-partial-indexed-docs</td><td>no</td><td>部分索引文档标记</td></tr><tr><td>_PRIORITIZE_INTERSECT_UNION_CHILDREN</td><td>false</td><td>search-_prioritize-intersect-union-children</td><td>no</td><td>优先处理 INTERSECT/UNION 子节点</td></tr><tr><td>_BG_INDEX_MEM_PCT_THR</td><td>100</td><td>search-_bg-index-mem-pct-thr</td><td>100</td><td>后台索引内存阈值</td></tr><tr><td>_NUMERIC_COMPRESS</td><td>false</td><td>search-_numeric-compress</td><td>no</td><td>数值压缩</td></tr><tr><td>_BG_INDEX_OOM_PAUSE_TIME</td><td>0</td><td>search-_bg-index-oom-pause-time</td><td>0</td><td>后台索引 OOM 暂停时间</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文介绍 Redis 扩展模块 – RediSearch 的使用方法&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文基于&lt;code&gt;redis-7.4.7&lt;/code&gt;，&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;操作系统：&lt;code&gt;Amazon Linux 2023(内核 6.1)&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis官网：&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis 命令文档：&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;RediSearch 的安装参见 &lt;a href=&quot;/2025/12/26/redis7-module-RediSearch/&quot; title=&quot;Redis 扩展模块 -- RediSearch 的安装方法&quot;&gt;Redis 扩展模块 -- RediSearch 的安装方法&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;示例代码：&lt;a href=&quot;https://github.com/hanqunfeng/springbootchapter/tree/master/springboot3-demo/redis-demo/redisson-demo&quot;&gt;GitHub&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis 扩展模块 -- RediSearch 的安装方法</title>
    <link href="https://blog.hanqunfeng.com/2025/12/26/redis7-module-RediSearch/"/>
    <id>https://blog.hanqunfeng.com/2025/12/26/redis7-module-RediSearch/</id>
    <published>2025-12-26T13:30:05.000Z</published>
    <updated>2026-01-07T07:22:09.326Z</updated>
    
    <content type="html"><![CDATA[<h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2">本文介绍 Redis 扩展模块 – RediSearch 的安装方法</li><li class="lvl-2">本文基于<code>redis-7.4.7</code>，<code>springboot-3.5.8</code></li><li class="lvl-2">操作系统：<code>Amazon Linux 2023(内核 6.1)</code></li><li class="lvl-2">Redis官网：<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis 命令文档：<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li></ul><span id="more"></span><h2 id="RediSearch-简介">RediSearch 简介</h2><ul class="lvl-0"><li class="lvl-2"><p><a href="https://github.com/RediSearch/RediSearch">RediSearch</a> 是 Redis 官方推出的 <code>全文搜索</code>与<code>二级索引</code>模块，用于在 Redis 之上提供类似<code>搜索引擎</code>的能力，解决“只能按 key 查、无法高效按字段查询”的问题。它是 Redis Stack 的核心组件之一，常用于搜索、过滤、排序和聚合场景。仅支持对 Hash 和 RedisJSON 类型进行索引。</p></li><li class="lvl-2"><p>该模块以 <code>Redis Module</code> 方式加载，可无缝集成到现有 Redis 实例中。</p></li><li class="lvl-2"><p>Redis8+，RediSearch 已经内置在 Redis 中，可以在安装redis同时安装全部 Stack 模块。</p></li><li class="lvl-2"><p>RediSearch 通过 <code>索引结构</code> + <code>查询语言</code>，提供：</p><ul class="lvl-2"><li class="lvl-4">全文搜索（Text Search）</li><li class="lvl-4">二级索引（按字段查询）</li><li class="lvl-4">多条件过滤 / 排序</li><li class="lvl-4">聚合分析（GROUP BY、COUNT、SUM 等）</li></ul></li><li class="lvl-2"><p>性能与设计特点</p><ul class="lvl-2"><li class="lvl-4">索引在内存中，查询延迟低（毫秒级）</li><li class="lvl-4">写入时同步更新索引（写入成本略高）</li><li class="lvl-4">适合 读多写少 / 查询复杂 的业务</li><li class="lvl-4">非事务型搜索引擎（不替代 ES，而是互补）</li></ul></li><li class="lvl-2"><p>与原生 Redis 的对比</p></li></ul><table><thead><tr><th>维度</th><th>Redis 原生</th><th>RediSearch</th></tr></thead><tbody><tr><td>查询方式</td><td>key 精确</td><td>多字段查询</td></tr><tr><td>全文搜索</td><td>不支持</td><td>支持</td></tr><tr><td>范围查询</td><td>有限</td><td>强</td></tr><tr><td>聚合统计</td><td>基本没有</td><td>类 SQL</td></tr><tr><td>性能</td><td>极快</td><td>近实时，内存换性能</td></tr></tbody></table><h2 id="RediSearch-vs-Elasticsearch">RediSearch vs Elasticsearch</h2><table><thead><tr><th>对比点</th><th>RediSearch</th><th>Elasticsearch</th></tr></thead><tbody><tr><td>部署复杂度</td><td>低</td><td>高</td></tr><tr><td>延迟</td><td>极低</td><td>较高</td></tr><tr><td>数据规模</td><td>中小规模</td><td>超大规模</td></tr><tr><td>实时性</td><td>强</td><td>近实时</td></tr><tr><td>场景</td><td>业务内搜索</td><td>搜索平台</td></tr></tbody></table><h2 id="安装-RediSearch">安装 RediSearch</h2><ul class="lvl-0"><li class="lvl-2"><p>最简单的方式就是从<a href="https://cloud.redis.io">Redis Cloud</a>的<code>Download Center</code>中进行下载，其提供了所有Redis模块编译后的<code>.so</code>文件，可以优先进行尝试，但是并不保证一定兼容，所以最稳妥的方式是通过源码自己编译。<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/rguEIA.png" alt=""></p></li><li class="lvl-2"><p>源码编译</p></li></ul><blockquote><p>安装时需要科学上网，主要是安装依赖时需要从海外网下载，如果要部署在国内服务器，可能会连接失败。<br>可以在海外的<code>相同配置</code>的服务器上进行编译，之后将编译好的<code>redisearch.so</code>上传到国内服务器即可。</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>安装依赖</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dnf install -y \</span><br><span class="line">  gcc \</span><br><span class="line">  gcc-c++ \</span><br><span class="line">  make \</span><br><span class="line">  cmake \</span><br><span class="line">  autoconf \</span><br><span class="line">  automake \</span><br><span class="line">  libtool \</span><br><span class="line">  pkgconfig \</span><br><span class="line">  openssl-devel \</span><br><span class="line">  libstdc++ \</span><br><span class="line">  libstdc++-devel</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>RediSearch 最新版本 依赖 CMake 3.25+，dnf源中的版本较低，所以这里需要手动安装</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CMAKE_VERSION=3.25.1</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /usr/local/src</span><br><span class="line">wget https://github.com/Kitware/CMake/releases/download/v<span class="variable">$&#123;CMAKE_VERSION&#125;</span>/cmake-<span class="variable">$&#123;CMAKE_VERSION&#125;</span>.tar.gz</span><br><span class="line">tar -xf cmake-<span class="variable">$&#123;CMAKE_VERSION&#125;</span>.tar.gz</span><br><span class="line"><span class="built_in">cd</span> cmake-<span class="variable">$&#123;CMAKE_VERSION&#125;</span></span><br><span class="line"></span><br><span class="line">./bootstrap --prefix=/usr/local</span><br><span class="line">make -j$(<span class="built_in">nproc</span>)</span><br><span class="line"><span class="built_in">sudo</span> make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证版本 /usr/local/bin/cmake</span></span><br><span class="line">/usr/local/bin/cmake --version</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>编译RediSearch</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /usr/local/soft/modules/</span><br><span class="line"><span class="built_in">cd</span> /usr/local/soft/modules</span><br><span class="line"><span class="comment"># clone 代码，这里 --recursive 是为了拉取子模块</span></span><br><span class="line">git <span class="built_in">clone</span> --recursive https://github.com/RediSearch/RediSearch.git</span><br><span class="line"><span class="built_in">cd</span> RediSearch</span><br><span class="line"><span class="comment"># 推荐切换到稳定的release版本</span></span><br><span class="line">git checkout v2.10.25</span><br><span class="line"><span class="comment"># 更新子模块，非必须，如果上面 clone 时没有加上 --recursive ，这个步骤就不能省略</span></span><br><span class="line">git submodule update --init --recursive</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 build_dir 目录，编译失败要先删除该目录在重新创建</span></span><br><span class="line"><span class="built_in">mkdir</span> build_dir &amp;&amp; <span class="built_in">cd</span> build_dir</span><br><span class="line"><span class="comment"># 生成 Makefile</span></span><br><span class="line">/usr/local/bin/cmake .. \</span><br><span class="line">  -DCMAKE_BUILD_TYPE=Release \</span><br><span class="line">  -DCMAKE_C_COMPILER=gcc \</span><br><span class="line">  -DCMAKE_CXX_COMPILER=g++</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译 RediSearch</span></span><br><span class="line">make -j$(<span class="built_in">nproc</span>)</span><br><span class="line"><span class="comment"># 编译过程会报错，同样在 Rocky9 上也会遇到这个问题</span></span><br><span class="line">[100%] Linking CXX shared library redisearch.so</span><br><span class="line">/usr/bin/ld: cannot find -lstdc++: No such file or directory</span><br><span class="line">collect2: error: ld returned 1 <span class="built_in">exit</span> status</span><br><span class="line">make[2]: *** [CMakeFiles/redisearch.dir/build.make:557: redisearch.so] Error 1</span><br><span class="line">make[1]: *** [CMakeFiles/Makefile2:2958: CMakeFiles/redisearch.dir/all] Error 2</span><br><span class="line">make: *** [Makefile:136: all] Error 2</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>编译错误原因分析</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RediSearch 2.10.x 在链接 redisearch.so 时 强制 使用 -static-libstdc++，而 libstdc++.a 静态文件不存在，导致编译失败</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>解决方法是安装静态库</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dnf install -y libstdc++-static</span><br><span class="line"><span class="comment"># 验证静态文件是否存在</span></span><br><span class="line"><span class="built_in">ls</span> /usr/lib/gcc/x86_64-amazon-linux/*/libstdc++.a</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">/usr/lib/gcc/x86_64-amazon-linux/11/libstdc++.a</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>安装后重新编译RediSearch</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/soft/modules</span><br><span class="line"><span class="comment"># 删除 build_dir 目录</span></span><br><span class="line"><span class="built_in">rm</span> -rf build_dir</span><br><span class="line"><span class="comment"># 创建 build_dir 目录，编译失败要先删除该目录再重新创建</span></span><br><span class="line"><span class="built_in">mkdir</span> build_dir &amp;&amp; <span class="built_in">cd</span> build_dir</span><br><span class="line"><span class="comment"># 生成 Makefile</span></span><br><span class="line">/usr/local/bin/cmake .. \</span><br><span class="line">  -DCMAKE_BUILD_TYPE=Release \</span><br><span class="line">  -DCMAKE_C_COMPILER=gcc \</span><br><span class="line">  -DCMAKE_CXX_COMPILER=g++</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译 RediSearch，如果没有错误，则说明编译成功，输出: build_dir/redisearch.so</span></span><br><span class="line">make -j$(<span class="built_in">nproc</span>)</span><br></pre></td></tr></table></figure><h2 id="Redis-启用模块">Redis 启用模块</h2><ul class="lvl-0"><li class="lvl-2"><p>将生成的 <code>redisearch.so</code> 拷贝到 redis 的 modules 目录下（非必须），目录不存在则创建</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意 .so 文件需要包含可执行权限</span></span><br><span class="line"><span class="built_in">cp</span> build_dir/redisearch.so /usr/local/soft/redis-7.4.7/modules/redisearch.so</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>本文采用 <code>loadmodule</code> 加载模块</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 redisearch.so 添加到 redis.conf 中，需要重启 redis</span></span><br><span class="line">loadmodule /usr/local/soft/redis-7.4.7/modules/redisearch.so</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动redis</span></span><br><span class="line">redis-server redis.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录测试</span></span><br><span class="line">redis-cli --user admin --pass 123456</span><br><span class="line"><span class="comment"># 查看模块</span></span><br><span class="line">127.0.0.1:6379&gt; MODULE LIST</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">1) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;ReJSON&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 20816</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/local/soft/redis-7.4.7/modules/rejson.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">2) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;bf&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 20817</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/local/soft/redis-7.4.7/modules/redisbloom.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">3) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;search&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 21025</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/local/soft/redis-7.4.7/modules/redisearch.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br></pre></td></tr></table></figure><h2 id="Rocky9-编译安装-RediSearch">Rocky9 编译安装 RediSearch</h2><blockquote><p>系统版本：<code>Rocky Linux release 9.4 (Blue Onyx)</code></p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>安装依赖</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dnf install -y \</span><br><span class="line">  gcc \</span><br><span class="line">  gcc-c++ \</span><br><span class="line">  make \</span><br><span class="line">  cmake \</span><br><span class="line">  autoconf \</span><br><span class="line">  automake \</span><br><span class="line">  libtool \</span><br><span class="line">  pkgconfig \</span><br><span class="line">  openssl-devel \</span><br><span class="line">  libstdc++ \</span><br><span class="line">  libstdc++-devel</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>启用 CRB</p></li></ul><blockquote><p>在 Rocky Linux 9 中，<code>libstdc++-static</code> 不在默认仓库里，它位于 CRB（CodeReady Builder）仓库，默认是 关闭的，所以我们需要先启用它</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果你系统里没有 config-manager，需要先先装</span></span><br><span class="line"><span class="built_in">sudo</span> dnf install -y dnf-plugins-core</span><br><span class="line"><span class="comment"># 启用 CRB</span></span><br><span class="line"><span class="built_in">sudo</span> dnf config-manager --set-enabled crb</span><br><span class="line"><span class="comment"># 刷新缓存</span></span><br><span class="line"><span class="built_in">sudo</span> dnf makecache</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>安装静态库，解决<code>/usr/bin/ld: cannot find -lstdc++: No such file or directory</code>的问题</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dnf install -y libstdc++-static</span><br><span class="line"><span class="comment"># 验证静态文件是否存在</span></span><br><span class="line"><span class="built_in">ls</span> /usr/lib/gcc/x86_64-redhat-linux/*/libstdc++.a</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>编译RediSearch</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /usr/local/soft/modules/</span><br><span class="line"><span class="built_in">cd</span> /usr/local/soft/modules</span><br><span class="line"><span class="comment"># clone 代码，这里 --recursive 是为了拉取子模块</span></span><br><span class="line">git <span class="built_in">clone</span> --recursive https://github.com/RediSearch/RediSearch.git</span><br><span class="line"><span class="built_in">cd</span> RediSearch</span><br><span class="line"><span class="comment"># 推荐切换到稳定的release版本</span></span><br><span class="line">git checkout v2.10.25</span><br><span class="line"><span class="comment"># 更新子模块，非必须，如果上面 clone 时没有加上 --recursive ，这个步骤就不能省略</span></span><br><span class="line">git submodule update --init --recursive</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 build_dir 目录，编译失败要先删除该目录再重新创建</span></span><br><span class="line"><span class="built_in">mkdir</span> build_dir &amp;&amp; <span class="built_in">cd</span> build_dir</span><br><span class="line"><span class="comment"># 生成 Makefile</span></span><br><span class="line">cmake .. \</span><br><span class="line">  -DCMAKE_BUILD_TYPE=Release \</span><br><span class="line">  -DCMAKE_C_COMPILER=gcc \</span><br><span class="line">  -DCMAKE_CXX_COMPILER=g++</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译 RediSearch，如果没有错误，则说明编译成功，输出: build_dir/redisearch.so</span></span><br><span class="line">make -j$(<span class="built_in">nproc</span>)</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文介绍 Redis 扩展模块 – RediSearch 的安装方法&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文基于&lt;code&gt;redis-7.4.7&lt;/code&gt;，&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;操作系统：&lt;code&gt;Amazon Linux 2023(内核 6.1)&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis官网：&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis 命令文档：&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Amazon Linux 2023(内核 6.1) 安装 Redis8</title>
    <link href="https://blog.hanqunfeng.com/2025/12/25/redis8-install-amazon-linux-2023/"/>
    <id>https://blog.hanqunfeng.com/2025/12/25/redis8-install-amazon-linux-2023/</id>
    <published>2025-12-25T13:30:05.000Z</published>
    <updated>2026-01-07T10:32:31.441Z</updated>
    
    <content type="html"><![CDATA[<h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2">本文介绍 Linux 安装 Redis8 的方法</li><li class="lvl-2">Linux 版本：<code>Amazon Linux 2023(内核 6.1)</code>。</li><li class="lvl-2">Redis官网：<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2"><a href="https://redis.io/docs/latest/operate/oss_and_stack/install/install-stack/rpm/">Redis官网安装手册</a></li></ul><span id="more"></span><h2 id="Yum-安装">Yum 安装</h2><blockquote><p>最省事，国内环境也可以顺利完成安装。<br><code>Amazon Linux 2023(内核 6.1)</code> 和 <code>Rocky Linux release 9.4 (Blue Onyx)</code> 均成功安装。</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>1.添加仓库</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/yum.repos.d/redis.repo &gt; /dev/null &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Redis]</span></span><br><span class="line"><span class="string">name=Redis</span></span><br><span class="line"><span class="string">baseurl=http://packages.redis.io/rpm/rockylinux9</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>2.安装 Redis</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://packages.redis.io/gpg &gt; /tmp/redis.key</span><br><span class="line"><span class="built_in">sudo</span> rpm --import /tmp/redis.key</span><br><span class="line"><span class="built_in">sudo</span> yum install redis -y</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>3.查看redis安装信息</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看已安装的redis版本</span></span><br><span class="line">$ rpm -qa | grep redis</span><br><span class="line">redis-8.4.0-1.x86_64</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看redis安装信息</span></span><br><span class="line">$ rpm -qi redis-8.4.0-1.x86_64</span><br><span class="line">Name        : redis</span><br><span class="line">Version     : 8.4.0</span><br><span class="line">Release     : 1</span><br><span class="line">Architecture: x86_64</span><br><span class="line">Install Date: Wed 24 Dec 2025 06:05:22 AM UTC</span><br><span class="line">Group       : Applications/Databases</span><br><span class="line">Size        : 83034075</span><br><span class="line">License     :</span><br><span class="line">Signature   : RSA/SHA512, Mon 01 Dec 2025 12:05:10 PM UTC, Key ID 5f4349d6bf53aa0c</span><br><span class="line">Source RPM  : redis-8.4.0-1.src.rpm</span><br><span class="line">Build Date  : Tue 18 Nov 2025 04:41:58 PM UTC</span><br><span class="line">Build Host  : 331d5099e900</span><br><span class="line">Packager    : Redis Labs &lt;redis@redis.io&gt;</span><br><span class="line">URL         : https://redis.io/</span><br><span class="line">Summary     : Redis is an in-memory database that persists on disk. The data model is key-value, but many different kind of values are supported: Strings, Lists, Sets, Sorted Sets, Hashes, Streams, HyperLogLogs, Bitmaps.</span><br><span class="line">Description :</span><br><span class="line">Redis is an in-memory database that persists on disk. The data model is key-value, but many different kind of values are supported: Strings, Lists, Sets, Sorted Sets, Hashes, Streams, HyperLogLogs, Bitmaps.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看redis安装的文件</span></span><br><span class="line">$ rpm -ql redis-8.4.0-1.x86_64</span><br><span class="line">/etc/redis</span><br><span class="line">/etc/redis/redis.conf</span><br><span class="line">/etc/redis/sentinel</span><br><span class="line">/etc/redis/sentinel/sentinel.conf</span><br><span class="line">/run/redis</span><br><span class="line">/run/redis/redis-server.pid</span><br><span class="line">/usr/bin/redis-benchmark</span><br><span class="line">/usr/bin/redis-check-aof</span><br><span class="line">/usr/bin/redis-check-rdb</span><br><span class="line">/usr/bin/redis-cli</span><br><span class="line">/usr/bin/redis-sentinel</span><br><span class="line">/usr/bin/redis-server</span><br><span class="line">/usr/lib/redis</span><br><span class="line">/usr/lib/redis/modules</span><br><span class="line">/usr/lib/redis/modules/redisbloom.so</span><br><span class="line">/usr/lib/redis/modules/redisearch.so</span><br><span class="line">/usr/lib/redis/modules/redistimeseries.so</span><br><span class="line">/usr/lib/redis/modules/rejson.so</span><br><span class="line">/usr/lib/redis/redisbloom.so</span><br><span class="line">/usr/lib/redis/redisearch.so</span><br><span class="line">/usr/lib/redis/redistimeseries.so</span><br><span class="line">/usr/lib/redis/rejson.so</span><br><span class="line">/usr/lib/systemd/system/redis-sentinel.service</span><br><span class="line">/usr/lib/systemd/system/redis.service</span><br><span class="line">/usr/share/selinux/packages/redis-ce.fc</span><br><span class="line">/usr/share/selinux/packages/redis-ce.te</span><br><span class="line">/var/lib/redis</span><br><span class="line">/var/log/redis</span><br><span class="line">/var/log/redis/redis-sentinel.log</span><br><span class="line">/var/log/redis/redis-server.log</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>4.启动redis</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> redis</span><br><span class="line"><span class="built_in">sudo</span> systemctl start redis</span><br><span class="line"><span class="built_in">sudo</span> systemctl status redis</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>5.登录redis</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli</span><br><span class="line">127.0.0.1:6379&gt; MODULE LIST</span><br><span class="line">1) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;bf&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 80400</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/lib/redis/modules/redisbloom.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">2) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;timeseries&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 80400</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/lib/redis/modules/redistimeseries.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">3) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;ReJSON&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 80400</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/lib/redis/modules/rejson.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">4) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;vectorset&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 1</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">5) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;search&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 80402</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/lib/redis/modules/redisearch.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br></pre></td></tr></table></figure><h2 id="源码安装">源码安装</h2><ul class="lvl-0"><li class="lvl-2"><p>1.更新环境(非必须)</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dnf update -y</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>2.安装依赖包</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dnf install -y --nobest --skip-broken \</span><br><span class="line">    pkg-config \</span><br><span class="line">    xz \</span><br><span class="line">    wget \</span><br><span class="line">    <span class="built_in">which</span> \</span><br><span class="line">    git \</span><br><span class="line">    make \</span><br><span class="line">    openssl \</span><br><span class="line">    openssl-devel \</span><br><span class="line">    python3 \</span><br><span class="line">    python3-pip \</span><br><span class="line">    python3-devel \</span><br><span class="line">    unzip \</span><br><span class="line">    rsync \</span><br><span class="line">    clang \</span><br><span class="line">    llvm \</span><br><span class="line">    curl \</span><br><span class="line">    libtool \</span><br><span class="line">    automake \</span><br><span class="line">    autoconf \</span><br><span class="line">    jq \</span><br><span class="line">    systemd-devel</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>3.下载并提取Redis源代码</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/src</span><br><span class="line"><span class="built_in">sudo</span> wget -O redis-8.4.0.tar.gz https://github.com/redis/redis/archive/refs/tags/8.4.0.tar.gz</span><br><span class="line"><span class="built_in">sudo</span> tar -xzf redis-8.4.0.tar.gz</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>4.编译Redis</p></li></ul><blockquote><p>这里要注意，不会自动安装模块，需要手动安装。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启用GCC工具集</span></span><br><span class="line"><span class="built_in">cd</span> /usr/src/redis-8.4.0</span><br><span class="line"><span class="comment"># 构建TLS</span></span><br><span class="line"><span class="built_in">export</span> BUILD_TLS=<span class="built_in">yes</span></span><br><span class="line"><span class="comment"># 构建Redis模块，配不配都不会自动安装模块</span></span><br><span class="line"><span class="built_in">export</span> BUILD_WITH_MODULES=<span class="built_in">yes</span></span><br><span class="line"><span class="comment"># 安装Rust工具链</span></span><br><span class="line"><span class="built_in">export</span> INSTALL_RUST_TOOLCHAIN=<span class="built_in">yes</span></span><br><span class="line"><span class="comment"># 关闭警告</span></span><br><span class="line"><span class="built_in">export</span> DISABLE_WERRORS=<span class="built_in">yes</span></span><br><span class="line"><span class="comment"># 开始编译</span></span><br><span class="line"><span class="built_in">sudo</span> make -j <span class="string">&quot;<span class="subst">$(nproc)</span>&quot;</span> all</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">./src/redis-server --version</span><br><span class="line">./src/redis-cli --version</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>5.启动Redis</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> ./src/redis-server redis.conf</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>6.登录Redis</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ./src/redis-cli</span><br><span class="line">127.0.0.1:6379&gt; MODULE LIST</span><br><span class="line">1) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;vectorset&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 1</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>7.安装模块，可以参考如下文章中的介绍</p><ul class="lvl-2"><li class="lvl-5"><a href="/2025/12/24/redis7-module-RedisJSON/" title="Redis 扩展模块 -- RedisJSON 的安装方法">Redis 扩展模块 -- RedisJSON 的安装方法</a></li><li class="lvl-5"><a href="/2025/12/21/redis7-module-RedisBloom/" title="Redis 扩展模块 -- RedisBloom 的安装方法">Redis 扩展模块 -- RedisBloom 的安装方法</a></li><li class="lvl-5"><a href="/2025/12/26/redis7-module-RediSearch/" title="Redis 扩展模块 -- RediSearch 的安装方法">Redis 扩展模块 -- RediSearch 的安装方法</a></li><li class="lvl-5"><a href="/2026/01/07/redis7-module-RedisTimeSeries/" title="Redis 扩展模块 -- RedisTimeSeries 的安装方法">Redis 扩展模块 -- RedisTimeSeries 的安装方法</a></li></ul></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文介绍 Linux 安装 Redis8 的方法&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Linux 版本：&lt;code&gt;Amazon Linux 2023(内核 6.1)&lt;/code&gt;。&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis官网：&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;&lt;a href=&quot;https://redis.io/docs/latest/operate/oss_and_stack/install/install-stack/rpm/&quot;&gt;Redis官网安装手册&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Rcoky9 安装 Redis8</title>
    <link href="https://blog.hanqunfeng.com/2025/12/25/redis8-install-rocky9/"/>
    <id>https://blog.hanqunfeng.com/2025/12/25/redis8-install-rocky9/</id>
    <published>2025-12-25T13:30:05.000Z</published>
    <updated>2025-12-24T10:06:24.246Z</updated>
    
    <content type="html"><![CDATA[<h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2">本文介绍 Linux 安装 Redis8 的方法</li><li class="lvl-2">Linux 版本：<code>Rocky Linux release 9.4 (Blue Onyx)</code>。</li><li class="lvl-2">Redis官网：<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2"><a href="https://redis.io/docs/latest/operate/oss_and_stack/install/install-stack/rpm/">Redis官网安装手册</a></li></ul><span id="more"></span><h2 id="Yum-安装">Yum 安装</h2><blockquote><p>最省事，国内环境也可以顺利完成安装。<br><code>Amazon Linux 2023(内核 6.1)</code> 和 <code>Rocky Linux release 9.4 (Blue Onyx)</code> 均成功安装。</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>1.添加仓库</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/yum.repos.d/redis.repo &gt; /dev/null &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Redis]</span></span><br><span class="line"><span class="string">name=Redis</span></span><br><span class="line"><span class="string">baseurl=http://packages.redis.io/rpm/rockylinux9</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>2.安装 Redis</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://packages.redis.io/gpg &gt; /tmp/redis.key</span><br><span class="line"><span class="built_in">sudo</span> rpm --import /tmp/redis.key</span><br><span class="line"><span class="built_in">sudo</span> yum install redis -y</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>3.查看redis安装信息</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看已安装的redis版本</span></span><br><span class="line">$ rpm -qa | grep redis</span><br><span class="line">redis-8.4.0-1.x86_64</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看redis安装信息</span></span><br><span class="line">$ rpm -qi redis-8.4.0-1.x86_64</span><br><span class="line">Name        : redis</span><br><span class="line">Version     : 8.4.0</span><br><span class="line">Release     : 1</span><br><span class="line">Architecture: x86_64</span><br><span class="line">Install Date: Wed 24 Dec 2025 06:05:22 AM UTC</span><br><span class="line">Group       : Applications/Databases</span><br><span class="line">Size        : 83034075</span><br><span class="line">License     :</span><br><span class="line">Signature   : RSA/SHA512, Mon 01 Dec 2025 12:05:10 PM UTC, Key ID 5f4349d6bf53aa0c</span><br><span class="line">Source RPM  : redis-8.4.0-1.src.rpm</span><br><span class="line">Build Date  : Tue 18 Nov 2025 04:41:58 PM UTC</span><br><span class="line">Build Host  : 331d5099e900</span><br><span class="line">Packager    : Redis Labs &lt;redis@redis.io&gt;</span><br><span class="line">URL         : https://redis.io/</span><br><span class="line">Summary     : Redis is an in-memory database that persists on disk. The data model is key-value, but many different kind of values are supported: Strings, Lists, Sets, Sorted Sets, Hashes, Streams, HyperLogLogs, Bitmaps.</span><br><span class="line">Description :</span><br><span class="line">Redis is an in-memory database that persists on disk. The data model is key-value, but many different kind of values are supported: Strings, Lists, Sets, Sorted Sets, Hashes, Streams, HyperLogLogs, Bitmaps.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看redis安装的文件</span></span><br><span class="line">$ rpm -ql redis-8.4.0-1.x86_64</span><br><span class="line">/etc/redis</span><br><span class="line">/etc/redis/redis.conf</span><br><span class="line">/etc/redis/sentinel</span><br><span class="line">/etc/redis/sentinel/sentinel.conf</span><br><span class="line">/run/redis</span><br><span class="line">/run/redis/redis-server.pid</span><br><span class="line">/usr/bin/redis-benchmark</span><br><span class="line">/usr/bin/redis-check-aof</span><br><span class="line">/usr/bin/redis-check-rdb</span><br><span class="line">/usr/bin/redis-cli</span><br><span class="line">/usr/bin/redis-sentinel</span><br><span class="line">/usr/bin/redis-server</span><br><span class="line">/usr/lib/redis</span><br><span class="line">/usr/lib/redis/modules</span><br><span class="line">/usr/lib/redis/modules/redisbloom.so</span><br><span class="line">/usr/lib/redis/modules/redisearch.so</span><br><span class="line">/usr/lib/redis/modules/redistimeseries.so</span><br><span class="line">/usr/lib/redis/modules/rejson.so</span><br><span class="line">/usr/lib/redis/redisbloom.so</span><br><span class="line">/usr/lib/redis/redisearch.so</span><br><span class="line">/usr/lib/redis/redistimeseries.so</span><br><span class="line">/usr/lib/redis/rejson.so</span><br><span class="line">/usr/lib/systemd/system/redis-sentinel.service</span><br><span class="line">/usr/lib/systemd/system/redis.service</span><br><span class="line">/usr/share/selinux/packages/redis-ce.fc</span><br><span class="line">/usr/share/selinux/packages/redis-ce.te</span><br><span class="line">/var/lib/redis</span><br><span class="line">/var/log/redis</span><br><span class="line">/var/log/redis/redis-sentinel.log</span><br><span class="line">/var/log/redis/redis-server.log</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>4.启动redis</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> redis</span><br><span class="line"><span class="built_in">sudo</span> systemctl start redis</span><br><span class="line"><span class="built_in">sudo</span> systemctl status redis</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>5.登录redis</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli</span><br><span class="line">127.0.0.1:6379&gt; MODULE LIST</span><br><span class="line">1) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;bf&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 80400</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/lib/redis/modules/redisbloom.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">2) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;timeseries&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 80400</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/lib/redis/modules/redistimeseries.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">3) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;ReJSON&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 80400</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/lib/redis/modules/rejson.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">4) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;vectorset&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 1</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">5) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;search&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 80402</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/lib/redis/modules/redisearch.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br></pre></td></tr></table></figure><h2 id="源码安装">源码安装</h2><ul class="lvl-0"><li class="lvl-2"><p>1.添加仓库</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/yum.repos.d/goreleaser.repo &gt; /dev/null &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[goreleaser]</span></span><br><span class="line"><span class="string">name=GoReleaser</span></span><br><span class="line"><span class="string">baseurl=https://repo.goreleaser.com/yum/</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> dnf clean all</span><br><span class="line"><span class="built_in">sudo</span> dnf makecache</span><br><span class="line"><span class="built_in">sudo</span> dnf update -y</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>2.安装依赖包</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dnf install -y --nobest --skip-broken \</span><br><span class="line">    pkg-config \</span><br><span class="line">    xz \</span><br><span class="line">    wget \</span><br><span class="line">    <span class="built_in">which</span> \</span><br><span class="line">    gcc-toolset-13-gcc \</span><br><span class="line">    gcc-toolset-13-gcc-c++ \</span><br><span class="line">    git \</span><br><span class="line">    make \</span><br><span class="line">    openssl \</span><br><span class="line">    openssl-devel \</span><br><span class="line">    python3 \</span><br><span class="line">    python3-pip \</span><br><span class="line">    python3-devel \</span><br><span class="line">    unzip \</span><br><span class="line">    rsync \</span><br><span class="line">    clang \</span><br><span class="line">    curl \</span><br><span class="line">    libtool \</span><br><span class="line">    automake \</span><br><span class="line">    autoconf \</span><br><span class="line">    jq \</span><br><span class="line">    systemd-devel</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>3.创建一个Python虚拟环境</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> python3 -m venv /opt/venv</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>4.启用GCC工具集</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> /opt/rh/gcc-toolset-13/enable /etc/profile.d/gcc-toolset-13.sh</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;source /etc/profile.d/gcc-toolset-13.sh&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> -a /etc/bashrc</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>5.安装CMake</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">CMAKE_VERSION=3.25.1</span><br><span class="line">ARCH=$(<span class="built_in">uname</span> -m)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$ARCH</span>&quot;</span> = <span class="string">&quot;x86_64&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  CMAKE_FILE=cmake-<span class="variable">$&#123;CMAKE_VERSION&#125;</span>-linux-x86_64.sh</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  CMAKE_FILE=cmake-<span class="variable">$&#123;CMAKE_VERSION&#125;</span>-linux-aarch64.sh</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> wget https://github.com/Kitware/CMake/releases/download/v<span class="variable">$&#123;CMAKE_VERSION&#125;</span>/<span class="variable">$&#123;CMAKE_FILE&#125;</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> +x <span class="variable">$&#123;CMAKE_FILE&#125;</span></span><br><span class="line"><span class="built_in">sudo</span> ./<span class="variable">$&#123;CMAKE_FILE&#125;</span> --skip-license --prefix=/usr/local --exclude-subdir</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> <span class="variable">$&#123;CMAKE_FILE&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/usr/local/bin</span><br><span class="line">cmake --version</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>6.下载并提取Redis源代码</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/src</span><br><span class="line"><span class="built_in">sudo</span> wget -O redis-8.4.0.tar.gz https://github.com/redis/redis/archive/refs/tags/8.4.0.tar.gz</span><br><span class="line"><span class="built_in">sudo</span> tar -xzf redis-8.4.0.tar.gz</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>7.编译Redis</p></li></ul><blockquote><p>国内环境安装时因为需要从GitHub下载模块，速度很慢，而且经常失败，建议安装时先不要安装模块，安装好redis后再按需安装模块。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启用GCC工具集</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile.d/gcc-toolset-13.sh</span><br><span class="line"><span class="built_in">cd</span> /usr/src/redis-8.4.0</span><br><span class="line"><span class="comment"># 构建TLS</span></span><br><span class="line"><span class="built_in">export</span> BUILD_TLS=<span class="built_in">yes</span></span><br><span class="line"><span class="comment"># 构建Redis模块，如果不安装模块，则不需要此参数</span></span><br><span class="line"><span class="built_in">export</span> BUILD_WITH_MODULES=<span class="built_in">yes</span></span><br><span class="line"><span class="comment"># 安装Rust工具链</span></span><br><span class="line"><span class="built_in">export</span> INSTALL_RUST_TOOLCHAIN=<span class="built_in">yes</span></span><br><span class="line"><span class="comment"># 关闭警告</span></span><br><span class="line"><span class="built_in">export</span> DISABLE_WERRORS=<span class="built_in">yes</span></span><br><span class="line"><span class="comment"># 开始编译</span></span><br><span class="line"><span class="built_in">sudo</span> make -j <span class="string">&quot;<span class="subst">$(nproc)</span>&quot;</span> all</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">./src/redis-server --version</span><br><span class="line">./src/redis-cli --version</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>8.启动Redis</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> ./src/redis-server redis-full.conf</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>9.登录Redis</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">$ ./src/redis-cli</span><br><span class="line">127.0.0.1:6379&gt; MODULE LIST</span><br><span class="line">1) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;search&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 80402</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;./modules/redisearch/redisearch.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">2) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;vectorset&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 1</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">3) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;ReJSON&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 80400</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;./modules/redisjson/rejson.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">4) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;bf&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 80400</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;./modules/redisbloom/redisbloom.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">5) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;timeseries&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 80400</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;./modules/redistimeseries/redistimeseries.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>10.安装模块，如果安装时没有安装模块，可以参考如下文章中的介绍</p><ul class="lvl-2"><li class="lvl-5"><a href="/2025/12/24/redis7-module-RedisJSON/" title="Redis 扩展模块 -- RedisJSON 的安装方法">Redis 扩展模块 -- RedisJSON 的安装方法</a></li><li class="lvl-5"><a href="/2025/12/21/redis7-module-RedisBloom/" title="Redis 扩展模块 -- RedisBloom 的安装方法">Redis 扩展模块 -- RedisBloom 的安装方法</a></li></ul></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文介绍 Linux 安装 Redis8 的方法&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Linux 版本：&lt;code&gt;Rocky Linux release 9.4 (Blue Onyx)&lt;/code&gt;。&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis官网：&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;&lt;a href=&quot;https://redis.io/docs/latest/operate/oss_and_stack/install/install-stack/rpm/&quot;&gt;Redis官网安装手册&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis 命令及数据类型 -- JSON</title>
    <link href="https://blog.hanqunfeng.com/2025/12/24/redis7-datatype-16-JSON/"/>
    <id>https://blog.hanqunfeng.com/2025/12/24/redis7-datatype-16-JSON/</id>
    <published>2025-12-24T13:40:05.000Z</published>
    <updated>2026-01-07T02:44:09.582Z</updated>
    
    <content type="html"><![CDATA[<h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2">本文介绍 Redis 扩展模型 RedisJSON 中的 JSON 数据类型</li><li class="lvl-2">本文基于<code>redis-7.4.7</code>，<code>springboot-3.5.8</code></li><li class="lvl-2">Redis官网：<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis 命令文档：<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li><li class="lvl-2">RedisJSON 的安装参见 <a href="/2025/12/24/redis7-module-RedisJSON/" title="Redis 扩展模块 -- RedisJSON 的安装方法">Redis 扩展模块 -- RedisJSON 的安装方法</a></li><li class="lvl-2">示例代码：<a href="https://github.com/hanqunfeng/springbootchapter/tree/master/springboot3-demo/redis-demo/redisson-demo">GitHub</a></li></ul><span id="more"></span><h2 id="JSON-vs-String">JSON vs String</h2><ul class="lvl-0"><li class="lvl-2"><p>Redis JSON存储数据的性能更高。</p><ul class="lvl-2"><li class="lvl-6">Redis JSON 底层其实是以一种高效的二进制的格式存储。</li><li class="lvl-6">相比简单的文本格式，二进制格式进行 JOSN 格式读写的性能更高，也更节省内存。</li><li class="lvl-6">根据官网的性能测试报告，使用 Redis JSON 读写 JSON数据，性能已经能够媲美 MongoDB 以及 ElasticSearch 等传统 NoSQL 数据库。</li></ul></li><li class="lvl-2"><p>Redis JSON 使用树状结构来存储JSON。</p><ul class="lvl-2"><li class="lvl-6">这种存储方式可以快速访问子元素。</li><li class="lvl-6">与传统的文本存储方案相比，树状存储结构能够更高效的执行查询操作。</li></ul></li><li class="lvl-2"><p>与Redis生态集成度高。</p><ul class="lvl-2"><li class="lvl-6">作为Redis的扩展模块，Redis JSON 和Redis的其他功能和工具无缝集成。</li><li class="lvl-6">这意味着开发者可以继续使用TTL、Redis事务、发布/订阅、Lua脚本等功能。</li></ul></li></ul><h2 id="JSONPath">JSONPath</h2><ul class="lvl-0"><li class="lvl-2"><p>JSONPath 是一种用于查询和修改 JSON 数据的语法。</p></li><li class="lvl-2"><p>JSONPath 语法</p></li></ul><table><thead><tr><th>语法元素</th><th>中文说明</th><th>示例</th></tr></thead><tbody><tr><td><code>$</code></td><td>根节点（最外层 JSON 元素），JSONPath 的起点</td><td><code>$</code>、<code>$.user.name</code></td></tr><tr><td><code>.</code></td><td>访问子字段（对象属性访问）</td><td><code>$.user.age</code></td></tr><tr><td><code>[]</code></td><td>子元素选择器（字段名或数组索引）</td><td><code>$['user']['name']</code></td></tr><tr><td><code>..</code></td><td>递归下降，遍历所有层级的节点</td><td><code>$..id</code></td></tr><tr><td><code>*</code></td><td>通配符，匹配当前层级的所有元素</td><td><code>$.users[*]</code></td></tr><tr><td><code>[index]</code></td><td>数组下标访问（支持负索引）</td><td><code>$.scores[0]</code></td></tr><tr><td><code>[a,b,c]</code></td><td>联合选择，返回多个指定元素</td><td><code>$.scores[0,2,4]</code></td></tr><tr><td><code>[start:end:step]</code></td><td>数组切片（起始索引 : 结束索引 : 步长）</td><td><code>$.scores[1:5:2]</code></td></tr><tr><td><code>[*]</code></td><td>选择数组中的所有元素</td><td><code>$.items[*]</code></td></tr><tr><td><code>[:]</code></td><td>选择数组中的所有元素（切片写法）</td><td><code>$.items[:]</code></td></tr><tr><td><code>?()</code></td><td>过滤表达式，用于数组或对象的条件筛选</td><td><code>$.users[?(@.age&gt;=18)]</code></td></tr><tr><td><code>()</code></td><td>脚本表达式，用于计算或复杂逻辑判断</td><td><code>$.items[?((@.a+@.b)&gt;10)]</code></td></tr><tr><td><code>@</code></td><td>当前元素引用，常用于过滤或脚本表达式中</td><td><code>@.price&lt;100</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>数组切片 <code>[start:end:step]</code> 详解</p></li></ul><table><thead><tr><th>写法</th><th>含义</th></tr></thead><tbody><tr><td><code>[3:]</code></td><td>从索引 3 到末尾</td></tr><tr><td><code>[:8]</code></td><td>从头到索引 7</td></tr><tr><td><code>[:8:2]</code></td><td>从头到 7，每隔 2 个取一个</td></tr><tr><td><code>[::]</code></td><td>等价于 <code>[:]</code>，取全部</td></tr><tr><td><code>[*]</code></td><td>推荐写法，取全部</td></tr></tbody></table><blockquote><p>默认值规则：<br>start 默认 0<br>end 默认数组末尾<br>step 默认 1</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>过滤表达式 <code>?()</code> 支持的运算符</p></li></ul><blockquote><p>比较运算符，实测中仅支持数字比较，且注意两边不能有空格</p></blockquote><table><thead><tr><th>运算符</th><th>含义</th></tr></thead><tbody><tr><td><code>==</code></td><td>等于</td></tr><tr><td><code>!=</code></td><td>不等于</td></tr><tr><td><code>&lt;</code></td><td>小于</td></tr><tr><td><code>&lt;=</code></td><td>小于等于</td></tr><tr><td><code>&gt;</code></td><td>大于</td></tr><tr><td><code>&gt;=</code></td><td>大于等于</td></tr><tr><td><code>=~</code></td><td>正则匹配</td></tr></tbody></table><blockquote><p>逻辑运算符</p></blockquote><table><thead><tr><th>运算符</th><th>含义</th></tr></thead><tbody><tr><td><code>&amp;&amp;</code></td><td>与</td></tr><tr><td><code>||</code></td><td>或</td></tr><tr><td><code>()</code></td><td>分组优先级</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>Redis 的 RedisJSON 模块（提供 JSON 操作功能）支持的 JSONPath 语法是受限的子集，尤其是：</p><ul class="lvl-2"><li class="lvl-6">❌ 不支持复杂表达式</li><li class="lvl-6">❌ 不支持嵌套数组条件（@.items[*].xxx）</li><li class="lvl-6">⚠️ 对 ?() 的支持非常有限</li></ul></li><li class="lvl-2"><p>如果需要复杂的查询推荐使用 <code>RediSearch</code> 模块，这个我们后面的章节会介绍。</p></li></ul><h2 id="JSON-命令">JSON 命令</h2><ul class="lvl-0"><li class="lvl-2"><p>JSON 命令 汇总</p></li></ul><table><thead><tr><th>分类</th><th>命令</th></tr></thead><tbody><tr><td>基础读写</td><td>SET / MSET / GET / MGET</td></tr><tr><td>数组操作</td><td>ARRAPPEND / ARRINSERT / ARRPOP / ARRLEN / ARRINDEX / ARRTRIM</td></tr><tr><td>对象操作</td><td>OBJKEYS / OBJLEN / TYPE</td></tr><tr><td>数值运算</td><td>NUMINCRBY / NUMMULTBY / TOGGLE</td></tr><tr><td>字符串</td><td>STRAPPEND / STRLEN</td></tr><tr><td>删除清空</td><td>DEL / FORGET / CLEAR</td></tr><tr><td>合并输出</td><td>MERGE / RESP</td></tr><tr><td>调试诊断</td><td>DEBUG / DEBUG MEMORY</td></tr></tbody></table><h3 id="一、基础读写类（CRUD）">一、基础读写类（CRUD）</h3><table><thead><tr><th>命令</th><th>作用</th><th>关键参数说明</th><th>示例</th></tr></thead><tbody><tr><td>JSON.SET</td><td>设置或更新某个 path 的值</td><td><code>key</code>：键名<br><code>path</code>：JSONPath（如 <code>$</code>、<code>$.a.b</code>）<br><code>value</code>：JSON 值</td><td><code>JSON.SET user:1 $ '&#123;&quot;name&quot;:&quot;Tom&quot;,&quot;age&quot;:18&#125;'</code></td></tr><tr><td>JSON.MSET</td><td>批量设置多个 key</td><td><code>(key path value)...</code></td><td><code>JSON.MSET k1 $ '&#123;&quot;a&quot;:1&#125;' k2 $.b 2</code></td></tr><tr><td>JSON.GET</td><td>获取一个 key 的 JSON 值</td><td><code>key</code><br><code>path...</code>：可多个</td><td><code>JSON.GET user:1 $.name $.age</code></td></tr><tr><td>JSON.MGET</td><td>从多个 key 获取同一路径</td><td><code>key... path</code></td><td><code>JSON.MGET k1 k2 $.a</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>说明：</p><ul class="lvl-2"><li class="lvl-6">JSON.GET 返回 字符串化 JSON</li><li class="lvl-6">JSON.MGET 返回数组，对应多个 key</li></ul></li></ul><h3 id="二、数组操作类（Array）">二、数组操作类（Array）</h3><table><thead><tr><th>命令</th><th>作用</th><th>参数含义</th><th>示例</th></tr></thead><tbody><tr><td>JSON.ARRAPPEND</td><td>向数组末尾追加元素</td><td><code>key path value...</code></td><td><code>JSON.ARRAPPEND k $.tags &quot;redis&quot; &quot;json&quot;</code></td></tr><tr><td>JSON.ARRINSERT</td><td>在指定索引插入元素</td><td><code>key path index value...</code></td><td><code>JSON.ARRINSERT k $.tags 1 &quot;nosql&quot;</code></td></tr><tr><td>JSON.ARRPOP</td><td>删除并返回指定索引元素</td><td><code>key path [index]</code></td><td><code>JSON.ARRPOP k $.tags -1</code></td></tr><tr><td>JSON.ARRLEN</td><td>获取数组长度</td><td><code>key path</code></td><td><code>JSON.ARRLEN k $.tags</code></td></tr><tr><td>JSON.ARRINDEX</td><td>查找元素索引</td><td><code>key path value</code></td><td><code>JSON.ARRINDEX k $.tags &quot;redis&quot;</code></td></tr><tr><td>JSON.ARRTRIM</td><td>截取数组区间</td><td><code>key path start stop</code></td><td><code>JSON.ARRTRIM k $.scores 0 9</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>说明：</p><ul class="lvl-2"><li class="lvl-6">索引支持负数（-1 表示最后一个）</li><li class="lvl-6">ARRTRIM 类似 LTRIM</li></ul></li></ul><h3 id="三、对象操作类（Object）">三、对象操作类（Object）</h3><table><thead><tr><th>命令</th><th>作用</th><th>参数说明</th><th>示例</th></tr></thead><tbody><tr><td>JSON.OBJKEYS</td><td>获取对象的所有 key</td><td><code>key path</code></td><td><code>JSON.OBJKEYS k $.user</code></td></tr><tr><td>JSON.OBJLEN</td><td>获取对象字段数量</td><td><code>key path</code></td><td><code>JSON.OBJLEN k $.user</code></td></tr><tr><td>JSON.TYPE</td><td>返回 path 对应值类型</td><td><code>key path</code></td><td><code>JSON.TYPE k $.user.name</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>JSON.TYPE 返回类型包括：object / array / string / number / boolean / null</p></li></ul><h3 id="四、数值运算类（Numeric）">四、数值运算类（Numeric）</h3><table><thead><tr><th>命令</th><th>作用</th><th>参数说明</th><th>示例</th></tr></thead><tbody><tr><td>JSON.NUMINCRBY</td><td>数值自增</td><td><code>key path number</code></td><td><code>JSON.NUMINCRBY k $.count 1</code></td></tr><tr><td>JSON.NUMMULTBY</td><td>数值乘法</td><td><code>key path number</code></td><td><code>JSON.NUMMULTBY k $.price 0.8</code></td></tr><tr><td>JSON.TOGGLE</td><td>布尔值取反</td><td><code>key path</code></td><td><code>JSON.TOGGLE k $.enabled</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>说明：</p><ul class="lvl-2"><li class="lvl-6">保证 原子性</li><li class="lvl-6">常用于计数、开关状态</li></ul></li></ul><h3 id="五、字符串操作类（String）">五、字符串操作类（String）</h3><table><thead><tr><th>命令</th><th>作用</th><th>参数说明</th><th>示例</th></tr></thead><tbody><tr><td>JSON.STRAPPEND</td><td>追加字符串</td><td><code>key path value</code></td><td><code>JSON.STRAPPEND k $.msg &quot; world&quot;</code></td></tr><tr><td>JSON.STRLEN</td><td>字符串长度</td><td><code>key path</code></td><td><code>JSON.STRLEN k $.msg</code></td></tr></tbody></table><h3 id="六、删除-清空类">六、删除 / 清空类</h3><table><thead><tr><th>命令</th><th>作用</th><th>参数说明</th><th>示例</th></tr></thead><tbody><tr><td>JSON.DEL</td><td>删除指定 path</td><td><code>key path</code></td><td><code>JSON.DEL k $.user.age</code></td></tr><tr><td>JSON.FORGET</td><td>等价 JSON.DEL</td><td>同上</td><td><code>JSON.FORGET k $.tmp</code></td></tr><tr><td>JSON.CLEAR</td><td>清空值</td><td><code>key path</code></td><td><code>JSON.CLEAR k $.list</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>JSON.CLEAR 行为说明：</p><ul class="lvl-2"><li class="lvl-6">数组 → []</li><li class="lvl-6">对象 → {}</li><li class="lvl-6">数值 → 0</li></ul></li></ul><h3 id="七、合并与高级操作">七、合并与高级操作</h3><table><thead><tr><th>命令</th><th>作用</th><th>参数说明</th><th>示例</th></tr></thead><tbody><tr><td>JSON.MERGE</td><td>合并 JSON（RFC7396）</td><td><code>key path value</code></td><td><code>JSON.MERGE k $ '&#123;&quot;a&quot;:2,&quot;b&quot;:3&#125;'</code></td></tr><tr><td>JSON.RESP</td><td>RESP 格式返回</td><td><code>key path</code></td><td><code>JSON.RESP k $.user</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>说明：</p><ul class="lvl-2"><li class="lvl-6">MERGE 支持字段覆盖、删除、扩展</li><li class="lvl-6">RESP 适合客户端直接解析</li></ul></li></ul><h3 id="八、调试与诊断类（Debug）">八、调试与诊断类（Debug）</h3><table><thead><tr><th>命令</th><th>作用</th><th>参数说明</th><th>示例</th></tr></thead><tbody><tr><td>JSON.DEBUG</td><td>调试命令容器</td><td>子命令</td><td><code>JSON.DEBUG MEMORY k</code></td></tr><tr><td>JSON.DEBUG MEMORY</td><td>查看 JSON 占用内存</td><td><code>key</code></td><td><code>JSON.DEBUG MEMORY user:1</code></td></tr></tbody></table><h2 id="应用示例">应用示例</h2><ul class="lvl-0"><li class="lvl-2"><p>场景选用：电商用户画像 + 订单系统（结构复杂、字段多、非常适合 JSONPath）</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">我们要存储一个用户的完整画像：</span><br><span class="line">    基本信息</span><br><span class="line">    地址列表</span><br><span class="line">    订单列表（包含商品、价格、数量）</span><br><span class="line">    标签(偏好)</span><br><span class="line">    账户状态</span><br><span class="line">    统计信息</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>SpringBoot暂时没有支持RedisJSON，你可以编写Lua脚本来实现相应的功能，另外 <a href="https://redisson.pro/docs/data-and-services/objects/#json-object-holder">Redisson</a>已经提供了对JSON的支持，但是实际使用中发现还有一些Bug，下面结合命令给出代码示例。</p></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 引入 Redisson ，这里要注意，现在最新版是 4.0.0，需要 springboot 4.x --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.52.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>创建完整 JSON 文档（JSON.SET）</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 JSON 文档，实际执行中不支持多行，这里只是为了看着清楚些，实际运行时要将其改成一行</span></span><br><span class="line">JSON.SET user:10001 $ <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;profile&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;name&quot;: &quot;Alice&quot;,</span></span><br><span class="line"><span class="string">    &quot;age&quot;: 28,</span></span><br><span class="line"><span class="string">    &quot;vip&quot;: true</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;tags&quot;: [&quot;vip&quot;, &quot;electronics&quot;, &quot;promotion&quot;],</span></span><br><span class="line"><span class="string">  &quot;addresses&quot;: [</span></span><br><span class="line"><span class="string">    &#123; &quot;city&quot;: &quot;Beijing&quot;, &quot;zip&quot;: &quot;100000&quot; &#125;,</span></span><br><span class="line"><span class="string">    &#123; &quot;city&quot;: &quot;Shanghai&quot;, &quot;zip&quot;: &quot;200000&quot; &#125;</span></span><br><span class="line"><span class="string">  ],</span></span><br><span class="line"><span class="string">  &quot;orders&quot;: [</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;orderId&quot;: &quot;O1001&quot;,</span></span><br><span class="line"><span class="string">      &quot;amount&quot;: 199.99,</span></span><br><span class="line"><span class="string">      &quot;status&quot;: &quot;PAID&quot;,</span></span><br><span class="line"><span class="string">      &quot;items&quot;: [</span></span><br><span class="line"><span class="string">        &#123; &quot;sku&quot;: &quot;SKU-1&quot;, &quot;price&quot;: 99.99, &quot;qty&quot;: 1 &#125;,</span></span><br><span class="line"><span class="string">        &#123; &quot;sku&quot;: &quot;SKU-2&quot;, &quot;price&quot;: 100.00, &quot;qty&quot;: 1 &#125;</span></span><br><span class="line"><span class="string">      ]</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;orderId&quot;: &quot;O1002&quot;,</span></span><br><span class="line"><span class="string">      &quot;amount&quot;: 59.90,</span></span><br><span class="line"><span class="string">      &quot;status&quot;: &quot;CREATED&quot;,</span></span><br><span class="line"><span class="string">      &quot;items&quot;: [</span></span><br><span class="line"><span class="string">        &#123; &quot;sku&quot;: &quot;SKU-3&quot;, &quot;price&quot;: 59.90, &quot;qty&quot;: 1 &#125;</span></span><br><span class="line"><span class="string">      ]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  ],</span></span><br><span class="line"><span class="string">  &quot;stats&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;loginCount&quot;: 10,</span></span><br><span class="line"><span class="string">    &quot;balance&quot;: 300.5</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以使用单行模式一点点组装</span></span><br><span class="line">JSON.SET user:10001 $ <span class="string">&#x27;&#123;&#125;&#x27;</span></span><br><span class="line">JSON.SET user:10001 $.profile <span class="string">&#x27;&#123;&quot;name&quot;:&quot;Alice&quot;,&quot;age&quot;:28,&quot;vip&quot;:true&#125;&#x27;</span></span><br><span class="line">JSON.SET user:10001 $.tags <span class="string">&#x27;[&quot;vip&quot;,&quot;electronics&quot;,&quot;promotion&quot;]&#x27;</span></span><br><span class="line">JSON.SET user:10001 $.addresses <span class="string">&#x27;[&#123;&quot;city&quot;:&quot;Beijing&quot;,&quot;zip&quot;:&quot;100000&quot;&#125;,&#123;&quot;city&quot;:&quot;Shanghai&quot;,&quot;zip&quot;:&quot;200000&quot;&#125;]&#x27;</span></span><br><span class="line">JSON.SET user:10001 $.orders <span class="string">&#x27;[&#123;&quot;orderId&quot;:&quot;O1001&quot;,&quot;amount&quot;:199.99,&quot;status&quot;:&quot;PAID&quot;,&quot;items&quot;:[&#123;&quot;sku&quot;:&quot;SKU-1&quot;,&quot;price&quot;:99.99,&quot;qty&quot;:1&#125;,&#123;&quot;sku&quot;:&quot;SKU-2&quot;,&quot;price&quot;:100,&quot;qty&quot;:1&#125;]&#125;,&#123;&quot;orderId&quot;:&quot;O1002&quot;,&quot;amount&quot;:59.90,&quot;status&quot;:&quot;CREATED&quot;,&quot;items&quot;:[&#123;&quot;sku&quot;:&quot;SKU-3&quot;,&quot;price&quot;:59.90,&quot;qty&quot;:1&#125;]&#125;]&#x27;</span></span><br><span class="line">JSON.SET user:10001 $.stats <span class="string">&#x27;&#123;&quot;loginCount&quot;:10,&quot;balance&quot;:300.5&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看类型</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">type</span> user:10001</span><br><span class="line">ReJSON-RL</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>通用代码</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">userStr</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">              &quot;profile&quot;: &#123;</span></span><br><span class="line"><span class="string">                &quot;name&quot;: &quot;Alice&quot;,</span></span><br><span class="line"><span class="string">                &quot;age&quot;: 28,</span></span><br><span class="line"><span class="string">                &quot;vip&quot;: true</span></span><br><span class="line"><span class="string">              &#125;,</span></span><br><span class="line"><span class="string">              &quot;tags&quot;: [&quot;vip&quot;, &quot;electronics&quot;, &quot;promotion&quot;],</span></span><br><span class="line"><span class="string">              &quot;addresses&quot;: [</span></span><br><span class="line"><span class="string">                &#123; &quot;city&quot;: &quot;Beijing&quot;, &quot;zip&quot;: &quot;100000&quot; &#125;,</span></span><br><span class="line"><span class="string">                &#123; &quot;city&quot;: &quot;Shanghai&quot;, &quot;zip&quot;: &quot;200000&quot; &#125;</span></span><br><span class="line"><span class="string">              ],</span></span><br><span class="line"><span class="string">              &quot;orders&quot;: [</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                  &quot;orderId&quot;: &quot;O1001&quot;,</span></span><br><span class="line"><span class="string">                  &quot;amount&quot;: 199.99,</span></span><br><span class="line"><span class="string">                  &quot;status&quot;: &quot;PAID&quot;,</span></span><br><span class="line"><span class="string">                  &quot;items&quot;: [</span></span><br><span class="line"><span class="string">                    &#123; &quot;sku&quot;: &quot;SKU-1&quot;, &quot;price&quot;: 99.99, &quot;qty&quot;: 1 &#125;,</span></span><br><span class="line"><span class="string">                    &#123; &quot;sku&quot;: &quot;SKU-2&quot;, &quot;price&quot;: 100.00, &quot;qty&quot;: 1 &#125;</span></span><br><span class="line"><span class="string">                  ]</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                  &quot;orderId&quot;: &quot;O1002&quot;,</span></span><br><span class="line"><span class="string">                  &quot;amount&quot;: 59.90,</span></span><br><span class="line"><span class="string">                  &quot;status&quot;: &quot;CREATED&quot;,</span></span><br><span class="line"><span class="string">                  &quot;items&quot;: [</span></span><br><span class="line"><span class="string">                    &#123; &quot;sku&quot;: &quot;SKU-3&quot;, &quot;price&quot;: 59.90, &quot;qty&quot;: 1 &#125;</span></span><br><span class="line"><span class="string">                  ]</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">              ],</span></span><br><span class="line"><span class="string">              &quot;stats&quot;: &#123;</span></span><br><span class="line"><span class="string">                &quot;loginCount&quot;: 10,</span></span><br><span class="line"><span class="string">                &quot;balance&quot;: 300.5</span></span><br><span class="line"><span class="string">              &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>;</span><br><span class="line"><span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">RJsonBucket&lt;User&gt; bucket = redissonClient.getJsonBucket(<span class="string">&quot;user:10001&quot;</span>, <span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(User.class));</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> objectMapper.readValue(userStr, User.class);</span><br><span class="line">bucket.set(user);</span><br></pre></td></tr></table></figure><h3 id="JSONPath-查询示例">JSONPath 查询示例</h3><ul class="lvl-0"><li class="lvl-2"><p>1️⃣ 基础路径访问</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取全部数据</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.GET user:10001</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取用户信息</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.GET user:10001 $.profile</span><br><span class="line"><span class="string">&quot;[&#123;\&quot;name\&quot;:\&quot;Alice\&quot;,\&quot;age\&quot;:28,\&quot;vip\&quot;:true&#125;]&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取用户名</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.GET user:10001 $.profile.name</span><br><span class="line"><span class="string">&quot;[\&quot;Alice\&quot;]&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> bucket.get(<span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;User&gt;() &#123;&#125;));</span><br><span class="line"></span><br><span class="line">User.<span class="type">ProfileBean</span> <span class="variable">profile</span> <span class="operator">=</span> bucket.get(<span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;User.ProfileBean&gt;() &#123;&#125;),<span class="string">&quot;profile&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> bucket.get(<span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;String&gt;() &#123;&#125;),<span class="string">&quot;profile.name&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加上 $. 前缀，返回值必须是 List&lt;T&gt;</span></span><br><span class="line">List&lt;String&gt; names = bucket.get(<span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;String&gt;&gt;() &#123;&#125;),<span class="string">&quot;$.profile.name&quot;</span>);</span><br><span class="line">System.out.println(names.get(<span class="number">0</span>));</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>2️⃣ 数组访问 &amp; 通配符</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取所有订单ID</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.GET user:10001 $.orders[*].orderId</span><br><span class="line"><span class="string">&quot;[\&quot;O1001\&quot;,\&quot;O1002\&quot;]&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取所有地址的城市</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.GET user:10001 $.addresses[*].city</span><br><span class="line"><span class="string">&quot;[\&quot;Beijing\&quot;,\&quot;Shanghai\&quot;]&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; orderIds = bucket.get(<span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;String&gt;&gt;() &#123;&#125;),<span class="string">&quot;$.orders[*].orderId&quot;</span>);</span><br><span class="line"></span><br><span class="line">List&lt;String&gt; citys = bucket.get(<span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;String&gt;&gt;() &#123;&#125;),<span class="string">&quot;$.addresses[*].city&quot;</span>);</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>3️⃣ 数组下标与切片</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取第一个订单</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.GET user:10001 $.orders[0]</span><br><span class="line"><span class="string">&quot;[&#123;\&quot;orderId\&quot;:\&quot;O1001\&quot;,\&quot;amount\&quot;:199.99,\&quot;status\&quot;:\&quot;PAID\&quot;,\&quot;items\&quot;:[&#123;\&quot;sku\&quot;:\&quot;SKU-1\&quot;,\&quot;price\&quot;:99.99,\&quot;qty\&quot;:1&#125;,&#123;\&quot;sku\&quot;:\&quot;SKU-2\&quot;,\&quot;price\&quot;:100,\&quot;qty\&quot;:1&#125;]&#125;]&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取第一个和第二个订单，切片逻辑是 [start:end]， start &lt;= x &lt; end ，end不写默认为数组末尾</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.GET user:10001 $.orders[0:2]</span><br><span class="line"><span class="string">&quot;[&#123;\&quot;orderId\&quot;:\&quot;O1001\&quot;,\&quot;amount\&quot;:199.99,\&quot;status\&quot;:\&quot;PAID\&quot;,\&quot;items\&quot;:[&#123;\&quot;sku\&quot;:\&quot;SKU-1\&quot;,\&quot;price\&quot;:99.99,\&quot;qty\&quot;:1&#125;,&#123;\&quot;sku\&quot;:\&quot;SKU-2\&quot;,\&quot;price\&quot;:100,\&quot;qty\&quot;:1&#125;]&#125;,&#123;\&quot;orderId\&quot;:\&quot;O1002\&quot;,\&quot;amount\&quot;:59.9,\&quot;status\&quot;:\&quot;CREATED\&quot;,\&quot;items\&quot;:[&#123;\&quot;sku\&quot;:\&quot;SKU-3\&quot;,\&quot;price\&quot;:59.9,\&quot;qty\&quot;:1&#125;]&#125;]&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取所有订单，这里等同于 $.orders[*]</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.GET user:10001 $.orders[:]</span><br><span class="line"><span class="string">&quot;[&#123;\&quot;orderId\&quot;:\&quot;O1001\&quot;,\&quot;amount\&quot;:199.99,\&quot;status\&quot;:\&quot;PAID\&quot;,\&quot;items\&quot;:[&#123;\&quot;sku\&quot;:\&quot;SKU-1\&quot;,\&quot;price\&quot;:99.99,\&quot;qty\&quot;:1&#125;,&#123;\&quot;sku\&quot;:\&quot;SKU-2\&quot;,\&quot;price\&quot;:100,\&quot;qty\&quot;:1&#125;]&#125;,&#123;\&quot;orderId\&quot;:\&quot;O1002\&quot;,\&quot;amount\&quot;:59.9,\&quot;status\&quot;:\&quot;CREATED\&quot;,\&quot;items\&quot;:[&#123;\&quot;sku\&quot;:\&quot;SKU-3\&quot;,\&quot;price\&quot;:59.9,\&quot;qty\&quot;:1&#125;]&#125;]&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;OrdersBean&gt; orders = bucket.get(<span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;OrdersBean&gt;&gt;() &#123;&#125;),<span class="string">&quot;$.orders[0]&quot;</span>);</span><br><span class="line"></span><br><span class="line">orders = bucket.get(<span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;OrdersBean&gt;&gt;() &#123;&#125;),<span class="string">&quot;$.orders[0:2]&quot;</span>);</span><br><span class="line"></span><br><span class="line">orders = bucket.get(<span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;OrdersBean&gt;&gt;() &#123;&#125;),<span class="string">&quot;$.orders[:]&quot;</span>);</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>4️⃣ 递归查询（…）</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 👉 找出所有商品价格（不管在哪一层）</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.GET user:10001 $..price</span><br><span class="line"><span class="string">&quot;[99.99,100,59.9]&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Double&gt; prices = bucket.get(<span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;Double&gt;&gt;() &#123;&#125;),<span class="string">&quot;$..price&quot;</span>);</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>5️⃣ 条件过滤（JSONPath 核心能力）</p></li></ul><blockquote><p>✅ 支持的查询</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 👉 找出所有订单金额大于100的订单，✅ 数字比较</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.GET user:10001 $.orders[?(@.amount&gt;100)]</span><br><span class="line"><span class="string">&quot;[&#123;\&quot;orderId\&quot;:\&quot;O1001\&quot;,\&quot;amount\&quot;:199.99,\&quot;status\&quot;:\&quot;PAID\&quot;,\&quot;items\&quot;:[&#123;\&quot;sku\&quot;:\&quot;SKU-1\&quot;,\&quot;price\&quot;:99.99,\&quot;qty\&quot;:1&#125;,&#123;\&quot;sku\&quot;:\&quot;SKU-2\&quot;,\&quot;price\&quot;:100,\&quot;qty\&quot;:1&#125;]&#125;]&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 👉 找出所有订单中第一个商品价格大于50的订单，✅ 数组条件</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.GET user:10001 $.orders[?(@.items[0].price&gt;50)]</span><br><span class="line"><span class="string">&quot;[&#123;\&quot;orderId\&quot;:\&quot;O1001\&quot;,\&quot;amount\&quot;:199.99,\&quot;status\&quot;:\&quot;PAID\&quot;,\&quot;items\&quot;:[&#123;\&quot;sku\&quot;:\&quot;SKU-1\&quot;,\&quot;price\&quot;:99.99,\&quot;qty\&quot;:1&#125;,&#123;\&quot;sku\&quot;:\&quot;SKU-2\&quot;,\&quot;price\&quot;:100,\&quot;qty\&quot;:1&#125;]&#125;,&#123;\&quot;orderId\&quot;:\&quot;O1002\&quot;,\&quot;amount\&quot;:59.9,\&quot;status\&quot;:\&quot;CREATED\&quot;,\&quot;items\&quot;:[&#123;\&quot;sku\&quot;:\&quot;SKU-3\&quot;,\&quot;price\&quot;:59.9,\&quot;qty\&quot;:1&#125;]&#125;]&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 👉 找出所有订单金额大于100并且订单中第一个商品价格大于50的订单，✅ 逻辑运算符</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.GET user:10001 $.orders[?(@.amount&gt;100)&amp;&amp;(@.items[0].price&gt;50)]</span><br><span class="line"><span class="string">&quot;[&#123;\&quot;orderId\&quot;:\&quot;O1001\&quot;,\&quot;amount\&quot;:199.99,\&quot;status\&quot;:\&quot;PAID\&quot;,\&quot;items\&quot;:[&#123;\&quot;sku\&quot;:\&quot;SKU-1\&quot;,\&quot;price\&quot;:99.99,\&quot;qty\&quot;:1&#125;,&#123;\&quot;sku\&quot;:\&quot;SKU-2\&quot;,\&quot;price\&quot;:100,\&quot;qty\&quot;:1&#125;]&#125;]&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;OrdersBean&gt; orders = bucket.get(<span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;OrdersBean&gt;&gt;() &#123;&#125;),<span class="string">&quot;$.orders[?(@.amount&gt;100)]&quot;</span>);</span><br><span class="line"></span><br><span class="line">orders = bucket.get(<span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;OrdersBean&gt;&gt;() &#123;&#125;),<span class="string">&quot;$.orders[?(@.items[0].price&gt;50)]&quot;</span>);</span><br><span class="line"></span><br><span class="line">orders = bucket.get(<span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;OrdersBean&gt;&gt;() &#123;&#125;),<span class="string">&quot;$.orders[?(@.amount&gt;100)&amp;&amp;(@.items[0].price&gt;50)]&quot;</span>);</span><br></pre></td></tr></table></figure><blockquote><p>❌ 不支持的查询</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 👉 找出所有已支付订单，❌ 不支持字符串的比较</span><br><span class="line">JSON.GET user:10001 $.orders[?(@.status==&quot;PAID&quot;)]</span><br><span class="line"># 👉 找出所有已支付订单，❌ 不支持正则匹配</span><br><span class="line">JSON.GET user:10001 $.orders[?(@.status=~&quot;PAID&quot;)]</span><br><span class="line"></span><br><span class="line"># 👉 找出所有订单中商品价格大于50的订单，这个就不准，❌ 不支持嵌套数组条件（@.items[*].xxx）</span><br><span class="line">127.0.0.1:6379&gt; JSON.GET user:10001 $.orders[?(@.items[*].price&gt;50)]</span><br><span class="line">&quot;[&#123;\&quot;orderId\&quot;:\&quot;O1002\&quot;,\&quot;amount\&quot;:59.9,\&quot;status\&quot;:\&quot;CREATED\&quot;,\&quot;items\&quot;:[&#123;\&quot;sku\&quot;:\&quot;SKU-3\&quot;,\&quot;price\&quot;:59.9,\&quot;qty\&quot;:1&#125;]&#125;]&quot;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>6️⃣ 修改数据（JSON.SET / JSON.NUMINCRBY）</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 👉 修改用户名</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.SET user:10001 $.profile.name <span class="string">&#x27;&quot;Alice Zhang&quot;&#x27;</span></span><br><span class="line">OK</span><br><span class="line"><span class="comment"># 👉 用户登录次数 +1</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.NUMINCRBY user:10001 $.stats.loginCount 1</span><br><span class="line"><span class="string">&quot;[11]&quot;</span> <span class="comment"># 返回修改后的值</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bucket.set(<span class="string">&quot;$.profile.name&quot;</span>, <span class="string">&quot;Alice Zhang&quot;</span>);</span><br><span class="line"><span class="comment">// 注意如下方法会增加成功，但是会抛异常，应该是Redisson的bug</span></span><br><span class="line"><span class="comment">// Caused by: java.lang.NumberFormatException: For input string: &quot;[11]&quot;</span></span><br><span class="line">bucket.incrementAndGet(<span class="string">&quot;$.stats.loginCount&quot;</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>7️⃣ 数组操作（ARRAPPEND / ARRINSERT）</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 👉 添加一个订单</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.ARRAPPEND user:10001 $.orders <span class="string">&#x27;&#123;&quot;orderId&quot;: &quot;O1003&quot;,&quot;amount&quot;: 399,&quot;status&quot;: &quot;PAID&quot;,&quot;items&quot;: [&#123; &quot;sku&quot;: &quot;SKU-9&quot;, &quot;price&quot;: 399, &quot;qty&quot;: 1 &#125;]&#125;&#x27;</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 3 <span class="comment"># 返回添加后的长度</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 👉 在 tags 的最后添加一个标签</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.ARRAPPEND user:10001 $.tags <span class="string">&#x27;&quot;newTag&quot;&#x27;</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 4 <span class="comment"># 添加后的长度</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 👉 在 tags 中的指定位置插入一个标签</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.ARRINSERT user:10001 $.tags 1 <span class="string">&#x27;&quot;newTag2&quot;&#x27;</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 5 <span class="comment"># 插入后的长度</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">OrdersBean</span> <span class="variable">ordersBean</span> <span class="operator">=</span> OrdersBean.builder()</span><br><span class="line">                .orderId(<span class="string">&quot;O1003&quot;</span>)</span><br><span class="line">                .amount(<span class="number">399</span>)</span><br><span class="line">                .status(<span class="string">&quot;CREATED&quot;</span>)</span><br><span class="line">                .items(List.of(</span><br><span class="line">                        OrdersBean.ItemsBean.builder()</span><br><span class="line">                                .sku(<span class="string">&quot;SKU-9&quot;</span>)</span><br><span class="line">                                .qty(<span class="number">1</span>)</span><br><span class="line">                                .price(<span class="number">399</span>).build()</span><br><span class="line">                )).build();</span><br><span class="line"><span class="comment">// 添加一个订单，返回添加后的长度</span></span><br><span class="line"><span class="type">long</span> <span class="variable">num</span> <span class="operator">=</span> bucket.arrayAppend(<span class="string">&quot;$.orders&quot;</span>, ordersBean);</span><br><span class="line"></span><br><span class="line">num = bucket.arrayAppend(<span class="string">&quot;$.tags&quot;</span>, <span class="string">&quot;newTag&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 插入成功，但是会抛异常，应该是Redisson的bug</span></span><br><span class="line">num = bucket.arrayInsert(<span class="string">&quot;$.tags&quot;</span>, <span class="number">1</span>, <span class="string">&quot;newTag2&quot;</span>);</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>8️⃣ 删除 &amp; 清理操作（JSON.DEL &amp; JSON.CLEAR）</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 👉 删除用户年龄，$.profile.age 不存在了</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.DEL user:10001 $.profile.age</span><br><span class="line">(<span class="built_in">integer</span>) 1 <span class="comment"># 删除成功，返回0，表示路径不存在</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 👉 清空用户所有标签，$.tags 保留，只是变成了 [] 空数组</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.CLEAR user:10001 $.tags</span><br><span class="line">(<span class="built_in">integer</span>) 1 <span class="comment"># 清空成功，返回0，表示路径不存在或已经清空</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">delete</span> <span class="operator">=</span> bucket.delete(<span class="string">&quot;$.profile.age&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="variable">clear</span> <span class="operator">=</span> bucket.clear(<span class="string">&quot;$.tags&quot;</span>);</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>9️⃣ 统计数组长度</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 👉 统计用户订单的长度</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.ARRLEN user:10001 $.orders</span><br><span class="line">1) (<span class="built_in">integer</span>) 3</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 会抛异常，应该是Redisson的bug</span></span><br><span class="line"><span class="type">long</span> <span class="variable">length</span> <span class="operator">=</span> bucket.arraySize(<span class="string">&quot;$.orders&quot;</span>);</span><br></pre></td></tr></table></figure><p>🔟 查看 JSON 占用内存</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; JSON.DEBUG MEMORY user:10001</span><br><span class="line">(<span class="built_in">integer</span>) 1896 <span class="comment"># 占用内存大小，单位字节</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">sizeInMemory</span> <span class="operator">=</span> bucket.sizeInMemory();</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文介绍 Redis 扩展模型 RedisJSON 中的 JSON 数据类型&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文基于&lt;code&gt;redis-7.4.7&lt;/code&gt;，&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis官网：&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis 命令文档：&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;RedisJSON 的安装参见 &lt;a href=&quot;/2025/12/24/redis7-module-RedisJSON/&quot; title=&quot;Redis 扩展模块 -- RedisJSON 的安装方法&quot;&gt;Redis 扩展模块 -- RedisJSON 的安装方法&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;示例代码：&lt;a href=&quot;https://github.com/hanqunfeng/springbootchapter/tree/master/springboot3-demo/redis-demo/redisson-demo&quot;&gt;GitHub&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis 扩展模块 -- RedisJSON 的安装方法</title>
    <link href="https://blog.hanqunfeng.com/2025/12/24/redis7-module-RedisJSON/"/>
    <id>https://blog.hanqunfeng.com/2025/12/24/redis7-module-RedisJSON/</id>
    <published>2025-12-24T13:30:05.000Z</published>
    <updated>2026-01-05T02:21:23.571Z</updated>
    
    <content type="html"><![CDATA[<h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2">本文介绍 Redis 扩展模块 – RedisJSON 的安装方法</li><li class="lvl-2">本文基于<code>redis-7.4.7</code>，<code>springboot-3.5.8</code></li><li class="lvl-2">操作系统：<code>Amazon Linux 2023(内核 6.1)</code></li><li class="lvl-2">Redis官网：<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis 命令文档：<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li></ul><span id="more"></span><h2 id="RedisJSON-简介">RedisJSON 简介</h2><ul class="lvl-0"><li class="lvl-2"><p><a href="https://github.com/RedisJSON/RedisJSON">RedisJSON</a> 是 Redis 官方维护的一个扩展模块，隶属于 <code>Redis Stack</code>，专门用于对JSON数据进行操作。</p></li><li class="lvl-2"><p>该模块以 <code>Redis Module</code> 方式加载，可无缝集成到现有 Redis 实例中。</p></li><li class="lvl-2"><p>Redis8+，RedisJSON 已经内置在 Redis 中，可以在安装redis同时安装全部 Stack 模块。</p></li></ul><h2 id="安装-RedisJSON">安装 RedisJSON</h2><ul class="lvl-0"><li class="lvl-2"><p>虽然<a href="https://cloud.redis.io">Redis Cloud</a>的<code>Download Center</code>中提供了所有Redis模块编译后的<code>.so</code>文件，但是并不保证一定兼容，所以最稳妥的方式是通过源码自己编译。</p></li></ul><blockquote><p>安装时需要科学上网，主要是安装依赖时需要从海外网下载，如果要部署在国内服务器，可能会连接失败。<br>可以在海外的<code>相同配置</code>的服务器上进行编译，之后将编译好的<code>rejson.so</code>上传到国内服务器即可。</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>安装依赖</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dnf install -y \</span><br><span class="line">  gcc \</span><br><span class="line">  gcc-c++ \</span><br><span class="line">  make \</span><br><span class="line">  cmake \</span><br><span class="line">  autoconf \</span><br><span class="line">  automake \</span><br><span class="line">  libtool \</span><br><span class="line">  pkgconfig \</span><br><span class="line">  openssl-devel</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>编译RedisJSON</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /usr/local/soft/modules/</span><br><span class="line"><span class="built_in">cd</span> /usr/local/soft/modules</span><br><span class="line"><span class="comment"># clone 代码，这里 --recursive 是为了拉取子模块</span></span><br><span class="line">git <span class="built_in">clone</span> --recursive https://github.com/RedisJSON/RedisJSON.git</span><br><span class="line"><span class="built_in">cd</span> RedisJSON</span><br><span class="line"><span class="comment"># 推荐切换到稳定的release版本</span></span><br><span class="line">git checkout v2.8.16</span><br><span class="line"><span class="comment"># 更新子模块，非必须，如果上面 clone 时没有加上 --recursive ，这个步骤就不能省略</span></span><br><span class="line">git submodule update --init --recursive</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查并安装需要的依赖</span></span><br><span class="line">./sbin/setup</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line"><span class="comment"># readies version: 7fc8e62</span></span><br><span class="line">dnf install -q -y ca-certificates</span><br><span class="line">dnf install -q -y wget unzip</span><br><span class="line">/usr/local/soft/modules/RedisJSON/deps/readies/bin/enable-utf8</span><br><span class="line">dnf install -q -y git unzip rsync</span><br><span class="line">/usr/local/soft/modules/RedisJSON/deps/readies/bin/getclang --modern</span><br><span class="line">/usr/local/soft/modules/RedisJSON/deps/readies/bin/getrust</span><br><span class="line">/usr/local/soft/modules/RedisJSON/deps/readies/bin/getcmake --usr</span><br><span class="line">dnf install -q -y <span class="built_in">which</span></span><br><span class="line">/usr/local/soft/modules/RedisJSON/deps/readies/bin/getgcc --modern</span><br><span class="line"><span class="built_in">dir</span>=$(<span class="built_in">mktemp</span> -d /tmp/tar.XXXXXX); (<span class="built_in">cd</span> <span class="variable">$dir</span>; wget --no-verbose -O tar.tgz http://redismodules.s3.amazonaws.com/readies/gnu/gnu-tar-1.32-x64-centos7.tgz; tar -xzf tar.tgz -C /; ); <span class="built_in">rm</span> -rf <span class="variable">$dir</span></span><br><span class="line">dnf install -q -y lcov</span><br><span class="line">/usr/bin/python3 /usr/local/soft/modules/RedisJSON/deps/readies/bin/getrmpytools --reinstall --modern</span><br><span class="line">/usr/bin/python3 -m pip install --disable-pip-version-check --user  -r /usr/local/soft/modules/RedisJSON/tests/pytest/requirements.txt</span><br><span class="line">/usr/local/soft/modules/RedisJSON/deps/readies/bin/getaws</span><br><span class="line">NO_PY2=1 /usr/local/soft/modules/RedisJSON/deps/readies/bin/getpudb</span><br><span class="line"></span><br><span class="line"><span class="comment"># RedisJSON 的编译依赖 Rust 工具链，所以编译前需要安装rust，若已经安装则忽略</span></span><br><span class="line"><span class="comment"># 安装 rustup</span></span><br><span class="line">curl --proto <span class="string">&#x27;=https&#x27;</span> --tlsv1.2 -sSf https://sh.rustup.rs | sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按提示选择默认安装（通常选择 1）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 让 Rust 生效</span></span><br><span class="line"><span class="built_in">source</span> <span class="variable">$HOME</span>/.cargo/env</span><br><span class="line"><span class="comment"># 检查 rust 版本</span></span><br><span class="line">rustc --version <span class="comment"># rustc 1.92.0 (ded5c06cf 2025-12-08)</span></span><br><span class="line">cargo --version <span class="comment"># cargo 1.92.0 (344c4567c 2025-10-21)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译 RedisJSON</span></span><br><span class="line">make</span><br><span class="line"><span class="comment"># 编译过程未报错说明编译成功，编译后的文件位于 `bin/linux-x64-release/rejson.so`</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><div class="tips"><p><em><strong><code>./sbin/setup</code> 报错</strong></em></p><ul class="lvl-1"><li class="lvl-2">本人使用的是 Amazon Linux 2023(内核 6.1)，即 <code>EL9</code>，类似于CentOS 9，第一次运行会报错，大致报错信息如下：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">./sbin/setup</span><br><span class="line"><span class="comment">## 错误信息</span></span><br><span class="line">……</span><br><span class="line">[FAILED] raven-release.el9.noarch.rpm: Status code: 403 <span class="keyword">for</span> https://dyn.su/el9/base/x86_64/raven-release.el9.noarch.rpm (IP: 104.21.57.14)</span><br><span class="line">Status code: 403 <span class="keyword">for</span> https://dyn.su/el9/base/x86_64/raven-release.el9.noarch.rpm (IP: 104.21.57.14)</span><br><span class="line"></span><br><span class="line">In /usr/local/soft/modules/RedisJSON/deps/readies/bin/getepel:</span><br><span class="line">346      <span class="comment"># xinstall --allowerasing https://dl.fedoraproject.org/pub/epel/epel-release-latest-$&#123;EPEL&#125;.noarch.rpm</span></span><br><span class="line">347      <span class="keyword">fi</span></span><br><span class="line">348</span><br><span class="line">349  &gt;&gt;&gt; install_raven</span><br><span class="line">350      install_remi</span><br><span class="line">351      <span class="comment"># install_centos_stream_repos</span></span><br><span class="line">352</span><br><span class="line"></span><br><span class="line"><span class="built_in">command</span> failed: /usr/local/soft/modules/RedisJSON/deps/readies/bin/getepel</span><br><span class="line"><span class="built_in">command</span> failed: /usr/local/soft/modules/RedisJSON/deps/readies/bin/getclang --modern</span><br><span class="line"></span><br><span class="line">In /usr/local/soft/modules/RedisJSON/sbin/setup:</span><br><span class="line">18       python3 -m pip list</span><br><span class="line">19       <span class="keyword">fi</span></span><br><span class="line">20</span><br><span class="line">21   &gt;&gt;&gt; <span class="variable">$ROOT</span>/sbin/system-setup.py</span><br><span class="line">22       <span class="keyword">if</span> [[ <span class="variable">$VERBOSE</span> == 1 ]]; <span class="keyword">then</span></span><br><span class="line">23       python3 -m pip list</span><br><span class="line">24       <span class="keyword">fi</span></span><br></pre></td></tr></table></figure><ul class="lvl-1"><li class="lvl-2"><p>错误分析与解决方法：</p><ul class="lvl-3"><li class="lvl-6"><p>这里实际上是两个错误，第一个错误与安装 RedisBloom 时一样，禁用掉 <code>install_raven</code> 即可，具体参见 <a href="/2025/12/21/redis7-module-RedisBloom/" title="Redis 扩展模块 -- RedisBloom 的安装方法">Redis 扩展模块 -- RedisBloom 的安装方法</a> 进行修改。</p></li><li class="lvl-6"><p>第二个错误还是操作系统的事，在 <code>deps/readies/bin/getclang</code>中有一个方法，其实一看就明白了</p></li></ul>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">redhat_compat</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.modern:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="variable language_">self</span>.run(<span class="string">&quot;%s/bin/getepel&quot;</span> % READIES, sudo=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.dist <span class="keyword">in</span> [<span class="string">&#x27;centos&#x27;</span>, <span class="string">&#x27;ol&#x27;</span>] <span class="keyword">and</span> <span class="variable language_">self</span>.os_version[<span class="number">0</span>] &gt;= <span class="number">8</span>:</span><br><span class="line">        <span class="variable language_">self</span>.install(<span class="string">&quot;clang&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.install(<span class="string">&quot;llvm-toolset&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="variable language_">self</span>.install(<span class="string">&quot;llvm-toolset-7.0&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.cp_to_profile_d(<span class="string">&quot;/opt/rh/llvm-toolset-7.0/enable&quot;</span>, <span class="string">&quot;llvm-toolset-7.0.sh&quot;</span>)</span><br></pre></td></tr></table></figure><p>我使用的机器不是 centos，所以就走<code>else</code>的逻辑了，另外这里即便走了 centos 逻辑，也有问题，就是el9中已经没有 <code>llvm-toolset</code> 了，取而代之的是 <code>llvm</code>，所以需要修改该方法</p><ul class="lvl-3"><li class="lvl-6">修改方法如下：</li></ul>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">redhat_compat</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.modern:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="variable language_">self</span>.run(<span class="string">&quot;%s/bin/getepel&quot;</span> % READIES, sudo=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># 去掉判断，直接安装，前提是 el9，当然这里也可以什么都不写，而是通过命令行安装：dnf install -y clang llvm llvm-devel</span></span><br><span class="line">    <span class="variable language_">self</span>.install(<span class="string">&quot;clang&quot;</span>)</span><br><span class="line">    <span class="variable language_">self</span>.install(<span class="string">&quot;llvm&quot;</span>)</span><br></pre></td></tr></table></figure></li></ul></div><h2 id="Redis-启用模块">Redis 启用模块</h2><ul class="lvl-0"><li class="lvl-2"><p>将生成的 <code>rejson.so</code> 拷贝到 redis 的 modules 目录下（非必须），目录不存在则创建</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意 .so 文件需要包含可执行权限</span></span><br><span class="line"><span class="built_in">cp</span> bin/linux-x64-release/rejson.so /usr/local/soft/redis-7.4.7/modules/rejson.so</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>本文采用 <code>loadmodule</code> 加载模块</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 rejson.so 添加到 redis.conf 中，需要重启 redis</span></span><br><span class="line">loadmodule /usr/local/soft/redis-7.4.7/modules/rejson.so</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动redis</span></span><br><span class="line">redis-server redis.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录测试</span></span><br><span class="line">redis-cli --user admin --pass 123456</span><br><span class="line"><span class="comment"># 查看模块</span></span><br><span class="line">127.0.0.1:6379&gt; info Modules</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line"><span class="comment"># Modules</span></span><br><span class="line">module:name=ReJSON,ver=20816,api=1,filters=0,usedby=[],using=[],options=[handle-io-errors]</span><br><span class="line">module:name=bf,ver=20817,api=1,filters=0,usedby=[],using=[],options=[handle-io-errors]</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; MODULE LIST</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">1) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;ReJSON&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 20816</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/local/soft/redis-7.4.7/modules/rejson.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">2) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;bf&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 20817</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/local/soft/redis-7.4.7/modules/redisbloom.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文介绍 Redis 扩展模块 – RedisJSON 的安装方法&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文基于&lt;code&gt;redis-7.4.7&lt;/code&gt;，&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;操作系统：&lt;code&gt;Amazon Linux 2023(内核 6.1)&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis官网：&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis 命令文档：&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis 命令及数据类型 -- TDigest</title>
    <link href="https://blog.hanqunfeng.com/2025/12/23/redis7-datatype-15-TDigest/"/>
    <id>https://blog.hanqunfeng.com/2025/12/23/redis7-datatype-15-TDigest/</id>
    <published>2025-12-23T07:40:05.000Z</published>
    <updated>2025-12-23T09:53:35.193Z</updated>
    
    <content type="html"><![CDATA[<h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2">本文介绍 Redis 扩展模型 RedisBloom 中的 TDigest 数据类型</li><li class="lvl-2">本文基于<code>redis-7.4.7</code>，<code>springboot-3.5.8</code></li><li class="lvl-2">Redis官网：<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis 命令文档：<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li><li class="lvl-2">RedisBloom 的安装参见 <a href="/2025/12/21/redis7-module-RedisBloom/" title="Redis 扩展模块 -- RedisBloom 的安装方法">Redis 扩展模块 -- RedisBloom 的安装方法</a></li></ul><span id="more"></span><h2 id="T-Digest-分位数估计算法">T-Digest(分位数估计算法)</h2><ul class="lvl-0"><li class="lvl-2"><p>T-Digest（TDigest）解决的问题与 CMS、TopK 完全不同，核心目标是 分位数（quantile）统计。</p></li><li class="lvl-2"><p>T-Digest 由 Ted Dunning 提出，专门为 <code>高精度尾部分位数</code> 设计。</p></li><li class="lvl-2"><p>TDigest 可以在极低内存占用下，近似计算分位数（P50 / P90 / P99 / Median 等）。</p></li><li class="lvl-2"><p>分位数（Percentile）指标对照表</p></li></ul><table><thead><tr><th>指标</th><th>英文全称</th><th>数学含义</th><th>通俗解释</th><th>典型业务解读</th><th>常见使用场景</th></tr></thead><tbody><tr><td>Median</td><td>Median</td><td>排序后位于中间位置的值</td><td>一半数据在它左右</td><td>“一般用户的体验”</td><td>基础体验评估</td></tr><tr><td>P50</td><td>50th Percentile</td><td>50% 的数据 ≤ 该值</td><td>和 Median 完全相同</td><td>“典型请求耗时”</td><td>常规性能监控</td></tr><tr><td>P90</td><td>90th Percentile</td><td>90% 的数据 ≤ 该值</td><td>10% 的请求更慢</td><td>“大多数用户的体验”</td><td>业务体验监控</td></tr><tr><td>P95</td><td>95th Percentile</td><td>95% 的数据 ≤ 该值</td><td>5% 的请求更慢</td><td>“尾部开始恶化”</td><td>SLA 边界监控</td></tr><tr><td>P99</td><td>99th Percentile</td><td>99% 的数据 ≤ 该值</td><td>1% 的请求最慢</td><td>“极端但真实的用户体验”</td><td>核心 SLA / SLO</td></tr><tr><td>P99.9</td><td>99.9th Percentile</td><td>99.9% 的数据 ≤ 该值</td><td>千分之一最慢请求</td><td>“极端尾延迟”</td><td>金融 / 核心链路</td></tr><tr><td>Max</td><td>Maximum</td><td>数据中的最大值</td><td>最慢的那一次</td><td>噪音极大</td><td>几乎不用</td></tr></tbody></table><blockquote><p>一个快速理解示例</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">假设 100 次请求：</span><br><span class="line">    99 次耗时：10 ms</span><br><span class="line">    1 次耗时：3000 ms</span><br><span class="line"></span><br><span class="line">所以：</span><br><span class="line">    P99 = 3000 ms</span><br><span class="line">    P90 = 10 ms</span><br><span class="line">    P50/Median = 10 ms</span><br><span class="line">    平均值 = （99*10 + 1*3000）/ 100 = 39.9 ms</span><br><span class="line"></span><br><span class="line">👉 只有 P99 真实暴露了问题。</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>工程实践中的“标准搭配”</p></li></ul><table><thead><tr><th>应用场景</th><th>常看指标</th></tr></thead><tbody><tr><td>Web / API 服务</td><td>P90 / P99</td></tr><tr><td>微服务链路</td><td>P99 / P99.9</td></tr><tr><td>数据库 / 存储</td><td>P95 / P99</td></tr><tr><td>前端体验</td><td>P50 / P90</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>一句话：TDigest 用于统计数字的分布，P50 看中间，P90 看大多数，P99 看最差那 1%</p></li></ul><h2 id="RedisBloom-中-TDigest-的核心命令">RedisBloom 中 TDigest 的核心命令</h2><h3 id="创建-TDigest">创建 TDigest</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TDIGEST.CREATE key [COMPRESSION compression]</span></span><br><span class="line"><span class="comment"># 参数说明</span></span><br><span class="line"><span class="comment"># key： TDigest 的名称</span></span><br><span class="line"><span class="comment"># compression： 压缩级别，默认为 100，越大 → 精度越高 → 内存越大</span></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line">TDIGEST.CREATE latency:td COMPRESSION 200</span><br><span class="line"><span class="comment"># 返回值</span></span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取 TDigest 的类型</span></span><br><span class="line"><span class="built_in">type</span> latency:td</span><br><span class="line"><span class="comment"># 返回值</span></span><br><span class="line">TDIS-TYPE</span><br></pre></td></tr></table></figure><h3 id="添加样本">添加样本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TDIGEST.ADD key value [value ...]</span></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line">TDIGEST.ADD latency:td 12.3 15.7 100.4</span><br><span class="line"><span class="comment"># 返回值</span></span><br><span class="line">OK</span><br></pre></td></tr></table></figure><h3 id="查看最大-最小值">查看最大/最小值</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取最大值</span></span><br><span class="line"><span class="comment"># TDIGEST.MAX key</span></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line">TDIGEST.MAX latency:td</span><br><span class="line"><span class="comment"># 返回值</span></span><br><span class="line"><span class="string">&quot;100.4&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 取最小值</span></span><br><span class="line"><span class="comment"># TDIGEST.MIN key</span></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line">TDIGEST.MIN latency:td</span><br><span class="line"><span class="comment"># 返回值</span></span><br><span class="line"><span class="string">&quot;12.3&quot;</span></span><br></pre></td></tr></table></figure><h3 id="查询分位数">查询分位数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TDIGEST.QUANTILE key quantile [quantile ...]</span></span><br><span class="line"><span class="comment"># 参数说明</span></span><br><span class="line"><span class="comment"># key： TDigest 的名称</span></span><br><span class="line"><span class="comment"># quantile： 查询的分位数，0.5=&gt;P50 / 0.9=&gt;P90 / 0.99=&gt;P99</span></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line">TDIGEST.QUANTILE latency:td 0.5 0.9 0.99</span><br><span class="line"><span class="comment"># 返回值</span></span><br><span class="line">1) <span class="string">&quot;15.7&quot;</span></span><br><span class="line">2) <span class="string">&quot;100.4&quot;</span></span><br><span class="line">3) <span class="string">&quot;100.4&quot;</span></span><br></pre></td></tr></table></figure><h3 id="反向查询（值-→-百分位）">反向查询（值 → 百分位）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TDIGEST.CDF key value [value ...]</span></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line">TDIGEST.CDF latency:td 12.3 15.7 100.4 20</span><br><span class="line"><span class="comment"># 返回值</span></span><br><span class="line">1) <span class="string">&quot;0.16666666666666666&quot;</span></span><br><span class="line">2) <span class="string">&quot;0.5&quot;</span></span><br><span class="line">3) <span class="string">&quot;0.8333333333333334&quot;</span></span><br><span class="line">4) <span class="string">&quot;0.6666666666666666&quot;</span>  <span class="comment"># 这里注意 value 不必须在 TDIGEST 中，这里的含义是 P66=20，即 66% 的值都 ≤ 20</span></span><br></pre></td></tr></table></figure><h3 id="合并-TDigest">合并 TDigest</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TDIGEST.MERGE destination-key numkeys source-key [source-key ...] [COMPRESSION compression] [OVERRIDE]</span></span><br><span class="line"><span class="comment"># 参数说明</span></span><br><span class="line"><span class="comment"># destination-key： 目标 TDigest 的名称</span></span><br><span class="line"><span class="comment"># numkeys： 源 TDigest 的数量</span></span><br><span class="line"><span class="comment"># source-key： 源 TDigest 的名称</span></span><br><span class="line"><span class="comment"># compression： 压缩级别，默认为 100，越大 → 精度越高 → 内存越大</span></span><br><span class="line"><span class="comment"># OVERRIDE： 是否覆盖目标 TDigest，默认为 false</span></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line">TDIGEST.MERGE latency:td 2 latency:td:1 latency:td:2 COMPRESSION 200 OVERRIDE</span><br><span class="line"><span class="comment"># 返回值</span></span><br><span class="line">OK</span><br></pre></td></tr></table></figure><h3 id="获取近似排名">获取近似排名</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 正向排名</span></span><br><span class="line"><span class="comment"># TDIGEST.RANK key value [value ...]</span></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line"><span class="comment"># TDIGEST.ADD latency:td 12.3 15.7 100.4 # 假设这些数据已经写入了 TDigest</span></span><br><span class="line"><span class="comment"># 如果把 value 放入当前分布中，它的 rank（小于该值的样本数量）是多少</span></span><br><span class="line">TDIGEST.RANK latency:td 0 12.3 15.7 20 100.4 200</span><br><span class="line"><span class="comment"># 返回值</span></span><br><span class="line">1) (<span class="built_in">integer</span>) -1   <span class="comment"># 0: 小于最小值 12.3 → 返回 -1</span></span><br><span class="line">2) (<span class="built_in">integer</span>) 0    <span class="comment"># 12.3: 第 0 位 → 返回 0，真实存在的位数</span></span><br><span class="line">3) (<span class="built_in">integer</span>) 1    <span class="comment"># 15.7: 排在 12.3 后 → 返回 1，真实存在的位数</span></span><br><span class="line">4) (<span class="built_in">integer</span>) 2    <span class="comment"># 20: 介于 15.7 与 100.4 之间 → 返回 2</span></span><br><span class="line">5) (<span class="built_in">integer</span>) 2    <span class="comment"># 100.4: 第 2 位 → 20，真实存在的位数</span></span><br><span class="line">6) (<span class="built_in">integer</span>) 3    <span class="comment"># 200: 大于 100.4 → 返回 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 反向排名</span></span><br><span class="line"><span class="comment"># TDIGEST.REVRANK key value [value ...]</span></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line">TDIGEST.REVRANK latency:td 0 12.3 15.7 20 100.4 200</span><br></pre></td></tr></table></figure><h2 id="根据排名获取元素">根据排名获取元素</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 正向排名</span></span><br><span class="line"><span class="comment"># TDIGEST.BYRANK key rank [rank ...]</span></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line">TDIGEST.BYRANK latency:td 0 1 2 3</span><br><span class="line"><span class="comment"># 输出结果</span></span><br><span class="line">1) <span class="string">&quot;12.3&quot;</span></span><br><span class="line">2) <span class="string">&quot;15.7&quot;</span></span><br><span class="line">3) <span class="string">&quot;100.4&quot;</span></span><br><span class="line">4) <span class="string">&quot;inf&quot;</span>  <span class="comment"># 不存在</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 反向排名</span></span><br><span class="line"><span class="comment"># TDIGEST.BYREVRANK key rank [rank ...]</span></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line">TDIGEST.BYREVRANK latency:td 0 1 2 3</span><br></pre></td></tr></table></figure><h3 id="计算-TDigest-内部样本-去掉尾部极值后的平均近似值（Trimmed-Mean，截断均值）">计算 TDigest 内部样本 去掉尾部极值后的平均近似值（Trimmed Mean，截断均值）</h3><ul class="lvl-0"><li class="lvl-2"><p>去掉数据分布的极端尾部，只算主要集中区域的平均值，这样更能代表“绝大多数用户的体验”</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TDIGEST.TRIMMED_MEAN key low_cut_quantile high_cut_quantile</span></span><br><span class="line"><span class="comment"># 参数说明</span></span><br><span class="line"><span class="comment"># key： TDigest 的名称</span></span><br><span class="line"><span class="comment"># low_cut_quantile： 去掉的左侧百分比</span></span><br><span class="line"><span class="comment"># high_cut_quantile： 去掉的右侧百分比</span></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line">TDIGEST.TRIMMED_MEAN latency:td 0.05 0.95</span><br><span class="line"><span class="comment"># 输出结果</span></span><br><span class="line"><span class="string">&quot;42.800000000000004&quot;</span></span><br></pre></td></tr></table></figure><h3 id="获取-TDigest-的信息">获取 TDigest 的信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TDIGEST.INFO key</span></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line">TDIGEST.INFO latency:td</span><br><span class="line"><span class="comment"># 输出结果</span></span><br><span class="line"> 1) Compression     <span class="comment"># 压缩级别，控制质心的数量与精度。值越大 → 精度越高，内存稍大。</span></span><br><span class="line"> 2) (<span class="built_in">integer</span>) 200</span><br><span class="line"> 3) Capacity       <span class="comment"># 质心最大容量。表示内部能容纳的最大节点数，实际使用中 TDigest 会动态合并质心以控制内存。</span></span><br><span class="line"> 4) (<span class="built_in">integer</span>) 1210</span><br><span class="line"> 5) Merged nodes   <span class="comment"># 已合并的质心数量。这些是 TDigest 当前压缩后的节点，用于计算 rank / quantile。</span></span><br><span class="line"> 6) (<span class="built_in">integer</span>) 3</span><br><span class="line"> 7) Unmerged nodes <span class="comment"># 未合并的节点数量。表示新加入但尚未压缩到质心的样本。</span></span><br><span class="line"> 8) (<span class="built_in">integer</span>) 0</span><br><span class="line"> 9) Merged weight  <span class="comment"># 已合并质心的总权重。每个样本权重默认为 1，3 表示目前总共有 3 个样本被合并进质心。</span></span><br><span class="line">10) (<span class="built_in">integer</span>) 3</span><br><span class="line">11) Unmerged weight <span class="comment"># 未合并节点的权重总和。0 表示没有未压缩的样本</span></span><br><span class="line">12) (<span class="built_in">integer</span>) 0</span><br><span class="line">13) Observations    <span class="comment"># 观测到的样本总数。你 TDIGEST.ADD 的 3 个样本正好对应这个值。</span></span><br><span class="line">14) (<span class="built_in">integer</span>) 3</span><br><span class="line">15) Total compressions <span class="comment"># 已经执行的压缩次数。每次 TDigest 内部质心合并称为一次压缩。</span></span><br><span class="line">16) (<span class="built_in">integer</span>) 1</span><br><span class="line">17) Memory usage     <span class="comment"># Redis 为这个 TDigest 分配的内存（字节）。包含质心、索引、结构开销。TDigest 内存使用是固定的、与样本数量无关（主要由 Compression 决定）</span></span><br><span class="line">18) (<span class="built_in">integer</span>) 19368</span><br></pre></td></tr></table></figure><h3 id="清空元素">清空元素</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TDIGEST.RESET key</span></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line">TDIGEST.RESET latency:td</span><br><span class="line"><span class="comment"># 输出结果</span></span><br><span class="line">OK</span><br></pre></td></tr></table></figure><h2 id="TDigest-的内存与精度">TDigest 的内存与精度</h2><table><thead><tr><th>维度</th><th>特性</th></tr></thead><tbody><tr><td>内存占用</td><td>与 COMPRESSION 成正比（通常 KB 级）</td></tr><tr><td>精度</td><td>尾部分位数（P95/P99）极高</td></tr><tr><td>写入复杂度</td><td>近似 O(log n)</td></tr><tr><td>查询复杂度</td><td>O(log n)</td></tr></tbody></table><blockquote><p>与样本数量无关。</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文介绍 Redis 扩展模型 RedisBloom 中的 TDigest 数据类型&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文基于&lt;code&gt;redis-7.4.7&lt;/code&gt;，&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis官网：&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis 命令文档：&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;RedisBloom 的安装参见 &lt;a href=&quot;/2025/12/21/redis7-module-RedisBloom/&quot; title=&quot;Redis 扩展模块 -- RedisBloom 的安装方法&quot;&gt;Redis 扩展模块 -- RedisBloom 的安装方法&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis 命令及数据类型 -- TopK</title>
    <link href="https://blog.hanqunfeng.com/2025/12/23/redis7-datatype-14-TopK/"/>
    <id>https://blog.hanqunfeng.com/2025/12/23/redis7-datatype-14-TopK/</id>
    <published>2025-12-23T06:50:05.000Z</published>
    <updated>2025-12-24T03:37:03.539Z</updated>
    
    <content type="html"><![CDATA[<h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2">本文介绍 Redis 扩展模型 RedisBloom 中的 TopK 数据类型</li><li class="lvl-2">本文基于<code>redis-7.4.7</code>，<code>springboot-3.5.8</code></li><li class="lvl-2">Redis官网：<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis 命令文档：<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li><li class="lvl-2">RedisBloom 的安装参见 <a href="/2025/12/21/redis7-module-RedisBloom/" title="Redis 扩展模块 -- RedisBloom 的安装方法">Redis 扩展模块 -- RedisBloom 的安装方法</a></li></ul><span id="more"></span><h2 id="TopK">TopK</h2><ul class="lvl-0"><li class="lvl-2"><p>TopK，专门用于解决 “在海量数据流中，实时找出最热门的 N 个元素” 这一类问题</p></li><li class="lvl-2"><p>Top-K 属于流式重频（Heavy Hitters）算法家族，其目标不是记录所有元素，而是：</p><ul class="lvl-2"><li class="lvl-6">在受限内存下，持续维护出现频率最高的 K 个元素</li></ul></li><li class="lvl-3"><p>TopK 的核心特性</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">固定容量：只维护 K 个元素</span><br><span class="line">近似统计：计数可能略有误差</span><br><span class="line">自动淘汰：低频元素会被踢出</span><br><span class="line">写入极快：适合高 QPS</span><br><span class="line">内存稳定：与数据规模无关</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>RedisBloom 的 TopK 内部使用 CMS 作为频次估算基础，并结合<code>堆+淘汰策略</code>来维护热点集合。</p><ul class="lvl-2"><li class="lvl-6">CMS: 参考 <a href="/2025/12/23/redis7-datatype-13-CMS/" title="Redis 命令及数据类型 -- CMS(Count-Min Sketch)">Redis 命令及数据类型 -- CMS(Count-Min Sketch)</a></li><li class="lvl-6">堆+淘汰策略: TopK 在内部如何决定谁能进入 TopK、谁必须被踢出 TopK 的一整套机制。<ul class="lvl-4"><li class="lvl-10">堆：TopK 使用一个最小堆来维护 TopK 元素，TopK 维护 K 个候选元素，堆顶永远是 当前 TopK 中频次最低的那个</li><li class="lvl-10">淘汰策略：TopK 使用一个 LRU 缓存来记录最近访问的元素，当 TopK 元素数量达到上限时，将 LRU 缓存中的元素逐个加入 TopK，并更新 TopK 元素的频率。</li><li class="lvl-10">一句话：当新元素的估算频次超过当前最弱的那个时，就把弱者淘汰掉，让新元素进榜。</li></ul></li></ul></li></ul><h3 id="当一个新元素到来时，我该不该让它进入-TopK？">当一个新元素到来时，我该不该让它进入 TopK？</h3><ul class="lvl-0"><li class="lvl-2"><p>下面是 TopK 在 TOPK.ADD 时的真实逻辑抽象</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Step 1：更新 CMS（不存 item，只更新计数器）</span></span><br><span class="line">CMS.increment(item)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 2：item 是否在 TopK 显式集合中？</span></span><br><span class="line"><span class="keyword">if</span> item <span class="keyword">in</span> TopK:</span><br><span class="line">    <span class="comment"># 重新平衡堆位置</span></span><br><span class="line">    update_heap(item)</span><br><span class="line">    <span class="built_in">return</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 3：TopK 是否未满？</span></span><br><span class="line"><span class="keyword">if</span> TopK.size &lt; K:</span><br><span class="line">    TopK.insert(item)</span><br><span class="line">    <span class="built_in">return</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 4：比较 CMS 估算值</span></span><br><span class="line">freq_new = CMS.query(item)</span><br><span class="line">freq_min = CMS.query(TopK.min_item)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> freq_new &gt; freq_min:</span><br><span class="line">    TopK.evict_min()</span><br><span class="line">    TopK.insert(item)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># 什么都不做</span></span><br><span class="line">    pass</span><br></pre></td></tr></table></figure><h2 id="TopK-的应用场景">TopK 的应用场景</h2><table><thead><tr><th>问题</th><th>TopK 是否适合</th></tr></thead><tbody><tr><td>当前访问量最高的 URL</td><td>✅</td></tr><tr><td>搜索热词 Top 10</td><td>✅</td></tr><tr><td>商品点击榜</td><td>✅</td></tr><tr><td>所有商品的点击次数</td><td>❌</td></tr><tr><td>精确计数</td><td>❌</td></tr></tbody></table><h2 id="RedisBloom-TopK-的核心命令">RedisBloom TopK 的核心命令</h2><h3 id="创建-TopK">创建 TopK</h3><ul class="lvl-0"><li class="lvl-2"><p>使用 TopK 前必须先创建 TopK</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TOPK.RESERVE key topk [width depth decay]</span></span><br><span class="line"><span class="comment"># 参数说明</span></span><br><span class="line"><span class="comment"># key: 键名</span></span><br><span class="line"><span class="comment"># topk: 存储的元素数量，即统计的前 K 个元素</span></span><br><span class="line"><span class="comment"># width: 内部CMS 的宽度，默认 8</span></span><br><span class="line"><span class="comment"># depth: 内部CMS 的深度，默认 7</span></span><br><span class="line"><span class="comment"># decay: 衰减因子（0 ~ 1），默认 0.9</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line"><span class="comment"># 含义：维护访问量最高的 100 个 URL，允许历史热度逐渐衰减。</span></span><br><span class="line">TOPK.RESERVE topk:urls 100 2000 7 0.9</span><br><span class="line"><span class="comment"># 返回值</span></span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证类型</span></span><br><span class="line"><span class="built_in">type</span> topk:urls</span><br><span class="line"><span class="comment"># 返回值</span></span><br><span class="line">TopK-TYPE</span><br></pre></td></tr></table></figure><h3 id="添加元素">添加元素</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TOPK.ADD key items [items ...]</span></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line"><span class="comment"># 含义：添加元素 &quot;a&quot; 和 &quot;b&quot; 到 TopK 中</span></span><br><span class="line">TOPK.ADD topk:urls a b</span><br><span class="line"><span class="comment"># 返回值，被挤出 TopK 的元素（如果有）</span></span><br><span class="line">1) (nil)</span><br><span class="line">2) (nil)</span><br></pre></td></tr></table></figure><h3 id="增加元素的频率">增加元素的频率</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TOPK.INCRBY key item increment [item increment ...]</span></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line"><span class="comment"># 含义：将元素 &quot;a&quot; 的频率增加 1</span></span><br><span class="line">TOPK.INCRBY topk:urls a 1</span><br><span class="line"><span class="comment"># 输出结果</span></span><br><span class="line">1) (nil)</span><br></pre></td></tr></table></figure><h3 id="查询元素是否在-TopK-中">查询元素是否在 TopK 中</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TOPK.QUERY key item [item ...]</span></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line"><span class="comment"># 含义：查询元素 &quot;a&quot; 是否在 TopK 中</span></span><br><span class="line">TOPK.QUERY topk:urls a</span><br><span class="line"><span class="comment"># 返回值</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 1 <span class="comment"># 1 表示元素 &quot;a&quot; 在 TopK 中，0 表示元素 &quot;a&quot; 不在 TopK 中</span></span><br></pre></td></tr></table></figure><h3 id="获取-TopK-中的元素">获取 TopK 中的元素</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TOPK.LIST key [WITHCOUNT]</span></span><br><span class="line"><span class="comment"># 参数说明</span></span><br><span class="line"><span class="comment"># WITHCOUNT: 是否返回每个元素出现的次数，默认不返回</span></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line"><span class="comment"># 含义：获取 TopK 中的元素，并返回每个元素出现的次数</span></span><br><span class="line">TOPK.LIST topk:urls WITHCOUNT</span><br><span class="line"><span class="comment"># 输出结果</span></span><br><span class="line">1) <span class="string">&quot;a&quot;</span></span><br><span class="line">2) (<span class="built_in">integer</span>) 2</span><br><span class="line">3) <span class="string">&quot;b&quot;</span></span><br><span class="line">4) (<span class="built_in">integer</span>) 1</span><br></pre></td></tr></table></figure><h3 id="获取近似计数">获取近似计数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TOPK.COUNT key item [item ...]</span></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line"><span class="comment"># 含义：获取元素 &quot;a&quot; 的近似计数</span></span><br><span class="line">TOPK.COUNT topk:urls a</span><br><span class="line"><span class="comment"># 输出结果</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 2</span><br></pre></td></tr></table></figure><h3 id="查看TopK-的状态">查看TopK 的状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TOPK.INFO key</span></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line"><span class="comment"># 含义：查看 TopK 的状态</span></span><br><span class="line">TOPK.INFO topk:urls</span><br><span class="line"><span class="comment"># 输出结果</span></span><br><span class="line">1) k                    <span class="comment"># topk 的大小</span></span><br><span class="line">2) (<span class="built_in">integer</span>) 100</span><br><span class="line">3) width                <span class="comment"># 内部 CMS 的宽度</span></span><br><span class="line">4) (<span class="built_in">integer</span>) 2000</span><br><span class="line">5) depth                <span class="comment"># 内部 CMS 的深度</span></span><br><span class="line">6) (<span class="built_in">integer</span>) 7</span><br><span class="line">7) decay                <span class="comment"># 衰减因子</span></span><br><span class="line">8) <span class="string">&quot;0.9&quot;</span></span><br></pre></td></tr></table></figure><h2 id="TopK-的衰减（decay）参数怎么理解">TopK 的衰减（decay）参数怎么理解</h2><ul class="lvl-0"><li class="lvl-2"><p>decay 用于解决一个问题：“老热点永远霸榜，新热点上不来”</p></li></ul><table><thead><tr><th>decay</th><th>行为</th></tr></thead><tbody><tr><td>1.0</td><td>永不衰减（全历史统计）</td></tr><tr><td>0.9</td><td>越老的数据权重越低</td></tr><tr><td>0.5</td><td>热点更新非常快</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>经验值：</p><ul class="lvl-2"><li class="lvl-6">实时热点：0.8 ~ 0.9</li><li class="lvl-6">长周期榜单：0.95 ~ 1.0</li></ul></li></ul><h2 id="CMS-和-TopK-组合使用场景">CMS 和 TopK 组合使用场景</h2><h3 id="📌场景1：-实时热搜榜（最经典组合）">📌场景1： 实时热搜榜（最经典组合）</h3><ul class="lvl-0"><li class="lvl-2"><p>需求：统计所有搜索词频次（CMS），同时实时出TOP10热搜（TOPK），既知热度又能排序</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 初始化CMS（统计全量搜索词计数，误差0.001）</span></span><br><span class="line">cms.initbyprob search_count 0.001 0.01</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 初始化TOPK（取TOP10热搜）</span></span><br><span class="line">topk.reserve search_top10 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 用户搜索核心操作（2命令必一起执行）</span></span><br><span class="line"><span class="comment"># 搜索&quot;周杰伦&quot;，CMS计数+1，同时录入TOPK（自动累加热度）</span></span><br><span class="line">cms.incrby search_count 周杰伦 1</span><br><span class="line">topk.incrby search_top10 周杰伦 1</span><br><span class="line"></span><br><span class="line">cms.incrby search_count 原神 1</span><br><span class="line">topk.incrby search_top10 原神 1</span><br><span class="line">cms.incrby search_count 周杰伦 1  <span class="comment"># 重复搜索，双端同步+1</span></span><br><span class="line">topk.incrby search_top10 周杰伦 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 核心查询：先取TOP10，再查精准计数（组合核心）</span></span><br><span class="line"><span class="comment"># 第一步：取TOP10热搜列表</span></span><br><span class="line">topk.list search_top10  <span class="comment"># 返回：周杰伦、原神...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二步：查热搜词精准近似计数（CMS比TOPK.count更准）</span></span><br><span class="line">cms.query search_count 周杰伦  <span class="comment"># 返回2（精准）</span></span><br><span class="line">topk.count search_top10 周杰伦  <span class="comment"># 参考值，优先用CMS结果</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 辅助查询：判断词是否在热搜榜</span></span><br><span class="line">topk.query search_top10 周杰伦  <span class="comment"># 1=在，0=不在</span></span><br></pre></td></tr></table></figure><h2 id="TopK-vs-ZSET">TopK vs ZSET</h2><ul class="lvl-0"><li class="lvl-2"><p>能力边界对比</p></li></ul><table><thead><tr><th>能力</th><th>TopK</th><th>ZSet</th></tr></thead><tbody><tr><td>是否近似</td><td>✔️ 是</td><td>❌ 否</td></tr><tr><td>是否保存全部元素</td><td>❌ 只保存 Top K</td><td>✔️ 保存全部</td></tr><tr><td>频次是否精确</td><td>❌ 估计</td><td>✔️ 精确</td></tr><tr><td>是否支持排序</td><td>⚠️ 仅 Top K</td><td>✔️ 全量排序</td></tr><tr><td>是否可遍历</td><td>❌ 仅 K 个</td><td>✔️ 全量</td></tr><tr><td>是否支持删除</td><td>❌ 不支持</td><td>✔️ 支持</td></tr><tr><td>是否支持范围查询</td><td>❌</td><td>✔️</td></tr><tr><td>Top N 查询</td><td>✔️ 原生</td><td>✔️</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>性能与吞吐量对比</p></li></ul><table><thead><tr><th>维度</th><th>TopK</th><th>ZSet</th></tr></thead><tbody><tr><td>写入复杂度</td><td>O(d)</td><td>O(log N)</td></tr><tr><td>高并发写入</td><td>极优</td><td>一般</td></tr><tr><td>查询 TopK</td><td>O(K)</td><td>O(K)</td></tr><tr><td>查询单元素频次</td><td>O(d)</td><td>O(1)</td></tr><tr><td>批量写入</td><td>极快</td><td>较慢</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文介绍 Redis 扩展模型 RedisBloom 中的 TopK 数据类型&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文基于&lt;code&gt;redis-7.4.7&lt;/code&gt;，&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis官网：&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis 命令文档：&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;RedisBloom 的安装参见 &lt;a href=&quot;/2025/12/21/redis7-module-RedisBloom/&quot; title=&quot;Redis 扩展模块 -- RedisBloom 的安装方法&quot;&gt;Redis 扩展模块 -- RedisBloom 的安装方法&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis 命令及数据类型 -- CMS(Count-Min Sketch)</title>
    <link href="https://blog.hanqunfeng.com/2025/12/23/redis7-datatype-13-CMS/"/>
    <id>https://blog.hanqunfeng.com/2025/12/23/redis7-datatype-13-CMS/</id>
    <published>2025-12-23T06:40:05.000Z</published>
    <updated>2025-12-24T03:38:33.098Z</updated>
    
    <content type="html"><![CDATA[<h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2">本文介绍 Redis 扩展模型 RedisBloom 中的 Count-Min Sketch 数据类型</li><li class="lvl-2">本文基于<code>redis-7.4.7</code>，<code>springboot-3.5.8</code></li><li class="lvl-2">Redis官网：<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis 命令文档：<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li><li class="lvl-2">RedisBloom 的安装参见 <a href="/2025/12/21/redis7-module-RedisBloom/" title="Redis 扩展模块 -- RedisBloom 的安装方法">Redis 扩展模块 -- RedisBloom 的安装方法</a></li></ul><span id="more"></span><h2 id="Count-Min-Sketch">Count-Min Sketch</h2><ul class="lvl-0"><li class="lvl-2"><p>Count-Min Sketch（CMS） 用于在极低内存占用下，对高频写入的计数型数据进行近似统计，非常适合流量、事件、关键词等“只关心频次规模、不要求精确值”的场景。</p></li><li class="lvl-2"><p>Count-Min Sketch 是一种基于哈希的概率型计数结构，用于估算元素出现次数，具有以下核心特征：</p><ul class="lvl-2"><li class="lvl-6">只会高估，不会低估（over-estimation）</li><li class="lvl-6">固定内存，与元素种类数无关</li><li class="lvl-6">O(1) 的更新与查询复杂度</li><li class="lvl-6">不支持删除（或只能近似删除）</li><li class="lvl-6">只能返回给定元素近似统计其频次，而无法返回全部元素的统计频次</li></ul></li><li class="lvl-2"><p>基本工作原理（简化版）</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.初始化一个二维数组 counter[d][w]</span><br><span class="line">2.对每个元素 x：</span><br><span class="line">    a. 通过 d 个哈希函数映射到 d 行中的 w 个位置</span><br><span class="line">    b. 对对应的 d 个计数器全部 +1</span><br><span class="line">3.查询元素 x 的频次：</span><br><span class="line">    a.取这 d 个计数器的 最小值(取最小值是为了尽量抵消哈希冲突带来的“多加”)</span><br></pre></td></tr></table></figure><blockquote><p>注意下图中的数组不是二进制的，每次映射都会+1<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/Ybl5tj.png" alt=""></p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>误差与空间复杂度</p></li></ul><table><thead><tr><th>维度</th><th>说明</th></tr></thead><tbody><tr><td>误差上界</td><td>≤ ε × 总插入次数</td></tr><tr><td>错误概率</td><td>≤ δ</td></tr><tr><td>空间复杂度</td><td>O(1 / ε × log(1 / δ))</td></tr><tr><td>查询复杂度</td><td>O(d)</td></tr><tr><td>更新复杂度</td><td>O(d)</td></tr></tbody></table><blockquote><p>结论：数据量再大，内存不增长，代价是“精度换空间”</p></blockquote><h2 id="RedisBloom-中-CMS-的核心命令">RedisBloom 中 CMS 的核心命令</h2><h3 id="创建-CMS">创建 CMS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 按底层维度初始化</span></span><br><span class="line"><span class="comment"># CMS.INITBYDIM key width depth</span></span><br><span class="line"><span class="comment"># 参数说明</span></span><br><span class="line"><span class="comment"># width (w)：每一行的桶数（影响误差）</span></span><br><span class="line"><span class="comment"># depth (d)：哈希函数数量（影响冲突概率）</span></span><br><span class="line"><span class="comment"># 比如：</span></span><br><span class="line">CMS.INITBYDIM page:view 1000 10</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证类型</span></span><br><span class="line"><span class="built_in">type</span> page:view</span><br><span class="line"><span class="comment"># 返回值</span></span><br><span class="line">CMSk-TYPE</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按误差+容量初始化</span></span><br><span class="line"><span class="comment"># CMS.INITBYPROB page:view error probability</span></span><br><span class="line"><span class="comment"># 参数说明</span></span><br><span class="line"><span class="comment"># error (ε)：误差上界</span></span><br><span class="line"><span class="comment"># probability (δ)：超过误差上界的概率，这个数字越接近零，每个项目的内存消耗就越大，每次操作的CPU使用就越多。</span></span><br><span class="line"><span class="comment"># RedisBloom 会自动换算 w 和 d</span></span><br><span class="line"><span class="comment"># 比如：</span></span><br><span class="line">CMS.INITBYPROB key 0.001 0.01</span><br></pre></td></tr></table></figure><table><thead><tr><th>参数</th><th>数值</th><th>说明</th></tr></thead><tbody><tr><td><code>error</code></td><td><code>0.001</code></td><td>最大相对误差 ε = 0.1%</td></tr><tr><td><code>probability</code></td><td><code>0.01</code></td><td>只有 1% 的概率超过该误差</td></tr></tbody></table><h3 id="增加计数">增加计数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMS.INCRBY key item1 count1 item2 count2 ...</span></span><br><span class="line">CMS.INCRBY page:view home 1 about 1 home 1</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 1</span><br><span class="line">2) (<span class="built_in">integer</span>) 1</span><br><span class="line">3) (<span class="built_in">integer</span>) 2</span><br></pre></td></tr></table></figure><h3 id="查询计数">查询计数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMS.QUERY key item1 item2 ...</span></span><br><span class="line">CMS.QUERY page:view home about</span><br><span class="line"><span class="comment"># 返回的是 估算值（可能偏大）</span></span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 2</span><br><span class="line">2) (<span class="built_in">integer</span>) 1</span><br></pre></td></tr></table></figure><h3 id="合并-CMS">合并 CMS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMS.MERGE dest numkeys src1 src2 ... WEIGHTS w1 w2 ...</span></span><br><span class="line"><span class="comment"># 参数说明</span></span><br><span class="line"><span class="comment"># dest：目标 CMS，必须存在</span></span><br><span class="line"><span class="comment"># numkeys：源 CMS 数量</span></span><br><span class="line"><span class="comment"># src1 src2 ...：源 CMS，必须存在</span></span><br><span class="line"><span class="comment"># WEIGHTS w1 w2 ...：源 CMS 权重</span></span><br><span class="line">CMS.MERGE page:view 2 page:view:1 page:view:2 WEIGHTS 1 1</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">OK</span><br></pre></td></tr></table></figure><h3 id="获取-CMS-的信息">获取 CMS 的信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMS.INFO key</span></span><br><span class="line">CMS.INFO page:view</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">1) width            <span class="comment"># 每一行桶数 w</span></span><br><span class="line">2) (<span class="built_in">integer</span>) 1000</span><br><span class="line">3) depth            <span class="comment"># 哈希函数数量 d</span></span><br><span class="line">4) (<span class="built_in">integer</span>) 10</span><br><span class="line">5) count            <span class="comment"># 当前已插入的元素数量</span></span><br><span class="line">6) (<span class="built_in">integer</span>) 3</span><br></pre></td></tr></table></figure><h2 id="CMS-的使用场景">CMS 的使用场景</h2><h3 id="场景1：网站PV统计">场景1：网站PV统计</h3><ul class="lvl-0"><li class="lvl-2"><p>需求：统计网站 PV，即页面被访问的次数，允许0.1%的误差</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化 CMS</span></span><br><span class="line">CMS.INITBYPROB page:pv 0.001 0.01</span><br><span class="line"><span class="comment"># 添加计数</span></span><br><span class="line">CMS.INCRBY page:pv /home 1 /about 1</span><br><span class="line">CMS.INCRBY page:pv /home 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询计数</span></span><br><span class="line">CMS.QUERY page:pv /home</span><br></pre></td></tr></table></figure><h3 id="场景2：接口调用频次限流前置统计">场景2：接口调用频次限流前置统计</h3><ul class="lvl-0"><li class="lvl-2"><p>需求：统计接口调用次数，为限流提供已经，不需要精准计数，允许0.1%的误差</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 CMS</span></span><br><span class="line">CMS.INITBYPROB api:<span class="built_in">limit</span> 0.001 0.01</span><br><span class="line"><span class="comment"># 添加计数</span></span><br><span class="line">CMS.INCRBY api:<span class="built_in">limit</span> /api/user/list 1</span><br><span class="line"><span class="comment"># 获取计数</span></span><br><span class="line">CMS.QUERY api:<span class="built_in">limit</span> /api/user/list</span><br></pre></td></tr></table></figure><h2 id="CMS-vs-ZSET">CMS vs ZSET</h2><ul class="lvl-0"><li class="lvl-2"><p>能力边界对比</p></li></ul><table><thead><tr><th>能力</th><th>CMS</th><th>ZSet</th></tr></thead><tbody><tr><td>频次统计</td><td>✔️ 近似</td><td>✔️ 精确</td></tr><tr><td>是否存元素</td><td>❌ 不存</td><td>✔️ 存</td></tr><tr><td>是否可遍历元素</td><td>❌ 不可</td><td>✔️ 可</td></tr><tr><td>TopK / 排行</td><td>❌（需配合 TopK）</td><td>✔️ 天然支持</td></tr><tr><td>删除元素</td><td>❌ 不支持</td><td>✔️ 支持</td></tr><tr><td>误判 / 误差</td><td>✔️ 存在</td><td>❌ 无</td></tr><tr><td>是否可逆（查成员）</td><td>❌ 不可逆</td><td>✔️ 可逆</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>性能特征对比</p></li></ul><table><thead><tr><th>操作</th><th>CMS</th><th>ZSet</th></tr></thead><tbody><tr><td>插入 / 计数</td><td>O(d)（常数级）</td><td>O(log N)</td></tr><tr><td>查询频次</td><td>O(d)</td><td>O(1)</td></tr><tr><td>排名查询</td><td>❌</td><td>O(log N)</td></tr><tr><td>批量写入</td><td>极快</td><td>中等</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文介绍 Redis 扩展模型 RedisBloom 中的 Count-Min Sketch 数据类型&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文基于&lt;code&gt;redis-7.4.7&lt;/code&gt;，&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis官网：&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis 命令文档：&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;RedisBloom 的安装参见 &lt;a href=&quot;/2025/12/21/redis7-module-RedisBloom/&quot; title=&quot;Redis 扩展模块 -- RedisBloom 的安装方法&quot;&gt;Redis 扩展模块 -- RedisBloom 的安装方法&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis 命令及数据类型 -- CF(Cuckoo Filter)</title>
    <link href="https://blog.hanqunfeng.com/2025/12/22/redis7-datatype-12-CF/"/>
    <id>https://blog.hanqunfeng.com/2025/12/22/redis7-datatype-12-CF/</id>
    <published>2025-12-22T06:40:05.000Z</published>
    <updated>2026-01-06T10:10:32.852Z</updated>
    
    <content type="html"><![CDATA[<h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2">本文介绍 Redis 扩展模型 RedisBloom 中的 Cuckoo Filter 数据类型</li><li class="lvl-2">本文基于<code>redis-7.4.7</code>，<code>springboot-3.5.8</code></li><li class="lvl-2">Redis官网：<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis 命令文档：<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li><li class="lvl-2">RedisBloom 的安装参见 <a href="/2025/12/21/redis7-module-RedisBloom/" title="Redis 扩展模块 -- RedisBloom 的安装方法">Redis 扩展模块 -- RedisBloom 的安装方法</a></li><li class="lvl-2">示例代码：<a href="https://github.com/hanqunfeng/springbootchapter/tree/master/springboot3-demo/redis-demo/data-type-demo">GitHub</a></li></ul><span id="more"></span><h2 id="Cuckoo-Filter（布谷鸟过滤器）">Cuckoo Filter（布谷鸟过滤器）</h2><ul class="lvl-0"><li class="lvl-2"><p>Cuckoo Filter 是 Bloom Filter 的改进版，支持 动态添加和删除元素，仍能提供比布隆过滤器更高的查询性能。</p></li><li class="lvl-2"><p><a href="https://en.wikipedia.org/wiki/Cuckoo_filter">维基百科对 Cuckoo Filter 的描述</a></p></li><li class="lvl-2"><p>在高 QPS 查询场景下，Cuckoo Filter 通常优于 Bloom Filter。</p></li><li class="lvl-2"><p>优点：低误判率 + 高负载率，基于相同的集合和误报率，Cuckoo Filter通常占用空间更少。相对的，算法实现也就更复杂。</p></li><li class="lvl-2"><p>缺点：与Bloom Filter一样，有可能将一个不在集合中的元素错误的判断成在集合中</p></li><li class="lvl-2"><p>Bloom Filter 的误报率通过调整<code>位数组的大小</code>和<code>哈希函数数量</code>来控制，而 Cuckoo Filter 的误报率受<code>指纹大小</code>和<code>桶大小</code>控制。</p></li></ul><h3 id="布谷哈希算法">布谷哈希算法</h3><ul class="lvl-0"><li class="lvl-2"><p><a href="https://baike.baidu.com/item/Cockoo%20hash/3022855">百度百科对布谷哈希算法的描述</a>]</p></li><li class="lvl-2"><p>算法使用两个不同哈希函数计算对应 key 的位置。</p><ul class="lvl-2"><li class="lvl-6"><ol><li class="lvl-9">当两个哈希任意位置为空，则随机选择一个位置插入</li></ol></li><li class="lvl-6"><ol start="2"><li class="lvl-9">当两个哈希有位置为空时，则插入到空位置</li></ol></li><li class="lvl-6"><ol start="3"><li class="lvl-9">当两个哈希位置均不为空时，随机选择一个位置插入并踢出原key，原key会再次经过计算获得新的位置，转至1执行，反复直到成功或者达到最大迭代次数。</li></ol></li></ul></li></ul><h3 id="Cuckoo-Filter-的实现原理">Cuckoo Filter 的实现原理</h3><ul class="lvl-0"><li class="lvl-2"><p>布谷过滤器 是在<code>布谷哈希算法</code>的算法基础上扩充来的，但是它所提供的概念不是表，而是提供了多个数据桶(Bucket)</p></li><li class="lvl-2"><p>每一个数据桶都是个<code>一维数组</code>，每个数组的保存内容为<code>条目(Entry)</code>，每一个条目里面可以保存一个<code>指纹数据</code>(指纹数据就是原始数据经过哈希计算得到的一个n位的数据标记)，除了指纹数据之外，还会同时得出一个<code>保存位置P1标记</code>。</p></li><li class="lvl-2"><p>当两个数据计算得到的指纹数据相同时，就会发生冲突，冲突操作的解决思路是使用<code>布谷哈希算法</code>，简单说就是新的数据会将原有数据<code>踢出</code>，而被踢出的数据会被重新计算得到新的指纹数据和保存位置标记。</p></li><li class="lvl-2"><p>布谷过滤器里面需要进行各种数据的<code>踢出</code>操作，这个踢出的方式就是使用<code>P1标志位</code>和<code>指纹数据</code>进行<code>异或计算</code>得出来的<code>P2标志位</code>，按照同样的思路(前提:一直都有冲突操作)一直计算新的P2位，直到冲突解决或者达到最大迭代次数，就会失败。</p></li><li class="lvl-2"><p>指纹数据里面包含有<code>唯一性</code>，所以可以实现数据的删除，当然，不同的数据计算是有可能得到相同指纹的，那么一旦删除数据之后，有可能造成数据的&quot;假删除&quot;，所以布谷过滤器本身也是存在有误差的。</p></li><li class="lvl-2"><p>Cuckoo Filter 中的 <code>BUSKETSIZE</code></p><ul class="lvl-2"><li class="lvl-6">BUSKETSIZE，表示每个桶(Busket)中存放的元素个数，即桶大小。</li><li class="lvl-6">Cuckoo Filter的数组里存的不是位，而是桶(busket)，每个桶里可以存放多个数据。</li><li class="lvl-6">同一个桶中存放的数据越多，空间利用率更高，相应的误判率也就越高，性能也更慢。</li><li class="lvl-6">Redis的CuckooFilter实现中，BUSKETSIZE应该是一个在1到255之间的整数，默认的 BUSKETSIZE 是 <code>2</code>。</li><li class="lvl-6">桶(Busket)中并不实际保存数据本身，而是保存数据的指纹(fingerprint)。指纹越小，HASH冲突造成误判的几率就越小。这个参数的调整比较复杂，Redis的CuckooFilter中不支持调整这个参数。</li></ul></li></ul><h2 id="CF-命令说明">CF 命令说明</h2><ul class="lvl-0"><li class="lvl-2"><p>对应Redis命令： <code>CF.xxx</code></p></li></ul><table><thead><tr><th>命令</th><th>功能说明</th><th>是否创建 Filter</th><th>关键参数含义</th><th>返回值</th><th>示例</th><th>使用要点 / 备注</th></tr></thead><tbody><tr><td><strong>CF.RESERVE</strong></td><td>显式创建 Cuckoo Filter</td><td>是</td><td><code>capacity</code>：容量(必填)<br><code>BUCKETSIZE</code>：每个桶里最多能放多少个 fingerprint（指纹），默认 2(大多数情况下的最优解)<br><code>MAXITERATIONS</code>：重排次数，越大成功率越高<br><code>EXPANSION</code>：扩容倍数，默认 1（不扩容）</td><td>OK</td><td><code>CF.RESERVE user:cf 100000</code></td><td>✅ <strong>生产推荐</strong><br>支持删除与计数</td></tr><tr><td><strong>CF.ADD</strong></td><td>添加一个元素，不去重</td><td>是 （不存在则创建）</td><td><code>item</code>：元素</td><td>OK</td><td><code>CF.ADD user:cf user_1</code></td><td>若满可能失败</td></tr><tr><td><strong>CF.ADDNX</strong></td><td>元素不存在时才添加，去重</td><td>是 （不存在则创建）</td><td><code>item</code></td><td><code>1</code> 新增<br><code>0</code> 已存在</td><td><code>CF.ADDNX user:cf user_1</code></td><td>幂等写入首选</td></tr><tr><td><strong>CF.INSERT</strong></td><td>批量插入</td><td>是（不存在则创建）</td><td><code>ITEMS</code>：元素列表</td><td>OK</td><td><code>CF.INSERT user:cf ITEMS u1 u2</code></td><td>默认配置</td></tr><tr><td><strong>CF.INSERTNX</strong></td><td>批量插入（不存在才加）</td><td>是</td><td><code>ITEMS</code></td><td><code>0/1</code> 列表</td><td><code>CF.INSERTNX user:cf ITEMS u1 u2</code></td><td>幂等 + 批量</td></tr><tr><td><strong>CF.EXISTS</strong></td><td>判断单个元素是否存在</td><td>否</td><td><code>item</code></td><td><code>1</code> 可能存在<br><code>0</code> 不存在</td><td><code>CF.EXISTS user:cf user_1</code></td><td>仍有误判</td></tr><tr><td><strong>CF.MEXISTS</strong></td><td>批量判断是否存在</td><td>否</td><td><code>item...</code></td><td><code>0/1</code> 列表</td><td><code>CF.MEXISTS user:cf u1 u9</code></td><td>高并发推荐</td></tr><tr><td><strong>CF.COUNT</strong></td><td>返回元素出现次数</td><td>否</td><td><code>item</code></td><td>整数</td><td><code>CF.COUNT user:cf user_1</code></td><td>⭐ Bloom 没有的能力</td></tr><tr><td><strong>CF.DEL</strong></td><td>删除一个元素</td><td>否</td><td><code>item</code></td><td><code>1</code> 删除成功<br><code>0</code> 不存在</td><td><code>CF.DEL user:cf user_1</code></td><td>⭐ Bloom 不支持</td></tr><tr><td><strong><a href="http://CF.INFO">CF.INFO</a></strong></td><td>查看 Filter 元信息</td><td>否</td><td>无</td><td>KV 列表</td><td><code>CF.INFO user:cf</code></td><td>运维分析</td></tr><tr><td><strong>CF.SCANDUMP</strong></td><td>分块导出 Filter</td><td>否</td><td><code>iterator</code></td><td><code>iterator + data</code></td><td><code>CF.SCANDUMP user:cf 0</code></td><td>迁移 / 备份</td></tr><tr><td><strong>CF.LOADCHUNK</strong></td><td>从 dump 恢复 Filter</td><td>是</td><td><code>iterator + data</code></td><td>OK</td><td><code>CF.LOADCHUNK user:cf 1 &quot;xxx&quot;</code></td><td>与 SCANDUMP 配合</td></tr></tbody></table><h2 id="Bloom-vs-Cuckoo">Bloom vs Cuckoo</h2><table><thead><tr><th>维度</th><th>Bloom Filter</th><th>Cuckoo Filter</th></tr></thead><tbody><tr><td>查询复杂度</td><td>O(k)（k 个哈希函数）</td><td>O(1)（2–4 次 bucket 访问）</td></tr><tr><td>插入复杂度</td><td>O(k)</td><td>平均 O(1)，最坏可能触发重排</td></tr><tr><td>删除支持</td><td>❌ 原生不支持</td><td>✅ 原生支持</td></tr><tr><td>误判率（False Positive）</td><td>可配置，稳定</td><td>可配置，通常更低</td></tr><tr><td>漏判（False Negative）</td><td>❌ 理论上不会</td><td>❌ 理论上不会</td></tr><tr><td>空间利用率</td><td>高（但受 k 影响）</td><td>通常更高（特别是低误判率）</td></tr><tr><td>扩容成本</td><td>高（需重建）</td><td>中等（支持扩展策略）</td></tr><tr><td>实现复杂度</td><td>低</td><td>较高</td></tr></tbody></table><blockquote><p>RedisBloom Cuckoo Filter 不支持设置 <code>误判率</code>，通常 容量 越大，误判率越低。</p></blockquote><h2 id="CF-命令示例">CF 命令示例</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 Cuckoo Filter</span></span><br><span class="line"><span class="comment">## 容量1000，这个是必填参数。后面几个都是可选参数。</span></span><br><span class="line"><span class="comment">## BUSKETSIZE越大，空间利用率更高，但是误判率也更高，性能更差，默认2</span></span><br><span class="line"><span class="comment">## MAXITARATIONS越小，性能越好。如果设置越大，空间利用率就越好。默认20</span></span><br><span class="line"><span class="comment">## EXPANSION 是指空间扩容的比例。默认1，不扩容</span></span><br><span class="line">127.0.0.1:6379&gt; CF.RESERVE user:cf 1000 BUCKETSIZE 2 MAXITERATIONS 500 EXPANSION 2</span><br><span class="line">OK</span><br><span class="line"><span class="comment"># 添加元素</span></span><br><span class="line">127.0.0.1:6379&gt; CF.ADD user:cf user_1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; CF.ADD user:cf user_2</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"><span class="comment"># 可以重复添加元素</span></span><br><span class="line">127.0.0.1:6379&gt; CF.ADD user:cf user_1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"><span class="comment"># 返回元素出现次数</span></span><br><span class="line">127.0.0.1:6379&gt; CF.COUNT user:cf user_1</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line"><span class="comment"># 判断元素是否存在</span></span><br><span class="line">127.0.0.1:6379&gt; CF.EXISTS user:cf user_1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"><span class="comment"># 批量判断元素是否存在</span></span><br><span class="line">127.0.0.1:6379&gt; CF.MEXISTS user:cf user_1 user_2 user_100</span><br><span class="line">1) (<span class="built_in">integer</span>) 1</span><br><span class="line">2) (<span class="built_in">integer</span>) 1</span><br><span class="line">3) (<span class="built_in">integer</span>) 0</span><br><span class="line"><span class="comment"># 删除元素，一次只删除一个</span></span><br><span class="line">127.0.0.1:6379&gt; CF.DEL user:cf user_1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"><span class="comment"># 因为user_1有两个，所以才是还是能查询出 user_1</span></span><br><span class="line">127.0.0.1:6379&gt; CF.COUNT user:cf user_1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"><span class="comment"># 再次删除</span></span><br><span class="line">127.0.0.1:6379&gt; CF.DEL user:cf user_1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"><span class="comment"># 同名元素已全部删除，查询不到</span></span><br><span class="line">127.0.0.1:6379&gt; CF.COUNT user:cf user_1</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 元素不存在时才添加，幂等</span></span><br><span class="line">127.0.0.1:6379&gt; CF.ADDNX user:cf user_2</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; CF.ADDNX user:cf user_3</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Filter 元信息</span></span><br><span class="line">127.0.0.1:6379&gt; CF.INFO user:cf</span><br><span class="line"> 1) Size                      <span class="comment"># 当前 Cuckoo Filter 实际占用的内存大小（字节）</span></span><br><span class="line"> 2) (<span class="built_in">integer</span>) 1080</span><br><span class="line"> 3) Number of buckets         <span class="comment"># 当前过滤器中 bucket（桶）的总数量，Size = Number of buckets * Bucket size(默认为2)</span></span><br><span class="line"> 4) (<span class="built_in">integer</span>) 512</span><br><span class="line"> 5) Number of filters         <span class="comment"># 内部 子 Cuckoo Filter 的数量</span></span><br><span class="line"> 6) (<span class="built_in">integer</span>) 1</span><br><span class="line"> 7) Number of items inserted  <span class="comment"># 成功插入的元素总数（近似）</span></span><br><span class="line"> 8) (<span class="built_in">integer</span>) 2</span><br><span class="line"> 9) Number of items deleted   <span class="comment"># 已删除元素的累计次数</span></span><br><span class="line">10) (<span class="built_in">integer</span>) 2</span><br><span class="line">11) Bucket size               <span class="comment"># 每个 bucket 可容纳的 fingerprint 数，默认为 2</span></span><br><span class="line">12) (<span class="built_in">integer</span>) 2</span><br><span class="line">13) Expansion rate            <span class="comment"># 过滤器自动扩容倍率，默认为1，0 或 1 表示不扩容（满则失败）</span></span><br><span class="line">14) (<span class="built_in">integer</span>) 2</span><br><span class="line">15) Max iterations            <span class="comment"># Cuckoo Kick-out 的最大重排次数，值越大，插入成功率越高，但写入延迟可能上升</span></span><br><span class="line">16) (<span class="built_in">integer</span>) 500</span><br><span class="line"></span><br><span class="line"><span class="comment"># 批量添加，key不存在则创建</span></span><br><span class="line">127.0.0.1:6379&gt; CF.INSERT order:cf CAPACITY 100 ITEMS order1 order2</span><br><span class="line">1) (<span class="built_in">integer</span>) 1</span><br><span class="line">2) (<span class="built_in">integer</span>) 1</span><br><span class="line"><span class="comment"># 幂等，元素不存在时才添加</span></span><br><span class="line">127.0.0.1:6379&gt; CF.INSERTNX order:cf CAPACITY 100 ITEMS order1 order2 order100</span><br><span class="line">1) (<span class="built_in">integer</span>) 0</span><br><span class="line">2) (<span class="built_in">integer</span>) 0</span><br><span class="line">3) (<span class="built_in">integer</span>) 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看类型</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">type</span> order:cf</span><br><span class="line">MBbloomCF</span><br></pre></td></tr></table></figure><h2 id="SpringBoot-集成">SpringBoot 集成</h2><ul class="lvl-0"><li class="lvl-2"><p>SpringBoot 的 RedisTemplate 中没有提供对<code>RedisBloom</code>的封装，需要自己封装，我这里封装了一个简易的<code>RedisCuckooFilterTool</code></p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.redisbloom;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基于 RedisBloom 插件的 CuckooFilter 实现</span></span><br><span class="line"><span class="comment"> * https://github.com/RedisBloom/RedisBloom/releases</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisCuckooFilterTool</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisCuckooFilterTool</span><span class="params">(StringRedisTemplate redisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化 Cuckoo Filter</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 不能重复创建</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key      Filter 名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> capacity 预计容量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">reserve</span><span class="params">(String key, <span class="type">long</span> capacity)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;CF.RESERVE&#x27;, KEYS[1], &quot;</span> + capacity + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            redisTemplate.execute(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, String.class),</span><br><span class="line">                    Collections.singletonList(key)</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;RedisCuckooFilterTool reserve error:&quot;</span>,e);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化 Cuckoo Filter（高级参数）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 不能重复创建</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key           Filter 名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> capacity      预计容量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucketSize    每个桶里最多能放多少个 fingerprint（指纹），默认 2(大多数情况下的最优解)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> maxIterations 重排次数，越大成功率越高</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> expansion     扩容倍数，默认 1（不扩容）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">reserve</span><span class="params">(String key, <span class="type">long</span> capacity, <span class="type">int</span> bucketSize, <span class="type">int</span> maxIterations, <span class="type">int</span> expansion)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> String.format(</span><br><span class="line">                <span class="string">&quot;return redis.call(&#x27;CF.RESERVE&#x27;, KEYS[1], %d, &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;&#x27;BUCKETSIZE&#x27;, %d, &#x27;MAXITERATIONS&#x27;, %d, &#x27;EXPANSION&#x27;, %d)&quot;</span>,</span><br><span class="line">                capacity, bucketSize, maxIterations, expansion</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            redisTemplate.execute(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, String.class),</span><br><span class="line">                    Collections.singletonList(key)</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;RedisCuckooFilterTool reserve error:&quot;</span>,e);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加元素（不去重）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;CF.ADD&#x27;, KEYS[1], ARGV[1])&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Boolean</span> <span class="variable">execute</span> <span class="operator">=</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Boolean.class),</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                value</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE.equals(execute);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加元素（仅当不存在时）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 表示成功插入，false 表示已存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">addNx</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;CF.ADDNX&#x27;, KEYS[1], ARGV[1])&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Boolean</span> <span class="variable">execute</span> <span class="operator">=</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Boolean.class),</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                value</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE.equals(execute);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断元素是否存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">exists</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;CF.EXISTS&#x27;, KEYS[1], ARGV[1])&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Boolean</span> <span class="variable">execute</span> <span class="operator">=</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Boolean.class),</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                value</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE.equals(execute);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量判断是否存在</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 每个元素对应的结果，1 表示存在，0 表示不存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Long&gt; <span class="title function_">mexists</span><span class="params">(String key, String... items)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;CF.MEXISTS&#x27;, KEYS[1], unpack(ARGV))&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (items == <span class="literal">null</span> || items.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, List.class),</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                items</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回元素出现次数（近似）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">count</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;CF.COUNT&#x27;, KEYS[1], ARGV[1])&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Long.class),</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                value</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除元素</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 删除成功，false 表示不存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">delete</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;CF.DEL&#x27;, KEYS[1], ARGV[1])&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">execute</span> <span class="operator">=</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Long.class),</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                value</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE.equals(execute);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量插入，不去重</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 每个元素对应插入结果，1 插入成功，0 插入失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Long&gt; <span class="title function_">insert</span><span class="params">(String key, String... items)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;CF.INSERT&#x27;, KEYS[1], &#x27;ITEMS&#x27;, unpack(ARGV))&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (items == <span class="literal">null</span> || items.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, List.class),</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                items</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量插入，去重</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 每个元素对应插入结果，1 插入成功，0 插入失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Boolean&gt; <span class="title function_">insertNx</span><span class="params">(String key, String... items)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;CF.INSERTNX&#x27;, KEYS[1], &#x27;ITEMS&#x27;, unpack(ARGV))&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (items == <span class="literal">null</span> || items.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, List.class),</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                items</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取 Cuckoo Filter 元信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Long&gt; <span class="title function_">info</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;CF.INFO&#x27;, KEYS[1])&quot;</span>;</span><br><span class="line">        List&lt;Object&gt; result = redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, List.class),</span><br><span class="line">                Collections.singletonList(key)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result == <span class="literal">null</span> || result.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyMap();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Long&gt; infoMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; result.size(); i += <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">field</span> <span class="operator">=</span> toString(result.get(i));</span><br><span class="line">            <span class="type">Long</span> <span class="variable">value</span> <span class="operator">=</span> (Long) result.get(i + <span class="number">1</span>);</span><br><span class="line">            infoMap.put(field, value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> infoMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 字节数组转字符串</span></span><br><span class="line"><span class="comment">     * info 返回的 List</span></span><br><span class="line"><span class="comment">     * [</span></span><br><span class="line"><span class="comment">     * byte[](&quot;Size&quot;),                  Long(1080),</span></span><br><span class="line"><span class="comment">     * byte[](&quot;Number of buckets&quot;),     Long(512),</span></span><br><span class="line"><span class="comment">     * byte[](&quot;Number of filters&quot;),     Long(1),</span></span><br><span class="line"><span class="comment">     * ...</span></span><br><span class="line"><span class="comment">     * ]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">toString</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> <span class="type">byte</span>[]) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>((<span class="type">byte</span>[]) obj);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文介绍 Redis 扩展模型 RedisBloom 中的 Cuckoo Filter 数据类型&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文基于&lt;code&gt;redis-7.4.7&lt;/code&gt;，&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis官网：&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis 命令文档：&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;RedisBloom 的安装参见 &lt;a href=&quot;/2025/12/21/redis7-module-RedisBloom/&quot; title=&quot;Redis 扩展模块 -- RedisBloom 的安装方法&quot;&gt;Redis 扩展模块 -- RedisBloom 的安装方法&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;示例代码：&lt;a href=&quot;https://github.com/hanqunfeng/springbootchapter/tree/master/springboot3-demo/redis-demo/data-type-demo&quot;&gt;GitHub&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis 命令及数据类型 -- BF(Bloom Filter)</title>
    <link href="https://blog.hanqunfeng.com/2025/12/22/redis7-datatype-11-BF/"/>
    <id>https://blog.hanqunfeng.com/2025/12/22/redis7-datatype-11-BF/</id>
    <published>2025-12-22T05:40:05.000Z</published>
    <updated>2026-01-06T10:10:11.963Z</updated>
    
    <content type="html"><![CDATA[<h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2">本文介绍 Redis 扩展模型 RedisBloom 中的 Bloom Filter 数据类型</li><li class="lvl-2">本文基于<code>redis-7.4.7</code>，<code>springboot-3.5.8</code></li><li class="lvl-2">Redis官网：<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis 命令文档：<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li><li class="lvl-2">RedisBloom 的安装参见 <a href="/2025/12/21/redis7-module-RedisBloom/" title="Redis 扩展模块 -- RedisBloom 的安装方法">Redis 扩展模块 -- RedisBloom 的安装方法</a></li><li class="lvl-2">示例代码：<a href="https://github.com/hanqunfeng/springbootchapter/tree/master/springboot3-demo/redis-demo/data-type-demo">GitHub</a></li></ul><span id="more"></span><h2 id="Bloom-Filter-布隆过滤器">Bloom Filter(布隆过滤器)</h2><ul class="lvl-0"><li class="lvl-2"><p>布隆过滤器是一种用于快速判断元素是否存在的 probabilistic data structure（概率数据结构），非常适合海量数据且不要求绝对精确的场景。</p></li><li class="lvl-2"><p><a href="https://en.wikipedia.org/wiki/Bloom_filter">维基百科对 Bloom Filter 的描述</a></p></li><li class="lvl-2"><p>生产环境推荐使用 <a href="https://redisson.pro/docs/data-and-services/objects/#bloom-filter">Redisson的布隆过滤器</a></p></li><li class="lvl-2"><p>布隆过滤器使用一个很长的二进制位数组和一系列哈希函数来保存元素。</p><ul class="lvl-2"><li class="lvl-6">优点: 非常节省空间、查询快</li><li class="lvl-6">缺点: 有一定的误判概率、无法删除元素、无法给元素计数</li></ul></li><li class="lvl-2"><p>布隆过滤器判断一个元素不在集合中，那么这个元素肯定不在集合中。但是，布隆过滤器判断一个元素在集合中，那么这个元素有可能不在集合中。<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/l7rGDM.png" alt=""></p></li><li class="lvl-2"><p>位数组（Bit Array）：布隆过滤器使用一个长度固定的位数组来存储数据。每个位置只占用一个比特（0或1），初始时所有位都设置为0。位数组的长度和哈希函数的数量决定了过滤器的误报率和容量。</p></li><li class="lvl-2"><p>哈希函数集合：布隆过滤器使用多个哈希函数，每个函数都会将输入数据映射到位数组的一个不同位置。哈希函数的选择对过滤器的性能有很大影响，理想的哈希函数应该具有良好的散列性，使得不同的输入尽可能均匀地映射到位数组的不同位置。</p></li><li class="lvl-2"><p>如何降低误判率？</p><ul class="lvl-2"><li class="lvl-6">更大的位数组</li><li class="lvl-6">更多的哈希函数</li></ul></li><li class="lvl-2"><p>很多人都是用过Google开源的Guava的布隆过滤器，但其是JVM层的布隆过滤器，若需要分布式布隆过滤器，就可以使用RedisBloom提供的BF(Bloom Filter)。</p></li></ul><h2 id="BF-命令说明">BF 命令说明</h2><ul class="lvl-0"><li class="lvl-2"><p>对应Redis命令： <code>BF.xxx</code></p></li></ul><table><thead><tr><th>命令</th><th>功能说明</th><th>是否创建 Filter</th><th>关键参数含义</th><th>返回值</th><th>示例</th><th>使用要点 / 备注</th></tr></thead><tbody><tr><td><strong>BF.RESERVE</strong></td><td>显式创建 Bloom Filter</td><td>是（已存在则报错）</td><td><code>error_rate</code>：误判率<br><code>capacity</code>：预计元素数<br><code>EXPANSION</code>：扩容倍率</td><td>OK</td><td><code>BF.RESERVE user:bf 0.001 1000000</code></td><td>✅ <strong>生产推荐</strong><br>显式规划容量与误判率，避免隐式创建</td></tr><tr><td><strong>BF.ADD</strong></td><td>添加单个元素</td><td>是（不存在则创建）</td><td>无</td><td><code>1</code> 新增<br><code>0</code> 可能已存在</td><td><code>BF.ADD user:bf user_1</code></td><td>Key 必须已存在，否则报错</td></tr><tr><td><strong>BF.MADD</strong></td><td>批量添加元素</td><td>是（不存在则创建）</td><td><code>item...</code>：多个元素</td><td><code>0/1</code> 列表</td><td><code>BF.MADD user:bf u1 u2 u3</code></td><td>⚠ 使用默认配置，不建议生产</td></tr><tr><td><strong>BF.INSERT</strong></td><td>批量插入（可控参数）</td><td>是</td><td><code>CAPACITY</code>：容量<br><code>ERROR</code>：误判率<br><code>NOCREATE</code>:不自动创建过滤器<br><code>NONSCALING</code>: 不扩容，达到capacity时，过滤器返回错误<br><code>EXPANSION expansion</code>:扩容时，新建子过滤器的容量增长倍率，默认2 <br><code>ITEMS</code>：元素列表</td><td><code>0/1</code> 列表</td><td><code>BF.INSERT user:bf CAPACITY 10000 ERROR 0.001 ITEMS u1 u2</code></td><td>✅ <strong>最推荐的写入方式</strong><br>支持初始化 + 插入</td></tr><tr><td><strong>BF.EXISTS</strong></td><td>判断单个元素是否存在</td><td>否</td><td><code>item</code>：待判断元素</td><td><code>1</code> 可能存在<br><code>0</code> 一定不存在</td><td><code>BF.EXISTS user:bf user_1</code></td><td>不存在结果 <strong>绝对可靠</strong></td></tr><tr><td><strong>BF.MEXISTS</strong></td><td>批量判断是否存在</td><td>否</td><td><code>item...</code>：多个元素</td><td><code>0/1</code> 列表</td><td><code>BF.MEXISTS user:bf u1 u9</code></td><td>高并发批量查询首选</td></tr><tr><td><strong>BF.CARD</strong></td><td>返回插入元素数量（近似）</td><td>否</td><td>无</td><td>整数</td><td><code>BF.CARD user:bf</code></td><td>用于容量监控，非精确</td></tr><tr><td><strong><a href="http://BF.INFO">BF.INFO</a></strong></td><td>返回 Bloom Filter 元信息</td><td>否</td><td>无</td><td>KV 列表</td><td><code>BF.INFO user:bf</code></td><td>运维、容量与内存分析必备</td></tr><tr><td><strong>BF.SCANDUMP</strong></td><td>分块导出 Bloom Filter</td><td>否</td><td><code>iterator</code>：游标</td><td><code>iterator + data</code></td><td><code>BF.SCANDUMP user:bf 0</code></td><td>用于迁移、备份</td></tr><tr><td><strong>BF.LOADCHUNK</strong></td><td>从 dump 数据恢复 Filter</td><td>是</td><td><code>iterator</code><br><code>data</code></td><td>OK</td><td><code>BF.LOADCHUNK user:bf 1 &quot;xxx&quot;</code></td><td>必须与 SCANDUMP 配合使用</td></tr></tbody></table><h2 id="BF-命令示例">BF 命令示例</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化一个BloomFilter，错误率0.01，元素数量1000</span></span><br><span class="line">127.0.0.1:6379&gt; BF.RESERVE <span class="built_in">test</span> 0.01 1000</span><br><span class="line">OK</span><br><span class="line"><span class="comment"># 查看类型</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">type</span> <span class="built_in">test</span></span><br><span class="line">MBbloom--</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加元素</span></span><br><span class="line">127.0.0.1:6379&gt; BF.ADD <span class="built_in">test</span> user1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; BF.ADD <span class="built_in">test</span> user2</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"><span class="comment"># 批量添加元素</span></span><br><span class="line">127.0.0.1:6379&gt; BF.MADD <span class="built_in">test</span> user3 user4 user5</span><br><span class="line">1) (<span class="built_in">integer</span>) 1</span><br><span class="line">2) (<span class="built_in">integer</span>) 1</span><br><span class="line">3) (<span class="built_in">integer</span>) 1</span><br><span class="line"><span class="comment"># 返回Bloom过滤器的基数，即添加的元素数量(存在误差)</span></span><br><span class="line">127.0.0.1:6379&gt; BF.CARD <span class="built_in">test</span></span><br><span class="line">(<span class="built_in">integer</span>) 5</span><br><span class="line"><span class="comment"># 查询元素是否存在</span></span><br><span class="line">127.0.0.1:6379&gt; BF.EXISTS <span class="built_in">test</span> user2</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; BF.EXISTS <span class="built_in">test</span> user6</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line"><span class="comment"># 批量查询元素是否存在</span></span><br><span class="line">127.0.0.1:6379&gt; BF.MEXISTS <span class="built_in">test</span> user1 user2 user6</span><br><span class="line">1) (<span class="built_in">integer</span>) 1</span><br><span class="line">2) (<span class="built_in">integer</span>) 1</span><br><span class="line">3) (<span class="built_in">integer</span>) 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取信息</span></span><br><span class="line">127.0.0.1:6379&gt; BF.INFO <span class="built_in">test</span></span><br><span class="line"> 1) Capacity       <span class="comment"># 初始化时的容量，超过该值后，会触发 扩容（新建一个子 Bloom Filter）</span></span><br><span class="line"> 2) (<span class="built_in">integer</span>) 1000</span><br><span class="line"> 3) Size           <span class="comment"># 当前 Bloom Filter 实际使用的 bit array 大小（字节)，由 capacity + error_rate 计算得出，值一旦创建 不会随元素减少</span></span><br><span class="line"> 4) (<span class="built_in">integer</span>) 1480</span><br><span class="line"> 5) Number of filters <span class="comment"># 当前 key 内部包含的 Bloom Filter 数量</span></span><br><span class="line"> 6) (<span class="built_in">integer</span>) 1</span><br><span class="line"> 7) Number of items inserted  <span class="comment"># 已调用 BF.ADD / BF.MADD 插入的元素总数</span></span><br><span class="line"> 8) (<span class="built_in">integer</span>) 5</span><br><span class="line"> 9) Expansion rate     <span class="comment"># Bloom Filter 扩容时，新建子过滤器的容量增长倍率</span></span><br><span class="line">10) (<span class="built_in">integer</span>) 2</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="SpringBoot-集成">SpringBoot 集成</h2><ul class="lvl-0"><li class="lvl-2"><p>SpringBoot 的 RedisTemplate 中没有提供对<code>RedisBloom</code>的封装，需要自己封装，我这里封装了一个简易的<code>RedisBloomFilterTool</code></p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.redisbloom;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基于 RedisBloom 插件的 BloomFilter 实现</span></span><br><span class="line"><span class="comment"> * https://github.com/RedisBloom/RedisBloom/releases</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 不想安装插件也可以使用 Redission 的 BloomFilter</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisBloomFilterTool</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisBloomFilterTool</span><span class="params">(StringRedisTemplate redisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化 BloomFilter</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 不能重复创建</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key       BloomFilter 名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> errorRate 错误率，比如为0.01，即 1%</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> capacity  容量，比如为1000</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">reserve</span><span class="params">(String key, <span class="type">double</span> errorRate, <span class="type">long</span> capacity)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;BF.RESERVE&#x27;, KEYS[1], &quot;</span> + errorRate + <span class="string">&quot;, &quot;</span> + capacity + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.execute(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, String.class),</span><br><span class="line">                    Collections.singletonList(key)</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;RedisBloomFilterTool reserve error:&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加元素到 BloomFilter，BloomFilter 不存在会自动创建</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">        <span class="comment">// 使用 RedisModule 提供的 BF.ADD 命令</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;BF.ADD&#x27;, KEYS[1], ARGV[1])&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Boolean</span> <span class="variable">execute</span> <span class="operator">=</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Boolean.class),</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                value</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE.equals(execute);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断元素是否存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">exists</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;BF.EXISTS&#x27;, KEYS[1], ARGV[1])&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Boolean</span> <span class="variable">execute</span> <span class="operator">=</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Boolean.class),</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                value</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE.equals(execute);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量添加</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 添加结果列表，成功 1，失败 0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Long&gt; <span class="title function_">addBatch</span><span class="params">(String key, String... items)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;BF.MADD&#x27;, KEYS[1], unpack(ARGV))&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (items == <span class="literal">null</span> || items.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 调用 BF.MADD 命令</span></span><br><span class="line">        <span class="keyword">return</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, List.class),</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                items</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量添加，如果BloomFilter不存在，则根据参数创建 BloomFilter，若已存在，则忽略 capacity 和 errorRate</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key       BloomFilter 名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> capacity  容量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> errorRate 错误率</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> items     要添加的元素</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 添加结果列表，成功 1，失败 0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Long&gt; <span class="title function_">insert</span><span class="params">(String key, <span class="type">long</span> capacity, <span class="type">double</span> errorRate, String... items)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;BF.INSERT&#x27;, KEYS[1], &#x27;CAPACITY&#x27;, ARGV[1], &#x27;ERROR&#x27;, ARGV[2], &#x27;ITEMS&#x27;, unpack(ARGV, 3))&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (items == <span class="literal">null</span> || items.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;Object&gt; args = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        args.add(String.valueOf(capacity));</span><br><span class="line">        args.add(String.valueOf(errorRate));</span><br><span class="line">        Collections.addAll(args, items);   <span class="comment">// ✅ 关键点</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用 BF.INSERT 命令</span></span><br><span class="line">        <span class="keyword">return</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, List.class),</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                args.toArray()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量判断元素是否存在</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 存在 1，不存在 0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Long&gt; <span class="title function_">mexists</span><span class="params">(String key, String... items)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;BF.MEXISTS&#x27;, KEYS[1], unpack(ARGV))&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (items == <span class="literal">null</span> || items.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用 BF.MADD 命令</span></span><br><span class="line">        <span class="keyword">return</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, List.class),</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                items</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取元素数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">card</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;BF.CARD&#x27;, KEYS[1])&quot;</span>;</span><br><span class="line">        <span class="comment">// 使用 RedisModule 提供的 BF.CARD 命令</span></span><br><span class="line">        <span class="keyword">return</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Long.class),</span><br><span class="line">                Collections.singletonList(key)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取 Bloom Filter 元信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Long&gt; <span class="title function_">info</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;BF.INFO&#x27;, KEYS[1])&quot;</span>;</span><br><span class="line"></span><br><span class="line">        List&lt;Object&gt; result = redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, List.class),</span><br><span class="line">                Collections.singletonList(key)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result == <span class="literal">null</span> || result.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyMap();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Long&gt; infoMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; result.size(); i += <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">field</span> <span class="operator">=</span> toString(result.get(i));</span><br><span class="line">            <span class="type">Long</span> <span class="variable">value</span> <span class="operator">=</span> (Long) result.get(i + <span class="number">1</span>);</span><br><span class="line">            infoMap.put(field, value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> infoMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">toString</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> <span class="type">byte</span>[]) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>((<span class="type">byte</span>[]) obj);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="SpringBoot-与-Redisson-集成之-BloomFilter-的使用方法">SpringBoot 与 Redisson 集成之 BloomFilter 的使用方法</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.52.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">……………………………………………………………………………………………………………………………………………………………………………………………………………………</span><br><span class="line">RBloomFilter&lt;Object&gt; bloomFilter = redissonClient.getBloomFilter(<span class="string">&quot;bloomFilter&quot;</span>);</span><br><span class="line">bloomFilter.tryInit(<span class="number">1000000</span>, <span class="number">0.01</span>); <span class="comment">// 初始化</span></span><br><span class="line">bloomFilter.add(<span class="string">&quot;test&quot;</span>); <span class="comment">// 添加元素</span></span><br><span class="line">System.out.println(bloomFilter.contains(<span class="string">&quot;test&quot;</span>)); <span class="comment">// 判断是否存在</span></span><br><span class="line">System.out.println(bloomFilter.count()); <span class="comment">// 获取当前布隆过滤器中已添加的元素个数</span></span><br><span class="line">System.out.println(bloomFilter.getSize()); <span class="comment">// 获取当前布隆过滤器占用内存的大小，单位bit</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文介绍 Redis 扩展模型 RedisBloom 中的 Bloom Filter 数据类型&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文基于&lt;code&gt;redis-7.4.7&lt;/code&gt;，&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis官网：&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis 命令文档：&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;RedisBloom 的安装参见 &lt;a href=&quot;/2025/12/21/redis7-module-RedisBloom/&quot; title=&quot;Redis 扩展模块 -- RedisBloom 的安装方法&quot;&gt;Redis 扩展模块 -- RedisBloom 的安装方法&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;示例代码：&lt;a href=&quot;https://github.com/hanqunfeng/springbootchapter/tree/master/springboot3-demo/redis-demo/data-type-demo&quot;&gt;GitHub&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis 扩展模块 -- RedisBloom 的安装方法</title>
    <link href="https://blog.hanqunfeng.com/2025/12/21/redis7-module-RedisBloom/"/>
    <id>https://blog.hanqunfeng.com/2025/12/21/redis7-module-RedisBloom/</id>
    <published>2025-12-21T13:30:05.000Z</published>
    <updated>2026-01-05T02:00:34.824Z</updated>
    
    <content type="html"><![CDATA[<h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2">本文介绍 Redis 扩展模块 – RedisBloom 的安装方法</li><li class="lvl-2">本文基于<code>redis-7.4.7</code>，<code>springboot-3.5.8</code></li><li class="lvl-2">操作系统：<code>Amazon Linux 2023(内核 6.1)</code></li><li class="lvl-2">Redis官网：<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis 命令文档：<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li></ul><span id="more"></span><h2 id="RedisBloom-简介">RedisBloom 简介</h2><ul class="lvl-0"><li class="lvl-2"><p><a href="https://github.com/RedisBloom/RedisBloom">RedisBloom</a> 是 Redis 官方维护的一个扩展模块，隶属于 <code>Redis Stack</code>，专门用于提供概率型数据结构（Probabilistic Data Structures）的高性能实现。</p></li><li class="lvl-2"><p>它通过牺牲一定的精确性，换取极低的内存占用和极高的吞吐能力，非常适合海量数据场景下的“存在性判断”和“近似统计”。</p></li><li class="lvl-2"><p>该模块以 <code>Redis Module</code> 方式加载，可无缝集成到现有 Redis 实例中。</p></li><li class="lvl-2"><p>Redis8+，RedisBloom 已经内置在 Redis 中，可以在安装redis同时安装全部 Stack 模块。</p></li></ul><h2 id="RedisBloom-提供的核心数据结构">RedisBloom 提供的核心数据结构</h2><ul class="lvl-0"><li class="lvl-2"><p>安装好RedisBloom后，我们可以通过如下方式查看RedisBloom 支持的命令</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 实际上所有 Stack Module Commands都是通过如下命令查看，因为我们这里只安装了 RedisBloom，所以此时仅可以看到 RedisBloom 模块的命令</span></span><br><span class="line">&gt; <span class="built_in">help</span> @module</span><br></pre></td></tr></table></figure><h3 id="通过输出我们可以看到-RedisBloom-模块支持的命令大致分为-5-类">通过输出我们可以看到 RedisBloom 模块支持的命令大致分为 5 类</h3><ul class="lvl-0"><li class="lvl-2"><p>1️⃣ Bloom Filter（布隆过滤器）</p><ul class="lvl-2"><li class="lvl-6">判断某个元素“可能存在 / 一定不存在”，但不存储元素本身，也不支持删除</li><li class="lvl-6"><a href="https://en.wikipedia.org/wiki/Bloom_filter">维基百科对 Bloom Filter 的描述</a></li><li class="lvl-6">生产环境推荐使用 <a href="https://redisson.pro/docs/data-and-services/objects/#bloom-filter">Redisson的布隆过滤器</a></li><li class="lvl-6">对应Redis命令： <code>BF.xxx</code>，详细的使用方法参见 <a href="/2025/12/22/redis7-datatype-11-BF/" title="Redis 命令及数据类型 -- BF(Bloom Filter)">Redis 命令及数据类型 -- BF(Bloom Filter)</a></li></ul></li><li class="lvl-2"><p>2️⃣ Cuckoo Filter（布谷鸟过滤器）</p><ul class="lvl-2"><li class="lvl-6">Bloom Filter 的增强版，支持 删除元素</li><li class="lvl-6"><a href="https://en.wikipedia.org/wiki/Cuckoo_filter">维基百科对 Cuckoo Filter 的描述</a></li><li class="lvl-6">在高 QPS 查询场景下，Cuckoo Filter 通常优于 Bloom Filter。</li><li class="lvl-6">低误判率 + 高负载率场景，Cuckoo Filter 更省内存。</li><li class="lvl-6">对应Redis命令： <code>CF.xxx</code>，详细的使用方法参见 <a href="/2025/12/22/redis7-datatype-12-CF/" title="Redis 命令及数据类型 -- CF(Cuckoo Filter)">Redis 命令及数据类型 -- CF(Cuckoo Filter)</a></li></ul></li><li class="lvl-2"><p>3️⃣ Count-Min Sketch（CMS）</p><ul class="lvl-2"><li class="lvl-6">近似统计元素出现频率</li><li class="lvl-6">对应Redis命令： <code>CMS.xxx</code>，详细的使用方法参见 <a href="/2025/12/23/redis7-datatype-13-CMS/" title="Redis 命令及数据类型 -- CMS(Count-Min Sketch)">Redis 命令及数据类型 -- CMS(Count-Min Sketch)</a></li></ul></li><li class="lvl-2"><p>4️⃣ Top-K</p><ul class="lvl-2"><li class="lvl-6">统计访问频率最高的 K 个元素</li><li class="lvl-6">对应Redis命令： <code>TOPK.xxx</code>，详细的使用方法参见 <a href="/2025/12/23/redis7-datatype-14-TopK/" title="Redis 命令及数据类型 -- TopK">Redis 命令及数据类型 -- TopK</a></li></ul></li><li class="lvl-2"><p>5️⃣ TDigest</p><ul class="lvl-2"><li class="lvl-6">统计数字的分布</li><li class="lvl-6">对应Redis命令： <code>TDIGEST.xxx</code>，详细的使用方法参见 <a href="/2025/12/23/redis7-datatype-15-TDigest/" title="Redis 命令及数据类型 -- TDigest">Redis 命令及数据类型 -- TDigest</a></li></ul></li></ul><h2 id="安装-RedisBloom">安装 RedisBloom</h2><ul class="lvl-0"><li class="lvl-2"><p>最简单的方式就是从<a href="https://cloud.redis.io">Redis Cloud</a>的<code>Download Center</code>中进行下载，其提供了所有Redis模块编译后的<code>.so</code>文件，可以优先进行尝试，但是并不保证一定兼容，所以最稳妥的方式是通过源码自己编译。<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/rguEIA.png" alt=""></p></li><li class="lvl-2"><p>源码编译</p></li></ul><blockquote><p>安装时需要科学上网，主要是安装依赖时需要从海外网下载，如果要部署在国内服务器，可能会连接失败。<br>可以在海外的<code>相同配置</code>的服务器上进行编译，之后将编译好的<code>redisbloom.so</code>上传到国内服务器即可。</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>安装依赖</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dnf install -y \</span><br><span class="line">  gcc \</span><br><span class="line">  gcc-c++ \</span><br><span class="line">  make \</span><br><span class="line">  cmake \</span><br><span class="line">  autoconf \</span><br><span class="line">  automake \</span><br><span class="line">  libtool \</span><br><span class="line">  pkgconfig \</span><br><span class="line">  openssl-devel</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>编译RedisBloom</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /usr/local/soft/modules/</span><br><span class="line"><span class="built_in">cd</span> /usr/local/soft/modules</span><br><span class="line"><span class="comment"># clone 代码，这里 --recursive 是为了拉取子模块</span></span><br><span class="line">git <span class="built_in">clone</span> --recursive https://github.com/RedisBloom/RedisBloom.git</span><br><span class="line"><span class="built_in">cd</span> RedisBloom</span><br><span class="line"><span class="comment"># 推荐切换到稳定的release版本</span></span><br><span class="line">git checkout v2.8.17</span><br><span class="line"><span class="comment"># 更新子模块，非必须，如果上面 clone 时没有加上 --recursive ，这个步骤就不能省略</span></span><br><span class="line">git submodule update --init --recursive</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查并安装需要的依赖</span></span><br><span class="line">./sbin/setup</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line"><span class="comment"># readies version: 7fc8e62</span></span><br><span class="line">dnf install -q -y ca-certificates</span><br><span class="line">dnf install -q -y wget unzip</span><br><span class="line">/usr/local/soft/modules/RedisBloom/deps/readies/bin/enable-utf8</span><br><span class="line">dnf install -q -y git jq</span><br><span class="line">dnf install -q -y <span class="built_in">which</span></span><br><span class="line">/usr/local/soft/modules/RedisBloom/deps/readies/bin/getepel</span><br><span class="line">/usr/local/soft/modules/RedisBloom/deps/readies/bin/getgcc --modern</span><br><span class="line">dnf install -q -y valgrind</span><br><span class="line">/usr/local/soft/modules/RedisBloom/sbin/get-fbinfer</span><br><span class="line">dnf install -q -y lcov</span><br><span class="line">/usr/bin/python3 /usr/local/soft/modules/RedisBloom/deps/readies/bin/getrmpytools --reinstall --modern</span><br><span class="line">/usr/bin/python3 /usr/local/soft/modules/RedisBloom/deps/readies/bin/getcmake --usr</span><br><span class="line">/usr/bin/python3 -m pip install --disable-pip-version-check --user  -r tests/flow/requirements.txt</span><br><span class="line">/usr/local/soft/modules/RedisBloom/deps/readies/bin/getaws</span><br><span class="line">/usr/bin/python3 -m pip install --disable-pip-version-check --user  pudb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译</span></span><br><span class="line">make</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">Building /usr/local/soft/modules/RedisBloom/bin/linux-x64-release/t-digest-c/src/libtdigest_static.a ...</span><br><span class="line"></span><br><span class="line">Generating /usr/local/soft/modules/RedisBloom/bin/linux-x64-release/t-digest-c/Makefile ...</span><br><span class="line">-- The C compiler identification is GNU 11.5.0</span><br><span class="line">-- The CXX compiler identification is GNU 11.5.0</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Check <span class="keyword">for</span> working C compiler: /usr/bin/gcc - skipped</span><br><span class="line">-- Detecting C compile features</span><br><span class="line">-- Detecting C compile features - <span class="keyword">done</span></span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /usr/bin/g++ - skipped</span><br><span class="line">-- Detecting CXX compile features</span><br><span class="line">-- Detecting CXX compile features - <span class="keyword">done</span></span><br><span class="line">-- Setting build <span class="built_in">type</span> to <span class="string">&#x27;Release&#x27;</span> as none was specified.</span><br><span class="line">-- Configuring <span class="keyword">done</span></span><br><span class="line">-- Generating <span class="keyword">done</span></span><br><span class="line">-- Build files have been written to: /usr/local/soft/modules/RedisBloom/bin/linux-x64-release/t-digest-c</span><br><span class="line"></span><br><span class="line">Building /usr/local/soft/modules/RedisBloom/bin/linux-x64-release/t-digest-c/libtdigest_static.a ...</span><br><span class="line">[ 50%] Building C object src/CMakeFiles/tdigest_static.dir/tdigest.c.o</span><br><span class="line">[100%] Linking C static library libtdigest_static.a</span><br><span class="line">[100%] Built target tdigest_static</span><br><span class="line">Compiling deps/bloom/bloom.c...</span><br><span class="line">Compiling deps/murmur2/MurmurHash2.c...</span><br><span class="line">Compiling deps/rmutil/util.c...</span><br><span class="line">Compiling src/rebloom.c...</span><br><span class="line">Compiling src/sb.c...</span><br><span class="line">Compiling src/cf.c...</span><br><span class="line">Compiling src/rm_topk.c...</span><br><span class="line">Compiling src/rm_tdigest.c...</span><br><span class="line">Compiling src/topk.c...</span><br><span class="line">Compiling src/rm_cms.c...</span><br><span class="line">Compiling src/cms.c...</span><br><span class="line">Linking /usr/local/soft/modules/RedisBloom/bin/linux-x64-release/redisbloom.so...</span><br></pre></td></tr></table></figure><div class="tips"><p><em><strong><code>./sbin/setup</code> 报错</strong></em></p><ul class="lvl-1"><li class="lvl-2">本人使用的是 Amazon Linux 2023(内核 6.1)，即 <code>EL9</code>，类似于CentOS 9，第一次运行会报错，大致报错信息如下：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">./sbin/setup</span><br><span class="line"><span class="comment">## 错误信息</span></span><br><span class="line">……</span><br><span class="line">[FAILED] raven-release.el9.noarch.rpm: Status code: 403 <span class="keyword">for</span> https://dyn.su/el9/base/x86_64/raven-release.el9.noarch.rpm (IP: 104.21.57.14)</span><br><span class="line">Status code: 403 <span class="keyword">for</span> https://dyn.su/el9/base/x86_64/raven-release.el9.noarch.rpm (IP: 104.21.57.14)</span><br><span class="line"></span><br><span class="line">In /usr/local/soft/modules/RedisBloom/deps/readies/bin/getepel:</span><br><span class="line">346      <span class="comment"># xinstall --allowerasing https://dl.fedoraproject.org/pub/epel/epel-release-latest-$&#123;EPEL&#125;.noarch.rpm</span></span><br><span class="line">347      <span class="keyword">fi</span></span><br><span class="line">348</span><br><span class="line">349  &gt;&gt;&gt; install_raven</span><br><span class="line">350      install_remi</span><br><span class="line">351      <span class="comment"># install_centos_stream_repos</span></span><br><span class="line">352</span><br><span class="line"></span><br><span class="line"><span class="built_in">command</span> failed: /usr/local/soft/modules/RedisBloom/deps/readies/bin/getepel</span><br><span class="line"></span><br><span class="line">In /usr/local/soft/modules/RedisBloom/sbin/setup:</span><br><span class="line">16       python3 -m pip list</span><br><span class="line">17       <span class="keyword">fi</span></span><br><span class="line">18</span><br><span class="line">19   &gt;&gt;&gt; <span class="variable">$ROOT</span>/sbin/system-setup.py</span><br><span class="line">20       <span class="keyword">if</span> [[ <span class="variable">$VERBOSE</span> == 1 ]]; <span class="keyword">then</span></span><br><span class="line">21       python3 -m pip list</span><br><span class="line">22       <span class="keyword">fi</span> 编译安装时报错</span><br><span class="line"></span><br><span class="line"><span class="comment">## 错误分析与解决方法</span></span><br><span class="line">问题原因：</span><br><span class="line">    你这个错误不是 RedisBloom 本身的编译问题，而是 依赖环境初始化（readies / getepel）阶段失败，失败点非常明确。</span><br><span class="line">readies/bin/getepel 脚本在 RHEL 9 / Rocky 9 / AlmaLinux 9 系统上尝试安装 Raven Repo，但该仓库地址 https://dyn.su/el9/... 已被 403 Forbidden 拒绝，导致脚本直接失败并中断 setup。</span><br><span class="line">    这不是你机器的问题，而是 RedisBloom 依赖工具链对 EL9 的兼容性滞后。</span><br><span class="line">    RedisBloom 的 ./sbin/setup 会调用 deps/readies/bin/getepel</span><br><span class="line">    这个脚本用于：</span><br><span class="line">        安装 EPEL</span><br><span class="line">        安装 Raven Repo（EL9 特有）</span><br><span class="line">        安装 Remi Repo</span><br><span class="line">    但 Raven Repo 目前已不稳定 / 不再公开提供 rpm 下载，而 readies 代码仍然在强制安装。</span><br><span class="line">    你的系统是 EL9 系列，日志中明确：raven-release.el9.noarch.rpm</span><br><span class="line">    说明你使用的可能是如下系统中的一个：</span><br><span class="line">        RHEL 9</span><br><span class="line">        Rocky Linux 9</span><br><span class="line">        AlmaLinux 9</span><br><span class="line">        CentOS Stream 9</span><br><span class="line"></span><br><span class="line">推荐解决方案:</span><br><span class="line">   Raven Repo 并非是 ReidsBloom 的必要依赖，所以直接修改 getepel 脚本，禁用 install_raven</span><br><span class="line">   vi deps/readies/bin/getepel，找到所有 install_raven，并将其注释掉即可</span><br></pre></td></tr></table></figure></div><h2 id="Redis-启用模块">Redis 启用模块</h2><ul class="lvl-0"><li class="lvl-2"><p>将生成的 <code>redisbloom.so</code> 拷贝到 redis 的 modules 目录下（非必须），目录不存在则创建</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意 .so 文件需要具有可执行权限</span></span><br><span class="line"><span class="built_in">cp</span> bin/linux-x64-release/redisbloom.so /usr/local/soft/redis-7.4.7/modules/redisbloom.so</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>Redis 启用模块有三种方法</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.将 redisbloom.so 添加到 redis.conf 中，需要重启 redis</span></span><br><span class="line">loadmodule /usr/local/soft/redis-7.4.7/modules/redisbloom.so</span><br><span class="line"><span class="comment"># 2.也可以通过如下方式加载模块</span></span><br><span class="line">redis-server --loadmodule /usr/local/soft/redis-7.4.7/modules/redisbloom.so</span><br><span class="line"><span class="comment"># 3.不需要重启redis</span></span><br><span class="line">redis-cli MODULE LOAD /usr/local/soft/redis-7.4.7/modules/redisbloom.so</span><br></pre></td></tr></table></figure><table><thead><tr><th>加载方式</th><th>是否持久</th></tr></thead><tbody><tr><td><code>MODULE LOAD</code>（redis-cli）</td><td>❌ 仅当前进程</td></tr><tr><td>命令行 <code>redis-server --loadmodule</code></td><td>❌ 仅本次启动</td></tr><tr><td><code>redis.conf</code> 中 <code>loadmodule</code></td><td>✅ <strong>永久生效</strong> （推荐/生产）</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>本文采用 <code>loadmodule</code> 加载模块</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 redisbloom.so 添加到 redis.conf 中，需要重启 redis</span></span><br><span class="line">loadmodule /usr/local/soft/redis-7.4.7/modules/redisbloom.so</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动redis</span></span><br><span class="line">redis-server redis.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录测试</span></span><br><span class="line">redis-cli --user admin --pass 123456</span><br><span class="line"><span class="comment"># 查看模块</span></span><br><span class="line">127.0.0.1:6379&gt; info Modules</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line"><span class="comment"># Modules</span></span><br><span class="line">module:name=bf,ver=20817,api=1,filters=0,usedby=[],using=[],options=[handle-io-errors]</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; MODULE LIST</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">1) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;bf&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 20817</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/local/soft/redis-7.4.7/modules/redisbloom.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文介绍 Redis 扩展模块 – RedisBloom 的安装方法&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文基于&lt;code&gt;redis-7.4.7&lt;/code&gt;，&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;操作系统：&lt;code&gt;Amazon Linux 2023(内核 6.1)&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis官网：&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis 命令文档：&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis 命令及数据类型 -- Stream</title>
    <link href="https://blog.hanqunfeng.com/2025/12/20/redis7-datatype-10-stream/"/>
    <id>https://blog.hanqunfeng.com/2025/12/20/redis7-datatype-10-stream/</id>
    <published>2025-12-20T05:40:05.000Z</published>
    <updated>2025-12-20T08:35:36.054Z</updated>
    
    <content type="html"><![CDATA[<h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2">本文介绍 Redis Stream 数据类型</li><li class="lvl-2">本文基于<code>redis-7.4.7</code>，<code>springboot-3.5.8</code></li><li class="lvl-2">Redis官网：<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis 命令文档：<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li></ul><span id="more"></span><h2 id="Stream-核心详解">Stream 核心详解</h2><ul class="lvl-0"><li class="lvl-2"><p>Redis Stream 是 Redis 5.0 新增的有序、可持久化、支持多播的<code>消息队列</code>，底层用<code>基数树+链表</code>实现，兼顾了高效查询与有序写入，完美解决了 List 队列（无法多播、无持久化保障）、Pub/Sub（无持久化、丢消息）的痛点，是生产环境首选的 Redis 消息队列方案。</p></li><li class="lvl-2"><p>建议生产环境还是使用传统的 MQ 方案，如果仅是内部系统使用的轻量MQ，已经有了redis，但是不想引入其它中间件，也可以尝试。</p></li><li class="lvl-2"><p>Stream 与传统的MQ 的对比</p></li></ul><table><thead><tr><th>对比维度</th><th>Redis Stream</th><th>RabbitMQ</th><th>Kafka</th></tr></thead><tbody><tr><td><strong>数据模型</strong></td><td>类似日志的有序 KV 消息流（ID → field/value）</td><td>队列（FIFO）</td><td>日志分区（Partitioned Append-Only Log）</td></tr><tr><td><strong>消息持久化</strong></td><td>可选持久化（AOF / RDB），默认内存优先</td><td>可持久化到磁盘</td><td>持久化到磁盘，顺序写入，效率高</td></tr><tr><td><strong>消息确认</strong></td><td>XACK 对单条消息确认，支持 Pending 消息管理</td><td>ACK / NACK</td><td>Offset 控制，Consumer 自行提交</td></tr><tr><td><strong>消费模式</strong></td><td>支持 Consumer Group，多消费者共享 Pending 消息</td><td>Queue 绑定 Consumer，多消费者抢占</td><td>Consumer Group，多消费者平行消费</td></tr><tr><td><strong>重复消费</strong></td><td>默认可能重复，需要应用端幂等</td><td>可通过 ACK/NACK 控制</td><td>默认可能重复，Consumer 需幂等处理</td></tr><tr><td><strong>消息顺序</strong></td><td>按 Stream ID 顺序，可保证分组内顺序</td><td>队列顺序保证</td><td>Partition 内顺序保证</td></tr><tr><td><strong>消息保留策略</strong></td><td>可配置 maxlen / minid，按时间或长度裁剪</td><td>队列长度 / TTL 控制</td><td>基于时间或大小保留（Retention Policy）</td></tr><tr><td><strong>延时/定时消费</strong></td><td>原生不支持延时队列，需要应用端处理</td><td>支持插件或 TTL</td><td>原生不支持，需要应用端处理或 Kafka Streams</td></tr><tr><td><strong>事务与原子操作</strong></td><td>事务可用 MULTI/EXEC，XADD 支持 NOMKSTREAM 等选项</td><td>原生事务支持（事务 / confirm 模式）</td><td>不支持事务，依赖幂等生产者</td></tr><tr><td><strong>性能</strong></td><td>内存级高吞吐，持久化会有开销</td><td>中等，受磁盘和网络限制</td><td>高吞吐，顺序写入磁盘效率极高</td></tr><tr><td><strong>典型使用场景</strong></td><td>事件日志、轻量 MQ、内部异步流水线</td><td>企业级消息、任务调度、RPC</td><td>大数据管道、日志收集、流处理</td></tr><tr><td><strong>多语言支持</strong></td><td>客户端支持多种语言（Java、Python、Go 等）</td><td>客户端丰富</td><td>客户端丰富</td></tr><tr><td><strong>易运维性</strong></td><td>单节点即可使用，但持久化需关注内存</td><td>集群较复杂，需要 RabbitMQ 集群</td><td>集群复杂度高，需要 ZooKeeper 或 KRaft</td></tr></tbody></table><h3 id="底层核心实现">底层核心实现</h3><ol><li class="lvl-3"><p>存储结构：核心是基数树（Radix Tree）+ 双向链表，基数树存「消息ID→消息内容」的映射，双向链表按消息ID有序串联所有消息，保证写入和按ID查询的高效性（O(logN)）。</p></li><li class="lvl-3"><p>消息ID：默认自动生成，格式为时间戳-序列号（如1734567890000-0），时间戳是毫秒级，序列号解决同一毫秒多消息的有序问题；也支持手动指定，需满足严格递增，否则写入失败。</p></li><li class="lvl-3"><p>持久化：和 Redis 其他数据结构一致，依赖 RDB/AOF 持久化，消息写入后会落盘，重启后不丢失，这是 Pub/Sub 不具备的核心优势。</p></li><li class="lvl-3"><p>核心元数据：每个 Stream 会维护last-id（最新消息ID）、groups（消费组列表）、entries（消息实体）三类元数据，消费组的元数据独立存储，互不干扰。</p></li></ol><h2 id="Stream-核心基础操作（必用）">Stream 核心基础操作（必用）</h2><h3 id="1-生产消息（XADD）：写入队列">1. 生产消息（XADD）：写入队列</h3><p>• 核心命令：<code>XADD key ID 字段1 值1 字段2 值2 ...</code>，ID 写*表示自动生成（生产首选）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">XADD key</span><br><span class="line">     [NOMKSTREAM]</span><br><span class="line">     [MAXLEN | MINID [= | ~] threshold [LIMIT count]]</span><br><span class="line">     * | <span class="built_in">id</span></span><br><span class="line">     field value [field value ...]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数解释</span></span><br><span class="line"><span class="comment"># key: Stream 名称</span></span><br><span class="line"><span class="comment"># NOMKSTREAM: 不自动创建 Stream，若 key 不存在 → 命令直接失败</span></span><br><span class="line"><span class="comment"># MAXLEN threshold —— 按长度裁剪</span></span><br><span class="line"><span class="comment">#   MAXLEN 1000: Stream 最多保留 1000 条消息，超出部分会被删除（从最旧开始）</span></span><br><span class="line"><span class="comment">#   MAXLEN = 1000: 精确裁剪，严格保证长度 ≤ 1000，每次写入都会检查并裁剪，性能开销较大</span></span><br><span class="line"><span class="comment">#   MAXLEN ~ 1000（推荐）: 近似裁剪，允许 Stream 长度 略微超过阈值，Redis 在内部批量裁剪，写入性能更高</span></span><br><span class="line"><span class="comment"># LIMIT count —— 每次最多裁剪多少条</span></span><br><span class="line"><span class="comment">#   MAXLEN ~ 1000 LIMIT 100: 单次写入 最多删除 100 条旧消息，防止一次裁剪阻塞 Redis 主线程</span></span><br><span class="line"><span class="comment"># MINID threshold —— 按 ID 裁剪（Redis ≥ 6.2）</span></span><br><span class="line"><span class="comment">#   MINID ~ 1670000000000-0: 删除 ID 小于 threshold 的消息，更适合 时间窗口型保留策略</span></span><br><span class="line"><span class="comment"># * | id —— 消息 ID</span></span><br><span class="line"><span class="comment">#   *: 自动生成 ID（99% 场景），格式：&lt;毫秒时间戳&gt;-&lt;序号&gt;，单调递增，全局有序，消费者组依赖它进行 offset 管理</span></span><br><span class="line"><span class="comment">#   id: 指定ID（不常用），ID 必须严格大于 Stream 中最大 ID，否则写入失败</span></span><br><span class="line"><span class="comment"># field value —— 消息体（Payload）</span></span><br><span class="line"><span class="comment">#   至少一对 field-value，field / value 都是 Binary Safe，本质类似 Hash，但不可修改</span></span><br></pre></td></tr></table></figure><p>• 示例</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 向订单队列写入1条消息，自动生成消息ID</span></span><br><span class="line">XADD order_stream * uid 1001 order_no ORD20251220 price 299</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line"><span class="string">&quot;1766215406540-0&quot;</span> <span class="comment"># 消息ID</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 保留某个时间点之后的日志</span></span><br><span class="line">XADD <span class="built_in">log</span> MINID ~ 1689900000000-0 * level INFO msg <span class="string">&quot;startup&quot;</span></span><br></pre></td></tr></table></figure><h3 id="2-消费消息（2种核心模式）">2. 消费消息（2种核心模式）</h3><h4 id="（1）-独立消费（无消费组）：一对一消费，适合简单场景">（1） 独立消费（无消费组）：一对一消费，适合简单场景</h4><p>• XREAD：主动拉取消息，支持阻塞/非阻塞</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">XREAD</span><br><span class="line">  [COUNT count]</span><br><span class="line">  [BLOCK milliseconds]</span><br><span class="line">  STREAMS key [key ...]</span><br><span class="line">          <span class="built_in">id</span>  [<span class="built_in">id</span>  ...]</span><br><span class="line"><span class="comment"># 参数解释</span></span><br><span class="line"><span class="comment"># COUNT count —— 单次最多读取多少条，是“上限”，不是保证值</span></span><br><span class="line"><span class="comment"># BLOCK milliseconds —— 阻塞等待新消息，阻塞期间 不会占用 CPU，超时返回 nil</span></span><br><span class="line"><span class="comment">#   BLOCK 0: 无限阻塞，直到有新消息</span></span><br><span class="line"><span class="comment"># STREAMS key [key ...] —— 指定读取的 Stream，key 与 id 一一对应</span></span><br><span class="line"><span class="comment"># id [id ...] —— 从哪个位置开始读，读取 ID 大于该值的消息，不包含 该 ID 本身</span></span><br><span class="line"><span class="comment">#   普通 ID（游标语义）: XREAD STREAMS mystream 1689999999999-0</span></span><br><span class="line"><span class="comment">#   $: 只关心“将来”的消息，从 当前 Stream 的末尾之后 开始读，历史消息全部忽略: XREAD BLOCK 0 STREAMS mystream $</span></span><br></pre></td></tr></table></figure><p>• 示例1（非阻塞）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从开头拉5条消息</span></span><br><span class="line">XREAD COUNT 5 STREAMS order_stream 0-0</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">1) 1) <span class="string">&quot;order_stream&quot;</span>          <span class="comment"># Stream名称</span></span><br><span class="line">   2) 1) 1) <span class="string">&quot;1766215406540-0&quot;</span> <span class="comment"># 消息ID</span></span><br><span class="line">         2) 1) <span class="string">&quot;uid&quot;</span>          <span class="comment"># 消息体 键值对</span></span><br><span class="line">            2) <span class="string">&quot;1001&quot;</span></span><br><span class="line">            3) <span class="string">&quot;order_no&quot;</span></span><br><span class="line">            4) <span class="string">&quot;ORD20251220&quot;</span></span><br><span class="line">            5) <span class="string">&quot;price&quot;</span></span><br><span class="line">            6) <span class="string">&quot;299&quot;</span></span><br></pre></td></tr></table></figure><p>• 示例2（阻塞）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># $表示从最新消息开始拉，阻塞3秒，有新消息立即返回，无则3秒后超时，是生产常用写法。</span></span><br><span class="line">XREAD COUNT 5 BLOCK 3000 STREAMS order_stream $</span><br></pre></td></tr></table></figure><h4 id="（2）-消费组消费（XGROUP）：一对多消费，核心生产模式">（2） 消费组消费（XGROUP）：一对多消费，核心生产模式</h4><ul class="lvl-0"><li class="lvl-2"><p>Stream 最核心的价值就是消费组，支持多消费者协同消费、消息确认、未消费消息追溯，解决了分布式场景下的消息分片与负载均衡问题。</p></li><li class="lvl-2"><ol><li class="lvl-5">先创建消费组<code>XGROUP CREATE</code></li></ol></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">XGROUP CREATE key group <span class="built_in">id</span>|$</span><br><span class="line">       [MKSTREAM]</span><br><span class="line">       [ENTRIESREAD entries-read]</span><br><span class="line"><span class="comment"># 参数解释</span></span><br><span class="line"><span class="comment"># key：Stream 名称，为指定的Stream创建消费组</span></span><br><span class="line"><span class="comment"># group: 消费组名称，消费者组的唯一标识，一个 Stream 可以有 多个 consumer group</span></span><br><span class="line"><span class="comment"># id | $ —— 关键参数：消费起始位点（offset），$表示从当前最新消息开始消费，用0-0表示从队列开头消费。</span></span><br><span class="line"><span class="comment"># [MKSTREAM] —— 自动创建 Stream，如果指定的key不存在则自动创建，推荐在自动化部署中使用</span></span><br><span class="line"><span class="comment"># [ENTRIESREAD entries-read] —— 设置“已读取条数”（高级参数），一般业务不需要使用，主要用于手动恢复group、数据迁移等场景</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例：创建group1消费组，从最新订单消息开始消费</span></span><br><span class="line">XGROUP CREATE order_stream group1 $ MKSTREAM</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">OK</span><br></pre></td></tr></table></figure><ol start="2"><li class="lvl-3"><p>消费者拉取消息<code>XREADGROUP</code></p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">XREADGROUP GROUP group consumer</span><br><span class="line">           [COUNT count]</span><br><span class="line">           [BLOCK milliseconds]</span><br><span class="line">           [NOACK]</span><br><span class="line">           STREAMS key [key ...]</span><br><span class="line">                   <span class="built_in">id</span>  [<span class="built_in">id</span>  ...]</span><br><span class="line"><span class="comment"># 参数解释</span></span><br><span class="line"><span class="comment"># GROUP group consumer: 指定消费者组名：group，消费者名：consumer</span></span><br><span class="line"><span class="comment">#    同一个 group 下，不同 consumer 不会收到重复消息</span></span><br><span class="line"><span class="comment"># [COUNT count] —— 单次最多返回条数，是软限制，不是严格保证</span></span><br><span class="line"><span class="comment"># [BLOCK milliseconds] —— 阻塞等待新消息，最多阻塞 milliseconds 毫秒</span></span><br><span class="line"><span class="comment">#    BLOCK 0 → 永久阻塞</span></span><br><span class="line"><span class="comment"># [NOACK] —— 不进入 Pending（⚠️ 谨慎）</span></span><br><span class="line"><span class="comment">#    消息 不会进入 Pending，不需要 XACK，消费后即认为完成</span></span><br><span class="line"><span class="comment">#    风险：消费者崩溃 → 消息直接丢失，不可重投递</span></span><br><span class="line"><span class="comment"># STREAMS key [key ...]: 指定要读取的 Stream（支持多个），key 顺序需与后续 id 顺序一致</span></span><br><span class="line"><span class="comment"># id [id ...] —— 决定“读什么”的关键</span></span><br><span class="line"><span class="comment">#    使用 &gt; —— 读取“新消息”（✅ 生产环境 99% 使用这种方式），从未投递给任何 consumer 的新消息</span></span><br><span class="line"><span class="comment">#    使用 0/具体ID —— 重读 Pending（补偿），读取 已投递但未 ACK 的消息</span></span><br><span class="line"><span class="comment">#    多 Stream 场景: STREAMS stream1 stream2 &gt; &gt;，每个 stream 必须有一个对应 id</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例：consumerA 从group1拉3条未被消费的消息，阻塞5秒。</span></span><br><span class="line">XREADGROUP GROUP group1 consumerA COUNT 3 BLOCK 5000 STREAMS order_stream &gt;</span><br><span class="line"><span class="comment">## 此时在5秒内创建新的消息，就会有类似如下输出</span></span><br><span class="line">1) 1) <span class="string">&quot;order_stream&quot;</span></span><br><span class="line">   2) 1) 1) <span class="string">&quot;1766215642763-0&quot;</span></span><br><span class="line">         2) 1) <span class="string">&quot;uid&quot;</span></span><br><span class="line">            2) <span class="string">&quot;1001&quot;</span></span><br><span class="line">            3) <span class="string">&quot;order_no&quot;</span></span><br><span class="line">            4) <span class="string">&quot;ORD20251220&quot;</span></span><br><span class="line">            5) <span class="string">&quot;price&quot;</span></span><br><span class="line">            6) <span class="string">&quot;299&quot;</span></span><br><span class="line">(1.50s)</span><br></pre></td></tr></table></figure><h3 id="3-消息确认（XACK）">3. 消息确认（XACK）</h3><ul class="lvl-0"><li class="lvl-2"><p>消费完成后必须确认，否则会被标记为「未确认消息」</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># XACK key 消费组名 消息ID1 消息ID2 ...。</span></span><br><span class="line">XACK key group <span class="built_in">id</span> [<span class="built_in">id</span> ...]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例: 确认2条消息消费完成，Stream 会删除该消息的未确认标记</span></span><br><span class="line">XACK order_stream group1 1734567890000-0 1734567890001-0</span><br></pre></td></tr></table></figure><h3 id="4-消息重试">4. 消息重试</h3><ul class="lvl-0"><li class="lvl-2"><p>未确认的消息，会被存入消费组的<code>「PEL（Pending Entries List）」</code>，可通过<code>XPENDING key 消费组名</code>查看，支持<code>XCLAIM</code>将<code>PEL</code>中的消息转移给其他消费者处理，避免单点故障导致消息堆积。</p></li><li class="lvl-2"><p>XPENDING：查看未被确认的消息情况</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">XPENDING key group</span><br><span class="line">        [[IDLE min-idle-time]</span><br><span class="line">         start end count</span><br><span class="line">         [consumer]]</span><br><span class="line"><span class="comment"># 参数解释</span></span><br><span class="line"><span class="comment"># key: Stream 名称，必须存在</span></span><br><span class="line"><span class="comment"># group: 消费者组名称，必须存在</span></span><br><span class="line"><span class="comment"># [IDLE min-idle-time]（Redis ≥ 6.2）: 仅返回 空闲时间 ≥ min-idle-time（毫秒） 的 Pending 消息</span></span><br><span class="line"><span class="comment">#    min-idle-time(空闲时间) = 从上次投递 / claim到现在</span></span><br><span class="line"><span class="comment"># start end —— ID 范围</span></span><br><span class="line"><span class="comment">#    -: 最小ID</span></span><br><span class="line"><span class="comment">#    +: 最大ID</span></span><br><span class="line"><span class="comment"># count —— 返回条数上限</span></span><br><span class="line"><span class="comment"># [consumer]（可选）: 只查看某一个 consumer 的 Pending，不指定则查看 group 内全部</span></span><br><span class="line"><span class="comment"># 只返回 元数据，不返回消息内容</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例1: 查看是否有消息积压</span></span><br><span class="line">XPENDING order_stream group1</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 1      <span class="comment"># 积压消息数，未确认消息数量</span></span><br><span class="line">2) <span class="string">&quot;1766215642763-0&quot;</span> <span class="comment"># Pending 中最小 ID</span></span><br><span class="line">3) <span class="string">&quot;1766215642763-0&quot;</span> <span class="comment"># Pending 中最大 ID</span></span><br><span class="line">4) 1) 1) <span class="string">&quot;consumerA&quot;</span> <span class="comment"># 按 consumer 统计的 Pending 数量</span></span><br><span class="line">      2) <span class="string">&quot;1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例2: 查找 idle 超过 1 分钟的消息，最多返回10条</span></span><br><span class="line">XPENDING order_stream group1 IDLE 60000 - + 10</span><br><span class="line"><span class="comment">## 输出</span></span><br><span class="line">1) 1) <span class="string">&quot;1766215642763-0&quot;</span> <span class="comment"># 消息 ID</span></span><br><span class="line">   2) <span class="string">&quot;consumerA&quot;</span>       <span class="comment"># 当前持有该消息的 consumer</span></span><br><span class="line">   3) (<span class="built_in">integer</span>) 255581  <span class="comment"># idle 时间（毫秒）</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 2       <span class="comment"># delivery count（投递次数）,该消息至少被投递过 2 次</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例3: 只查看 consumerA 的 Pending，最多返回20条</span></span><br><span class="line">XPENDING order_stream group1 - + 20 consumerA</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>XCLAIM: 转移投递</p></li></ul><blockquote><p>将已经投递但未 ACK、且 idle 超过阈值的 Pending 消息，从原 consumer 手中“抢占”给新的 consumer，并重新投递。<br>一旦抢占成功，原 consumer 就不在拥有该消息的 Pending 记录</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">XCLAIM key group consumer min-idle-time <span class="built_in">id</span> [<span class="built_in">id</span> ...]</span><br><span class="line">       [IDLE ms]</span><br><span class="line">       [TIME unix-time-milliseconds]</span><br><span class="line">       [RETRYCOUNT count]</span><br><span class="line">       [FORCE]</span><br><span class="line">       [JUSTID]</span><br><span class="line">       [LASTID lastid]</span><br><span class="line"><span class="comment"># 参数解释</span></span><br><span class="line"><span class="comment"># key: Stream Key，必须存在</span></span><br><span class="line"><span class="comment"># group: 消费者组名称，必须存在</span></span><br><span class="line"><span class="comment"># consumer: 新的消费者，抢占后的 Pending 消息将归属该 consumer</span></span><br><span class="line"><span class="comment"># min-idle-time: 空闲时间，只有 idle ≥ min-idle-time 的 Pending 消息才允许被 claim</span></span><br><span class="line"><span class="comment"># id [id ...]: 指定要 claim 的消息 ID，ID必须存在</span></span><br><span class="line"><span class="comment"># [IDLE ms]: 人为设置 idle 时间，覆盖 Redis 内部计算的 idle，比如强制制造“已超时”状态</span></span><br><span class="line"><span class="comment"># [TIME unix-time-milliseconds]: 手动指定“最后投递时间”，与 IDLE 二选一使用，极少见于业务代码</span></span><br><span class="line"><span class="comment"># [RETRYCOUNT count]: 手动设置 delivery count，实现“最多重试 N 次，超过进死信队列”</span></span><br><span class="line"><span class="comment"># [FORCE]: 强制 claim 不存在于 Pending 的消息，⚠️ 高风险</span></span><br><span class="line"><span class="comment"># [JUSTID]: 只返回 消息 ID，不返回消息体（field/value），减少网络开销</span></span><br><span class="line"><span class="comment"># [LASTID lastid]（Redis ≥ 7.0）: 更新 consumer group 的 last-delivered-id，影响后续 XREADGROUP &gt; 的行为</span></span><br><span class="line"><span class="comment">#    ⚠️ 高级特性，一般不建议业务代码使用</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例：</span></span><br><span class="line"><span class="comment"># 1️⃣ 抢占 idle 超过 60s 的消息</span></span><br><span class="line">XCLAIM order_stream group1 consumerB 60000 1766215642763-0</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">1) 1) <span class="string">&quot;1766215642763-0&quot;</span></span><br><span class="line">   2) 1) <span class="string">&quot;uid&quot;</span></span><br><span class="line">      2) <span class="string">&quot;1001&quot;</span></span><br><span class="line">      3) <span class="string">&quot;order_no&quot;</span></span><br><span class="line">      4) <span class="string">&quot;ORD20251220&quot;</span></span><br><span class="line">      5) <span class="string">&quot;price&quot;</span></span><br><span class="line">      6) <span class="string">&quot;299&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2️⃣ 抢占并标记为第 3 次重试</span></span><br><span class="line">XCLAIM orders order-group consumerB 60000 1766215642763-0 RETRYCOUNT 3</span><br><span class="line"><span class="comment"># 3️⃣ 只返回 ID（配合批处理）</span></span><br><span class="line">XCLAIM orders order-group consumerB 60000 1766215642763-0 JUSTID</span><br></pre></td></tr></table></figure><h2 id="高级特性（生产必备）">高级特性（生产必备）</h2><ol><li class="lvl-3"><p>消息回溯与遍历</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># XRANGE key 起始ID 结束ID [COUNT 条数]（正向遍历）</span></span><br><span class="line">XRANGE key start end [COUNT count]</span><br><span class="line"><span class="comment"># XREVRANGE key 结束ID 起始ID [COUNT 条数]（反向遍历）</span></span><br><span class="line">XREVRANGE key end start [COUNT count]</span><br><span class="line"><span class="comment"># 示例: 0-0:最小的消息ID，等同于 -，+:表示最新消息，适合数据对账、历史消息查询。</span></span><br><span class="line">XRANGE order_stream 0-0 + COUNT 10</span><br><span class="line">XRANGE order_stream - + COUNT 10</span><br></pre></td></tr></table></figure><ol start="2"><li class="lvl-3"><p>队列信息查询</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查消息总数</span></span><br><span class="line">XLEN key</span><br><span class="line"><span class="comment"># 查Stream完整元数据（最新ID、消费组数量、消息总数等）</span></span><br><span class="line"></span><br><span class="line">XINFO STREAM key [FULL [COUNT count]]</span><br><span class="line"><span class="comment">## FULL: 完整模式</span></span><br><span class="line">    <span class="comment"># 👉 返回：</span></span><br><span class="line">    <span class="comment">#     Stream 元信息</span></span><br><span class="line">    <span class="comment">#     所有 Consumer Group</span></span><br><span class="line">    <span class="comment">#     每个 Group 的 Consumer</span></span><br><span class="line">    <span class="comment">#     Pending Entries List（PEL）</span></span><br><span class="line">    <span class="comment">#     部分历史 entries</span></span><br><span class="line">    <span class="comment"># ⚠️ 开销很大，慎用于生产环境。</span></span><br><span class="line"><span class="comment">## COUNT count（FULL 模式的限制参数）</span></span><br><span class="line">    <span class="comment">#   XINFO STREAM key FULL COUNT 10: 限制返回的entries 数量以及每个 group / consumer 的 PEL 记录数量</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查所有消费组信息</span></span><br><span class="line">XINFO GROUPS key</span><br><span class="line"><span class="comment"># 查该组下所有消费者</span></span><br><span class="line">XINFO CONSUMERS key 消费组名</span><br></pre></td></tr></table></figure><ol start="3"><li class="lvl-3"><p>消费组管理</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除消费组</span></span><br><span class="line">XGROUP DESTROY key 消费组名</span><br><span class="line"><span class="comment"># 删除消费者</span></span><br><span class="line">XGROUP DELCONSUMER key 消费组名 消费者名</span><br><span class="line"><span class="comment"># 重置消费组起始ID</span></span><br><span class="line">XGROUP SETID key 消费组名 新ID</span><br></pre></td></tr></table></figure><ol start="4"><li class="lvl-3"><p>惰性删除：Stream 不会主动删除已确认的消息，仅靠MAXLEN淘汰，若需主动清理历史消息，直接用XADD的MAXLEN参数即可，无需额外命令。</p></li></ol><h2 id="生产环境核心痛点与解决方案">生产环境核心痛点与解决方案</h2><ol><li class="lvl-3"><p>消息丢失：3重保障</p><ul class="lvl-2"><li class="lvl-6">开启 Redis AOF 持久化（设为everysec，兼顾性能与可靠性）</li><li class="lvl-6">生产者写入后确认返回值（确保写入成功）</li><li class="lvl-6">消费者消费后必须<code>XACK</code>确认。</li></ul></li><li class="lvl-3"><p>消息堆积：2种处理</p><ul class="lvl-2"><li class="lvl-6">① 写入时用<code>MAXLEN</code>设置上限，淘汰旧消息；</li><li class="lvl-6">② 消费端扩容消费者实例，消费组会自动将未消费消息分片给多个消费者，实现并行消费。</li></ul></li><li class="lvl-3"><p>重复消费</p><ul class="lvl-2"><li class="lvl-6">根源: 网络抖动（消费者确认消息前断开连接，消息重回PEL）</li><li class="lvl-6">解决方案: 消息幂等性（生产者给消息加唯一标识，消费者根据唯一标识去重）。</li></ul></li><li class="lvl-3"><p>阻塞超时：消费端用BLOCK阻塞拉取，超时时间建议设为3-5秒，避免频繁空轮询占用CPU，同时保证新消息的响应速度。</p></li></ol><h2 id="典型应用场景">典型应用场景</h2><h3 id="分布式业务解耦（订单-库存-支付-物流解耦）">分布式业务解耦（订单-库存-支付-物流解耦）</h3><blockquote><p>核心思路：单 Stream 对应核心业务（订单），库存、支付、物流各创建独立消费组，各自消费互不干扰，实现业务解耦。</p></blockquote><ol><li class="lvl-3"><p>生产者（订单服务）：写入订单完成消息</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自动生成消息ID，写入订单核心信息，设置队列最大1万条消息（近似淘汰）</span></span><br><span class="line">XADD order_core_stream * MAXLEN ~ 10000 order_no ORD20251220001 uid 1001 amount 299 status created create_time 1734567890</span><br></pre></td></tr></table></figure><ol start="2"><li class="lvl-3"><p>创建3个独立消费组（库存/支付/物流）</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 库存消费组：从最新消息开始消费，队列不存在则自动创建</span></span><br><span class="line">XGROUP CREATE order_core_stream group_stock $ MKSTREAM</span><br><span class="line"><span class="comment"># 支付消费组</span></span><br><span class="line">XGROUP CREATE order_core_stream group_pay $ MKSTREAM</span><br><span class="line"><span class="comment"># 物流消费组</span></span><br><span class="line">XGROUP CREATE order_core_stream group_logistics $ MKSTREAM</span><br></pre></td></tr></table></figure><ol start="3"><li class="lvl-3"><p>各消费组消费者拉取+确认消息</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 库存服务消费者（consumer_stock1）拉取3条未消费消息，阻塞5秒</span></span><br><span class="line">XREADGROUP GROUP group_stock consumer_stock1 COUNT 3 BLOCK 5000 STREAMS order_core_stream &gt;</span><br><span class="line"><span class="comment"># 库存处理完成后确认消息（替换为实际拉取到的消息ID）</span></span><br><span class="line">XACK order_core_stream group_stock 1734567890000-0 1734567890001-0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 支付服务消费者（consumer_pay1）同理</span></span><br><span class="line">XREADGROUP GROUP group_pay consumer_pay1 COUNT 3 BLOCK 5000 STREAMS order_core_stream &gt;</span><br><span class="line">XACK order_core_stream group_pay 1734567890000-0 1734567890001-0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 物流服务消费者（consumer_log1）同理</span></span><br><span class="line">XREADGROUP GROUP group_logistics consumer_log1 COUNT 3 BLOCK 5000 STREAMS order_core_stream &gt;</span><br><span class="line">XACK order_core_stream group_logistics 1734567890000-0 1734567890001-0</span><br></pre></td></tr></table></figure><h3 id="异步任务处理（用户注册-邮件-短信-积分异步执行）">异步任务处理（用户注册-邮件/短信/积分异步执行）</h3><blockquote><p>核心思路：注册接口只负责写入 Stream 消息，无需等待后续任务完成，单消费组多消费者提升异步任务处理效率，核心是快速响应前端。</p></blockquote><ol><li class="lvl-3"><p>生产者（注册服务）：用户注册成功后写入消息</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 写入用户注册信息，MAXLEN限制5000条，避免积压过多无效注册消息</span></span><br><span class="line">XADD user_register_stream * MAXLEN ~ 5000 uid 1001 username zhangsan phone 13800138000 email zs@xxx.com reg_time 1734567900</span><br></pre></td></tr></table></figure><ol start="2"><li class="lvl-3"><p>创建单个消费组（统一处理注册后续任务）</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XGROUP CREATE user_register_stream group_reg_task $ MKSTREAM</span><br></pre></td></tr></table></figure><ol start="3"><li class="lvl-3"><p>多消费者并行拉取（邮件/短信/积分各1个消费者，或多实例扩容）</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 短信发送消费者（consumer_sms）</span></span><br><span class="line">XREADGROUP GROUP group_reg_task consumer_sms COUNT 5 BLOCK 3000 STREAMS user_register_stream &gt;</span><br><span class="line">XACK user_register_stream group_reg_task 消息ID1 消息ID2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 邮件发送消费者（consumer_email）</span></span><br><span class="line">XREADGROUP GROUP group_reg_task consumer_email COUNT 5 BLOCK 3000 STREAMS user_register_stream &gt;</span><br><span class="line">XACK user_register_stream group_reg_task 消息ID1 消息ID2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 积分发放消费者（consumer_score）</span></span><br><span class="line">XREADGROUP GROUP group_reg_task consumer_score COUNT 5 BLOCK 3000 STREAMS user_register_stream &gt;</span><br><span class="line">XACK user_register_stream group_reg_task 消息ID1 消息ID2</span><br></pre></td></tr></table></figure><h3 id="日志收集（系统实时日志-分析-告警）">日志收集（系统实时日志-分析/告警）</h3><blockquote><p>核心思路：各业务系统实时写入日志到 Stream，多消费组分别做日志分析、实时告警，兼顾实时性与数据留存，支持历史日志回溯。</p></blockquote><ol><li class="lvl-3"><p>生产者（各业务系统）：实时写入系统日志（按级别/业务分类，这里统一写入总日志流）</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 写入日志：包含业务模块、日志级别、内容、时间，无消息数量上限（按实际服务器内存调整MAXLEN）</span></span><br><span class="line">XADD sys_log_stream * module order_service level ERROR content <span class="string">&quot;库存扣减失败，订单号ORD20251220001&quot;</span> log_time 1734567910</span><br><span class="line">XADD sys_log_stream * module pay_service level INFO content <span class="string">&quot;支付成功，uid1001，金额299&quot;</span> log_time 1734567912</span><br></pre></td></tr></table></figure><ol start="2"><li class="lvl-3"><p>创建2个消费组（日志分析+实时告警）</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 日志分析消费组（用于离线统计、数据归档），从队列开头消费（0-0），兜底所有历史日志</span></span><br><span class="line">XGROUP CREATE sys_log_stream group_log_analysis 0-0 MKSTREAM</span><br><span class="line"><span class="comment"># 实时告警消费组（用于实时捕获ERROR日志告警），从最新消息消费</span></span><br><span class="line">XGROUP CREATE sys_log_stream group_log_alert $ MKSTREAM</span><br></pre></td></tr></table></figure><ol start="3"><li class="lvl-3"><p>对应消费者拉取处理</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 日志分析消费者（批量拉取，非阻塞，适合离线处理）</span></span><br><span class="line">XREADGROUP GROUP group_log_analysis consumer_analysis COUNT 100 STREAMS sys_log_stream &gt;</span><br><span class="line">XACK sys_log_stream group_log_analysis 批量消息ID...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 告警消费者（阻塞拉取，快速响应，只处理ERROR级别日志）</span></span><br><span class="line">XREADGROUP GROUP group_log_alert consumer_alert BLOCK 0 STREAMS sys_log_stream &gt;  <span class="comment"># BLOCK 0 永久阻塞，有消息立即返回</span></span><br><span class="line">XACK sys_log_stream group_log_alert 告警消息ID</span><br></pre></td></tr></table></figure><h3 id="限流削峰（秒杀场景-请求削峰填谷）">限流削峰（秒杀场景-请求削峰填谷）</h3><blockquote><p>核心思路：秒杀请求高峰时，先写入 Stream 做缓冲，消费端匀速拉取（控制每秒处理量），避免下游数据库/业务服务被压垮，核心是“慢消费、稳处理”。</p></blockquote><ol><li class="lvl-3"><p>生产者（秒杀入口服务）：接收秒杀请求，直接写入 Stream，快速返回“排队中”</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 写入秒杀请求，设置MAXLEN 10000（限制最大排队数，超过则拒绝，避免OOM）</span></span><br><span class="line">XADD seckill_stream * MAXLEN ~ 10000 seckill_id 101 uid 1001 request_time 1734568000</span><br></pre></td></tr></table></figure><ol start="2"><li class="lvl-3"><p>创建消费组（单消费组+多消费者，控制总处理速率）</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XGROUP CREATE seckill_stream group_seckill $ MKSTREAM</span><br></pre></td></tr></table></figure><ol start="3"><li class="lvl-3"><p>消费端（匀速拉取，核心是控制COUNT和消费频率，比如每秒处理100条）</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 消费者（多实例部署，总处理量=单实例COUNT×实例数，这里单实例每次拉10条，每秒拉10次，单实例每秒处理100条）</span></span><br><span class="line">XREADGROUP GROUP group_seckill consumer_seckill1 COUNT 10 BLOCK 100 STREAMS seckill_stream &gt;</span><br><span class="line"><span class="comment"># 业务处理：扣库存、生成订单（核心是处理逻辑同步执行，控制速率）</span></span><br><span class="line">XACK seckill_stream group_seckill 秒杀请求消息ID...</span><br></pre></td></tr></table></figure><blockquote><p>关键优化：消费端通过定时任务+固定COUNT拉取，而非无限拉取，精准控制处理速率，实现削峰填谷。</p></blockquote><h2 id="与其他-Redis-队列方案对比（核心优势）">与其他 Redis 队列方案对比（核心优势）</h2><p>• 对比 List<br>- List 是简单的先进先出，不支持多播（多个消费者会抢消息）、无消费组、无消息确认，仅适合简单一对一队列；<br>- Stream 支持多播+消费组+确认机制，适合复杂分布式场景。</p><table><thead><tr><th>对比项</th><th>Stream</th><th>List</th></tr></thead><tbody><tr><td>消费者组</td><td>✅</td><td>❌</td></tr><tr><td>ACK</td><td>✅</td><td>❌</td></tr><tr><td>重试</td><td>✅</td><td>❌</td></tr><tr><td>阻塞</td><td>✅</td><td>✅</td></tr><tr><td>顺序性</td><td>强</td><td>强</td></tr></tbody></table><p>• 对比 Pub/Sub<br>- Pub/Sub 无持久化，Redis 重启或消费者离线会丢消息；<br>- Pub/Sub 无消费组，消息发完即丢，仅适合实时广播（如聊天室），不适合重要业务。</p><h2 id="Stream-命令">Stream 命令</h2><ul class="lvl-0"><li class="lvl-2"><p>SpringBoot 的 <code>StringRedisTemplate.opsForStream()</code> 中 Stream 数据类型 的操作方法与 Redis 原生命令的对应关系如下：</p></li></ul><blockquote><p>注意这里不一定要用 <code>StringRedisTemplate</code> 来操作 Stream，但是用 <code>StringRedisTemplate</code> 可以保证可读性。</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>核心能力划分：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">消息写入（XADD）</span><br><span class="line">消息确认（XACK）</span><br><span class="line">消息读取（XRANGE / XREAD / XREADGROUP）</span><br><span class="line">Pending 消息管理（XPENDING / XCLAIM）</span><br><span class="line">消费者组管理（XGROUP）</span><br><span class="line">Stream 元信息（XINFO）</span><br><span class="line">Stream 裁剪与删除（XTRIM / XDEL）</span><br><span class="line">对象映射（MapRecord / ObjectRecord）</span><br></pre></td></tr></table></figure><h3 id="消息写入（XADD）">消息写入（XADD）</h3><ul class="lvl-0"><li class="lvl-2"><p>1️⃣ 基础写入</p></li></ul><table><thead><tr><th>方法功能</th><th>方法 <code>opsForStream().xxx()</code></th><th>Redis 原始命令</th><th>说明</th></tr></thead><tbody><tr><td>写入 Map</td><td><code>add(K key, Map&lt;HK,HV&gt;)</code></td><td><code>XADD key * field value</code></td><td>自动生成 ID</td></tr><tr><td>写入 Record</td><td><code>add(Record&lt;K, ?&gt; record)</code></td><td><code>XADD</code></td><td>支持 ObjectRecord</td></tr><tr><td>写入 MapRecord</td><td><code>add(MapRecord&lt;K,HK,HV&gt;)</code></td><td><code>XADD</code></td><td>Map 形式</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>2️⃣ 带参数写入（推荐）</p></li></ul><table><thead><tr><th>方法功能</th><th>方法</th><th>Redis 原始命令</th><th>备注</th></tr></thead><tbody><tr><td>写入 + 选项</td><td><code>add(record, XAddOptions)</code></td><td><code>XADD ...</code></td><td>支持 MAXLEN / NOMKSTREAM</td></tr><tr><td>Map + 选项</td><td><code>add(key, map, XAddOptions)</code></td><td><code>XADD</code></td><td>Redis ≥ 6</td></tr></tbody></table><h3 id="消息确认（XACK）">消息确认（XACK）</h3><table><thead><tr><th>方法功能</th><th>方法</th><th>Redis 原始命令</th><th>说明</th></tr></thead><tbody><tr><td>确认消息</td><td><code>acknowledge(key, group, recordIds…)</code></td><td><code>XACK</code></td><td>标记已消费</td></tr><tr><td>Record 确认</td><td><code>acknowledge(group, record)</code></td><td><code>XACK</code></td><td>常用</td></tr></tbody></table><blockquote><p>⚠️ 只对 Consumer Group 生效</p></blockquote><h3 id="消息读取（无消费者组）">消息读取（无消费者组）</h3><ul class="lvl-0"><li class="lvl-2"><p>1️⃣ 按 Range 读取（历史数据）</p></li></ul><table><thead><tr><th>方法功能</th><th>方法</th><th>Redis 原始命令</th></tr></thead><tbody><tr><td>正序读取</td><td><code>range(key, range)</code></td><td><code>XRANGE</code></td></tr><tr><td>限制条数</td><td><code>range(key, range, limit)</code></td><td><code>XRANGE</code></td></tr><tr><td>反序读取</td><td><code>reverseRange(key, range)</code></td><td><code>XREVRANGE</code></td></tr><tr><td>反序 + limit</td><td><code>reverseRange(key, range, limit)</code></td><td><code>XREVRANGE</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>2️⃣ 实时读取（XREAD）</p></li></ul><table><thead><tr><th>方法功能</th><th>方法</th><th>Redis 原始命令</th><th>说明</th></tr></thead><tbody><tr><td>读取</td><td><code>read(StreamOffset…)</code></td><td><code>XREAD</code></td><td>不支持 ACK</td></tr><tr><td>带参数</td><td><code>read(options, offsets…)</code></td><td><code>XREAD</code></td><td>BLOCK / COUNT</td></tr><tr><td>映射对象</td><td><code>read(Class&lt;T&gt;, …)</code></td><td><code>XREAD</code></td><td>自动反序列化</td></tr></tbody></table><h3 id="消费者组读取（XREADGROUP）">消费者组读取（XREADGROUP）</h3><table><thead><tr><th>方法功能</th><th>方法</th><th>Redis 原始命令</th><th>说明</th></tr></thead><tbody><tr><td>组内读取</td><td><code>read(Consumer, offsets…)</code></td><td><code>XREADGROUP</code></td><td>MQ 核心</td></tr><tr><td>带参数</td><td><code>read(Consumer, options, offsets…)</code></td><td><code>XREADGROUP</code></td><td>BLOCK</td></tr><tr><td>映射对象</td><td><code>read(Class&lt;T&gt;, Consumer, …)</code></td><td><code>XREADGROUP</code></td><td>—</td></tr></tbody></table><h3 id="Pending-消息管理（XPENDING-XCLAIM）">Pending 消息管理（XPENDING / XCLAIM）</h3><ul class="lvl-0"><li class="lvl-2"><p>1️⃣ Pending 查询</p></li></ul><table><thead><tr><th>方法功能</th><th>方法</th><th>Redis 原始命令</th></tr></thead><tbody><tr><td>Pending 汇总</td><td><code>pending(key, group)</code></td><td><code>XPENDING</code></td></tr><tr><td>指定消费者</td><td><code>pending(key, consumer)</code></td><td><code>XPENDING</code></td></tr><tr><td>范围查询</td><td><code>pending(key, group, range, count)</code></td><td><code>XPENDING</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>2️⃣ 消息重新分配（XCLAIM）</p></li></ul><table><thead><tr><th>方法功能</th><th>方法</th><th>Redis 原始命令</th><th>说明</th></tr></thead><tbody><tr><td>重新分配</td><td><code>claim(key, group, newOwner, minIdle, ids…)</code></td><td><code>XCLAIM</code></td><td>超时接管</td></tr><tr><td>高级配置</td><td><code>claim(key, group, newOwner, XClaimOptions)</code></td><td><code>XCLAIM</code></td><td>force / retry</td></tr></tbody></table><h3 id="消费者组管理（XGROUP）">消费者组管理（XGROUP）</h3><table><thead><tr><th>方法功能</th><th>方法</th><th>Redis 原始命令</th><th>说明</th></tr></thead><tbody><tr><td>创建组</td><td><code>createGroup(key, group)</code></td><td><code>XGROUP CREATE</code></td><td>从 <code>$</code> 开始</td></tr><tr><td>指定 offset</td><td><code>createGroup(key, offset, group)</code></td><td><code>XGROUP CREATE</code></td><td>常用 <code>0-0</code></td></tr><tr><td>删除消费者</td><td><code>deleteConsumer(key, consumer)</code></td><td><code>XGROUP DELCONSUMER</code></td><td></td></tr><tr><td>销毁组</td><td><code>destroyGroup(key, group)</code></td><td><code>XGROUP DESTROY</code></td><td></td></tr></tbody></table><h3 id="Stream-元信息（XINFO）">Stream 元信息（XINFO）</h3><table><thead><tr><th>方法功能</th><th>方法</th><th>Redis 原始命令</th></tr></thead><tbody><tr><td>Stream 信息</td><td><code>info(key)</code></td><td><code>XINFO STREAM</code></td></tr><tr><td>组信息</td><td><code>groups(key)</code></td><td><code>XINFO GROUPS</code></td></tr><tr><td>消费者信息</td><td><code>consumers(key, group)</code></td><td><code>XINFO CONSUMERS</code></td></tr></tbody></table><h3 id="Stream-删除-裁剪">Stream 删除 / 裁剪</h3><ul class="lvl-0"><li class="lvl-2"><p>1️⃣ 删除消息</p></li></ul><table><thead><tr><th>方法功能</th><th>方法</th><th>Redis 原始命令</th></tr></thead><tbody><tr><td>删除消息</td><td><code>delete(key, recordIds…)</code></td><td><code>XDEL</code></td></tr><tr><td>删除 Record</td><td><code>delete(record)</code></td><td><code>XDEL</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>2️⃣ 裁剪 Stream（XTRIM）</p></li></ul><table><thead><tr><th>方法功能</th><th>方法</th><th>Redis 原始命令</th><th>说明</th></tr></thead><tbody><tr><td>精确裁剪</td><td><code>trim(key, count)</code></td><td><code>XTRIM</code></td><td></td></tr><tr><td>近似裁剪</td><td><code>trim(key, count, true)</code></td><td><code>XTRIM ~</code></td><td>性能更好</td></tr></tbody></table><h3 id="对象映射能力（非常重要）">对象映射能力（非常重要）</h3><table><thead><tr><th>能力</th><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>Map → Object</td><td><code>map(MapRecord, Class&lt;T&gt;)</code></td><td>自动反序列化</td></tr><tr><td>List 映射</td><td><code>map(List&lt;MapRecord&gt;, Class&lt;T&gt;)</code></td><td></td></tr><tr><td>HashMapper</td><td><code>getHashMapper(Class&lt;T&gt;)</code></td><td>自定义映射</td></tr><tr><td>反序列化</td><td><code>deserializeRecord(ByteRecord)</code></td><td>底层能力</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文介绍 Redis Stream 数据类型&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文基于&lt;code&gt;redis-7.4.7&lt;/code&gt;，&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis官网：&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis 命令文档：&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis 命令及数据类型 -- Geo</title>
    <link href="https://blog.hanqunfeng.com/2025/12/19/redis7-datatype-09-geo/"/>
    <id>https://blog.hanqunfeng.com/2025/12/19/redis7-datatype-09-geo/</id>
    <published>2025-12-19T13:40:05.000Z</published>
    <updated>2025-12-20T05:57:13.739Z</updated>
    
    <content type="html"><![CDATA[<h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2">本文介绍 Redis Geo 数据类型</li><li class="lvl-2">本文基于<code>redis-7.4.7</code>，<code>springboot-3.5.8</code></li><li class="lvl-2">Redis官网：<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis 命令文档：<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li></ul><span id="more"></span><h2 id="Geo-核心详解">Geo 核心详解</h2><ul class="lvl-0"><li class="lvl-2"><p>Redis Geo 是基于有序集合（<code>zset</code>） 实现的地理空间操作功能，底层用<code>geohash编码</code>存储<code>经纬度</code>，核心支持 6 个基础操作 + 2 个扩展操作，兼顾<code>精准存储</code>、<code>距离计算</code>、<code>范围筛选</code>等核心需求，直接对接实际场景（如附近门店、同城好友）。</p></li><li class="lvl-2"><p>有效经度(longitude)为 <code>-180 ~ 180</code>，有效纬度(latitude)为 <code>-85.05112878 ~ 85.05112878</code>。</p></li><li class="lvl-2"><p>Redis 内部实现中：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GEO 数据 ≈ ZSET</span><br><span class="line">score = GeoHash（52 位bit ≈ 11 个字符）</span><br><span class="line">member = 实际成员名</span><br></pre></td></tr></table></figure><h2 id="Geohash-是什么">Geohash 是什么?</h2><ul class="lvl-0"><li class="lvl-2"><p>Geohash 是一种将二维地理坐标（经度、纬度）编码为一维字符串或整数的空间索引算法，核心目标是：</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">将「位置」映射为「可排序的值」</span><br><span class="line">相近的地理位置 → 前缀相同或接近</span><br><span class="line">便于 范围查询、邻近查询、索引存储</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>核心思想</p></li></ul><blockquote><p>不断对经纬度区间进行二分，并交叉编码<br>编码顺序：经度 → 纬度 → 经度 → 纬度 → …</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">每一步：</span><br><span class="line">    1.取当前区间的中点</span><br><span class="line">    2.大于中点记为 1</span><br><span class="line">    3.小于中点记为 0</span><br><span class="line">    4.缩小区间，继续下一位</span><br><span class="line">最终得到一个 bit 序列。</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>Redis 内部的 Geohash 字符 = <code>52bit</code>，即 经度 <code>26 bit</code>，纬度 <code>26 bit</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">每个字符 = 5 bit</span><br><span class="line">内部 52 bit → 按 5 bit 分组 → 52 ÷ 5 = 10 余 2 bit</span><br><span class="line"></span><br><span class="line">Redis 默认在输出字符串时：</span><br><span class="line">    会把 剩余的 2 bit 填充成完整字符，即末尾补三个 0</span><br><span class="line">    因此最终得到 11 个 Base32 字符</span><br></pre></td></tr></table></figure><h3 id="Geohash-计算过程示例">Geohash 计算过程示例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">longitude = 116.397128</span><br><span class="line">latitude  = 39.916527</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>为了简化计算过程，我们这里固定一个常用精度：</p><ul class="lvl-2"><li class="lvl-6">精度选择：5 个 Geohash 字符 = 25 个 bit ⇒ 经度 13 bit，纬度 12 bit（奇数位经度）</li></ul></li><li class="lvl-2"><p>逐位计算（关键过程）<br>1️⃣ 经度 bit（13 位）</p></li></ul><table><thead><tr><th>位次</th><th>区间</th><th>mid</th><th>判断</th><th>bit</th></tr></thead><tbody><tr><td>1</td><td>[-180,180]</td><td>0</td><td>116 ≥ 0</td><td>1</td></tr><tr><td>2</td><td>[0,180]</td><td>90</td><td>116 ≥ 90</td><td>1</td></tr><tr><td>3</td><td>[90,180]</td><td>135</td><td>116 &lt; 135</td><td>0</td></tr><tr><td>4</td><td>[90,135]</td><td>112.5</td><td>116 ≥ 112.5</td><td>1</td></tr><tr><td>5</td><td>[112.5,135]</td><td>123.75</td><td>116 &lt; 123.75</td><td>0</td></tr><tr><td>6</td><td>[112.5,123.75]</td><td>118.125</td><td>116 &lt; 118.125</td><td>0</td></tr><tr><td>7</td><td>[112.5,118.125]</td><td>115.3125</td><td>116 ≥ 115.3125</td><td>1</td></tr><tr><td>8</td><td>[115.3125,118.125]</td><td>116.71875</td><td>116 &lt; 116.71875</td><td>0</td></tr><tr><td>9</td><td>[115.3125,116.71875]</td><td>116.015625</td><td>116 ≥ 116.015625</td><td>1</td></tr><tr><td>10</td><td>[116.015625,116.71875]</td><td>116.3671875</td><td>116 ≥ 116.3671875</td><td>1</td></tr><tr><td>11</td><td>[116.3671875,116.71875]</td><td>116.54296875</td><td>116 &lt; 116.54296875</td><td>0</td></tr><tr><td>12</td><td>[116.3671875,116.54296875]</td><td>116.455078125</td><td>116 &lt; 116.455078125</td><td>0</td></tr><tr><td>13</td><td>[116.3671875,116.455078125]</td><td>116.4111328125</td><td>116 &lt; 116.4111328125</td><td>0</td></tr></tbody></table><blockquote><p>经度 bit（13 位）：<code>1101001011000</code></p></blockquote><p>2️⃣ 纬度 bit（12 位）</p><table><thead><tr><th>位次</th><th>区间</th><th>mid</th><th>判断</th><th>bit</th></tr></thead><tbody><tr><td>1</td><td>[-90,90]</td><td>0</td><td>39 ≥ 0</td><td>1</td></tr><tr><td>2</td><td>[0,90]</td><td>45</td><td>39 &lt; 45</td><td>0</td></tr><tr><td>3</td><td>[0,45]</td><td>22.5</td><td>39 ≥ 22.5</td><td>1</td></tr><tr><td>4</td><td>[22.5,45]</td><td>33.75</td><td>39 ≥ 33.75</td><td>1</td></tr><tr><td>5</td><td>[33.75,45]</td><td>39.375</td><td>39 &lt; 39.375</td><td>0</td></tr><tr><td>6</td><td>[33.75,39.375]</td><td>36.5625</td><td>39 ≥ 36.5625</td><td>1</td></tr><tr><td>7</td><td>[36.5625,39.375]</td><td>37.96875</td><td>39 ≥ 37.96875</td><td>1</td></tr><tr><td>8</td><td>[37.96875,39.375]</td><td>38.671875</td><td>39 ≥ 38.671875</td><td>1</td></tr><tr><td>9</td><td>[38.671875,39.375]</td><td>39.0234375</td><td>39 &lt; 39.0234375</td><td>0</td></tr><tr><td>10</td><td>[38.671875,39.0234375]</td><td>38.84765625</td><td>39 ≥ 38.84765625</td><td>1</td></tr><tr><td>11</td><td>[38.84765625,39.0234375]</td><td>38.935546875</td><td>39 ≥ 38.935546875</td><td>1</td></tr><tr><td>12</td><td>[38.935546875,39.0234375]</td><td>38.9794921875</td><td>39 ≥ 38.9794921875</td><td>1</td></tr></tbody></table><blockquote><p>纬度 bit（12 位）：<code>101101110111</code></p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>交叉合并（最终 bit 序列）</p></li></ul><blockquote><p>按规则：经度 → 纬度 → 经度 → 纬度 …</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">经度: 1 1 0 1 0 0 1 0 1 1 0 0 0</span><br><span class="line">纬度: 1 0 1 1 0 1 1 1 0 1 1 1</span><br><span class="line"></span><br><span class="line">交叉后得到 25 bit：11 10 01 11 00 01 11 01 10 11 01 01 01</span><br><span class="line">合并为一行：1110011100011101101010101</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>每 5 bit → 1 个 Base32 字符</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从左到右，每 5 位一组：</span></span><br><span class="line">11100 | 11100 | 01110 | 11010 | 10101</span><br><span class="line"><span class="comment"># 转10进制</span></span><br><span class="line">28    | 28    | 14    | 26    | 21</span><br><span class="line"><span class="comment"># 转 Base32</span></span><br><span class="line">w     | w    | f    | u    | p</span><br><span class="line"><span class="comment"># 最终结果：</span></span><br><span class="line">wwfup</span><br></pre></td></tr></table></figure><div class="tips"><p><em><strong>Geohash 使用的 Base32 字符集（固定，不是 RFC Base32）：</strong></em></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Index:  0 1 2 3 4 5 6 7 8 9</span><br><span class="line">Char :  0 1 2 3 4 5 6 7 8 9</span><br><span class="line"></span><br><span class="line">Index: 10 11 12 13 14 15 16 17 18 19</span><br><span class="line">Char :  b  c  d  e  f  g  h  j  k  m</span><br><span class="line"></span><br><span class="line">Index: 20 21 22 23 24 25 26 27 28 29</span><br><span class="line">Char :  n  p  q  r  s  t  u  v  w  x</span><br><span class="line"></span><br><span class="line">Index: 30 31</span><br><span class="line">Char :  y  z</span><br></pre></td></tr></table></figure><ul class="lvl-1"><li class="lvl-2">Geohash Base32 字符集 为什么缺少 <code>a, i, l, o</code><ul class="lvl-3"><li class="lvl-6">为了避免在视觉上引起数字混淆</li></ul>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a 容易和 4 混淆</span><br><span class="line">i 容易和 1 混淆</span><br><span class="line">l 容易和 1 混淆</span><br><span class="line">o 容易和 0 混淆</span><br></pre></td></tr></table></figure><ul class="lvl-3"><li class="lvl-6">去掉 <code>a, i, l, o</code> 后刚好是 32 个字符，因为 Geohash 需要 2⁵ = 32 个字符 对应 5 bit 精度</li></ul></li></ul></div><h2 id="Geo-核心基础操作（必用）">Geo 核心基础操作（必用）</h2><h3 id="1-GEOADD：添加地理位置坐标（核心写入操作）">1. GEOADD：添加地理位置坐标（核心写入操作）</h3><p>◦ 语法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GEOADD key [NX | XX] [CH] longitude latitude member [longitude latitude member ...]</span><br><span class="line"><span class="comment"># 参数说明：</span></span><br><span class="line"><span class="comment"># key: key名称</span></span><br><span class="line"><span class="comment"># NX：如果已存在，则不执行写入操作</span></span><br><span class="line"><span class="comment"># XX: 如果不存在，则执行写入操作，与 NX 互斥</span></span><br><span class="line"><span class="comment"># CH: （CH是更改的缩写）返回新增和修改的成员数量，修改经纬度也算修改，如果不加CH，则只计算新增成员数量</span></span><br><span class="line"><span class="comment"># longitude: 经度 (-180 ~ 180)</span></span><br><span class="line"><span class="comment"># latitude: 纬度 (-85.05112878 ~ 85.05112878)</span></span><br><span class="line"><span class="comment"># member: 成员名称，位置唯一标识（字符串）</span></span><br><span class="line"><span class="comment"># 返回值：(不带CH)成功新增的 member 数量（已存在不会重复计算），(带CH)返回新增和修改的成员数量</span></span><br></pre></td></tr></table></figure><p>◦ 示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 给shop集合加王府井、西单2个门店的经纬度</span></span><br><span class="line">GEOADD shop 116.403963 39.915112 wangfujing 116.391248 39.906217 xidan</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br></pre></td></tr></table></figure><p>◦ 关键：经纬度顺序不能反，存储后会自动给每个成员生成geohash编码。</p><h3 id="2-GEOPOS：获取指定成员的经纬度（精准查询坐标）">2. GEOPOS：获取指定成员的经纬度（精准查询坐标）</h3><p>◦ 语法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GEOPOS key [member [member ...]]</span><br></pre></td></tr></table></figure><p>◦ 示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 返回王府井的经纬度数组 [经度, 纬度]</span></span><br><span class="line">GEOPOS shop wangfujing</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">1) 1) <span class="string">&quot;116.40396326780319214&quot;</span></span><br><span class="line">   2) <span class="string">&quot;39.91511209922290249&quot;</span></span><br></pre></td></tr></table></figure><p>◦ 关键：返回结果与查询成员顺序一致，不存在的成员返回nil，可批量查询提升效率。</p><h3 id="3-GEODIST：计算两个成员之间的距离（核心计算操作）">3. GEODIST：计算两个成员之间的距离（核心计算操作）</h3><p>◦ 语法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GEODIST key member1 member2 [M|KM|FT|MI]</span><br><span class="line"><span class="comment"># [M|KM|FT|MI] : 距离单位</span></span><br><span class="line"><span class="comment"># M : 米，默认</span></span><br><span class="line"><span class="comment"># KM : 千米</span></span><br><span class="line"><span class="comment"># FT : 英尺</span></span><br><span class="line"><span class="comment"># MI : 英里</span></span><br></pre></td></tr></table></figure><p>◦ 示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 返回王府井和西单之间的距离，单位为米</span></span><br><span class="line">GEODIST shop wangfujing xidan</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="string">&quot;1468.0611&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算王府井到西单的距离，单位千米</span></span><br><span class="line">GEODIST shop wangfujing xidan km</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="string">&quot;1.4681&quot;</span></span><br></pre></td></tr></table></figure><p>◦ 关键：返回浮点型结果，成员不存在返回nil，支持跨区域距离计算（如不同城市门店）。</p><h3 id="4-GEOHASH：获取指定成员的geohash编码（底层编码查询）">4. GEOHASH：获取指定成员的geohash编码（底层编码查询）</h3><p>◦ 语法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GEOHASH key [member [member ...]]</span><br></pre></td></tr></table></figure><p>◦ 示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 返回王府井的geohash字符串，共11位</span></span><br><span class="line">GEOHASH shop wangfujing</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">1) <span class="string">&quot;wx4g0f6f2u0&quot;</span></span><br></pre></td></tr></table></figure><p>◦ 关键：geohash编码越长精度越高，Redis默认精度足够日常使用；编码相同的成员，地理位置极近，可用于快速判近。</p><h3 id="5-GEORADIUS：按指定经纬度为中心，筛选指定范围的成员（范围查询1，按中心点坐标）">5. GEORADIUS：按指定经纬度为中心，筛选指定范围的成员（范围查询1，按中心点坐标）</h3><ul class="lvl-0"><li class="lvl-2"><p>即将弃用，请使用 <code>GEOSEARCH</code> / <code>GEOSEARCHSTORE</code> 替代<br>◦ 语法：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GEORADIUS key longitude latitude radius M|KM|FT|MI [WITHCOORD] [WITHDIST] [WITHHASH] [COUNT count [ANY]] [ASC|DESC] [STORE key|STOREDIST key]</span><br><span class="line"><span class="comment"># 参数说明</span></span><br><span class="line"><span class="comment"># key: key名称</span></span><br><span class="line"><span class="comment"># longitude: 经度</span></span><br><span class="line"><span class="comment"># latitude: 纬度</span></span><br><span class="line"><span class="comment"># radius: 半径</span></span><br><span class="line"><span class="comment"># M|KM|FT|MI: 单位</span></span><br><span class="line"><span class="comment">## 可选参数</span></span><br><span class="line"><span class="comment"># WITHCOORD: 返回经纬度</span></span><br><span class="line"><span class="comment"># WITHDIST: 带距离</span></span><br><span class="line"><span class="comment"># WITHHASH: 带geohash</span></span><br><span class="line"><span class="comment"># COUNT count: 限制返回数量</span></span><br><span class="line"><span class="comment"># ANY: 随机返回数量</span></span><br><span class="line"><span class="comment"># ASC/DESC: 按距离正/倒序</span></span><br><span class="line"><span class="comment"># STORE key: 存储结果到指定key</span></span><br><span class="line"><span class="comment"># STOREDIST key: 存储结果到指定key，结果为距离</span></span><br></pre></td></tr></table></figure><p>◦ 核心可选参数：WITHDIST（返回距离）、WITHCOORD（返回经纬度）、WITHHASH（返回geohash）、COUNT n（限制返回数量）、ASC/DESC（按距离正/倒序）</p><p>◦ 示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以天安门附近为中心，查5km内10个门店，按距离从近到远返回并带距离</span></span><br><span class="line">GEORADIUS shop 116.397 39.91 5 km WITHDIST COUNT 10 ASC</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">1) 1) <span class="string">&quot;xidan&quot;</span></span><br><span class="line">   2) <span class="string">&quot;0.6463&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;wangfujing&quot;</span></span><br><span class="line">   2) <span class="string">&quot;0.8223&quot;</span></span><br></pre></td></tr></table></figure><h3 id="6-GEORADIUSBYMEMBER：按已有成员为中心，筛选指定范围的成员（范围查询2，按已有节点，更常用）">6. GEORADIUSBYMEMBER：按已有成员为中心，筛选指定范围的成员（范围查询2，按已有节点，更常用）</h3><ul class="lvl-0"><li class="lvl-2"><p>即将弃用，请使用 <code>GEOSEARCH</code> / <code>GEOSEARCHSTORE</code> 替代<br>◦ 语法：</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GEORADIUSBYMEMBER key member radius M|KM|FT|MI [WITHCOORD] [WITHDIST] [WITHHASH] [COUNT count [ANY]] [ASC|DESC] [STORE key|STOREDIST key]</span><br><span class="line"><span class="comment"># 语法说明：</span></span><br><span class="line"><span class="comment"># key: key名称</span></span><br><span class="line"><span class="comment"># member: 已有成员名称</span></span><br><span class="line"><span class="comment"># radius: 半径</span></span><br><span class="line"><span class="comment"># M|KM|FT|MI: 单位</span></span><br><span class="line"><span class="comment">## 可选参数说明同 GEORADIUS</span></span><br></pre></td></tr></table></figure><p>◦ 可选参数与GEORADIUS一致，场景更贴合实际（如查“我附近”的门店，先存自己的坐标为成员，再用此命令）<br>◦ 示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查王府井3km内的门店，按距离排序</span></span><br><span class="line">GEORADIUSBYMEMBER shop wangfujing 3 km WITHDIST ASC</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">1) 1) <span class="string">&quot;wangfujing&quot;</span></span><br><span class="line">   2) <span class="string">&quot;0.0000&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;xidan&quot;</span></span><br><span class="line">   2) <span class="string">&quot;1.4681&quot;</span></span><br></pre></td></tr></table></figure><h2 id="Geo-扩展操作（实战常用）">Geo 扩展操作（实战常用）</h2><h3 id="1-GEOSEARCH（Redis-6-2-新增，替代-GEORADIUS-GEORADIUSBYMEMBER）">1. GEOSEARCH（Redis 6.2+ 新增，替代 GEORADIUS/GEORADIUSBYMEMBER）</h3><p>◦ 优势：功能更全、语法更统一，支持两种查询模式，是未来主流用法</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GEOSEARCH key &lt;FROMMEMBER member | FROMLONLAT longitude latitude&gt;</span><br><span class="line">  &lt;BYRADIUS radius &lt;M | KM | FT | MI&gt; | BYBOX width height &lt;M | KM | FT | MI&gt;&gt;</span><br><span class="line">  [ASC | DESC] [COUNT count [ANY]] [WITHCOORD] [WITHDIST] [WITHHASH]</span><br></pre></td></tr></table></figure><p>◦ 语法1（按坐标中心）：<code>GEOSEARCH key FROMLONLAT 经度 纬度 BYRADIUS 距离 单位 [可选参数]</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查天安门3km内的门店，按距离排序</span></span><br><span class="line">GEOSEARCH shop FROMLONLAT 116.397 39.91 BYRADIUS 3 km WITHDIST WITHCOORD WITHHASH ASC COUNT 10</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">1) 1) <span class="string">&quot;xidan&quot;</span></span><br><span class="line">   2) <span class="string">&quot;0.6463&quot;</span></span><br><span class="line">   3) (<span class="built_in">integer</span>) 4069885362016563</span><br><span class="line">   4) 1) <span class="string">&quot;116.39124959707260132&quot;</span></span><br><span class="line">      2) <span class="string">&quot;39.90621776267477827&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;wangfujing&quot;</span></span><br><span class="line">   2) <span class="string">&quot;0.8223&quot;</span></span><br><span class="line">   3) (<span class="built_in">integer</span>) 4069885555089518</span><br><span class="line">   4) 1) <span class="string">&quot;116.40396326780319214&quot;</span></span><br><span class="line">      2) <span class="string">&quot;39.91511209922290249&quot;</span></span><br></pre></td></tr></table></figure><p>◦ 语法2（按成员中心）：<code>GEOSEARCH key FROMMEMBER 中心成员 BYRADIUS 距离 单位 [可选参数]</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查王府井3km内的门店，按距离排序</span></span><br><span class="line">GEOSEARCH shop FROMMEMBER wangfujing BYRADIUS 3 km WITHDIST WITHCOORD WITHHASH ASC COUNT 10</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">1) 1) <span class="string">&quot;wangfujing&quot;</span></span><br><span class="line">   2) <span class="string">&quot;0.0000&quot;</span></span><br><span class="line">   3) (<span class="built_in">integer</span>) 4069885555089518</span><br><span class="line">   4) 1) <span class="string">&quot;116.40396326780319214&quot;</span></span><br><span class="line">      2) <span class="string">&quot;39.91511209922290249&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;xidan&quot;</span></span><br><span class="line">   2) <span class="string">&quot;1.4681&quot;</span></span><br><span class="line">   3) (<span class="built_in">integer</span>) 4069885362016563</span><br><span class="line">   4) 1) <span class="string">&quot;116.39124959707260132&quot;</span></span><br><span class="line">      2) <span class="string">&quot;39.90621776267477827&quot;</span></span><br></pre></td></tr></table></figure><p>◦ 新增特性：支持 <code>BYBOX（按矩形范围查询）</code>，适配更多场景（如查询某片区内的门店）。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查王府井2.0*2.0km内的门店，按距离排序，这里以 王府井 为矩形的中心，查询2.0*2.0km内的门店</span></span><br><span class="line"><span class="comment"># 西单距离王府井 1.4681 km，所以不在结果中</span></span><br><span class="line">GEOSEARCH shop FROMMEMBER wangfujing BYBOX 2.0 2.0 km WITHDIST WITHCOORD WITHHASH ASC COUNT 10</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line">1) 1) <span class="string">&quot;wangfujing&quot;</span></span><br><span class="line">   2) <span class="string">&quot;0.0000&quot;</span></span><br><span class="line">   3) (<span class="built_in">integer</span>) 4069885555089518</span><br><span class="line">   4) 1) <span class="string">&quot;116.40396326780319214&quot;</span></span><br><span class="line">      2) <span class="string">&quot;39.91511209922290249&quot;</span></span><br></pre></td></tr></table></figure><h3 id="2-GEOSEARCHSTORE（Redis-6-2-新增）">2. GEOSEARCHSTORE（Redis 6.2+ 新增）</h3><p>◦ 作用：将 GEOSEARCH 的查询结果，直接存储到指定zset中，方便后续二次处理（如分页、排序）<br>◦ 语法：GEOSEARCHSTORE 目标key 源key 查询条件（同GEOSEARCH）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GEOSEARCHSTORE destination <span class="built_in">source</span></span><br><span class="line">  &lt;FROMMEMBER member | FROMLONLAT longitude latitude&gt;</span><br><span class="line">  &lt;BYRADIUS radius &lt;M | KM | FT | MI&gt; | BYBOX width height &lt;M | KM | FT | MI&gt;&gt;</span><br><span class="line">  [ASC | DESC] [COUNT count [ANY]] [STOREDIST]</span><br></pre></td></tr></table></figure><p>◦ 示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 把王府井3km内的门店，存到near_shop集合</span></span><br><span class="line">GEOSEARCHSTORE near_shop shop FROMMEMBER wangfujing BYRADIUS 3 km</span><br></pre></td></tr></table></figure><h2 id="底层核心与实战注意事项">底层核心与实战注意事项</h2><ol><li class="lvl-3"><p>底层本质：所有Geo操作的key，本质都是zset，因此zset的命令（如ZREM、ZSCORE）可直接用于Geo key，例如 ZREM shop xidan 可删除西单的地理位置（Geo无单独删除命令，依赖ZREM）。</p></li><li class="lvl-3"><p>精度限制：经纬度支持小数点后多位，但Redis内部会做精度取舍，日常场景（如打车、门店）完全够用，无需额外处理。</p></li><li class="lvl-3"><p>性能优化：大范围查询（如100km以上）建议加COUNT限制返回数量；高频查询可将结果缓存到普通key，减少Geo计算开销。</p></li><li class="lvl-3"><p>适用场景：附近门店、同城社交、物流定位，不适用高精度场景（如军事、测绘），此类场景需用专业GIS系统。</p></li></ol><h2 id="典型实战场景示例">典型实战场景示例</h2><ul class="lvl-0"><li class="lvl-2"><p>需求：搭建“附近餐饮”查询功能，支持添加餐饮坐标、查询当前位置3km内餐饮并按距离排序。</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 批量添加餐饮坐标</span></span><br><span class="line">GEOADD restaurant 116.405 39.916 aaa 116.402 39.913 bbb 116.408 39.918 ccc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 查当前位置（116.404,39.915）3km内餐饮（带距离、正序）</span></span><br><span class="line">GEOSEARCH restaurant FROMLONLAT 116.404 39.915 BYRADIUS 3 km WITHDIST ASC</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 删除某餐饮</span></span><br><span class="line">ZREM restaurant aaa</span><br></pre></td></tr></table></figure><h2 id="Geo-命令">Geo 命令</h2><ul class="lvl-0"><li class="lvl-2"><p>SpringBoot 的 <code>StringRedisTemplate.opsForGeo()</code> 中 Geo 数据类型 的操作方法与 Redis 原生命令的对应关系如下：</p></li></ul><blockquote><p>注意这里一定要用 <code>StringRedisTemplate</code> 来操作 Geo</p></blockquote><h3 id="写入-删除类操作">写入 / 删除类操作</h3><table><thead><tr><th>方法功能</th><th>方法</th><th>Redis 原始命令</th><th>备注</th></tr></thead><tbody><tr><td>添加单个坐标</td><td><code>add(K key, Point point, M member)</code></td><td><code>GEOADD key longitude latitude member</code></td><td>返回 <strong>新增成员数量</strong>（已存在则返回 0）</td></tr><tr><td>添加单个位置</td><td><code>add(K key, GeoLocation&lt;M&gt; location)</code></td><td><code>GEOADD key longitude latitude member</code></td><td><code>GeoLocation</code> 内部封装了 <code>Point + member</code></td></tr><tr><td>批量添加</td><td><code>add(K key, Map&lt;M, Point&gt; map)</code></td><td><code>GEOADD key lon1 lat1 member1 [lon2 lat2 member2 ...]</code></td><td><strong>推荐</strong>，一次网络 IO</td></tr><tr><td>批量添加</td><td><code>add(K key, Iterable&lt;GeoLocation&lt;M&gt;&gt; locations)</code></td><td><code>GEOADD key lon1 lat1 member1 [lon2 lat2 member2 ...]</code></td><td>与 Map 方式等价</td></tr><tr><td>删除成员</td><td><code>remove(K key, M... members)</code></td><td><code>ZREM key member [member ...]</code></td><td>GEO 本质是 <strong>Sorted Set</strong></td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Point</span> <span class="variable">point</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Point</span>(longitude, latitude);</span><br><span class="line">redisTemplate.opsForGeo().add(key, point, member);</span><br><span class="line"></span><br><span class="line">RedisGeoCommands.GeoLocation&lt;String&gt; geoLocation= <span class="keyword">new</span> <span class="title class_">RedisGeoCommands</span>.GeoLocation&lt;&gt;(member, point);</span><br><span class="line">redisTemplate.opsForGeo().add(key, geoLocation);</span><br></pre></td></tr></table></figure><h3 id="距离-坐标-哈希查询">距离 / 坐标 / 哈希查询</h3><table><thead><tr><th>方法功能</th><th>方法</th><th>Redis 原始命令</th><th>说明</th></tr></thead><tbody><tr><td>两点距离</td><td><code>distance(K key, m1, m2)</code></td><td><code>GEODIST key m1 m2</code></td><td>默认单位米</td></tr><tr><td>指定单位距离</td><td><code>distance(K key, m1, m2, metric)</code></td><td><code>GEODIST key m1 m2 unit</code></td><td>m / km / mi / ft</td></tr><tr><td>获取 GeoHash</td><td><code>hash(K key, M... members)</code></td><td><code>GEOHASH key member</code></td><td>用于调试</td></tr><tr><td>获取坐标</td><td><code>position(K key, M... members)</code></td><td><code>GEOPOS key member</code></td><td>lon / lat</td></tr></tbody></table><h3 id="半径查询（旧接口，已不推荐）">半径查询（旧接口，已不推荐）</h3><blockquote><p>Redis 6.2 起，官方不推荐继续使用 GEORADIUS / GEORADIUSBYMEMBER，但 Spring 仍保留接口以兼容。</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>1️⃣ 基于坐标点</p></li></ul><table><thead><tr><th>方法功能</th><th>方法</th><th>Redis 原始命令</th></tr></thead><tbody><tr><td>半径查询</td><td><code>radius(K key, Circle within)</code></td><td><code>GEORADIUS key lon lat radius</code></td></tr><tr><td>半径 + 参数</td><td><code>radius(K key, Circle within, args)</code></td><td><code>GEORADIUS</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>2️⃣ 基于成员</p></li></ul><table><thead><tr><th>方法功能</th><th>方法</th><th>Redis 原始命令</th></tr></thead><tbody><tr><td>半径查询</td><td><code>radius(K key, member, radius)</code></td><td><code>GEORADIUSBYMEMBER</code></td></tr><tr><td>指定单位</td><td><code>radius(K key, member, Distance)</code></td><td><code>GEORADIUSBYMEMBER</code></td></tr><tr><td>带参数</td><td><code>radius(K key, member, Distance, args)</code></td><td><code>GEORADIUSBYMEMBER</code></td></tr></tbody></table><h3 id="搜索查询（推荐使用-GEOSEARCH）">搜索查询（推荐使用 GEOSEARCH）</h3><blockquote><p>替代 GEORADIUS / GEORADIUSBYMEMBER</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>1️⃣ 按圆形范围搜索</p></li></ul><table><thead><tr><th>方法功能</th><th>方法</th><th>Redis 原始命令</th><th>说明</th></tr></thead><tbody><tr><td>圆形搜索</td><td><code>search(K key, Circle within)</code></td><td><code>GEOSEARCH</code></td><td>新推荐接口</td></tr><tr><td>指定参考点</td><td><code>search(K key, GeoReference, Distance)</code></td><td><code>GEOSEARCH</code></td><td>FROMMEMBER / FROMLONLAT</td></tr><tr><td>带参数</td><td><code>search(K key, reference, radius, args)</code></td><td><code>GEOSEARCH</code></td><td>支持排序、limit</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>2️⃣ 按矩形范围搜索</p></li></ul><table><thead><tr><th>方法功能</th><th>方法</th><th>Redis 原始命令</th></tr></thead><tbody><tr><td>矩形搜索</td><td><code>search(K key, reference, BoundingBox)</code></td><td><code>GEOSEARCH</code></td></tr><tr><td>带参数</td><td><code>search(K key, reference, BoundingBox, args)</code></td><td><code>GEOSEARCH</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>通用搜索（底层能力）</p></li></ul><table><thead><tr><th>方法功能</th><th>方法</th><th>Redis 原始命令</th></tr></thead><tbody><tr><td>任意 GeoShape</td><td><code>search(K key, reference, GeoShape, args)</code></td><td><code>GEOSEARCH</code></td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基于给定的坐标搜索</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">search</span><span class="params">(String key, <span class="type">double</span> longitude, <span class="type">double</span> latitude, <span class="type">double</span> radius)</span> &#123;</span><br><span class="line">    <span class="comment">// 中心点</span></span><br><span class="line">    <span class="type">Point</span> <span class="variable">point</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Point</span>(longitude, latitude);</span><br><span class="line">    <span class="comment">// 半径</span></span><br><span class="line">    <span class="type">Distance</span> <span class="variable">distance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Distance</span>(radius, RedisGeoCommands.DistanceUnit.METERS);</span><br><span class="line">    <span class="comment">// 创建圆形</span></span><br><span class="line">    <span class="type">Circle</span> <span class="variable">circle</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Circle</span>(point, distance);</span><br><span class="line">    <span class="comment">// 创建地理参考</span></span><br><span class="line">    GeoReference&lt;String&gt; objectGeoReference = GeoReference.fromCircle(circle);</span><br><span class="line">    <span class="comment">// 创建地理形状</span></span><br><span class="line">    <span class="type">GeoShape</span> <span class="variable">geoShape</span> <span class="operator">=</span> GeoShape.byRadius(distance);</span><br><span class="line">    <span class="comment">// 创建参数</span></span><br><span class="line">    RedisGeoCommands.<span class="type">GeoRadiusCommandArgs</span> <span class="variable">args</span> <span class="operator">=</span> RedisGeoCommands.GeoRadiusCommandArgs.newGeoRadiusArgs()</span><br><span class="line">            .includeCoordinates() <span class="comment">// 返回坐标</span></span><br><span class="line">            .includeDistance() <span class="comment">// 返回距离</span></span><br><span class="line">            .sortAscending() <span class="comment">// 排序</span></span><br><span class="line">            .limit(<span class="number">10</span>); <span class="comment">// 限制返回数量</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询</span></span><br><span class="line">    <span class="keyword">final</span> GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; results = redisTemplate.opsForGeo().search(key, objectGeoReference, geoShape, args);</span><br><span class="line">    <span class="keyword">if</span> (results != <span class="literal">null</span>) &#123;</span><br><span class="line">        results.forEach(result -&gt; &#123;</span><br><span class="line">            <span class="comment">// 获取成员名称</span></span><br><span class="line">            System.out.println(result.getContent().getName());</span><br><span class="line">            <span class="comment">// 获取坐标</span></span><br><span class="line">            System.out.println(result.getContent().getPoint());</span><br><span class="line">            <span class="comment">// 获取距离</span></span><br><span class="line">            System.out.println(result.getDistance());</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基于成员的坐标搜索</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">search</span><span class="params">(String key, String member, <span class="type">double</span> radius)</span> &#123;</span><br><span class="line">    <span class="comment">// 半径</span></span><br><span class="line">    <span class="type">Distance</span> <span class="variable">distance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Distance</span>(radius, RedisGeoCommands.DistanceUnit.METERS);</span><br><span class="line">    <span class="comment">// 创建地理参考</span></span><br><span class="line">    GeoReference&lt;String&gt; objectGeoReference = GeoReference.fromMember(member);</span><br><span class="line">    <span class="comment">// 创建地理形状</span></span><br><span class="line">    <span class="type">GeoShape</span> <span class="variable">geoShape</span> <span class="operator">=</span> GeoShape.byRadius(distance);</span><br><span class="line">    <span class="comment">// 创建参数</span></span><br><span class="line">    RedisGeoCommands.<span class="type">GeoRadiusCommandArgs</span> <span class="variable">args</span> <span class="operator">=</span> RedisGeoCommands.GeoRadiusCommandArgs.newGeoRadiusArgs()</span><br><span class="line">            .includeCoordinates() <span class="comment">// 返回坐标</span></span><br><span class="line">            .includeDistance() <span class="comment">// 返回距离</span></span><br><span class="line">            .sortAscending() <span class="comment">// 排序</span></span><br><span class="line">            .limit(<span class="number">10</span>); <span class="comment">// 限制返回数量</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询</span></span><br><span class="line">    <span class="keyword">final</span> GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; results = redisTemplate.opsForGeo().search(key, objectGeoReference, geoShape, args);</span><br><span class="line">    <span class="keyword">if</span> (results != <span class="literal">null</span>) &#123;</span><br><span class="line">        results.forEach(result -&gt; &#123;</span><br><span class="line">            <span class="comment">// 获取成员名称</span></span><br><span class="line">            System.out.println(result.getContent().getName());</span><br><span class="line">            <span class="comment">// 获取坐标</span></span><br><span class="line">            System.out.println(result.getContent().getPoint());</span><br><span class="line">            <span class="comment">// 获取距离</span></span><br><span class="line">            System.out.println(result.getDistance());</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="搜索并存储（GEOSEARCHSTORE）">搜索并存储（GEOSEARCHSTORE）</h3><blockquote><p>这是 搜索 + 写入 的组合操作，结果会写入新的 ZSet</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>1️⃣ 圆形范围存储</p></li></ul><table><thead><tr><th>方法功能</th><th>方法</th><th>Redis 原始命令</th></tr></thead><tbody><tr><td>搜索并存储</td><td><code>searchAndStore(K key, destKey, Circle)</code></td><td><code>GEOSEARCHSTORE</code></td></tr><tr><td>指定参考点</td><td><code>searchAndStore(K key, destKey, reference, radius)</code></td><td><code>GEOSEARCHSTORE</code></td></tr><tr><td>带参数</td><td><code>searchAndStore(K key, destKey, reference, radius, args)</code></td><td><code>GEOSEARCHSTORE</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>2️⃣ 矩形范围存储</p></li></ul><table><thead><tr><th>方法功能</th><th>方法</th><th>Redis 原始命令</th></tr></thead><tbody><tr><td>矩形存储</td><td><code>searchAndStore(K key, destKey, reference, BoundingBox)</code></td><td><code>GEOSEARCHSTORE</code></td></tr><tr><td>带参数</td><td><code>searchAndStore(K key, destKey, reference, BoundingBox, args)</code></td><td><code>GEOSEARCHSTORE</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>3️⃣ 通用 GeoShape 存储</p></li></ul><table><thead><tr><th>方法功能</th><th>方法</th><th>Redis 原始命令</th></tr></thead><tbody><tr><td>通用存储</td><td><code>searchAndStore(K key, destKey, reference, GeoShape, args)</code></td><td><code>GEOSEARCHSTORE</code></td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文介绍 Redis Geo 数据类型&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文基于&lt;code&gt;redis-7.4.7&lt;/code&gt;，&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis官网：&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis 命令文档：&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis 命令及数据类型 -- Hyperloglog</title>
    <link href="https://blog.hanqunfeng.com/2025/12/19/redis7-datatype-08-hyperloglog/"/>
    <id>https://blog.hanqunfeng.com/2025/12/19/redis7-datatype-08-hyperloglog/</id>
    <published>2025-12-19T13:30:05.000Z</published>
    <updated>2025-12-20T05:57:19.021Z</updated>
    
    <content type="html"><![CDATA[<h2 id="摘要">摘要</h2><ul class="lvl-0"><li class="lvl-2">本文介绍 Redis Hyperloglog 数据类型</li><li class="lvl-2">本文基于<code>redis-7.4.7</code>，<code>springboot-3.5.8</code></li><li class="lvl-2">Redis官网：<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis 命令文档：<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li></ul><span id="more"></span><h2 id="Hyperloglog-核心详解">Hyperloglog 核心详解</h2><ul class="lvl-0"><li class="lvl-2"><p>Redis HyperLogLog 是专门用于做基数统计的高级数据类型，核心优势是用极小的内存（固定约 <code>12KB</code>）就能统计海量数据的基数，误差率仅 <code>0.81%</code>，无需存储全部数据本身。</p></li></ul><blockquote><p>基数：指集合中不重复元素的数量（比如统计 UV，就是不重复访客的数量）。</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>Redis Hyperloglog 并非独立数据类型，而是基于 String 类型的位操作扩展</p></li></ul><h2 id="核心使用方式（3个核心命令）">核心使用方式（3个核心命令）</h2><ul class="lvl-0"><li class="lvl-2"><p>HyperLogLog 命令极简，只有 3 个核心操作</p></li></ul><h3 id="PFADD">PFADD</h3><ul class="lvl-0"><li class="lvl-2"><p>向 HyperLogLog 中添加1个或多个元素，成功添加（元素未存在）返回1，否则返回0。</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PFADD key [element [element ...]]</span><br></pre></td></tr></table></figure><h3 id="PFCOUNT">PFCOUNT</h3><ul class="lvl-0"><li class="lvl-2"><p>统计单个/多个 HyperLogLog 的基数（去重总数），多 key 传入时会计算所有 key 的并集基数。</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PFCOUNT key [key ...]</span><br></pre></td></tr></table></figure><h3 id="PFMERGE">PFMERGE</h3><ul class="lvl-0"><li class="lvl-2"><p>将多个源 HyperLogLog 合并为1个目标 HyperLogLog，适用于跨维度汇总统计（比如合并今日、昨日的 UV 得到两日总 UV）。</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PFMERGE destkey [sourcekey [sourcekey ...]]</span><br></pre></td></tr></table></figure><h2 id="实操示例">实操示例</h2><h3 id="示例1：单-key-基础统计（统计网站-UV）">示例1：单 key 基础统计（统计网站 UV）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 模拟3个访客访问，其中用户A重复访问</span></span><br><span class="line">127.0.0.1:6379&gt; PFADD uv:20251218 userA userB userC</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; PFADD uv:20251218 userA</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 统计当日UV（去重后是3，忽略重复的userA）</span></span><br><span class="line">127.0.0.1:6379&gt; PFCOUNT uv:20251218</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br></pre></td></tr></table></figure><h3 id="示例2：-多-key-合并与汇总统计">示例2： 多 key 合并与汇总统计</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 分别统计12.17和12.18的UV</span></span><br><span class="line">127.0.0.1:6379&gt; PFADD uv:20251217 userA userD</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; PFADD uv:20251218 userA userB userC</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 合并两日UV到 uv:20251217_18</span></span><br><span class="line">127.0.0.1:6379&gt; PFMERGE uv:20251217_18 uv:20251217 uv:20251218</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 统计两日总UV（并集去重，结果为4：userA、B、C、D）</span></span><br><span class="line">127.0.0.1:6379&gt; PFCOUNT uv:20251217_18</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br></pre></td></tr></table></figure><h2 id="核心应用场景（精准落地场景）">核心应用场景（精准落地场景）</h2><ul class="lvl-0"><li class="lvl-2"><p>HyperLogLog 只关注 <strong>“去重数量”</strong>，不关注“具体元素是谁”，适合以下高频场景，也是企业级常用方案：</p></li></ul><ol><li class="lvl-3"><p>网站/APP UV 统计：替代传统的 Set 存储（Set 存海量 UV 内存占用极高），单 key 仅 12KB，轻松统计百万/千万级 UV。</p></li><li class="lvl-3"><p>业务场景去重计数：比如统计单日/单月的独立支付用户数、独立下单用户数、独立点击商品的用户数。</p></li><li class="lvl-3"><p>海量数据去重统计：比如统计某接口的独立调用 IP 数、某直播间的独立观看人数、某广告的独立曝光数。</p></li><li class="lvl-3"><p>跨维度汇总统计：比如合并不同渠道（APP、小程序、H5）的独立访客数，得到全渠道总访客数。</p></li></ol><h2 id="关键注意事项（避坑重点）">关键注意事项（避坑重点）</h2><ol><li class="lvl-3"><p>不存储具体元素，仅存统计结果：无法像 Set 那样获取集合中的具体元素（比如无法通过 HyperLogLog 查到具体是哪些用户访问了网站），只关心“有多少个”，不关心“是谁”。</p></li><li class="lvl-3"><p>误差不可避免，可控不影响大部分场景：固定误差率 <code>0.81%</code>，数据量越大误差越稳定，UV、独立用户数等场景对精度要求不高，完全够用；若需 100% 精准（比如统计核心交易用户数），需用 Set 或 Hash 实现。</p></li><li class="lvl-3"><p>内存占用固定，与数据量无关：无论统计 10 个还是 1 亿个元素，单个 HyperLogLog 占用内存约 <code>12KB</code>，这是其核心优势，也是区别于 Set 的关键。</p></li><li class="lvl-3"><p>元素支持字符串类型：PFADD 传入的元素必须是字符串/字节类型，不支持其他数据类型（如数字、列表等，需手动转为字符串）。</p></li><li class="lvl-3"><p>过期时间支持：HyperLogLog 本身不自带过期机制，但可通过 <code>EXPIRE key seconds</code> 给其设置过期时间（比如 UV 统计按日过期，避免内存堆积）。</p></li><li class="lvl-3"><p>PFADD 幂等性：重复添加同一元素，不会改变基数结果，也不会额外占用内存，可放心重复调用。</p></li></ol><h2 id="与-Set-统计基数的对比（选型参考）">与 Set 统计基数的对比（选型参考）</h2><table><thead><tr><th>对比维度</th><th>HyperLogLog</th><th>Set</th></tr></thead><tbody><tr><td>数据结构类型</td><td>基数统计结构</td><td>无序集合</td></tr><tr><td>内存占用</td><td>固定约 <strong>12KB</strong>，与数据量无关</td><td>随元素数量线性增长，海量数据内存占用极高</td></tr><tr><td>统计结果精度</td><td><strong>非精准</strong>，标准误差约 <strong>0.81%</strong></td><td><strong>100% 精准</strong></td></tr><tr><td>是否支持获取具体元素</td><td>不支持</td><td>支持（如 <code>SMEMBERS</code>）</td></tr><tr><td>是否支持去重</td><td>支持（基数去重）</td><td>支持（元素级去重）</td></tr><tr><td>统计性能</td><td>极快（固定计算逻辑，O(1)）</td><td>数据量越大，统计与遍历成本越高</td></tr><tr><td>适合数据规模</td><td>超大规模（百万 / 千万 / 亿级）</td><td>中小规模集合</td></tr><tr><td>常见使用场景</td><td>UV / DAU 统计、独立 IP 数、访问用户数</td><td>好友列表、标签集合、关注列表</td></tr><tr><td>是否可做集合运算</td><td>不支持</td><td>支持（<code>SUNION</code> / <code>SINTER</code> / <code>SDIFF</code>）</td></tr><tr><td>是否可序列化/持久化</td><td>可（Redis 内部结构）</td><td>可</td></tr><tr><td>选型结论</td><td><strong>低成本 + 海量数据 + 可接受误差的基数统计</strong></td><td><strong>精准统计 + 需要元素明细的场景</strong></td></tr></tbody></table><h2 id="HyperLogLog-命令">HyperLogLog 命令</h2><ul class="lvl-0"><li class="lvl-2"><p>SpringBoot 的 <code>StringRedisTemplate.opsForHyperLogLog()</code> 中 HyperLogLog 数据类型 的操作方法与 Redis 原生命令的对应关系如下：</p></li></ul><blockquote><p>注意这里一定要用 <code>StringRedisTemplate</code> 来操作 HyperLogLog</p></blockquote><table><thead><tr><th>方法功能</th><th>方法</th><th>Redis 原始命令</th><th>备注 / 使用建议</th></tr></thead><tbody><tr><td>添加元素</td><td><code>Long add(K key, V... values)</code></td><td><code>PFADD key element [element ...]</code></td><td>返回 1 表示 HLL 结构发生变化</td></tr><tr><td>获取基数（去重数）</td><td><code>Long size(K... keys)</code></td><td><code>PFCOUNT key [key ...]</code></td><td>支持多 key 合并统计</td></tr><tr><td>合并 HLL</td><td><code>Long union(K destination, K... sourceKeys)</code></td><td><code>PFMERGE destkey sourcekey [sourcekey ...]</code></td><td>合并后写入 destkey</td></tr><tr><td>删除 HLL</td><td><code>void delete(K key)</code></td><td><code>DEL key</code></td><td>直接删除整个 HLL</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;摘要&quot;&gt;摘要&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文介绍 Redis Hyperloglog 数据类型&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;本文基于&lt;code&gt;redis-7.4.7&lt;/code&gt;，&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis官网：&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis 命令文档：&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="技术" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
</feed>
