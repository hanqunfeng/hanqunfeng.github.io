<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>é£˜é€¸å³°çš„åšå®¢</title>
  
  <subtitle>Spring--Javaç¨‹åºå‘˜çš„æ˜¥å¤©</subtitle>
  <link href="https://blog.hanqunfeng.com/atom.xml" rel="self"/>
  
  <link href="https://blog.hanqunfeng.com/"/>
  <updated>2026-01-07T03:38:04.634Z</updated>
  <id>https://blog.hanqunfeng.com/</id>
  
  <author>
    <name>é£˜é€¸å³°</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Redis å‘½ä»¤åŠæ•°æ®ç±»å‹ -- AutoSuggest</title>
    <link href="https://blog.hanqunfeng.com/2026/01/06/redis7-datatype-17-AutoSuggest/"/>
    <id>https://blog.hanqunfeng.com/2026/01/06/redis7-datatype-17-AutoSuggest/</id>
    <published>2026-01-06T13:30:05.000Z</published>
    <updated>2026-01-07T03:38:04.634Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2">æœ¬æ–‡ä»‹ç» Redis æ‰©å±•æ¨¡å— â€“ RediSearch ä¸­ AutoSuggest æ¨¡å— çš„ä½¿ç”¨æ–¹æ³•</li><li class="lvl-2">æœ¬æ–‡åŸºäº<code>redis-7.4.7</code>ï¼Œ<code>springboot-3.5.8</code></li><li class="lvl-2">æ“ä½œç³»ç»Ÿï¼š<code>Amazon Linux 2023(å†…æ ¸ 6.1)</code></li><li class="lvl-2">Rediså®˜ç½‘ï¼š<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis å‘½ä»¤æ–‡æ¡£ï¼š<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li><li class="lvl-2">RediSearch çš„å®‰è£…å‚è§ <a href="/2025/12/26/redis7-module-RediSearch/" title="Redis æ‰©å±•æ¨¡å— -- RediSearch çš„å®‰è£…æ–¹æ³•">Redis æ‰©å±•æ¨¡å— -- RediSearch çš„å®‰è£…æ–¹æ³•</a></li><li class="lvl-2">ç¤ºä¾‹ä»£ç ï¼š<a href="https://github.com/hanqunfeng/springbootchapter/tree/master/springboot3-demo/redis-demo/redisson-demo">GitHub</a></li></ul><span id="more"></span><h2 id="AutoSuggest-æœç´¢å»ºè®®ï¼ˆè‡ªåŠ¨è¡¥å…¨ï¼‰">AutoSuggest æœç´¢å»ºè®®ï¼ˆè‡ªåŠ¨è¡¥å…¨ï¼‰</h2><ul class="lvl-0"><li class="lvl-2"><p>Suggest æœ¬è´¨è§£å†³çš„é—®é¢˜ï¼šâ€œå½“ç”¨æˆ·åªè¾“å…¥éƒ¨åˆ†å‰ç¼€æ—¶ï¼Œå¦‚ä½•é«˜æ€§èƒ½åœ°ç»™å‡ºå€™é€‰è¯ï¼Œè€Œä¸æ˜¯å…¨æ–‡æœç´¢ç»“æœã€‚â€</p></li><li class="lvl-2"><p>Suggest èƒ½è§£å†³ä»€ä¹ˆä¸šåŠ¡é—®é¢˜?</p></li></ul><table><thead><tr><th>ä¸šåŠ¡ç—›ç‚¹</th><th>ä¼ ç»Ÿæ–¹æ¡ˆé—®é¢˜</th><th>Suggest çš„ä»·å€¼</th></tr></thead><tbody><tr><td>æœç´¢æ¡†è‡ªåŠ¨è¡¥å…¨</td><td>LIKE / æ¨¡ç³ŠæŸ¥è¯¢æ€§èƒ½å·®</td><td>O(logN) çº§å‰ç¼€åŒ¹é…</td></tr><tr><td>çƒ­é—¨è¯æ¨è</td><td>éœ€è¦é¢å¤–ç»Ÿè®¡ç³»ç»Ÿ</td><td>å†…ç½® score æ’åº</td></tr><tr><td>æ‹¼å†™ä¸å‡†ç¡®</td><td>æ™®é€šå‰ç¼€æ— æ³•å‘½ä¸­</td><td>FUZZY æ¨¡ç³ŠåŒ¹é…</td></tr><tr><td>è”æƒ³æç¤º</td><td>æœç´¢ç´¢å¼•è¿‡é‡</td><td>Suggest ç‹¬ç«‹ç»“æ„ï¼Œè½»é‡</td></tr><tr><td>é«˜å¹¶å‘æç¤º</td><td>æ•°æ®åº“å‹åŠ›å¤§</td><td>Redis å†…å­˜çº§åå</td></tr><tr><td>å®æ—¶æ›´æ–°</td><td>ç¦»çº¿è¯åº“å¤æ‚</td><td>åŠ¨æ€å¢åˆ </td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>Suggest å‘½ä»¤ä¸ä½¿ç”¨åœºæ™¯å¯¹ç…§è¡¨</p></li></ul><table><thead><tr><th>å‘½ä»¤</th><th>ä½œç”¨</th><th>å…¸å‹ä½¿ç”¨åœºæ™¯</th><th>æ˜¯å¦é«˜é¢‘</th></tr></thead><tbody><tr><td><strong>FT.SUGADD</strong></td><td>æ·»åŠ  / æ›´æ–°è¡¥å…¨è¯</td><td>æ„å»ºè¯åº“ã€åŠ¨æ€çƒ­è¯æ›´æ–°</td><td>â­â­â­â­</td></tr><tr><td><strong>FT.SUGGET</strong></td><td>æŸ¥è¯¢è¡¥å…¨å»ºè®®</td><td>ç”¨æˆ·è¾“å…¥è”æƒ³æç¤º</td><td>â­â­â­â­â­</td></tr><tr><td><strong>FT.SUGDEL</strong></td><td>åˆ é™¤è¡¥å…¨è¯</td><td>è¯ä¸‹æ¶ã€æ¸…ç†è„æ•°æ®</td><td>â­â­</td></tr><tr><td><strong>FT.SUGLEN</strong></td><td>ç»Ÿè®¡è¡¥å…¨è¯æ•°é‡</td><td>ç›‘æ§ã€å®¹é‡è¯„ä¼°</td><td>â­</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>åœºæ™¯ â†’ å‘½ä»¤æ˜ å°„æ€»ç»“è¡¨ï¼ˆæ¨èæ”¶è—ï¼‰</p></li></ul><table><thead><tr><th>ä¸šåŠ¡ç›®æ ‡</th><th>æ¨èå‘½ä»¤ç»„åˆ</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>è‡ªåŠ¨è¡¥å…¨</td><td>SUGADD + SUGGET</td><td>åŸºç¡€èƒ½åŠ›</td></tr><tr><td>çƒ­è¯æ’è¡Œ</td><td>SUGADD(INCR) + SUGGET(WITHSCORES)</td><td>æƒé‡é©±åŠ¨</td></tr><tr><td>æ‹¼å†™çº é”™</td><td>SUGGET(FUZZY)</td><td>å®¹é”™</td></tr><tr><td>åˆ†ç±»æ¨è</td><td>SUGADD(PAYLOAD) + SUGGET(WITHPAYLOADS)</td><td>æºå¸¦ä¸šåŠ¡ä¿¡æ¯</td></tr><tr><td>è¯åº“æ²»ç†</td><td>SUGDEL + SUGLEN</td><td>è¿ç»´</td></tr><tr><td>å®¹é‡ç›‘æ§</td><td>SUGLEN</td><td>è§„æ¨¡è¯„ä¼°</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>ğŸ‘‰ åŸåˆ™ï¼šè¾“å…¥æ¡†æç¤ºç”¨ Suggestï¼Œæœç´¢ç»“æœç”¨ FT.SEARCHã€‚</p></li></ul><h3 id="1ï¸âƒ£-FT-SUGADD-â€”â€”-æ·»åŠ -æ›´æ–°è¡¥å…¨è¯">1ï¸âƒ£ FT.SUGADD â€”â€” æ·»åŠ  / æ›´æ–°è¡¥å…¨è¯</h3><ul class="lvl-0"><li class="lvl-2"><p>å‘è¡¥å…¨è¯åº“ä¸­æ·»åŠ ä¸€ä¸ªå€™é€‰è¯</p></li><li class="lvl-2"><p>å¯è®¾ç½® æƒé‡ã€payload</p></li><li class="lvl-2"><p>å¯ç”¨äº çƒ­è¯æ’åº</p></li><li class="lvl-2"><p>è¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FT.SUGADD key string score</span><br><span class="line">  [INCR]</span><br><span class="line">  [PAYLOAD payload]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å‚æ•°è¯´æ˜</p></li></ul><table><thead><tr><th>å‚æ•°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td><code>key</code></td><td>Suggestion è¯åº“ Keyï¼Œç´¢å¼•åç§°</td></tr><tr><td><code>string</code></td><td>è¡¥å…¨æ–‡æœ¬</td></tr><tr><td><code>score</code></td><td>æƒé‡ï¼ˆè¶Šå¤§è¶Šé å‰ï¼‰</td></tr><tr><td><code>INCR</code></td><td>é€’å¢ï¼Œç´¯åŠ æƒé‡</td></tr><tr><td><code>PAYLOAD</code></td><td>é™„åŠ å…ƒæ•°æ®</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FT.SUGADD sug:search <span class="string">&quot;iphone&quot;</span> 100</span><br><span class="line">FT.SUGADD sug:search <span class="string">&quot;iphone 15&quot;</span> 200</span><br><span class="line">FT.SUGADD sug:search <span class="string">&quot;ipad&quot;</span> 50 PAYLOAD <span class="string">&quot;category=tablet&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç±»å‹</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">type</span> sug:search</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">trietype0</span><br></pre></td></tr></table></figure><h3 id="2ï¸âƒ£-FT-SUGGET-â€”â€”-è·å–è¡¥å…¨å»ºè®®">2ï¸âƒ£ FT.SUGGET â€”â€” è·å–è¡¥å…¨å»ºè®®</h3><ul class="lvl-0"><li class="lvl-2"><p>æ ¹æ® å‰ç¼€ è¿”å›æœ€ç›¸å…³çš„å€™é€‰è¯</p></li><li class="lvl-2"><p>æ”¯æŒæ¨¡ç³ŠåŒ¹é…</p></li><li class="lvl-2"><p>å¯è¿”å› payload / score</p></li><li class="lvl-2"><p>å¯ç”¨äº æœç´¢æ¡†è¾“å…¥è”æƒ³ã€æ‹¼å†™çº é”™</p></li><li class="lvl-2"><p>è¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FT.SUGGET key prefix</span><br><span class="line">  [FUZZY]</span><br><span class="line">  [WITHSCORES]</span><br><span class="line">  [WITHPAYLOADS]</span><br><span class="line">  [MAX num]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å‚æ•°è¯´æ˜</p></li></ul><table><thead><tr><th>å‚æ•°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td><code>prefix</code></td><td>ç”¨æˆ·è¾“å…¥å‰ç¼€</td></tr><tr><td><code>FUZZY</code></td><td>æ¨¡ç³ŠåŒ¹é…ï¼ˆå…è®¸æ‹¼å†™é”™è¯¯ï¼‰</td></tr><tr><td><code>WITHSCORES</code></td><td>è¿”å›æƒé‡</td></tr><tr><td><code>WITHPAYLOADS</code></td><td>è¿”å› payload</td></tr><tr><td><code>MAX</code></td><td>æœ€å¤§è¿”å›æ•°é‡</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">FT.SUGGET sug:search <span class="string">&quot;ip&quot;</span> MAX 5</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">1) <span class="string">&quot;iphone 15&quot;</span></span><br><span class="line">2) <span class="string">&quot;iphone&quot;</span></span><br><span class="line">3) <span class="string">&quot;ipad&quot;</span></span><br><span class="line"></span><br><span class="line">FT.SUGGET sug:search <span class="string">&quot;iphne&quot;</span> FUZZY</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">1) <span class="string">&quot;iphone 15&quot;</span></span><br><span class="line">2) <span class="string">&quot;iphone&quot;</span></span><br><span class="line"></span><br><span class="line">FT.SUGGET sug:search <span class="string">&quot;ip&quot;</span> WITHSCORES WITHPAYLOADS</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">1) <span class="string">&quot;iphone 15&quot;</span></span><br><span class="line">2) <span class="string">&quot;70.71067810058594&quot;</span></span><br><span class="line">3) (nil)</span><br><span class="line">4) <span class="string">&quot;iphone&quot;</span></span><br><span class="line">5) <span class="string">&quot;44.72135925292969&quot;</span></span><br><span class="line">6) (nil)</span><br><span class="line">7) <span class="string">&quot;ipad&quot;</span></span><br><span class="line">8) <span class="string">&quot;28.86751365661621&quot;</span></span><br><span class="line">9) <span class="string">&quot;category=tablet&quot;</span></span><br></pre></td></tr></table></figure><h3 id="3ï¸âƒ£-FT-SUGDEL-â€”â€”-åˆ é™¤è¡¥å…¨è¯">3ï¸âƒ£ FT.SUGDEL â€”â€” åˆ é™¤è¡¥å…¨è¯</h3><ul class="lvl-0"><li class="lvl-2"><p>ä»è¡¥å…¨è¯åº“ä¸­ç§»é™¤æŒ‡å®šè¯æ¡</p></li><li class="lvl-2"><p>å¯ç”¨äº å•†å“ä¸‹æ¶ã€æ•æ„Ÿè¯ç§»é™¤ã€è¿‡æœŸå…³é”®è¯æ¸…ç†</p></li><li class="lvl-2"><p>è¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FT.SUGDEL key string</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FT.SUGDEL sug:search <span class="string">&quot;iphone&quot;</span></span><br></pre></td></tr></table></figure><h3 id="4ï¸âƒ£-FT-SUGLEN-â€”â€”-æŸ¥çœ‹è¯åº“è§„æ¨¡">4ï¸âƒ£ FT.SUGLEN â€”â€” æŸ¥çœ‹è¯åº“è§„æ¨¡</h3><ul class="lvl-0"><li class="lvl-2"><p>è·å–å½“å‰è¯åº“çš„è¯æ¡æ•°é‡</p></li><li class="lvl-2"><p>è¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FT.SUGLEN key</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FT.SUGLEN sug:search</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br></pre></td></tr></table></figure><h2 id="ç¤ºä¾‹ä»£ç ">ç¤ºä¾‹ä»£ç </h2><ul class="lvl-0"><li class="lvl-2"><p>SpringBoot çš„ RedisTemplate ä¸­æ²¡æœ‰æä¾›å¯¹<code>AutoSuggest</code>çš„å°è£…ï¼Œéœ€è¦è‡ªå·±å°è£…ï¼Œæˆ‘è¿™é‡Œå°è£…äº†ä¸€ä¸ªç®€æ˜“çš„<code>RedisSuggestTool</code></p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.redissug;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¡¥å…¨å»ºè®®å·¥å…·ç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisSuggestTool</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> &lt;T&gt; T <span class="title function_">executeLua</span><span class="params">(String script, List&lt;String&gt; keys, Object... args)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (T) stringRedisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Object.class),</span><br><span class="line">                keys,</span><br><span class="line">                Arrays.stream(args)</span><br><span class="line">                        .map(String::valueOf)</span><br><span class="line">                        .toArray(String[]::<span class="keyword">new</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ·»åŠ  / æ›´æ–°è¡¥å…¨è¯</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * FT.SUGADD key string score</span></span><br><span class="line"><span class="comment">     * [INCR]</span></span><br><span class="line"><span class="comment">     * [PAYLOAD payload]</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key     ç´¢å¼•åç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value   è¡¥å…¨æ–‡æœ¬</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> score   åˆ†æ•°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> incr    æ˜¯å¦é€’å¢ï¼Œé»˜è®¤ä¸ºfalse</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> payload è¡¥å…¨è¯çš„é™„åŠ ä¿¡æ¯ï¼Œé»˜è®¤ä¸ºç©º</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">sugAdd</span><span class="params">(String key,</span></span><br><span class="line"><span class="params">                       String value,</span></span><br><span class="line"><span class="params">                       <span class="type">double</span> score,</span></span><br><span class="line"><span class="params">                       <span class="type">boolean</span> incr,</span></span><br><span class="line"><span class="params">                       String payload)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">lua</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                local args = &#123;&#x27;FT.SUGADD&#x27;, KEYS[1], ARGV[1], ARGV[2]&#125;</span></span><br><span class="line"><span class="string">                if ARGV[3] == &#x27;1&#x27; then table.insert(args, &#x27;INCR&#x27;) end</span></span><br><span class="line"><span class="string">                if ARGV[4] ~= &#x27;&#x27; then table.insert(args, &#x27;PAYLOAD&#x27;); table.insert(args, ARGV[4]) end</span></span><br><span class="line"><span class="string">                return redis.call(unpack(args))</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> executeLua(</span><br><span class="line">                lua,</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                value,</span><br><span class="line">                score,</span><br><span class="line">                incr ? <span class="string">&quot;1&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">                payload == <span class="literal">null</span> ? <span class="string">&quot;&quot;</span> : payload</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">sugAdd</span><span class="params">(String key,</span></span><br><span class="line"><span class="params">                       String value,</span></span><br><span class="line"><span class="params">                       <span class="type">double</span> score)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sugAdd(key, value, score, <span class="literal">false</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŸ¥è¯¢è¡¥å…¨å»ºè®®</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * FT.SUGGET key prefix</span></span><br><span class="line"><span class="comment">     * [FUZZY]</span></span><br><span class="line"><span class="comment">     * [WITHSCORES]</span></span><br><span class="line"><span class="comment">     * [WITHPAYLOADS]</span></span><br><span class="line"><span class="comment">     * [MAX num]</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key          ç´¢å¼•åç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> prefix       å‰ç¼€</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fuzzy        æ˜¯å¦æ¨¡ç³ŠåŒ¹é…ï¼Œé»˜è®¤ä¸ºfalse</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> withScores   æ˜¯å¦è¿”å›åˆ†æ•°ï¼Œé»˜è®¤ä¸ºfalse</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> withPayloads æ˜¯å¦è¿”å›é™„åŠ ä¿¡æ¯ï¼Œé»˜è®¤ä¸ºfalse</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> max           æœ€å¤§è¿”å›æ•°é‡ï¼Œé»˜è®¤ä¸º5</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Suggestion&gt; <span class="title function_">sugGet</span><span class="params">(String key,</span></span><br><span class="line"><span class="params">                                   String prefix,</span></span><br><span class="line"><span class="params">                                   <span class="type">boolean</span> fuzzy,</span></span><br><span class="line"><span class="params">                                   <span class="type">boolean</span> withScores,</span></span><br><span class="line"><span class="params">                                   <span class="type">boolean</span> withPayloads,</span></span><br><span class="line"><span class="params">                                   <span class="type">int</span> max)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">lua</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                local args = &#123;&#x27;FT.SUGGET&#x27;, KEYS[1], ARGV[1]&#125;</span></span><br><span class="line"><span class="string">                if ARGV[2] == &#x27;1&#x27; then table.insert(args, &#x27;FUZZY&#x27;) end</span></span><br><span class="line"><span class="string">                if ARGV[3] == &#x27;1&#x27; then table.insert(args, &#x27;WITHSCORES&#x27;) end</span></span><br><span class="line"><span class="string">                if ARGV[4] == &#x27;1&#x27; then table.insert(args, &#x27;WITHPAYLOADS&#x27;) end</span></span><br><span class="line"><span class="string">                if tonumber(ARGV[5]) &gt; 0 then table.insert(args, &#x27;MAX&#x27;); table.insert(args, ARGV[5]) end</span></span><br><span class="line"><span class="string">                return redis.call(unpack(args))</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        List&lt;Object&gt; raw = executeLua(</span><br><span class="line">                lua,</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                prefix,</span><br><span class="line">                fuzzy ? <span class="string">&quot;1&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">                withScores ? <span class="string">&quot;1&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">                withPayloads ? <span class="string">&quot;1&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">                max</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> parseSuggestionResult(raw, withScores, withPayloads);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»“æœè§£æå™¨</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Suggestion&gt; <span class="title function_">parseSuggestionResult</span><span class="params">(List&lt;Object&gt; raw,</span></span><br><span class="line"><span class="params">                                                   <span class="type">boolean</span> withScores,</span></span><br><span class="line"><span class="params">                                                   <span class="type">boolean</span> withPayloads)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (raw == <span class="literal">null</span> || raw.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;Suggestion&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">step</span> <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">                + (withScores ? <span class="number">1</span> : <span class="number">0</span>)</span><br><span class="line">                + (withPayloads ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; raw.size(); i += step) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> i;</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> String.valueOf(raw.get(idx++));</span><br><span class="line">            <span class="type">Double</span> <span class="variable">score</span> <span class="operator">=</span> withScores ? Double.valueOf(String.valueOf(raw.get(idx++))) : <span class="literal">null</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> withPayloads ? String.valueOf(raw.get(idx++)) : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            list.add(<span class="keyword">new</span> <span class="title class_">Suggestion</span>(value, score, payload));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ é™¤è¡¥å…¨è¯</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * FT.SUGDEL key string</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   ç´¢å¼•åç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value è¡¥å…¨è¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">sugDel</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">lua</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;FT.SUGDEL&#x27;, KEYS[1], ARGV[1])&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> executeLua(</span><br><span class="line">                lua,</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                value</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Long.valueOf(<span class="number">1</span>).equals(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–è¡¥å…¨è¯æ•°é‡</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * FT.SUGLEN key</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key ç´¢å¼•åç§°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">sugLen</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">lua</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;FT.SUGLEN&#x27;, KEYS[1])&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> executeLua(</span><br><span class="line">                lua,</span><br><span class="line">                Collections.singletonList(key)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Suggestion</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String value;</span><br><span class="line">    <span class="keyword">private</span> Double score;</span><br><span class="line">    <span class="keyword">private</span> String payload;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡ä»‹ç» Redis æ‰©å±•æ¨¡å— â€“ RediSearch ä¸­ AutoSuggest æ¨¡å— çš„ä½¿ç”¨æ–¹æ³•&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡åŸºäº&lt;code&gt;redis-7.4.7&lt;/code&gt;ï¼Œ&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æ“ä½œç³»ç»Ÿï¼š&lt;code&gt;Amazon Linux 2023(å†…æ ¸ 6.1)&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Rediså®˜ç½‘ï¼š&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis å‘½ä»¤æ–‡æ¡£ï¼š&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;RediSearch çš„å®‰è£…å‚è§ &lt;a href=&quot;/2025/12/26/redis7-module-RediSearch/&quot; title=&quot;Redis æ‰©å±•æ¨¡å— -- RediSearch çš„å®‰è£…æ–¹æ³•&quot;&gt;Redis æ‰©å±•æ¨¡å— -- RediSearch çš„å®‰è£…æ–¹æ³•&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;ç¤ºä¾‹ä»£ç ï¼š&lt;a href=&quot;https://github.com/hanqunfeng/springbootchapter/tree/master/springboot3-demo/redis-demo/redisson-demo&quot;&gt;GitHub&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>RediSearch å¼€å‘å®æˆ˜</title>
    <link href="https://blog.hanqunfeng.com/2026/01/05/redis7-module-RediSearch-study/"/>
    <id>https://blog.hanqunfeng.com/2026/01/05/redis7-module-RediSearch-study/</id>
    <published>2026-01-05T13:30:05.000Z</published>
    <updated>2026-01-07T03:18:14.861Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2">æœ¬æ–‡ä»‹ç» Redis æ‰©å±•æ¨¡å— â€“ RediSearch çš„ä½¿ç”¨æ–¹æ³•</li><li class="lvl-2">æœ¬æ–‡åŸºäº<code>redis-7.4.7</code>ï¼Œ<code>springboot-3.5.8</code></li><li class="lvl-2">æ“ä½œç³»ç»Ÿï¼š<code>Amazon Linux 2023(å†…æ ¸ 6.1)</code></li><li class="lvl-2">Rediså®˜ç½‘ï¼š<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis å‘½ä»¤æ–‡æ¡£ï¼š<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li><li class="lvl-2">RediSearch çš„å®‰è£…å‚è§ <a href="/2025/12/26/redis7-module-RediSearch/" title="Redis æ‰©å±•æ¨¡å— -- RediSearch çš„å®‰è£…æ–¹æ³•">Redis æ‰©å±•æ¨¡å— -- RediSearch çš„å®‰è£…æ–¹æ³•</a></li><li class="lvl-2">ç¤ºä¾‹ä»£ç ï¼š<a href="https://github.com/hanqunfeng/springbootchapter/tree/master/springboot3-demo/redis-demo/redisson-demo">GitHub</a></li></ul><span id="more"></span><h2 id="RediSearch-å‘½ä»¤">RediSearch å‘½ä»¤</h2><ul class="lvl-0"><li class="lvl-2"><p>ä¸ºäº†å±•ç¤ºå‘½ä»¤çš„ä½¿ç”¨æ–¹æ³•ï¼Œè¿™é‡Œä»¥JSONæ–‡æ¡£è¿›è¡Œç´¢å¼•ï¼Œåˆå§‹åŒ–æ•°æ®å¦‚ä¸‹ï¼š</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">JSON.SET user:10001 $ <span class="string">&#x27;&#123;&quot;name&quot;:&quot;Alice Bob&quot;,&quot;age&quot;:28,&quot;vip&quot;:&quot;yes&quot;,&quot;orders&quot;:[&#123;&quot;amount&quot;:199.99,&quot;status&quot;:&quot;PAID&quot;&#125;,&#123;&quot;amount&quot;:59.9,&quot;status&quot;:&quot;CREATED&quot;&#125;],&quot;comment&quot;: &quot;I have a phone&quot;,&quot;items&quot;:[&quot;SpringCloudæŠ€æœ¯æŒ‡å—&quot;,&quot;Shellè„šæœ¬åŸºç¡€&quot;]&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">JSON.SET user:10002 $ <span class="string">&#x27;&#123;&quot;name&quot;:&quot;Bob Frank&quot;,&quot;age&quot;:35,&quot;vip&quot;:&quot;no&quot;,&quot;orders&quot;:[&#123;&quot;amount&quot;:899.0,&quot;status&quot;:&quot;PAID&quot;&#125;],&quot;comment&quot;: &quot;I have a iphone&quot;,&quot;items&quot;:[&quot;Linuxå¿…çŸ¥å¿…ä¼š&quot;,&quot;Javaå¤šçº¿ç¨‹è¯¦è§£&quot;]&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">JSON.SET user:10003 $ <span class="string">&#x27;&#123;&quot;name&quot;:&quot;Carol&quot;,&quot;age&quot;:22,&quot;vip&quot;:&quot;no&quot;,&quot;orders&quot;:[&#123;&quot;amount&quot;:19.9,&quot;status&quot;:&quot;CANCELLED&quot;&#125;],&quot;comment&quot;: &quot;I have a mobile&quot;,&quot;items&quot;:[&quot;MySQLä»åˆ åº“åˆ°è·‘è·¯&quot;,&quot;Oracleå¼€å‘å®è·µ&quot;]&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">JSON.SET user:10004 $ <span class="string">&#x27;&#123;&quot;name&quot;:&quot;David Bob&quot;,&quot;age&quot;:41,&quot;vip&quot;:&quot;yes&quot;,&quot;orders&quot;:[&#123;&quot;amount&quot;:1200,&quot;status&quot;:&quot;PAID&quot;&#125;,&#123;&quot;amount&quot;:300,&quot;status&quot;:&quot;PAID&quot;&#125;],&quot;comment&quot;: &quot;I have a car&quot;,&quot;items&quot;:[&quot;SpringæŠ€æœ¯æŒ‡å—&quot;,&quot;RocketMQç”±æµ…å…¥æ·±&quot;]&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">JSON.SET user:10005 $ <span class="string">&#x27;&#123;&quot;name&quot;:&quot;Eve&quot;,&quot;age&quot;:30,&quot;vip&quot;:&quot;no&quot;,&quot;orders&quot;:[&#123;&quot;amount&quot;:88.8,&quot;status&quot;:&quot;CREATED&quot;&#125;],&quot;comment&quot;: &quot;I have a pencil&quot;,&quot;items&quot;:[&quot;Kafkaä»é›¶å¼€å§‹&quot;,&quot;Javaç”±æµ…å…¥æ·±&quot;]&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">JSON.SET user:10006 $ <span class="string">&#x27;&#123;&quot;name&quot;:&quot;Frank&quot;,&quot;age&quot;:27,&quot;vip&quot;:&quot;no&quot;,&quot;orders&quot;:[&#123;&quot;amount&quot;:499,&quot;status&quot;:&quot;PAID&quot;&#125;,&#123;&quot;amount&quot;:129,&quot;status&quot;:&quot;CREATED&quot;&#125;],&quot;comment&quot;: &quot;I have a phone&quot;,&quot;items&quot;:[&quot;Rediså¼€å‘å®æˆ˜&quot;,&quot;MongoDBä»å…¥é—¨åˆ°å®æˆ˜&quot;]&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">JSON.SET user:10007 $ <span class="string">&#x27;&#123;&quot;name&quot;:&quot;Grace&quot;,&quot;age&quot;:33,&quot;vip&quot;:&quot;yes&quot;,&quot;orders&quot;:[&#123;&quot;amount&quot;:999.9,&quot;status&quot;:&quot;PAID&quot;&#125;],&quot;comment&quot;: &quot;I have a book&quot;,&quot;items&quot;:[&quot;Androidå¼€å‘æ‰‹å†Œ&quot;,&quot;Gradleä»é›¶å¼€å§‹&quot;]&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">JSON.SET user:10008 $ <span class="string">&#x27;&#123;&quot;name&quot;:&quot;Henry&quot;,&quot;age&quot;:45,&quot;vip&quot;:&quot;no&quot;,&quot;orders&quot;:[&#123;&quot;amount&quot;:59.9,&quot;status&quot;:&quot;CANCELLED&quot;&#125;],&quot;comment&quot;: &quot;I have a macbook&quot;,&quot;items&quot;:[&quot;SpringBootæŠ€æœ¯æŒ‡å—&quot;,&quot;Mavenç”±æµ…å…¥æ·±&quot;]&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">JSON.SET user:10009 $ <span class="string">&#x27;&#123;&quot;name&quot;:&quot;Ivy&quot;,&quot;age&quot;:26,&quot;vip&quot;:&quot;yes&quot;,&quot;orders&quot;:[&#123;&quot;amount&quot;:299,&quot;status&quot;:&quot;PAID&quot;&#125;,&#123;&quot;amount&quot;:199,&quot;status&quot;:&quot;PAID&quot;&#125;],&quot;comment&quot;: &quot;I have a watch&quot;,&quot;items&quot;:[&quot;Springèä¼šè´µé€š&quot;,&quot;JavaæŠ€æœ¯å¼€å‘æŒ‡å—&quot;]&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">JSON.SET user:10010 $ <span class="string">&#x27;&#123;&quot;name&quot;:&quot;Jack&quot;,&quot;age&quot;:38,&quot;vip&quot;:&quot;no&quot;,&quot;orders&quot;:[&#123;&quot;amount&quot;:150,&quot;status&quot;:&quot;CREATED&quot;&#125;],&quot;comment&quot;: &quot;I have a apple&quot;,&quot;items&quot;:[&quot;SpringæŠ€æœ¯æŒ‡å—&quot;,&quot;Javaç”±æµ…å…¥æ·±&quot;]&#125;&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>SpringBootæš‚æ—¶æ²¡æœ‰æ”¯æŒ RediSearch ï¼Œä½ å¯ä»¥ç¼–å†™Luaè„šæœ¬æ¥å®ç°ç›¸åº”çš„åŠŸèƒ½ï¼Œå¦å¤– <a href="https://redisson.pro/docs/data-and-services/services/#redisearch-service">Redisson</a>å·²ç»æä¾›äº†å¯¹ RediSearch çš„æ”¯æŒï¼Œä¸‹é¢ç»“åˆå‘½ä»¤ç»™å‡ºä»£ç ç¤ºä¾‹ã€‚</p></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- å¼•å…¥ Redisson ï¼Œè¿™é‡Œè¦æ³¨æ„ï¼Œç°åœ¨æœ€æ–°ç‰ˆæ˜¯ 4.0.0ï¼Œéœ€è¦ springboot 4.x --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.52.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>é€šç”¨ä»£ç </p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="type">RSearch</span> <span class="variable">rSearch</span> <span class="operator">=</span> redissonClient.getSearch(StringCodec.INSTANCE);</span><br></pre></td></tr></table></figure><h3 id="ä¸€ã€ç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†ç±»">ä¸€ã€ç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†ç±»</h3><table><thead><tr><th>å‘½ä»¤</th><th>ä½œç”¨</th><th>æ ¸å¿ƒå‚æ•°</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td><code>FT.CREATE</code></td><td>åˆ›å»ºç´¢å¼•</td><td>ç´¢å¼•åã€ONã€PREFIXã€SCHEMA</td><td>è§ä¸‹</td></tr><tr><td><code>FT.ALTER</code></td><td>ç»™å·²æœ‰ç´¢å¼•æ–°å¢å­—æ®µ</td><td>ç´¢å¼•åã€SCHEMA ADD</td><td>è§ä¸‹</td></tr><tr><td><code>FT.DROPINDEX</code></td><td>åˆ é™¤ç´¢å¼•</td><td>ç´¢å¼•åã€DD</td><td>è§ä¸‹</td></tr><tr><td><code>FT.INFO</code></td><td>æŸ¥çœ‹ç´¢å¼•ä¿¡æ¯</td><td>ç´¢å¼•å</td><td>è§ä¸‹</td></tr><tr><td><code>FT._LIST</code></td><td>åˆ—å‡ºæ‰€æœ‰ç´¢å¼•</td><td>æ— </td><td>è§ä¸‹</td></tr></tbody></table><h4 id="1ï¸âƒ£-FT-CREATE">1ï¸âƒ£ FT.CREATE</h4><ul class="lvl-0"><li class="lvl-2"><p>FT.CREATE åŸºæœ¬è¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">FT.CREATE index_name</span><br><span class="line">[ON HASH | JSON]</span><br><span class="line">[PREFIX count prefix ...]</span><br><span class="line">[FILTER filter]</span><br><span class="line">[LANGUAGE default_lang]</span><br><span class="line">[LANGUAGE_FIELD lang_attribute]</span><br><span class="line">[SCORE default_score]</span><br><span class="line">[SCORE_FIELD score_attribute]</span><br><span class="line">[PAYLOAD_FIELD payload_attribute]</span><br><span class="line">[MAXTEXTFIELDS]</span><br><span class="line">[TEMPORARY seconds]</span><br><span class="line">[NOOFFSETS] [NOHL] [NOFIELDS] [NOFREQS]</span><br><span class="line">[STOPWORDS count stopword ...]</span><br><span class="line">[SKIPINITIALSCAN]</span><br><span class="line">SCHEMA</span><br><span class="line">  field_name [AS <span class="built_in">alias</span>] TEXT | TAG | NUMERIC | GEO | VECTOR</span><br><span class="line">  [SORTABLE [UNF]]</span><br><span class="line">  [NOINDEX]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>FT.CREATE å‚æ•°è¯´æ˜è¡¨</p></li></ul><table><thead><tr><th>å‚æ•°</th><th>ä½œç”¨è¯´æ˜</th></tr></thead><tbody><tr><td><code>index_name</code></td><td>ç´¢å¼•åç§°</td></tr><tr><td><code>ON HASH | JSON</code></td><td>æŒ‡å®šç´¢å¼•æ•°æ®æ¥æºç±»å‹ï¼Œé»˜è®¤ <code>HASH</code></td></tr><tr><td><code>PREFIX count prefix...</code></td><td>æŒ‡å®šç´¢å¼• Key å‰ç¼€</td></tr><tr><td><code>FILTER filter</code></td><td>å¯¹ç´¢å¼•æ•°æ®è®¾ç½®è¿‡æ»¤è¡¨è¾¾å¼</td></tr><tr><td><code>LANGUAGE</code></td><td>æŒ‡å®šé»˜è®¤åˆ†è¯è¯­è¨€ï¼ˆé»˜è®¤ englishï¼Œä¸­æ–‡æ˜¯ chineseï¼‰</td></tr><tr><td><code>LANGUAGE_FIELD</code></td><td>æŒ‡å®šæ–‡æ¡£ä¸­çš„è¯­è¨€å­—æ®µ</td></tr><tr><td><code>SCORE</code></td><td>è®¾ç½®æ–‡æ¡£é»˜è®¤è¯„åˆ†</td></tr><tr><td><code>SCORE_FIELD</code></td><td>ä»å­—æ®µä¸­è¯»å–è¯„åˆ†</td></tr><tr><td><code>PAYLOAD_FIELD</code></td><td>æŒ‡å®šå­˜å‚¨çš„äºŒè¿›åˆ¶è´Ÿè½½å­—æ®µ</td></tr><tr><td><code>MAXTEXTFIELDS</code></td><td>å…è®¸æ›´å¤š TEXT å­—æ®µï¼ˆæ¶ˆè€—æ›´å¤šå†…å­˜ï¼‰</td></tr><tr><td><code>TEMPORARY seconds</code></td><td>åˆ›å»ºä¸´æ—¶ç´¢å¼•ï¼Œè¶…æ—¶åè‡ªåŠ¨åˆ é™¤</td></tr><tr><td><code>NOOFFSETS</code></td><td>ä¸å­˜å‚¨æ–‡æœ¬åç§»é‡ï¼ˆèŠ‚çœå†…å­˜ï¼‰</td></tr><tr><td><code>NOHL</code></td><td>ç¦ç”¨é«˜äº®</td></tr><tr><td><code>NOFIELDS</code></td><td>ä¸ä¿å­˜å­—æ®µå†…å®¹</td></tr><tr><td><code>NOFREQS</code></td><td>ä¸ä¿å­˜è¯é¢‘ä¿¡æ¯</td></tr><tr><td><code>STOPWORDS count ...</code></td><td>æŒ‡å®šåœç”¨è¯</td></tr><tr><td><code>SKIPINITIALSCAN</code></td><td>åˆ›å»ºç´¢å¼•æ—¶ä¸æ‰«æå·²æœ‰æ•°æ®</td></tr><tr><td><code>SCHEMA</code></td><td>ç´¢å¼•å­—æ®µå®šä¹‰èµ·å§‹</td></tr><tr><td><code>AS alias</code></td><td>å­—æ®µåˆ«å</td></tr><tr><td><code>TEXT</code></td><td>å…¨æ–‡ç´¢å¼•å­—æ®µ</td></tr><tr><td><code>TAG</code></td><td>ç²¾ç¡®åŒ¹é…å­—æ®µ</td></tr><tr><td><code>NUMERIC</code></td><td>æ•°å€¼å­—æ®µ</td></tr><tr><td><code>GEO</code></td><td>åœ°ç†ä½ç½®å­—æ®µ</td></tr><tr><td><code>VECTOR</code></td><td>å‘é‡å­—æ®µ</td></tr><tr><td><code>SORTABLE</code></td><td>å…è®¸æ’åº</td></tr><tr><td><code>UNF</code></td><td>ä¸è§„èŒƒåŒ–æ’åº</td></tr><tr><td><code>NOINDEX</code></td><td>å­—æ®µä¸å‚ä¸ç´¢å¼•</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>FT.CREATE çš„æ ¸å¿ƒè¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FT.CREATE &lt;index&gt;</span><br><span class="line">[ON HASH | JSON]</span><br><span class="line">[PREFIX count prefix ...]</span><br><span class="line">[LANGUAGE default_lang]</span><br><span class="line">SCHEMA</span><br><span class="line">  field_name [AS <span class="built_in">alias</span>] TEXT | TAG | NUMERIC | GEO | VECTOR</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åˆ›å»ºç´¢å¼•ç¤ºä¾‹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">FT.CREATE idx:user</span><br><span class="line">  ON JSON</span><br><span class="line">  PREFIX 1 user:</span><br><span class="line">  LANGUAGE chinese</span><br><span class="line">  SCHEMA</span><br><span class="line">    $.name AS name TEXT</span><br><span class="line">    $.age AS age NUMERIC SORTABLE</span><br><span class="line">    $.orders[*].amount AS amount NUMERIC</span><br><span class="line">    $.orders[*].status AS status TAG</span><br><span class="line">    $.comment AS comment TEXT</span><br><span class="line">    $.items[*] AS items TEXT</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‚æ•°è¯´æ˜</span></span><br><span class="line">  <span class="comment"># idx:userï¼šç´¢å¼•å</span></span><br><span class="line">  <span class="comment"># ON JSONï¼šç´¢å¼• JSON æ–‡æ¡£ï¼ŒRediSearch ä»…æ”¯æŒå¯¹ HASH å’Œ JSON è¿›è¡Œç´¢å¼•</span></span><br><span class="line">  <span class="comment"># PREFIX 1 user: ï¼šç´¢å¼•æŒ‡å®š key å‰ç¼€ï¼Œ1 è¡¨ç¤ºç´¢å¼•ä¸€ä¸ªï¼Œuser: è¡¨ç¤ºç´¢å¼•çš„ key å‰ç¼€ï¼Œå¦‚æœç´¢å¼•ä¸¤ä¸ªï¼šPREFIX 2 user: order:</span></span><br><span class="line">  <span class="comment"># LANGUAGE chineseï¼šæŒ‡å®šé»˜è®¤åˆ†è¯è¯­è¨€ï¼Œé»˜è®¤æ˜¯è‹±æ–‡ englishï¼Œä¸­æ–‡æ˜¯ chineseï¼Œå¦‚æœç´¢å¼•ä¸­æœ‰ä¸­æ–‡ï¼Œåˆ™å¿…é¡»æŒ‡å®š LANGUAGE ä¸º chinese</span></span><br><span class="line">  <span class="comment"># SCHEMAï¼šç´¢å¼•å­—æ®µ</span></span><br><span class="line">  <span class="comment"># $.name AS name TEXTï¼šç´¢å¼•å­—æ®µ $.name(æ³¨æ„ï¼šJSONç±»å‹ä»¥ $. å¼€å¤´ï¼ŒHashç±»å‹å°±ä¸éœ€è¦äº†)ï¼Œå­—æ®µåˆ«åä¸º nameï¼Œå­—æ®µç±»å‹ä¸º TEXT</span></span><br><span class="line">  <span class="comment"># ASï¼šå­—æ®µåˆ«åï¼ˆæŸ¥è¯¢æ—¶ä½¿ç”¨ï¼‰</span></span><br><span class="line">  <span class="comment"># TEXT / NUMERIC / TAGï¼šå­—æ®µç±»å‹ï¼Œè¿™å‡ ä¸ªæ˜¯æœ€å¸¸ç”¨çš„</span></span><br><span class="line">  <span class="comment"># SORTABLEï¼šNUMERICã€TAGã€TEXT æˆ– GEO ç±»å‹çš„å­—æ®µå¯ä»¥å¸¦æœ‰ä¸€ä¸ªå¯é€‰çš„ SORTABLE å‚æ•°ï¼Œè¡¨ç¤ºä¸ºå­—æ®µå»ºç«‹ä¸“é—¨çš„æ’åºæ•°æ®ç»“æ„ï¼ˆç±»ä¼¼åˆ—å¼å­˜å‚¨ï¼‰ï¼Œä»è€Œé¿å…åœ¨æŸ¥è¯¢é˜¶æ®µå¯¹å¤§é‡ç»“æœè¿›è¡Œä¸´æ—¶æ’åºã€‚</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">rSearch.createIndex(</span><br><span class="line">    <span class="string">&quot;idx:user&quot;</span>,</span><br><span class="line">    IndexOptions.defaults()</span><br><span class="line">            .on(IndexType.JSON)</span><br><span class="line">            .prefix(List.of(<span class="string">&quot;user:&quot;</span>))</span><br><span class="line">            .language(<span class="string">&quot;chinese&quot;</span>),</span><br><span class="line">    FieldIndex.text(<span class="string">&quot;$.name&quot;</span>).as(<span class="string">&quot;name&quot;</span>),</span><br><span class="line">    FieldIndex.numeric(<span class="string">&quot;$.age&quot;</span>).as(<span class="string">&quot;age&quot;</span>),</span><br><span class="line">    FieldIndex.numeric(<span class="string">&quot;$.orders[*].amount&quot;</span>).as(<span class="string">&quot;amount&quot;</span>),</span><br><span class="line">    FieldIndex.tag(<span class="string">&quot;$.orders[*].status&quot;</span>).as(<span class="string">&quot;status&quot;</span>),</span><br><span class="line">    FieldIndex.text(<span class="string">&quot;$.comment&quot;</span>).as(<span class="string">&quot;comment&quot;</span>),</span><br><span class="line">    FieldIndex.text(<span class="string">&quot;$.items[*]&quot;</span>).as(<span class="string">&quot;items&quot;</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç´¢å¼•å­—æ®µçš„ç±»å‹</p></li></ul><table><thead><tr><th>å­—æ®µç±»å‹</th><th>ä¸­æ–‡åç§°</th><th>åŠŸèƒ½è¯´æ˜</th><th>å…¸å‹ä½¿ç”¨åœºæ™¯</th><th>å¤‡æ³¨ / é™åˆ¶</th></tr></thead><tbody><tr><td><strong>TEXT</strong></td><td>å…¨æ–‡æ–‡æœ¬å­—æ®µ</td><td>æ”¯æŒå¯¹å­—æ®µå€¼è¿›è¡Œå…¨æ–‡æ£€ç´¢ï¼ˆåˆ†è¯ã€ç›¸å…³åº¦è®¡ç®—ã€æ¨¡ç³ŠåŒ¹é…ç­‰ï¼‰</td><td>æ–‡ç« å†…å®¹ã€ç”¨æˆ·åã€æè¿°ä¿¡æ¯</td><td>æ”¯æŒæƒé‡ï¼ˆWEIGHTï¼‰ã€æ’åºï¼ˆSORTABLEï¼‰ç­‰é€‰é¡¹</td></tr><tr><td><strong>TAG</strong></td><td>æ ‡ç­¾å­—æ®µ / ç²¾ç¡®åŒ¹é…å­—æ®µ</td><td>æ”¯æŒç²¾ç¡®åŒ¹é…æŸ¥è¯¢ï¼Œé€‚ç”¨äºæšä¸¾å€¼æˆ–ç¦»æ•£åˆ†ç±»</td><td>åˆ†ç±»ã€çŠ¶æ€ã€ä¸»é”®ã€ç±»å‹å­—æ®µ</td><td>ä¸åˆ†è¯ï¼›å¯è‡ªå®šä¹‰åˆ†éš”ç¬¦</td></tr><tr><td><strong>NUMERIC</strong></td><td>æ•°å€¼å­—æ®µ</td><td>æ”¯æŒæ•°å€¼èŒƒå›´æŸ¥è¯¢</td><td>å¹´é¾„ã€ä»·æ ¼ã€åˆ†æ•°ã€æ—¶é—´æˆ³</td><td>æ”¯æŒåŒºé—´æŸ¥è¯¢ï¼ˆ<code>[min max]</code>ï¼‰</td></tr><tr><td><strong>GEO</strong></td><td>åœ°ç†ä½ç½®å­—æ®µï¼ˆç‚¹ï¼‰</td><td>æ”¯æŒä»¥â€œç‚¹â€ä¸ºä¸­å¿ƒçš„åŠå¾„èŒƒå›´æŸ¥è¯¢</td><td>é—¨åº—ä½ç½®ã€ç”¨æˆ·ä½ç½®</td><td>å€¼æ ¼å¼å¿…é¡»ä¸º <code>&quot;ç»åº¦,çº¬åº¦&quot;</code></td></tr><tr><td><strong>VECTOR</strong></td><td>å‘é‡å­—æ®µ</td><td>æ”¯æŒå‘é‡ç›¸ä¼¼åº¦æœç´¢ï¼ˆKNN ç­‰ï¼‰</td><td>è¯­ä¹‰æœç´¢ã€æ¨èç³»ç»Ÿã€Embedding å‘é‡</td><td>éœ€è¦ <strong>Query Dialect â‰¥ 2</strong>ï¼ˆRediSearch â‰¥ 2.4ï¼‰</td></tr><tr><td><strong>GEOSHAPE</strong></td><td>åœ°ç†å½¢çŠ¶å­—æ®µï¼ˆå¤šè¾¹å½¢ï¼‰</td><td>æ”¯æŒå¤šè¾¹å½¢ç©ºé—´æŸ¥è¯¢</td><td>è¡Œæ”¿åŒºã€å•†åœˆã€åœ°å›¾åŒºåŸŸ</td><td>ä½¿ç”¨ WKT æ ¼å¼ï¼›ä¸æ”¯æŒ JSON å¤šå€¼å’Œ SORTABLE</td></tr></tbody></table><blockquote><p>GEOSHAPE å­—æ®µè¡¥å……è¯´æ˜</p></blockquote><table><thead><tr><th>é¡¹ç›®</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>æ•°æ®æ ¼å¼</td><td>WKTï¼ˆWell-Known Textï¼‰æ ¼å¼ï¼Œå¦‚ï¼š<code>POLYGON((x1 y1, x2 y2, ...))</code></td></tr><tr><td>åæ ‡ç³»ç»Ÿ</td><td><code>SPHERICAL</code>ï¼ˆçƒé¢åæ ‡ï¼Œç»çº¬åº¦ï¼‰<br><code>FLAT</code>ï¼ˆå¹³é¢åæ ‡ï¼Œç¬›å¡å°” X/Yï¼‰</td></tr><tr><td>é»˜è®¤åæ ‡ç³»ç»Ÿ</td><td><code>SPHERICAL</code></td></tr><tr><td>å½“å‰é™åˆ¶</td><td>âŒ ä¸æ”¯æŒ JSON å¤šå€¼<br>âŒ ä¸æ”¯æŒ <code>SORTABLE</code> é€‰é¡¹</td></tr></tbody></table><blockquote><p>ç´¢å¼•å­—æ®µç±»å‹é€‰å‹å»ºè®®</p></blockquote><table><thead><tr><th>ä½¿ç”¨åœºæ™¯</th><th>æ¨èå­—æ®µç±»å‹</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>å…¨æ–‡æ£€ç´¢</td><td><strong>TEXT</strong></td><td>æ”¯æŒåˆ†è¯ã€ç›¸å…³åº¦è®¡ç®—ã€æ¨¡ç³ŠåŒ¹é…ç­‰å…¨æ–‡æœç´¢èƒ½åŠ›</td></tr><tr><td>ç²¾ç¡®è¿‡æ»¤ / åˆ†ç±»</td><td><strong>TAG</strong></td><td>ç²¾ç¡®åŒ¹é…ï¼Œä¸åˆ†è¯ï¼Œé€‚åˆæšä¸¾å€¼ã€çŠ¶æ€ã€ç±»å‹ç­‰å­—æ®µ</td></tr><tr><td>åŒºé—´ç­›é€‰ / æ’åº</td><td><strong>NUMERIC</strong></td><td>æ”¯æŒæ•°å€¼åŒºé—´æŸ¥è¯¢ä¸æ’åºï¼Œé€‚åˆä»·æ ¼ã€æ—¶é—´ã€åˆ†æ•°ç­‰</td></tr><tr><td>é™„è¿‘çš„äºº / é—¨åº—</td><td><strong>GEO</strong></td><td>åŸºäºç»çº¬åº¦ç‚¹è¿›è¡ŒåŠå¾„èŒƒå›´æŸ¥è¯¢</td></tr><tr><td>è¯­ä¹‰æœç´¢ / å‘é‡å¬å›</td><td><strong>VECTOR</strong></td><td>åŸºäºå‘é‡ç›¸ä¼¼åº¦ï¼ˆKNNï¼‰çš„è¯­ä¹‰æœç´¢ï¼Œéœ€è¦ Dialect â‰¥ 2</td></tr><tr><td>å¤æ‚åœ°ç†åŒºåŸŸåˆ¤æ–­</td><td><strong>GEOSHAPE</strong></td><td>æ”¯æŒå¤šè¾¹å½¢ï¼ˆPolygonï¼‰åŒºåŸŸæŸ¥è¯¢ï¼Œé€‚åˆè¡Œæ”¿åŒºã€å•†åœˆç­‰</td></tr></tbody></table><blockquote><p>å“ªäº›å­—æ®µé€‚åˆä½¿ç”¨ SORTABLE</p></blockquote><table><thead><tr><th>å­—æ®µç±»å‹</th><th>æ˜¯å¦é€‚åˆ SORTABLE</th><th>åŸå› </th></tr></thead><tbody><tr><td>NUMERIC</td><td>âœ… å¼ºçƒˆæ¨è</td><td>æ•°å€¼æ’åºæœ€å¸¸è§ï¼Œå¦‚ä»·æ ¼ã€æ—¶é—´ã€è¯„åˆ†</td></tr><tr><td>TAG</td><td>âš ï¸ è§†æƒ…å†µ</td><td>ä¸€èˆ¬ç”¨äºè¿‡æ»¤ï¼Œæ’åºæ„ä¹‰ä¸å¤§</td></tr><tr><td>TEXT</td><td>âš ï¸ è°¨æ…</td><td>æ–‡æœ¬å¯èƒ½å¾ˆå¤§ï¼Œå†…å­˜å¼€é”€é«˜</td></tr><tr><td>GEO</td><td>âš ï¸ ç‰¹æ®Šåœºæ™¯</td><td>é€šå¸¸æŒ‰è·ç¦»æ’åºï¼Œæ›´å¤šä¾èµ– <code>GEOFILTER</code></td></tr></tbody></table><div class="tips"><p><em><strong>å°è´´å£«ï¼šå¦‚ä½•åœ¨redisç»ˆç«¯è¾“å…¥å¤šè¡Œçš„å‘½ä»¤ï¼Ÿ</strong></em></p><ul class="lvl-1"><li class="lvl-2">å…ˆè¯´ç»“è®ºï¼šredisç»ˆç«¯ ä¸æ”¯æŒå¤šè¡Œè¾“å…¥ï¼Œä½†å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼è¾“å…¥å¤šè¡Œå‘½ä»¤ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">redis-cli &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">HSET user:1 \</span></span><br><span class="line"><span class="string">name Tom \</span></span><br><span class="line"><span class="string">age 18 \</span></span><br><span class="line"><span class="string">city Beijing</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><ul class="lvl-1"><li class="lvl-2">è¿™ç§æ–¹æ³•æ˜¯åˆ©ç”¨äº† Bash çš„èƒ½åŠ›ï¼Œå³ <code>&lt;&lt;EOF</code> åé¢çš„å†…å®¹ä¼šä½œä¸ºæ ‡å‡†è¾“å…¥ï¼Œç›´åˆ° <code>EOF</code> ä¸ºæ­¢ï¼Œå¹¶é€šè¿‡ <code>\</code> ç¬¦æ¢è¡Œã€‚</li><li class="lvl-2">å¦‚æœåœ¨VSCodeä¸­ï¼Œå¯ä»¥é€‰ä¸­è¦åˆå¹¶çš„å¤šè¡Œå†…å®¹ï¼Œç„¶åé€šè¿‡ <code>Ctrl + Shift + J</code> å¿«æ·é”®å°†å¤šè¡Œåˆå¹¶åˆ°ä¸€è¡Œã€‚</li></ul></div><h4 id="2ï¸âƒ£-FT-ALTER">2ï¸âƒ£ FT.ALTER</h4><blockquote><p>âš ï¸ åªèƒ½ æ–°å¢å­—æ®µï¼Œä¸èƒ½ä¿®æ”¹æˆ–åˆ é™¤å·²æœ‰å­—æ®µ</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FT.ALTER idx:user SCHEMA ADD $.vip AS vip TAG</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rSearch.alter(</span><br><span class="line">        <span class="string">&quot;idx:user&quot;</span>,</span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        FieldIndex.tag(<span class="string">&quot;$.vip&quot;</span>).as(<span class="string">&quot;vip&quot;</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h4 id="3ï¸âƒ£-FT-DROPINDEX">3ï¸âƒ£ FT.DROPINDEX</h4><blockquote><p>âš ï¸ åˆ é™¤ç´¢å¼•</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FT.DROPINDEX idx:user</span><br><span class="line"><span class="comment"># âš ï¸ DDï¼šåˆ é™¤ç´¢å¼•çš„åŒæ—¶åˆ é™¤è¢«ç´¢å¼•æ•°æ®ï¼Œè°¨æ…ä½¿ç”¨</span></span><br><span class="line">FT.DROPINDEX idx:user DD</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rSearch.dropIndex(<span class="string">&quot;idx:user&quot;</span>);</span><br><span class="line">rSearch.dropIndexAndDocuments(<span class="string">&quot;idx:user&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="4ï¸âƒ£-FT-INFO">4ï¸âƒ£ <a href="http://FT.INFO">FT.INFO</a></h4><blockquote><p>æŸ¥çœ‹ç´¢å¼•ä¿¡æ¯</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FT.INFO idx:user</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">IndexInfo</span> <span class="variable">info</span> <span class="operator">=</span> rSearch.info(<span class="string">&quot;idx:user&quot;</span>);</span><br></pre></td></tr></table></figure><blockquote><p>é‡ç‚¹å…³æ³¨å­—æ®µ</p></blockquote><table><thead><tr><th>å­—æ®µ</th><th>å«ä¹‰</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td><code>num_docs</code></td><td><strong>å½“å‰è¢«ç´¢å¼•ã€å¯è¢«æœç´¢çš„æ–‡æ¡£æ•°é‡</strong></td><td>user:10001 ~ user:10010ï¼Œ10æ¡æ–‡æ¡£</td></tr><tr><td><code>num_terms</code></td><td><strong>è¯å…¸ä¸­å”¯ä¸€è¯é¡¹ term çš„æ•°é‡</strong><br><strong>ä¸»è¦æ¥æºäº TEXTï¼ˆnameï¼‰ å’Œ TAGï¼ˆvip, statusï¼‰ å­—æ®µå»é‡ä¹‹åçš„æ•°é‡</strong></td><td>name: alice, bob, carol, â€¦<br>vip: yes, no<br>status: PAID, CREATED, CANCELLED<br></td></tr><tr><td><code>num_records</code></td><td><strong>å€’æ’ç´¢å¼•ä¸­çš„è®°å½•æ¡ç›®æ€»æ•°</strong><br><strong>æ‰€æœ‰ term åœ¨æ‰€æœ‰æ–‡æ¡£ä¸­çš„å‡ºç°æ¬¡æ•°ä¹‹å’Œ</strong></td><td>JSON æ•°ç»„å­—æ®µ orders[],æ¯ä¸ª order éƒ½ä¼šç”Ÿæˆç‹¬ç«‹çš„ç´¢å¼• entry<br>å¤šå€¼å­—æ®µ Ã— å¤šæ–‡æ¡£ = record çˆ†ç‚¸å¼å¢é•¿<br><br>num_records çœŸæ­£å½±å“ï¼šå†…å­˜ã€æŸ¥è¯¢é€Ÿåº¦ã€èšåˆæˆæœ¬</td></tr></tbody></table><h4 id="5ï¸âƒ£-FT-LIST">5ï¸âƒ£ FT._LIST</h4><blockquote><p>åˆ—å‡ºæ‰€æœ‰ç´¢å¼•</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FT._LIST</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; indexes = rSearch.getIndexes();</span><br></pre></td></tr></table></figure><h3 id="äºŒã€æŸ¥è¯¢ç±»ï¼ˆæ ¸å¿ƒï¼‰">äºŒã€æŸ¥è¯¢ç±»ï¼ˆæ ¸å¿ƒï¼‰</h3><table><thead><tr><th>å‘½ä»¤</th><th>ä½œç”¨</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td><code>FT.SEARCH</code></td><td>æ ‡å‡†æœç´¢</td><td>90% åœºæ™¯</td></tr><tr><td><code>FT.AGGREGATE</code></td><td>åˆ†ç»„ / ç»Ÿè®¡ / èšåˆ</td><td>æŠ¥è¡¨ã€åˆ†æ</td></tr><tr><td><code>FT.HYBRID</code></td><td>æ–‡æœ¬ + å‘é‡æ··åˆ</td><td>å‘é‡æœç´¢</td></tr><tr><td><code>FT.EXPLAIN</code></td><td>æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’</td><td>è°ƒä¼˜</td></tr><tr><td><code>FT.EXPLAINCLI</code></td><td>CLI å¯è¯»æ‰§è¡Œè®¡åˆ’</td><td>è°ƒè¯•</td></tr><tr><td><code>FT.PROFILE</code></td><td>æ€§èƒ½åˆ†æ</td><td>æ…¢æŸ¥è¯¢</td></tr></tbody></table><h4 id="1ï¸âƒ£-FT-SEARCH">1ï¸âƒ£ FT.SEARCH</h4><ul class="lvl-0"><li class="lvl-2"><p>FT.SEARCH åŸºæœ¬è¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">FT.SEARCH index query</span><br><span class="line">[NOCOENTENT] [VERBATIM] [NOSTOPWORDS]</span><br><span class="line">[WITHSCORES] [WITHPAYLOADS] [WITHSORTKEYS]</span><br><span class="line">[FILTER numeric_field min max ...]</span><br><span class="line">[GEOFILTER geo_field lon lat radius m|km|mi|ft]</span><br><span class="line">[INKEYS count key ...]</span><br><span class="line">[INFIELDS count field ...]</span><br><span class="line">[RETURN count identifier [AS property] ...]</span><br><span class="line">[SUMMARIZE FIELDS count field ... FRAGS num LEN fragsize SEPARATOR sep]</span><br><span class="line">[HIGHLIGHT FIELDS count field ... TAGS open close]</span><br><span class="line">[SLOP slop] [TIMEOUT <span class="built_in">timeout</span>] [INORDER]</span><br><span class="line">[LANGUAGE language]</span><br><span class="line">[EXPANDER expander]</span><br><span class="line">[SCORER scorer]</span><br><span class="line">[EXPLAINSCORE]</span><br><span class="line">[PAYLOAD payload]</span><br><span class="line">[SORTBY sortby ASC|DESC]</span><br><span class="line">[LIMIT offset num]</span><br><span class="line">[PARAMS nargs name value ...]</span><br><span class="line">[DIALECT dialect]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>FT.SEARCH å‚æ•°è¯´æ˜è¡¨</p></li></ul><table><thead><tr><th>å‚æ•°</th><th>ä½œç”¨è¯´æ˜</th></tr></thead><tbody><tr><td><code>index</code></td><td>ç´¢å¼•åç§°</td></tr><tr><td><code>query</code></td><td>æŸ¥è¯¢æ¡ä»¶ï¼ˆç±»ä¼¼ SQL WHEREï¼‰</td></tr><tr><td><code>NOCONTENT</code></td><td>ä»…è¿”å›æ–‡æ¡£ IDï¼Œä¸è¿”å›å†…å®¹</td></tr><tr><td><code>VERBATIM</code></td><td>ç¦ç”¨æŸ¥è¯¢ä¼˜åŒ–ï¼Œå®Œå…¨æŒ‰åŸæŸ¥è¯¢æ‰§è¡Œ</td></tr><tr><td><code>NOSTOPWORDS</code></td><td>æŸ¥è¯¢æ—¶ä¸å¿½ç•¥åœç”¨è¯</td></tr><tr><td><code>WITHSCORES</code></td><td>è¿”å›åŒ¹é…æ–‡æ¡£çš„ç›¸å…³æ€§è¯„åˆ†</td></tr><tr><td><code>WITHPAYLOADS</code></td><td>è¿”å›æ–‡æ¡£çš„ payload æ•°æ®</td></tr><tr><td><code>WITHSORTKEYS</code></td><td>è¿”å›æ’åºä½¿ç”¨çš„ key</td></tr><tr><td><code>FILTER</code></td><td>æ•°å€¼å­—æ®µè¿‡æ»¤ï¼ˆèŒƒå›´æŸ¥è¯¢ï¼‰</td></tr><tr><td><code>GEOFILTER</code></td><td>åœ°ç†ä½ç½®èŒƒå›´æŸ¥è¯¢</td></tr><tr><td><code>INKEYS</code></td><td>ä»…åœ¨æŒ‡å®šçš„ key é›†åˆä¸­æœç´¢</td></tr><tr><td><code>INFIELDS</code></td><td>ä»…åœ¨æŒ‡å®šå­—æ®µä¸­æœç´¢</td></tr><tr><td><code>RETURN</code></td><td>æŒ‡å®šè¿”å›çš„å­—æ®µ</td></tr><tr><td><code>SUMMARIZE</code></td><td>è¿”å›å­—æ®µå†…å®¹æ‘˜è¦</td></tr><tr><td><code>HIGHLIGHT</code></td><td>é«˜äº®åŒ¹é…çš„å…³é”®è¯</td></tr><tr><td><code>SLOP</code></td><td>è®¾ç½®çŸ­è¯­æŸ¥è¯¢ä¸­å…è®¸çš„è¯è·</td></tr><tr><td><code>TIMEOUT</code></td><td>è®¾ç½®æŸ¥è¯¢è¶…æ—¶æ—¶é—´</td></tr><tr><td><code>INORDER</code></td><td>çŸ­è¯­å¿…é¡»æŒ‰é¡ºåºåŒ¹é…</td></tr><tr><td><code>LANGUAGE</code></td><td>æŒ‡å®šæŸ¥è¯¢è¯­è¨€</td></tr><tr><td><code>EXPANDER</code></td><td>ä½¿ç”¨è‡ªå®šä¹‰æŸ¥è¯¢æ‰©å±•å™¨</td></tr><tr><td><code>SCORER</code></td><td>ä½¿ç”¨è‡ªå®šä¹‰è¯„åˆ†å‡½æ•°</td></tr><tr><td><code>EXPLAINSCORE</code></td><td>è¿”å›è¯„åˆ†è®¡ç®—è¯¦æƒ…</td></tr><tr><td><code>PAYLOAD</code></td><td>ç»™è¯„åˆ†å‡½æ•°ä¼ å…¥è‡ªå®šä¹‰å‚æ•°</td></tr><tr><td><code>SORTBY</code></td><td>æŒ‰æŒ‡å®šå­—æ®µæ’åº</td></tr><tr><td><code>ASC / DESC</code></td><td>æ’åºæ–¹å‘</td></tr><tr><td><code>LIMIT</code></td><td>åˆ†é¡µæ§åˆ¶</td></tr><tr><td><code>PARAMS</code></td><td>å‚æ•°åŒ–æŸ¥è¯¢</td></tr><tr><td><code>DIALECT</code></td><td>æŒ‡å®šæŸ¥è¯¢è¯­æ³•ç‰ˆæœ¬</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>FT.SEARCH æ ¸å¿ƒè¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FT.SEARCH index</span><br><span class="line">query</span><br><span class="line">[RETURN count identifier [AS property] ...]</span><br><span class="line">[SORTBY sortby ASC|DESC]</span><br><span class="line">[LIMIT offset num]</span><br></pre></td></tr></table></figure><blockquote><p>æ ‡å‡†æœç´¢</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">FT.SEARCH idx:user</span><br><span class="line">  <span class="string">&#x27;@status:&#123;PAID&#125; @amount:[50 +inf]&#x27;</span></span><br><span class="line">  RETURN 3 name status amount</span><br><span class="line">  SORTBY amount DESC</span><br><span class="line">  LIMIT 0 10</span><br><span class="line"><span class="comment">## å‚æ•°è¯´æ˜</span></span><br><span class="line">  <span class="comment"># æŸ¥è¯¢æ¡ä»¶ï¼š&#x27;@status:&#123;PAID&#125; @amount:[50 +inf]&#x27;</span></span><br><span class="line">  <span class="comment"># æŸ¥è¯¢æ¡ä»¶è¯­æ³•ï¼š</span></span><br><span class="line">  <span class="comment"># &#x27;xxx&#x27;: å…¨æ–‡æ£€ç´¢åŒ…å« xxx çš„æ•°æ®ï¼Œä¼šä» TEXT å­—æ®µä¸­åŒ¹é…</span></span><br><span class="line">  <span class="comment"># &#x27;@field:value&#x27;: åŒ¹é…å­—æ®µ field çš„å€¼æ˜¯ valueï¼Œè¦æ±‚ field çš„ç±»å‹ä¸º TEXTï¼Œå…¨æ–‡æ£€ç´¢</span></span><br><span class="line">  <span class="comment"># &#x27;@field:&#123;xxx&#125;&#x27;:ç²¾ç¡®åŒ¹é…ï¼Œ&#123;xxx*&#125;:åŒ¹é…å‰ç¼€ï¼Œ&#123;xxx|yyy&#125;:åŒ¹é…ä»»æ„ä¸€ä¸ªï¼Œè¦æ±‚ field çš„ç±»å‹ä¸º TAG</span></span><br><span class="line">  <span class="comment"># &#x27;@field:[min max]&#x27;: èŒƒå›´åŒ¹é…ï¼Œè¿™é‡Œ +inf è¡¨ç¤ºæ­£æ— ç©·å¤§ï¼Œè¦æ±‚ field çš„ç±»å‹ä¸º NUMERIC</span></span><br><span class="line">  <span class="comment"># å¤šä¸ªæ¡ä»¶ç©ºæ ¼åˆ†éš”</span></span><br><span class="line">  <span class="comment"># æ¨¡ç³ŠåŒ¹é…ï¼š* è¡¨ç¤ºä»»æ„å­—ç¬¦ï¼Œå³åŒ¹é…æ‰€æœ‰</span></span><br><span class="line"><span class="comment"># RETURN 3 name status amount è¿”å›å­—æ®µï¼Œ3:è¡¨ç¤ºè¿”å› 3 ä¸ªå­—æ®µ</span></span><br><span class="line"><span class="comment"># LIMIT 0 10 åˆ†é¡µï¼Œ0:è¡¨ç¤ºä»ç¬¬ 0 æ¡å¼€å§‹ï¼Œ10:è¡¨ç¤ºè¿”å› 10 æ¡æ•°æ®</span></span><br><span class="line"><span class="comment"># SORTBY amount DESC æ’åºï¼Œamount:è¡¨ç¤ºæ’åºå­—æ®µï¼ŒDESC:è¡¨ç¤ºé™åº</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SearchResult</span> <span class="variable">result</span> <span class="operator">=</span> rSearch.search(</span><br><span class="line">        <span class="string">&quot;idx:user&quot;</span>,</span><br><span class="line">        <span class="string">&quot;@status:&#123;PAID&#125; @amount:[50 +inf]&quot;</span>,</span><br><span class="line">        QueryOptions.defaults()</span><br><span class="line">        .returnAttributes(<span class="keyword">new</span> <span class="title class_">ReturnAttribute</span>(<span class="string">&quot;name&quot;</span>), <span class="keyword">new</span> <span class="title class_">ReturnAttribute</span>(<span class="string">&quot;status&quot;</span>),<span class="keyword">new</span> <span class="title class_">ReturnAttribute</span>(<span class="string">&quot;amount&quot;</span>))</span><br><span class="line">                .sortBy(<span class="string">&quot;amount&quot;</span>)</span><br><span class="line">                .sortOrder(SortOrder.DESC)</span><br><span class="line">                .limit(<span class="number">0</span>, <span class="number">10</span>));</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> result.getTotal();</span><br><span class="line">System.out.println(<span class="string">&quot;total = &quot;</span> + total);</span><br><span class="line">List&lt;Document&gt; docs = result.getDocuments();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (Document doc: docs) &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> doc.getId();</span><br><span class="line">    Map&lt;String, Object&gt; attrs = doc.getAttributes();</span><br><span class="line">    System.out.println(<span class="string">&quot;id = &quot;</span> + id + <span class="string">&quot; attrs = &quot;</span> + attrs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…¨æ–‡æ£€ç´¢ï¼Œä» æ‰€æœ‰ TEXT å­—æ®µä¸­åŒ¹é…ï¼Œä¸åŒºåˆ†å¤§å°å†™ï¼Œå³ phone/Phone/PHONE éƒ½åŒ¹é…</span></span><br><span class="line">FT.SEARCH idx:user <span class="string">&#x27;phone&#x27;</span></span><br><span class="line"><span class="comment">## ç¤ºä¾‹ç»“æœ</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 2</span><br><span class="line">2) <span class="string">&quot;user:10006&quot;</span></span><br><span class="line">3) 1) <span class="string">&quot;$&quot;</span></span><br><span class="line">   2) <span class="string">&quot;&#123;\&quot;name\&quot;:\&quot;Frank\&quot;,\&quot;age\&quot;:27,\&quot;vip\&quot;:\&quot;no\&quot;,\&quot;orders\&quot;:[&#123;\&quot;amount\&quot;:499,\&quot;status\&quot;:\&quot;PAID\&quot;&#125;,&#123;\&quot;amount\&quot;:129,\&quot;status\&quot;:\&quot;CREATED\&quot;&#125;],\&quot;comment\&quot;:\&quot;I have a phone\&quot;,\&quot;items\&quot;:[\&quot;Redis\xe5\xbc\x80\xe5\x8f\x91\xe5\xae\x9e\xe6\x88\x98\&quot;,\&quot;MongoDB\xe4\xbb\x8e\xe5\x85\xa5\xe9\x97\xa8\xe5\x88\xb0\xe5\xae\x9e\xe6\x88\x98\&quot;]&#125;&quot;</span></span><br><span class="line">4) <span class="string">&quot;user:10001&quot;</span></span><br><span class="line">5) 1) <span class="string">&quot;$&quot;</span></span><br><span class="line">   2) <span class="string">&quot;&#123;\&quot;name\&quot;:\&quot;Alice Bob\&quot;,\&quot;age\&quot;:28,\&quot;vip\&quot;:\&quot;yes\&quot;,\&quot;orders\&quot;:[&#123;\&quot;amount\&quot;:199.99,\&quot;status\&quot;:\&quot;PAID\&quot;&#125;,&#123;\&quot;amount\&quot;:59.9,\&quot;status\&quot;:\&quot;CREATED\&quot;&#125;],\&quot;comment\&quot;:\&quot;I have a phone\&quot;,\&quot;items\&quot;:[\&quot;SpringCloud\xe6\x8a\x80\xe6\x9c\xaf\xe6\x8c\x87\xe5\x8d\x97\&quot;,\&quot;Shell\xe8\x84\x9a\xe6\x9c\xac\xe5\x9f\xba\xe7\xa1\x80\&quot;]&#125;&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SearchResult</span> <span class="variable">result</span> <span class="operator">=</span> rSearch.search(</span><br><span class="line">        <span class="string">&quot;idx:user&quot;</span>,</span><br><span class="line">        <span class="string">&quot;phone&quot;</span>,</span><br><span class="line">        QueryOptions.defaults()</span><br><span class="line">);</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸­æ–‡æ£€ç´¢</span></span><br><span class="line">FT.SEARCH idx:user <span class="string">&#x27;å¼€å§‹&#x27;</span></span><br><span class="line"><span class="comment">## ç¤ºä¾‹ç»“æœ</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 2</span><br><span class="line">2) <span class="string">&quot;user:10005&quot;</span></span><br><span class="line">3) 1) <span class="string">&quot;$&quot;</span></span><br><span class="line">   2) <span class="string">&quot;&#123;\&quot;name\&quot;:\&quot;Eve\&quot;,\&quot;age\&quot;:30,\&quot;vip\&quot;:\&quot;no\&quot;,\&quot;orders\&quot;:[&#123;\&quot;amount\&quot;:88.8,\&quot;status\&quot;:\&quot;CREATED\&quot;&#125;],\&quot;comment\&quot;:\&quot;I have a pencil\&quot;,\&quot;items\&quot;:[\&quot;Kafka\xe4\xbb\x8e\xe9\x9b\xb6\xe5\xbc\x80\xe5\xa7\x8b\&quot;,\&quot;Java\xe7\x94\xb1\xe6\xb5\x85\xe5\x85\xa5\xe6\xb7\xb1\&quot;]&#125;&quot;</span></span><br><span class="line">4) <span class="string">&quot;user:10007&quot;</span></span><br><span class="line">5) 1) <span class="string">&quot;$&quot;</span></span><br><span class="line">   2) <span class="string">&quot;&#123;\&quot;name\&quot;:\&quot;Grace\&quot;,\&quot;age\&quot;:33,\&quot;vip\&quot;:\&quot;yes\&quot;,\&quot;orders\&quot;:[&#123;\&quot;amount\&quot;:999.9,\&quot;status\&quot;:\&quot;PAID\&quot;&#125;],\&quot;comment\&quot;:\&quot;I have a book\&quot;,\&quot;items\&quot;:[\&quot;Android\xe5\xbc\x80\xe5\x8f\x91\xe6\x89\x8b\xe5\x86\x8c\&quot;,\&quot;Gradle\xe4\xbb\x8e\xe9\x9b\xb6\xe5\xbc\x80\xe5\xa7\x8b\&quot;]&#125;&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SearchResult</span> <span class="variable">result</span> <span class="operator">=</span> rSearch.search(</span><br><span class="line">        <span class="string">&quot;idx:user&quot;</span>,</span><br><span class="line">        <span class="string">&quot;å¼€å§‹&quot;</span>,</span><br><span class="line">        QueryOptions.defaults()</span><br><span class="line">);</span><br></pre></td></tr></table></figure><div class="tips"><p><em><strong>å°è´´å£«</strong></em></p><ul class="lvl-1"><li class="lvl-2">çœ‹åˆ°ä¸­æ–‡è¾“å‡ºæ˜¯ä¹±ç ï¼Œå¯ä»¥åœ¨ç™»å½•å®¢æˆ·ç«¯æ—¶åŠ ä¸Š --raw</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --user admin -a 123456 --raw</span><br><span class="line">127.0.0.1:6379&gt; FT.SEARCH idx:user <span class="string">&#x27;å¼€å§‹&#x27;</span></span><br><span class="line">2</span><br><span class="line">user:10005</span><br><span class="line">$</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;Eve&quot;</span>,<span class="string">&quot;age&quot;</span>:30,<span class="string">&quot;vip&quot;</span>:<span class="string">&quot;no&quot;</span>,<span class="string">&quot;orders&quot;</span>:[&#123;<span class="string">&quot;amount&quot;</span>:88.8,<span class="string">&quot;status&quot;</span>:<span class="string">&quot;CREATED&quot;</span>&#125;],<span class="string">&quot;comment&quot;</span>:<span class="string">&quot;I have a pencil&quot;</span>,<span class="string">&quot;items&quot;</span>:[<span class="string">&quot;Kafkaä»é›¶å¼€å§‹&quot;</span>,<span class="string">&quot;Javaç”±æµ…å…¥æ·±&quot;</span>]&#125;</span><br><span class="line">user:10007</span><br><span class="line">$</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;Grace&quot;</span>,<span class="string">&quot;age&quot;</span>:33,<span class="string">&quot;vip&quot;</span>:<span class="string">&quot;yes&quot;</span>,<span class="string">&quot;orders&quot;</span>:[&#123;<span class="string">&quot;amount&quot;</span>:999.9,<span class="string">&quot;status&quot;</span>:<span class="string">&quot;PAID&quot;</span>&#125;],<span class="string">&quot;comment&quot;</span>:<span class="string">&quot;I have a book&quot;</span>,<span class="string">&quot;items&quot;</span>:[<span class="string">&quot;Androidå¼€å‘æ‰‹å†Œ&quot;</span>,<span class="string">&quot;Gradleä»é›¶å¼€å§‹&quot;</span>]&#125;</span><br></pre></td></tr></table></figure></div><h5 id="SQL-WHERE-ä¸-RediSearch-æŸ¥è¯¢è¯­æ³•å¯¹ç…§è¡¨">SQL WHERE ä¸ RediSearch æŸ¥è¯¢è¯­æ³•å¯¹ç…§è¡¨</h5><ul class="lvl-0"><li class="lvl-2"><p><code>x/y/name</code> â†’ <code>TEXT/TAG(è¦åŠ ä¸Š&#123;&#125;)</code> å­—æ®µï¼Œ<code>num</code>â†’<code>NUMERIC</code> å­—æ®µï¼ŒæŸ¥è¯¢è¯­æ³•ç”¨äº <code>FT.SEARCH</code>/<code>FT.AGGREGATE</code> çš„æŸ¥è¯¢å­—ç¬¦ä¸²éƒ¨åˆ†</p></li></ul><table><thead><tr><th>ID</th><th>SQL æ¡ä»¶</th><th>RediSearch å¯¹ç­‰å†™æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>1</td><td><code>WHERE x = 'book' AND y = 'phone'</code></td><td><code>@x:book @y:phone</code></td><td>AND ä¸ºé»˜è®¤å…³ç³»ï¼ˆç©ºæ ¼ï¼‰</td></tr><tr><td>2</td><td><code>WHERE x = 'book' AND y != 'phone'</code></td><td><code>@x:book -@y:phone</code></td><td><code>-</code> è¡¨ç¤º NOT</td></tr><tr><td>3</td><td><code>WHERE x = 'book' OR y = 'phone'</code></td><td><code>(@x:book) | (@y:phone)</code></td><td>OR å¿…é¡»æ˜¾å¼å†™ <code>|</code></td></tr><tr><td>4</td><td><code>WHERE x IN ('book','phone','hello world')</code></td><td><code>@x:(book|phone|&quot;hello world&quot;)</code></td><td>å¤šå€¼ ORï¼ŒçŸ­è¯­éœ€åŠ å¼•å·</td></tr><tr><td>5</td><td><code>WHERE y='book' AND x NOT IN ('book','phone')</code></td><td><code>@y:book -(@x:book|@x:phone)</code></td><td>NOT IN = NOT + OR</td></tr><tr><td>6</td><td><code>WHERE x NOT IN ('book','phone')</code></td><td><code>-@x:(book|phone)</code></td><td>æ•´ä½“å¦å®š</td></tr><tr><td>7</td><td><code>WHERE num BETWEEN 10 AND 20</code></td><td><code>@num:[10 20]</code></td><td>æ•°å€¼åŒºé—´ï¼ˆé—­åŒºé—´ï¼‰</td></tr><tr><td>8</td><td><code>WHERE num &gt;= 10</code></td><td><code>@num:[10 +inf]</code></td><td><code>+inf</code> è¡¨ç¤ºæ­£æ— ç©·</td></tr><tr><td>9</td><td><code>WHERE num &gt; 10</code></td><td><code>@num:[(10 +inf]</code></td><td><code>(</code> è¡¨ç¤ºä¸åŒ…å«</td></tr><tr><td>10</td><td><code>WHERE num &lt; 10</code></td><td><code>@num:[-inf (10]</code></td><td>å°äºï¼ˆä¸å« 10ï¼‰</td></tr><tr><td>11</td><td><code>WHERE num &lt;= 10</code></td><td><code>@num:[-inf 10]</code></td><td>å°äºç­‰äº</td></tr><tr><td>12</td><td><code>WHERE num &lt; 10 OR num &gt; 20</code></td><td><code>@num:[-inf (10] | @num:[(20 +inf]</code></td><td>æ•°å€¼ OR</td></tr><tr><td>13</td><td><code>WHERE name LIKE 'Li%'</code></td><td><code>@name:Li*</code></td><td>å‰ç¼€åŒ¹é…</td></tr></tbody></table><h4 id="2ï¸âƒ£-FT-AGGREGATE">2ï¸âƒ£ FT.AGGREGATE</h4><blockquote><p>åˆ†ç»„ / ç»Ÿè®¡ / èšåˆï¼Œè¯­æ³•</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>FT.AGGREGATE åŸºæœ¬è¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">FT.AGGREGATE index query</span><br><span class="line">[VERBATIM]</span><br><span class="line">[LOAD count field ... | LOAD *]</span><br><span class="line">[TIMEOUT <span class="built_in">timeout</span>]</span><br><span class="line">[GROUPBY nargs property ...</span><br><span class="line">   REDUCE <span class="keyword">function</span> nargs arg ... [AS name] ...]</span><br><span class="line">[SORTBY nargs property ASC|DESC ... [MAX num]]</span><br><span class="line">[APPLY expression AS name]</span><br><span class="line">[LIMIT offset num]</span><br><span class="line">[FILTER filter]</span><br><span class="line">[WITHCURSOR [COUNT read_size]]</span><br><span class="line">[MAXIDLE idle_time]</span><br><span class="line">[PARAMS nargs name value ...]</span><br><span class="line">[DIALECT dialect]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>FT.AGGREGATE å‚æ•°è¯´æ˜è¡¨</p></li></ul><table><thead><tr><th>å‚æ•°</th><th>ä½œç”¨è¯´æ˜</th></tr></thead><tbody><tr><td><code>index</code></td><td>ç´¢å¼•åç§°</td></tr><tr><td><code>query</code></td><td>æŸ¥è¯¢æ¡ä»¶ï¼ˆç±»ä¼¼ WHEREï¼‰</td></tr><tr><td><code>VERBATIM</code></td><td>ç¦ç”¨æŸ¥è¯¢ä¼˜åŒ–</td></tr><tr><td><code>LOAD</code></td><td>åŠ è½½åŸå§‹å­—æ®µ</td></tr><tr><td><code>TIMEOUT</code></td><td>æŸ¥è¯¢è¶…æ—¶æ—¶é—´</td></tr><tr><td><code>GROUPBY</code></td><td>åˆ†ç»„å­—æ®µï¼ˆç±»ä¼¼ SQL GROUP BYï¼‰</td></tr><tr><td><code>REDUCE</code></td><td>èšåˆå‡½æ•°ï¼ˆCOUNT / SUM / AVG / MIN / MAX ç­‰ï¼‰</td></tr><tr><td><code>AS</code></td><td>èšåˆç»“æœåˆ«å</td></tr><tr><td><code>SORTBY</code></td><td>å¯¹èšåˆç»“æœæ’åº</td></tr><tr><td><code>ASC / DESC</code></td><td>æ’åºæ–¹å‘</td></tr><tr><td><code>MAX</code></td><td>æœ€å¤§è¿”å›æ¡æ•°</td></tr><tr><td><code>APPLY</code></td><td>å¯¹ç»“æœå­—æ®µè¿›è¡Œè¡¨è¾¾å¼è®¡ç®—</td></tr><tr><td><code>LIMIT</code></td><td>åˆ†é¡µæ§åˆ¶</td></tr><tr><td><code>FILTER</code></td><td>ç»“æœè¿‡æ»¤ï¼ˆWHERE / HAVINGï¼‰</td></tr><tr><td><code>WITHCURSOR</code></td><td>ä½¿ç”¨æ¸¸æ ‡ï¼ˆå¤§ç»“æœé›†ï¼‰</td></tr><tr><td><code>COUNT</code></td><td>æ¯æ¬¡è¯»å–æ•°é‡</td></tr><tr><td><code>MAXIDLE</code></td><td>æ¸¸æ ‡æœ€å¤§ç©ºé—²æ—¶é—´</td></tr><tr><td><code>PARAMS</code></td><td>å‚æ•°åŒ–æŸ¥è¯¢</td></tr><tr><td><code>DIALECT</code></td><td>æŸ¥è¯¢è¯­æ³•ç‰ˆæœ¬</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>FT.AGGREGATE çš„æ ¸å¿ƒè¯­æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FT.AGGREGATE &lt;index&gt; &lt;query&gt;</span><br><span class="line">  [GROUPBY ...]</span><br><span class="line">  [REDUCE ...]</span><br><span class="line">  [SORTBY ...]</span><br><span class="line">  [LIMIT ...]</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹ 1ï¼šæŒ‰ status åˆ†ç»„ç»Ÿè®¡æ•°é‡</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">FT.AGGREGATE idx:user</span><br><span class="line">  <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  GROUPBY 1 @status</span><br><span class="line">  REDUCE COUNT 0 AS cnt</span><br><span class="line"><span class="comment">## å‚æ•°è¯´æ˜</span></span><br><span class="line"><span class="comment"># *: æŸ¥è¯¢æ¡ä»¶ï¼Œ* è¡¨ç¤ºåŒ¹é…ç´¢å¼•ä¸­çš„ æ‰€æœ‰æ–‡æ¡£ï¼Œä¹Ÿå¯ä»¥æ˜¯ FT.SEARCH ä¸­çš„æŸ¥è¯¢æ¡ä»¶ï¼Œæ¯”å¦‚ï¼š&#x27;@status:&#123;PAID&#125; @amount:[50 +inf]&#x27;</span></span><br><span class="line"><span class="comment"># GROUPBY 1 @status: åˆ†ç»„å­—æ®µ</span></span><br><span class="line">  <span class="comment"># 1:è¡¨ç¤ºåˆ†ç»„å­—æ®µæ•°é‡</span></span><br><span class="line">  <span class="comment"># @status:è¡¨ç¤ºåˆ†ç»„å­—æ®µ</span></span><br><span class="line"><span class="comment"># REDUCE COUNT 0 AS cnt: èšåˆå­—æ®µ</span></span><br><span class="line">  <span class="comment"># COUNT:èšåˆå‡½æ•°ï¼šè®¡æ•°</span></span><br><span class="line">  <span class="comment"># 0:å‚æ•°ä¸ªæ•°ï¼ˆCOUNT ä¸éœ€è¦å‚æ•°ï¼‰</span></span><br><span class="line">  <span class="comment"># AS cnt:è¡¨ç¤ºèšåˆå­—æ®µåˆ«å</span></span><br><span class="line"><span class="comment">## è¿”å›ç»“æœç¤ºä¾‹</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 3</span><br><span class="line">2) 1) <span class="string">&quot;status&quot;</span></span><br><span class="line">   2) <span class="string">&quot;CANCELLED&quot;</span></span><br><span class="line">   3) <span class="string">&quot;cnt&quot;</span></span><br><span class="line">   4) <span class="string">&quot;2&quot;</span></span><br><span class="line">3) 1) <span class="string">&quot;status&quot;</span></span><br><span class="line">   2) <span class="string">&quot;PAID&quot;</span></span><br><span class="line">   3) <span class="string">&quot;cnt&quot;</span></span><br><span class="line">   4) <span class="string">&quot;6&quot;</span></span><br><span class="line">4) 1) <span class="string">&quot;status&quot;</span></span><br><span class="line">   2) <span class="string">&quot;CREATED&quot;</span></span><br><span class="line">   3) <span class="string">&quot;cnt&quot;</span></span><br><span class="line">   4) <span class="string">&quot;2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¹åº”SQL è¯­å¥ï¼š</span></span><br><span class="line">SELECT status, COUNT(*) AS cnt</span><br><span class="line">  FROM user</span><br><span class="line">  GROUP BY status;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AggregationResult</span> <span class="variable">result</span> <span class="operator">=</span> rSearch.aggregate(</span><br><span class="line">        <span class="string">&quot;idx:user&quot;</span>,</span><br><span class="line">        <span class="string">&quot;*&quot;</span>,</span><br><span class="line">        AggregationOptions.defaults()</span><br><span class="line">                .groupBy(GroupBy.fieldNames(<span class="string">&quot;@status&quot;</span>).reducers(Reducer.count().as(<span class="string">&quot;cnt&quot;</span>)))</span><br><span class="line">);</span><br><span class="line"><span class="keyword">final</span> <span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> result.getTotal();</span><br><span class="line">System.out.println(<span class="string">&quot;total = &quot;</span> + total);</span><br><span class="line"><span class="keyword">final</span> List&lt;Map&lt;String, Object&gt;&gt; attributes = result.getAttributes();</span><br><span class="line"><span class="keyword">for</span> (Map&lt;String, Object&gt; attribute : attributes) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;attribute = &quot;</span> + attribute);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹ 2ï¼šæŒ‰ status åˆ†ç»„ç»Ÿè®¡é‡‘é¢æ€»å’Œ</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">FT.AGGREGATE idx:user <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  GROUPBY 1 @status</span><br><span class="line">  REDUCE SUM 1 @amount AS total_amount</span><br><span class="line">  SORTBY 2 @total_amount DESC</span><br><span class="line">  LIMIT 0 3</span><br><span class="line"></span><br><span class="line"><span class="comment">## å‚æ•°è¯´æ˜</span></span><br><span class="line"><span class="comment"># SUM:èšåˆå‡½æ•°ï¼šæ±‚å’Œ</span></span><br><span class="line"><span class="comment"># 1:å‚æ•°ä¸ªæ•°</span></span><br><span class="line"><span class="comment"># @amount:è¦å‚ä¸æ±‚å’Œçš„å­—æ®µ</span></span><br><span class="line"><span class="comment"># total_amount:è¡¨ç¤ºèšåˆå­—æ®µåˆ«å</span></span><br><span class="line"><span class="comment"># SORTBY 2 @total_amount DESC: æ’åº</span></span><br><span class="line">  <span class="comment"># 2: è¡¨ç¤ºåé¢è·Ÿ 2 ä¸ªå‚æ•°ï¼ˆå­—æ®µ + æ’åºæ–¹å‘ï¼‰</span></span><br><span class="line">  <span class="comment"># @total_amount: è¡¨ç¤ºæ’åºå­—æ®µï¼ˆREDUCE äº§ç”Ÿçš„åˆ«åï¼‰ï¼ŒDESC:è¡¨ç¤ºé™åº</span></span><br><span class="line"><span class="comment"># LIMIT 0 3: åˆ†é¡µï¼Œ0:è¡¨ç¤ºä»ç¬¬ 0 æ¡å¼€å§‹ï¼Œ3:è¡¨ç¤ºè¿”å› 3 æ¡æ•°æ®</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## ç¤ºä¾‹ç»“æœ</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 3</span><br><span class="line">2) 1) <span class="string">&quot;status&quot;</span></span><br><span class="line">   2) <span class="string">&quot;PAID&quot;</span></span><br><span class="line">   3) <span class="string">&quot;total_amount&quot;</span></span><br><span class="line">   4) <span class="string">&quot;4096.89&quot;</span></span><br><span class="line">3) 1) <span class="string">&quot;status&quot;</span></span><br><span class="line">   2) <span class="string">&quot;CREATED&quot;</span></span><br><span class="line">   3) <span class="string">&quot;total_amount&quot;</span></span><br><span class="line">   4) <span class="string">&quot;238.8&quot;</span></span><br><span class="line">4) 1) <span class="string">&quot;status&quot;</span></span><br><span class="line">   2) <span class="string">&quot;CANCELLED&quot;</span></span><br><span class="line">   3) <span class="string">&quot;total_amount&quot;</span></span><br><span class="line">   4) <span class="string">&quot;79.8&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¹åº”SQL è¯­å¥ï¼š</span></span><br><span class="line">SELECT status, SUM(amount) AS total_amount</span><br><span class="line">  FROM user</span><br><span class="line">  GROUP BY status</span><br><span class="line">  ORDER BY total_amount DESC</span><br><span class="line">  LIMIT 0 3;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AggregationResult</span> <span class="variable">result</span> <span class="operator">=</span> rSearch.aggregate(</span><br><span class="line">        <span class="string">&quot;idx:user&quot;</span>,</span><br><span class="line">        <span class="string">&quot;*&quot;</span>,</span><br><span class="line">        AggregationOptions.defaults()</span><br><span class="line">                .groupBy(GroupBy.fieldNames(<span class="string">&quot;@status&quot;</span>)</span><br><span class="line">                        .reducers(</span><br><span class="line">                                Reducer.sum(<span class="string">&quot;@amount&quot;</span>).as(<span class="string">&quot;total_amount&quot;</span>)</span><br><span class="line">                        )</span><br><span class="line">                )</span><br><span class="line">                .sortBy(<span class="keyword">new</span> <span class="title class_">SortedField</span>(<span class="string">&quot;@total_amount&quot;</span>, SortOrder.DESC))</span><br><span class="line">                .limit(<span class="number">0</span>, <span class="number">3</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹ 3ï¼šåŒæ—¶è¾“å‡ºæ•°é‡ + é‡‘é¢ï¼Œå¹¶æŒ‰é‡‘é¢é™åºï¼Œæ•°é‡å‡åº</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">FT.AGGREGATE idx:user <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  GROUPBY 1 @status</span><br><span class="line">  REDUCE COUNT 0 AS cnt</span><br><span class="line">  REDUCE SUM 1 @amount AS total_amount</span><br><span class="line">  SORTBY 4 @total_amount DESC @cnt ASC</span><br><span class="line"></span><br><span class="line"><span class="comment">## ç¤ºä¾‹ç»“æœ</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 3</span><br><span class="line">2) 1) <span class="string">&quot;status&quot;</span></span><br><span class="line">   2) <span class="string">&quot;PAID&quot;</span></span><br><span class="line">   3) <span class="string">&quot;cnt&quot;</span></span><br><span class="line">   4) <span class="string">&quot;6&quot;</span></span><br><span class="line">   5) <span class="string">&quot;total_amount&quot;</span></span><br><span class="line">   6) <span class="string">&quot;4096.89&quot;</span></span><br><span class="line">3) 1) <span class="string">&quot;status&quot;</span></span><br><span class="line">   2) <span class="string">&quot;CREATED&quot;</span></span><br><span class="line">   3) <span class="string">&quot;cnt&quot;</span></span><br><span class="line">   4) <span class="string">&quot;2&quot;</span></span><br><span class="line">   5) <span class="string">&quot;total_amount&quot;</span></span><br><span class="line">   6) <span class="string">&quot;238.8&quot;</span></span><br><span class="line">4) 1) <span class="string">&quot;status&quot;</span></span><br><span class="line">   2) <span class="string">&quot;CANCELLED&quot;</span></span><br><span class="line">   3) <span class="string">&quot;cnt&quot;</span></span><br><span class="line">   4) <span class="string">&quot;2&quot;</span></span><br><span class="line">   5) <span class="string">&quot;total_amount&quot;</span></span><br><span class="line">   6) <span class="string">&quot;79.8&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AggregationResult</span> <span class="variable">result</span> <span class="operator">=</span> rSearch.aggregate(</span><br><span class="line">        <span class="string">&quot;idx:user&quot;</span>,</span><br><span class="line">        <span class="string">&quot;*&quot;</span>,</span><br><span class="line">        AggregationOptions.defaults()</span><br><span class="line">                .groupBy(GroupBy.fieldNames(<span class="string">&quot;@status&quot;</span>)</span><br><span class="line">                        .reducers(</span><br><span class="line">                                Reducer.count().as(<span class="string">&quot;cnt&quot;</span>),</span><br><span class="line">                                Reducer.sum(<span class="string">&quot;@amount&quot;</span>).as(<span class="string">&quot;total_amount&quot;</span>)</span><br><span class="line">                        )</span><br><span class="line">                )</span><br><span class="line">                .sortBy(<span class="keyword">new</span> <span class="title class_">SortedField</span>(<span class="string">&quot;@total_amount&quot;</span>, SortOrder.DESC))</span><br><span class="line">                .sortBy(<span class="keyword">new</span> <span class="title class_">SortedField</span>(<span class="string">&quot;@cnt&quot;</span>, SortOrder.ASC))</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹ 4ï¼šæŒ‰çŠ¶æ€åˆ†ç»„ï¼Œç­›é€‰æ€»é‡‘é¢ &gt; 200</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FT.AGGREGATE idx:user <span class="string">&#x27;*&#x27;</span></span><br><span class="line">  GROUPBY 1 @status</span><br><span class="line">  REDUCE SUM 1 @amount AS total_amount</span><br><span class="line">  FILTER @total_amount &gt; 200</span><br><span class="line">  SORTBY 2 @total_amount DESC</span><br><span class="line"><span class="comment">## å‚æ•°è¯´æ˜</span></span><br><span class="line"><span class="comment"># FILTER: è¿‡æ»¤å™¨ï¼Œä½œç”¨åœ¨ GROUPBY + REDUCE ä¹‹åï¼Œè¯­ä¹‰ç­‰ä»·äº SQL çš„ï¼šHAVING SUM(amount) &gt; 1000</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AggregationResult</span> <span class="variable">result</span> <span class="operator">=</span> rSearch.aggregate(</span><br><span class="line">        <span class="string">&quot;idx:user&quot;</span>,</span><br><span class="line">        <span class="string">&quot;*&quot;</span>,</span><br><span class="line">        AggregationOptions.defaults()</span><br><span class="line">                .groupBy(GroupBy.fieldNames(<span class="string">&quot;@status&quot;</span>)</span><br><span class="line">                        .reducers(</span><br><span class="line">                                Reducer.sum(<span class="string">&quot;@amount&quot;</span>).as(<span class="string">&quot;total_amount&quot;</span>)</span><br><span class="line">                        )</span><br><span class="line">                )</span><br><span class="line">                .filter(<span class="string">&quot;@total_amount &gt; 200&quot;</span>)</span><br><span class="line">                .sortBy(<span class="keyword">new</span> <span class="title class_">SortedField</span>(<span class="string">&quot;@total_amount&quot;</span>, SortOrder.DESC))</span><br><span class="line">);</span><br></pre></td></tr></table></figure><blockquote><p>è¯­ä¹‰æ‰§è¡Œé¡ºåºï¼š SCAN â†’ GROUPBY â†’ REDUCE â†’ FILTER (HAVING) â†’ SORTBY â†’ LIMIT</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>å¸¸è§å¯ç”¨ REDUCE å‡½æ•°</p></li></ul><table><thead><tr><th>å‡½æ•°</th><th>ç”¨é€”</th></tr></thead><tbody><tr><td>COUNT</td><td>è¡Œæ•°</td></tr><tr><td>SUM</td><td>æ±‚å’Œ</td></tr><tr><td>AVG</td><td>å¹³å‡</td></tr><tr><td>MIN / MAX</td><td>æå€¼</td></tr><tr><td>TO_LIST</td><td>æ”¶é›†å­—æ®µ</td></tr></tbody></table><h4 id="3ï¸âƒ£-FT-EXPLAIN-FT-EXPLAINCLI">3ï¸âƒ£ FT.EXPLAIN/FT.EXPLAINCLI</h4><blockquote><p>æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’ï¼Œ ä¸ä¼šè€ƒè™‘åˆ†ç»„èšåˆï¼Œåªçœ‹æŸ¥è¯¢æ¡ä»¶ï¼Œå®ƒçš„å®šä½æ˜¯ï¼šçœ‹â€œä¼šä¸ä¼šç”¨ç´¢å¼•ã€æ€ä¹ˆç”¨ç´¢å¼•â€ï¼Œè€Œä¸æ˜¯çœ‹â€œè·‘å¾—æ…¢ä¸æ…¢â€ã€‚</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">FT.EXPLAINCLI idx:user <span class="string">&#x27;@status:&#123;PAID&#125;  @amount:[100 +inf]&#x27;</span></span><br><span class="line"><span class="comment">## ç¤ºä¾‹ç»“æœ</span></span><br><span class="line">1) INTERSECT &#123;</span><br><span class="line">2)   TAG:@status &#123;</span><br><span class="line">3)     paid</span><br><span class="line">4)   &#125;</span><br><span class="line">5)   NUMERIC &#123;100.000000 &lt;= @amount &lt;= inf&#125;</span><br><span class="line">6) &#125;</span><br><span class="line">7)</span><br></pre></td></tr></table></figure><h4 id="4ï¸âƒ£-FT-PROFILE">4ï¸âƒ£ FT.PROFILE</h4><blockquote><p>æ€§èƒ½åˆ†æï¼Œçœ‹â€œè·‘å¾—æ…¢ä¸æ…¢â€ã€‚</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FT.PROFILE idx:user</span><br><span class="line">  SEARCH</span><br><span class="line">  QUERY <span class="string">&#x27;@status:&#123;PAID&#125;  @amount:[100 +inf]&#x27;</span></span><br><span class="line"><span class="comment">## å‚æ•°è¯´æ˜</span></span><br><span class="line"><span class="comment"># SEARCH: æ ‡å‡†æŸ¥è¯¢ï¼ŒAGGREGATE: èšåˆæŸ¥è¯¢</span></span><br><span class="line"><span class="comment"># QUERY: æŸ¥è¯¢æ¡ä»¶</span></span><br><span class="line"></span><br><span class="line">FT.PROFILE idx:user</span><br><span class="line">  AGGREGATE</span><br><span class="line">  QUERY <span class="string">&quot;@status:&#123;PAID&#125; @amount:[100 +inf]&quot;</span></span><br><span class="line">  GROUPBY 1 @status</span><br><span class="line">  REDUCE SUM 1 @amount AS total_amount</span><br></pre></td></tr></table></figure><h5 id="å…³æ³¨æŒ‡æ ‡">å…³æ³¨æŒ‡æ ‡</h5><ul class="lvl-0"><li class="lvl-2"><p>ç¬¬ä¸€ä¼˜å…ˆçº§æŒ‡æ ‡ï¼ˆç›´æ¥å†³å®šæŸ¥è¯¢æ˜¯å¦æ…¢ï¼‰</p></li></ul><table><thead><tr><th>æŒ‡æ ‡</th><th>æ‰€åœ¨ä½ç½®</th><th>å«ä¹‰</th><th>å¥åº·é˜ˆå€¼</th><th>éœ€è¦è­¦æƒ•</th><th>å¸¸è§ä¼˜åŒ–æ‰‹æ®µ</th></tr></thead><tbody><tr><td><strong>Total profile time</strong></td><td>Shards â†’ Total profile time</td><td>æŸ¥è¯¢åœ¨æœç´¢å¼•æ“å±‚é¢çš„æ€»è€—æ—¶ï¼ˆä¸å«ç½‘ç»œï¼‰</td><td><strong>&lt; 1 msï¼šä¼˜ç§€</strong><br>1â€“10 msï¼šå¯æ¥å—</td><td>&gt; 20 msï¼šéœ€è¦ä¼˜åŒ–<br>&gt; 50 msï¼šç»“æ„æ€§é—®é¢˜</td><td>å‡å°‘ç»“æœé›†ã€æ‹†åˆ†æŸ¥è¯¢ã€ä¼˜åŒ–ç´¢å¼•å­—æ®µ</td></tr><tr><td><strong>Iterator Type</strong></td><td>Iterators profile â†’ Type</td><td>æŸ¥è¯¢æ‰§è¡Œç­–ç•¥</td><td><strong>INTERSECT / UNION</strong></td><td><strong>SCAN / WILDCARD</strong></td><td>å¢åŠ å¯ç´¢å¼•å­—æ®µã€é¿å…æ¨¡ç³Šå‰ç¼€</td></tr><tr><td><strong>Estimated number of matches</strong></td><td>Child iterators</td><td>ç´¢å¼•å±‚ä¼°ç®—çš„å€™é€‰æ–‡æ¡£æ•°</td><td><strong>&lt; 1kï¼šç†æƒ³</strong><br>1kâ€“10kï¼šå¯æ¥å—</td><td>&gt; 50kï¼šè¿‡æ»¤æ¡ä»¶è¿‡å®½</td><td>æ”¹ç”¨ TAG / NUMERIC / å†—ä½™å­—æ®µ</td></tr><tr><td><strong>Loader Time</strong></td><td>Result processors â†’ Loader</td><td>ä» Redis åŠ è½½å¹¶ååºåˆ—åŒ–æ–‡æ¡£</td><td>&lt; 30% Total time</td><td>&gt; 40% Total time</td><td>RETURN ç²¾ç®€å­—æ®µã€NOCONTENTã€ç¼©å° JSON</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>ç¬¬äºŒä¼˜å…ˆçº§æŒ‡æ ‡ï¼ˆåˆ¤æ–­ç´¢å¼•æˆ–æ¨¡å‹æ˜¯å¦åˆç†ï¼‰</p></li></ul><table><thead><tr><th>æŒ‡æ ‡</th><th>æ‰€åœ¨ä½ç½®</th><th>å«ä¹‰</th><th>å¥åº·é˜ˆå€¼</th><th>éœ€è¦è­¦æƒ•</th><th>å¸¸è§ä¼˜åŒ–æ‰‹æ®µ</th></tr></thead><tbody><tr><td><strong>Number of reading operations</strong></td><td>Iterators profile</td><td>å®é™…æ‰«æçš„å€’æ’è¡¨æ¡ç›®æ•°</td><td>â‰ˆ Estimated matches</td><td>æ˜æ˜¾å¤§äºç»“æœæ•°</td><td>æé«˜å­—æ®µé€‰æ‹©æ€§ã€æ‹†åˆ†æ¡ä»¶</td></tr><tr><td><strong>Estimated matches vs å®é™…ç»“æœæ•°</strong></td><td>Iterator + Result</td><td>ç´¢å¼•ä¼°ç®—ç²¾åº¦</td><td>ä¼°ç®—å€¼ç•¥å¤§äºå®é™…</td><td>ä¼°ç®— &gt;&gt; å®é™…ï¼ˆ10x+ï¼‰</td><td>è°ƒæ•´ schemaï¼Œé¿å…ä½åŸºæ•°å­—æ®µ</td></tr><tr><td><strong>Parsing time</strong></td><td>Shards â†’ Parsing time</td><td>æŸ¥è¯¢è¯­æ³•è§£æè€—æ—¶</td><td>&lt; 0.1 ms</td><td>&gt; 1 ms</td><td>å‡å°‘åŠ¨æ€æ‹¼æ¥ã€ç®€åŒ–è¯­æ³•</td></tr><tr><td><strong>Pipeline creation time</strong></td><td>Shards â†’ Pipeline creation</td><td>æ‰§è¡Œè®¡åˆ’æ„å»ºæ—¶é—´</td><td>&lt; 0.05 ms</td><td>&gt; 0.5 ms</td><td>å‡å°‘å­å¥ã€é¿å…å¤æ‚åµŒå¥—</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>ç»éªŒå‹â€œçº¢çº¿åˆ¤æ–­â€é€ŸæŸ¥è¡¨ï¼ˆéå¸¸å®ç”¨ï¼‰</p></li></ul><table><thead><tr><th>ç°è±¡</th><th>å«ä¹‰</th><th>æ˜¯å¦å¿…é¡»å¤„ç†</th></tr></thead><tbody><tr><td>Estimated matches &gt; 100k</td><td>ç´¢å¼•å­—æ®µé€‰æ‹©é”™è¯¯</td><td>å¿…é¡»</td></tr><tr><td>Iterator Type = SCAN</td><td>å…¨è¡¨æ‰«æ</td><td>å¿…é¡»</td></tr><tr><td>Loader &gt; 50% æ€»è€—æ—¶</td><td>è¿”å›æ•°æ®è¿‡é‡</td><td>å¼ºçƒˆå»ºè®®</td></tr><tr><td>reading ops â‰« results</td><td>å€’æ’æ•ˆç‡ä½</td><td>å»ºè®®</td></tr><tr><td>Total time &gt; 20 ms</td><td>åœ¨çº¿æŸ¥è¯¢é£é™©</td><td>å¿…é¡»</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>æ ¸å¿ƒæ‰§è¡Œç­–ç•¥å‹ Iteratorï¼ˆæœ€é‡è¦ï¼‰</p></li></ul><table><thead><tr><th>Type</th><th>è¯­ä¹‰</th><th>å…¸å‹è§¦å‘åœºæ™¯</th><th>æ€§èƒ½ç‰¹å¾</th><th>è°ƒä¼˜ç»“è®º</th></tr></thead><tbody><tr><td><strong>INTERSECT</strong></td><td>å¤šæ¡ä»¶å–äº¤é›†ï¼ˆANDï¼‰</td><td><code>@a:&#123;x&#125; @b:[1 10]</code></td><td>åŸºäºæœ€å°å€’æ’è¡¨ï¼Œæ•ˆç‡æœ€é«˜</td><td><strong>ç†æƒ³çŠ¶æ€ï¼Œä¼˜å…ˆä½¿ç”¨</strong></td></tr><tr><td><strong>UNION</strong></td><td>å¤šæ¡ä»¶å–å¹¶é›†ï¼ˆORï¼‰</td><td><code>@a:&#123;x|y&#125;</code></td><td>å€™é€‰é›†æ‰©å¤§ï¼Œéš OR æ•°é‡çº¿æ€§å¢é•¿</td><td>å¯æ¥å—ï¼Œé¿å…è¿‡å¤š OR</td></tr><tr><td><strong>SCAN</strong></td><td>å…¨é‡æ‰«æ</td><td>å­—æ®µæœªç´¢å¼• / JSON Path ä¸å¯ç´¢å¼•</td><td>O(N)ï¼Œæ–‡æ¡£è¶Šå¤šè¶Šæ…¢</td><td><strong>å¿…é¡»æ¶ˆç­</strong></td></tr><tr><td><strong>WILDCARD</strong></td><td>æ— è¿‡æ»¤æ¡ä»¶</td><td><code>&quot;*&quot;</code>ã€<code>@field:*</code></td><td>å€™é€‰é›†=å…¨éƒ¨æ–‡æ¡£</td><td>ä»…é™åˆ†æï¼Œçº¿ä¸Šæ…ç”¨</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>ç´¢å¼•è®¿é—®å‹ Iteratorï¼ˆINTERSECT / UNION çš„å­èŠ‚ç‚¹ï¼‰</p></li></ul><table><thead><tr><th>Type</th><th>å¯¹åº”å­—æ®µç±»å‹</th><th>ç¤ºä¾‹æŸ¥è¯¢</th><th>æ€§èƒ½ç‰¹å¾</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td><strong>TAG</strong></td><td>TAG</td><td><code>@status:&#123;PAID&#125;</code></td><td>å“ˆå¸Œå€’æ’ï¼Œæœ€å¿«</td><td>å¼ºçƒˆæ¨è</td></tr><tr><td><strong>NUMERIC</strong></td><td>NUMERIC</td><td><code>@amount:[100 +inf]</code></td><td>è·³è¡¨èŒƒå›´æ‰«æ</td><td>èŒƒå›´è¶Šçª„è¶Šå¿«</td></tr><tr><td><strong>TEXT</strong></td><td>TEXT</td><td><code>@name:alice</code></td><td>åˆ†è¯åŒ¹é…</td><td>åˆ†è¯æ•°å½±å“æ€§èƒ½</td></tr><tr><td><strong>GEO</strong></td><td>GEO</td><td><code>@loc:[13.4 52.5 10 km]</code></td><td>ç©ºé—´ç´¢å¼•</td><td>åŠå¾„å½±å“ç»“æœæ•°</td></tr><tr><td><strong>VECTOR</strong></td><td>VECTOR</td><td><code>=&gt;[KNN 10 @v $q]</code></td><td>å‘é‡æœç´¢</td><td>å¸¸ä¸ FILTER è”ç”¨</td></tr><tr><td><strong>IDLIST</strong></td><td>å†…éƒ¨</td><td>å°ç»“æœé›†</td><td>æšä¸¾ ID</td><td>è‡ªåŠ¨ä¼˜åŒ–</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>é€»è¾‘ / ç»“æ„å‹ Iterator</p></li></ul><table><thead><tr><th>Type</th><th>å«ä¹‰</th><th>è§¦å‘ç¤ºä¾‹</th><th>æ€§èƒ½å½±å“</th><th>æ˜¯å¦å¸¸è§</th></tr></thead><tbody><tr><td><strong>NOT</strong></td><td>å–å</td><td><code>-@status:&#123;PAID&#125;</code></td><td>ä¾èµ–å…¨é›†</td><td>è¾ƒå°‘</td></tr><tr><td><strong>OPTIONAL</strong></td><td>å¯é€‰å­å¥</td><td><code>( @a:&#123;x&#125; )?</code></td><td>å¢åŠ å€™é€‰é›†</td><td>å°‘è§</td></tr><tr><td><strong>EMPTY</strong></td><td>æ— åŒ¹é…</td><td>æ¡ä»¶ä¸å¯èƒ½æ»¡è¶³</td><td>æå¿«</td><td>å¶å‘</td></tr><tr><td><strong>PHRASE</strong></td><td>çŸ­è¯­åŒ¹é…</td><td><code>&quot;hello world&quot;</code></td><td>æ¯” TEXT æ…¢</td><td>ä½é¢‘</td></tr><tr><td><strong>PREFIX</strong></td><td>å‰ç¼€åŒ¹é…</td><td><code>abc*</code></td><td>å¯èƒ½é€€åŒ–</td><td>éœ€è°¨æ…</td></tr></tbody></table><h3 id="ä¸‰ã€åˆ«åç®¡ç†ï¼ˆç”Ÿäº§å¿…å¤‡ï¼‰">ä¸‰ã€åˆ«åç®¡ç†ï¼ˆç”Ÿäº§å¿…å¤‡ï¼‰</h3><table><thead><tr><th>å‘½ä»¤</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td><code>FT.ALIASADD</code></td><td>æ·»åŠ åˆ«å</td></tr><tr><td><code>FT.ALIASDEL</code></td><td>åˆ é™¤åˆ«å</td></tr><tr><td><code>FT.ALIASUPDATE</code></td><td>æ›´æ–°åˆ«åæŒ‡å‘</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>ä¸€ä¸ªç´¢å¼•å¯ä»¥æœ‰å¤šä¸ªåˆ«åï¼Œä¸€æ—¦åˆ›å»ºåˆ«åï¼Œæ‰€æœ‰ FT.SEARCH / FT.AGGREGATE / <a href="http://FT.INFO">FT.INFO</a> ç­‰å‘½ä»¤éƒ½å¯ä»¥ç›´æ¥ä½¿ç”¨ alias</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ åˆ«å: FT.ALIASADD alias index</span></span><br><span class="line">FT.ALIASADD <span class="built_in">alias</span>:user idx:user</span><br><span class="line"><span class="comment"># æ›´æ–°åˆ«åæŒ‡å‘: FT.ALIASUPDATE alias index</span></span><br><span class="line">FT.ALIASUPDATE <span class="built_in">alias</span>:user idx:user:v2</span><br><span class="line"><span class="comment"># åˆ é™¤åˆ«å: FT.ALIASDEL alias</span></span><br><span class="line">FT.ALIASDEL <span class="built_in">alias</span>:user</span><br><span class="line"><span class="comment"># åˆ¤æ–­ç´¢å¼•åç§°æ˜¯å¦ä¸ºåˆ«å</span></span><br><span class="line">FT.INFO <span class="built_in">alias</span>:user</span><br><span class="line"> 1) index_name</span><br><span class="line"> 2) idx:user  <span class="comment"># çœŸå®ç´¢å¼•åç§°</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rSearch.addAlias(<span class="string">&quot;alias:user&quot;</span>, <span class="string">&quot;idx:user&quot;</span>);</span><br><span class="line">rSearch.updateAlias(<span class="string">&quot;alias:user&quot;</span>, <span class="string">&quot;idx:user:v2&quot;</span>);</span><br><span class="line">rSearch.delAlias(<span class="string">&quot;alias:user&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="ç´¢å¼•åˆ«åçš„æ ¸å¿ƒä»·å€¼">ç´¢å¼•åˆ«åçš„æ ¸å¿ƒä»·å€¼</h4><ul class="lvl-0"><li class="lvl-2"><ol><li class="lvl-5">ç´¢å¼•æ— æŸé‡å»ºï¼ˆæœ€å…¸å‹åœºæ™¯ï¼‰</li></ol><ul class="lvl-2"><li class="lvl-4">RediSearch ä¸æ”¯æŒåœ¨çº¿ä¿®æ”¹ schemaï¼Œå­—æ®µå˜æ›´é€šå¸¸éœ€è¦é‡å»ºç´¢å¼•ï¼Œç´¢å¼•é‡å»ºæ—¶ä¸šåŠ¡å°†ä¸å¯ç”¨ã€‚</li><li class="lvl-4">æœ‰äº†åˆ«åï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„ç´¢å¼•ï¼Œåˆ›å»ºå¥½åå°†åˆ«åæŒ‡å‘æ–°çš„ç´¢å¼•ï¼Œæ—§ç´¢å¼•ä¸å†ä½¿ç”¨ï¼Œä¸šåŠ¡æ— å½±å“ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1. æ—§ç´¢å¼•</span><br><span class="line"> FT.ALIASADD user_idx user_idx_v1</span><br><span class="line"></span><br><span class="line">2. æ–°å»ºç´¢å¼•</span><br><span class="line">  FT.CREATE user_idx_v2 ...</span><br><span class="line"></span><br><span class="line">3. æ•°æ®å›å¡«å®Œæˆåï¼ŒåŸå­åˆ‡æ¢</span><br><span class="line">  FT.ALIASUPDATE user_idx user_idx_v2</span><br><span class="line"></span><br><span class="line">4. åˆ é™¤æ—§ç´¢å¼•ï¼ˆå¯é€‰ï¼‰</span><br><span class="line">  FT.DROPINDEX user_idx_v1</span><br></pre></td></tr></table></figure></li><li class="lvl-2"><ol start="2"><li class="lvl-5">ç°åº¦ / å¤šç‰ˆæœ¬å¹¶å­˜</li></ol><ul class="lvl-2"><li class="lvl-4">ä¸åŒç¯å¢ƒï¼ˆdev / staging / prodï¼‰</li><li class="lvl-4">ä¸åŒ schema ç‰ˆæœ¬</li></ul></li><li class="lvl-2"><ol start="3"><li class="lvl-5">è¿ç»´ä¸å‘å¸ƒè§„èŒƒåŒ–ï¼ˆå¼ºçƒˆæ¨èï¼‰</li></ol><ul class="lvl-2"><li class="lvl-4">åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼šæ°¸è¿œä¸è¦è®©ä¸šåŠ¡ä»£ç ç›´æ¥ä½¿ç”¨ç‰©ç†ç´¢å¼•å</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ç´¢å¼•çœŸå®å: ä¸šåŠ¡å_ç‰ˆæœ¬_æ—¶é—´æˆ³</span><br><span class="line">ç´¢å¼•åˆ«å : ä¸šåŠ¡å</span><br></pre></td></tr></table></figure></li></ul><h3 id="å››ã€æ¸¸æ ‡ï¼ˆå¤§ç»“æœé›†ï¼‰">å››ã€æ¸¸æ ‡ï¼ˆå¤§ç»“æœé›†ï¼‰</h3><table><thead><tr><th>å‘½ä»¤</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td><code>FT.CURSOR READ</code></td><td>åˆ†æ‰¹è¯»å–</td></tr><tr><td><code>FT.CURSOR DEL</code></td><td>åˆ é™¤æ¸¸æ ‡</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>æ¸¸æ ‡ç”¨äºèšåˆæŸ¥è¯¢ï¼ˆAGGREGATEï¼‰çš„å¤§ç»“æœé›†åˆ†é¡µ/åˆ†æ‰¹æ‹‰å–ï¼Œå…¸å‹åœºæ™¯åŒ…æ‹¬ï¼š</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GROUPBY / REDUCE åç»“æœé›†å¾ˆå¤§</span><br><span class="line">éœ€è¦æµå¼å¤„ç†èšåˆç»“æœï¼Œé¿å…ä¸€æ¬¡æ€§è¿”å›å ç”¨å¤§é‡å†…å­˜</span><br><span class="line">å®¢æˆ·ç«¯æŒ‰æ‰¹æ¶ˆè´¹ç»“æœï¼ˆç±»ä¼¼æ•°æ®åº“çš„ server-side cursorï¼‰</span><br><span class="line">æ³¨æ„ï¼šæ¸¸æ ‡ä¸»è¦ç”¨äº FT.AGGREGATEï¼Œæ™®é€š FT.SEARCH ä¸æ”¯æŒæ¸¸æ ‡åˆ†é¡µã€‚</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>é€šè¿‡ <code>FT.AGGREGATE ... WITHCURSOR</code> åˆ›å»ºæ¸¸æ ‡ï¼Œé€šè¿‡ <code>FT.CURSOR READ</code> è·å–ç»“æœã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">FT.AGGREGATE idx:user <span class="string">&quot;*&quot;</span></span><br><span class="line">  GROUPBY 1 @status</span><br><span class="line">  REDUCE SUM 1 @amount AS total_amount</span><br><span class="line">  WITHCURSOR COUNT 2 MAXIDLE 60000</span><br><span class="line"><span class="comment">## å‚æ•°è¯´æ˜</span></span><br><span class="line"><span class="comment"># WITHCURSOR : å¯ç”¨æ¸¸æ ‡</span></span><br><span class="line"><span class="comment"># COUNT 2 : æ¯æ¬¡ä»æ¸¸æ ‡ä¸­è¿”å›çš„è¡Œæ•°ï¼ˆæ‰¹å¤§å°ï¼‰</span></span><br><span class="line"><span class="comment"># MAXIDLE 60000 : æ¸¸æ ‡æœ€å¤§ç©ºé—²æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œè¶…æ—¶åè‡ªåŠ¨é”€æ¯</span></span><br><span class="line"><span class="comment">## è¿”å›ç»“æœ</span></span><br><span class="line">1) 1) (<span class="built_in">integer</span>) 3   <span class="comment"># GROUP BY åï¼Œä¸€å…±ä¼šäº§ç”Ÿ 3 è¡Œèšåˆç»“æœï¼Œè¿™é‡Œè¿”å›çš„æ˜¯å®é™…æŸ¥è¯¢çš„æ€»è¡Œæ•°ï¼Œä¸å—COUNT å‚æ•°é™åˆ¶</span></span><br><span class="line">   2) 1) <span class="string">&quot;status&quot;</span></span><br><span class="line">      2) <span class="string">&quot;CANCELLED&quot;</span></span><br><span class="line">      3) <span class="string">&quot;total_amount&quot;</span></span><br><span class="line">      4) <span class="string">&quot;79.8&quot;</span></span><br><span class="line">   3) 1) <span class="string">&quot;status&quot;</span></span><br><span class="line">      2) <span class="string">&quot;PAID&quot;</span></span><br><span class="line">      3) <span class="string">&quot;total_amount&quot;</span></span><br><span class="line">      4) <span class="string">&quot;4096.89&quot;</span></span><br><span class="line">2) (<span class="built_in">integer</span>) 116452546  <span class="comment"># æ¸¸æ ‡ID</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å–æ¸¸æ ‡</span></span><br><span class="line">FT.CURSOR READ idx:user 116452546 COUNT 2</span><br><span class="line"><span class="comment"># å‚æ•°è¯´æ˜</span></span><br><span class="line"><span class="comment"># 116452546 : æ¸¸æ ‡ID</span></span><br><span class="line"><span class="comment"># COUNT 2 : æ¯æ¬¡ä»æ¸¸æ ‡ä¸­è¿”å›çš„è¡Œæ•°(å¯è¦†ç›–åˆå§‹æ¸¸æ ‡ä¸­çš„ COUNTï¼‰</span></span><br><span class="line"><span class="comment">## è¿”å›ç»“æœ</span></span><br><span class="line">1) 1) (<span class="built_in">integer</span>) 0   <span class="comment"># å½“å‰æ¸¸æ ‡ä¸­â€œå‰©ä½™å¯è¯»çš„è¡Œæ•°â€ä¸º 0</span></span><br><span class="line">   2) 1) <span class="string">&quot;status&quot;</span></span><br><span class="line">      2) <span class="string">&quot;CREATED&quot;</span></span><br><span class="line">      3) <span class="string">&quot;total_amount&quot;</span></span><br><span class="line">      4) <span class="string">&quot;238.8&quot;</span></span><br><span class="line">2) (<span class="built_in">integer</span>) 0 <span class="comment"># 0 è¡¨ç¤ºæ²¡æœ‰æ›´å¤šç»“æœ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é”€æ¯æ¸¸æ ‡ï¼Œå¦‚æœè®¾ç½®äº† MAXIDLE å‚æ•°ï¼Œåˆ™è¯¥æ¸¸æ ‡åœ¨ MAXIDLE æ—¶é—´å†…è‡ªåŠ¨é”€æ¯ï¼Œæ‰€ä»¥æ— éœ€æ‰‹å·¥é”€æ¯</span></span><br><span class="line">FT.CURSOR DEL idx:user 116452546</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AggregationResult</span> <span class="variable">result</span> <span class="operator">=</span> rSearch.aggregate(</span><br><span class="line">        <span class="string">&quot;idx:user&quot;</span>,</span><br><span class="line">        <span class="string">&quot;*&quot;</span>,</span><br><span class="line">        AggregationOptions.defaults()</span><br><span class="line">                .groupBy(GroupBy.fieldNames(<span class="string">&quot;@status&quot;</span>)</span><br><span class="line">                        .reducers(</span><br><span class="line">                                Reducer.sum(<span class="string">&quot;@amount&quot;</span>).as(<span class="string">&quot;total_amount&quot;</span>)</span><br><span class="line">                        )</span><br><span class="line">                )</span><br><span class="line">                .withCursor(<span class="number">2</span>, <span class="number">60000</span>)</span><br><span class="line">);</span><br><span class="line"><span class="type">long</span> total;</span><br><span class="line"><span class="type">long</span> cursorId;</span><br><span class="line">List&lt;Map&lt;String, Object&gt;&gt; attributes;</span><br><span class="line"></span><br><span class="line">total = result.getTotal();</span><br><span class="line">cursorId = result.getCursorId();</span><br><span class="line">System.out.println(<span class="string">&quot;total = &quot;</span> + total);</span><br><span class="line">System.out.println(<span class="string">&quot;cursorId = &quot;</span> + cursorId);</span><br><span class="line">attributes = result.getAttributes();</span><br><span class="line"><span class="keyword">for</span> (Map&lt;String, Object&gt; attribute : attributes) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;attribute = &quot;</span> + attribute);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (cursorId != <span class="number">0</span>) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;===============================================&quot;</span>);</span><br><span class="line">    <span class="comment">// æ¸¸æ ‡è¯»å–ï¼ŒRedissonçš„readCursoræ–¹æ³•æœ‰bugï¼Œæ— æ³•ç»§ç»­è¯»å–æ¸¸æ ‡æ•°æ®</span></span><br><span class="line">    <span class="comment">// result = rSearch.readCursor(&quot;idx:user&quot;, cursorId, 2);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œæ¸¸æ ‡è¯»å–å¯ä»¥è‡ªå·±ç¼–å†™ä¸€ä¸ªåŸºäºLua çš„å®ç°</span></span><br><span class="line">    result = readCursor(<span class="string">&quot;idx:user&quot;</span>, cursorId, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    total = result.getTotal();</span><br><span class="line">    cursorId = result.getCursorId();</span><br><span class="line">    System.out.println(<span class="string">&quot;total = &quot;</span> + total);</span><br><span class="line">    System.out.println(<span class="string">&quot;cursorId = &quot;</span> + cursorId);</span><br><span class="line">    attributes = result.getAttributes();</span><br><span class="line">    <span class="keyword">for</span> (Map&lt;String, Object&gt; attribute : attributes) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;attribute = &quot;</span> + attribute);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// cursorId=0 æˆ– åˆ°æœŸ æ—¶ä¼šè‡ªåŠ¨åˆ é™¤æ¸¸æ ‡ï¼Œæ­¤å¤„æ— éœ€åˆ é™¤</span></span><br><span class="line"><span class="comment">// rSearch.delCursor(&quot;idx:user&quot;, cursorId);</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> AggregationResult <span class="title function_">readCursor</span><span class="params">(String indexName, <span class="type">long</span> cursorId, <span class="type">int</span> count)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;FT.CURSOR&#x27;, &#x27;READ&#x27;, KEYS[1], ARGV[1], &#x27;COUNT&#x27;, ARGV[2])&quot;</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;Object&gt; results = stringRedisTemplate.execute(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, List.class),</span><br><span class="line">            Collections.singletonList(indexName),</span><br><span class="line">            String.valueOf(cursorId),</span><br><span class="line">            String.valueOf(count)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    cursorId = (<span class="type">long</span>) results.get(<span class="number">1</span>);</span><br><span class="line">    List&lt;Object&gt; lo = (List) results.get(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AggregationResult</span>(</span><br><span class="line">            (<span class="type">long</span>) lo.get(<span class="number">0</span>),</span><br><span class="line">            toListOfMap(lo),</span><br><span class="line">            cursorId</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">toListOfMap</span><span class="params">(List&lt;Object&gt; lo)</span> &#123;</span><br><span class="line">    List&lt;Map&lt;String, Object&gt;&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lo == <span class="literal">null</span> || lo.size() &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»ç´¢å¼• 1 å¼€å§‹ï¼Œè·³è¿‡èšåˆæ€»æ•°</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; lo.size(); i++) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">rowObj</span> <span class="operator">=</span> lo.get(i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(rowObj <span class="keyword">instanceof</span> List&lt;?&gt; row)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; row.size() - <span class="number">1</span>; j += <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> String.valueOf(row.get(j));</span><br><span class="line">            <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> row.get(j + <span class="number">1</span>);</span><br><span class="line">            map.put(key, value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        result.add(map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å®Œæ•´ç”Ÿå‘½å‘¨æœŸæ€»ç»“</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FT.AGGREGATE ... WITHCURSOR      <span class="comment"># åˆ›å»ºæ¸¸æ ‡ï¼ˆå¹¶è¿”å›ç¬¬ä¸€æ‰¹ + cursorIdï¼‰</span></span><br><span class="line">        â†“</span><br><span class="line">FT.CURSOR READ                  <span class="comment"># è¯»å–ç¬¬ N æ‰¹</span></span><br><span class="line">        â†“</span><br><span class="line">FT.CURSOR READ                  <span class="comment"># ç»§ç»­è¯»å–</span></span><br><span class="line">        â†“</span><br><span class="line">FT.CURSOR DELï¼ˆå¯é€‰ï¼‰           <span class="comment"># æå‰é‡Šæ”¾èµ„æº</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ¸¸æ ‡ä¸ OFFSET/LIMIT çš„åŒºåˆ«</p></li></ul><table><thead><tr><th>å¯¹æ¯”é¡¹</th><th>æ¸¸æ ‡</th><th>OFFSET / LIMIT</th></tr></thead><tbody><tr><td>æ€§èƒ½</td><td>é«˜ï¼ˆæµå¼ï¼‰</td><td>å¤§ OFFSET æ€§èƒ½å·®</td></tr><tr><td>é€‚åˆå¤§ç»“æœé›†</td><td>æ˜¯</td><td>å¦</td></tr><tr><td>æœåŠ¡å™¨çŠ¶æ€</td><td>æœ‰</td><td>æ— </td></tr><tr><td>é€‚ç”¨å‘½ä»¤</td><td>FT.AGGREGATE</td><td>FT.SEARCH</td></tr></tbody></table><h3 id="äº”ã€è¯å…¸-åŒä¹‰è¯ï¼ˆæœç´¢å¢å¼ºï¼‰">äº”ã€è¯å…¸ &amp; åŒä¹‰è¯ï¼ˆæœç´¢å¢å¼ºï¼‰</h3><ul class="lvl-0"><li class="lvl-2"><p>è¯å…¸ï¼ˆDICTï¼‰å’ŒåŒä¹‰è¯ï¼ˆSYNONYMï¼‰åªå¯¹ TEXT / TAG æœç´¢ç”Ÿæ•ˆ</p></li><li class="lvl-2"><p>ä¸ <code>FT.AGGREGATE</code> æ— å…³ï¼Œä½†ä¸ <code>FT.SEARCH</code> å¼ºç›¸å…³ã€‚</p></li></ul><table><thead><tr><th>å‘½ä»¤</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td><code>FT.DICTADD</code></td><td>æ·»åŠ è¯</td></tr><tr><td><code>FT.DICTDEL</code></td><td>åˆ é™¤è¯</td></tr><tr><td><code>FT.DICTDUMP</code></td><td>æŸ¥çœ‹è¯å…¸</td></tr><tr><td><code>FT.SYNUPDATE</code></td><td>æ›´æ–°åŒä¹‰è¯</td></tr><tr><td><code>FT.SYNDUMP</code></td><td>æŸ¥çœ‹åŒä¹‰è¯</td></tr></tbody></table><h4 id="è¯å…¸">è¯å…¸</h4><ul class="lvl-0"><li class="lvl-2"><p>è¯å…¸ä½œç”¨ï¼šæ§åˆ¶â€œåˆæ³•æœç´¢è¯â€ï¼Œæ¯”å¦‚å°†è¯å…¸çš„å†…å®¹å‘é€ç»™ç”¨æˆ·ï¼Œè®©ç”¨æˆ·åªèƒ½æœç´¢è¿™äº›è¯ã€‚</p><ul class="lvl-2"><li class="lvl-4">âš ï¸ è¯å…¸æœ¬èº«ä¸å‚ä¸æœç´¢åŒ¹é…</li><li class="lvl-4">âš ï¸ åªæ˜¯ä¸ºæœç´¢å¢å¼ºæä¾›æ•°æ®æ¥æº</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¤ºä¾‹ï¼šæ·»åŠ å•†å“ç›¸å…³è¯</span></span><br><span class="line">FT.DICTADD product_dict iphone mobile phone android huawei</span><br><span class="line"><span class="comment"># æŸ¥çœ‹è¯å…¸å†…å®¹ï¼ˆFT.DICTDUMPï¼‰</span></span><br><span class="line">FT.DICTDUMP product_dict</span><br><span class="line"><span class="comment"># åˆ é™¤è¯å…¸ä¸­çš„è¯ï¼ˆFT.DICTDELï¼‰</span></span><br><span class="line">FT.DICTDEL product_dict iphone</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rSearch.addDict(<span class="string">&quot;product_dict&quot;</span>, <span class="string">&quot;iphone&quot;</span>, <span class="string">&quot;mobile&quot;</span>,<span class="string">&quot;phone&quot;</span>,<span class="string">&quot;android&quot;</span>,<span class="string">&quot;huawei&quot;</span>);</span><br><span class="line">List&lt;String&gt; productDict = rSearch.dumpDict(<span class="string">&quot;product_dict&quot;</span>);</span><br><span class="line">rSearch.delDict(<span class="string">&quot;product_dict&quot;</span>, <span class="string">&quot;iphone&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="åŒä¹‰è¯">åŒä¹‰è¯</h4><ul class="lvl-0"><li class="lvl-2"><p>åŒä¹‰è¯çš„ä½œç”¨: è®©ä¸åŒçš„æœç´¢è¯ å‘½ä¸­åŒä¸€æ‰¹æ–‡æ¡£</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ä¾‹å¦‚ï¼š</span><br><span class="line">  æœ iphone</span><br><span class="line">  æœ mobile</span><br><span class="line">  æœ phone</span><br><span class="line"></span><br><span class="line">  ğŸ‘‰ å‘½ä¸­åŒä¸€æ‰¹è®¢å•</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ·»åŠ  / æ›´æ–°åŒä¹‰è¯ï¼ˆFT.SYNUPDATEï¼‰</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®šä¹‰â€œæ‰‹æœºâ€çš„åŒä¹‰è¯é›†åˆï¼Œæ³¨æ„åŒä¹‰è¯æ˜¯ç»‘å®šåˆ° ç´¢å¼• çš„</span></span><br><span class="line">FT.SYNUPDATE idx:user</span><br><span class="line">  phone_group</span><br><span class="line">  iphone mobile phone</span><br><span class="line"><span class="comment">## å‚æ•°è¯´æ˜</span></span><br><span class="line"><span class="comment"># phone_group: åŒä¹‰è¯é›†åˆåç§°ï¼ˆä½ è‡ªå·±å®šä¹‰ï¼‰</span></span><br><span class="line"><span class="comment"># iphone mobile phone: æ·»åŠ åŒä¹‰è¯ï¼Œå¤šä¸ªè¯ç”¨ç©ºæ ¼éš”å¼€</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹åŒä¹‰è¯é›†åˆ</span></span><br><span class="line">FT.SYNDUMP idx:user</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">1) <span class="string">&quot;phone&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;phone_group&quot;</span></span><br><span class="line">3) <span class="string">&quot;iphone&quot;</span></span><br><span class="line">4) 1) <span class="string">&quot;phone_group&quot;</span></span><br><span class="line">5) <span class="string">&quot;mobile&quot;</span></span><br><span class="line">6) 1) <span class="string">&quot;phone_group&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rSearch.updateSynonyms(<span class="string">&quot;idx:user&quot;</span>, <span class="string">&quot;phone_group&quot;</span>, <span class="string">&quot;iphone&quot;</span>, <span class="string">&quot;mobile&quot;</span>, <span class="string">&quot;phone&quot;</span>);</span><br><span class="line">Map&lt;String, List&lt;String&gt;&gt; synonyms = rSearch.dumpSynonyms(<span class="string">&quot;idx:user&quot;</span>);</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ­¤æ—¶æˆ‘ä»¬å†è¿›è¡Œæœç´¢ï¼Œå°±ä¼šå‘½ä¸­æ‰€æœ‰åŒä¹‰è¯</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">FT.SEARCH idx:user <span class="string">&#x27;phone&#x27;</span></span><br><span class="line"><span class="comment"># æœç´¢ç»“æœ</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 4</span><br><span class="line">2) <span class="string">&quot;user:10001&quot;</span></span><br><span class="line">3) 1) <span class="string">&quot;$&quot;</span></span><br><span class="line">   2) <span class="string">&quot;&#123;\&quot;name\&quot;:\&quot;Alice Bob\&quot;,\&quot;age\&quot;:28,\&quot;vip\&quot;:\&quot;yes\&quot;,\&quot;orders\&quot;:[&#123;\&quot;amount\&quot;:199.99,\&quot;status\&quot;:\&quot;PAID\&quot;&#125;,&#123;\&quot;amount\&quot;:59.9,\&quot;status\&quot;:\&quot;CREATED\&quot;&#125;],\&quot;comment\&quot;:\&quot;I have a phone\&quot;,\&quot;items\&quot;:[\&quot;SpringCloud\xe6\x8a\x80\xe6\x9c\xaf\xe6\x8c\x87\xe5\x8d\x97\&quot;,\&quot;Shell\xe8\x84\x9a\xe6\x9c\xac\xe5\x9f\xba\xe7\xa1\x80\&quot;]&#125;&quot;</span></span><br><span class="line">4) <span class="string">&quot;user:10006&quot;</span></span><br><span class="line">5) 1) <span class="string">&quot;$&quot;</span></span><br><span class="line">   2) <span class="string">&quot;&#123;\&quot;name\&quot;:\&quot;Frank\&quot;,\&quot;age\&quot;:27,\&quot;vip\&quot;:\&quot;no\&quot;,\&quot;orders\&quot;:[&#123;\&quot;amount\&quot;:499,\&quot;status\&quot;:\&quot;PAID\&quot;&#125;,&#123;\&quot;amount\&quot;:129,\&quot;status\&quot;:\&quot;CREATED\&quot;&#125;],\&quot;comment\&quot;:\&quot;I have a phone\&quot;,\&quot;items\&quot;:[\&quot;Redis\xe5\xbc\x80\xe5\x8f\x91\xe5\xae\x9e\xe6\x88\x98\&quot;,\&quot;MongoDB\xe4\xbb\x8e\xe5\x85\xa5\xe9\x97\xa8\xe5\x88\xb0\xe5\xae\x9e\xe6\x88\x98\&quot;]&#125;&quot;</span></span><br><span class="line">6) <span class="string">&quot;user:10002&quot;</span></span><br><span class="line">7) 1) <span class="string">&quot;$&quot;</span></span><br><span class="line">   2) <span class="string">&quot;&#123;\&quot;name\&quot;:\&quot;Bob Frank\&quot;,\&quot;age\&quot;:35,\&quot;vip\&quot;:\&quot;no\&quot;,\&quot;orders\&quot;:[&#123;\&quot;amount\&quot;:899.0,\&quot;status\&quot;:\&quot;PAID\&quot;&#125;],\&quot;comment\&quot;:\&quot;I have a iphone\&quot;,\&quot;items\&quot;:[\&quot;Linux\xe5\xbf\x85\xe7\x9f\xa5\xe5\xbf\x85\xe4\xbc\x9a\&quot;,\&quot;Java\xe5\xa4\x9a\xe7\xba\xbf\xe7\xa8\x8b\xe8\xaf\xa6\xe8\xa7\xa3\&quot;]&#125;&quot;</span></span><br><span class="line">8) <span class="string">&quot;user:10003&quot;</span></span><br><span class="line">9) 1) <span class="string">&quot;$&quot;</span></span><br><span class="line">   2) <span class="string">&quot;&#123;\&quot;name\&quot;:\&quot;Carol\&quot;,\&quot;age\&quot;:22,\&quot;vip\&quot;:\&quot;no\&quot;,\&quot;orders\&quot;:[&#123;\&quot;amount\&quot;:19.9,\&quot;status\&quot;:\&quot;CANCELLED\&quot;&#125;],\&quot;comment\&quot;:\&quot;I have a mobile\&quot;,\&quot;items\&quot;:[\&quot;MySQL\xe4\xbb\x8e\xe5\x88\xa0\xe5\xba\x93\xe5\x88\xb0\xe8\xb7\x91\xe8\xb7\xaf\&quot;,\&quot;Oracle\xe5\xbc\x80\xe5\x8f\x91\xe5\xae\x9e\xe8\xb7\xb5\&quot;]&#125;&quot;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>è¯å…¸ + åŒä¹‰è¯çš„ç»„åˆä½¿ç”¨</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. ç”¨æˆ·è¾“å…¥: æ‰‹æœº</span><br><span class="line">2. å‰ç«¯ / æœåŠ¡ç«¯ â†’ ä» product_dict ç»™æç¤º</span><br><span class="line">3. æœç´¢è¯·æ±‚ â†’ FT.SEARCH</span><br><span class="line">4. RediSearch â†’ åŒä¹‰è¯æ‰©å±•</span><br><span class="line">5. è¿”å›ç»Ÿä¸€ç»“æœ</span><br></pre></td></tr></table></figure><h3 id="å·²åºŸå¼ƒå‘½ä»¤ï¼ˆä¸å»ºè®®ä½¿ç”¨ï¼‰">å·²åºŸå¼ƒå‘½ä»¤ï¼ˆä¸å»ºè®®ä½¿ç”¨ï¼‰</h3><table><thead><tr><th>å‘½ä»¤</th><th>çŠ¶æ€</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>FT.CONFIG GET</code></td><td>Deprecated</td><td>ä½¿ç”¨ <code>CONFIG GET</code></td></tr><tr><td><code>FT.CONFIG SET</code></td><td>Deprecated</td><td>åŒä¸Š</td></tr><tr><td><code>FT.TAGVALS</code></td><td>Deprecated</td><td>æ”¹ç”¨ AGGREGATE</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡ä»‹ç» Redis æ‰©å±•æ¨¡å— â€“ RediSearch çš„ä½¿ç”¨æ–¹æ³•&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡åŸºäº&lt;code&gt;redis-7.4.7&lt;/code&gt;ï¼Œ&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æ“ä½œç³»ç»Ÿï¼š&lt;code&gt;Amazon Linux 2023(å†…æ ¸ 6.1)&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Rediså®˜ç½‘ï¼š&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis å‘½ä»¤æ–‡æ¡£ï¼š&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;RediSearch çš„å®‰è£…å‚è§ &lt;a href=&quot;/2025/12/26/redis7-module-RediSearch/&quot; title=&quot;Redis æ‰©å±•æ¨¡å— -- RediSearch çš„å®‰è£…æ–¹æ³•&quot;&gt;Redis æ‰©å±•æ¨¡å— -- RediSearch çš„å®‰è£…æ–¹æ³•&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;ç¤ºä¾‹ä»£ç ï¼š&lt;a href=&quot;https://github.com/hanqunfeng/springbootchapter/tree/master/springboot3-demo/redis-demo/redisson-demo&quot;&gt;GitHub&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis æ‰©å±•æ¨¡å— -- RediSearch çš„å®‰è£…æ–¹æ³•</title>
    <link href="https://blog.hanqunfeng.com/2025/12/26/redis7-module-RediSearch/"/>
    <id>https://blog.hanqunfeng.com/2025/12/26/redis7-module-RediSearch/</id>
    <published>2025-12-26T13:30:05.000Z</published>
    <updated>2026-01-05T02:45:41.913Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2">æœ¬æ–‡ä»‹ç» Redis æ‰©å±•æ¨¡å— â€“ RediSearch çš„å®‰è£…æ–¹æ³•</li><li class="lvl-2">æœ¬æ–‡åŸºäº<code>redis-7.4.7</code>ï¼Œ<code>springboot-3.5.8</code></li><li class="lvl-2">æ“ä½œç³»ç»Ÿï¼š<code>Amazon Linux 2023(å†…æ ¸ 6.1)</code></li><li class="lvl-2">Rediså®˜ç½‘ï¼š<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis å‘½ä»¤æ–‡æ¡£ï¼š<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li></ul><span id="more"></span><h2 id="RediSearch-ç®€ä»‹">RediSearch ç®€ä»‹</h2><ul class="lvl-0"><li class="lvl-2"><p><a href="https://github.com/RediSearch/RediSearch">RediSearch</a> æ˜¯ Redis å®˜æ–¹æ¨å‡ºçš„ <code>å…¨æ–‡æœç´¢</code>ä¸<code>äºŒçº§ç´¢å¼•</code>æ¨¡å—ï¼Œç”¨äºåœ¨ Redis ä¹‹ä¸Šæä¾›ç±»ä¼¼<code>æœç´¢å¼•æ“</code>çš„èƒ½åŠ›ï¼Œè§£å†³â€œåªèƒ½æŒ‰ key æŸ¥ã€æ— æ³•é«˜æ•ˆæŒ‰å­—æ®µæŸ¥è¯¢â€çš„é—®é¢˜ã€‚å®ƒæ˜¯ Redis Stack çš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œå¸¸ç”¨äºæœç´¢ã€è¿‡æ»¤ã€æ’åºå’Œèšåˆåœºæ™¯ã€‚ä»…æ”¯æŒå¯¹ Hash å’Œ RedisJSON ç±»å‹è¿›è¡Œç´¢å¼•ã€‚</p></li><li class="lvl-2"><p>è¯¥æ¨¡å—ä»¥ <code>Redis Module</code> æ–¹å¼åŠ è½½ï¼Œå¯æ— ç¼é›†æˆåˆ°ç°æœ‰ Redis å®ä¾‹ä¸­ã€‚</p></li><li class="lvl-2"><p>Redis8+ï¼ŒRediSearch å·²ç»å†…ç½®åœ¨ Redis ä¸­ï¼Œå¯ä»¥åœ¨å®‰è£…redisåŒæ—¶å®‰è£…å…¨éƒ¨ Stack æ¨¡å—ã€‚</p></li><li class="lvl-2"><p>RediSearch é€šè¿‡ <code>ç´¢å¼•ç»“æ„</code> + <code>æŸ¥è¯¢è¯­è¨€</code>ï¼Œæä¾›ï¼š</p><ul class="lvl-2"><li class="lvl-4">å…¨æ–‡æœç´¢ï¼ˆText Searchï¼‰</li><li class="lvl-4">äºŒçº§ç´¢å¼•ï¼ˆæŒ‰å­—æ®µæŸ¥è¯¢ï¼‰</li><li class="lvl-4">å¤šæ¡ä»¶è¿‡æ»¤ / æ’åº</li><li class="lvl-4">èšåˆåˆ†æï¼ˆGROUP BYã€COUNTã€SUM ç­‰ï¼‰</li></ul></li><li class="lvl-2"><p>æ€§èƒ½ä¸è®¾è®¡ç‰¹ç‚¹</p><ul class="lvl-2"><li class="lvl-4">ç´¢å¼•åœ¨å†…å­˜ä¸­ï¼ŒæŸ¥è¯¢å»¶è¿Ÿä½ï¼ˆæ¯«ç§’çº§ï¼‰</li><li class="lvl-4">å†™å…¥æ—¶åŒæ­¥æ›´æ–°ç´¢å¼•ï¼ˆå†™å…¥æˆæœ¬ç•¥é«˜ï¼‰</li><li class="lvl-4">é€‚åˆ è¯»å¤šå†™å°‘ / æŸ¥è¯¢å¤æ‚ çš„ä¸šåŠ¡</li><li class="lvl-4">éäº‹åŠ¡å‹æœç´¢å¼•æ“ï¼ˆä¸æ›¿ä»£ ESï¼Œè€Œæ˜¯äº’è¡¥ï¼‰</li></ul></li><li class="lvl-2"><p>ä¸åŸç”Ÿ Redis çš„å¯¹æ¯”</p></li></ul><table><thead><tr><th>ç»´åº¦</th><th>Redis åŸç”Ÿ</th><th>RediSearch</th></tr></thead><tbody><tr><td>æŸ¥è¯¢æ–¹å¼</td><td>key ç²¾ç¡®</td><td>å¤šå­—æ®µæŸ¥è¯¢</td></tr><tr><td>å…¨æ–‡æœç´¢</td><td>ä¸æ”¯æŒ</td><td>æ”¯æŒ</td></tr><tr><td>èŒƒå›´æŸ¥è¯¢</td><td>æœ‰é™</td><td>å¼º</td></tr><tr><td>èšåˆç»Ÿè®¡</td><td>åŸºæœ¬æ²¡æœ‰</td><td>ç±» SQL</td></tr><tr><td>æ€§èƒ½</td><td>æå¿«</td><td>è¿‘å®æ—¶ï¼Œå†…å­˜æ¢æ€§èƒ½</td></tr></tbody></table><h2 id="RediSearch-vs-Elasticsearch">RediSearch vs Elasticsearch</h2><table><thead><tr><th>å¯¹æ¯”ç‚¹</th><th>RediSearch</th><th>Elasticsearch</th></tr></thead><tbody><tr><td>éƒ¨ç½²å¤æ‚åº¦</td><td>ä½</td><td>é«˜</td></tr><tr><td>å»¶è¿Ÿ</td><td>æä½</td><td>è¾ƒé«˜</td></tr><tr><td>æ•°æ®è§„æ¨¡</td><td>ä¸­å°è§„æ¨¡</td><td>è¶…å¤§è§„æ¨¡</td></tr><tr><td>å®æ—¶æ€§</td><td>å¼º</td><td>è¿‘å®æ—¶</td></tr><tr><td>åœºæ™¯</td><td>ä¸šåŠ¡å†…æœç´¢</td><td>æœç´¢å¹³å°</td></tr></tbody></table><h2 id="å®‰è£…-RediSearch">å®‰è£… RediSearch</h2><ul class="lvl-0"><li class="lvl-2"><p>æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯ä»<a href="https://cloud.redis.io">Redis Cloud</a>çš„<code>Download Center</code>ä¸­è¿›è¡Œä¸‹è½½ï¼Œå…¶æä¾›äº†æ‰€æœ‰Redisæ¨¡å—ç¼–è¯‘åçš„<code>.so</code>æ–‡ä»¶ï¼Œå¯ä»¥ä¼˜å…ˆè¿›è¡Œå°è¯•ï¼Œä½†æ˜¯å¹¶ä¸ä¿è¯ä¸€å®šå…¼å®¹ï¼Œæ‰€ä»¥æœ€ç¨³å¦¥çš„æ–¹å¼æ˜¯é€šè¿‡æºç è‡ªå·±ç¼–è¯‘ã€‚<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/rguEIA.png" alt=""></p></li><li class="lvl-2"><p>æºç ç¼–è¯‘</p></li></ul><blockquote><p>å®‰è£…æ—¶éœ€è¦ç§‘å­¦ä¸Šç½‘ï¼Œä¸»è¦æ˜¯å®‰è£…ä¾èµ–æ—¶éœ€è¦ä»æµ·å¤–ç½‘ä¸‹è½½ï¼Œå¦‚æœè¦éƒ¨ç½²åœ¨å›½å†…æœåŠ¡å™¨ï¼Œå¯èƒ½ä¼šè¿æ¥å¤±è´¥ã€‚<br>å¯ä»¥åœ¨æµ·å¤–çš„<code>ç›¸åŒé…ç½®</code>çš„æœåŠ¡å™¨ä¸Šè¿›è¡Œç¼–è¯‘ï¼Œä¹‹åå°†ç¼–è¯‘å¥½çš„<code>redisearch.so</code>ä¸Šä¼ åˆ°å›½å†…æœåŠ¡å™¨å³å¯ã€‚</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>å®‰è£…ä¾èµ–</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dnf install -y \</span><br><span class="line">  gcc \</span><br><span class="line">  gcc-c++ \</span><br><span class="line">  make \</span><br><span class="line">  cmake \</span><br><span class="line">  autoconf \</span><br><span class="line">  automake \</span><br><span class="line">  libtool \</span><br><span class="line">  pkgconfig \</span><br><span class="line">  openssl-devel \</span><br><span class="line">  libstdc++ \</span><br><span class="line">  libstdc++-devel</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>RediSearch æœ€æ–°ç‰ˆæœ¬ ä¾èµ– CMake 3.25+ï¼Œdnfæºä¸­çš„ç‰ˆæœ¬è¾ƒä½ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦æ‰‹åŠ¨å®‰è£…</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CMAKE_VERSION=3.25.1</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /usr/local/src</span><br><span class="line">wget https://github.com/Kitware/CMake/releases/download/v<span class="variable">$&#123;CMAKE_VERSION&#125;</span>/cmake-<span class="variable">$&#123;CMAKE_VERSION&#125;</span>.tar.gz</span><br><span class="line">tar -xf cmake-<span class="variable">$&#123;CMAKE_VERSION&#125;</span>.tar.gz</span><br><span class="line"><span class="built_in">cd</span> cmake-<span class="variable">$&#123;CMAKE_VERSION&#125;</span></span><br><span class="line"></span><br><span class="line">./bootstrap --prefix=/usr/local</span><br><span class="line">make -j$(<span class="built_in">nproc</span>)</span><br><span class="line"><span class="built_in">sudo</span> make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯ç‰ˆæœ¬ /usr/local/bin/cmake</span></span><br><span class="line">/usr/local/bin/cmake --version</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¼–è¯‘RediSearch</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /usr/local/soft/modules/</span><br><span class="line"><span class="built_in">cd</span> /usr/local/soft/modules</span><br><span class="line"><span class="comment"># clone ä»£ç ï¼Œè¿™é‡Œ --recursive æ˜¯ä¸ºäº†æ‹‰å–å­æ¨¡å—</span></span><br><span class="line">git <span class="built_in">clone</span> --recursive https://github.com/RediSearch/RediSearch.git</span><br><span class="line"><span class="built_in">cd</span> RediSearch</span><br><span class="line"><span class="comment"># æ¨èåˆ‡æ¢åˆ°ç¨³å®šçš„releaseç‰ˆæœ¬</span></span><br><span class="line">git checkout v2.10.25</span><br><span class="line"><span class="comment"># æ›´æ–°å­æ¨¡å—ï¼Œéå¿…é¡»ï¼Œå¦‚æœä¸Šé¢ clone æ—¶æ²¡æœ‰åŠ ä¸Š --recursive ï¼Œè¿™ä¸ªæ­¥éª¤å°±ä¸èƒ½çœç•¥</span></span><br><span class="line">git submodule update --init --recursive</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º build_dir ç›®å½•ï¼Œç¼–è¯‘å¤±è´¥è¦å…ˆåˆ é™¤è¯¥ç›®å½•åœ¨é‡æ–°åˆ›å»º</span></span><br><span class="line"><span class="built_in">mkdir</span> build_dir &amp;&amp; <span class="built_in">cd</span> build_dir</span><br><span class="line"><span class="comment"># ç”Ÿæˆ Makefile</span></span><br><span class="line">/usr/local/bin/cmake .. \</span><br><span class="line">  -DCMAKE_BUILD_TYPE=Release \</span><br><span class="line">  -DCMAKE_C_COMPILER=gcc \</span><br><span class="line">  -DCMAKE_CXX_COMPILER=g++</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘ RediSearch</span></span><br><span class="line">make -j$(<span class="built_in">nproc</span>)</span><br><span class="line"><span class="comment"># ç¼–è¯‘è¿‡ç¨‹ä¼šæŠ¥é”™ï¼ŒåŒæ ·åœ¨ Rocky9 ä¸Šä¹Ÿä¼šé‡åˆ°è¿™ä¸ªé—®é¢˜</span></span><br><span class="line">[100%] Linking CXX shared library redisearch.so</span><br><span class="line">/usr/bin/ld: cannot find -lstdc++: No such file or directory</span><br><span class="line">collect2: error: ld returned 1 <span class="built_in">exit</span> status</span><br><span class="line">make[2]: *** [CMakeFiles/redisearch.dir/build.make:557: redisearch.so] Error 1</span><br><span class="line">make[1]: *** [CMakeFiles/Makefile2:2958: CMakeFiles/redisearch.dir/all] Error 2</span><br><span class="line">make: *** [Makefile:136: all] Error 2</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¼–è¯‘é”™è¯¯åŸå› åˆ†æ</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RediSearch 2.10.x åœ¨é“¾æ¥ redisearch.so æ—¶ å¼ºåˆ¶ ä½¿ç”¨ -static-libstdc++ï¼Œè€Œ libstdc++.a é™æ€æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¯¼è‡´ç¼–è¯‘å¤±è´¥</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>è§£å†³æ–¹æ³•æ˜¯å®‰è£…é™æ€åº“</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dnf install -y libstdc++-static</span><br><span class="line"><span class="comment"># éªŒè¯é™æ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="built_in">ls</span> /usr/lib/gcc/x86_64-amazon-linux/*/libstdc++.a</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">/usr/lib/gcc/x86_64-amazon-linux/11/libstdc++.a</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å®‰è£…åé‡æ–°ç¼–è¯‘RediSearch</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/soft/modules</span><br><span class="line"><span class="comment"># åˆ é™¤ build_dir ç›®å½•</span></span><br><span class="line"><span class="built_in">rm</span> -rf build_dir</span><br><span class="line"><span class="comment"># åˆ›å»º build_dir ç›®å½•ï¼Œç¼–è¯‘å¤±è´¥è¦å…ˆåˆ é™¤è¯¥ç›®å½•å†é‡æ–°åˆ›å»º</span></span><br><span class="line"><span class="built_in">mkdir</span> build_dir &amp;&amp; <span class="built_in">cd</span> build_dir</span><br><span class="line"><span class="comment"># ç”Ÿæˆ Makefile</span></span><br><span class="line">/usr/local/bin/cmake .. \</span><br><span class="line">  -DCMAKE_BUILD_TYPE=Release \</span><br><span class="line">  -DCMAKE_C_COMPILER=gcc \</span><br><span class="line">  -DCMAKE_CXX_COMPILER=g++</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘ RediSearchï¼Œå¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œåˆ™è¯´æ˜ç¼–è¯‘æˆåŠŸï¼Œè¾“å‡º: build_dir/redisearch.so</span></span><br><span class="line">make -j$(<span class="built_in">nproc</span>)</span><br></pre></td></tr></table></figure><h2 id="Redis-å¯ç”¨æ¨¡å—">Redis å¯ç”¨æ¨¡å—</h2><ul class="lvl-0"><li class="lvl-2"><p>å°†ç”Ÿæˆçš„ <code>redisearch.so</code> æ‹·è´åˆ° redis çš„ modules ç›®å½•ä¸‹ï¼ˆéå¿…é¡»ï¼‰ï¼Œç›®å½•ä¸å­˜åœ¨åˆ™åˆ›å»º</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ³¨æ„ .so æ–‡ä»¶éœ€è¦åŒ…å«å¯æ‰§è¡Œæƒé™</span></span><br><span class="line"><span class="built_in">cp</span> build_dir/redisearch.so /usr/local/soft/redis-7.4.7/modules/redisearch.so</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æœ¬æ–‡é‡‡ç”¨ <code>loadmodule</code> åŠ è½½æ¨¡å—</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°† redisearch.so æ·»åŠ åˆ° redis.conf ä¸­ï¼Œéœ€è¦é‡å¯ redis</span></span><br><span class="line">loadmodule /usr/local/soft/redis-7.4.7/modules/redisearch.so</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨redis</span></span><br><span class="line">redis-server redis.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç™»å½•æµ‹è¯•</span></span><br><span class="line">redis-cli --user admin --pass 123456</span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ¨¡å—</span></span><br><span class="line">127.0.0.1:6379&gt; MODULE LIST</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">1) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;ReJSON&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 20816</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/local/soft/redis-7.4.7/modules/rejson.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">2) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;bf&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 20817</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/local/soft/redis-7.4.7/modules/redisbloom.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">3) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;search&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 21025</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/local/soft/redis-7.4.7/modules/redisearch.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br></pre></td></tr></table></figure><h2 id="Rocky9-ç¼–è¯‘å®‰è£…-RediSearch">Rocky9 ç¼–è¯‘å®‰è£… RediSearch</h2><blockquote><p>ç³»ç»Ÿç‰ˆæœ¬ï¼š<code>Rocky Linux release 9.4 (Blue Onyx)</code></p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>å®‰è£…ä¾èµ–</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dnf install -y \</span><br><span class="line">  gcc \</span><br><span class="line">  gcc-c++ \</span><br><span class="line">  make \</span><br><span class="line">  cmake \</span><br><span class="line">  autoconf \</span><br><span class="line">  automake \</span><br><span class="line">  libtool \</span><br><span class="line">  pkgconfig \</span><br><span class="line">  openssl-devel \</span><br><span class="line">  libstdc++ \</span><br><span class="line">  libstdc++-devel</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å¯ç”¨ CRB</p></li></ul><blockquote><p>åœ¨ Rocky Linux 9 ä¸­ï¼Œ<code>libstdc++-static</code> ä¸åœ¨é»˜è®¤ä»“åº“é‡Œï¼Œå®ƒä½äº CRBï¼ˆCodeReady Builderï¼‰ä»“åº“ï¼Œé»˜è®¤æ˜¯ å…³é—­çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆå¯ç”¨å®ƒ</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¦‚æœä½ ç³»ç»Ÿé‡Œæ²¡æœ‰ config-managerï¼Œéœ€è¦å…ˆå…ˆè£…</span></span><br><span class="line"><span class="built_in">sudo</span> dnf install -y dnf-plugins-core</span><br><span class="line"><span class="comment"># å¯ç”¨ CRB</span></span><br><span class="line"><span class="built_in">sudo</span> dnf config-manager --set-enabled crb</span><br><span class="line"><span class="comment"># åˆ·æ–°ç¼“å­˜</span></span><br><span class="line"><span class="built_in">sudo</span> dnf makecache</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å®‰è£…é™æ€åº“ï¼Œè§£å†³<code>/usr/bin/ld: cannot find -lstdc++: No such file or directory</code>çš„é—®é¢˜</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dnf install -y libstdc++-static</span><br><span class="line"><span class="comment"># éªŒè¯é™æ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="built_in">ls</span> /usr/lib/gcc/x86_64-redhat-linux/*/libstdc++.a</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¼–è¯‘RediSearch</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /usr/local/soft/modules/</span><br><span class="line"><span class="built_in">cd</span> /usr/local/soft/modules</span><br><span class="line"><span class="comment"># clone ä»£ç ï¼Œè¿™é‡Œ --recursive æ˜¯ä¸ºäº†æ‹‰å–å­æ¨¡å—</span></span><br><span class="line">git <span class="built_in">clone</span> --recursive https://github.com/RediSearch/RediSearch.git</span><br><span class="line"><span class="built_in">cd</span> RediSearch</span><br><span class="line"><span class="comment"># æ¨èåˆ‡æ¢åˆ°ç¨³å®šçš„releaseç‰ˆæœ¬</span></span><br><span class="line">git checkout v2.10.25</span><br><span class="line"><span class="comment"># æ›´æ–°å­æ¨¡å—ï¼Œéå¿…é¡»ï¼Œå¦‚æœä¸Šé¢ clone æ—¶æ²¡æœ‰åŠ ä¸Š --recursive ï¼Œè¿™ä¸ªæ­¥éª¤å°±ä¸èƒ½çœç•¥</span></span><br><span class="line">git submodule update --init --recursive</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º build_dir ç›®å½•ï¼Œç¼–è¯‘å¤±è´¥è¦å…ˆåˆ é™¤è¯¥ç›®å½•å†é‡æ–°åˆ›å»º</span></span><br><span class="line"><span class="built_in">mkdir</span> build_dir &amp;&amp; <span class="built_in">cd</span> build_dir</span><br><span class="line"><span class="comment"># ç”Ÿæˆ Makefile</span></span><br><span class="line">cmake .. \</span><br><span class="line">  -DCMAKE_BUILD_TYPE=Release \</span><br><span class="line">  -DCMAKE_C_COMPILER=gcc \</span><br><span class="line">  -DCMAKE_CXX_COMPILER=g++</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘ RediSearchï¼Œå¦‚æœæ²¡æœ‰é”™è¯¯ï¼Œåˆ™è¯´æ˜ç¼–è¯‘æˆåŠŸï¼Œè¾“å‡º: build_dir/redisearch.so</span></span><br><span class="line">make -j$(<span class="built_in">nproc</span>)</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡ä»‹ç» Redis æ‰©å±•æ¨¡å— â€“ RediSearch çš„å®‰è£…æ–¹æ³•&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡åŸºäº&lt;code&gt;redis-7.4.7&lt;/code&gt;ï¼Œ&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æ“ä½œç³»ç»Ÿï¼š&lt;code&gt;Amazon Linux 2023(å†…æ ¸ 6.1)&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Rediså®˜ç½‘ï¼š&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis å‘½ä»¤æ–‡æ¡£ï¼š&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Amazon Linux 2023(å†…æ ¸ 6.1) å®‰è£… Redis8</title>
    <link href="https://blog.hanqunfeng.com/2025/12/25/redis8-install-amazon-linux-2023/"/>
    <id>https://blog.hanqunfeng.com/2025/12/25/redis8-install-amazon-linux-2023/</id>
    <published>2025-12-25T13:30:05.000Z</published>
    <updated>2026-01-04T10:17:15.952Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2">æœ¬æ–‡ä»‹ç» Linux å®‰è£… Redis8 çš„æ–¹æ³•</li><li class="lvl-2">Linux ç‰ˆæœ¬ï¼š<code>Amazon Linux 2023(å†…æ ¸ 6.1)</code>ã€‚</li><li class="lvl-2">Rediså®˜ç½‘ï¼š<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2"><a href="https://redis.io/docs/latest/operate/oss_and_stack/install/install-stack/rpm/">Rediså®˜ç½‘å®‰è£…æ‰‹å†Œ</a></li></ul><span id="more"></span><h2 id="Yum-å®‰è£…">Yum å®‰è£…</h2><blockquote><p>æœ€çœäº‹ï¼Œå›½å†…ç¯å¢ƒä¹Ÿå¯ä»¥é¡ºåˆ©å®Œæˆå®‰è£…ã€‚<br><code>Amazon Linux 2023(å†…æ ¸ 6.1)</code> å’Œ <code>Rocky Linux release 9.4 (Blue Onyx)</code> å‡æˆåŠŸå®‰è£…ã€‚</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>1.æ·»åŠ ä»“åº“</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/yum.repos.d/redis.repo &gt; /dev/null &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Redis]</span></span><br><span class="line"><span class="string">name=Redis</span></span><br><span class="line"><span class="string">baseurl=http://packages.redis.io/rpm/rockylinux9</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>2.å®‰è£… Redis</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://packages.redis.io/gpg &gt; /tmp/redis.key</span><br><span class="line"><span class="built_in">sudo</span> rpm --import /tmp/redis.key</span><br><span class="line"><span class="built_in">sudo</span> yum install redis -y</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>3.æŸ¥çœ‹rediså®‰è£…ä¿¡æ¯</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å·²å®‰è£…çš„redisç‰ˆæœ¬</span></span><br><span class="line">$ rpm -qa | grep redis</span><br><span class="line">redis-8.4.0-1.x86_64</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹rediså®‰è£…ä¿¡æ¯</span></span><br><span class="line">$ rpm -qi redis-8.4.0-1.x86_64</span><br><span class="line">Name        : redis</span><br><span class="line">Version     : 8.4.0</span><br><span class="line">Release     : 1</span><br><span class="line">Architecture: x86_64</span><br><span class="line">Install Date: Wed 24 Dec 2025 06:05:22 AM UTC</span><br><span class="line">Group       : Applications/Databases</span><br><span class="line">Size        : 83034075</span><br><span class="line">License     :</span><br><span class="line">Signature   : RSA/SHA512, Mon 01 Dec 2025 12:05:10 PM UTC, Key ID 5f4349d6bf53aa0c</span><br><span class="line">Source RPM  : redis-8.4.0-1.src.rpm</span><br><span class="line">Build Date  : Tue 18 Nov 2025 04:41:58 PM UTC</span><br><span class="line">Build Host  : 331d5099e900</span><br><span class="line">Packager    : Redis Labs &lt;redis@redis.io&gt;</span><br><span class="line">URL         : https://redis.io/</span><br><span class="line">Summary     : Redis is an in-memory database that persists on disk. The data model is key-value, but many different kind of values are supported: Strings, Lists, Sets, Sorted Sets, Hashes, Streams, HyperLogLogs, Bitmaps.</span><br><span class="line">Description :</span><br><span class="line">Redis is an in-memory database that persists on disk. The data model is key-value, but many different kind of values are supported: Strings, Lists, Sets, Sorted Sets, Hashes, Streams, HyperLogLogs, Bitmaps.</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹rediså®‰è£…çš„æ–‡ä»¶</span></span><br><span class="line">$ rpm -ql redis-8.4.0-1.x86_64</span><br><span class="line">/etc/redis</span><br><span class="line">/etc/redis/redis.conf</span><br><span class="line">/etc/redis/sentinel</span><br><span class="line">/etc/redis/sentinel/sentinel.conf</span><br><span class="line">/run/redis</span><br><span class="line">/run/redis/redis-server.pid</span><br><span class="line">/usr/bin/redis-benchmark</span><br><span class="line">/usr/bin/redis-check-aof</span><br><span class="line">/usr/bin/redis-check-rdb</span><br><span class="line">/usr/bin/redis-cli</span><br><span class="line">/usr/bin/redis-sentinel</span><br><span class="line">/usr/bin/redis-server</span><br><span class="line">/usr/lib/redis</span><br><span class="line">/usr/lib/redis/modules</span><br><span class="line">/usr/lib/redis/modules/redisbloom.so</span><br><span class="line">/usr/lib/redis/modules/redisearch.so</span><br><span class="line">/usr/lib/redis/modules/redistimeseries.so</span><br><span class="line">/usr/lib/redis/modules/rejson.so</span><br><span class="line">/usr/lib/redis/redisbloom.so</span><br><span class="line">/usr/lib/redis/redisearch.so</span><br><span class="line">/usr/lib/redis/redistimeseries.so</span><br><span class="line">/usr/lib/redis/rejson.so</span><br><span class="line">/usr/lib/systemd/system/redis-sentinel.service</span><br><span class="line">/usr/lib/systemd/system/redis.service</span><br><span class="line">/usr/share/selinux/packages/redis-ce.fc</span><br><span class="line">/usr/share/selinux/packages/redis-ce.te</span><br><span class="line">/var/lib/redis</span><br><span class="line">/var/log/redis</span><br><span class="line">/var/log/redis/redis-sentinel.log</span><br><span class="line">/var/log/redis/redis-server.log</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>4.å¯åŠ¨redis</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> redis</span><br><span class="line"><span class="built_in">sudo</span> systemctl start redis</span><br><span class="line"><span class="built_in">sudo</span> systemctl status redis</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>5.ç™»å½•redis</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli</span><br><span class="line">127.0.0.1:6379&gt; MODULE LIST</span><br><span class="line">1) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;bf&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 80400</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/lib/redis/modules/redisbloom.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">2) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;timeseries&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 80400</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/lib/redis/modules/redistimeseries.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">3) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;ReJSON&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 80400</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/lib/redis/modules/rejson.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">4) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;vectorset&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 1</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">5) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;search&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 80402</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/lib/redis/modules/redisearch.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br></pre></td></tr></table></figure><h2 id="æºç å®‰è£…">æºç å®‰è£…</h2><ul class="lvl-0"><li class="lvl-2"><p>1.æ›´æ–°ç¯å¢ƒ(éå¿…é¡»)</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dnf update -y</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>2.å®‰è£…ä¾èµ–åŒ…</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dnf install -y --nobest --skip-broken \</span><br><span class="line">    pkg-config \</span><br><span class="line">    xz \</span><br><span class="line">    wget \</span><br><span class="line">    <span class="built_in">which</span> \</span><br><span class="line">    git \</span><br><span class="line">    make \</span><br><span class="line">    openssl \</span><br><span class="line">    openssl-devel \</span><br><span class="line">    python3 \</span><br><span class="line">    python3-pip \</span><br><span class="line">    python3-devel \</span><br><span class="line">    unzip \</span><br><span class="line">    rsync \</span><br><span class="line">    clang \</span><br><span class="line">    llvm \</span><br><span class="line">    curl \</span><br><span class="line">    libtool \</span><br><span class="line">    automake \</span><br><span class="line">    autoconf \</span><br><span class="line">    jq \</span><br><span class="line">    systemd-devel</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>3.ä¸‹è½½å¹¶æå–Redisæºä»£ç </p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/src</span><br><span class="line"><span class="built_in">sudo</span> wget -O redis-8.4.0.tar.gz https://github.com/redis/redis/archive/refs/tags/8.4.0.tar.gz</span><br><span class="line"><span class="built_in">sudo</span> tar -xzf redis-8.4.0.tar.gz</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>4.ç¼–è¯‘Redis</p></li></ul><blockquote><p>è¿™é‡Œè¦æ³¨æ„ï¼Œä¸ä¼šè‡ªåŠ¨å®‰è£…æ¨¡å—ï¼Œéœ€è¦æ‰‹åŠ¨å®‰è£…ã€‚</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯ç”¨GCCå·¥å…·é›†</span></span><br><span class="line"><span class="built_in">cd</span> /usr/src/redis-8.4.0</span><br><span class="line"><span class="comment"># æ„å»ºTLS</span></span><br><span class="line"><span class="built_in">export</span> BUILD_TLS=<span class="built_in">yes</span></span><br><span class="line"><span class="comment"># æ„å»ºRedisæ¨¡å—ï¼Œé…ä¸é…éƒ½ä¸ä¼šè‡ªåŠ¨å®‰è£…æ¨¡å—</span></span><br><span class="line"><span class="built_in">export</span> BUILD_WITH_MODULES=<span class="built_in">yes</span></span><br><span class="line"><span class="comment"># å®‰è£…Rustå·¥å…·é“¾</span></span><br><span class="line"><span class="built_in">export</span> INSTALL_RUST_TOOLCHAIN=<span class="built_in">yes</span></span><br><span class="line"><span class="comment"># å…³é—­è­¦å‘Š</span></span><br><span class="line"><span class="built_in">export</span> DISABLE_WERRORS=<span class="built_in">yes</span></span><br><span class="line"><span class="comment"># å¼€å§‹ç¼–è¯‘</span></span><br><span class="line"><span class="built_in">sudo</span> make -j <span class="string">&quot;<span class="subst">$(nproc)</span>&quot;</span> all</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯</span></span><br><span class="line">./src/redis-server --version</span><br><span class="line">./src/redis-cli --version</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>5.å¯åŠ¨Redis</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> ./src/redis-server redis.conf</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>6.ç™»å½•Redis</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ./src/redis-cli</span><br><span class="line">127.0.0.1:6379&gt; MODULE LIST</span><br><span class="line">1) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;vectorset&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 1</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>7.å®‰è£…æ¨¡å—ï¼Œå¯ä»¥å‚è€ƒå¦‚ä¸‹æ–‡ç« ä¸­çš„ä»‹ç»</p><ul class="lvl-2"><li class="lvl-5"><a href="/2025/12/24/redis7-module-RedisJSON/" title="Redis æ‰©å±•æ¨¡å— -- RedisJSON çš„å®‰è£…æ–¹æ³•">Redis æ‰©å±•æ¨¡å— -- RedisJSON çš„å®‰è£…æ–¹æ³•</a></li><li class="lvl-5"><a href="/2025/12/21/redis7-module-RedisBloom/" title="Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•">Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•</a></li><li class="lvl-5"><a href="/2025/12/26/redis7-module-RediSearch/" title="Redis æ‰©å±•æ¨¡å— -- RediSearch çš„å®‰è£…æ–¹æ³•">Redis æ‰©å±•æ¨¡å— -- RediSearch çš„å®‰è£…æ–¹æ³•</a></li></ul></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡ä»‹ç» Linux å®‰è£… Redis8 çš„æ–¹æ³•&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Linux ç‰ˆæœ¬ï¼š&lt;code&gt;Amazon Linux 2023(å†…æ ¸ 6.1)&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Rediså®˜ç½‘ï¼š&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;&lt;a href=&quot;https://redis.io/docs/latest/operate/oss_and_stack/install/install-stack/rpm/&quot;&gt;Rediså®˜ç½‘å®‰è£…æ‰‹å†Œ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Rcoky9 å®‰è£… Redis8</title>
    <link href="https://blog.hanqunfeng.com/2025/12/25/redis8-install-rocky9/"/>
    <id>https://blog.hanqunfeng.com/2025/12/25/redis8-install-rocky9/</id>
    <published>2025-12-25T13:30:05.000Z</published>
    <updated>2025-12-24T10:06:24.246Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2">æœ¬æ–‡ä»‹ç» Linux å®‰è£… Redis8 çš„æ–¹æ³•</li><li class="lvl-2">Linux ç‰ˆæœ¬ï¼š<code>Rocky Linux release 9.4 (Blue Onyx)</code>ã€‚</li><li class="lvl-2">Rediså®˜ç½‘ï¼š<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2"><a href="https://redis.io/docs/latest/operate/oss_and_stack/install/install-stack/rpm/">Rediså®˜ç½‘å®‰è£…æ‰‹å†Œ</a></li></ul><span id="more"></span><h2 id="Yum-å®‰è£…">Yum å®‰è£…</h2><blockquote><p>æœ€çœäº‹ï¼Œå›½å†…ç¯å¢ƒä¹Ÿå¯ä»¥é¡ºåˆ©å®Œæˆå®‰è£…ã€‚<br><code>Amazon Linux 2023(å†…æ ¸ 6.1)</code> å’Œ <code>Rocky Linux release 9.4 (Blue Onyx)</code> å‡æˆåŠŸå®‰è£…ã€‚</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>1.æ·»åŠ ä»“åº“</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/yum.repos.d/redis.repo &gt; /dev/null &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Redis]</span></span><br><span class="line"><span class="string">name=Redis</span></span><br><span class="line"><span class="string">baseurl=http://packages.redis.io/rpm/rockylinux9</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>2.å®‰è£… Redis</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://packages.redis.io/gpg &gt; /tmp/redis.key</span><br><span class="line"><span class="built_in">sudo</span> rpm --import /tmp/redis.key</span><br><span class="line"><span class="built_in">sudo</span> yum install redis -y</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>3.æŸ¥çœ‹rediså®‰è£…ä¿¡æ¯</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹å·²å®‰è£…çš„redisç‰ˆæœ¬</span></span><br><span class="line">$ rpm -qa | grep redis</span><br><span class="line">redis-8.4.0-1.x86_64</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹rediså®‰è£…ä¿¡æ¯</span></span><br><span class="line">$ rpm -qi redis-8.4.0-1.x86_64</span><br><span class="line">Name        : redis</span><br><span class="line">Version     : 8.4.0</span><br><span class="line">Release     : 1</span><br><span class="line">Architecture: x86_64</span><br><span class="line">Install Date: Wed 24 Dec 2025 06:05:22 AM UTC</span><br><span class="line">Group       : Applications/Databases</span><br><span class="line">Size        : 83034075</span><br><span class="line">License     :</span><br><span class="line">Signature   : RSA/SHA512, Mon 01 Dec 2025 12:05:10 PM UTC, Key ID 5f4349d6bf53aa0c</span><br><span class="line">Source RPM  : redis-8.4.0-1.src.rpm</span><br><span class="line">Build Date  : Tue 18 Nov 2025 04:41:58 PM UTC</span><br><span class="line">Build Host  : 331d5099e900</span><br><span class="line">Packager    : Redis Labs &lt;redis@redis.io&gt;</span><br><span class="line">URL         : https://redis.io/</span><br><span class="line">Summary     : Redis is an in-memory database that persists on disk. The data model is key-value, but many different kind of values are supported: Strings, Lists, Sets, Sorted Sets, Hashes, Streams, HyperLogLogs, Bitmaps.</span><br><span class="line">Description :</span><br><span class="line">Redis is an in-memory database that persists on disk. The data model is key-value, but many different kind of values are supported: Strings, Lists, Sets, Sorted Sets, Hashes, Streams, HyperLogLogs, Bitmaps.</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹rediså®‰è£…çš„æ–‡ä»¶</span></span><br><span class="line">$ rpm -ql redis-8.4.0-1.x86_64</span><br><span class="line">/etc/redis</span><br><span class="line">/etc/redis/redis.conf</span><br><span class="line">/etc/redis/sentinel</span><br><span class="line">/etc/redis/sentinel/sentinel.conf</span><br><span class="line">/run/redis</span><br><span class="line">/run/redis/redis-server.pid</span><br><span class="line">/usr/bin/redis-benchmark</span><br><span class="line">/usr/bin/redis-check-aof</span><br><span class="line">/usr/bin/redis-check-rdb</span><br><span class="line">/usr/bin/redis-cli</span><br><span class="line">/usr/bin/redis-sentinel</span><br><span class="line">/usr/bin/redis-server</span><br><span class="line">/usr/lib/redis</span><br><span class="line">/usr/lib/redis/modules</span><br><span class="line">/usr/lib/redis/modules/redisbloom.so</span><br><span class="line">/usr/lib/redis/modules/redisearch.so</span><br><span class="line">/usr/lib/redis/modules/redistimeseries.so</span><br><span class="line">/usr/lib/redis/modules/rejson.so</span><br><span class="line">/usr/lib/redis/redisbloom.so</span><br><span class="line">/usr/lib/redis/redisearch.so</span><br><span class="line">/usr/lib/redis/redistimeseries.so</span><br><span class="line">/usr/lib/redis/rejson.so</span><br><span class="line">/usr/lib/systemd/system/redis-sentinel.service</span><br><span class="line">/usr/lib/systemd/system/redis.service</span><br><span class="line">/usr/share/selinux/packages/redis-ce.fc</span><br><span class="line">/usr/share/selinux/packages/redis-ce.te</span><br><span class="line">/var/lib/redis</span><br><span class="line">/var/log/redis</span><br><span class="line">/var/log/redis/redis-sentinel.log</span><br><span class="line">/var/log/redis/redis-server.log</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>4.å¯åŠ¨redis</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> redis</span><br><span class="line"><span class="built_in">sudo</span> systemctl start redis</span><br><span class="line"><span class="built_in">sudo</span> systemctl status redis</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>5.ç™»å½•redis</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">$ redis-cli</span><br><span class="line">127.0.0.1:6379&gt; MODULE LIST</span><br><span class="line">1) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;bf&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 80400</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/lib/redis/modules/redisbloom.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">2) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;timeseries&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 80400</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/lib/redis/modules/redistimeseries.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">3) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;ReJSON&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 80400</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/lib/redis/modules/rejson.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">4) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;vectorset&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 1</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">5) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;search&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 80402</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/lib/redis/modules/redisearch.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br></pre></td></tr></table></figure><h2 id="æºç å®‰è£…">æºç å®‰è£…</h2><ul class="lvl-0"><li class="lvl-2"><p>1.æ·»åŠ ä»“åº“</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/yum.repos.d/goreleaser.repo &gt; /dev/null &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[goreleaser]</span></span><br><span class="line"><span class="string">name=GoReleaser</span></span><br><span class="line"><span class="string">baseurl=https://repo.goreleaser.com/yum/</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> dnf clean all</span><br><span class="line"><span class="built_in">sudo</span> dnf makecache</span><br><span class="line"><span class="built_in">sudo</span> dnf update -y</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>2.å®‰è£…ä¾èµ–åŒ…</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dnf install -y --nobest --skip-broken \</span><br><span class="line">    pkg-config \</span><br><span class="line">    xz \</span><br><span class="line">    wget \</span><br><span class="line">    <span class="built_in">which</span> \</span><br><span class="line">    gcc-toolset-13-gcc \</span><br><span class="line">    gcc-toolset-13-gcc-c++ \</span><br><span class="line">    git \</span><br><span class="line">    make \</span><br><span class="line">    openssl \</span><br><span class="line">    openssl-devel \</span><br><span class="line">    python3 \</span><br><span class="line">    python3-pip \</span><br><span class="line">    python3-devel \</span><br><span class="line">    unzip \</span><br><span class="line">    rsync \</span><br><span class="line">    clang \</span><br><span class="line">    curl \</span><br><span class="line">    libtool \</span><br><span class="line">    automake \</span><br><span class="line">    autoconf \</span><br><span class="line">    jq \</span><br><span class="line">    systemd-devel</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>3.åˆ›å»ºä¸€ä¸ªPythonè™šæ‹Ÿç¯å¢ƒ</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> python3 -m venv /opt/venv</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>4.å¯ç”¨GCCå·¥å…·é›†</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> /opt/rh/gcc-toolset-13/enable /etc/profile.d/gcc-toolset-13.sh</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;source /etc/profile.d/gcc-toolset-13.sh&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> -a /etc/bashrc</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>5.å®‰è£…CMake</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">CMAKE_VERSION=3.25.1</span><br><span class="line">ARCH=$(<span class="built_in">uname</span> -m)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$ARCH</span>&quot;</span> = <span class="string">&quot;x86_64&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  CMAKE_FILE=cmake-<span class="variable">$&#123;CMAKE_VERSION&#125;</span>-linux-x86_64.sh</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  CMAKE_FILE=cmake-<span class="variable">$&#123;CMAKE_VERSION&#125;</span>-linux-aarch64.sh</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> wget https://github.com/Kitware/CMake/releases/download/v<span class="variable">$&#123;CMAKE_VERSION&#125;</span>/<span class="variable">$&#123;CMAKE_FILE&#125;</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> +x <span class="variable">$&#123;CMAKE_FILE&#125;</span></span><br><span class="line"><span class="built_in">sudo</span> ./<span class="variable">$&#123;CMAKE_FILE&#125;</span> --skip-license --prefix=/usr/local --exclude-subdir</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">rm</span> <span class="variable">$&#123;CMAKE_FILE&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/usr/local/bin</span><br><span class="line">cmake --version</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>6.ä¸‹è½½å¹¶æå–Redisæºä»£ç </p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/src</span><br><span class="line"><span class="built_in">sudo</span> wget -O redis-8.4.0.tar.gz https://github.com/redis/redis/archive/refs/tags/8.4.0.tar.gz</span><br><span class="line"><span class="built_in">sudo</span> tar -xzf redis-8.4.0.tar.gz</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>7.ç¼–è¯‘Redis</p></li></ul><blockquote><p>å›½å†…ç¯å¢ƒå®‰è£…æ—¶å› ä¸ºéœ€è¦ä»GitHubä¸‹è½½æ¨¡å—ï¼Œé€Ÿåº¦å¾ˆæ…¢ï¼Œè€Œä¸”ç»å¸¸å¤±è´¥ï¼Œå»ºè®®å®‰è£…æ—¶å…ˆä¸è¦å®‰è£…æ¨¡å—ï¼Œå®‰è£…å¥½redisåå†æŒ‰éœ€å®‰è£…æ¨¡å—ã€‚</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯ç”¨GCCå·¥å…·é›†</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile.d/gcc-toolset-13.sh</span><br><span class="line"><span class="built_in">cd</span> /usr/src/redis-8.4.0</span><br><span class="line"><span class="comment"># æ„å»ºTLS</span></span><br><span class="line"><span class="built_in">export</span> BUILD_TLS=<span class="built_in">yes</span></span><br><span class="line"><span class="comment"># æ„å»ºRedisæ¨¡å—ï¼Œå¦‚æœä¸å®‰è£…æ¨¡å—ï¼Œåˆ™ä¸éœ€è¦æ­¤å‚æ•°</span></span><br><span class="line"><span class="built_in">export</span> BUILD_WITH_MODULES=<span class="built_in">yes</span></span><br><span class="line"><span class="comment"># å®‰è£…Rustå·¥å…·é“¾</span></span><br><span class="line"><span class="built_in">export</span> INSTALL_RUST_TOOLCHAIN=<span class="built_in">yes</span></span><br><span class="line"><span class="comment"># å…³é—­è­¦å‘Š</span></span><br><span class="line"><span class="built_in">export</span> DISABLE_WERRORS=<span class="built_in">yes</span></span><br><span class="line"><span class="comment"># å¼€å§‹ç¼–è¯‘</span></span><br><span class="line"><span class="built_in">sudo</span> make -j <span class="string">&quot;<span class="subst">$(nproc)</span>&quot;</span> all</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯</span></span><br><span class="line">./src/redis-server --version</span><br><span class="line">./src/redis-cli --version</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>8.å¯åŠ¨Redis</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> ./src/redis-server redis-full.conf</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>9.ç™»å½•Redis</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">$ ./src/redis-cli</span><br><span class="line">127.0.0.1:6379&gt; MODULE LIST</span><br><span class="line">1) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;search&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 80402</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;./modules/redisearch/redisearch.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">2) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;vectorset&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 1</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">3) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;ReJSON&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 80400</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;./modules/redisjson/rejson.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">4) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;bf&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 80400</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;./modules/redisbloom/redisbloom.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">5) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;timeseries&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 80400</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;./modules/redistimeseries/redistimeseries.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>10.å®‰è£…æ¨¡å—ï¼Œå¦‚æœå®‰è£…æ—¶æ²¡æœ‰å®‰è£…æ¨¡å—ï¼Œå¯ä»¥å‚è€ƒå¦‚ä¸‹æ–‡ç« ä¸­çš„ä»‹ç»</p><ul class="lvl-2"><li class="lvl-5"><a href="/2025/12/24/redis7-module-RedisJSON/" title="Redis æ‰©å±•æ¨¡å— -- RedisJSON çš„å®‰è£…æ–¹æ³•">Redis æ‰©å±•æ¨¡å— -- RedisJSON çš„å®‰è£…æ–¹æ³•</a></li><li class="lvl-5"><a href="/2025/12/21/redis7-module-RedisBloom/" title="Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•">Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•</a></li></ul></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡ä»‹ç» Linux å®‰è£… Redis8 çš„æ–¹æ³•&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Linux ç‰ˆæœ¬ï¼š&lt;code&gt;Rocky Linux release 9.4 (Blue Onyx)&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Rediså®˜ç½‘ï¼š&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;&lt;a href=&quot;https://redis.io/docs/latest/operate/oss_and_stack/install/install-stack/rpm/&quot;&gt;Rediså®˜ç½‘å®‰è£…æ‰‹å†Œ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis å‘½ä»¤åŠæ•°æ®ç±»å‹ -- JSON</title>
    <link href="https://blog.hanqunfeng.com/2025/12/24/redis7-datatype-16-JSON/"/>
    <id>https://blog.hanqunfeng.com/2025/12/24/redis7-datatype-16-JSON/</id>
    <published>2025-12-24T13:40:05.000Z</published>
    <updated>2026-01-07T02:44:09.582Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2">æœ¬æ–‡ä»‹ç» Redis æ‰©å±•æ¨¡å‹ RedisJSON ä¸­çš„ JSON æ•°æ®ç±»å‹</li><li class="lvl-2">æœ¬æ–‡åŸºäº<code>redis-7.4.7</code>ï¼Œ<code>springboot-3.5.8</code></li><li class="lvl-2">Rediså®˜ç½‘ï¼š<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis å‘½ä»¤æ–‡æ¡£ï¼š<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li><li class="lvl-2">RedisJSON çš„å®‰è£…å‚è§ <a href="/2025/12/24/redis7-module-RedisJSON/" title="Redis æ‰©å±•æ¨¡å— -- RedisJSON çš„å®‰è£…æ–¹æ³•">Redis æ‰©å±•æ¨¡å— -- RedisJSON çš„å®‰è£…æ–¹æ³•</a></li><li class="lvl-2">ç¤ºä¾‹ä»£ç ï¼š<a href="https://github.com/hanqunfeng/springbootchapter/tree/master/springboot3-demo/redis-demo/redisson-demo">GitHub</a></li></ul><span id="more"></span><h2 id="JSON-vs-String">JSON vs String</h2><ul class="lvl-0"><li class="lvl-2"><p>Redis JSONå­˜å‚¨æ•°æ®çš„æ€§èƒ½æ›´é«˜ã€‚</p><ul class="lvl-2"><li class="lvl-6">Redis JSON åº•å±‚å…¶å®æ˜¯ä»¥ä¸€ç§é«˜æ•ˆçš„äºŒè¿›åˆ¶çš„æ ¼å¼å­˜å‚¨ã€‚</li><li class="lvl-6">ç›¸æ¯”ç®€å•çš„æ–‡æœ¬æ ¼å¼ï¼ŒäºŒè¿›åˆ¶æ ¼å¼è¿›è¡Œ JOSN æ ¼å¼è¯»å†™çš„æ€§èƒ½æ›´é«˜ï¼Œä¹Ÿæ›´èŠ‚çœå†…å­˜ã€‚</li><li class="lvl-6">æ ¹æ®å®˜ç½‘çš„æ€§èƒ½æµ‹è¯•æŠ¥å‘Šï¼Œä½¿ç”¨ Redis JSON è¯»å†™ JSONæ•°æ®ï¼Œæ€§èƒ½å·²ç»èƒ½å¤Ÿåª²ç¾ MongoDB ä»¥åŠ ElasticSearch ç­‰ä¼ ç»Ÿ NoSQL æ•°æ®åº“ã€‚</li></ul></li><li class="lvl-2"><p>Redis JSON ä½¿ç”¨æ ‘çŠ¶ç»“æ„æ¥å­˜å‚¨JSONã€‚</p><ul class="lvl-2"><li class="lvl-6">è¿™ç§å­˜å‚¨æ–¹å¼å¯ä»¥å¿«é€Ÿè®¿é—®å­å…ƒç´ ã€‚</li><li class="lvl-6">ä¸ä¼ ç»Ÿçš„æ–‡æœ¬å­˜å‚¨æ–¹æ¡ˆç›¸æ¯”ï¼Œæ ‘çŠ¶å­˜å‚¨ç»“æ„èƒ½å¤Ÿæ›´é«˜æ•ˆçš„æ‰§è¡ŒæŸ¥è¯¢æ“ä½œã€‚</li></ul></li><li class="lvl-2"><p>ä¸Redisç”Ÿæ€é›†æˆåº¦é«˜ã€‚</p><ul class="lvl-2"><li class="lvl-6">ä½œä¸ºRedisçš„æ‰©å±•æ¨¡å—ï¼ŒRedis JSON å’ŒRedisçš„å…¶ä»–åŠŸèƒ½å’Œå·¥å…·æ— ç¼é›†æˆã€‚</li><li class="lvl-6">è¿™æ„å‘³ç€å¼€å‘è€…å¯ä»¥ç»§ç»­ä½¿ç”¨TTLã€Redisäº‹åŠ¡ã€å‘å¸ƒ/è®¢é˜…ã€Luaè„šæœ¬ç­‰åŠŸèƒ½ã€‚</li></ul></li></ul><h2 id="JSONPath">JSONPath</h2><ul class="lvl-0"><li class="lvl-2"><p>JSONPath æ˜¯ä¸€ç§ç”¨äºæŸ¥è¯¢å’Œä¿®æ”¹ JSON æ•°æ®çš„è¯­æ³•ã€‚</p></li><li class="lvl-2"><p>JSONPath è¯­æ³•</p></li></ul><table><thead><tr><th>è¯­æ³•å…ƒç´ </th><th>ä¸­æ–‡è¯´æ˜</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td><code>$</code></td><td>æ ¹èŠ‚ç‚¹ï¼ˆæœ€å¤–å±‚ JSON å…ƒç´ ï¼‰ï¼ŒJSONPath çš„èµ·ç‚¹</td><td><code>$</code>ã€<code>$.user.name</code></td></tr><tr><td><code>.</code></td><td>è®¿é—®å­å­—æ®µï¼ˆå¯¹è±¡å±æ€§è®¿é—®ï¼‰</td><td><code>$.user.age</code></td></tr><tr><td><code>[]</code></td><td>å­å…ƒç´ é€‰æ‹©å™¨ï¼ˆå­—æ®µåæˆ–æ•°ç»„ç´¢å¼•ï¼‰</td><td><code>$['user']['name']</code></td></tr><tr><td><code>..</code></td><td>é€’å½’ä¸‹é™ï¼Œéå†æ‰€æœ‰å±‚çº§çš„èŠ‚ç‚¹</td><td><code>$..id</code></td></tr><tr><td><code>*</code></td><td>é€šé…ç¬¦ï¼ŒåŒ¹é…å½“å‰å±‚çº§çš„æ‰€æœ‰å…ƒç´ </td><td><code>$.users[*]</code></td></tr><tr><td><code>[index]</code></td><td>æ•°ç»„ä¸‹æ ‡è®¿é—®ï¼ˆæ”¯æŒè´Ÿç´¢å¼•ï¼‰</td><td><code>$.scores[0]</code></td></tr><tr><td><code>[a,b,c]</code></td><td>è”åˆé€‰æ‹©ï¼Œè¿”å›å¤šä¸ªæŒ‡å®šå…ƒç´ </td><td><code>$.scores[0,2,4]</code></td></tr><tr><td><code>[start:end:step]</code></td><td>æ•°ç»„åˆ‡ç‰‡ï¼ˆèµ·å§‹ç´¢å¼• : ç»“æŸç´¢å¼• : æ­¥é•¿ï¼‰</td><td><code>$.scores[1:5:2]</code></td></tr><tr><td><code>[*]</code></td><td>é€‰æ‹©æ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ </td><td><code>$.items[*]</code></td></tr><tr><td><code>[:]</code></td><td>é€‰æ‹©æ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ ï¼ˆåˆ‡ç‰‡å†™æ³•ï¼‰</td><td><code>$.items[:]</code></td></tr><tr><td><code>?()</code></td><td>è¿‡æ»¤è¡¨è¾¾å¼ï¼Œç”¨äºæ•°ç»„æˆ–å¯¹è±¡çš„æ¡ä»¶ç­›é€‰</td><td><code>$.users[?(@.age&gt;=18)]</code></td></tr><tr><td><code>()</code></td><td>è„šæœ¬è¡¨è¾¾å¼ï¼Œç”¨äºè®¡ç®—æˆ–å¤æ‚é€»è¾‘åˆ¤æ–­</td><td><code>$.items[?((@.a+@.b)&gt;10)]</code></td></tr><tr><td><code>@</code></td><td>å½“å‰å…ƒç´ å¼•ç”¨ï¼Œå¸¸ç”¨äºè¿‡æ»¤æˆ–è„šæœ¬è¡¨è¾¾å¼ä¸­</td><td><code>@.price&lt;100</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>æ•°ç»„åˆ‡ç‰‡ <code>[start:end:step]</code> è¯¦è§£</p></li></ul><table><thead><tr><th>å†™æ³•</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td><code>[3:]</code></td><td>ä»ç´¢å¼• 3 åˆ°æœ«å°¾</td></tr><tr><td><code>[:8]</code></td><td>ä»å¤´åˆ°ç´¢å¼• 7</td></tr><tr><td><code>[:8:2]</code></td><td>ä»å¤´åˆ° 7ï¼Œæ¯éš” 2 ä¸ªå–ä¸€ä¸ª</td></tr><tr><td><code>[::]</code></td><td>ç­‰ä»·äº <code>[:]</code>ï¼Œå–å…¨éƒ¨</td></tr><tr><td><code>[*]</code></td><td>æ¨èå†™æ³•ï¼Œå–å…¨éƒ¨</td></tr></tbody></table><blockquote><p>é»˜è®¤å€¼è§„åˆ™ï¼š<br>start é»˜è®¤ 0<br>end é»˜è®¤æ•°ç»„æœ«å°¾<br>step é»˜è®¤ 1</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>è¿‡æ»¤è¡¨è¾¾å¼ <code>?()</code> æ”¯æŒçš„è¿ç®—ç¬¦</p></li></ul><blockquote><p>æ¯”è¾ƒè¿ç®—ç¬¦ï¼Œå®æµ‹ä¸­ä»…æ”¯æŒæ•°å­—æ¯”è¾ƒï¼Œä¸”æ³¨æ„ä¸¤è¾¹ä¸èƒ½æœ‰ç©ºæ ¼</p></blockquote><table><thead><tr><th>è¿ç®—ç¬¦</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td><code>==</code></td><td>ç­‰äº</td></tr><tr><td><code>!=</code></td><td>ä¸ç­‰äº</td></tr><tr><td><code>&lt;</code></td><td>å°äº</td></tr><tr><td><code>&lt;=</code></td><td>å°äºç­‰äº</td></tr><tr><td><code>&gt;</code></td><td>å¤§äº</td></tr><tr><td><code>&gt;=</code></td><td>å¤§äºç­‰äº</td></tr><tr><td><code>=~</code></td><td>æ­£åˆ™åŒ¹é…</td></tr></tbody></table><blockquote><p>é€»è¾‘è¿ç®—ç¬¦</p></blockquote><table><thead><tr><th>è¿ç®—ç¬¦</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td><code>&amp;&amp;</code></td><td>ä¸</td></tr><tr><td><code>||</code></td><td>æˆ–</td></tr><tr><td><code>()</code></td><td>åˆ†ç»„ä¼˜å…ˆçº§</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>Redis çš„ RedisJSON æ¨¡å—ï¼ˆæä¾› JSON æ“ä½œåŠŸèƒ½ï¼‰æ”¯æŒçš„ JSONPath è¯­æ³•æ˜¯å—é™çš„å­é›†ï¼Œå°¤å…¶æ˜¯ï¼š</p><ul class="lvl-2"><li class="lvl-6">âŒ ä¸æ”¯æŒå¤æ‚è¡¨è¾¾å¼</li><li class="lvl-6">âŒ ä¸æ”¯æŒåµŒå¥—æ•°ç»„æ¡ä»¶ï¼ˆ@.items[*].xxxï¼‰</li><li class="lvl-6">âš ï¸ å¯¹ ?() çš„æ”¯æŒéå¸¸æœ‰é™</li></ul></li><li class="lvl-2"><p>å¦‚æœéœ€è¦å¤æ‚çš„æŸ¥è¯¢æ¨èä½¿ç”¨ <code>RediSearch</code> æ¨¡å—ï¼Œè¿™ä¸ªæˆ‘ä»¬åé¢çš„ç« èŠ‚ä¼šä»‹ç»ã€‚</p></li></ul><h2 id="JSON-å‘½ä»¤">JSON å‘½ä»¤</h2><ul class="lvl-0"><li class="lvl-2"><p>JSON å‘½ä»¤ æ±‡æ€»</p></li></ul><table><thead><tr><th>åˆ†ç±»</th><th>å‘½ä»¤</th></tr></thead><tbody><tr><td>åŸºç¡€è¯»å†™</td><td>SET / MSET / GET / MGET</td></tr><tr><td>æ•°ç»„æ“ä½œ</td><td>ARRAPPEND / ARRINSERT / ARRPOP / ARRLEN / ARRINDEX / ARRTRIM</td></tr><tr><td>å¯¹è±¡æ“ä½œ</td><td>OBJKEYS / OBJLEN / TYPE</td></tr><tr><td>æ•°å€¼è¿ç®—</td><td>NUMINCRBY / NUMMULTBY / TOGGLE</td></tr><tr><td>å­—ç¬¦ä¸²</td><td>STRAPPEND / STRLEN</td></tr><tr><td>åˆ é™¤æ¸…ç©º</td><td>DEL / FORGET / CLEAR</td></tr><tr><td>åˆå¹¶è¾“å‡º</td><td>MERGE / RESP</td></tr><tr><td>è°ƒè¯•è¯Šæ–­</td><td>DEBUG / DEBUG MEMORY</td></tr></tbody></table><h3 id="ä¸€ã€åŸºç¡€è¯»å†™ç±»ï¼ˆCRUDï¼‰">ä¸€ã€åŸºç¡€è¯»å†™ç±»ï¼ˆCRUDï¼‰</h3><table><thead><tr><th>å‘½ä»¤</th><th>ä½œç”¨</th><th>å…³é”®å‚æ•°è¯´æ˜</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>JSON.SET</td><td>è®¾ç½®æˆ–æ›´æ–°æŸä¸ª path çš„å€¼</td><td><code>key</code>ï¼šé”®å<br><code>path</code>ï¼šJSONPathï¼ˆå¦‚ <code>$</code>ã€<code>$.a.b</code>ï¼‰<br><code>value</code>ï¼šJSON å€¼</td><td><code>JSON.SET user:1 $ '&#123;&quot;name&quot;:&quot;Tom&quot;,&quot;age&quot;:18&#125;'</code></td></tr><tr><td>JSON.MSET</td><td>æ‰¹é‡è®¾ç½®å¤šä¸ª key</td><td><code>(key path value)...</code></td><td><code>JSON.MSET k1 $ '&#123;&quot;a&quot;:1&#125;' k2 $.b 2</code></td></tr><tr><td>JSON.GET</td><td>è·å–ä¸€ä¸ª key çš„ JSON å€¼</td><td><code>key</code><br><code>path...</code>ï¼šå¯å¤šä¸ª</td><td><code>JSON.GET user:1 $.name $.age</code></td></tr><tr><td>JSON.MGET</td><td>ä»å¤šä¸ª key è·å–åŒä¸€è·¯å¾„</td><td><code>key... path</code></td><td><code>JSON.MGET k1 k2 $.a</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>è¯´æ˜ï¼š</p><ul class="lvl-2"><li class="lvl-6">JSON.GET è¿”å› å­—ç¬¦ä¸²åŒ– JSON</li><li class="lvl-6">JSON.MGET è¿”å›æ•°ç»„ï¼Œå¯¹åº”å¤šä¸ª key</li></ul></li></ul><h3 id="äºŒã€æ•°ç»„æ“ä½œç±»ï¼ˆArrayï¼‰">äºŒã€æ•°ç»„æ“ä½œç±»ï¼ˆArrayï¼‰</h3><table><thead><tr><th>å‘½ä»¤</th><th>ä½œç”¨</th><th>å‚æ•°å«ä¹‰</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>JSON.ARRAPPEND</td><td>å‘æ•°ç»„æœ«å°¾è¿½åŠ å…ƒç´ </td><td><code>key path value...</code></td><td><code>JSON.ARRAPPEND k $.tags &quot;redis&quot; &quot;json&quot;</code></td></tr><tr><td>JSON.ARRINSERT</td><td>åœ¨æŒ‡å®šç´¢å¼•æ’å…¥å…ƒç´ </td><td><code>key path index value...</code></td><td><code>JSON.ARRINSERT k $.tags 1 &quot;nosql&quot;</code></td></tr><tr><td>JSON.ARRPOP</td><td>åˆ é™¤å¹¶è¿”å›æŒ‡å®šç´¢å¼•å…ƒç´ </td><td><code>key path [index]</code></td><td><code>JSON.ARRPOP k $.tags -1</code></td></tr><tr><td>JSON.ARRLEN</td><td>è·å–æ•°ç»„é•¿åº¦</td><td><code>key path</code></td><td><code>JSON.ARRLEN k $.tags</code></td></tr><tr><td>JSON.ARRINDEX</td><td>æŸ¥æ‰¾å…ƒç´ ç´¢å¼•</td><td><code>key path value</code></td><td><code>JSON.ARRINDEX k $.tags &quot;redis&quot;</code></td></tr><tr><td>JSON.ARRTRIM</td><td>æˆªå–æ•°ç»„åŒºé—´</td><td><code>key path start stop</code></td><td><code>JSON.ARRTRIM k $.scores 0 9</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>è¯´æ˜ï¼š</p><ul class="lvl-2"><li class="lvl-6">ç´¢å¼•æ”¯æŒè´Ÿæ•°ï¼ˆ-1 è¡¨ç¤ºæœ€åä¸€ä¸ªï¼‰</li><li class="lvl-6">ARRTRIM ç±»ä¼¼ LTRIM</li></ul></li></ul><h3 id="ä¸‰ã€å¯¹è±¡æ“ä½œç±»ï¼ˆObjectï¼‰">ä¸‰ã€å¯¹è±¡æ“ä½œç±»ï¼ˆObjectï¼‰</h3><table><thead><tr><th>å‘½ä»¤</th><th>ä½œç”¨</th><th>å‚æ•°è¯´æ˜</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>JSON.OBJKEYS</td><td>è·å–å¯¹è±¡çš„æ‰€æœ‰ key</td><td><code>key path</code></td><td><code>JSON.OBJKEYS k $.user</code></td></tr><tr><td>JSON.OBJLEN</td><td>è·å–å¯¹è±¡å­—æ®µæ•°é‡</td><td><code>key path</code></td><td><code>JSON.OBJLEN k $.user</code></td></tr><tr><td>JSON.TYPE</td><td>è¿”å› path å¯¹åº”å€¼ç±»å‹</td><td><code>key path</code></td><td><code>JSON.TYPE k $.user.name</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>JSON.TYPE è¿”å›ç±»å‹åŒ…æ‹¬ï¼šobject / array / string / number / boolean / null</p></li></ul><h3 id="å››ã€æ•°å€¼è¿ç®—ç±»ï¼ˆNumericï¼‰">å››ã€æ•°å€¼è¿ç®—ç±»ï¼ˆNumericï¼‰</h3><table><thead><tr><th>å‘½ä»¤</th><th>ä½œç”¨</th><th>å‚æ•°è¯´æ˜</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>JSON.NUMINCRBY</td><td>æ•°å€¼è‡ªå¢</td><td><code>key path number</code></td><td><code>JSON.NUMINCRBY k $.count 1</code></td></tr><tr><td>JSON.NUMMULTBY</td><td>æ•°å€¼ä¹˜æ³•</td><td><code>key path number</code></td><td><code>JSON.NUMMULTBY k $.price 0.8</code></td></tr><tr><td>JSON.TOGGLE</td><td>å¸ƒå°”å€¼å–å</td><td><code>key path</code></td><td><code>JSON.TOGGLE k $.enabled</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>è¯´æ˜ï¼š</p><ul class="lvl-2"><li class="lvl-6">ä¿è¯ åŸå­æ€§</li><li class="lvl-6">å¸¸ç”¨äºè®¡æ•°ã€å¼€å…³çŠ¶æ€</li></ul></li></ul><h3 id="äº”ã€å­—ç¬¦ä¸²æ“ä½œç±»ï¼ˆStringï¼‰">äº”ã€å­—ç¬¦ä¸²æ“ä½œç±»ï¼ˆStringï¼‰</h3><table><thead><tr><th>å‘½ä»¤</th><th>ä½œç”¨</th><th>å‚æ•°è¯´æ˜</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>JSON.STRAPPEND</td><td>è¿½åŠ å­—ç¬¦ä¸²</td><td><code>key path value</code></td><td><code>JSON.STRAPPEND k $.msg &quot; world&quot;</code></td></tr><tr><td>JSON.STRLEN</td><td>å­—ç¬¦ä¸²é•¿åº¦</td><td><code>key path</code></td><td><code>JSON.STRLEN k $.msg</code></td></tr></tbody></table><h3 id="å…­ã€åˆ é™¤-æ¸…ç©ºç±»">å…­ã€åˆ é™¤ / æ¸…ç©ºç±»</h3><table><thead><tr><th>å‘½ä»¤</th><th>ä½œç”¨</th><th>å‚æ•°è¯´æ˜</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>JSON.DEL</td><td>åˆ é™¤æŒ‡å®š path</td><td><code>key path</code></td><td><code>JSON.DEL k $.user.age</code></td></tr><tr><td>JSON.FORGET</td><td>ç­‰ä»· JSON.DEL</td><td>åŒä¸Š</td><td><code>JSON.FORGET k $.tmp</code></td></tr><tr><td>JSON.CLEAR</td><td>æ¸…ç©ºå€¼</td><td><code>key path</code></td><td><code>JSON.CLEAR k $.list</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>JSON.CLEAR è¡Œä¸ºè¯´æ˜ï¼š</p><ul class="lvl-2"><li class="lvl-6">æ•°ç»„ â†’ []</li><li class="lvl-6">å¯¹è±¡ â†’ {}</li><li class="lvl-6">æ•°å€¼ â†’ 0</li></ul></li></ul><h3 id="ä¸ƒã€åˆå¹¶ä¸é«˜çº§æ“ä½œ">ä¸ƒã€åˆå¹¶ä¸é«˜çº§æ“ä½œ</h3><table><thead><tr><th>å‘½ä»¤</th><th>ä½œç”¨</th><th>å‚æ•°è¯´æ˜</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>JSON.MERGE</td><td>åˆå¹¶ JSONï¼ˆRFC7396ï¼‰</td><td><code>key path value</code></td><td><code>JSON.MERGE k $ '&#123;&quot;a&quot;:2,&quot;b&quot;:3&#125;'</code></td></tr><tr><td>JSON.RESP</td><td>RESP æ ¼å¼è¿”å›</td><td><code>key path</code></td><td><code>JSON.RESP k $.user</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>è¯´æ˜ï¼š</p><ul class="lvl-2"><li class="lvl-6">MERGE æ”¯æŒå­—æ®µè¦†ç›–ã€åˆ é™¤ã€æ‰©å±•</li><li class="lvl-6">RESP é€‚åˆå®¢æˆ·ç«¯ç›´æ¥è§£æ</li></ul></li></ul><h3 id="å…«ã€è°ƒè¯•ä¸è¯Šæ–­ç±»ï¼ˆDebugï¼‰">å…«ã€è°ƒè¯•ä¸è¯Šæ–­ç±»ï¼ˆDebugï¼‰</h3><table><thead><tr><th>å‘½ä»¤</th><th>ä½œç”¨</th><th>å‚æ•°è¯´æ˜</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>JSON.DEBUG</td><td>è°ƒè¯•å‘½ä»¤å®¹å™¨</td><td>å­å‘½ä»¤</td><td><code>JSON.DEBUG MEMORY k</code></td></tr><tr><td>JSON.DEBUG MEMORY</td><td>æŸ¥çœ‹ JSON å ç”¨å†…å­˜</td><td><code>key</code></td><td><code>JSON.DEBUG MEMORY user:1</code></td></tr></tbody></table><h2 id="åº”ç”¨ç¤ºä¾‹">åº”ç”¨ç¤ºä¾‹</h2><ul class="lvl-0"><li class="lvl-2"><p>åœºæ™¯é€‰ç”¨ï¼šç”µå•†ç”¨æˆ·ç”»åƒ + è®¢å•ç³»ç»Ÿï¼ˆç»“æ„å¤æ‚ã€å­—æ®µå¤šã€éå¸¸é€‚åˆ JSONPathï¼‰</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">æˆ‘ä»¬è¦å­˜å‚¨ä¸€ä¸ªç”¨æˆ·çš„å®Œæ•´ç”»åƒï¼š</span><br><span class="line">    åŸºæœ¬ä¿¡æ¯</span><br><span class="line">    åœ°å€åˆ—è¡¨</span><br><span class="line">    è®¢å•åˆ—è¡¨ï¼ˆåŒ…å«å•†å“ã€ä»·æ ¼ã€æ•°é‡ï¼‰</span><br><span class="line">    æ ‡ç­¾(åå¥½)</span><br><span class="line">    è´¦æˆ·çŠ¶æ€</span><br><span class="line">    ç»Ÿè®¡ä¿¡æ¯</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>SpringBootæš‚æ—¶æ²¡æœ‰æ”¯æŒRedisJSONï¼Œä½ å¯ä»¥ç¼–å†™Luaè„šæœ¬æ¥å®ç°ç›¸åº”çš„åŠŸèƒ½ï¼Œå¦å¤– <a href="https://redisson.pro/docs/data-and-services/objects/#json-object-holder">Redisson</a>å·²ç»æä¾›äº†å¯¹JSONçš„æ”¯æŒï¼Œä½†æ˜¯å®é™…ä½¿ç”¨ä¸­å‘ç°è¿˜æœ‰ä¸€äº›Bugï¼Œä¸‹é¢ç»“åˆå‘½ä»¤ç»™å‡ºä»£ç ç¤ºä¾‹ã€‚</p></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- å¼•å…¥ Redisson ï¼Œè¿™é‡Œè¦æ³¨æ„ï¼Œç°åœ¨æœ€æ–°ç‰ˆæ˜¯ 4.0.0ï¼Œéœ€è¦ springboot 4.x --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.52.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>åˆ›å»ºå®Œæ•´ JSON æ–‡æ¡£ï¼ˆJSON.SETï¼‰</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»º JSON æ–‡æ¡£ï¼Œå®é™…æ‰§è¡Œä¸­ä¸æ”¯æŒå¤šè¡Œï¼Œè¿™é‡Œåªæ˜¯ä¸ºäº†çœ‹ç€æ¸…æ¥šäº›ï¼Œå®é™…è¿è¡Œæ—¶è¦å°†å…¶æ”¹æˆä¸€è¡Œ</span></span><br><span class="line">JSON.SET user:10001 $ <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">  &quot;profile&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;name&quot;: &quot;Alice&quot;,</span></span><br><span class="line"><span class="string">    &quot;age&quot;: 28,</span></span><br><span class="line"><span class="string">    &quot;vip&quot;: true</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;tags&quot;: [&quot;vip&quot;, &quot;electronics&quot;, &quot;promotion&quot;],</span></span><br><span class="line"><span class="string">  &quot;addresses&quot;: [</span></span><br><span class="line"><span class="string">    &#123; &quot;city&quot;: &quot;Beijing&quot;, &quot;zip&quot;: &quot;100000&quot; &#125;,</span></span><br><span class="line"><span class="string">    &#123; &quot;city&quot;: &quot;Shanghai&quot;, &quot;zip&quot;: &quot;200000&quot; &#125;</span></span><br><span class="line"><span class="string">  ],</span></span><br><span class="line"><span class="string">  &quot;orders&quot;: [</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;orderId&quot;: &quot;O1001&quot;,</span></span><br><span class="line"><span class="string">      &quot;amount&quot;: 199.99,</span></span><br><span class="line"><span class="string">      &quot;status&quot;: &quot;PAID&quot;,</span></span><br><span class="line"><span class="string">      &quot;items&quot;: [</span></span><br><span class="line"><span class="string">        &#123; &quot;sku&quot;: &quot;SKU-1&quot;, &quot;price&quot;: 99.99, &quot;qty&quot;: 1 &#125;,</span></span><br><span class="line"><span class="string">        &#123; &quot;sku&quot;: &quot;SKU-2&quot;, &quot;price&quot;: 100.00, &quot;qty&quot;: 1 &#125;</span></span><br><span class="line"><span class="string">      ]</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;orderId&quot;: &quot;O1002&quot;,</span></span><br><span class="line"><span class="string">      &quot;amount&quot;: 59.90,</span></span><br><span class="line"><span class="string">      &quot;status&quot;: &quot;CREATED&quot;,</span></span><br><span class="line"><span class="string">      &quot;items&quot;: [</span></span><br><span class="line"><span class="string">        &#123; &quot;sku&quot;: &quot;SKU-3&quot;, &quot;price&quot;: 59.90, &quot;qty&quot;: 1 &#125;</span></span><br><span class="line"><span class="string">      ]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  ],</span></span><br><span class="line"><span class="string">  &quot;stats&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;loginCount&quot;: 10,</span></span><br><span class="line"><span class="string">    &quot;balance&quot;: 300.5</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¹Ÿå¯ä»¥ä½¿ç”¨å•è¡Œæ¨¡å¼ä¸€ç‚¹ç‚¹ç»„è£…</span></span><br><span class="line">JSON.SET user:10001 $ <span class="string">&#x27;&#123;&#125;&#x27;</span></span><br><span class="line">JSON.SET user:10001 $.profile <span class="string">&#x27;&#123;&quot;name&quot;:&quot;Alice&quot;,&quot;age&quot;:28,&quot;vip&quot;:true&#125;&#x27;</span></span><br><span class="line">JSON.SET user:10001 $.tags <span class="string">&#x27;[&quot;vip&quot;,&quot;electronics&quot;,&quot;promotion&quot;]&#x27;</span></span><br><span class="line">JSON.SET user:10001 $.addresses <span class="string">&#x27;[&#123;&quot;city&quot;:&quot;Beijing&quot;,&quot;zip&quot;:&quot;100000&quot;&#125;,&#123;&quot;city&quot;:&quot;Shanghai&quot;,&quot;zip&quot;:&quot;200000&quot;&#125;]&#x27;</span></span><br><span class="line">JSON.SET user:10001 $.orders <span class="string">&#x27;[&#123;&quot;orderId&quot;:&quot;O1001&quot;,&quot;amount&quot;:199.99,&quot;status&quot;:&quot;PAID&quot;,&quot;items&quot;:[&#123;&quot;sku&quot;:&quot;SKU-1&quot;,&quot;price&quot;:99.99,&quot;qty&quot;:1&#125;,&#123;&quot;sku&quot;:&quot;SKU-2&quot;,&quot;price&quot;:100,&quot;qty&quot;:1&#125;]&#125;,&#123;&quot;orderId&quot;:&quot;O1002&quot;,&quot;amount&quot;:59.90,&quot;status&quot;:&quot;CREATED&quot;,&quot;items&quot;:[&#123;&quot;sku&quot;:&quot;SKU-3&quot;,&quot;price&quot;:59.90,&quot;qty&quot;:1&#125;]&#125;]&#x27;</span></span><br><span class="line">JSON.SET user:10001 $.stats <span class="string">&#x27;&#123;&quot;loginCount&quot;:10,&quot;balance&quot;:300.5&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç±»å‹</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">type</span> user:10001</span><br><span class="line">ReJSON-RL</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>é€šç”¨ä»£ç </p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">userStr</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">              &quot;profile&quot;: &#123;</span></span><br><span class="line"><span class="string">                &quot;name&quot;: &quot;Alice&quot;,</span></span><br><span class="line"><span class="string">                &quot;age&quot;: 28,</span></span><br><span class="line"><span class="string">                &quot;vip&quot;: true</span></span><br><span class="line"><span class="string">              &#125;,</span></span><br><span class="line"><span class="string">              &quot;tags&quot;: [&quot;vip&quot;, &quot;electronics&quot;, &quot;promotion&quot;],</span></span><br><span class="line"><span class="string">              &quot;addresses&quot;: [</span></span><br><span class="line"><span class="string">                &#123; &quot;city&quot;: &quot;Beijing&quot;, &quot;zip&quot;: &quot;100000&quot; &#125;,</span></span><br><span class="line"><span class="string">                &#123; &quot;city&quot;: &quot;Shanghai&quot;, &quot;zip&quot;: &quot;200000&quot; &#125;</span></span><br><span class="line"><span class="string">              ],</span></span><br><span class="line"><span class="string">              &quot;orders&quot;: [</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                  &quot;orderId&quot;: &quot;O1001&quot;,</span></span><br><span class="line"><span class="string">                  &quot;amount&quot;: 199.99,</span></span><br><span class="line"><span class="string">                  &quot;status&quot;: &quot;PAID&quot;,</span></span><br><span class="line"><span class="string">                  &quot;items&quot;: [</span></span><br><span class="line"><span class="string">                    &#123; &quot;sku&quot;: &quot;SKU-1&quot;, &quot;price&quot;: 99.99, &quot;qty&quot;: 1 &#125;,</span></span><br><span class="line"><span class="string">                    &#123; &quot;sku&quot;: &quot;SKU-2&quot;, &quot;price&quot;: 100.00, &quot;qty&quot;: 1 &#125;</span></span><br><span class="line"><span class="string">                  ]</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                  &quot;orderId&quot;: &quot;O1002&quot;,</span></span><br><span class="line"><span class="string">                  &quot;amount&quot;: 59.90,</span></span><br><span class="line"><span class="string">                  &quot;status&quot;: &quot;CREATED&quot;,</span></span><br><span class="line"><span class="string">                  &quot;items&quot;: [</span></span><br><span class="line"><span class="string">                    &#123; &quot;sku&quot;: &quot;SKU-3&quot;, &quot;price&quot;: 59.90, &quot;qty&quot;: 1 &#125;</span></span><br><span class="line"><span class="string">                  ]</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">              ],</span></span><br><span class="line"><span class="string">              &quot;stats&quot;: &#123;</span></span><br><span class="line"><span class="string">                &quot;loginCount&quot;: 10,</span></span><br><span class="line"><span class="string">                &quot;balance&quot;: 300.5</span></span><br><span class="line"><span class="string">              &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>;</span><br><span class="line"><span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">RJsonBucket&lt;User&gt; bucket = redissonClient.getJsonBucket(<span class="string">&quot;user:10001&quot;</span>, <span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(User.class));</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> objectMapper.readValue(userStr, User.class);</span><br><span class="line">bucket.set(user);</span><br></pre></td></tr></table></figure><h3 id="JSONPath-æŸ¥è¯¢ç¤ºä¾‹">JSONPath æŸ¥è¯¢ç¤ºä¾‹</h3><ul class="lvl-0"><li class="lvl-2"><p>1ï¸âƒ£ åŸºç¡€è·¯å¾„è®¿é—®</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å–å…¨éƒ¨æ•°æ®</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.GET user:10001</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.GET user:10001 $.profile</span><br><span class="line"><span class="string">&quot;[&#123;\&quot;name\&quot;:\&quot;Alice\&quot;,\&quot;age\&quot;:28,\&quot;vip\&quot;:true&#125;]&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–ç”¨æˆ·å</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.GET user:10001 $.profile.name</span><br><span class="line"><span class="string">&quot;[\&quot;Alice\&quot;]&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> bucket.get(<span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;User&gt;() &#123;&#125;));</span><br><span class="line"></span><br><span class="line">User.<span class="type">ProfileBean</span> <span class="variable">profile</span> <span class="operator">=</span> bucket.get(<span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;User.ProfileBean&gt;() &#123;&#125;),<span class="string">&quot;profile&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> bucket.get(<span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;String&gt;() &#123;&#125;),<span class="string">&quot;profile.name&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŠ ä¸Š $. å‰ç¼€ï¼Œè¿”å›å€¼å¿…é¡»æ˜¯ List&lt;T&gt;</span></span><br><span class="line">List&lt;String&gt; names = bucket.get(<span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;String&gt;&gt;() &#123;&#125;),<span class="string">&quot;$.profile.name&quot;</span>);</span><br><span class="line">System.out.println(names.get(<span class="number">0</span>));</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>2ï¸âƒ£ æ•°ç»„è®¿é—® &amp; é€šé…ç¬¦</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å–æ‰€æœ‰è®¢å•ID</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.GET user:10001 $.orders[*].orderId</span><br><span class="line"><span class="string">&quot;[\&quot;O1001\&quot;,\&quot;O1002\&quot;]&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–æ‰€æœ‰åœ°å€çš„åŸå¸‚</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.GET user:10001 $.addresses[*].city</span><br><span class="line"><span class="string">&quot;[\&quot;Beijing\&quot;,\&quot;Shanghai\&quot;]&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; orderIds = bucket.get(<span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;String&gt;&gt;() &#123;&#125;),<span class="string">&quot;$.orders[*].orderId&quot;</span>);</span><br><span class="line"></span><br><span class="line">List&lt;String&gt; citys = bucket.get(<span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;String&gt;&gt;() &#123;&#125;),<span class="string">&quot;$.addresses[*].city&quot;</span>);</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>3ï¸âƒ£ æ•°ç»„ä¸‹æ ‡ä¸åˆ‡ç‰‡</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å–ç¬¬ä¸€ä¸ªè®¢å•</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.GET user:10001 $.orders[0]</span><br><span class="line"><span class="string">&quot;[&#123;\&quot;orderId\&quot;:\&quot;O1001\&quot;,\&quot;amount\&quot;:199.99,\&quot;status\&quot;:\&quot;PAID\&quot;,\&quot;items\&quot;:[&#123;\&quot;sku\&quot;:\&quot;SKU-1\&quot;,\&quot;price\&quot;:99.99,\&quot;qty\&quot;:1&#125;,&#123;\&quot;sku\&quot;:\&quot;SKU-2\&quot;,\&quot;price\&quot;:100,\&quot;qty\&quot;:1&#125;]&#125;]&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªè®¢å•ï¼Œåˆ‡ç‰‡é€»è¾‘æ˜¯ [start:end]ï¼Œ start &lt;= x &lt; end ï¼Œendä¸å†™é»˜è®¤ä¸ºæ•°ç»„æœ«å°¾</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.GET user:10001 $.orders[0:2]</span><br><span class="line"><span class="string">&quot;[&#123;\&quot;orderId\&quot;:\&quot;O1001\&quot;,\&quot;amount\&quot;:199.99,\&quot;status\&quot;:\&quot;PAID\&quot;,\&quot;items\&quot;:[&#123;\&quot;sku\&quot;:\&quot;SKU-1\&quot;,\&quot;price\&quot;:99.99,\&quot;qty\&quot;:1&#125;,&#123;\&quot;sku\&quot;:\&quot;SKU-2\&quot;,\&quot;price\&quot;:100,\&quot;qty\&quot;:1&#125;]&#125;,&#123;\&quot;orderId\&quot;:\&quot;O1002\&quot;,\&quot;amount\&quot;:59.9,\&quot;status\&quot;:\&quot;CREATED\&quot;,\&quot;items\&quot;:[&#123;\&quot;sku\&quot;:\&quot;SKU-3\&quot;,\&quot;price\&quot;:59.9,\&quot;qty\&quot;:1&#125;]&#125;]&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–æ‰€æœ‰è®¢å•ï¼Œè¿™é‡Œç­‰åŒäº $.orders[*]</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.GET user:10001 $.orders[:]</span><br><span class="line"><span class="string">&quot;[&#123;\&quot;orderId\&quot;:\&quot;O1001\&quot;,\&quot;amount\&quot;:199.99,\&quot;status\&quot;:\&quot;PAID\&quot;,\&quot;items\&quot;:[&#123;\&quot;sku\&quot;:\&quot;SKU-1\&quot;,\&quot;price\&quot;:99.99,\&quot;qty\&quot;:1&#125;,&#123;\&quot;sku\&quot;:\&quot;SKU-2\&quot;,\&quot;price\&quot;:100,\&quot;qty\&quot;:1&#125;]&#125;,&#123;\&quot;orderId\&quot;:\&quot;O1002\&quot;,\&quot;amount\&quot;:59.9,\&quot;status\&quot;:\&quot;CREATED\&quot;,\&quot;items\&quot;:[&#123;\&quot;sku\&quot;:\&quot;SKU-3\&quot;,\&quot;price\&quot;:59.9,\&quot;qty\&quot;:1&#125;]&#125;]&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;OrdersBean&gt; orders = bucket.get(<span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;OrdersBean&gt;&gt;() &#123;&#125;),<span class="string">&quot;$.orders[0]&quot;</span>);</span><br><span class="line"></span><br><span class="line">orders = bucket.get(<span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;OrdersBean&gt;&gt;() &#123;&#125;),<span class="string">&quot;$.orders[0:2]&quot;</span>);</span><br><span class="line"></span><br><span class="line">orders = bucket.get(<span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;OrdersBean&gt;&gt;() &#123;&#125;),<span class="string">&quot;$.orders[:]&quot;</span>);</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>4ï¸âƒ£ é€’å½’æŸ¥è¯¢ï¼ˆâ€¦ï¼‰</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ğŸ‘‰ æ‰¾å‡ºæ‰€æœ‰å•†å“ä»·æ ¼ï¼ˆä¸ç®¡åœ¨å“ªä¸€å±‚ï¼‰</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.GET user:10001 $..price</span><br><span class="line"><span class="string">&quot;[99.99,100,59.9]&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Double&gt; prices = bucket.get(<span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;Double&gt;&gt;() &#123;&#125;),<span class="string">&quot;$..price&quot;</span>);</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>5ï¸âƒ£ æ¡ä»¶è¿‡æ»¤ï¼ˆJSONPath æ ¸å¿ƒèƒ½åŠ›ï¼‰</p></li></ul><blockquote><p>âœ… æ”¯æŒçš„æŸ¥è¯¢</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ğŸ‘‰ æ‰¾å‡ºæ‰€æœ‰è®¢å•é‡‘é¢å¤§äº100çš„è®¢å•ï¼Œâœ… æ•°å­—æ¯”è¾ƒ</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.GET user:10001 $.orders[?(@.amount&gt;100)]</span><br><span class="line"><span class="string">&quot;[&#123;\&quot;orderId\&quot;:\&quot;O1001\&quot;,\&quot;amount\&quot;:199.99,\&quot;status\&quot;:\&quot;PAID\&quot;,\&quot;items\&quot;:[&#123;\&quot;sku\&quot;:\&quot;SKU-1\&quot;,\&quot;price\&quot;:99.99,\&quot;qty\&quot;:1&#125;,&#123;\&quot;sku\&quot;:\&quot;SKU-2\&quot;,\&quot;price\&quot;:100,\&quot;qty\&quot;:1&#125;]&#125;]&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ğŸ‘‰ æ‰¾å‡ºæ‰€æœ‰è®¢å•ä¸­ç¬¬ä¸€ä¸ªå•†å“ä»·æ ¼å¤§äº50çš„è®¢å•ï¼Œâœ… æ•°ç»„æ¡ä»¶</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.GET user:10001 $.orders[?(@.items[0].price&gt;50)]</span><br><span class="line"><span class="string">&quot;[&#123;\&quot;orderId\&quot;:\&quot;O1001\&quot;,\&quot;amount\&quot;:199.99,\&quot;status\&quot;:\&quot;PAID\&quot;,\&quot;items\&quot;:[&#123;\&quot;sku\&quot;:\&quot;SKU-1\&quot;,\&quot;price\&quot;:99.99,\&quot;qty\&quot;:1&#125;,&#123;\&quot;sku\&quot;:\&quot;SKU-2\&quot;,\&quot;price\&quot;:100,\&quot;qty\&quot;:1&#125;]&#125;,&#123;\&quot;orderId\&quot;:\&quot;O1002\&quot;,\&quot;amount\&quot;:59.9,\&quot;status\&quot;:\&quot;CREATED\&quot;,\&quot;items\&quot;:[&#123;\&quot;sku\&quot;:\&quot;SKU-3\&quot;,\&quot;price\&quot;:59.9,\&quot;qty\&quot;:1&#125;]&#125;]&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ğŸ‘‰ æ‰¾å‡ºæ‰€æœ‰è®¢å•é‡‘é¢å¤§äº100å¹¶ä¸”è®¢å•ä¸­ç¬¬ä¸€ä¸ªå•†å“ä»·æ ¼å¤§äº50çš„è®¢å•ï¼Œâœ… é€»è¾‘è¿ç®—ç¬¦</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.GET user:10001 $.orders[?(@.amount&gt;100)&amp;&amp;(@.items[0].price&gt;50)]</span><br><span class="line"><span class="string">&quot;[&#123;\&quot;orderId\&quot;:\&quot;O1001\&quot;,\&quot;amount\&quot;:199.99,\&quot;status\&quot;:\&quot;PAID\&quot;,\&quot;items\&quot;:[&#123;\&quot;sku\&quot;:\&quot;SKU-1\&quot;,\&quot;price\&quot;:99.99,\&quot;qty\&quot;:1&#125;,&#123;\&quot;sku\&quot;:\&quot;SKU-2\&quot;,\&quot;price\&quot;:100,\&quot;qty\&quot;:1&#125;]&#125;]&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;OrdersBean&gt; orders = bucket.get(<span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;OrdersBean&gt;&gt;() &#123;&#125;),<span class="string">&quot;$.orders[?(@.amount&gt;100)]&quot;</span>);</span><br><span class="line"></span><br><span class="line">orders = bucket.get(<span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;OrdersBean&gt;&gt;() &#123;&#125;),<span class="string">&quot;$.orders[?(@.items[0].price&gt;50)]&quot;</span>);</span><br><span class="line"></span><br><span class="line">orders = bucket.get(<span class="keyword">new</span> <span class="title class_">JacksonCodec</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;OrdersBean&gt;&gt;() &#123;&#125;),<span class="string">&quot;$.orders[?(@.amount&gt;100)&amp;&amp;(@.items[0].price&gt;50)]&quot;</span>);</span><br></pre></td></tr></table></figure><blockquote><p>âŒ ä¸æ”¯æŒçš„æŸ¥è¯¢</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># ğŸ‘‰ æ‰¾å‡ºæ‰€æœ‰å·²æ”¯ä»˜è®¢å•ï¼ŒâŒ ä¸æ”¯æŒå­—ç¬¦ä¸²çš„æ¯”è¾ƒ</span><br><span class="line">JSON.GET user:10001 $.orders[?(@.status==&quot;PAID&quot;)]</span><br><span class="line"># ğŸ‘‰ æ‰¾å‡ºæ‰€æœ‰å·²æ”¯ä»˜è®¢å•ï¼ŒâŒ ä¸æ”¯æŒæ­£åˆ™åŒ¹é…</span><br><span class="line">JSON.GET user:10001 $.orders[?(@.status=~&quot;PAID&quot;)]</span><br><span class="line"></span><br><span class="line"># ğŸ‘‰ æ‰¾å‡ºæ‰€æœ‰è®¢å•ä¸­å•†å“ä»·æ ¼å¤§äº50çš„è®¢å•ï¼Œè¿™ä¸ªå°±ä¸å‡†ï¼ŒâŒ ä¸æ”¯æŒåµŒå¥—æ•°ç»„æ¡ä»¶ï¼ˆ@.items[*].xxxï¼‰</span><br><span class="line">127.0.0.1:6379&gt; JSON.GET user:10001 $.orders[?(@.items[*].price&gt;50)]</span><br><span class="line">&quot;[&#123;\&quot;orderId\&quot;:\&quot;O1002\&quot;,\&quot;amount\&quot;:59.9,\&quot;status\&quot;:\&quot;CREATED\&quot;,\&quot;items\&quot;:[&#123;\&quot;sku\&quot;:\&quot;SKU-3\&quot;,\&quot;price\&quot;:59.9,\&quot;qty\&quot;:1&#125;]&#125;]&quot;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>6ï¸âƒ£ ä¿®æ”¹æ•°æ®ï¼ˆJSON.SET / JSON.NUMINCRBYï¼‰</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ğŸ‘‰ ä¿®æ”¹ç”¨æˆ·å</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.SET user:10001 $.profile.name <span class="string">&#x27;&quot;Alice Zhang&quot;&#x27;</span></span><br><span class="line">OK</span><br><span class="line"><span class="comment"># ğŸ‘‰ ç”¨æˆ·ç™»å½•æ¬¡æ•° +1</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.NUMINCRBY user:10001 $.stats.loginCount 1</span><br><span class="line"><span class="string">&quot;[11]&quot;</span> <span class="comment"># è¿”å›ä¿®æ”¹åçš„å€¼</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bucket.set(<span class="string">&quot;$.profile.name&quot;</span>, <span class="string">&quot;Alice Zhang&quot;</span>);</span><br><span class="line"><span class="comment">// æ³¨æ„å¦‚ä¸‹æ–¹æ³•ä¼šå¢åŠ æˆåŠŸï¼Œä½†æ˜¯ä¼šæŠ›å¼‚å¸¸ï¼Œåº”è¯¥æ˜¯Redissonçš„bug</span></span><br><span class="line"><span class="comment">// Caused by: java.lang.NumberFormatException: For input string: &quot;[11]&quot;</span></span><br><span class="line">bucket.incrementAndGet(<span class="string">&quot;$.stats.loginCount&quot;</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>7ï¸âƒ£ æ•°ç»„æ“ä½œï¼ˆARRAPPEND / ARRINSERTï¼‰</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ğŸ‘‰ æ·»åŠ ä¸€ä¸ªè®¢å•</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.ARRAPPEND user:10001 $.orders <span class="string">&#x27;&#123;&quot;orderId&quot;: &quot;O1003&quot;,&quot;amount&quot;: 399,&quot;status&quot;: &quot;PAID&quot;,&quot;items&quot;: [&#123; &quot;sku&quot;: &quot;SKU-9&quot;, &quot;price&quot;: 399, &quot;qty&quot;: 1 &#125;]&#125;&#x27;</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 3 <span class="comment"># è¿”å›æ·»åŠ åçš„é•¿åº¦</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ğŸ‘‰ åœ¨ tags çš„æœ€åæ·»åŠ ä¸€ä¸ªæ ‡ç­¾</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.ARRAPPEND user:10001 $.tags <span class="string">&#x27;&quot;newTag&quot;&#x27;</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 4 <span class="comment"># æ·»åŠ åçš„é•¿åº¦</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ğŸ‘‰ åœ¨ tags ä¸­çš„æŒ‡å®šä½ç½®æ’å…¥ä¸€ä¸ªæ ‡ç­¾</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.ARRINSERT user:10001 $.tags 1 <span class="string">&#x27;&quot;newTag2&quot;&#x27;</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 5 <span class="comment"># æ’å…¥åçš„é•¿åº¦</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">OrdersBean</span> <span class="variable">ordersBean</span> <span class="operator">=</span> OrdersBean.builder()</span><br><span class="line">                .orderId(<span class="string">&quot;O1003&quot;</span>)</span><br><span class="line">                .amount(<span class="number">399</span>)</span><br><span class="line">                .status(<span class="string">&quot;CREATED&quot;</span>)</span><br><span class="line">                .items(List.of(</span><br><span class="line">                        OrdersBean.ItemsBean.builder()</span><br><span class="line">                                .sku(<span class="string">&quot;SKU-9&quot;</span>)</span><br><span class="line">                                .qty(<span class="number">1</span>)</span><br><span class="line">                                .price(<span class="number">399</span>).build()</span><br><span class="line">                )).build();</span><br><span class="line"><span class="comment">// æ·»åŠ ä¸€ä¸ªè®¢å•ï¼Œè¿”å›æ·»åŠ åçš„é•¿åº¦</span></span><br><span class="line"><span class="type">long</span> <span class="variable">num</span> <span class="operator">=</span> bucket.arrayAppend(<span class="string">&quot;$.orders&quot;</span>, ordersBean);</span><br><span class="line"></span><br><span class="line">num = bucket.arrayAppend(<span class="string">&quot;$.tags&quot;</span>, <span class="string">&quot;newTag&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ’å…¥æˆåŠŸï¼Œä½†æ˜¯ä¼šæŠ›å¼‚å¸¸ï¼Œåº”è¯¥æ˜¯Redissonçš„bug</span></span><br><span class="line">num = bucket.arrayInsert(<span class="string">&quot;$.tags&quot;</span>, <span class="number">1</span>, <span class="string">&quot;newTag2&quot;</span>);</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>8ï¸âƒ£ åˆ é™¤ &amp; æ¸…ç†æ“ä½œï¼ˆJSON.DEL &amp; JSON.CLEARï¼‰</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ğŸ‘‰ åˆ é™¤ç”¨æˆ·å¹´é¾„ï¼Œ$.profile.age ä¸å­˜åœ¨äº†</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.DEL user:10001 $.profile.age</span><br><span class="line">(<span class="built_in">integer</span>) 1 <span class="comment"># åˆ é™¤æˆåŠŸï¼Œè¿”å›0ï¼Œè¡¨ç¤ºè·¯å¾„ä¸å­˜åœ¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ğŸ‘‰ æ¸…ç©ºç”¨æˆ·æ‰€æœ‰æ ‡ç­¾ï¼Œ$.tags ä¿ç•™ï¼Œåªæ˜¯å˜æˆäº† [] ç©ºæ•°ç»„</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.CLEAR user:10001 $.tags</span><br><span class="line">(<span class="built_in">integer</span>) 1 <span class="comment"># æ¸…ç©ºæˆåŠŸï¼Œè¿”å›0ï¼Œè¡¨ç¤ºè·¯å¾„ä¸å­˜åœ¨æˆ–å·²ç»æ¸…ç©º</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">delete</span> <span class="operator">=</span> bucket.delete(<span class="string">&quot;$.profile.age&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="variable">clear</span> <span class="operator">=</span> bucket.clear(<span class="string">&quot;$.tags&quot;</span>);</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>9ï¸âƒ£ ç»Ÿè®¡æ•°ç»„é•¿åº¦</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ğŸ‘‰ ç»Ÿè®¡ç”¨æˆ·è®¢å•çš„é•¿åº¦</span></span><br><span class="line">127.0.0.1:6379&gt; JSON.ARRLEN user:10001 $.orders</span><br><span class="line">1) (<span class="built_in">integer</span>) 3</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼šæŠ›å¼‚å¸¸ï¼Œåº”è¯¥æ˜¯Redissonçš„bug</span></span><br><span class="line"><span class="type">long</span> <span class="variable">length</span> <span class="operator">=</span> bucket.arraySize(<span class="string">&quot;$.orders&quot;</span>);</span><br></pre></td></tr></table></figure><p>ğŸ”Ÿ æŸ¥çœ‹ JSON å ç”¨å†…å­˜</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; JSON.DEBUG MEMORY user:10001</span><br><span class="line">(<span class="built_in">integer</span>) 1896 <span class="comment"># å ç”¨å†…å­˜å¤§å°ï¼Œå•ä½å­—èŠ‚</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">sizeInMemory</span> <span class="operator">=</span> bucket.sizeInMemory();</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡ä»‹ç» Redis æ‰©å±•æ¨¡å‹ RedisJSON ä¸­çš„ JSON æ•°æ®ç±»å‹&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡åŸºäº&lt;code&gt;redis-7.4.7&lt;/code&gt;ï¼Œ&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Rediså®˜ç½‘ï¼š&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis å‘½ä»¤æ–‡æ¡£ï¼š&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;RedisJSON çš„å®‰è£…å‚è§ &lt;a href=&quot;/2025/12/24/redis7-module-RedisJSON/&quot; title=&quot;Redis æ‰©å±•æ¨¡å— -- RedisJSON çš„å®‰è£…æ–¹æ³•&quot;&gt;Redis æ‰©å±•æ¨¡å— -- RedisJSON çš„å®‰è£…æ–¹æ³•&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;ç¤ºä¾‹ä»£ç ï¼š&lt;a href=&quot;https://github.com/hanqunfeng/springbootchapter/tree/master/springboot3-demo/redis-demo/redisson-demo&quot;&gt;GitHub&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis æ‰©å±•æ¨¡å— -- RedisJSON çš„å®‰è£…æ–¹æ³•</title>
    <link href="https://blog.hanqunfeng.com/2025/12/24/redis7-module-RedisJSON/"/>
    <id>https://blog.hanqunfeng.com/2025/12/24/redis7-module-RedisJSON/</id>
    <published>2025-12-24T13:30:05.000Z</published>
    <updated>2026-01-05T02:21:23.571Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2">æœ¬æ–‡ä»‹ç» Redis æ‰©å±•æ¨¡å— â€“ RedisJSON çš„å®‰è£…æ–¹æ³•</li><li class="lvl-2">æœ¬æ–‡åŸºäº<code>redis-7.4.7</code>ï¼Œ<code>springboot-3.5.8</code></li><li class="lvl-2">æ“ä½œç³»ç»Ÿï¼š<code>Amazon Linux 2023(å†…æ ¸ 6.1)</code></li><li class="lvl-2">Rediså®˜ç½‘ï¼š<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis å‘½ä»¤æ–‡æ¡£ï¼š<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li></ul><span id="more"></span><h2 id="RedisJSON-ç®€ä»‹">RedisJSON ç®€ä»‹</h2><ul class="lvl-0"><li class="lvl-2"><p><a href="https://github.com/RedisJSON/RedisJSON">RedisJSON</a> æ˜¯ Redis å®˜æ–¹ç»´æŠ¤çš„ä¸€ä¸ªæ‰©å±•æ¨¡å—ï¼Œéš¶å±äº <code>Redis Stack</code>ï¼Œä¸“é—¨ç”¨äºå¯¹JSONæ•°æ®è¿›è¡Œæ“ä½œã€‚</p></li><li class="lvl-2"><p>è¯¥æ¨¡å—ä»¥ <code>Redis Module</code> æ–¹å¼åŠ è½½ï¼Œå¯æ— ç¼é›†æˆåˆ°ç°æœ‰ Redis å®ä¾‹ä¸­ã€‚</p></li><li class="lvl-2"><p>Redis8+ï¼ŒRedisJSON å·²ç»å†…ç½®åœ¨ Redis ä¸­ï¼Œå¯ä»¥åœ¨å®‰è£…redisåŒæ—¶å®‰è£…å…¨éƒ¨ Stack æ¨¡å—ã€‚</p></li></ul><h2 id="å®‰è£…-RedisJSON">å®‰è£… RedisJSON</h2><ul class="lvl-0"><li class="lvl-2"><p>è™½ç„¶<a href="https://cloud.redis.io">Redis Cloud</a>çš„<code>Download Center</code>ä¸­æä¾›äº†æ‰€æœ‰Redisæ¨¡å—ç¼–è¯‘åçš„<code>.so</code>æ–‡ä»¶ï¼Œä½†æ˜¯å¹¶ä¸ä¿è¯ä¸€å®šå…¼å®¹ï¼Œæ‰€ä»¥æœ€ç¨³å¦¥çš„æ–¹å¼æ˜¯é€šè¿‡æºç è‡ªå·±ç¼–è¯‘ã€‚</p></li></ul><blockquote><p>å®‰è£…æ—¶éœ€è¦ç§‘å­¦ä¸Šç½‘ï¼Œä¸»è¦æ˜¯å®‰è£…ä¾èµ–æ—¶éœ€è¦ä»æµ·å¤–ç½‘ä¸‹è½½ï¼Œå¦‚æœè¦éƒ¨ç½²åœ¨å›½å†…æœåŠ¡å™¨ï¼Œå¯èƒ½ä¼šè¿æ¥å¤±è´¥ã€‚<br>å¯ä»¥åœ¨æµ·å¤–çš„<code>ç›¸åŒé…ç½®</code>çš„æœåŠ¡å™¨ä¸Šè¿›è¡Œç¼–è¯‘ï¼Œä¹‹åå°†ç¼–è¯‘å¥½çš„<code>rejson.so</code>ä¸Šä¼ åˆ°å›½å†…æœåŠ¡å™¨å³å¯ã€‚</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>å®‰è£…ä¾èµ–</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dnf install -y \</span><br><span class="line">  gcc \</span><br><span class="line">  gcc-c++ \</span><br><span class="line">  make \</span><br><span class="line">  cmake \</span><br><span class="line">  autoconf \</span><br><span class="line">  automake \</span><br><span class="line">  libtool \</span><br><span class="line">  pkgconfig \</span><br><span class="line">  openssl-devel</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¼–è¯‘RedisJSON</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /usr/local/soft/modules/</span><br><span class="line"><span class="built_in">cd</span> /usr/local/soft/modules</span><br><span class="line"><span class="comment"># clone ä»£ç ï¼Œè¿™é‡Œ --recursive æ˜¯ä¸ºäº†æ‹‰å–å­æ¨¡å—</span></span><br><span class="line">git <span class="built_in">clone</span> --recursive https://github.com/RedisJSON/RedisJSON.git</span><br><span class="line"><span class="built_in">cd</span> RedisJSON</span><br><span class="line"><span class="comment"># æ¨èåˆ‡æ¢åˆ°ç¨³å®šçš„releaseç‰ˆæœ¬</span></span><br><span class="line">git checkout v2.8.16</span><br><span class="line"><span class="comment"># æ›´æ–°å­æ¨¡å—ï¼Œéå¿…é¡»ï¼Œå¦‚æœä¸Šé¢ clone æ—¶æ²¡æœ‰åŠ ä¸Š --recursive ï¼Œè¿™ä¸ªæ­¥éª¤å°±ä¸èƒ½çœç•¥</span></span><br><span class="line">git submodule update --init --recursive</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥å¹¶å®‰è£…éœ€è¦çš„ä¾èµ–</span></span><br><span class="line">./sbin/setup</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line"><span class="comment"># readies version: 7fc8e62</span></span><br><span class="line">dnf install -q -y ca-certificates</span><br><span class="line">dnf install -q -y wget unzip</span><br><span class="line">/usr/local/soft/modules/RedisJSON/deps/readies/bin/enable-utf8</span><br><span class="line">dnf install -q -y git unzip rsync</span><br><span class="line">/usr/local/soft/modules/RedisJSON/deps/readies/bin/getclang --modern</span><br><span class="line">/usr/local/soft/modules/RedisJSON/deps/readies/bin/getrust</span><br><span class="line">/usr/local/soft/modules/RedisJSON/deps/readies/bin/getcmake --usr</span><br><span class="line">dnf install -q -y <span class="built_in">which</span></span><br><span class="line">/usr/local/soft/modules/RedisJSON/deps/readies/bin/getgcc --modern</span><br><span class="line"><span class="built_in">dir</span>=$(<span class="built_in">mktemp</span> -d /tmp/tar.XXXXXX); (<span class="built_in">cd</span> <span class="variable">$dir</span>; wget --no-verbose -O tar.tgz http://redismodules.s3.amazonaws.com/readies/gnu/gnu-tar-1.32-x64-centos7.tgz; tar -xzf tar.tgz -C /; ); <span class="built_in">rm</span> -rf <span class="variable">$dir</span></span><br><span class="line">dnf install -q -y lcov</span><br><span class="line">/usr/bin/python3 /usr/local/soft/modules/RedisJSON/deps/readies/bin/getrmpytools --reinstall --modern</span><br><span class="line">/usr/bin/python3 -m pip install --disable-pip-version-check --user  -r /usr/local/soft/modules/RedisJSON/tests/pytest/requirements.txt</span><br><span class="line">/usr/local/soft/modules/RedisJSON/deps/readies/bin/getaws</span><br><span class="line">NO_PY2=1 /usr/local/soft/modules/RedisJSON/deps/readies/bin/getpudb</span><br><span class="line"></span><br><span class="line"><span class="comment"># RedisJSON çš„ç¼–è¯‘ä¾èµ– Rust å·¥å…·é“¾ï¼Œæ‰€ä»¥ç¼–è¯‘å‰éœ€è¦å®‰è£…rustï¼Œè‹¥å·²ç»å®‰è£…åˆ™å¿½ç•¥</span></span><br><span class="line"><span class="comment"># å®‰è£… rustup</span></span><br><span class="line">curl --proto <span class="string">&#x27;=https&#x27;</span> --tlsv1.2 -sSf https://sh.rustup.rs | sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‰æç¤ºé€‰æ‹©é»˜è®¤å®‰è£…ï¼ˆé€šå¸¸é€‰æ‹© 1ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®© Rust ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="built_in">source</span> <span class="variable">$HOME</span>/.cargo/env</span><br><span class="line"><span class="comment"># æ£€æŸ¥ rust ç‰ˆæœ¬</span></span><br><span class="line">rustc --version <span class="comment"># rustc 1.92.0 (ded5c06cf 2025-12-08)</span></span><br><span class="line">cargo --version <span class="comment"># cargo 1.92.0 (344c4567c 2025-10-21)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘ RedisJSON</span></span><br><span class="line">make</span><br><span class="line"><span class="comment"># ç¼–è¯‘è¿‡ç¨‹æœªæŠ¥é”™è¯´æ˜ç¼–è¯‘æˆåŠŸï¼Œç¼–è¯‘åçš„æ–‡ä»¶ä½äº `bin/linux-x64-release/rejson.so`</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><div class="tips"><p><em><strong><code>./sbin/setup</code> æŠ¥é”™</strong></em></p><ul class="lvl-1"><li class="lvl-2">æœ¬äººä½¿ç”¨çš„æ˜¯ Amazon Linux 2023(å†…æ ¸ 6.1)ï¼Œå³ <code>EL9</code>ï¼Œç±»ä¼¼äºCentOS 9ï¼Œç¬¬ä¸€æ¬¡è¿è¡Œä¼šæŠ¥é”™ï¼Œå¤§è‡´æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">./sbin/setup</span><br><span class="line"><span class="comment">## é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">â€¦â€¦</span><br><span class="line">[FAILED] raven-release.el9.noarch.rpm: Status code: 403 <span class="keyword">for</span> https://dyn.su/el9/base/x86_64/raven-release.el9.noarch.rpm (IP: 104.21.57.14)</span><br><span class="line">Status code: 403 <span class="keyword">for</span> https://dyn.su/el9/base/x86_64/raven-release.el9.noarch.rpm (IP: 104.21.57.14)</span><br><span class="line"></span><br><span class="line">In /usr/local/soft/modules/RedisJSON/deps/readies/bin/getepel:</span><br><span class="line">346      <span class="comment"># xinstall --allowerasing https://dl.fedoraproject.org/pub/epel/epel-release-latest-$&#123;EPEL&#125;.noarch.rpm</span></span><br><span class="line">347      <span class="keyword">fi</span></span><br><span class="line">348</span><br><span class="line">349  &gt;&gt;&gt; install_raven</span><br><span class="line">350      install_remi</span><br><span class="line">351      <span class="comment"># install_centos_stream_repos</span></span><br><span class="line">352</span><br><span class="line"></span><br><span class="line"><span class="built_in">command</span> failed: /usr/local/soft/modules/RedisJSON/deps/readies/bin/getepel</span><br><span class="line"><span class="built_in">command</span> failed: /usr/local/soft/modules/RedisJSON/deps/readies/bin/getclang --modern</span><br><span class="line"></span><br><span class="line">In /usr/local/soft/modules/RedisJSON/sbin/setup:</span><br><span class="line">18       python3 -m pip list</span><br><span class="line">19       <span class="keyword">fi</span></span><br><span class="line">20</span><br><span class="line">21   &gt;&gt;&gt; <span class="variable">$ROOT</span>/sbin/system-setup.py</span><br><span class="line">22       <span class="keyword">if</span> [[ <span class="variable">$VERBOSE</span> == 1 ]]; <span class="keyword">then</span></span><br><span class="line">23       python3 -m pip list</span><br><span class="line">24       <span class="keyword">fi</span></span><br></pre></td></tr></table></figure><ul class="lvl-1"><li class="lvl-2"><p>é”™è¯¯åˆ†æä¸è§£å†³æ–¹æ³•ï¼š</p><ul class="lvl-3"><li class="lvl-6"><p>è¿™é‡Œå®é™…ä¸Šæ˜¯ä¸¤ä¸ªé”™è¯¯ï¼Œç¬¬ä¸€ä¸ªé”™è¯¯ä¸å®‰è£… RedisBloom æ—¶ä¸€æ ·ï¼Œç¦ç”¨æ‰ <code>install_raven</code> å³å¯ï¼Œå…·ä½“å‚è§ <a href="/2025/12/21/redis7-module-RedisBloom/" title="Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•">Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•</a> è¿›è¡Œä¿®æ”¹ã€‚</p></li><li class="lvl-6"><p>ç¬¬äºŒä¸ªé”™è¯¯è¿˜æ˜¯æ“ä½œç³»ç»Ÿçš„äº‹ï¼Œåœ¨ <code>deps/readies/bin/getclang</code>ä¸­æœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œå…¶å®ä¸€çœ‹å°±æ˜ç™½äº†</p></li></ul>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">redhat_compat</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.modern:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="variable language_">self</span>.run(<span class="string">&quot;%s/bin/getepel&quot;</span> % READIES, sudo=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="variable language_">self</span>.dist <span class="keyword">in</span> [<span class="string">&#x27;centos&#x27;</span>, <span class="string">&#x27;ol&#x27;</span>] <span class="keyword">and</span> <span class="variable language_">self</span>.os_version[<span class="number">0</span>] &gt;= <span class="number">8</span>:</span><br><span class="line">        <span class="variable language_">self</span>.install(<span class="string">&quot;clang&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.install(<span class="string">&quot;llvm-toolset&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="variable language_">self</span>.install(<span class="string">&quot;llvm-toolset-7.0&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.cp_to_profile_d(<span class="string">&quot;/opt/rh/llvm-toolset-7.0/enable&quot;</span>, <span class="string">&quot;llvm-toolset-7.0.sh&quot;</span>)</span><br></pre></td></tr></table></figure><p>æˆ‘ä½¿ç”¨çš„æœºå™¨ä¸æ˜¯ centosï¼Œæ‰€ä»¥å°±èµ°<code>else</code>çš„é€»è¾‘äº†ï¼Œå¦å¤–è¿™é‡Œå³ä¾¿èµ°äº† centos é€»è¾‘ï¼Œä¹Ÿæœ‰é—®é¢˜ï¼Œå°±æ˜¯el9ä¸­å·²ç»æ²¡æœ‰ <code>llvm-toolset</code> äº†ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ <code>llvm</code>ï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹è¯¥æ–¹æ³•</p><ul class="lvl-3"><li class="lvl-6">ä¿®æ”¹æ–¹æ³•å¦‚ä¸‹ï¼š</li></ul>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">redhat_compat</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.modern:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="variable language_">self</span>.run(<span class="string">&quot;%s/bin/getepel&quot;</span> % READIES, sudo=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># å»æ‰åˆ¤æ–­ï¼Œç›´æ¥å®‰è£…ï¼Œå‰ææ˜¯ el9ï¼Œå½“ç„¶è¿™é‡Œä¹Ÿå¯ä»¥ä»€ä¹ˆéƒ½ä¸å†™ï¼Œè€Œæ˜¯é€šè¿‡å‘½ä»¤è¡Œå®‰è£…ï¼šdnf install -y clang llvm llvm-devel</span></span><br><span class="line">    <span class="variable language_">self</span>.install(<span class="string">&quot;clang&quot;</span>)</span><br><span class="line">    <span class="variable language_">self</span>.install(<span class="string">&quot;llvm&quot;</span>)</span><br></pre></td></tr></table></figure></li></ul></div><h2 id="Redis-å¯ç”¨æ¨¡å—">Redis å¯ç”¨æ¨¡å—</h2><ul class="lvl-0"><li class="lvl-2"><p>å°†ç”Ÿæˆçš„ <code>rejson.so</code> æ‹·è´åˆ° redis çš„ modules ç›®å½•ä¸‹ï¼ˆéå¿…é¡»ï¼‰ï¼Œç›®å½•ä¸å­˜åœ¨åˆ™åˆ›å»º</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ³¨æ„ .so æ–‡ä»¶éœ€è¦åŒ…å«å¯æ‰§è¡Œæƒé™</span></span><br><span class="line"><span class="built_in">cp</span> bin/linux-x64-release/rejson.so /usr/local/soft/redis-7.4.7/modules/rejson.so</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æœ¬æ–‡é‡‡ç”¨ <code>loadmodule</code> åŠ è½½æ¨¡å—</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°† rejson.so æ·»åŠ åˆ° redis.conf ä¸­ï¼Œéœ€è¦é‡å¯ redis</span></span><br><span class="line">loadmodule /usr/local/soft/redis-7.4.7/modules/rejson.so</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨redis</span></span><br><span class="line">redis-server redis.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç™»å½•æµ‹è¯•</span></span><br><span class="line">redis-cli --user admin --pass 123456</span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ¨¡å—</span></span><br><span class="line">127.0.0.1:6379&gt; info Modules</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line"><span class="comment"># Modules</span></span><br><span class="line">module:name=ReJSON,ver=20816,api=1,filters=0,usedby=[],using=[],options=[handle-io-errors]</span><br><span class="line">module:name=bf,ver=20817,api=1,filters=0,usedby=[],using=[],options=[handle-io-errors]</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; MODULE LIST</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">1) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;ReJSON&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 20816</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/local/soft/redis-7.4.7/modules/rejson.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line">2) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;bf&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 20817</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/local/soft/redis-7.4.7/modules/redisbloom.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡ä»‹ç» Redis æ‰©å±•æ¨¡å— â€“ RedisJSON çš„å®‰è£…æ–¹æ³•&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡åŸºäº&lt;code&gt;redis-7.4.7&lt;/code&gt;ï¼Œ&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æ“ä½œç³»ç»Ÿï¼š&lt;code&gt;Amazon Linux 2023(å†…æ ¸ 6.1)&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Rediså®˜ç½‘ï¼š&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis å‘½ä»¤æ–‡æ¡£ï¼š&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis å‘½ä»¤åŠæ•°æ®ç±»å‹ -- TDigest</title>
    <link href="https://blog.hanqunfeng.com/2025/12/23/redis7-datatype-15-TDigest/"/>
    <id>https://blog.hanqunfeng.com/2025/12/23/redis7-datatype-15-TDigest/</id>
    <published>2025-12-23T07:40:05.000Z</published>
    <updated>2025-12-23T09:53:35.193Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2">æœ¬æ–‡ä»‹ç» Redis æ‰©å±•æ¨¡å‹ RedisBloom ä¸­çš„ TDigest æ•°æ®ç±»å‹</li><li class="lvl-2">æœ¬æ–‡åŸºäº<code>redis-7.4.7</code>ï¼Œ<code>springboot-3.5.8</code></li><li class="lvl-2">Rediså®˜ç½‘ï¼š<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis å‘½ä»¤æ–‡æ¡£ï¼š<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li><li class="lvl-2">RedisBloom çš„å®‰è£…å‚è§ <a href="/2025/12/21/redis7-module-RedisBloom/" title="Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•">Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•</a></li></ul><span id="more"></span><h2 id="T-Digest-åˆ†ä½æ•°ä¼°è®¡ç®—æ³•">T-Digest(åˆ†ä½æ•°ä¼°è®¡ç®—æ³•)</h2><ul class="lvl-0"><li class="lvl-2"><p>T-Digestï¼ˆTDigestï¼‰è§£å†³çš„é—®é¢˜ä¸ CMSã€TopK å®Œå…¨ä¸åŒï¼Œæ ¸å¿ƒç›®æ ‡æ˜¯ åˆ†ä½æ•°ï¼ˆquantileï¼‰ç»Ÿè®¡ã€‚</p></li><li class="lvl-2"><p>T-Digest ç”± Ted Dunning æå‡ºï¼Œä¸“é—¨ä¸º <code>é«˜ç²¾åº¦å°¾éƒ¨åˆ†ä½æ•°</code> è®¾è®¡ã€‚</p></li><li class="lvl-2"><p>TDigest å¯ä»¥åœ¨æä½å†…å­˜å ç”¨ä¸‹ï¼Œè¿‘ä¼¼è®¡ç®—åˆ†ä½æ•°ï¼ˆP50 / P90 / P99 / Median ç­‰ï¼‰ã€‚</p></li><li class="lvl-2"><p>åˆ†ä½æ•°ï¼ˆPercentileï¼‰æŒ‡æ ‡å¯¹ç…§è¡¨</p></li></ul><table><thead><tr><th>æŒ‡æ ‡</th><th>è‹±æ–‡å…¨ç§°</th><th>æ•°å­¦å«ä¹‰</th><th>é€šä¿—è§£é‡Š</th><th>å…¸å‹ä¸šåŠ¡è§£è¯»</th><th>å¸¸è§ä½¿ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>Median</td><td>Median</td><td>æ’åºåä½äºä¸­é—´ä½ç½®çš„å€¼</td><td>ä¸€åŠæ•°æ®åœ¨å®ƒå·¦å³</td><td>â€œä¸€èˆ¬ç”¨æˆ·çš„ä½“éªŒâ€</td><td>åŸºç¡€ä½“éªŒè¯„ä¼°</td></tr><tr><td>P50</td><td>50th Percentile</td><td>50% çš„æ•°æ® â‰¤ è¯¥å€¼</td><td>å’Œ Median å®Œå…¨ç›¸åŒ</td><td>â€œå…¸å‹è¯·æ±‚è€—æ—¶â€</td><td>å¸¸è§„æ€§èƒ½ç›‘æ§</td></tr><tr><td>P90</td><td>90th Percentile</td><td>90% çš„æ•°æ® â‰¤ è¯¥å€¼</td><td>10% çš„è¯·æ±‚æ›´æ…¢</td><td>â€œå¤§å¤šæ•°ç”¨æˆ·çš„ä½“éªŒâ€</td><td>ä¸šåŠ¡ä½“éªŒç›‘æ§</td></tr><tr><td>P95</td><td>95th Percentile</td><td>95% çš„æ•°æ® â‰¤ è¯¥å€¼</td><td>5% çš„è¯·æ±‚æ›´æ…¢</td><td>â€œå°¾éƒ¨å¼€å§‹æ¶åŒ–â€</td><td>SLA è¾¹ç•Œç›‘æ§</td></tr><tr><td>P99</td><td>99th Percentile</td><td>99% çš„æ•°æ® â‰¤ è¯¥å€¼</td><td>1% çš„è¯·æ±‚æœ€æ…¢</td><td>â€œæç«¯ä½†çœŸå®çš„ç”¨æˆ·ä½“éªŒâ€</td><td>æ ¸å¿ƒ SLA / SLO</td></tr><tr><td>P99.9</td><td>99.9th Percentile</td><td>99.9% çš„æ•°æ® â‰¤ è¯¥å€¼</td><td>åƒåˆ†ä¹‹ä¸€æœ€æ…¢è¯·æ±‚</td><td>â€œæç«¯å°¾å»¶è¿Ÿâ€</td><td>é‡‘è / æ ¸å¿ƒé“¾è·¯</td></tr><tr><td>Max</td><td>Maximum</td><td>æ•°æ®ä¸­çš„æœ€å¤§å€¼</td><td>æœ€æ…¢çš„é‚£ä¸€æ¬¡</td><td>å™ªéŸ³æå¤§</td><td>å‡ ä¹ä¸ç”¨</td></tr></tbody></table><blockquote><p>ä¸€ä¸ªå¿«é€Ÿç†è§£ç¤ºä¾‹</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">å‡è®¾ 100 æ¬¡è¯·æ±‚ï¼š</span><br><span class="line">    99 æ¬¡è€—æ—¶ï¼š10 ms</span><br><span class="line">    1 æ¬¡è€—æ—¶ï¼š3000 ms</span><br><span class="line"></span><br><span class="line">æ‰€ä»¥ï¼š</span><br><span class="line">    P99 = 3000 ms</span><br><span class="line">    P90 = 10 ms</span><br><span class="line">    P50/Median = 10 ms</span><br><span class="line">    å¹³å‡å€¼ = ï¼ˆ99*10 + 1*3000ï¼‰/ 100 = 39.9 ms</span><br><span class="line"></span><br><span class="line">ğŸ‘‰ åªæœ‰ P99 çœŸå®æš´éœ²äº†é—®é¢˜ã€‚</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å·¥ç¨‹å®è·µä¸­çš„â€œæ ‡å‡†æ­é…â€</p></li></ul><table><thead><tr><th>åº”ç”¨åœºæ™¯</th><th>å¸¸çœ‹æŒ‡æ ‡</th></tr></thead><tbody><tr><td>Web / API æœåŠ¡</td><td>P90 / P99</td></tr><tr><td>å¾®æœåŠ¡é“¾è·¯</td><td>P99 / P99.9</td></tr><tr><td>æ•°æ®åº“ / å­˜å‚¨</td><td>P95 / P99</td></tr><tr><td>å‰ç«¯ä½“éªŒ</td><td>P50 / P90</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>ä¸€å¥è¯ï¼šTDigest ç”¨äºç»Ÿè®¡æ•°å­—çš„åˆ†å¸ƒï¼ŒP50 çœ‹ä¸­é—´ï¼ŒP90 çœ‹å¤§å¤šæ•°ï¼ŒP99 çœ‹æœ€å·®é‚£ 1%</p></li></ul><h2 id="RedisBloom-ä¸­-TDigest-çš„æ ¸å¿ƒå‘½ä»¤">RedisBloom ä¸­ TDigest çš„æ ¸å¿ƒå‘½ä»¤</h2><h3 id="åˆ›å»º-TDigest">åˆ›å»º TDigest</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TDIGEST.CREATE key [COMPRESSION compression]</span></span><br><span class="line"><span class="comment"># å‚æ•°è¯´æ˜</span></span><br><span class="line"><span class="comment"># keyï¼š TDigest çš„åç§°</span></span><br><span class="line"><span class="comment"># compressionï¼š å‹ç¼©çº§åˆ«ï¼Œé»˜è®¤ä¸º 100ï¼Œè¶Šå¤§ â†’ ç²¾åº¦è¶Šé«˜ â†’ å†…å­˜è¶Šå¤§</span></span><br><span class="line"><span class="comment"># ç¤ºä¾‹</span></span><br><span class="line">TDIGEST.CREATE latency:td COMPRESSION 200</span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å– TDigest çš„ç±»å‹</span></span><br><span class="line"><span class="built_in">type</span> latency:td</span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">TDIS-TYPE</span><br></pre></td></tr></table></figure><h3 id="æ·»åŠ æ ·æœ¬">æ·»åŠ æ ·æœ¬</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TDIGEST.ADD key value [value ...]</span></span><br><span class="line"><span class="comment"># ç¤ºä¾‹</span></span><br><span class="line">TDIGEST.ADD latency:td 12.3 15.7 100.4</span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">OK</span><br></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹æœ€å¤§-æœ€å°å€¼">æŸ¥çœ‹æœ€å¤§/æœ€å°å€¼</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å–æœ€å¤§å€¼</span></span><br><span class="line"><span class="comment"># TDIGEST.MAX key</span></span><br><span class="line"><span class="comment"># ç¤ºä¾‹</span></span><br><span class="line">TDIGEST.MAX latency:td</span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line"><span class="string">&quot;100.4&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å–æœ€å°å€¼</span></span><br><span class="line"><span class="comment"># TDIGEST.MIN key</span></span><br><span class="line"><span class="comment"># ç¤ºä¾‹</span></span><br><span class="line">TDIGEST.MIN latency:td</span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line"><span class="string">&quot;12.3&quot;</span></span><br></pre></td></tr></table></figure><h3 id="æŸ¥è¯¢åˆ†ä½æ•°">æŸ¥è¯¢åˆ†ä½æ•°</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TDIGEST.QUANTILE key quantile [quantile ...]</span></span><br><span class="line"><span class="comment"># å‚æ•°è¯´æ˜</span></span><br><span class="line"><span class="comment"># keyï¼š TDigest çš„åç§°</span></span><br><span class="line"><span class="comment"># quantileï¼š æŸ¥è¯¢çš„åˆ†ä½æ•°ï¼Œ0.5=&gt;P50 / 0.9=&gt;P90 / 0.99=&gt;P99</span></span><br><span class="line"><span class="comment"># ç¤ºä¾‹</span></span><br><span class="line">TDIGEST.QUANTILE latency:td 0.5 0.9 0.99</span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">1) <span class="string">&quot;15.7&quot;</span></span><br><span class="line">2) <span class="string">&quot;100.4&quot;</span></span><br><span class="line">3) <span class="string">&quot;100.4&quot;</span></span><br></pre></td></tr></table></figure><h3 id="åå‘æŸ¥è¯¢ï¼ˆå€¼-â†’-ç™¾åˆ†ä½ï¼‰">åå‘æŸ¥è¯¢ï¼ˆå€¼ â†’ ç™¾åˆ†ä½ï¼‰</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TDIGEST.CDF key value [value ...]</span></span><br><span class="line"><span class="comment"># ç¤ºä¾‹</span></span><br><span class="line">TDIGEST.CDF latency:td 12.3 15.7 100.4 20</span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">1) <span class="string">&quot;0.16666666666666666&quot;</span></span><br><span class="line">2) <span class="string">&quot;0.5&quot;</span></span><br><span class="line">3) <span class="string">&quot;0.8333333333333334&quot;</span></span><br><span class="line">4) <span class="string">&quot;0.6666666666666666&quot;</span>  <span class="comment"># è¿™é‡Œæ³¨æ„ value ä¸å¿…é¡»åœ¨ TDIGEST ä¸­ï¼Œè¿™é‡Œçš„å«ä¹‰æ˜¯ P66=20ï¼Œå³ 66% çš„å€¼éƒ½ â‰¤ 20</span></span><br></pre></td></tr></table></figure><h3 id="åˆå¹¶-TDigest">åˆå¹¶ TDigest</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TDIGEST.MERGE destination-key numkeys source-key [source-key ...] [COMPRESSION compression] [OVERRIDE]</span></span><br><span class="line"><span class="comment"># å‚æ•°è¯´æ˜</span></span><br><span class="line"><span class="comment"># destination-keyï¼š ç›®æ ‡ TDigest çš„åç§°</span></span><br><span class="line"><span class="comment"># numkeysï¼š æº TDigest çš„æ•°é‡</span></span><br><span class="line"><span class="comment"># source-keyï¼š æº TDigest çš„åç§°</span></span><br><span class="line"><span class="comment"># compressionï¼š å‹ç¼©çº§åˆ«ï¼Œé»˜è®¤ä¸º 100ï¼Œè¶Šå¤§ â†’ ç²¾åº¦è¶Šé«˜ â†’ å†…å­˜è¶Šå¤§</span></span><br><span class="line"><span class="comment"># OVERRIDEï¼š æ˜¯å¦è¦†ç›–ç›®æ ‡ TDigestï¼Œé»˜è®¤ä¸º false</span></span><br><span class="line"><span class="comment"># ç¤ºä¾‹</span></span><br><span class="line">TDIGEST.MERGE latency:td 2 latency:td:1 latency:td:2 COMPRESSION 200 OVERRIDE</span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">OK</span><br></pre></td></tr></table></figure><h3 id="è·å–è¿‘ä¼¼æ’å">è·å–è¿‘ä¼¼æ’å</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ­£å‘æ’å</span></span><br><span class="line"><span class="comment"># TDIGEST.RANK key value [value ...]</span></span><br><span class="line"><span class="comment"># ç¤ºä¾‹</span></span><br><span class="line"><span class="comment"># TDIGEST.ADD latency:td 12.3 15.7 100.4 # å‡è®¾è¿™äº›æ•°æ®å·²ç»å†™å…¥äº† TDigest</span></span><br><span class="line"><span class="comment"># å¦‚æœæŠŠ value æ”¾å…¥å½“å‰åˆ†å¸ƒä¸­ï¼Œå®ƒçš„ rankï¼ˆå°äºè¯¥å€¼çš„æ ·æœ¬æ•°é‡ï¼‰æ˜¯å¤šå°‘</span></span><br><span class="line">TDIGEST.RANK latency:td 0 12.3 15.7 20 100.4 200</span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">1) (<span class="built_in">integer</span>) -1   <span class="comment"># 0: å°äºæœ€å°å€¼ 12.3 â†’ è¿”å› -1</span></span><br><span class="line">2) (<span class="built_in">integer</span>) 0    <span class="comment"># 12.3: ç¬¬ 0 ä½ â†’ è¿”å› 0ï¼ŒçœŸå®å­˜åœ¨çš„ä½æ•°</span></span><br><span class="line">3) (<span class="built_in">integer</span>) 1    <span class="comment"># 15.7: æ’åœ¨ 12.3 å â†’ è¿”å› 1ï¼ŒçœŸå®å­˜åœ¨çš„ä½æ•°</span></span><br><span class="line">4) (<span class="built_in">integer</span>) 2    <span class="comment"># 20: ä»‹äº 15.7 ä¸ 100.4 ä¹‹é—´ â†’ è¿”å› 2</span></span><br><span class="line">5) (<span class="built_in">integer</span>) 2    <span class="comment"># 100.4: ç¬¬ 2 ä½ â†’ 20ï¼ŒçœŸå®å­˜åœ¨çš„ä½æ•°</span></span><br><span class="line">6) (<span class="built_in">integer</span>) 3    <span class="comment"># 200: å¤§äº 100.4 â†’ è¿”å› 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åå‘æ’å</span></span><br><span class="line"><span class="comment"># TDIGEST.REVRANK key value [value ...]</span></span><br><span class="line"><span class="comment"># ç¤ºä¾‹</span></span><br><span class="line">TDIGEST.REVRANK latency:td 0 12.3 15.7 20 100.4 200</span><br></pre></td></tr></table></figure><h2 id="æ ¹æ®æ’åè·å–å…ƒç´ ">æ ¹æ®æ’åè·å–å…ƒç´ </h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ­£å‘æ’å</span></span><br><span class="line"><span class="comment"># TDIGEST.BYRANK key rank [rank ...]</span></span><br><span class="line"><span class="comment"># ç¤ºä¾‹</span></span><br><span class="line">TDIGEST.BYRANK latency:td 0 1 2 3</span><br><span class="line"><span class="comment"># è¾“å‡ºç»“æœ</span></span><br><span class="line">1) <span class="string">&quot;12.3&quot;</span></span><br><span class="line">2) <span class="string">&quot;15.7&quot;</span></span><br><span class="line">3) <span class="string">&quot;100.4&quot;</span></span><br><span class="line">4) <span class="string">&quot;inf&quot;</span>  <span class="comment"># ä¸å­˜åœ¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åå‘æ’å</span></span><br><span class="line"><span class="comment"># TDIGEST.BYREVRANK key rank [rank ...]</span></span><br><span class="line"><span class="comment"># ç¤ºä¾‹</span></span><br><span class="line">TDIGEST.BYREVRANK latency:td 0 1 2 3</span><br></pre></td></tr></table></figure><h3 id="è®¡ç®—-TDigest-å†…éƒ¨æ ·æœ¬-å»æ‰å°¾éƒ¨æå€¼åçš„å¹³å‡è¿‘ä¼¼å€¼ï¼ˆTrimmed-Meanï¼Œæˆªæ–­å‡å€¼ï¼‰">è®¡ç®— TDigest å†…éƒ¨æ ·æœ¬ å»æ‰å°¾éƒ¨æå€¼åçš„å¹³å‡è¿‘ä¼¼å€¼ï¼ˆTrimmed Meanï¼Œæˆªæ–­å‡å€¼ï¼‰</h3><ul class="lvl-0"><li class="lvl-2"><p>å»æ‰æ•°æ®åˆ†å¸ƒçš„æç«¯å°¾éƒ¨ï¼Œåªç®—ä¸»è¦é›†ä¸­åŒºåŸŸçš„å¹³å‡å€¼ï¼Œè¿™æ ·æ›´èƒ½ä»£è¡¨â€œç»å¤§å¤šæ•°ç”¨æˆ·çš„ä½“éªŒâ€</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TDIGEST.TRIMMED_MEAN key low_cut_quantile high_cut_quantile</span></span><br><span class="line"><span class="comment"># å‚æ•°è¯´æ˜</span></span><br><span class="line"><span class="comment"># keyï¼š TDigest çš„åç§°</span></span><br><span class="line"><span class="comment"># low_cut_quantileï¼š å»æ‰çš„å·¦ä¾§ç™¾åˆ†æ¯”</span></span><br><span class="line"><span class="comment"># high_cut_quantileï¼š å»æ‰çš„å³ä¾§ç™¾åˆ†æ¯”</span></span><br><span class="line"><span class="comment"># ç¤ºä¾‹</span></span><br><span class="line">TDIGEST.TRIMMED_MEAN latency:td 0.05 0.95</span><br><span class="line"><span class="comment"># è¾“å‡ºç»“æœ</span></span><br><span class="line"><span class="string">&quot;42.800000000000004&quot;</span></span><br></pre></td></tr></table></figure><h3 id="è·å–-TDigest-çš„ä¿¡æ¯">è·å– TDigest çš„ä¿¡æ¯</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TDIGEST.INFO key</span></span><br><span class="line"><span class="comment"># ç¤ºä¾‹</span></span><br><span class="line">TDIGEST.INFO latency:td</span><br><span class="line"><span class="comment"># è¾“å‡ºç»“æœ</span></span><br><span class="line"> 1) Compression     <span class="comment"># å‹ç¼©çº§åˆ«ï¼Œæ§åˆ¶è´¨å¿ƒçš„æ•°é‡ä¸ç²¾åº¦ã€‚å€¼è¶Šå¤§ â†’ ç²¾åº¦è¶Šé«˜ï¼Œå†…å­˜ç¨å¤§ã€‚</span></span><br><span class="line"> 2) (<span class="built_in">integer</span>) 200</span><br><span class="line"> 3) Capacity       <span class="comment"># è´¨å¿ƒæœ€å¤§å®¹é‡ã€‚è¡¨ç¤ºå†…éƒ¨èƒ½å®¹çº³çš„æœ€å¤§èŠ‚ç‚¹æ•°ï¼Œå®é™…ä½¿ç”¨ä¸­ TDigest ä¼šåŠ¨æ€åˆå¹¶è´¨å¿ƒä»¥æ§åˆ¶å†…å­˜ã€‚</span></span><br><span class="line"> 4) (<span class="built_in">integer</span>) 1210</span><br><span class="line"> 5) Merged nodes   <span class="comment"># å·²åˆå¹¶çš„è´¨å¿ƒæ•°é‡ã€‚è¿™äº›æ˜¯ TDigest å½“å‰å‹ç¼©åçš„èŠ‚ç‚¹ï¼Œç”¨äºè®¡ç®— rank / quantileã€‚</span></span><br><span class="line"> 6) (<span class="built_in">integer</span>) 3</span><br><span class="line"> 7) Unmerged nodes <span class="comment"># æœªåˆå¹¶çš„èŠ‚ç‚¹æ•°é‡ã€‚è¡¨ç¤ºæ–°åŠ å…¥ä½†å°šæœªå‹ç¼©åˆ°è´¨å¿ƒçš„æ ·æœ¬ã€‚</span></span><br><span class="line"> 8) (<span class="built_in">integer</span>) 0</span><br><span class="line"> 9) Merged weight  <span class="comment"># å·²åˆå¹¶è´¨å¿ƒçš„æ€»æƒé‡ã€‚æ¯ä¸ªæ ·æœ¬æƒé‡é»˜è®¤ä¸º 1ï¼Œ3 è¡¨ç¤ºç›®å‰æ€»å…±æœ‰ 3 ä¸ªæ ·æœ¬è¢«åˆå¹¶è¿›è´¨å¿ƒã€‚</span></span><br><span class="line">10) (<span class="built_in">integer</span>) 3</span><br><span class="line">11) Unmerged weight <span class="comment"># æœªåˆå¹¶èŠ‚ç‚¹çš„æƒé‡æ€»å’Œã€‚0 è¡¨ç¤ºæ²¡æœ‰æœªå‹ç¼©çš„æ ·æœ¬</span></span><br><span class="line">12) (<span class="built_in">integer</span>) 0</span><br><span class="line">13) Observations    <span class="comment"># è§‚æµ‹åˆ°çš„æ ·æœ¬æ€»æ•°ã€‚ä½  TDIGEST.ADD çš„ 3 ä¸ªæ ·æœ¬æ­£å¥½å¯¹åº”è¿™ä¸ªå€¼ã€‚</span></span><br><span class="line">14) (<span class="built_in">integer</span>) 3</span><br><span class="line">15) Total compressions <span class="comment"># å·²ç»æ‰§è¡Œçš„å‹ç¼©æ¬¡æ•°ã€‚æ¯æ¬¡ TDigest å†…éƒ¨è´¨å¿ƒåˆå¹¶ç§°ä¸ºä¸€æ¬¡å‹ç¼©ã€‚</span></span><br><span class="line">16) (<span class="built_in">integer</span>) 1</span><br><span class="line">17) Memory usage     <span class="comment"># Redis ä¸ºè¿™ä¸ª TDigest åˆ†é…çš„å†…å­˜ï¼ˆå­—èŠ‚ï¼‰ã€‚åŒ…å«è´¨å¿ƒã€ç´¢å¼•ã€ç»“æ„å¼€é”€ã€‚TDigest å†…å­˜ä½¿ç”¨æ˜¯å›ºå®šçš„ã€ä¸æ ·æœ¬æ•°é‡æ— å…³ï¼ˆä¸»è¦ç”± Compression å†³å®šï¼‰</span></span><br><span class="line">18) (<span class="built_in">integer</span>) 19368</span><br></pre></td></tr></table></figure><h3 id="æ¸…ç©ºå…ƒç´ ">æ¸…ç©ºå…ƒç´ </h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TDIGEST.RESET key</span></span><br><span class="line"><span class="comment"># ç¤ºä¾‹</span></span><br><span class="line">TDIGEST.RESET latency:td</span><br><span class="line"><span class="comment"># è¾“å‡ºç»“æœ</span></span><br><span class="line">OK</span><br></pre></td></tr></table></figure><h2 id="TDigest-çš„å†…å­˜ä¸ç²¾åº¦">TDigest çš„å†…å­˜ä¸ç²¾åº¦</h2><table><thead><tr><th>ç»´åº¦</th><th>ç‰¹æ€§</th></tr></thead><tbody><tr><td>å†…å­˜å ç”¨</td><td>ä¸ COMPRESSION æˆæ­£æ¯”ï¼ˆé€šå¸¸ KB çº§ï¼‰</td></tr><tr><td>ç²¾åº¦</td><td>å°¾éƒ¨åˆ†ä½æ•°ï¼ˆP95/P99ï¼‰æé«˜</td></tr><tr><td>å†™å…¥å¤æ‚åº¦</td><td>è¿‘ä¼¼ O(log n)</td></tr><tr><td>æŸ¥è¯¢å¤æ‚åº¦</td><td>O(log n)</td></tr></tbody></table><blockquote><p>ä¸æ ·æœ¬æ•°é‡æ— å…³ã€‚</p></blockquote>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡ä»‹ç» Redis æ‰©å±•æ¨¡å‹ RedisBloom ä¸­çš„ TDigest æ•°æ®ç±»å‹&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡åŸºäº&lt;code&gt;redis-7.4.7&lt;/code&gt;ï¼Œ&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Rediså®˜ç½‘ï¼š&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis å‘½ä»¤æ–‡æ¡£ï¼š&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;RedisBloom çš„å®‰è£…å‚è§ &lt;a href=&quot;/2025/12/21/redis7-module-RedisBloom/&quot; title=&quot;Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•&quot;&gt;Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis å‘½ä»¤åŠæ•°æ®ç±»å‹ -- TopK</title>
    <link href="https://blog.hanqunfeng.com/2025/12/23/redis7-datatype-14-TopK/"/>
    <id>https://blog.hanqunfeng.com/2025/12/23/redis7-datatype-14-TopK/</id>
    <published>2025-12-23T06:50:05.000Z</published>
    <updated>2025-12-24T03:37:03.539Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2">æœ¬æ–‡ä»‹ç» Redis æ‰©å±•æ¨¡å‹ RedisBloom ä¸­çš„ TopK æ•°æ®ç±»å‹</li><li class="lvl-2">æœ¬æ–‡åŸºäº<code>redis-7.4.7</code>ï¼Œ<code>springboot-3.5.8</code></li><li class="lvl-2">Rediså®˜ç½‘ï¼š<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis å‘½ä»¤æ–‡æ¡£ï¼š<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li><li class="lvl-2">RedisBloom çš„å®‰è£…å‚è§ <a href="/2025/12/21/redis7-module-RedisBloom/" title="Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•">Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•</a></li></ul><span id="more"></span><h2 id="TopK">TopK</h2><ul class="lvl-0"><li class="lvl-2"><p>TopKï¼Œä¸“é—¨ç”¨äºè§£å†³ â€œåœ¨æµ·é‡æ•°æ®æµä¸­ï¼Œå®æ—¶æ‰¾å‡ºæœ€çƒ­é—¨çš„ N ä¸ªå…ƒç´ â€ è¿™ä¸€ç±»é—®é¢˜</p></li><li class="lvl-2"><p>Top-K å±äºæµå¼é‡é¢‘ï¼ˆHeavy Hittersï¼‰ç®—æ³•å®¶æ—ï¼Œå…¶ç›®æ ‡ä¸æ˜¯è®°å½•æ‰€æœ‰å…ƒç´ ï¼Œè€Œæ˜¯ï¼š</p><ul class="lvl-2"><li class="lvl-6">åœ¨å—é™å†…å­˜ä¸‹ï¼ŒæŒç»­ç»´æŠ¤å‡ºç°é¢‘ç‡æœ€é«˜çš„ K ä¸ªå…ƒç´ </li></ul></li><li class="lvl-3"><p>TopK çš„æ ¸å¿ƒç‰¹æ€§</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å›ºå®šå®¹é‡ï¼šåªç»´æŠ¤ K ä¸ªå…ƒç´ </span><br><span class="line">è¿‘ä¼¼ç»Ÿè®¡ï¼šè®¡æ•°å¯èƒ½ç•¥æœ‰è¯¯å·®</span><br><span class="line">è‡ªåŠ¨æ·˜æ±°ï¼šä½é¢‘å…ƒç´ ä¼šè¢«è¸¢å‡º</span><br><span class="line">å†™å…¥æå¿«ï¼šé€‚åˆé«˜ QPS</span><br><span class="line">å†…å­˜ç¨³å®šï¼šä¸æ•°æ®è§„æ¨¡æ— å…³</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>RedisBloom çš„ TopK å†…éƒ¨ä½¿ç”¨ CMS ä½œä¸ºé¢‘æ¬¡ä¼°ç®—åŸºç¡€ï¼Œå¹¶ç»“åˆ<code>å †+æ·˜æ±°ç­–ç•¥</code>æ¥ç»´æŠ¤çƒ­ç‚¹é›†åˆã€‚</p><ul class="lvl-2"><li class="lvl-6">CMS: å‚è€ƒ <a href="/2025/12/23/redis7-datatype-13-CMS/" title="Redis å‘½ä»¤åŠæ•°æ®ç±»å‹ -- CMS(Count-Min Sketch)">Redis å‘½ä»¤åŠæ•°æ®ç±»å‹ -- CMS(Count-Min Sketch)</a></li><li class="lvl-6">å †+æ·˜æ±°ç­–ç•¥: TopK åœ¨å†…éƒ¨å¦‚ä½•å†³å®šè°èƒ½è¿›å…¥ TopKã€è°å¿…é¡»è¢«è¸¢å‡º TopK çš„ä¸€æ•´å¥—æœºåˆ¶ã€‚<ul class="lvl-4"><li class="lvl-10">å †ï¼šTopK ä½¿ç”¨ä¸€ä¸ªæœ€å°å †æ¥ç»´æŠ¤ TopK å…ƒç´ ï¼ŒTopK ç»´æŠ¤ K ä¸ªå€™é€‰å…ƒç´ ï¼Œå †é¡¶æ°¸è¿œæ˜¯ å½“å‰ TopK ä¸­é¢‘æ¬¡æœ€ä½çš„é‚£ä¸ª</li><li class="lvl-10">æ·˜æ±°ç­–ç•¥ï¼šTopK ä½¿ç”¨ä¸€ä¸ª LRU ç¼“å­˜æ¥è®°å½•æœ€è¿‘è®¿é—®çš„å…ƒç´ ï¼Œå½“ TopK å…ƒç´ æ•°é‡è¾¾åˆ°ä¸Šé™æ—¶ï¼Œå°† LRU ç¼“å­˜ä¸­çš„å…ƒç´ é€ä¸ªåŠ å…¥ TopKï¼Œå¹¶æ›´æ–° TopK å…ƒç´ çš„é¢‘ç‡ã€‚</li><li class="lvl-10">ä¸€å¥è¯ï¼šå½“æ–°å…ƒç´ çš„ä¼°ç®—é¢‘æ¬¡è¶…è¿‡å½“å‰æœ€å¼±çš„é‚£ä¸ªæ—¶ï¼Œå°±æŠŠå¼±è€…æ·˜æ±°æ‰ï¼Œè®©æ–°å…ƒç´ è¿›æ¦œã€‚</li></ul></li></ul></li></ul><h3 id="å½“ä¸€ä¸ªæ–°å…ƒç´ åˆ°æ¥æ—¶ï¼Œæˆ‘è¯¥ä¸è¯¥è®©å®ƒè¿›å…¥-TopKï¼Ÿ">å½“ä¸€ä¸ªæ–°å…ƒç´ åˆ°æ¥æ—¶ï¼Œæˆ‘è¯¥ä¸è¯¥è®©å®ƒè¿›å…¥ TopKï¼Ÿ</h3><ul class="lvl-0"><li class="lvl-2"><p>ä¸‹é¢æ˜¯ TopK åœ¨ TOPK.ADD æ—¶çš„çœŸå®é€»è¾‘æŠ½è±¡</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Step 1ï¼šæ›´æ–° CMSï¼ˆä¸å­˜ itemï¼Œåªæ›´æ–°è®¡æ•°å™¨ï¼‰</span></span><br><span class="line">CMS.increment(item)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 2ï¼šitem æ˜¯å¦åœ¨ TopK æ˜¾å¼é›†åˆä¸­ï¼Ÿ</span></span><br><span class="line"><span class="keyword">if</span> item <span class="keyword">in</span> TopK:</span><br><span class="line">    <span class="comment"># é‡æ–°å¹³è¡¡å †ä½ç½®</span></span><br><span class="line">    update_heap(item)</span><br><span class="line">    <span class="built_in">return</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 3ï¼šTopK æ˜¯å¦æœªæ»¡ï¼Ÿ</span></span><br><span class="line"><span class="keyword">if</span> TopK.size &lt; K:</span><br><span class="line">    TopK.insert(item)</span><br><span class="line">    <span class="built_in">return</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 4ï¼šæ¯”è¾ƒ CMS ä¼°ç®—å€¼</span></span><br><span class="line">freq_new = CMS.query(item)</span><br><span class="line">freq_min = CMS.query(TopK.min_item)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> freq_new &gt; freq_min:</span><br><span class="line">    TopK.evict_min()</span><br><span class="line">    TopK.insert(item)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># ä»€ä¹ˆéƒ½ä¸åš</span></span><br><span class="line">    pass</span><br></pre></td></tr></table></figure><h2 id="TopK-çš„åº”ç”¨åœºæ™¯">TopK çš„åº”ç”¨åœºæ™¯</h2><table><thead><tr><th>é—®é¢˜</th><th>TopK æ˜¯å¦é€‚åˆ</th></tr></thead><tbody><tr><td>å½“å‰è®¿é—®é‡æœ€é«˜çš„ URL</td><td>âœ…</td></tr><tr><td>æœç´¢çƒ­è¯ Top 10</td><td>âœ…</td></tr><tr><td>å•†å“ç‚¹å‡»æ¦œ</td><td>âœ…</td></tr><tr><td>æ‰€æœ‰å•†å“çš„ç‚¹å‡»æ¬¡æ•°</td><td>âŒ</td></tr><tr><td>ç²¾ç¡®è®¡æ•°</td><td>âŒ</td></tr></tbody></table><h2 id="RedisBloom-TopK-çš„æ ¸å¿ƒå‘½ä»¤">RedisBloom TopK çš„æ ¸å¿ƒå‘½ä»¤</h2><h3 id="åˆ›å»º-TopK">åˆ›å»º TopK</h3><ul class="lvl-0"><li class="lvl-2"><p>ä½¿ç”¨ TopK å‰å¿…é¡»å…ˆåˆ›å»º TopK</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TOPK.RESERVE key topk [width depth decay]</span></span><br><span class="line"><span class="comment"># å‚æ•°è¯´æ˜</span></span><br><span class="line"><span class="comment"># key: é”®å</span></span><br><span class="line"><span class="comment"># topk: å­˜å‚¨çš„å…ƒç´ æ•°é‡ï¼Œå³ç»Ÿè®¡çš„å‰ K ä¸ªå…ƒç´ </span></span><br><span class="line"><span class="comment"># width: å†…éƒ¨CMS çš„å®½åº¦ï¼Œé»˜è®¤ 8</span></span><br><span class="line"><span class="comment"># depth: å†…éƒ¨CMS çš„æ·±åº¦ï¼Œé»˜è®¤ 7</span></span><br><span class="line"><span class="comment"># decay: è¡°å‡å› å­ï¼ˆ0 ~ 1ï¼‰ï¼Œé»˜è®¤ 0.9</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹</span></span><br><span class="line"><span class="comment"># å«ä¹‰ï¼šç»´æŠ¤è®¿é—®é‡æœ€é«˜çš„ 100 ä¸ª URLï¼Œå…è®¸å†å²çƒ­åº¦é€æ¸è¡°å‡ã€‚</span></span><br><span class="line">TOPK.RESERVE topk:urls 100 2000 7 0.9</span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯ç±»å‹</span></span><br><span class="line"><span class="built_in">type</span> topk:urls</span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">TopK-TYPE</span><br></pre></td></tr></table></figure><h3 id="æ·»åŠ å…ƒç´ ">æ·»åŠ å…ƒç´ </h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TOPK.ADD key items [items ...]</span></span><br><span class="line"><span class="comment"># ç¤ºä¾‹</span></span><br><span class="line"><span class="comment"># å«ä¹‰ï¼šæ·»åŠ å…ƒç´  &quot;a&quot; å’Œ &quot;b&quot; åˆ° TopK ä¸­</span></span><br><span class="line">TOPK.ADD topk:urls a b</span><br><span class="line"><span class="comment"># è¿”å›å€¼ï¼Œè¢«æŒ¤å‡º TopK çš„å…ƒç´ ï¼ˆå¦‚æœæœ‰ï¼‰</span></span><br><span class="line">1) (nil)</span><br><span class="line">2) (nil)</span><br></pre></td></tr></table></figure><h3 id="å¢åŠ å…ƒç´ çš„é¢‘ç‡">å¢åŠ å…ƒç´ çš„é¢‘ç‡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TOPK.INCRBY key item increment [item increment ...]</span></span><br><span class="line"><span class="comment"># ç¤ºä¾‹</span></span><br><span class="line"><span class="comment"># å«ä¹‰ï¼šå°†å…ƒç´  &quot;a&quot; çš„é¢‘ç‡å¢åŠ  1</span></span><br><span class="line">TOPK.INCRBY topk:urls a 1</span><br><span class="line"><span class="comment"># è¾“å‡ºç»“æœ</span></span><br><span class="line">1) (nil)</span><br></pre></td></tr></table></figure><h3 id="æŸ¥è¯¢å…ƒç´ æ˜¯å¦åœ¨-TopK-ä¸­">æŸ¥è¯¢å…ƒç´ æ˜¯å¦åœ¨ TopK ä¸­</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TOPK.QUERY key item [item ...]</span></span><br><span class="line"><span class="comment"># ç¤ºä¾‹</span></span><br><span class="line"><span class="comment"># å«ä¹‰ï¼šæŸ¥è¯¢å…ƒç´  &quot;a&quot; æ˜¯å¦åœ¨ TopK ä¸­</span></span><br><span class="line">TOPK.QUERY topk:urls a</span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 1 <span class="comment"># 1 è¡¨ç¤ºå…ƒç´  &quot;a&quot; åœ¨ TopK ä¸­ï¼Œ0 è¡¨ç¤ºå…ƒç´  &quot;a&quot; ä¸åœ¨ TopK ä¸­</span></span><br></pre></td></tr></table></figure><h3 id="è·å–-TopK-ä¸­çš„å…ƒç´ ">è·å– TopK ä¸­çš„å…ƒç´ </h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TOPK.LIST key [WITHCOUNT]</span></span><br><span class="line"><span class="comment"># å‚æ•°è¯´æ˜</span></span><br><span class="line"><span class="comment"># WITHCOUNT: æ˜¯å¦è¿”å›æ¯ä¸ªå…ƒç´ å‡ºç°çš„æ¬¡æ•°ï¼Œé»˜è®¤ä¸è¿”å›</span></span><br><span class="line"><span class="comment"># ç¤ºä¾‹</span></span><br><span class="line"><span class="comment"># å«ä¹‰ï¼šè·å– TopK ä¸­çš„å…ƒç´ ï¼Œå¹¶è¿”å›æ¯ä¸ªå…ƒç´ å‡ºç°çš„æ¬¡æ•°</span></span><br><span class="line">TOPK.LIST topk:urls WITHCOUNT</span><br><span class="line"><span class="comment"># è¾“å‡ºç»“æœ</span></span><br><span class="line">1) <span class="string">&quot;a&quot;</span></span><br><span class="line">2) (<span class="built_in">integer</span>) 2</span><br><span class="line">3) <span class="string">&quot;b&quot;</span></span><br><span class="line">4) (<span class="built_in">integer</span>) 1</span><br></pre></td></tr></table></figure><h3 id="è·å–è¿‘ä¼¼è®¡æ•°">è·å–è¿‘ä¼¼è®¡æ•°</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TOPK.COUNT key item [item ...]</span></span><br><span class="line"><span class="comment"># ç¤ºä¾‹</span></span><br><span class="line"><span class="comment"># å«ä¹‰ï¼šè·å–å…ƒç´  &quot;a&quot; çš„è¿‘ä¼¼è®¡æ•°</span></span><br><span class="line">TOPK.COUNT topk:urls a</span><br><span class="line"><span class="comment"># è¾“å‡ºç»“æœ</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 2</span><br></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹TopK-çš„çŠ¶æ€">æŸ¥çœ‹TopK çš„çŠ¶æ€</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TOPK.INFO key</span></span><br><span class="line"><span class="comment"># ç¤ºä¾‹</span></span><br><span class="line"><span class="comment"># å«ä¹‰ï¼šæŸ¥çœ‹ TopK çš„çŠ¶æ€</span></span><br><span class="line">TOPK.INFO topk:urls</span><br><span class="line"><span class="comment"># è¾“å‡ºç»“æœ</span></span><br><span class="line">1) k                    <span class="comment"># topk çš„å¤§å°</span></span><br><span class="line">2) (<span class="built_in">integer</span>) 100</span><br><span class="line">3) width                <span class="comment"># å†…éƒ¨ CMS çš„å®½åº¦</span></span><br><span class="line">4) (<span class="built_in">integer</span>) 2000</span><br><span class="line">5) depth                <span class="comment"># å†…éƒ¨ CMS çš„æ·±åº¦</span></span><br><span class="line">6) (<span class="built_in">integer</span>) 7</span><br><span class="line">7) decay                <span class="comment"># è¡°å‡å› å­</span></span><br><span class="line">8) <span class="string">&quot;0.9&quot;</span></span><br></pre></td></tr></table></figure><h2 id="TopK-çš„è¡°å‡ï¼ˆdecayï¼‰å‚æ•°æ€ä¹ˆç†è§£">TopK çš„è¡°å‡ï¼ˆdecayï¼‰å‚æ•°æ€ä¹ˆç†è§£</h2><ul class="lvl-0"><li class="lvl-2"><p>decay ç”¨äºè§£å†³ä¸€ä¸ªé—®é¢˜ï¼šâ€œè€çƒ­ç‚¹æ°¸è¿œéœ¸æ¦œï¼Œæ–°çƒ­ç‚¹ä¸Šä¸æ¥â€</p></li></ul><table><thead><tr><th>decay</th><th>è¡Œä¸º</th></tr></thead><tbody><tr><td>1.0</td><td>æ°¸ä¸è¡°å‡ï¼ˆå…¨å†å²ç»Ÿè®¡ï¼‰</td></tr><tr><td>0.9</td><td>è¶Šè€çš„æ•°æ®æƒé‡è¶Šä½</td></tr><tr><td>0.5</td><td>çƒ­ç‚¹æ›´æ–°éå¸¸å¿«</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>ç»éªŒå€¼ï¼š</p><ul class="lvl-2"><li class="lvl-6">å®æ—¶çƒ­ç‚¹ï¼š0.8 ~ 0.9</li><li class="lvl-6">é•¿å‘¨æœŸæ¦œå•ï¼š0.95 ~ 1.0</li></ul></li></ul><h2 id="CMS-å’Œ-TopK-ç»„åˆä½¿ç”¨åœºæ™¯">CMS å’Œ TopK ç»„åˆä½¿ç”¨åœºæ™¯</h2><h3 id="ğŸ“Œåœºæ™¯1ï¼š-å®æ—¶çƒ­æœæ¦œï¼ˆæœ€ç»å…¸ç»„åˆï¼‰">ğŸ“Œåœºæ™¯1ï¼š å®æ—¶çƒ­æœæ¦œï¼ˆæœ€ç»å…¸ç»„åˆï¼‰</h3><ul class="lvl-0"><li class="lvl-2"><p>éœ€æ±‚ï¼šç»Ÿè®¡æ‰€æœ‰æœç´¢è¯é¢‘æ¬¡ï¼ˆCMSï¼‰ï¼ŒåŒæ—¶å®æ—¶å‡ºTOP10çƒ­æœï¼ˆTOPKï¼‰ï¼Œæ—¢çŸ¥çƒ­åº¦åˆèƒ½æ’åº</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. åˆå§‹åŒ–CMSï¼ˆç»Ÿè®¡å…¨é‡æœç´¢è¯è®¡æ•°ï¼Œè¯¯å·®0.001ï¼‰</span></span><br><span class="line">cms.initbyprob search_count 0.001 0.01</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. åˆå§‹åŒ–TOPKï¼ˆå–TOP10çƒ­æœï¼‰</span></span><br><span class="line">topk.reserve search_top10 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. ç”¨æˆ·æœç´¢æ ¸å¿ƒæ“ä½œï¼ˆ2å‘½ä»¤å¿…ä¸€èµ·æ‰§è¡Œï¼‰</span></span><br><span class="line"><span class="comment"># æœç´¢&quot;å‘¨æ°ä¼¦&quot;ï¼ŒCMSè®¡æ•°+1ï¼ŒåŒæ—¶å½•å…¥TOPKï¼ˆè‡ªåŠ¨ç´¯åŠ çƒ­åº¦ï¼‰</span></span><br><span class="line">cms.incrby search_count å‘¨æ°ä¼¦ 1</span><br><span class="line">topk.incrby search_top10 å‘¨æ°ä¼¦ 1</span><br><span class="line"></span><br><span class="line">cms.incrby search_count åŸç¥ 1</span><br><span class="line">topk.incrby search_top10 åŸç¥ 1</span><br><span class="line">cms.incrby search_count å‘¨æ°ä¼¦ 1  <span class="comment"># é‡å¤æœç´¢ï¼ŒåŒç«¯åŒæ­¥+1</span></span><br><span class="line">topk.incrby search_top10 å‘¨æ°ä¼¦ 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. æ ¸å¿ƒæŸ¥è¯¢ï¼šå…ˆå–TOP10ï¼Œå†æŸ¥ç²¾å‡†è®¡æ•°ï¼ˆç»„åˆæ ¸å¿ƒï¼‰</span></span><br><span class="line"><span class="comment"># ç¬¬ä¸€æ­¥ï¼šå–TOP10çƒ­æœåˆ—è¡¨</span></span><br><span class="line">topk.list search_top10  <span class="comment"># è¿”å›ï¼šå‘¨æ°ä¼¦ã€åŸç¥...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¬¬äºŒæ­¥ï¼šæŸ¥çƒ­æœè¯ç²¾å‡†è¿‘ä¼¼è®¡æ•°ï¼ˆCMSæ¯”TOPK.countæ›´å‡†ï¼‰</span></span><br><span class="line">cms.query search_count å‘¨æ°ä¼¦  <span class="comment"># è¿”å›2ï¼ˆç²¾å‡†ï¼‰</span></span><br><span class="line">topk.count search_top10 å‘¨æ°ä¼¦  <span class="comment"># å‚è€ƒå€¼ï¼Œä¼˜å…ˆç”¨CMSç»“æœ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. è¾…åŠ©æŸ¥è¯¢ï¼šåˆ¤æ–­è¯æ˜¯å¦åœ¨çƒ­æœæ¦œ</span></span><br><span class="line">topk.query search_top10 å‘¨æ°ä¼¦  <span class="comment"># 1=åœ¨ï¼Œ0=ä¸åœ¨</span></span><br></pre></td></tr></table></figure><h2 id="TopK-vs-ZSET">TopK vs ZSET</h2><ul class="lvl-0"><li class="lvl-2"><p>èƒ½åŠ›è¾¹ç•Œå¯¹æ¯”</p></li></ul><table><thead><tr><th>èƒ½åŠ›</th><th>TopK</th><th>ZSet</th></tr></thead><tbody><tr><td>æ˜¯å¦è¿‘ä¼¼</td><td>âœ”ï¸ æ˜¯</td><td>âŒ å¦</td></tr><tr><td>æ˜¯å¦ä¿å­˜å…¨éƒ¨å…ƒç´ </td><td>âŒ åªä¿å­˜ Top K</td><td>âœ”ï¸ ä¿å­˜å…¨éƒ¨</td></tr><tr><td>é¢‘æ¬¡æ˜¯å¦ç²¾ç¡®</td><td>âŒ ä¼°è®¡</td><td>âœ”ï¸ ç²¾ç¡®</td></tr><tr><td>æ˜¯å¦æ”¯æŒæ’åº</td><td>âš ï¸ ä»… Top K</td><td>âœ”ï¸ å…¨é‡æ’åº</td></tr><tr><td>æ˜¯å¦å¯éå†</td><td>âŒ ä»… K ä¸ª</td><td>âœ”ï¸ å…¨é‡</td></tr><tr><td>æ˜¯å¦æ”¯æŒåˆ é™¤</td><td>âŒ ä¸æ”¯æŒ</td><td>âœ”ï¸ æ”¯æŒ</td></tr><tr><td>æ˜¯å¦æ”¯æŒèŒƒå›´æŸ¥è¯¢</td><td>âŒ</td><td>âœ”ï¸</td></tr><tr><td>Top N æŸ¥è¯¢</td><td>âœ”ï¸ åŸç”Ÿ</td><td>âœ”ï¸</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>æ€§èƒ½ä¸ååé‡å¯¹æ¯”</p></li></ul><table><thead><tr><th>ç»´åº¦</th><th>TopK</th><th>ZSet</th></tr></thead><tbody><tr><td>å†™å…¥å¤æ‚åº¦</td><td>O(d)</td><td>O(log N)</td></tr><tr><td>é«˜å¹¶å‘å†™å…¥</td><td>æä¼˜</td><td>ä¸€èˆ¬</td></tr><tr><td>æŸ¥è¯¢ TopK</td><td>O(K)</td><td>O(K)</td></tr><tr><td>æŸ¥è¯¢å•å…ƒç´ é¢‘æ¬¡</td><td>O(d)</td><td>O(1)</td></tr><tr><td>æ‰¹é‡å†™å…¥</td><td>æå¿«</td><td>è¾ƒæ…¢</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡ä»‹ç» Redis æ‰©å±•æ¨¡å‹ RedisBloom ä¸­çš„ TopK æ•°æ®ç±»å‹&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡åŸºäº&lt;code&gt;redis-7.4.7&lt;/code&gt;ï¼Œ&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Rediså®˜ç½‘ï¼š&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis å‘½ä»¤æ–‡æ¡£ï¼š&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;RedisBloom çš„å®‰è£…å‚è§ &lt;a href=&quot;/2025/12/21/redis7-module-RedisBloom/&quot; title=&quot;Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•&quot;&gt;Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis å‘½ä»¤åŠæ•°æ®ç±»å‹ -- CMS(Count-Min Sketch)</title>
    <link href="https://blog.hanqunfeng.com/2025/12/23/redis7-datatype-13-CMS/"/>
    <id>https://blog.hanqunfeng.com/2025/12/23/redis7-datatype-13-CMS/</id>
    <published>2025-12-23T06:40:05.000Z</published>
    <updated>2025-12-24T03:38:33.098Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2">æœ¬æ–‡ä»‹ç» Redis æ‰©å±•æ¨¡å‹ RedisBloom ä¸­çš„ Count-Min Sketch æ•°æ®ç±»å‹</li><li class="lvl-2">æœ¬æ–‡åŸºäº<code>redis-7.4.7</code>ï¼Œ<code>springboot-3.5.8</code></li><li class="lvl-2">Rediså®˜ç½‘ï¼š<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis å‘½ä»¤æ–‡æ¡£ï¼š<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li><li class="lvl-2">RedisBloom çš„å®‰è£…å‚è§ <a href="/2025/12/21/redis7-module-RedisBloom/" title="Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•">Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•</a></li></ul><span id="more"></span><h2 id="Count-Min-Sketch">Count-Min Sketch</h2><ul class="lvl-0"><li class="lvl-2"><p>Count-Min Sketchï¼ˆCMSï¼‰ ç”¨äºåœ¨æä½å†…å­˜å ç”¨ä¸‹ï¼Œå¯¹é«˜é¢‘å†™å…¥çš„è®¡æ•°å‹æ•°æ®è¿›è¡Œè¿‘ä¼¼ç»Ÿè®¡ï¼Œéå¸¸é€‚åˆæµé‡ã€äº‹ä»¶ã€å…³é”®è¯ç­‰â€œåªå…³å¿ƒé¢‘æ¬¡è§„æ¨¡ã€ä¸è¦æ±‚ç²¾ç¡®å€¼â€çš„åœºæ™¯ã€‚</p></li><li class="lvl-2"><p>Count-Min Sketch æ˜¯ä¸€ç§åŸºäºå“ˆå¸Œçš„æ¦‚ç‡å‹è®¡æ•°ç»“æ„ï¼Œç”¨äºä¼°ç®—å…ƒç´ å‡ºç°æ¬¡æ•°ï¼Œå…·æœ‰ä»¥ä¸‹æ ¸å¿ƒç‰¹å¾ï¼š</p><ul class="lvl-2"><li class="lvl-6">åªä¼šé«˜ä¼°ï¼Œä¸ä¼šä½ä¼°ï¼ˆover-estimationï¼‰</li><li class="lvl-6">å›ºå®šå†…å­˜ï¼Œä¸å…ƒç´ ç§ç±»æ•°æ— å…³</li><li class="lvl-6">O(1) çš„æ›´æ–°ä¸æŸ¥è¯¢å¤æ‚åº¦</li><li class="lvl-6">ä¸æ”¯æŒåˆ é™¤ï¼ˆæˆ–åªèƒ½è¿‘ä¼¼åˆ é™¤ï¼‰</li><li class="lvl-6">åªèƒ½è¿”å›ç»™å®šå…ƒç´ è¿‘ä¼¼ç»Ÿè®¡å…¶é¢‘æ¬¡ï¼Œè€Œæ— æ³•è¿”å›å…¨éƒ¨å…ƒç´ çš„ç»Ÿè®¡é¢‘æ¬¡</li></ul></li><li class="lvl-2"><p>åŸºæœ¬å·¥ä½œåŸç†ï¼ˆç®€åŒ–ç‰ˆï¼‰</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.åˆå§‹åŒ–ä¸€ä¸ªäºŒç»´æ•°ç»„ counter[d][w]</span><br><span class="line">2.å¯¹æ¯ä¸ªå…ƒç´  xï¼š</span><br><span class="line">    a. é€šè¿‡ d ä¸ªå“ˆå¸Œå‡½æ•°æ˜ å°„åˆ° d è¡Œä¸­çš„ w ä¸ªä½ç½®</span><br><span class="line">    b. å¯¹å¯¹åº”çš„ d ä¸ªè®¡æ•°å™¨å…¨éƒ¨ +1</span><br><span class="line">3.æŸ¥è¯¢å…ƒç´  x çš„é¢‘æ¬¡ï¼š</span><br><span class="line">    a.å–è¿™ d ä¸ªè®¡æ•°å™¨çš„ æœ€å°å€¼(å–æœ€å°å€¼æ˜¯ä¸ºäº†å°½é‡æŠµæ¶ˆå“ˆå¸Œå†²çªå¸¦æ¥çš„â€œå¤šåŠ â€)</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ä¸‹å›¾ä¸­çš„æ•°ç»„ä¸æ˜¯äºŒè¿›åˆ¶çš„ï¼Œæ¯æ¬¡æ˜ å°„éƒ½ä¼š+1<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/Ybl5tj.png" alt=""></p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>è¯¯å·®ä¸ç©ºé—´å¤æ‚åº¦</p></li></ul><table><thead><tr><th>ç»´åº¦</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>è¯¯å·®ä¸Šç•Œ</td><td>â‰¤ Îµ Ã— æ€»æ’å…¥æ¬¡æ•°</td></tr><tr><td>é”™è¯¯æ¦‚ç‡</td><td>â‰¤ Î´</td></tr><tr><td>ç©ºé—´å¤æ‚åº¦</td><td>O(1 / Îµ Ã— log(1 / Î´))</td></tr><tr><td>æŸ¥è¯¢å¤æ‚åº¦</td><td>O(d)</td></tr><tr><td>æ›´æ–°å¤æ‚åº¦</td><td>O(d)</td></tr></tbody></table><blockquote><p>ç»“è®ºï¼šæ•°æ®é‡å†å¤§ï¼Œå†…å­˜ä¸å¢é•¿ï¼Œä»£ä»·æ˜¯â€œç²¾åº¦æ¢ç©ºé—´â€</p></blockquote><h2 id="RedisBloom-ä¸­-CMS-çš„æ ¸å¿ƒå‘½ä»¤">RedisBloom ä¸­ CMS çš„æ ¸å¿ƒå‘½ä»¤</h2><h3 id="åˆ›å»º-CMS">åˆ›å»º CMS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŒ‰åº•å±‚ç»´åº¦åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment"># CMS.INITBYDIM key width depth</span></span><br><span class="line"><span class="comment"># å‚æ•°è¯´æ˜</span></span><br><span class="line"><span class="comment"># width (w)ï¼šæ¯ä¸€è¡Œçš„æ¡¶æ•°ï¼ˆå½±å“è¯¯å·®ï¼‰</span></span><br><span class="line"><span class="comment"># depth (d)ï¼šå“ˆå¸Œå‡½æ•°æ•°é‡ï¼ˆå½±å“å†²çªæ¦‚ç‡ï¼‰</span></span><br><span class="line"><span class="comment"># æ¯”å¦‚ï¼š</span></span><br><span class="line">CMS.INITBYDIM page:view 1000 10</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯ç±»å‹</span></span><br><span class="line"><span class="built_in">type</span> page:view</span><br><span class="line"><span class="comment"># è¿”å›å€¼</span></span><br><span class="line">CMSk-TYPE</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‰è¯¯å·®+å®¹é‡åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment"># CMS.INITBYPROB page:view error probability</span></span><br><span class="line"><span class="comment"># å‚æ•°è¯´æ˜</span></span><br><span class="line"><span class="comment"># error (Îµ)ï¼šè¯¯å·®ä¸Šç•Œ</span></span><br><span class="line"><span class="comment"># probability (Î´)ï¼šè¶…è¿‡è¯¯å·®ä¸Šç•Œçš„æ¦‚ç‡ï¼Œè¿™ä¸ªæ•°å­—è¶Šæ¥è¿‘é›¶ï¼Œæ¯ä¸ªé¡¹ç›®çš„å†…å­˜æ¶ˆè€—å°±è¶Šå¤§ï¼Œæ¯æ¬¡æ“ä½œçš„CPUä½¿ç”¨å°±è¶Šå¤šã€‚</span></span><br><span class="line"><span class="comment"># RedisBloom ä¼šè‡ªåŠ¨æ¢ç®— w å’Œ d</span></span><br><span class="line"><span class="comment"># æ¯”å¦‚ï¼š</span></span><br><span class="line">CMS.INITBYPROB key 0.001 0.01</span><br></pre></td></tr></table></figure><table><thead><tr><th>å‚æ•°</th><th>æ•°å€¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>error</code></td><td><code>0.001</code></td><td>æœ€å¤§ç›¸å¯¹è¯¯å·® Îµ = 0.1%</td></tr><tr><td><code>probability</code></td><td><code>0.01</code></td><td>åªæœ‰ 1% çš„æ¦‚ç‡è¶…è¿‡è¯¥è¯¯å·®</td></tr></tbody></table><h3 id="å¢åŠ è®¡æ•°">å¢åŠ è®¡æ•°</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMS.INCRBY key item1 count1 item2 count2 ...</span></span><br><span class="line">CMS.INCRBY page:view home 1 about 1 home 1</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 1</span><br><span class="line">2) (<span class="built_in">integer</span>) 1</span><br><span class="line">3) (<span class="built_in">integer</span>) 2</span><br></pre></td></tr></table></figure><h3 id="æŸ¥è¯¢è®¡æ•°">æŸ¥è¯¢è®¡æ•°</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMS.QUERY key item1 item2 ...</span></span><br><span class="line">CMS.QUERY page:view home about</span><br><span class="line"><span class="comment"># è¿”å›çš„æ˜¯ ä¼°ç®—å€¼ï¼ˆå¯èƒ½åå¤§ï¼‰</span></span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 2</span><br><span class="line">2) (<span class="built_in">integer</span>) 1</span><br></pre></td></tr></table></figure><h3 id="åˆå¹¶-CMS">åˆå¹¶ CMS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMS.MERGE dest numkeys src1 src2 ... WEIGHTS w1 w2 ...</span></span><br><span class="line"><span class="comment"># å‚æ•°è¯´æ˜</span></span><br><span class="line"><span class="comment"># destï¼šç›®æ ‡ CMSï¼Œå¿…é¡»å­˜åœ¨</span></span><br><span class="line"><span class="comment"># numkeysï¼šæº CMS æ•°é‡</span></span><br><span class="line"><span class="comment"># src1 src2 ...ï¼šæº CMSï¼Œå¿…é¡»å­˜åœ¨</span></span><br><span class="line"><span class="comment"># WEIGHTS w1 w2 ...ï¼šæº CMS æƒé‡</span></span><br><span class="line">CMS.MERGE page:view 2 page:view:1 page:view:2 WEIGHTS 1 1</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">OK</span><br></pre></td></tr></table></figure><h3 id="è·å–-CMS-çš„ä¿¡æ¯">è·å– CMS çš„ä¿¡æ¯</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMS.INFO key</span></span><br><span class="line">CMS.INFO page:view</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">1) width            <span class="comment"># æ¯ä¸€è¡Œæ¡¶æ•° w</span></span><br><span class="line">2) (<span class="built_in">integer</span>) 1000</span><br><span class="line">3) depth            <span class="comment"># å“ˆå¸Œå‡½æ•°æ•°é‡ d</span></span><br><span class="line">4) (<span class="built_in">integer</span>) 10</span><br><span class="line">5) count            <span class="comment"># å½“å‰å·²æ’å…¥çš„å…ƒç´ æ•°é‡</span></span><br><span class="line">6) (<span class="built_in">integer</span>) 3</span><br></pre></td></tr></table></figure><h2 id="CMS-çš„ä½¿ç”¨åœºæ™¯">CMS çš„ä½¿ç”¨åœºæ™¯</h2><h3 id="åœºæ™¯1ï¼šç½‘ç«™PVç»Ÿè®¡">åœºæ™¯1ï¼šç½‘ç«™PVç»Ÿè®¡</h3><ul class="lvl-0"><li class="lvl-2"><p>éœ€æ±‚ï¼šç»Ÿè®¡ç½‘ç«™ PVï¼Œå³é¡µé¢è¢«è®¿é—®çš„æ¬¡æ•°ï¼Œå…è®¸0.1%çš„è¯¯å·®</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆå§‹åŒ– CMS</span></span><br><span class="line">CMS.INITBYPROB page:pv 0.001 0.01</span><br><span class="line"><span class="comment"># æ·»åŠ è®¡æ•°</span></span><br><span class="line">CMS.INCRBY page:pv /home 1 /about 1</span><br><span class="line">CMS.INCRBY page:pv /home 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥è¯¢è®¡æ•°</span></span><br><span class="line">CMS.QUERY page:pv /home</span><br></pre></td></tr></table></figure><h3 id="åœºæ™¯2ï¼šæ¥å£è°ƒç”¨é¢‘æ¬¡é™æµå‰ç½®ç»Ÿè®¡">åœºæ™¯2ï¼šæ¥å£è°ƒç”¨é¢‘æ¬¡é™æµå‰ç½®ç»Ÿè®¡</h3><ul class="lvl-0"><li class="lvl-2"><p>éœ€æ±‚ï¼šç»Ÿè®¡æ¥å£è°ƒç”¨æ¬¡æ•°ï¼Œä¸ºé™æµæä¾›å·²ç»ï¼Œä¸éœ€è¦ç²¾å‡†è®¡æ•°ï¼Œå…è®¸0.1%çš„è¯¯å·®</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»º CMS</span></span><br><span class="line">CMS.INITBYPROB api:<span class="built_in">limit</span> 0.001 0.01</span><br><span class="line"><span class="comment"># æ·»åŠ è®¡æ•°</span></span><br><span class="line">CMS.INCRBY api:<span class="built_in">limit</span> /api/user/list 1</span><br><span class="line"><span class="comment"># è·å–è®¡æ•°</span></span><br><span class="line">CMS.QUERY api:<span class="built_in">limit</span> /api/user/list</span><br></pre></td></tr></table></figure><h2 id="CMS-vs-ZSET">CMS vs ZSET</h2><ul class="lvl-0"><li class="lvl-2"><p>èƒ½åŠ›è¾¹ç•Œå¯¹æ¯”</p></li></ul><table><thead><tr><th>èƒ½åŠ›</th><th>CMS</th><th>ZSet</th></tr></thead><tbody><tr><td>é¢‘æ¬¡ç»Ÿè®¡</td><td>âœ”ï¸ è¿‘ä¼¼</td><td>âœ”ï¸ ç²¾ç¡®</td></tr><tr><td>æ˜¯å¦å­˜å…ƒç´ </td><td>âŒ ä¸å­˜</td><td>âœ”ï¸ å­˜</td></tr><tr><td>æ˜¯å¦å¯éå†å…ƒç´ </td><td>âŒ ä¸å¯</td><td>âœ”ï¸ å¯</td></tr><tr><td>TopK / æ’è¡Œ</td><td>âŒï¼ˆéœ€é…åˆ TopKï¼‰</td><td>âœ”ï¸ å¤©ç„¶æ”¯æŒ</td></tr><tr><td>åˆ é™¤å…ƒç´ </td><td>âŒ ä¸æ”¯æŒ</td><td>âœ”ï¸ æ”¯æŒ</td></tr><tr><td>è¯¯åˆ¤ / è¯¯å·®</td><td>âœ”ï¸ å­˜åœ¨</td><td>âŒ æ— </td></tr><tr><td>æ˜¯å¦å¯é€†ï¼ˆæŸ¥æˆå‘˜ï¼‰</td><td>âŒ ä¸å¯é€†</td><td>âœ”ï¸ å¯é€†</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>æ€§èƒ½ç‰¹å¾å¯¹æ¯”</p></li></ul><table><thead><tr><th>æ“ä½œ</th><th>CMS</th><th>ZSet</th></tr></thead><tbody><tr><td>æ’å…¥ / è®¡æ•°</td><td>O(d)ï¼ˆå¸¸æ•°çº§ï¼‰</td><td>O(log N)</td></tr><tr><td>æŸ¥è¯¢é¢‘æ¬¡</td><td>O(d)</td><td>O(1)</td></tr><tr><td>æ’åæŸ¥è¯¢</td><td>âŒ</td><td>O(log N)</td></tr><tr><td>æ‰¹é‡å†™å…¥</td><td>æå¿«</td><td>ä¸­ç­‰</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡ä»‹ç» Redis æ‰©å±•æ¨¡å‹ RedisBloom ä¸­çš„ Count-Min Sketch æ•°æ®ç±»å‹&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡åŸºäº&lt;code&gt;redis-7.4.7&lt;/code&gt;ï¼Œ&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Rediså®˜ç½‘ï¼š&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis å‘½ä»¤æ–‡æ¡£ï¼š&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;RedisBloom çš„å®‰è£…å‚è§ &lt;a href=&quot;/2025/12/21/redis7-module-RedisBloom/&quot; title=&quot;Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•&quot;&gt;Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis å‘½ä»¤åŠæ•°æ®ç±»å‹ -- CF(Cuckoo Filter)</title>
    <link href="https://blog.hanqunfeng.com/2025/12/22/redis7-datatype-12-CF/"/>
    <id>https://blog.hanqunfeng.com/2025/12/22/redis7-datatype-12-CF/</id>
    <published>2025-12-22T06:40:05.000Z</published>
    <updated>2026-01-06T10:10:32.852Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2">æœ¬æ–‡ä»‹ç» Redis æ‰©å±•æ¨¡å‹ RedisBloom ä¸­çš„ Cuckoo Filter æ•°æ®ç±»å‹</li><li class="lvl-2">æœ¬æ–‡åŸºäº<code>redis-7.4.7</code>ï¼Œ<code>springboot-3.5.8</code></li><li class="lvl-2">Rediså®˜ç½‘ï¼š<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis å‘½ä»¤æ–‡æ¡£ï¼š<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li><li class="lvl-2">RedisBloom çš„å®‰è£…å‚è§ <a href="/2025/12/21/redis7-module-RedisBloom/" title="Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•">Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•</a></li><li class="lvl-2">ç¤ºä¾‹ä»£ç ï¼š<a href="https://github.com/hanqunfeng/springbootchapter/tree/master/springboot3-demo/redis-demo/data-type-demo">GitHub</a></li></ul><span id="more"></span><h2 id="Cuckoo-Filterï¼ˆå¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ï¼‰">Cuckoo Filterï¼ˆå¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ï¼‰</h2><ul class="lvl-0"><li class="lvl-2"><p>Cuckoo Filter æ˜¯ Bloom Filter çš„æ”¹è¿›ç‰ˆï¼Œæ”¯æŒ åŠ¨æ€æ·»åŠ å’Œåˆ é™¤å…ƒç´ ï¼Œä»èƒ½æä¾›æ¯”å¸ƒéš†è¿‡æ»¤å™¨æ›´é«˜çš„æŸ¥è¯¢æ€§èƒ½ã€‚</p></li><li class="lvl-2"><p><a href="https://en.wikipedia.org/wiki/Cuckoo_filter">ç»´åŸºç™¾ç§‘å¯¹ Cuckoo Filter çš„æè¿°</a></p></li><li class="lvl-2"><p>åœ¨é«˜ QPS æŸ¥è¯¢åœºæ™¯ä¸‹ï¼ŒCuckoo Filter é€šå¸¸ä¼˜äº Bloom Filterã€‚</p></li><li class="lvl-2"><p>ä¼˜ç‚¹ï¼šä½è¯¯åˆ¤ç‡ + é«˜è´Ÿè½½ç‡ï¼ŒåŸºäºç›¸åŒçš„é›†åˆå’Œè¯¯æŠ¥ç‡ï¼ŒCuckoo Filteré€šå¸¸å ç”¨ç©ºé—´æ›´å°‘ã€‚ç›¸å¯¹çš„ï¼Œç®—æ³•å®ç°ä¹Ÿå°±æ›´å¤æ‚ã€‚</p></li><li class="lvl-2"><p>ç¼ºç‚¹ï¼šä¸Bloom Filterä¸€æ ·ï¼Œæœ‰å¯èƒ½å°†ä¸€ä¸ªä¸åœ¨é›†åˆä¸­çš„å…ƒç´ é”™è¯¯çš„åˆ¤æ–­æˆåœ¨é›†åˆä¸­</p></li><li class="lvl-2"><p>Bloom Filter çš„è¯¯æŠ¥ç‡é€šè¿‡è°ƒæ•´<code>ä½æ•°ç»„çš„å¤§å°</code>å’Œ<code>å“ˆå¸Œå‡½æ•°æ•°é‡</code>æ¥æ§åˆ¶ï¼Œè€Œ Cuckoo Filter çš„è¯¯æŠ¥ç‡å—<code>æŒ‡çº¹å¤§å°</code>å’Œ<code>æ¡¶å¤§å°</code>æ§åˆ¶ã€‚</p></li></ul><h3 id="å¸ƒè°·å“ˆå¸Œç®—æ³•">å¸ƒè°·å“ˆå¸Œç®—æ³•</h3><ul class="lvl-0"><li class="lvl-2"><p><a href="https://baike.baidu.com/item/Cockoo%20hash/3022855">ç™¾åº¦ç™¾ç§‘å¯¹å¸ƒè°·å“ˆå¸Œç®—æ³•çš„æè¿°</a>]</p></li><li class="lvl-2"><p>ç®—æ³•ä½¿ç”¨ä¸¤ä¸ªä¸åŒå“ˆå¸Œå‡½æ•°è®¡ç®—å¯¹åº” key çš„ä½ç½®ã€‚</p><ul class="lvl-2"><li class="lvl-6"><ol><li class="lvl-9">å½“ä¸¤ä¸ªå“ˆå¸Œä»»æ„ä½ç½®ä¸ºç©ºï¼Œåˆ™éšæœºé€‰æ‹©ä¸€ä¸ªä½ç½®æ’å…¥</li></ol></li><li class="lvl-6"><ol start="2"><li class="lvl-9">å½“ä¸¤ä¸ªå“ˆå¸Œæœ‰ä½ç½®ä¸ºç©ºæ—¶ï¼Œåˆ™æ’å…¥åˆ°ç©ºä½ç½®</li></ol></li><li class="lvl-6"><ol start="3"><li class="lvl-9">å½“ä¸¤ä¸ªå“ˆå¸Œä½ç½®å‡ä¸ä¸ºç©ºæ—¶ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ªä½ç½®æ’å…¥å¹¶è¸¢å‡ºåŸkeyï¼ŒåŸkeyä¼šå†æ¬¡ç»è¿‡è®¡ç®—è·å¾—æ–°çš„ä½ç½®ï¼Œè½¬è‡³1æ‰§è¡Œï¼Œåå¤ç›´åˆ°æˆåŠŸæˆ–è€…è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°ã€‚</li></ol></li></ul></li></ul><h3 id="Cuckoo-Filter-çš„å®ç°åŸç†">Cuckoo Filter çš„å®ç°åŸç†</h3><ul class="lvl-0"><li class="lvl-2"><p>å¸ƒè°·è¿‡æ»¤å™¨ æ˜¯åœ¨<code>å¸ƒè°·å“ˆå¸Œç®—æ³•</code>çš„ç®—æ³•åŸºç¡€ä¸Šæ‰©å……æ¥çš„ï¼Œä½†æ˜¯å®ƒæ‰€æä¾›çš„æ¦‚å¿µä¸æ˜¯è¡¨ï¼Œè€Œæ˜¯æä¾›äº†å¤šä¸ªæ•°æ®æ¡¶(Bucket)</p></li><li class="lvl-2"><p>æ¯ä¸€ä¸ªæ•°æ®æ¡¶éƒ½æ˜¯ä¸ª<code>ä¸€ç»´æ•°ç»„</code>ï¼Œæ¯ä¸ªæ•°ç»„çš„ä¿å­˜å†…å®¹ä¸º<code>æ¡ç›®(Entry)</code>ï¼Œæ¯ä¸€ä¸ªæ¡ç›®é‡Œé¢å¯ä»¥ä¿å­˜ä¸€ä¸ª<code>æŒ‡çº¹æ•°æ®</code>(æŒ‡çº¹æ•°æ®å°±æ˜¯åŸå§‹æ•°æ®ç»è¿‡å“ˆå¸Œè®¡ç®—å¾—åˆ°çš„ä¸€ä¸ªnä½çš„æ•°æ®æ ‡è®°)ï¼Œé™¤äº†æŒ‡çº¹æ•°æ®ä¹‹å¤–ï¼Œè¿˜ä¼šåŒæ—¶å¾—å‡ºä¸€ä¸ª<code>ä¿å­˜ä½ç½®P1æ ‡è®°</code>ã€‚</p></li><li class="lvl-2"><p>å½“ä¸¤ä¸ªæ•°æ®è®¡ç®—å¾—åˆ°çš„æŒ‡çº¹æ•°æ®ç›¸åŒæ—¶ï¼Œå°±ä¼šå‘ç”Ÿå†²çªï¼Œå†²çªæ“ä½œçš„è§£å†³æ€è·¯æ˜¯ä½¿ç”¨<code>å¸ƒè°·å“ˆå¸Œç®—æ³•</code>ï¼Œç®€å•è¯´å°±æ˜¯æ–°çš„æ•°æ®ä¼šå°†åŸæœ‰æ•°æ®<code>è¸¢å‡º</code>ï¼Œè€Œè¢«è¸¢å‡ºçš„æ•°æ®ä¼šè¢«é‡æ–°è®¡ç®—å¾—åˆ°æ–°çš„æŒ‡çº¹æ•°æ®å’Œä¿å­˜ä½ç½®æ ‡è®°ã€‚</p></li><li class="lvl-2"><p>å¸ƒè°·è¿‡æ»¤å™¨é‡Œé¢éœ€è¦è¿›è¡Œå„ç§æ•°æ®çš„<code>è¸¢å‡º</code>æ“ä½œï¼Œè¿™ä¸ªè¸¢å‡ºçš„æ–¹å¼å°±æ˜¯ä½¿ç”¨<code>P1æ ‡å¿—ä½</code>å’Œ<code>æŒ‡çº¹æ•°æ®</code>è¿›è¡Œ<code>å¼‚æˆ–è®¡ç®—</code>å¾—å‡ºæ¥çš„<code>P2æ ‡å¿—ä½</code>ï¼ŒæŒ‰ç…§åŒæ ·çš„æ€è·¯(å‰æ:ä¸€ç›´éƒ½æœ‰å†²çªæ“ä½œ)ä¸€ç›´è®¡ç®—æ–°çš„P2ä½ï¼Œç›´åˆ°å†²çªè§£å†³æˆ–è€…è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼Œå°±ä¼šå¤±è´¥ã€‚</p></li><li class="lvl-2"><p>æŒ‡çº¹æ•°æ®é‡Œé¢åŒ…å«æœ‰<code>å”¯ä¸€æ€§</code>ï¼Œæ‰€ä»¥å¯ä»¥å®ç°æ•°æ®çš„åˆ é™¤ï¼Œå½“ç„¶ï¼Œä¸åŒçš„æ•°æ®è®¡ç®—æ˜¯æœ‰å¯èƒ½å¾—åˆ°ç›¸åŒæŒ‡çº¹çš„ï¼Œé‚£ä¹ˆä¸€æ—¦åˆ é™¤æ•°æ®ä¹‹åï¼Œæœ‰å¯èƒ½é€ æˆæ•°æ®çš„&quot;å‡åˆ é™¤&quot;ï¼Œæ‰€ä»¥å¸ƒè°·è¿‡æ»¤å™¨æœ¬èº«ä¹Ÿæ˜¯å­˜åœ¨æœ‰è¯¯å·®çš„ã€‚</p></li><li class="lvl-2"><p>Cuckoo Filter ä¸­çš„ <code>BUSKETSIZE</code></p><ul class="lvl-2"><li class="lvl-6">BUSKETSIZEï¼Œè¡¨ç¤ºæ¯ä¸ªæ¡¶(Busket)ä¸­å­˜æ”¾çš„å…ƒç´ ä¸ªæ•°ï¼Œå³æ¡¶å¤§å°ã€‚</li><li class="lvl-6">Cuckoo Filterçš„æ•°ç»„é‡Œå­˜çš„ä¸æ˜¯ä½ï¼Œè€Œæ˜¯æ¡¶(busket)ï¼Œæ¯ä¸ªæ¡¶é‡Œå¯ä»¥å­˜æ”¾å¤šä¸ªæ•°æ®ã€‚</li><li class="lvl-6">åŒä¸€ä¸ªæ¡¶ä¸­å­˜æ”¾çš„æ•°æ®è¶Šå¤šï¼Œç©ºé—´åˆ©ç”¨ç‡æ›´é«˜ï¼Œç›¸åº”çš„è¯¯åˆ¤ç‡ä¹Ÿå°±è¶Šé«˜ï¼Œæ€§èƒ½ä¹Ÿæ›´æ…¢ã€‚</li><li class="lvl-6">Redisçš„CuckooFilterå®ç°ä¸­ï¼ŒBUSKETSIZEåº”è¯¥æ˜¯ä¸€ä¸ªåœ¨1åˆ°255ä¹‹é—´çš„æ•´æ•°ï¼Œé»˜è®¤çš„ BUSKETSIZE æ˜¯ <code>2</code>ã€‚</li><li class="lvl-6">æ¡¶(Busket)ä¸­å¹¶ä¸å®é™…ä¿å­˜æ•°æ®æœ¬èº«ï¼Œè€Œæ˜¯ä¿å­˜æ•°æ®çš„æŒ‡çº¹(fingerprint)ã€‚æŒ‡çº¹è¶Šå°ï¼ŒHASHå†²çªé€ æˆè¯¯åˆ¤çš„å‡ ç‡å°±è¶Šå°ã€‚è¿™ä¸ªå‚æ•°çš„è°ƒæ•´æ¯”è¾ƒå¤æ‚ï¼ŒRedisçš„CuckooFilterä¸­ä¸æ”¯æŒè°ƒæ•´è¿™ä¸ªå‚æ•°ã€‚</li></ul></li></ul><h2 id="CF-å‘½ä»¤è¯´æ˜">CF å‘½ä»¤è¯´æ˜</h2><ul class="lvl-0"><li class="lvl-2"><p>å¯¹åº”Rediså‘½ä»¤ï¼š <code>CF.xxx</code></p></li></ul><table><thead><tr><th>å‘½ä»¤</th><th>åŠŸèƒ½è¯´æ˜</th><th>æ˜¯å¦åˆ›å»º Filter</th><th>å…³é”®å‚æ•°å«ä¹‰</th><th>è¿”å›å€¼</th><th>ç¤ºä¾‹</th><th>ä½¿ç”¨è¦ç‚¹ / å¤‡æ³¨</th></tr></thead><tbody><tr><td><strong>CF.RESERVE</strong></td><td>æ˜¾å¼åˆ›å»º Cuckoo Filter</td><td>æ˜¯</td><td><code>capacity</code>ï¼šå®¹é‡(å¿…å¡«)<br><code>BUCKETSIZE</code>ï¼šæ¯ä¸ªæ¡¶é‡Œæœ€å¤šèƒ½æ”¾å¤šå°‘ä¸ª fingerprintï¼ˆæŒ‡çº¹ï¼‰ï¼Œé»˜è®¤ 2(å¤§å¤šæ•°æƒ…å†µä¸‹çš„æœ€ä¼˜è§£)<br><code>MAXITERATIONS</code>ï¼šé‡æ’æ¬¡æ•°ï¼Œè¶Šå¤§æˆåŠŸç‡è¶Šé«˜<br><code>EXPANSION</code>ï¼šæ‰©å®¹å€æ•°ï¼Œé»˜è®¤ 1ï¼ˆä¸æ‰©å®¹ï¼‰</td><td>OK</td><td><code>CF.RESERVE user:cf 100000</code></td><td>âœ… <strong>ç”Ÿäº§æ¨è</strong><br>æ”¯æŒåˆ é™¤ä¸è®¡æ•°</td></tr><tr><td><strong>CF.ADD</strong></td><td>æ·»åŠ ä¸€ä¸ªå…ƒç´ ï¼Œä¸å»é‡</td><td>æ˜¯ ï¼ˆä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰</td><td><code>item</code>ï¼šå…ƒç´ </td><td>OK</td><td><code>CF.ADD user:cf user_1</code></td><td>è‹¥æ»¡å¯èƒ½å¤±è´¥</td></tr><tr><td><strong>CF.ADDNX</strong></td><td>å…ƒç´ ä¸å­˜åœ¨æ—¶æ‰æ·»åŠ ï¼Œå»é‡</td><td>æ˜¯ ï¼ˆä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰</td><td><code>item</code></td><td><code>1</code> æ–°å¢<br><code>0</code> å·²å­˜åœ¨</td><td><code>CF.ADDNX user:cf user_1</code></td><td>å¹‚ç­‰å†™å…¥é¦–é€‰</td></tr><tr><td><strong>CF.INSERT</strong></td><td>æ‰¹é‡æ’å…¥</td><td>æ˜¯ï¼ˆä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰</td><td><code>ITEMS</code>ï¼šå…ƒç´ åˆ—è¡¨</td><td>OK</td><td><code>CF.INSERT user:cf ITEMS u1 u2</code></td><td>é»˜è®¤é…ç½®</td></tr><tr><td><strong>CF.INSERTNX</strong></td><td>æ‰¹é‡æ’å…¥ï¼ˆä¸å­˜åœ¨æ‰åŠ ï¼‰</td><td>æ˜¯</td><td><code>ITEMS</code></td><td><code>0/1</code> åˆ—è¡¨</td><td><code>CF.INSERTNX user:cf ITEMS u1 u2</code></td><td>å¹‚ç­‰ + æ‰¹é‡</td></tr><tr><td><strong>CF.EXISTS</strong></td><td>åˆ¤æ–­å•ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨</td><td>å¦</td><td><code>item</code></td><td><code>1</code> å¯èƒ½å­˜åœ¨<br><code>0</code> ä¸å­˜åœ¨</td><td><code>CF.EXISTS user:cf user_1</code></td><td>ä»æœ‰è¯¯åˆ¤</td></tr><tr><td><strong>CF.MEXISTS</strong></td><td>æ‰¹é‡åˆ¤æ–­æ˜¯å¦å­˜åœ¨</td><td>å¦</td><td><code>item...</code></td><td><code>0/1</code> åˆ—è¡¨</td><td><code>CF.MEXISTS user:cf u1 u9</code></td><td>é«˜å¹¶å‘æ¨è</td></tr><tr><td><strong>CF.COUNT</strong></td><td>è¿”å›å…ƒç´ å‡ºç°æ¬¡æ•°</td><td>å¦</td><td><code>item</code></td><td>æ•´æ•°</td><td><code>CF.COUNT user:cf user_1</code></td><td>â­ Bloom æ²¡æœ‰çš„èƒ½åŠ›</td></tr><tr><td><strong>CF.DEL</strong></td><td>åˆ é™¤ä¸€ä¸ªå…ƒç´ </td><td>å¦</td><td><code>item</code></td><td><code>1</code> åˆ é™¤æˆåŠŸ<br><code>0</code> ä¸å­˜åœ¨</td><td><code>CF.DEL user:cf user_1</code></td><td>â­ Bloom ä¸æ”¯æŒ</td></tr><tr><td><strong><a href="http://CF.INFO">CF.INFO</a></strong></td><td>æŸ¥çœ‹ Filter å…ƒä¿¡æ¯</td><td>å¦</td><td>æ— </td><td>KV åˆ—è¡¨</td><td><code>CF.INFO user:cf</code></td><td>è¿ç»´åˆ†æ</td></tr><tr><td><strong>CF.SCANDUMP</strong></td><td>åˆ†å—å¯¼å‡º Filter</td><td>å¦</td><td><code>iterator</code></td><td><code>iterator + data</code></td><td><code>CF.SCANDUMP user:cf 0</code></td><td>è¿ç§» / å¤‡ä»½</td></tr><tr><td><strong>CF.LOADCHUNK</strong></td><td>ä» dump æ¢å¤ Filter</td><td>æ˜¯</td><td><code>iterator + data</code></td><td>OK</td><td><code>CF.LOADCHUNK user:cf 1 &quot;xxx&quot;</code></td><td>ä¸ SCANDUMP é…åˆ</td></tr></tbody></table><h2 id="Bloom-vs-Cuckoo">Bloom vs Cuckoo</h2><table><thead><tr><th>ç»´åº¦</th><th>Bloom Filter</th><th>Cuckoo Filter</th></tr></thead><tbody><tr><td>æŸ¥è¯¢å¤æ‚åº¦</td><td>O(k)ï¼ˆk ä¸ªå“ˆå¸Œå‡½æ•°ï¼‰</td><td>O(1)ï¼ˆ2â€“4 æ¬¡ bucket è®¿é—®ï¼‰</td></tr><tr><td>æ’å…¥å¤æ‚åº¦</td><td>O(k)</td><td>å¹³å‡ O(1)ï¼Œæœ€åå¯èƒ½è§¦å‘é‡æ’</td></tr><tr><td>åˆ é™¤æ”¯æŒ</td><td>âŒ åŸç”Ÿä¸æ”¯æŒ</td><td>âœ… åŸç”Ÿæ”¯æŒ</td></tr><tr><td>è¯¯åˆ¤ç‡ï¼ˆFalse Positiveï¼‰</td><td>å¯é…ç½®ï¼Œç¨³å®š</td><td>å¯é…ç½®ï¼Œé€šå¸¸æ›´ä½</td></tr><tr><td>æ¼åˆ¤ï¼ˆFalse Negativeï¼‰</td><td>âŒ ç†è®ºä¸Šä¸ä¼š</td><td>âŒ ç†è®ºä¸Šä¸ä¼š</td></tr><tr><td>ç©ºé—´åˆ©ç”¨ç‡</td><td>é«˜ï¼ˆä½†å— k å½±å“ï¼‰</td><td>é€šå¸¸æ›´é«˜ï¼ˆç‰¹åˆ«æ˜¯ä½è¯¯åˆ¤ç‡ï¼‰</td></tr><tr><td>æ‰©å®¹æˆæœ¬</td><td>é«˜ï¼ˆéœ€é‡å»ºï¼‰</td><td>ä¸­ç­‰ï¼ˆæ”¯æŒæ‰©å±•ç­–ç•¥ï¼‰</td></tr><tr><td>å®ç°å¤æ‚åº¦</td><td>ä½</td><td>è¾ƒé«˜</td></tr></tbody></table><blockquote><p>RedisBloom Cuckoo Filter ä¸æ”¯æŒè®¾ç½® <code>è¯¯åˆ¤ç‡</code>ï¼Œé€šå¸¸ å®¹é‡ è¶Šå¤§ï¼Œè¯¯åˆ¤ç‡è¶Šä½ã€‚</p></blockquote><h2 id="CF-å‘½ä»¤ç¤ºä¾‹">CF å‘½ä»¤ç¤ºä¾‹</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»º Cuckoo Filter</span></span><br><span class="line"><span class="comment">## å®¹é‡1000ï¼Œè¿™ä¸ªæ˜¯å¿…å¡«å‚æ•°ã€‚åé¢å‡ ä¸ªéƒ½æ˜¯å¯é€‰å‚æ•°ã€‚</span></span><br><span class="line"><span class="comment">## BUSKETSIZEè¶Šå¤§ï¼Œç©ºé—´åˆ©ç”¨ç‡æ›´é«˜ï¼Œä½†æ˜¯è¯¯åˆ¤ç‡ä¹Ÿæ›´é«˜ï¼Œæ€§èƒ½æ›´å·®ï¼Œé»˜è®¤2</span></span><br><span class="line"><span class="comment">## MAXITARATIONSè¶Šå°ï¼Œæ€§èƒ½è¶Šå¥½ã€‚å¦‚æœè®¾ç½®è¶Šå¤§ï¼Œç©ºé—´åˆ©ç”¨ç‡å°±è¶Šå¥½ã€‚é»˜è®¤20</span></span><br><span class="line"><span class="comment">## EXPANSION æ˜¯æŒ‡ç©ºé—´æ‰©å®¹çš„æ¯”ä¾‹ã€‚é»˜è®¤1ï¼Œä¸æ‰©å®¹</span></span><br><span class="line">127.0.0.1:6379&gt; CF.RESERVE user:cf 1000 BUCKETSIZE 2 MAXITERATIONS 500 EXPANSION 2</span><br><span class="line">OK</span><br><span class="line"><span class="comment"># æ·»åŠ å…ƒç´ </span></span><br><span class="line">127.0.0.1:6379&gt; CF.ADD user:cf user_1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; CF.ADD user:cf user_2</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"><span class="comment"># å¯ä»¥é‡å¤æ·»åŠ å…ƒç´ </span></span><br><span class="line">127.0.0.1:6379&gt; CF.ADD user:cf user_1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"><span class="comment"># è¿”å›å…ƒç´ å‡ºç°æ¬¡æ•°</span></span><br><span class="line">127.0.0.1:6379&gt; CF.COUNT user:cf user_1</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line"><span class="comment"># åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">127.0.0.1:6379&gt; CF.EXISTS user:cf user_1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"><span class="comment"># æ‰¹é‡åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">127.0.0.1:6379&gt; CF.MEXISTS user:cf user_1 user_2 user_100</span><br><span class="line">1) (<span class="built_in">integer</span>) 1</span><br><span class="line">2) (<span class="built_in">integer</span>) 1</span><br><span class="line">3) (<span class="built_in">integer</span>) 0</span><br><span class="line"><span class="comment"># åˆ é™¤å…ƒç´ ï¼Œä¸€æ¬¡åªåˆ é™¤ä¸€ä¸ª</span></span><br><span class="line">127.0.0.1:6379&gt; CF.DEL user:cf user_1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"><span class="comment"># å› ä¸ºuser_1æœ‰ä¸¤ä¸ªï¼Œæ‰€ä»¥æ‰æ˜¯è¿˜æ˜¯èƒ½æŸ¥è¯¢å‡º user_1</span></span><br><span class="line">127.0.0.1:6379&gt; CF.COUNT user:cf user_1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"><span class="comment"># å†æ¬¡åˆ é™¤</span></span><br><span class="line">127.0.0.1:6379&gt; CF.DEL user:cf user_1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"><span class="comment"># åŒåå…ƒç´ å·²å…¨éƒ¨åˆ é™¤ï¼ŒæŸ¥è¯¢ä¸åˆ°</span></span><br><span class="line">127.0.0.1:6379&gt; CF.COUNT user:cf user_1</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…ƒç´ ä¸å­˜åœ¨æ—¶æ‰æ·»åŠ ï¼Œå¹‚ç­‰</span></span><br><span class="line">127.0.0.1:6379&gt; CF.ADDNX user:cf user_2</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; CF.ADDNX user:cf user_3</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ Filter å…ƒä¿¡æ¯</span></span><br><span class="line">127.0.0.1:6379&gt; CF.INFO user:cf</span><br><span class="line"> 1) Size                      <span class="comment"># å½“å‰ Cuckoo Filter å®é™…å ç”¨çš„å†…å­˜å¤§å°ï¼ˆå­—èŠ‚ï¼‰</span></span><br><span class="line"> 2) (<span class="built_in">integer</span>) 1080</span><br><span class="line"> 3) Number of buckets         <span class="comment"># å½“å‰è¿‡æ»¤å™¨ä¸­ bucketï¼ˆæ¡¶ï¼‰çš„æ€»æ•°é‡ï¼ŒSize = Number of buckets * Bucket size(é»˜è®¤ä¸º2)</span></span><br><span class="line"> 4) (<span class="built_in">integer</span>) 512</span><br><span class="line"> 5) Number of filters         <span class="comment"># å†…éƒ¨ å­ Cuckoo Filter çš„æ•°é‡</span></span><br><span class="line"> 6) (<span class="built_in">integer</span>) 1</span><br><span class="line"> 7) Number of items inserted  <span class="comment"># æˆåŠŸæ’å…¥çš„å…ƒç´ æ€»æ•°ï¼ˆè¿‘ä¼¼ï¼‰</span></span><br><span class="line"> 8) (<span class="built_in">integer</span>) 2</span><br><span class="line"> 9) Number of items deleted   <span class="comment"># å·²åˆ é™¤å…ƒç´ çš„ç´¯è®¡æ¬¡æ•°</span></span><br><span class="line">10) (<span class="built_in">integer</span>) 2</span><br><span class="line">11) Bucket size               <span class="comment"># æ¯ä¸ª bucket å¯å®¹çº³çš„ fingerprint æ•°ï¼Œé»˜è®¤ä¸º 2</span></span><br><span class="line">12) (<span class="built_in">integer</span>) 2</span><br><span class="line">13) Expansion rate            <span class="comment"># è¿‡æ»¤å™¨è‡ªåŠ¨æ‰©å®¹å€ç‡ï¼Œé»˜è®¤ä¸º1ï¼Œ0 æˆ– 1 è¡¨ç¤ºä¸æ‰©å®¹ï¼ˆæ»¡åˆ™å¤±è´¥ï¼‰</span></span><br><span class="line">14) (<span class="built_in">integer</span>) 2</span><br><span class="line">15) Max iterations            <span class="comment"># Cuckoo Kick-out çš„æœ€å¤§é‡æ’æ¬¡æ•°ï¼Œå€¼è¶Šå¤§ï¼Œæ’å…¥æˆåŠŸç‡è¶Šé«˜ï¼Œä½†å†™å…¥å»¶è¿Ÿå¯èƒ½ä¸Šå‡</span></span><br><span class="line">16) (<span class="built_in">integer</span>) 500</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰¹é‡æ·»åŠ ï¼Œkeyä¸å­˜åœ¨åˆ™åˆ›å»º</span></span><br><span class="line">127.0.0.1:6379&gt; CF.INSERT order:cf CAPACITY 100 ITEMS order1 order2</span><br><span class="line">1) (<span class="built_in">integer</span>) 1</span><br><span class="line">2) (<span class="built_in">integer</span>) 1</span><br><span class="line"><span class="comment"># å¹‚ç­‰ï¼Œå…ƒç´ ä¸å­˜åœ¨æ—¶æ‰æ·»åŠ </span></span><br><span class="line">127.0.0.1:6379&gt; CF.INSERTNX order:cf CAPACITY 100 ITEMS order1 order2 order100</span><br><span class="line">1) (<span class="built_in">integer</span>) 0</span><br><span class="line">2) (<span class="built_in">integer</span>) 0</span><br><span class="line">3) (<span class="built_in">integer</span>) 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç±»å‹</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">type</span> order:cf</span><br><span class="line">MBbloomCF</span><br></pre></td></tr></table></figure><h2 id="SpringBoot-é›†æˆ">SpringBoot é›†æˆ</h2><ul class="lvl-0"><li class="lvl-2"><p>SpringBoot çš„ RedisTemplate ä¸­æ²¡æœ‰æä¾›å¯¹<code>RedisBloom</code>çš„å°è£…ï¼Œéœ€è¦è‡ªå·±å°è£…ï¼Œæˆ‘è¿™é‡Œå°è£…äº†ä¸€ä¸ªç®€æ˜“çš„<code>RedisCuckooFilterTool</code></p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.redisbloom;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åŸºäº RedisBloom æ’ä»¶çš„ CuckooFilter å®ç°</span></span><br><span class="line"><span class="comment"> * https://github.com/RedisBloom/RedisBloom/releases</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisCuckooFilterTool</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisCuckooFilterTool</span><span class="params">(StringRedisTemplate redisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ– Cuckoo Filter</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * ä¸èƒ½é‡å¤åˆ›å»º</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key      Filter åç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> capacity é¢„è®¡å®¹é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">reserve</span><span class="params">(String key, <span class="type">long</span> capacity)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;CF.RESERVE&#x27;, KEYS[1], &quot;</span> + capacity + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            redisTemplate.execute(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, String.class),</span><br><span class="line">                    Collections.singletonList(key)</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;RedisCuckooFilterTool reserve error:&quot;</span>,e);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ– Cuckoo Filterï¼ˆé«˜çº§å‚æ•°ï¼‰</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * ä¸èƒ½é‡å¤åˆ›å»º</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key           Filter åç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> capacity      é¢„è®¡å®¹é‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucketSize    æ¯ä¸ªæ¡¶é‡Œæœ€å¤šèƒ½æ”¾å¤šå°‘ä¸ª fingerprintï¼ˆæŒ‡çº¹ï¼‰ï¼Œé»˜è®¤ 2(å¤§å¤šæ•°æƒ…å†µä¸‹çš„æœ€ä¼˜è§£)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> maxIterations é‡æ’æ¬¡æ•°ï¼Œè¶Šå¤§æˆåŠŸç‡è¶Šé«˜</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> expansion     æ‰©å®¹å€æ•°ï¼Œé»˜è®¤ 1ï¼ˆä¸æ‰©å®¹ï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">reserve</span><span class="params">(String key, <span class="type">long</span> capacity, <span class="type">int</span> bucketSize, <span class="type">int</span> maxIterations, <span class="type">int</span> expansion)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> String.format(</span><br><span class="line">                <span class="string">&quot;return redis.call(&#x27;CF.RESERVE&#x27;, KEYS[1], %d, &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;&#x27;BUCKETSIZE&#x27;, %d, &#x27;MAXITERATIONS&#x27;, %d, &#x27;EXPANSION&#x27;, %d)&quot;</span>,</span><br><span class="line">                capacity, bucketSize, maxIterations, expansion</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            redisTemplate.execute(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, String.class),</span><br><span class="line">                    Collections.singletonList(key)</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;RedisCuckooFilterTool reserve error:&quot;</span>,e);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ·»åŠ å…ƒç´ ï¼ˆä¸å»é‡ï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;CF.ADD&#x27;, KEYS[1], ARGV[1])&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Boolean</span> <span class="variable">execute</span> <span class="operator">=</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Boolean.class),</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                value</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE.equals(execute);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ·»åŠ å…ƒç´ ï¼ˆä»…å½“ä¸å­˜åœ¨æ—¶ï¼‰</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true è¡¨ç¤ºæˆåŠŸæ’å…¥ï¼Œfalse è¡¨ç¤ºå·²å­˜åœ¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">addNx</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;CF.ADDNX&#x27;, KEYS[1], ARGV[1])&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Boolean</span> <span class="variable">execute</span> <span class="operator">=</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Boolean.class),</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                value</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE.equals(execute);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">exists</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;CF.EXISTS&#x27;, KEYS[1], ARGV[1])&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Boolean</span> <span class="variable">execute</span> <span class="operator">=</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Boolean.class),</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                value</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE.equals(execute);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ‰¹é‡åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ¯ä¸ªå…ƒç´ å¯¹åº”çš„ç»“æœï¼Œ1 è¡¨ç¤ºå­˜åœ¨ï¼Œ0 è¡¨ç¤ºä¸å­˜åœ¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Long&gt; <span class="title function_">mexists</span><span class="params">(String key, String... items)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;CF.MEXISTS&#x27;, KEYS[1], unpack(ARGV))&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (items == <span class="literal">null</span> || items.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, List.class),</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                items</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿”å›å…ƒç´ å‡ºç°æ¬¡æ•°ï¼ˆè¿‘ä¼¼ï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">count</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;CF.COUNT&#x27;, KEYS[1], ARGV[1])&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Long.class),</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                value</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ é™¤å…ƒç´ </span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true åˆ é™¤æˆåŠŸï¼Œfalse è¡¨ç¤ºä¸å­˜åœ¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">delete</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;CF.DEL&#x27;, KEYS[1], ARGV[1])&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Long</span> <span class="variable">execute</span> <span class="operator">=</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Long.class),</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                value</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE.equals(execute);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ‰¹é‡æ’å…¥ï¼Œä¸å»é‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ¯ä¸ªå…ƒç´ å¯¹åº”æ’å…¥ç»“æœï¼Œ1 æ’å…¥æˆåŠŸï¼Œ0 æ’å…¥å¤±è´¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Long&gt; <span class="title function_">insert</span><span class="params">(String key, String... items)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;CF.INSERT&#x27;, KEYS[1], &#x27;ITEMS&#x27;, unpack(ARGV))&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (items == <span class="literal">null</span> || items.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, List.class),</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                items</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ‰¹é‡æ’å…¥ï¼Œå»é‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ¯ä¸ªå…ƒç´ å¯¹åº”æ’å…¥ç»“æœï¼Œ1 æ’å…¥æˆåŠŸï¼Œ0 æ’å…¥å¤±è´¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Boolean&gt; <span class="title function_">insertNx</span><span class="params">(String key, String... items)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;CF.INSERTNX&#x27;, KEYS[1], &#x27;ITEMS&#x27;, unpack(ARGV))&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (items == <span class="literal">null</span> || items.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, List.class),</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                items</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å– Cuckoo Filter å…ƒä¿¡æ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Long&gt; <span class="title function_">info</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;CF.INFO&#x27;, KEYS[1])&quot;</span>;</span><br><span class="line">        List&lt;Object&gt; result = redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, List.class),</span><br><span class="line">                Collections.singletonList(key)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result == <span class="literal">null</span> || result.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyMap();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Long&gt; infoMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; result.size(); i += <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">field</span> <span class="operator">=</span> toString(result.get(i));</span><br><span class="line">            <span class="type">Long</span> <span class="variable">value</span> <span class="operator">=</span> (Long) result.get(i + <span class="number">1</span>);</span><br><span class="line">            infoMap.put(field, value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> infoMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å­—èŠ‚æ•°ç»„è½¬å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="comment">     * info è¿”å›çš„ List</span></span><br><span class="line"><span class="comment">     * [</span></span><br><span class="line"><span class="comment">     * byte[](&quot;Size&quot;),                  Long(1080),</span></span><br><span class="line"><span class="comment">     * byte[](&quot;Number of buckets&quot;),     Long(512),</span></span><br><span class="line"><span class="comment">     * byte[](&quot;Number of filters&quot;),     Long(1),</span></span><br><span class="line"><span class="comment">     * ...</span></span><br><span class="line"><span class="comment">     * ]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">toString</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> <span class="type">byte</span>[]) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>((<span class="type">byte</span>[]) obj);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡ä»‹ç» Redis æ‰©å±•æ¨¡å‹ RedisBloom ä¸­çš„ Cuckoo Filter æ•°æ®ç±»å‹&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡åŸºäº&lt;code&gt;redis-7.4.7&lt;/code&gt;ï¼Œ&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Rediså®˜ç½‘ï¼š&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis å‘½ä»¤æ–‡æ¡£ï¼š&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;RedisBloom çš„å®‰è£…å‚è§ &lt;a href=&quot;/2025/12/21/redis7-module-RedisBloom/&quot; title=&quot;Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•&quot;&gt;Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;ç¤ºä¾‹ä»£ç ï¼š&lt;a href=&quot;https://github.com/hanqunfeng/springbootchapter/tree/master/springboot3-demo/redis-demo/data-type-demo&quot;&gt;GitHub&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis å‘½ä»¤åŠæ•°æ®ç±»å‹ -- BF(Bloom Filter)</title>
    <link href="https://blog.hanqunfeng.com/2025/12/22/redis7-datatype-11-BF/"/>
    <id>https://blog.hanqunfeng.com/2025/12/22/redis7-datatype-11-BF/</id>
    <published>2025-12-22T05:40:05.000Z</published>
    <updated>2026-01-06T10:10:11.963Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2">æœ¬æ–‡ä»‹ç» Redis æ‰©å±•æ¨¡å‹ RedisBloom ä¸­çš„ Bloom Filter æ•°æ®ç±»å‹</li><li class="lvl-2">æœ¬æ–‡åŸºäº<code>redis-7.4.7</code>ï¼Œ<code>springboot-3.5.8</code></li><li class="lvl-2">Rediså®˜ç½‘ï¼š<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis å‘½ä»¤æ–‡æ¡£ï¼š<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li><li class="lvl-2">RedisBloom çš„å®‰è£…å‚è§ <a href="/2025/12/21/redis7-module-RedisBloom/" title="Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•">Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•</a></li><li class="lvl-2">ç¤ºä¾‹ä»£ç ï¼š<a href="https://github.com/hanqunfeng/springbootchapter/tree/master/springboot3-demo/redis-demo/data-type-demo">GitHub</a></li></ul><span id="more"></span><h2 id="Bloom-Filter-å¸ƒéš†è¿‡æ»¤å™¨">Bloom Filter(å¸ƒéš†è¿‡æ»¤å™¨)</h2><ul class="lvl-0"><li class="lvl-2"><p>å¸ƒéš†è¿‡æ»¤å™¨æ˜¯ä¸€ç§ç”¨äºå¿«é€Ÿåˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨çš„ probabilistic data structureï¼ˆæ¦‚ç‡æ•°æ®ç»“æ„ï¼‰ï¼Œéå¸¸é€‚åˆæµ·é‡æ•°æ®ä¸”ä¸è¦æ±‚ç»å¯¹ç²¾ç¡®çš„åœºæ™¯ã€‚</p></li><li class="lvl-2"><p><a href="https://en.wikipedia.org/wiki/Bloom_filter">ç»´åŸºç™¾ç§‘å¯¹ Bloom Filter çš„æè¿°</a></p></li><li class="lvl-2"><p>ç”Ÿäº§ç¯å¢ƒæ¨èä½¿ç”¨ <a href="https://redisson.pro/docs/data-and-services/objects/#bloom-filter">Redissonçš„å¸ƒéš†è¿‡æ»¤å™¨</a></p></li><li class="lvl-2"><p>å¸ƒéš†è¿‡æ»¤å™¨ä½¿ç”¨ä¸€ä¸ªå¾ˆé•¿çš„äºŒè¿›åˆ¶ä½æ•°ç»„å’Œä¸€ç³»åˆ—å“ˆå¸Œå‡½æ•°æ¥ä¿å­˜å…ƒç´ ã€‚</p><ul class="lvl-2"><li class="lvl-6">ä¼˜ç‚¹: éå¸¸èŠ‚çœç©ºé—´ã€æŸ¥è¯¢å¿«</li><li class="lvl-6">ç¼ºç‚¹: æœ‰ä¸€å®šçš„è¯¯åˆ¤æ¦‚ç‡ã€æ— æ³•åˆ é™¤å…ƒç´ ã€æ— æ³•ç»™å…ƒç´ è®¡æ•°</li></ul></li><li class="lvl-2"><p>å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­ä¸€ä¸ªå…ƒç´ ä¸åœ¨é›†åˆä¸­ï¼Œé‚£ä¹ˆè¿™ä¸ªå…ƒç´ è‚¯å®šä¸åœ¨é›†åˆä¸­ã€‚ä½†æ˜¯ï¼Œå¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­ä¸€ä¸ªå…ƒç´ åœ¨é›†åˆä¸­ï¼Œé‚£ä¹ˆè¿™ä¸ªå…ƒç´ æœ‰å¯èƒ½ä¸åœ¨é›†åˆä¸­ã€‚<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/l7rGDM.png" alt=""></p></li><li class="lvl-2"><p>ä½æ•°ç»„ï¼ˆBit Arrayï¼‰ï¼šå¸ƒéš†è¿‡æ»¤å™¨ä½¿ç”¨ä¸€ä¸ªé•¿åº¦å›ºå®šçš„ä½æ•°ç»„æ¥å­˜å‚¨æ•°æ®ã€‚æ¯ä¸ªä½ç½®åªå ç”¨ä¸€ä¸ªæ¯”ç‰¹ï¼ˆ0æˆ–1ï¼‰ï¼Œåˆå§‹æ—¶æ‰€æœ‰ä½éƒ½è®¾ç½®ä¸º0ã€‚ä½æ•°ç»„çš„é•¿åº¦å’Œå“ˆå¸Œå‡½æ•°çš„æ•°é‡å†³å®šäº†è¿‡æ»¤å™¨çš„è¯¯æŠ¥ç‡å’Œå®¹é‡ã€‚</p></li><li class="lvl-2"><p>å“ˆå¸Œå‡½æ•°é›†åˆï¼šå¸ƒéš†è¿‡æ»¤å™¨ä½¿ç”¨å¤šä¸ªå“ˆå¸Œå‡½æ•°ï¼Œæ¯ä¸ªå‡½æ•°éƒ½ä¼šå°†è¾“å…¥æ•°æ®æ˜ å°„åˆ°ä½æ•°ç»„çš„ä¸€ä¸ªä¸åŒä½ç½®ã€‚å“ˆå¸Œå‡½æ•°çš„é€‰æ‹©å¯¹è¿‡æ»¤å™¨çš„æ€§èƒ½æœ‰å¾ˆå¤§å½±å“ï¼Œç†æƒ³çš„å“ˆå¸Œå‡½æ•°åº”è¯¥å…·æœ‰è‰¯å¥½çš„æ•£åˆ—æ€§ï¼Œä½¿å¾—ä¸åŒçš„è¾“å…¥å°½å¯èƒ½å‡åŒ€åœ°æ˜ å°„åˆ°ä½æ•°ç»„çš„ä¸åŒä½ç½®ã€‚</p></li><li class="lvl-2"><p>å¦‚ä½•é™ä½è¯¯åˆ¤ç‡ï¼Ÿ</p><ul class="lvl-2"><li class="lvl-6">æ›´å¤§çš„ä½æ•°ç»„</li><li class="lvl-6">æ›´å¤šçš„å“ˆå¸Œå‡½æ•°</li></ul></li><li class="lvl-2"><p>å¾ˆå¤šäººéƒ½æ˜¯ç”¨è¿‡Googleå¼€æºçš„Guavaçš„å¸ƒéš†è¿‡æ»¤å™¨ï¼Œä½†å…¶æ˜¯JVMå±‚çš„å¸ƒéš†è¿‡æ»¤å™¨ï¼Œè‹¥éœ€è¦åˆ†å¸ƒå¼å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå°±å¯ä»¥ä½¿ç”¨RedisBloomæä¾›çš„BF(Bloom Filter)ã€‚</p></li></ul><h2 id="BF-å‘½ä»¤è¯´æ˜">BF å‘½ä»¤è¯´æ˜</h2><ul class="lvl-0"><li class="lvl-2"><p>å¯¹åº”Rediså‘½ä»¤ï¼š <code>BF.xxx</code></p></li></ul><table><thead><tr><th>å‘½ä»¤</th><th>åŠŸèƒ½è¯´æ˜</th><th>æ˜¯å¦åˆ›å»º Filter</th><th>å…³é”®å‚æ•°å«ä¹‰</th><th>è¿”å›å€¼</th><th>ç¤ºä¾‹</th><th>ä½¿ç”¨è¦ç‚¹ / å¤‡æ³¨</th></tr></thead><tbody><tr><td><strong>BF.RESERVE</strong></td><td>æ˜¾å¼åˆ›å»º Bloom Filter</td><td>æ˜¯ï¼ˆå·²å­˜åœ¨åˆ™æŠ¥é”™ï¼‰</td><td><code>error_rate</code>ï¼šè¯¯åˆ¤ç‡<br><code>capacity</code>ï¼šé¢„è®¡å…ƒç´ æ•°<br><code>EXPANSION</code>ï¼šæ‰©å®¹å€ç‡</td><td>OK</td><td><code>BF.RESERVE user:bf 0.001 1000000</code></td><td>âœ… <strong>ç”Ÿäº§æ¨è</strong><br>æ˜¾å¼è§„åˆ’å®¹é‡ä¸è¯¯åˆ¤ç‡ï¼Œé¿å…éšå¼åˆ›å»º</td></tr><tr><td><strong>BF.ADD</strong></td><td>æ·»åŠ å•ä¸ªå…ƒç´ </td><td>æ˜¯ï¼ˆä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰</td><td>æ— </td><td><code>1</code> æ–°å¢<br><code>0</code> å¯èƒ½å·²å­˜åœ¨</td><td><code>BF.ADD user:bf user_1</code></td><td>Key å¿…é¡»å·²å­˜åœ¨ï¼Œå¦åˆ™æŠ¥é”™</td></tr><tr><td><strong>BF.MADD</strong></td><td>æ‰¹é‡æ·»åŠ å…ƒç´ </td><td>æ˜¯ï¼ˆä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰</td><td><code>item...</code>ï¼šå¤šä¸ªå…ƒç´ </td><td><code>0/1</code> åˆ—è¡¨</td><td><code>BF.MADD user:bf u1 u2 u3</code></td><td>âš  ä½¿ç”¨é»˜è®¤é…ç½®ï¼Œä¸å»ºè®®ç”Ÿäº§</td></tr><tr><td><strong>BF.INSERT</strong></td><td>æ‰¹é‡æ’å…¥ï¼ˆå¯æ§å‚æ•°ï¼‰</td><td>æ˜¯</td><td><code>CAPACITY</code>ï¼šå®¹é‡<br><code>ERROR</code>ï¼šè¯¯åˆ¤ç‡<br><code>NOCREATE</code>:ä¸è‡ªåŠ¨åˆ›å»ºè¿‡æ»¤å™¨<br><code>NONSCALING</code>: ä¸æ‰©å®¹ï¼Œè¾¾åˆ°capacityæ—¶ï¼Œè¿‡æ»¤å™¨è¿”å›é”™è¯¯<br><code>EXPANSION expansion</code>:æ‰©å®¹æ—¶ï¼Œæ–°å»ºå­è¿‡æ»¤å™¨çš„å®¹é‡å¢é•¿å€ç‡ï¼Œé»˜è®¤2 <br><code>ITEMS</code>ï¼šå…ƒç´ åˆ—è¡¨</td><td><code>0/1</code> åˆ—è¡¨</td><td><code>BF.INSERT user:bf CAPACITY 10000 ERROR 0.001 ITEMS u1 u2</code></td><td>âœ… <strong>æœ€æ¨èçš„å†™å…¥æ–¹å¼</strong><br>æ”¯æŒåˆå§‹åŒ– + æ’å…¥</td></tr><tr><td><strong>BF.EXISTS</strong></td><td>åˆ¤æ–­å•ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨</td><td>å¦</td><td><code>item</code>ï¼šå¾…åˆ¤æ–­å…ƒç´ </td><td><code>1</code> å¯èƒ½å­˜åœ¨<br><code>0</code> ä¸€å®šä¸å­˜åœ¨</td><td><code>BF.EXISTS user:bf user_1</code></td><td>ä¸å­˜åœ¨ç»“æœ <strong>ç»å¯¹å¯é </strong></td></tr><tr><td><strong>BF.MEXISTS</strong></td><td>æ‰¹é‡åˆ¤æ–­æ˜¯å¦å­˜åœ¨</td><td>å¦</td><td><code>item...</code>ï¼šå¤šä¸ªå…ƒç´ </td><td><code>0/1</code> åˆ—è¡¨</td><td><code>BF.MEXISTS user:bf u1 u9</code></td><td>é«˜å¹¶å‘æ‰¹é‡æŸ¥è¯¢é¦–é€‰</td></tr><tr><td><strong>BF.CARD</strong></td><td>è¿”å›æ’å…¥å…ƒç´ æ•°é‡ï¼ˆè¿‘ä¼¼ï¼‰</td><td>å¦</td><td>æ— </td><td>æ•´æ•°</td><td><code>BF.CARD user:bf</code></td><td>ç”¨äºå®¹é‡ç›‘æ§ï¼Œéç²¾ç¡®</td></tr><tr><td><strong><a href="http://BF.INFO">BF.INFO</a></strong></td><td>è¿”å› Bloom Filter å…ƒä¿¡æ¯</td><td>å¦</td><td>æ— </td><td>KV åˆ—è¡¨</td><td><code>BF.INFO user:bf</code></td><td>è¿ç»´ã€å®¹é‡ä¸å†…å­˜åˆ†æå¿…å¤‡</td></tr><tr><td><strong>BF.SCANDUMP</strong></td><td>åˆ†å—å¯¼å‡º Bloom Filter</td><td>å¦</td><td><code>iterator</code>ï¼šæ¸¸æ ‡</td><td><code>iterator + data</code></td><td><code>BF.SCANDUMP user:bf 0</code></td><td>ç”¨äºè¿ç§»ã€å¤‡ä»½</td></tr><tr><td><strong>BF.LOADCHUNK</strong></td><td>ä» dump æ•°æ®æ¢å¤ Filter</td><td>æ˜¯</td><td><code>iterator</code><br><code>data</code></td><td>OK</td><td><code>BF.LOADCHUNK user:bf 1 &quot;xxx&quot;</code></td><td>å¿…é¡»ä¸ SCANDUMP é…åˆä½¿ç”¨</td></tr></tbody></table><h2 id="BF-å‘½ä»¤ç¤ºä¾‹">BF å‘½ä»¤ç¤ºä¾‹</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆå§‹åŒ–ä¸€ä¸ªBloomFilterï¼Œé”™è¯¯ç‡0.01ï¼Œå…ƒç´ æ•°é‡1000</span></span><br><span class="line">127.0.0.1:6379&gt; BF.RESERVE <span class="built_in">test</span> 0.01 1000</span><br><span class="line">OK</span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç±»å‹</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">type</span> <span class="built_in">test</span></span><br><span class="line">MBbloom--</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ å…ƒç´ </span></span><br><span class="line">127.0.0.1:6379&gt; BF.ADD <span class="built_in">test</span> user1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; BF.ADD <span class="built_in">test</span> user2</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"><span class="comment"># æ‰¹é‡æ·»åŠ å…ƒç´ </span></span><br><span class="line">127.0.0.1:6379&gt; BF.MADD <span class="built_in">test</span> user3 user4 user5</span><br><span class="line">1) (<span class="built_in">integer</span>) 1</span><br><span class="line">2) (<span class="built_in">integer</span>) 1</span><br><span class="line">3) (<span class="built_in">integer</span>) 1</span><br><span class="line"><span class="comment"># è¿”å›Bloomè¿‡æ»¤å™¨çš„åŸºæ•°ï¼Œå³æ·»åŠ çš„å…ƒç´ æ•°é‡(å­˜åœ¨è¯¯å·®)</span></span><br><span class="line">127.0.0.1:6379&gt; BF.CARD <span class="built_in">test</span></span><br><span class="line">(<span class="built_in">integer</span>) 5</span><br><span class="line"><span class="comment"># æŸ¥è¯¢å…ƒç´ æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">127.0.0.1:6379&gt; BF.EXISTS <span class="built_in">test</span> user2</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; BF.EXISTS <span class="built_in">test</span> user6</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line"><span class="comment"># æ‰¹é‡æŸ¥è¯¢å…ƒç´ æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">127.0.0.1:6379&gt; BF.MEXISTS <span class="built_in">test</span> user1 user2 user6</span><br><span class="line">1) (<span class="built_in">integer</span>) 1</span><br><span class="line">2) (<span class="built_in">integer</span>) 1</span><br><span class="line">3) (<span class="built_in">integer</span>) 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–ä¿¡æ¯</span></span><br><span class="line">127.0.0.1:6379&gt; BF.INFO <span class="built_in">test</span></span><br><span class="line"> 1) Capacity       <span class="comment"># åˆå§‹åŒ–æ—¶çš„å®¹é‡ï¼Œè¶…è¿‡è¯¥å€¼åï¼Œä¼šè§¦å‘ æ‰©å®¹ï¼ˆæ–°å»ºä¸€ä¸ªå­ Bloom Filterï¼‰</span></span><br><span class="line"> 2) (<span class="built_in">integer</span>) 1000</span><br><span class="line"> 3) Size           <span class="comment"># å½“å‰ Bloom Filter å®é™…ä½¿ç”¨çš„ bit array å¤§å°ï¼ˆå­—èŠ‚)ï¼Œç”± capacity + error_rate è®¡ç®—å¾—å‡ºï¼Œå€¼ä¸€æ—¦åˆ›å»º ä¸ä¼šéšå…ƒç´ å‡å°‘</span></span><br><span class="line"> 4) (<span class="built_in">integer</span>) 1480</span><br><span class="line"> 5) Number of filters <span class="comment"># å½“å‰ key å†…éƒ¨åŒ…å«çš„ Bloom Filter æ•°é‡</span></span><br><span class="line"> 6) (<span class="built_in">integer</span>) 1</span><br><span class="line"> 7) Number of items inserted  <span class="comment"># å·²è°ƒç”¨ BF.ADD / BF.MADD æ’å…¥çš„å…ƒç´ æ€»æ•°</span></span><br><span class="line"> 8) (<span class="built_in">integer</span>) 5</span><br><span class="line"> 9) Expansion rate     <span class="comment"># Bloom Filter æ‰©å®¹æ—¶ï¼Œæ–°å»ºå­è¿‡æ»¤å™¨çš„å®¹é‡å¢é•¿å€ç‡</span></span><br><span class="line">10) (<span class="built_in">integer</span>) 2</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="SpringBoot-é›†æˆ">SpringBoot é›†æˆ</h2><ul class="lvl-0"><li class="lvl-2"><p>SpringBoot çš„ RedisTemplate ä¸­æ²¡æœ‰æä¾›å¯¹<code>RedisBloom</code>çš„å°è£…ï¼Œéœ€è¦è‡ªå·±å°è£…ï¼Œæˆ‘è¿™é‡Œå°è£…äº†ä¸€ä¸ªç®€æ˜“çš„<code>RedisBloomFilterTool</code></p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.redisbloom;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åŸºäº RedisBloom æ’ä»¶çš„ BloomFilter å®ç°</span></span><br><span class="line"><span class="comment"> * https://github.com/RedisBloom/RedisBloom/releases</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * ä¸æƒ³å®‰è£…æ’ä»¶ä¹Ÿå¯ä»¥ä½¿ç”¨ Redission çš„ BloomFilter</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisBloomFilterTool</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisBloomFilterTool</span><span class="params">(StringRedisTemplate redisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ– BloomFilter</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * ä¸èƒ½é‡å¤åˆ›å»º</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key       BloomFilter åç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> errorRate é”™è¯¯ç‡ï¼Œæ¯”å¦‚ä¸º0.01ï¼Œå³ 1%</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> capacity  å®¹é‡ï¼Œæ¯”å¦‚ä¸º1000</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">reserve</span><span class="params">(String key, <span class="type">double</span> errorRate, <span class="type">long</span> capacity)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;BF.RESERVE&#x27;, KEYS[1], &quot;</span> + errorRate + <span class="string">&quot;, &quot;</span> + capacity + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.execute(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, String.class),</span><br><span class="line">                    Collections.singletonList(key)</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;RedisBloomFilterTool reserve error:&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ·»åŠ å…ƒç´ åˆ° BloomFilterï¼ŒBloomFilter ä¸å­˜åœ¨ä¼šè‡ªåŠ¨åˆ›å»º</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨ RedisModule æä¾›çš„ BF.ADD å‘½ä»¤</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;BF.ADD&#x27;, KEYS[1], ARGV[1])&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Boolean</span> <span class="variable">execute</span> <span class="operator">=</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Boolean.class),</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                value</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE.equals(execute);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">exists</span><span class="params">(String key, String value)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;BF.EXISTS&#x27;, KEYS[1], ARGV[1])&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Boolean</span> <span class="variable">execute</span> <span class="operator">=</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Boolean.class),</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                value</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> Boolean.TRUE.equals(execute);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ‰¹é‡æ·»åŠ </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ·»åŠ ç»“æœåˆ—è¡¨ï¼ŒæˆåŠŸ 1ï¼Œå¤±è´¥ 0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Long&gt; <span class="title function_">addBatch</span><span class="params">(String key, String... items)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;BF.MADD&#x27;, KEYS[1], unpack(ARGV))&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (items == <span class="literal">null</span> || items.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è°ƒç”¨ BF.MADD å‘½ä»¤</span></span><br><span class="line">        <span class="keyword">return</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, List.class),</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                items</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ‰¹é‡æ·»åŠ ï¼Œå¦‚æœBloomFilterä¸å­˜åœ¨ï¼Œåˆ™æ ¹æ®å‚æ•°åˆ›å»º BloomFilterï¼Œè‹¥å·²å­˜åœ¨ï¼Œåˆ™å¿½ç•¥ capacity å’Œ errorRate</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key       BloomFilter åç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> capacity  å®¹é‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> errorRate é”™è¯¯ç‡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> items     è¦æ·»åŠ çš„å…ƒç´ </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ·»åŠ ç»“æœåˆ—è¡¨ï¼ŒæˆåŠŸ 1ï¼Œå¤±è´¥ 0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Long&gt; <span class="title function_">insert</span><span class="params">(String key, <span class="type">long</span> capacity, <span class="type">double</span> errorRate, String... items)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;BF.INSERT&#x27;, KEYS[1], &#x27;CAPACITY&#x27;, ARGV[1], &#x27;ERROR&#x27;, ARGV[2], &#x27;ITEMS&#x27;, unpack(ARGV, 3))&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (items == <span class="literal">null</span> || items.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;Object&gt; args = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        args.add(String.valueOf(capacity));</span><br><span class="line">        args.add(String.valueOf(errorRate));</span><br><span class="line">        Collections.addAll(args, items);   <span class="comment">// âœ… å…³é”®ç‚¹</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// è°ƒç”¨ BF.INSERT å‘½ä»¤</span></span><br><span class="line">        <span class="keyword">return</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, List.class),</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                args.toArray()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ‰¹é‡åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å­˜åœ¨ 1ï¼Œä¸å­˜åœ¨ 0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Long&gt; <span class="title function_">mexists</span><span class="params">(String key, String... items)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;BF.MEXISTS&#x27;, KEYS[1], unpack(ARGV))&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (items == <span class="literal">null</span> || items.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è°ƒç”¨ BF.MADD å‘½ä»¤</span></span><br><span class="line">        <span class="keyword">return</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, List.class),</span><br><span class="line">                Collections.singletonList(key),</span><br><span class="line">                items</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–å…ƒç´ æ•°é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">card</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;BF.CARD&#x27;, KEYS[1])&quot;</span>;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨ RedisModule æä¾›çš„ BF.CARD å‘½ä»¤</span></span><br><span class="line">        <span class="keyword">return</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, Long.class),</span><br><span class="line">                Collections.singletonList(key)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å– Bloom Filter å…ƒä¿¡æ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Long&gt; <span class="title function_">info</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">&quot;return redis.call(&#x27;BF.INFO&#x27;, KEYS[1])&quot;</span>;</span><br><span class="line"></span><br><span class="line">        List&lt;Object&gt; result = redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(script, List.class),</span><br><span class="line">                Collections.singletonList(key)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result == <span class="literal">null</span> || result.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyMap();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Long&gt; infoMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; result.size(); i += <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">field</span> <span class="operator">=</span> toString(result.get(i));</span><br><span class="line">            <span class="type">Long</span> <span class="variable">value</span> <span class="operator">=</span> (Long) result.get(i + <span class="number">1</span>);</span><br><span class="line">            infoMap.put(field, value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> infoMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">toString</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> <span class="type">byte</span>[]) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>((<span class="type">byte</span>[]) obj);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="SpringBoot-ä¸-Redisson-é›†æˆä¹‹-BloomFilter-çš„ä½¿ç”¨æ–¹æ³•">SpringBoot ä¸ Redisson é›†æˆä¹‹ BloomFilter çš„ä½¿ç”¨æ–¹æ³•</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.52.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class="line">RBloomFilter&lt;Object&gt; bloomFilter = redissonClient.getBloomFilter(<span class="string">&quot;bloomFilter&quot;</span>);</span><br><span class="line">bloomFilter.tryInit(<span class="number">1000000</span>, <span class="number">0.01</span>); <span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line">bloomFilter.add(<span class="string">&quot;test&quot;</span>); <span class="comment">// æ·»åŠ å…ƒç´ </span></span><br><span class="line">System.out.println(bloomFilter.contains(<span class="string">&quot;test&quot;</span>)); <span class="comment">// åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">System.out.println(bloomFilter.count()); <span class="comment">// è·å–å½“å‰å¸ƒéš†è¿‡æ»¤å™¨ä¸­å·²æ·»åŠ çš„å…ƒç´ ä¸ªæ•°</span></span><br><span class="line">System.out.println(bloomFilter.getSize()); <span class="comment">// è·å–å½“å‰å¸ƒéš†è¿‡æ»¤å™¨å ç”¨å†…å­˜çš„å¤§å°ï¼Œå•ä½bit</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡ä»‹ç» Redis æ‰©å±•æ¨¡å‹ RedisBloom ä¸­çš„ Bloom Filter æ•°æ®ç±»å‹&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡åŸºäº&lt;code&gt;redis-7.4.7&lt;/code&gt;ï¼Œ&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Rediså®˜ç½‘ï¼š&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis å‘½ä»¤æ–‡æ¡£ï¼š&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;RedisBloom çš„å®‰è£…å‚è§ &lt;a href=&quot;/2025/12/21/redis7-module-RedisBloom/&quot; title=&quot;Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•&quot;&gt;Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;ç¤ºä¾‹ä»£ç ï¼š&lt;a href=&quot;https://github.com/hanqunfeng/springbootchapter/tree/master/springboot3-demo/redis-demo/data-type-demo&quot;&gt;GitHub&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis æ‰©å±•æ¨¡å— -- RedisBloom çš„å®‰è£…æ–¹æ³•</title>
    <link href="https://blog.hanqunfeng.com/2025/12/21/redis7-module-RedisBloom/"/>
    <id>https://blog.hanqunfeng.com/2025/12/21/redis7-module-RedisBloom/</id>
    <published>2025-12-21T13:30:05.000Z</published>
    <updated>2026-01-05T02:00:34.824Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2">æœ¬æ–‡ä»‹ç» Redis æ‰©å±•æ¨¡å— â€“ RedisBloom çš„å®‰è£…æ–¹æ³•</li><li class="lvl-2">æœ¬æ–‡åŸºäº<code>redis-7.4.7</code>ï¼Œ<code>springboot-3.5.8</code></li><li class="lvl-2">æ“ä½œç³»ç»Ÿï¼š<code>Amazon Linux 2023(å†…æ ¸ 6.1)</code></li><li class="lvl-2">Rediså®˜ç½‘ï¼š<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis å‘½ä»¤æ–‡æ¡£ï¼š<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li></ul><span id="more"></span><h2 id="RedisBloom-ç®€ä»‹">RedisBloom ç®€ä»‹</h2><ul class="lvl-0"><li class="lvl-2"><p><a href="https://github.com/RedisBloom/RedisBloom">RedisBloom</a> æ˜¯ Redis å®˜æ–¹ç»´æŠ¤çš„ä¸€ä¸ªæ‰©å±•æ¨¡å—ï¼Œéš¶å±äº <code>Redis Stack</code>ï¼Œä¸“é—¨ç”¨äºæä¾›æ¦‚ç‡å‹æ•°æ®ç»“æ„ï¼ˆProbabilistic Data Structuresï¼‰çš„é«˜æ€§èƒ½å®ç°ã€‚</p></li><li class="lvl-2"><p>å®ƒé€šè¿‡ç‰ºç‰²ä¸€å®šçš„ç²¾ç¡®æ€§ï¼Œæ¢å–æä½çš„å†…å­˜å ç”¨å’Œæé«˜çš„ååèƒ½åŠ›ï¼Œéå¸¸é€‚åˆæµ·é‡æ•°æ®åœºæ™¯ä¸‹çš„â€œå­˜åœ¨æ€§åˆ¤æ–­â€å’Œâ€œè¿‘ä¼¼ç»Ÿè®¡â€ã€‚</p></li><li class="lvl-2"><p>è¯¥æ¨¡å—ä»¥ <code>Redis Module</code> æ–¹å¼åŠ è½½ï¼Œå¯æ— ç¼é›†æˆåˆ°ç°æœ‰ Redis å®ä¾‹ä¸­ã€‚</p></li><li class="lvl-2"><p>Redis8+ï¼ŒRedisBloom å·²ç»å†…ç½®åœ¨ Redis ä¸­ï¼Œå¯ä»¥åœ¨å®‰è£…redisåŒæ—¶å®‰è£…å…¨éƒ¨ Stack æ¨¡å—ã€‚</p></li></ul><h2 id="RedisBloom-æä¾›çš„æ ¸å¿ƒæ•°æ®ç»“æ„">RedisBloom æä¾›çš„æ ¸å¿ƒæ•°æ®ç»“æ„</h2><ul class="lvl-0"><li class="lvl-2"><p>å®‰è£…å¥½RedisBloomåï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼æŸ¥çœ‹RedisBloom æ”¯æŒçš„å‘½ä»¤</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®é™…ä¸Šæ‰€æœ‰ Stack Module Commandséƒ½æ˜¯é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ï¼Œå› ä¸ºæˆ‘ä»¬è¿™é‡Œåªå®‰è£…äº† RedisBloomï¼Œæ‰€ä»¥æ­¤æ—¶ä»…å¯ä»¥çœ‹åˆ° RedisBloom æ¨¡å—çš„å‘½ä»¤</span></span><br><span class="line">&gt; <span class="built_in">help</span> @module</span><br></pre></td></tr></table></figure><h3 id="é€šè¿‡è¾“å‡ºæˆ‘ä»¬å¯ä»¥çœ‹åˆ°-RedisBloom-æ¨¡å—æ”¯æŒçš„å‘½ä»¤å¤§è‡´åˆ†ä¸º-5-ç±»">é€šè¿‡è¾“å‡ºæˆ‘ä»¬å¯ä»¥çœ‹åˆ° RedisBloom æ¨¡å—æ”¯æŒçš„å‘½ä»¤å¤§è‡´åˆ†ä¸º 5 ç±»</h3><ul class="lvl-0"><li class="lvl-2"><p>1ï¸âƒ£ Bloom Filterï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ï¼‰</p><ul class="lvl-2"><li class="lvl-6">åˆ¤æ–­æŸä¸ªå…ƒç´ â€œå¯èƒ½å­˜åœ¨ / ä¸€å®šä¸å­˜åœ¨â€ï¼Œä½†ä¸å­˜å‚¨å…ƒç´ æœ¬èº«ï¼Œä¹Ÿä¸æ”¯æŒåˆ é™¤</li><li class="lvl-6"><a href="https://en.wikipedia.org/wiki/Bloom_filter">ç»´åŸºç™¾ç§‘å¯¹ Bloom Filter çš„æè¿°</a></li><li class="lvl-6">ç”Ÿäº§ç¯å¢ƒæ¨èä½¿ç”¨ <a href="https://redisson.pro/docs/data-and-services/objects/#bloom-filter">Redissonçš„å¸ƒéš†è¿‡æ»¤å™¨</a></li><li class="lvl-6">å¯¹åº”Rediså‘½ä»¤ï¼š <code>BF.xxx</code>ï¼Œè¯¦ç»†çš„ä½¿ç”¨æ–¹æ³•å‚è§ <a href="/2025/12/22/redis7-datatype-11-BF/" title="Redis å‘½ä»¤åŠæ•°æ®ç±»å‹ -- BF(Bloom Filter)">Redis å‘½ä»¤åŠæ•°æ®ç±»å‹ -- BF(Bloom Filter)</a></li></ul></li><li class="lvl-2"><p>2ï¸âƒ£ Cuckoo Filterï¼ˆå¸ƒè°·é¸Ÿè¿‡æ»¤å™¨ï¼‰</p><ul class="lvl-2"><li class="lvl-6">Bloom Filter çš„å¢å¼ºç‰ˆï¼Œæ”¯æŒ åˆ é™¤å…ƒç´ </li><li class="lvl-6"><a href="https://en.wikipedia.org/wiki/Cuckoo_filter">ç»´åŸºç™¾ç§‘å¯¹ Cuckoo Filter çš„æè¿°</a></li><li class="lvl-6">åœ¨é«˜ QPS æŸ¥è¯¢åœºæ™¯ä¸‹ï¼ŒCuckoo Filter é€šå¸¸ä¼˜äº Bloom Filterã€‚</li><li class="lvl-6">ä½è¯¯åˆ¤ç‡ + é«˜è´Ÿè½½ç‡åœºæ™¯ï¼ŒCuckoo Filter æ›´çœå†…å­˜ã€‚</li><li class="lvl-6">å¯¹åº”Rediså‘½ä»¤ï¼š <code>CF.xxx</code>ï¼Œè¯¦ç»†çš„ä½¿ç”¨æ–¹æ³•å‚è§ <a href="/2025/12/22/redis7-datatype-12-CF/" title="Redis å‘½ä»¤åŠæ•°æ®ç±»å‹ -- CF(Cuckoo Filter)">Redis å‘½ä»¤åŠæ•°æ®ç±»å‹ -- CF(Cuckoo Filter)</a></li></ul></li><li class="lvl-2"><p>3ï¸âƒ£ Count-Min Sketchï¼ˆCMSï¼‰</p><ul class="lvl-2"><li class="lvl-6">è¿‘ä¼¼ç»Ÿè®¡å…ƒç´ å‡ºç°é¢‘ç‡</li><li class="lvl-6">å¯¹åº”Rediså‘½ä»¤ï¼š <code>CMS.xxx</code>ï¼Œè¯¦ç»†çš„ä½¿ç”¨æ–¹æ³•å‚è§ <a href="/2025/12/23/redis7-datatype-13-CMS/" title="Redis å‘½ä»¤åŠæ•°æ®ç±»å‹ -- CMS(Count-Min Sketch)">Redis å‘½ä»¤åŠæ•°æ®ç±»å‹ -- CMS(Count-Min Sketch)</a></li></ul></li><li class="lvl-2"><p>4ï¸âƒ£ Top-K</p><ul class="lvl-2"><li class="lvl-6">ç»Ÿè®¡è®¿é—®é¢‘ç‡æœ€é«˜çš„ K ä¸ªå…ƒç´ </li><li class="lvl-6">å¯¹åº”Rediså‘½ä»¤ï¼š <code>TOPK.xxx</code>ï¼Œè¯¦ç»†çš„ä½¿ç”¨æ–¹æ³•å‚è§ <a href="/2025/12/23/redis7-datatype-14-TopK/" title="Redis å‘½ä»¤åŠæ•°æ®ç±»å‹ -- TopK">Redis å‘½ä»¤åŠæ•°æ®ç±»å‹ -- TopK</a></li></ul></li><li class="lvl-2"><p>5ï¸âƒ£ TDigest</p><ul class="lvl-2"><li class="lvl-6">ç»Ÿè®¡æ•°å­—çš„åˆ†å¸ƒ</li><li class="lvl-6">å¯¹åº”Rediså‘½ä»¤ï¼š <code>TDIGEST.xxx</code>ï¼Œè¯¦ç»†çš„ä½¿ç”¨æ–¹æ³•å‚è§ <a href="/2025/12/23/redis7-datatype-15-TDigest/" title="Redis å‘½ä»¤åŠæ•°æ®ç±»å‹ -- TDigest">Redis å‘½ä»¤åŠæ•°æ®ç±»å‹ -- TDigest</a></li></ul></li></ul><h2 id="å®‰è£…-RedisBloom">å®‰è£… RedisBloom</h2><ul class="lvl-0"><li class="lvl-2"><p>æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯ä»<a href="https://cloud.redis.io">Redis Cloud</a>çš„<code>Download Center</code>ä¸­è¿›è¡Œä¸‹è½½ï¼Œå…¶æä¾›äº†æ‰€æœ‰Redisæ¨¡å—ç¼–è¯‘åçš„<code>.so</code>æ–‡ä»¶ï¼Œå¯ä»¥ä¼˜å…ˆè¿›è¡Œå°è¯•ï¼Œä½†æ˜¯å¹¶ä¸ä¿è¯ä¸€å®šå…¼å®¹ï¼Œæ‰€ä»¥æœ€ç¨³å¦¥çš„æ–¹å¼æ˜¯é€šè¿‡æºç è‡ªå·±ç¼–è¯‘ã€‚<br><img src="https://upic-oss.oss-cn-beijing.aliyuncs.com/uPic/rguEIA.png" alt=""></p></li><li class="lvl-2"><p>æºç ç¼–è¯‘</p></li></ul><blockquote><p>å®‰è£…æ—¶éœ€è¦ç§‘å­¦ä¸Šç½‘ï¼Œä¸»è¦æ˜¯å®‰è£…ä¾èµ–æ—¶éœ€è¦ä»æµ·å¤–ç½‘ä¸‹è½½ï¼Œå¦‚æœè¦éƒ¨ç½²åœ¨å›½å†…æœåŠ¡å™¨ï¼Œå¯èƒ½ä¼šè¿æ¥å¤±è´¥ã€‚<br>å¯ä»¥åœ¨æµ·å¤–çš„<code>ç›¸åŒé…ç½®</code>çš„æœåŠ¡å™¨ä¸Šè¿›è¡Œç¼–è¯‘ï¼Œä¹‹åå°†ç¼–è¯‘å¥½çš„<code>redisbloom.so</code>ä¸Šä¼ åˆ°å›½å†…æœåŠ¡å™¨å³å¯ã€‚</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>å®‰è£…ä¾èµ–</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> dnf install -y \</span><br><span class="line">  gcc \</span><br><span class="line">  gcc-c++ \</span><br><span class="line">  make \</span><br><span class="line">  cmake \</span><br><span class="line">  autoconf \</span><br><span class="line">  automake \</span><br><span class="line">  libtool \</span><br><span class="line">  pkgconfig \</span><br><span class="line">  openssl-devel</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç¼–è¯‘RedisBloom</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /usr/local/soft/modules/</span><br><span class="line"><span class="built_in">cd</span> /usr/local/soft/modules</span><br><span class="line"><span class="comment"># clone ä»£ç ï¼Œè¿™é‡Œ --recursive æ˜¯ä¸ºäº†æ‹‰å–å­æ¨¡å—</span></span><br><span class="line">git <span class="built_in">clone</span> --recursive https://github.com/RedisBloom/RedisBloom.git</span><br><span class="line"><span class="built_in">cd</span> RedisBloom</span><br><span class="line"><span class="comment"># æ¨èåˆ‡æ¢åˆ°ç¨³å®šçš„releaseç‰ˆæœ¬</span></span><br><span class="line">git checkout v2.8.17</span><br><span class="line"><span class="comment"># æ›´æ–°å­æ¨¡å—ï¼Œéå¿…é¡»ï¼Œå¦‚æœä¸Šé¢ clone æ—¶æ²¡æœ‰åŠ ä¸Š --recursive ï¼Œè¿™ä¸ªæ­¥éª¤å°±ä¸èƒ½çœç•¥</span></span><br><span class="line">git submodule update --init --recursive</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥å¹¶å®‰è£…éœ€è¦çš„ä¾èµ–</span></span><br><span class="line">./sbin/setup</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line"><span class="comment"># readies version: 7fc8e62</span></span><br><span class="line">dnf install -q -y ca-certificates</span><br><span class="line">dnf install -q -y wget unzip</span><br><span class="line">/usr/local/soft/modules/RedisBloom/deps/readies/bin/enable-utf8</span><br><span class="line">dnf install -q -y git jq</span><br><span class="line">dnf install -q -y <span class="built_in">which</span></span><br><span class="line">/usr/local/soft/modules/RedisBloom/deps/readies/bin/getepel</span><br><span class="line">/usr/local/soft/modules/RedisBloom/deps/readies/bin/getgcc --modern</span><br><span class="line">dnf install -q -y valgrind</span><br><span class="line">/usr/local/soft/modules/RedisBloom/sbin/get-fbinfer</span><br><span class="line">dnf install -q -y lcov</span><br><span class="line">/usr/bin/python3 /usr/local/soft/modules/RedisBloom/deps/readies/bin/getrmpytools --reinstall --modern</span><br><span class="line">/usr/bin/python3 /usr/local/soft/modules/RedisBloom/deps/readies/bin/getcmake --usr</span><br><span class="line">/usr/bin/python3 -m pip install --disable-pip-version-check --user  -r tests/flow/requirements.txt</span><br><span class="line">/usr/local/soft/modules/RedisBloom/deps/readies/bin/getaws</span><br><span class="line">/usr/bin/python3 -m pip install --disable-pip-version-check --user  pudb</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘</span></span><br><span class="line">make</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">Building /usr/local/soft/modules/RedisBloom/bin/linux-x64-release/t-digest-c/src/libtdigest_static.a ...</span><br><span class="line"></span><br><span class="line">Generating /usr/local/soft/modules/RedisBloom/bin/linux-x64-release/t-digest-c/Makefile ...</span><br><span class="line">-- The C compiler identification is GNU 11.5.0</span><br><span class="line">-- The CXX compiler identification is GNU 11.5.0</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Check <span class="keyword">for</span> working C compiler: /usr/bin/gcc - skipped</span><br><span class="line">-- Detecting C compile features</span><br><span class="line">-- Detecting C compile features - <span class="keyword">done</span></span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /usr/bin/g++ - skipped</span><br><span class="line">-- Detecting CXX compile features</span><br><span class="line">-- Detecting CXX compile features - <span class="keyword">done</span></span><br><span class="line">-- Setting build <span class="built_in">type</span> to <span class="string">&#x27;Release&#x27;</span> as none was specified.</span><br><span class="line">-- Configuring <span class="keyword">done</span></span><br><span class="line">-- Generating <span class="keyword">done</span></span><br><span class="line">-- Build files have been written to: /usr/local/soft/modules/RedisBloom/bin/linux-x64-release/t-digest-c</span><br><span class="line"></span><br><span class="line">Building /usr/local/soft/modules/RedisBloom/bin/linux-x64-release/t-digest-c/libtdigest_static.a ...</span><br><span class="line">[ 50%] Building C object src/CMakeFiles/tdigest_static.dir/tdigest.c.o</span><br><span class="line">[100%] Linking C static library libtdigest_static.a</span><br><span class="line">[100%] Built target tdigest_static</span><br><span class="line">Compiling deps/bloom/bloom.c...</span><br><span class="line">Compiling deps/murmur2/MurmurHash2.c...</span><br><span class="line">Compiling deps/rmutil/util.c...</span><br><span class="line">Compiling src/rebloom.c...</span><br><span class="line">Compiling src/sb.c...</span><br><span class="line">Compiling src/cf.c...</span><br><span class="line">Compiling src/rm_topk.c...</span><br><span class="line">Compiling src/rm_tdigest.c...</span><br><span class="line">Compiling src/topk.c...</span><br><span class="line">Compiling src/rm_cms.c...</span><br><span class="line">Compiling src/cms.c...</span><br><span class="line">Linking /usr/local/soft/modules/RedisBloom/bin/linux-x64-release/redisbloom.so...</span><br></pre></td></tr></table></figure><div class="tips"><p><em><strong><code>./sbin/setup</code> æŠ¥é”™</strong></em></p><ul class="lvl-1"><li class="lvl-2">æœ¬äººä½¿ç”¨çš„æ˜¯ Amazon Linux 2023(å†…æ ¸ 6.1)ï¼Œå³ <code>EL9</code>ï¼Œç±»ä¼¼äºCentOS 9ï¼Œç¬¬ä¸€æ¬¡è¿è¡Œä¼šæŠ¥é”™ï¼Œå¤§è‡´æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">./sbin/setup</span><br><span class="line"><span class="comment">## é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">â€¦â€¦</span><br><span class="line">[FAILED] raven-release.el9.noarch.rpm: Status code: 403 <span class="keyword">for</span> https://dyn.su/el9/base/x86_64/raven-release.el9.noarch.rpm (IP: 104.21.57.14)</span><br><span class="line">Status code: 403 <span class="keyword">for</span> https://dyn.su/el9/base/x86_64/raven-release.el9.noarch.rpm (IP: 104.21.57.14)</span><br><span class="line"></span><br><span class="line">In /usr/local/soft/modules/RedisBloom/deps/readies/bin/getepel:</span><br><span class="line">346      <span class="comment"># xinstall --allowerasing https://dl.fedoraproject.org/pub/epel/epel-release-latest-$&#123;EPEL&#125;.noarch.rpm</span></span><br><span class="line">347      <span class="keyword">fi</span></span><br><span class="line">348</span><br><span class="line">349  &gt;&gt;&gt; install_raven</span><br><span class="line">350      install_remi</span><br><span class="line">351      <span class="comment"># install_centos_stream_repos</span></span><br><span class="line">352</span><br><span class="line"></span><br><span class="line"><span class="built_in">command</span> failed: /usr/local/soft/modules/RedisBloom/deps/readies/bin/getepel</span><br><span class="line"></span><br><span class="line">In /usr/local/soft/modules/RedisBloom/sbin/setup:</span><br><span class="line">16       python3 -m pip list</span><br><span class="line">17       <span class="keyword">fi</span></span><br><span class="line">18</span><br><span class="line">19   &gt;&gt;&gt; <span class="variable">$ROOT</span>/sbin/system-setup.py</span><br><span class="line">20       <span class="keyword">if</span> [[ <span class="variable">$VERBOSE</span> == 1 ]]; <span class="keyword">then</span></span><br><span class="line">21       python3 -m pip list</span><br><span class="line">22       <span class="keyword">fi</span> ç¼–è¯‘å®‰è£…æ—¶æŠ¥é”™</span><br><span class="line"></span><br><span class="line"><span class="comment">## é”™è¯¯åˆ†æä¸è§£å†³æ–¹æ³•</span></span><br><span class="line">é—®é¢˜åŸå› ï¼š</span><br><span class="line">    ä½ è¿™ä¸ªé”™è¯¯ä¸æ˜¯ RedisBloom æœ¬èº«çš„ç¼–è¯‘é—®é¢˜ï¼Œè€Œæ˜¯ ä¾èµ–ç¯å¢ƒåˆå§‹åŒ–ï¼ˆreadies / getepelï¼‰é˜¶æ®µå¤±è´¥ï¼Œå¤±è´¥ç‚¹éå¸¸æ˜ç¡®ã€‚</span><br><span class="line">readies/bin/getepel è„šæœ¬åœ¨ RHEL 9 / Rocky 9 / AlmaLinux 9 ç³»ç»Ÿä¸Šå°è¯•å®‰è£… Raven Repoï¼Œä½†è¯¥ä»“åº“åœ°å€ https://dyn.su/el9/... å·²è¢« 403 Forbidden æ‹’ç»ï¼Œå¯¼è‡´è„šæœ¬ç›´æ¥å¤±è´¥å¹¶ä¸­æ–­ setupã€‚</span><br><span class="line">    è¿™ä¸æ˜¯ä½ æœºå™¨çš„é—®é¢˜ï¼Œè€Œæ˜¯ RedisBloom ä¾èµ–å·¥å…·é“¾å¯¹ EL9 çš„å…¼å®¹æ€§æ»åã€‚</span><br><span class="line">    RedisBloom çš„ ./sbin/setup ä¼šè°ƒç”¨ deps/readies/bin/getepel</span><br><span class="line">    è¿™ä¸ªè„šæœ¬ç”¨äºï¼š</span><br><span class="line">        å®‰è£… EPEL</span><br><span class="line">        å®‰è£… Raven Repoï¼ˆEL9 ç‰¹æœ‰ï¼‰</span><br><span class="line">        å®‰è£… Remi Repo</span><br><span class="line">    ä½† Raven Repo ç›®å‰å·²ä¸ç¨³å®š / ä¸å†å…¬å¼€æä¾› rpm ä¸‹è½½ï¼Œè€Œ readies ä»£ç ä»ç„¶åœ¨å¼ºåˆ¶å®‰è£…ã€‚</span><br><span class="line">    ä½ çš„ç³»ç»Ÿæ˜¯ EL9 ç³»åˆ—ï¼Œæ—¥å¿—ä¸­æ˜ç¡®ï¼šraven-release.el9.noarch.rpm</span><br><span class="line">    è¯´æ˜ä½ ä½¿ç”¨çš„å¯èƒ½æ˜¯å¦‚ä¸‹ç³»ç»Ÿä¸­çš„ä¸€ä¸ªï¼š</span><br><span class="line">        RHEL 9</span><br><span class="line">        Rocky Linux 9</span><br><span class="line">        AlmaLinux 9</span><br><span class="line">        CentOS Stream 9</span><br><span class="line"></span><br><span class="line">æ¨èè§£å†³æ–¹æ¡ˆ:</span><br><span class="line">   Raven Repo å¹¶éæ˜¯ ReidsBloom çš„å¿…è¦ä¾èµ–ï¼Œæ‰€ä»¥ç›´æ¥ä¿®æ”¹ getepel è„šæœ¬ï¼Œç¦ç”¨ install_raven</span><br><span class="line">   vi deps/readies/bin/getepelï¼Œæ‰¾åˆ°æ‰€æœ‰ install_ravenï¼Œå¹¶å°†å…¶æ³¨é‡Šæ‰å³å¯</span><br></pre></td></tr></table></figure></div><h2 id="Redis-å¯ç”¨æ¨¡å—">Redis å¯ç”¨æ¨¡å—</h2><ul class="lvl-0"><li class="lvl-2"><p>å°†ç”Ÿæˆçš„ <code>redisbloom.so</code> æ‹·è´åˆ° redis çš„ modules ç›®å½•ä¸‹ï¼ˆéå¿…é¡»ï¼‰ï¼Œç›®å½•ä¸å­˜åœ¨åˆ™åˆ›å»º</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ³¨æ„ .so æ–‡ä»¶éœ€è¦å…·æœ‰å¯æ‰§è¡Œæƒé™</span></span><br><span class="line"><span class="built_in">cp</span> bin/linux-x64-release/redisbloom.so /usr/local/soft/redis-7.4.7/modules/redisbloom.so</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>Redis å¯ç”¨æ¨¡å—æœ‰ä¸‰ç§æ–¹æ³•</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.å°† redisbloom.so æ·»åŠ åˆ° redis.conf ä¸­ï¼Œéœ€è¦é‡å¯ redis</span></span><br><span class="line">loadmodule /usr/local/soft/redis-7.4.7/modules/redisbloom.so</span><br><span class="line"><span class="comment"># 2.ä¹Ÿå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼åŠ è½½æ¨¡å—</span></span><br><span class="line">redis-server --loadmodule /usr/local/soft/redis-7.4.7/modules/redisbloom.so</span><br><span class="line"><span class="comment"># 3.ä¸éœ€è¦é‡å¯redis</span></span><br><span class="line">redis-cli MODULE LOAD /usr/local/soft/redis-7.4.7/modules/redisbloom.so</span><br></pre></td></tr></table></figure><table><thead><tr><th>åŠ è½½æ–¹å¼</th><th>æ˜¯å¦æŒä¹…</th></tr></thead><tbody><tr><td><code>MODULE LOAD</code>ï¼ˆredis-cliï¼‰</td><td>âŒ ä»…å½“å‰è¿›ç¨‹</td></tr><tr><td>å‘½ä»¤è¡Œ <code>redis-server --loadmodule</code></td><td>âŒ ä»…æœ¬æ¬¡å¯åŠ¨</td></tr><tr><td><code>redis.conf</code> ä¸­ <code>loadmodule</code></td><td>âœ… <strong>æ°¸ä¹…ç”Ÿæ•ˆ</strong> ï¼ˆæ¨è/ç”Ÿäº§ï¼‰</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>æœ¬æ–‡é‡‡ç”¨ <code>loadmodule</code> åŠ è½½æ¨¡å—</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°† redisbloom.so æ·»åŠ åˆ° redis.conf ä¸­ï¼Œéœ€è¦é‡å¯ redis</span></span><br><span class="line">loadmodule /usr/local/soft/redis-7.4.7/modules/redisbloom.so</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨redis</span></span><br><span class="line">redis-server redis.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç™»å½•æµ‹è¯•</span></span><br><span class="line">redis-cli --user admin --pass 123456</span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ¨¡å—</span></span><br><span class="line">127.0.0.1:6379&gt; info Modules</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line"><span class="comment"># Modules</span></span><br><span class="line">module:name=bf,ver=20817,api=1,filters=0,usedby=[],using=[],options=[handle-io-errors]</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; MODULE LIST</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">1) 1) <span class="string">&quot;name&quot;</span></span><br><span class="line">   2) <span class="string">&quot;bf&quot;</span></span><br><span class="line">   3) <span class="string">&quot;ver&quot;</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 20817</span><br><span class="line">   5) <span class="string">&quot;path&quot;</span></span><br><span class="line">   6) <span class="string">&quot;/usr/local/soft/redis-7.4.7/modules/redisbloom.so&quot;</span></span><br><span class="line">   7) <span class="string">&quot;args&quot;</span></span><br><span class="line">   8) (empty array)</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡ä»‹ç» Redis æ‰©å±•æ¨¡å— â€“ RedisBloom çš„å®‰è£…æ–¹æ³•&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡åŸºäº&lt;code&gt;redis-7.4.7&lt;/code&gt;ï¼Œ&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æ“ä½œç³»ç»Ÿï¼š&lt;code&gt;Amazon Linux 2023(å†…æ ¸ 6.1)&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Rediså®˜ç½‘ï¼š&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis å‘½ä»¤æ–‡æ¡£ï¼š&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis å‘½ä»¤åŠæ•°æ®ç±»å‹ -- Stream</title>
    <link href="https://blog.hanqunfeng.com/2025/12/20/redis7-datatype-10-stream/"/>
    <id>https://blog.hanqunfeng.com/2025/12/20/redis7-datatype-10-stream/</id>
    <published>2025-12-20T05:40:05.000Z</published>
    <updated>2025-12-20T08:35:36.054Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2">æœ¬æ–‡ä»‹ç» Redis Stream æ•°æ®ç±»å‹</li><li class="lvl-2">æœ¬æ–‡åŸºäº<code>redis-7.4.7</code>ï¼Œ<code>springboot-3.5.8</code></li><li class="lvl-2">Rediså®˜ç½‘ï¼š<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis å‘½ä»¤æ–‡æ¡£ï¼š<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li></ul><span id="more"></span><h2 id="Stream-æ ¸å¿ƒè¯¦è§£">Stream æ ¸å¿ƒè¯¦è§£</h2><ul class="lvl-0"><li class="lvl-2"><p>Redis Stream æ˜¯ Redis 5.0 æ–°å¢çš„æœ‰åºã€å¯æŒä¹…åŒ–ã€æ”¯æŒå¤šæ’­çš„<code>æ¶ˆæ¯é˜Ÿåˆ—</code>ï¼Œåº•å±‚ç”¨<code>åŸºæ•°æ ‘+é“¾è¡¨</code>å®ç°ï¼Œå…¼é¡¾äº†é«˜æ•ˆæŸ¥è¯¢ä¸æœ‰åºå†™å…¥ï¼Œå®Œç¾è§£å†³äº† List é˜Ÿåˆ—ï¼ˆæ— æ³•å¤šæ’­ã€æ— æŒä¹…åŒ–ä¿éšœï¼‰ã€Pub/Subï¼ˆæ— æŒä¹…åŒ–ã€ä¸¢æ¶ˆæ¯ï¼‰çš„ç—›ç‚¹ï¼Œæ˜¯ç”Ÿäº§ç¯å¢ƒé¦–é€‰çš„ Redis æ¶ˆæ¯é˜Ÿåˆ—æ–¹æ¡ˆã€‚</p></li><li class="lvl-2"><p>å»ºè®®ç”Ÿäº§ç¯å¢ƒè¿˜æ˜¯ä½¿ç”¨ä¼ ç»Ÿçš„ MQ æ–¹æ¡ˆï¼Œå¦‚æœä»…æ˜¯å†…éƒ¨ç³»ç»Ÿä½¿ç”¨çš„è½»é‡MQï¼Œå·²ç»æœ‰äº†redisï¼Œä½†æ˜¯ä¸æƒ³å¼•å…¥å…¶å®ƒä¸­é—´ä»¶ï¼Œä¹Ÿå¯ä»¥å°è¯•ã€‚</p></li><li class="lvl-2"><p>Stream ä¸ä¼ ç»Ÿçš„MQ çš„å¯¹æ¯”</p></li></ul><table><thead><tr><th>å¯¹æ¯”ç»´åº¦</th><th>Redis Stream</th><th>RabbitMQ</th><th>Kafka</th></tr></thead><tbody><tr><td><strong>æ•°æ®æ¨¡å‹</strong></td><td>ç±»ä¼¼æ—¥å¿—çš„æœ‰åº KV æ¶ˆæ¯æµï¼ˆID â†’ field/valueï¼‰</td><td>é˜Ÿåˆ—ï¼ˆFIFOï¼‰</td><td>æ—¥å¿—åˆ†åŒºï¼ˆPartitioned Append-Only Logï¼‰</td></tr><tr><td><strong>æ¶ˆæ¯æŒä¹…åŒ–</strong></td><td>å¯é€‰æŒä¹…åŒ–ï¼ˆAOF / RDBï¼‰ï¼Œé»˜è®¤å†…å­˜ä¼˜å…ˆ</td><td>å¯æŒä¹…åŒ–åˆ°ç£ç›˜</td><td>æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œé¡ºåºå†™å…¥ï¼Œæ•ˆç‡é«˜</td></tr><tr><td><strong>æ¶ˆæ¯ç¡®è®¤</strong></td><td>XACK å¯¹å•æ¡æ¶ˆæ¯ç¡®è®¤ï¼Œæ”¯æŒ Pending æ¶ˆæ¯ç®¡ç†</td><td>ACK / NACK</td><td>Offset æ§åˆ¶ï¼ŒConsumer è‡ªè¡Œæäº¤</td></tr><tr><td><strong>æ¶ˆè´¹æ¨¡å¼</strong></td><td>æ”¯æŒ Consumer Groupï¼Œå¤šæ¶ˆè´¹è€…å…±äº« Pending æ¶ˆæ¯</td><td>Queue ç»‘å®š Consumerï¼Œå¤šæ¶ˆè´¹è€…æŠ¢å </td><td>Consumer Groupï¼Œå¤šæ¶ˆè´¹è€…å¹³è¡Œæ¶ˆè´¹</td></tr><tr><td><strong>é‡å¤æ¶ˆè´¹</strong></td><td>é»˜è®¤å¯èƒ½é‡å¤ï¼Œéœ€è¦åº”ç”¨ç«¯å¹‚ç­‰</td><td>å¯é€šè¿‡ ACK/NACK æ§åˆ¶</td><td>é»˜è®¤å¯èƒ½é‡å¤ï¼ŒConsumer éœ€å¹‚ç­‰å¤„ç†</td></tr><tr><td><strong>æ¶ˆæ¯é¡ºåº</strong></td><td>æŒ‰ Stream ID é¡ºåºï¼Œå¯ä¿è¯åˆ†ç»„å†…é¡ºåº</td><td>é˜Ÿåˆ—é¡ºåºä¿è¯</td><td>Partition å†…é¡ºåºä¿è¯</td></tr><tr><td><strong>æ¶ˆæ¯ä¿ç•™ç­–ç•¥</strong></td><td>å¯é…ç½® maxlen / minidï¼ŒæŒ‰æ—¶é—´æˆ–é•¿åº¦è£å‰ª</td><td>é˜Ÿåˆ—é•¿åº¦ / TTL æ§åˆ¶</td><td>åŸºäºæ—¶é—´æˆ–å¤§å°ä¿ç•™ï¼ˆRetention Policyï¼‰</td></tr><tr><td><strong>å»¶æ—¶/å®šæ—¶æ¶ˆè´¹</strong></td><td>åŸç”Ÿä¸æ”¯æŒå»¶æ—¶é˜Ÿåˆ—ï¼Œéœ€è¦åº”ç”¨ç«¯å¤„ç†</td><td>æ”¯æŒæ’ä»¶æˆ– TTL</td><td>åŸç”Ÿä¸æ”¯æŒï¼Œéœ€è¦åº”ç”¨ç«¯å¤„ç†æˆ– Kafka Streams</td></tr><tr><td><strong>äº‹åŠ¡ä¸åŸå­æ“ä½œ</strong></td><td>äº‹åŠ¡å¯ç”¨ MULTI/EXECï¼ŒXADD æ”¯æŒ NOMKSTREAM ç­‰é€‰é¡¹</td><td>åŸç”Ÿäº‹åŠ¡æ”¯æŒï¼ˆäº‹åŠ¡ / confirm æ¨¡å¼ï¼‰</td><td>ä¸æ”¯æŒäº‹åŠ¡ï¼Œä¾èµ–å¹‚ç­‰ç”Ÿäº§è€…</td></tr><tr><td><strong>æ€§èƒ½</strong></td><td>å†…å­˜çº§é«˜ååï¼ŒæŒä¹…åŒ–ä¼šæœ‰å¼€é”€</td><td>ä¸­ç­‰ï¼Œå—ç£ç›˜å’Œç½‘ç»œé™åˆ¶</td><td>é«˜ååï¼Œé¡ºåºå†™å…¥ç£ç›˜æ•ˆç‡æé«˜</td></tr><tr><td><strong>å…¸å‹ä½¿ç”¨åœºæ™¯</strong></td><td>äº‹ä»¶æ—¥å¿—ã€è½»é‡ MQã€å†…éƒ¨å¼‚æ­¥æµæ°´çº¿</td><td>ä¼ä¸šçº§æ¶ˆæ¯ã€ä»»åŠ¡è°ƒåº¦ã€RPC</td><td>å¤§æ•°æ®ç®¡é“ã€æ—¥å¿—æ”¶é›†ã€æµå¤„ç†</td></tr><tr><td><strong>å¤šè¯­è¨€æ”¯æŒ</strong></td><td>å®¢æˆ·ç«¯æ”¯æŒå¤šç§è¯­è¨€ï¼ˆJavaã€Pythonã€Go ç­‰ï¼‰</td><td>å®¢æˆ·ç«¯ä¸°å¯Œ</td><td>å®¢æˆ·ç«¯ä¸°å¯Œ</td></tr><tr><td><strong>æ˜“è¿ç»´æ€§</strong></td><td>å•èŠ‚ç‚¹å³å¯ä½¿ç”¨ï¼Œä½†æŒä¹…åŒ–éœ€å…³æ³¨å†…å­˜</td><td>é›†ç¾¤è¾ƒå¤æ‚ï¼Œéœ€è¦ RabbitMQ é›†ç¾¤</td><td>é›†ç¾¤å¤æ‚åº¦é«˜ï¼Œéœ€è¦ ZooKeeper æˆ– KRaft</td></tr></tbody></table><h3 id="åº•å±‚æ ¸å¿ƒå®ç°">åº•å±‚æ ¸å¿ƒå®ç°</h3><ol><li class="lvl-3"><p>å­˜å‚¨ç»“æ„ï¼šæ ¸å¿ƒæ˜¯åŸºæ•°æ ‘ï¼ˆRadix Treeï¼‰+ åŒå‘é“¾è¡¨ï¼ŒåŸºæ•°æ ‘å­˜ã€Œæ¶ˆæ¯IDâ†’æ¶ˆæ¯å†…å®¹ã€çš„æ˜ å°„ï¼ŒåŒå‘é“¾è¡¨æŒ‰æ¶ˆæ¯IDæœ‰åºä¸²è”æ‰€æœ‰æ¶ˆæ¯ï¼Œä¿è¯å†™å…¥å’ŒæŒ‰IDæŸ¥è¯¢çš„é«˜æ•ˆæ€§ï¼ˆO(logN)ï¼‰ã€‚</p></li><li class="lvl-3"><p>æ¶ˆæ¯IDï¼šé»˜è®¤è‡ªåŠ¨ç”Ÿæˆï¼Œæ ¼å¼ä¸ºæ—¶é—´æˆ³-åºåˆ—å·ï¼ˆå¦‚1734567890000-0ï¼‰ï¼Œæ—¶é—´æˆ³æ˜¯æ¯«ç§’çº§ï¼Œåºåˆ—å·è§£å†³åŒä¸€æ¯«ç§’å¤šæ¶ˆæ¯çš„æœ‰åºé—®é¢˜ï¼›ä¹Ÿæ”¯æŒæ‰‹åŠ¨æŒ‡å®šï¼Œéœ€æ»¡è¶³ä¸¥æ ¼é€’å¢ï¼Œå¦åˆ™å†™å…¥å¤±è´¥ã€‚</p></li><li class="lvl-3"><p>æŒä¹…åŒ–ï¼šå’Œ Redis å…¶ä»–æ•°æ®ç»“æ„ä¸€è‡´ï¼Œä¾èµ– RDB/AOF æŒä¹…åŒ–ï¼Œæ¶ˆæ¯å†™å…¥åä¼šè½ç›˜ï¼Œé‡å¯åä¸ä¸¢å¤±ï¼Œè¿™æ˜¯ Pub/Sub ä¸å…·å¤‡çš„æ ¸å¿ƒä¼˜åŠ¿ã€‚</p></li><li class="lvl-3"><p>æ ¸å¿ƒå…ƒæ•°æ®ï¼šæ¯ä¸ª Stream ä¼šç»´æŠ¤last-idï¼ˆæœ€æ–°æ¶ˆæ¯IDï¼‰ã€groupsï¼ˆæ¶ˆè´¹ç»„åˆ—è¡¨ï¼‰ã€entriesï¼ˆæ¶ˆæ¯å®ä½“ï¼‰ä¸‰ç±»å…ƒæ•°æ®ï¼Œæ¶ˆè´¹ç»„çš„å…ƒæ•°æ®ç‹¬ç«‹å­˜å‚¨ï¼Œäº’ä¸å¹²æ‰°ã€‚</p></li></ol><h2 id="Stream-æ ¸å¿ƒåŸºç¡€æ“ä½œï¼ˆå¿…ç”¨ï¼‰">Stream æ ¸å¿ƒåŸºç¡€æ“ä½œï¼ˆå¿…ç”¨ï¼‰</h2><h3 id="1-ç”Ÿäº§æ¶ˆæ¯ï¼ˆXADDï¼‰ï¼šå†™å…¥é˜Ÿåˆ—">1. ç”Ÿäº§æ¶ˆæ¯ï¼ˆXADDï¼‰ï¼šå†™å…¥é˜Ÿåˆ—</h3><p>â€¢ æ ¸å¿ƒå‘½ä»¤ï¼š<code>XADD key ID å­—æ®µ1 å€¼1 å­—æ®µ2 å€¼2 ...</code>ï¼ŒID å†™*è¡¨ç¤ºè‡ªåŠ¨ç”Ÿæˆï¼ˆç”Ÿäº§é¦–é€‰ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">XADD key</span><br><span class="line">     [NOMKSTREAM]</span><br><span class="line">     [MAXLEN | MINID [= | ~] threshold [LIMIT count]]</span><br><span class="line">     * | <span class="built_in">id</span></span><br><span class="line">     field value [field value ...]</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‚æ•°è§£é‡Š</span></span><br><span class="line"><span class="comment"># key: Stream åç§°</span></span><br><span class="line"><span class="comment"># NOMKSTREAM: ä¸è‡ªåŠ¨åˆ›å»º Streamï¼Œè‹¥ key ä¸å­˜åœ¨ â†’ å‘½ä»¤ç›´æ¥å¤±è´¥</span></span><br><span class="line"><span class="comment"># MAXLEN threshold â€”â€” æŒ‰é•¿åº¦è£å‰ª</span></span><br><span class="line"><span class="comment">#   MAXLEN 1000: Stream æœ€å¤šä¿ç•™ 1000 æ¡æ¶ˆæ¯ï¼Œè¶…å‡ºéƒ¨åˆ†ä¼šè¢«åˆ é™¤ï¼ˆä»æœ€æ—§å¼€å§‹ï¼‰</span></span><br><span class="line"><span class="comment">#   MAXLEN = 1000: ç²¾ç¡®è£å‰ªï¼Œä¸¥æ ¼ä¿è¯é•¿åº¦ â‰¤ 1000ï¼Œæ¯æ¬¡å†™å…¥éƒ½ä¼šæ£€æŸ¥å¹¶è£å‰ªï¼Œæ€§èƒ½å¼€é”€è¾ƒå¤§</span></span><br><span class="line"><span class="comment">#   MAXLEN ~ 1000ï¼ˆæ¨èï¼‰: è¿‘ä¼¼è£å‰ªï¼Œå…è®¸ Stream é•¿åº¦ ç•¥å¾®è¶…è¿‡é˜ˆå€¼ï¼ŒRedis åœ¨å†…éƒ¨æ‰¹é‡è£å‰ªï¼Œå†™å…¥æ€§èƒ½æ›´é«˜</span></span><br><span class="line"><span class="comment"># LIMIT count â€”â€” æ¯æ¬¡æœ€å¤šè£å‰ªå¤šå°‘æ¡</span></span><br><span class="line"><span class="comment">#   MAXLEN ~ 1000 LIMIT 100: å•æ¬¡å†™å…¥ æœ€å¤šåˆ é™¤ 100 æ¡æ—§æ¶ˆæ¯ï¼Œé˜²æ­¢ä¸€æ¬¡è£å‰ªé˜»å¡ Redis ä¸»çº¿ç¨‹</span></span><br><span class="line"><span class="comment"># MINID threshold â€”â€” æŒ‰ ID è£å‰ªï¼ˆRedis â‰¥ 6.2ï¼‰</span></span><br><span class="line"><span class="comment">#   MINID ~ 1670000000000-0: åˆ é™¤ ID å°äº threshold çš„æ¶ˆæ¯ï¼Œæ›´é€‚åˆ æ—¶é—´çª—å£å‹ä¿ç•™ç­–ç•¥</span></span><br><span class="line"><span class="comment"># * | id â€”â€” æ¶ˆæ¯ ID</span></span><br><span class="line"><span class="comment">#   *: è‡ªåŠ¨ç”Ÿæˆ IDï¼ˆ99% åœºæ™¯ï¼‰ï¼Œæ ¼å¼ï¼š&lt;æ¯«ç§’æ—¶é—´æˆ³&gt;-&lt;åºå·&gt;ï¼Œå•è°ƒé€’å¢ï¼Œå…¨å±€æœ‰åºï¼Œæ¶ˆè´¹è€…ç»„ä¾èµ–å®ƒè¿›è¡Œ offset ç®¡ç†</span></span><br><span class="line"><span class="comment">#   id: æŒ‡å®šIDï¼ˆä¸å¸¸ç”¨ï¼‰ï¼ŒID å¿…é¡»ä¸¥æ ¼å¤§äº Stream ä¸­æœ€å¤§ IDï¼Œå¦åˆ™å†™å…¥å¤±è´¥</span></span><br><span class="line"><span class="comment"># field value â€”â€” æ¶ˆæ¯ä½“ï¼ˆPayloadï¼‰</span></span><br><span class="line"><span class="comment">#   è‡³å°‘ä¸€å¯¹ field-valueï¼Œfield / value éƒ½æ˜¯ Binary Safeï¼Œæœ¬è´¨ç±»ä¼¼ Hashï¼Œä½†ä¸å¯ä¿®æ”¹</span></span><br></pre></td></tr></table></figure><p>â€¢ ç¤ºä¾‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å‘è®¢å•é˜Ÿåˆ—å†™å…¥1æ¡æ¶ˆæ¯ï¼Œè‡ªåŠ¨ç”Ÿæˆæ¶ˆæ¯ID</span></span><br><span class="line">XADD order_stream * uid 1001 order_no ORD20251220 price 299</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line"><span class="string">&quot;1766215406540-0&quot;</span> <span class="comment"># æ¶ˆæ¯ID</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿ç•™æŸä¸ªæ—¶é—´ç‚¹ä¹‹åçš„æ—¥å¿—</span></span><br><span class="line">XADD <span class="built_in">log</span> MINID ~ 1689900000000-0 * level INFO msg <span class="string">&quot;startup&quot;</span></span><br></pre></td></tr></table></figure><h3 id="2-æ¶ˆè´¹æ¶ˆæ¯ï¼ˆ2ç§æ ¸å¿ƒæ¨¡å¼ï¼‰">2. æ¶ˆè´¹æ¶ˆæ¯ï¼ˆ2ç§æ ¸å¿ƒæ¨¡å¼ï¼‰</h3><h4 id="ï¼ˆ1ï¼‰-ç‹¬ç«‹æ¶ˆè´¹ï¼ˆæ— æ¶ˆè´¹ç»„ï¼‰ï¼šä¸€å¯¹ä¸€æ¶ˆè´¹ï¼Œé€‚åˆç®€å•åœºæ™¯">ï¼ˆ1ï¼‰ ç‹¬ç«‹æ¶ˆè´¹ï¼ˆæ— æ¶ˆè´¹ç»„ï¼‰ï¼šä¸€å¯¹ä¸€æ¶ˆè´¹ï¼Œé€‚åˆç®€å•åœºæ™¯</h4><p>â€¢ XREADï¼šä¸»åŠ¨æ‹‰å–æ¶ˆæ¯ï¼Œæ”¯æŒé˜»å¡/éé˜»å¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">XREAD</span><br><span class="line">  [COUNT count]</span><br><span class="line">  [BLOCK milliseconds]</span><br><span class="line">  STREAMS key [key ...]</span><br><span class="line">          <span class="built_in">id</span>  [<span class="built_in">id</span>  ...]</span><br><span class="line"><span class="comment"># å‚æ•°è§£é‡Š</span></span><br><span class="line"><span class="comment"># COUNT count â€”â€” å•æ¬¡æœ€å¤šè¯»å–å¤šå°‘æ¡ï¼Œæ˜¯â€œä¸Šé™â€ï¼Œä¸æ˜¯ä¿è¯å€¼</span></span><br><span class="line"><span class="comment"># BLOCK milliseconds â€”â€” é˜»å¡ç­‰å¾…æ–°æ¶ˆæ¯ï¼Œé˜»å¡æœŸé—´ ä¸ä¼šå ç”¨ CPUï¼Œè¶…æ—¶è¿”å› nil</span></span><br><span class="line"><span class="comment">#   BLOCK 0: æ— é™é˜»å¡ï¼Œç›´åˆ°æœ‰æ–°æ¶ˆæ¯</span></span><br><span class="line"><span class="comment"># STREAMS key [key ...] â€”â€” æŒ‡å®šè¯»å–çš„ Streamï¼Œkey ä¸ id ä¸€ä¸€å¯¹åº”</span></span><br><span class="line"><span class="comment"># id [id ...] â€”â€” ä»å“ªä¸ªä½ç½®å¼€å§‹è¯»ï¼Œè¯»å– ID å¤§äºè¯¥å€¼çš„æ¶ˆæ¯ï¼Œä¸åŒ…å« è¯¥ ID æœ¬èº«</span></span><br><span class="line"><span class="comment">#   æ™®é€š IDï¼ˆæ¸¸æ ‡è¯­ä¹‰ï¼‰: XREAD STREAMS mystream 1689999999999-0</span></span><br><span class="line"><span class="comment">#   $: åªå…³å¿ƒâ€œå°†æ¥â€çš„æ¶ˆæ¯ï¼Œä» å½“å‰ Stream çš„æœ«å°¾ä¹‹å å¼€å§‹è¯»ï¼Œå†å²æ¶ˆæ¯å…¨éƒ¨å¿½ç•¥: XREAD BLOCK 0 STREAMS mystream $</span></span><br></pre></td></tr></table></figure><p>â€¢ ç¤ºä¾‹1ï¼ˆéé˜»å¡ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»å¼€å¤´æ‹‰5æ¡æ¶ˆæ¯</span></span><br><span class="line">XREAD COUNT 5 STREAMS order_stream 0-0</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">1) 1) <span class="string">&quot;order_stream&quot;</span>          <span class="comment"># Streamåç§°</span></span><br><span class="line">   2) 1) 1) <span class="string">&quot;1766215406540-0&quot;</span> <span class="comment"># æ¶ˆæ¯ID</span></span><br><span class="line">         2) 1) <span class="string">&quot;uid&quot;</span>          <span class="comment"># æ¶ˆæ¯ä½“ é”®å€¼å¯¹</span></span><br><span class="line">            2) <span class="string">&quot;1001&quot;</span></span><br><span class="line">            3) <span class="string">&quot;order_no&quot;</span></span><br><span class="line">            4) <span class="string">&quot;ORD20251220&quot;</span></span><br><span class="line">            5) <span class="string">&quot;price&quot;</span></span><br><span class="line">            6) <span class="string">&quot;299&quot;</span></span><br></pre></td></tr></table></figure><p>â€¢ ç¤ºä¾‹2ï¼ˆé˜»å¡ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># $è¡¨ç¤ºä»æœ€æ–°æ¶ˆæ¯å¼€å§‹æ‹‰ï¼Œé˜»å¡3ç§’ï¼Œæœ‰æ–°æ¶ˆæ¯ç«‹å³è¿”å›ï¼Œæ— åˆ™3ç§’åè¶…æ—¶ï¼Œæ˜¯ç”Ÿäº§å¸¸ç”¨å†™æ³•ã€‚</span></span><br><span class="line">XREAD COUNT 5 BLOCK 3000 STREAMS order_stream $</span><br></pre></td></tr></table></figure><h4 id="ï¼ˆ2ï¼‰-æ¶ˆè´¹ç»„æ¶ˆè´¹ï¼ˆXGROUPï¼‰ï¼šä¸€å¯¹å¤šæ¶ˆè´¹ï¼Œæ ¸å¿ƒç”Ÿäº§æ¨¡å¼">ï¼ˆ2ï¼‰ æ¶ˆè´¹ç»„æ¶ˆè´¹ï¼ˆXGROUPï¼‰ï¼šä¸€å¯¹å¤šæ¶ˆè´¹ï¼Œæ ¸å¿ƒç”Ÿäº§æ¨¡å¼</h4><ul class="lvl-0"><li class="lvl-2"><p>Stream æœ€æ ¸å¿ƒçš„ä»·å€¼å°±æ˜¯æ¶ˆè´¹ç»„ï¼Œæ”¯æŒå¤šæ¶ˆè´¹è€…ååŒæ¶ˆè´¹ã€æ¶ˆæ¯ç¡®è®¤ã€æœªæ¶ˆè´¹æ¶ˆæ¯è¿½æº¯ï¼Œè§£å†³äº†åˆ†å¸ƒå¼åœºæ™¯ä¸‹çš„æ¶ˆæ¯åˆ†ç‰‡ä¸è´Ÿè½½å‡è¡¡é—®é¢˜ã€‚</p></li><li class="lvl-2"><ol><li class="lvl-5">å…ˆåˆ›å»ºæ¶ˆè´¹ç»„<code>XGROUP CREATE</code></li></ol></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">XGROUP CREATE key group <span class="built_in">id</span>|$</span><br><span class="line">       [MKSTREAM]</span><br><span class="line">       [ENTRIESREAD entries-read]</span><br><span class="line"><span class="comment"># å‚æ•°è§£é‡Š</span></span><br><span class="line"><span class="comment"># keyï¼šStream åç§°ï¼Œä¸ºæŒ‡å®šçš„Streamåˆ›å»ºæ¶ˆè´¹ç»„</span></span><br><span class="line"><span class="comment"># group: æ¶ˆè´¹ç»„åç§°ï¼Œæ¶ˆè´¹è€…ç»„çš„å”¯ä¸€æ ‡è¯†ï¼Œä¸€ä¸ª Stream å¯ä»¥æœ‰ å¤šä¸ª consumer group</span></span><br><span class="line"><span class="comment"># id | $ â€”â€” å…³é”®å‚æ•°ï¼šæ¶ˆè´¹èµ·å§‹ä½ç‚¹ï¼ˆoffsetï¼‰ï¼Œ$è¡¨ç¤ºä»å½“å‰æœ€æ–°æ¶ˆæ¯å¼€å§‹æ¶ˆè´¹ï¼Œç”¨0-0è¡¨ç¤ºä»é˜Ÿåˆ—å¼€å¤´æ¶ˆè´¹ã€‚</span></span><br><span class="line"><span class="comment"># [MKSTREAM] â€”â€” è‡ªåŠ¨åˆ›å»º Streamï¼Œå¦‚æœæŒ‡å®šçš„keyä¸å­˜åœ¨åˆ™è‡ªåŠ¨åˆ›å»ºï¼Œæ¨èåœ¨è‡ªåŠ¨åŒ–éƒ¨ç½²ä¸­ä½¿ç”¨</span></span><br><span class="line"><span class="comment"># [ENTRIESREAD entries-read] â€”â€” è®¾ç½®â€œå·²è¯»å–æ¡æ•°â€ï¼ˆé«˜çº§å‚æ•°ï¼‰ï¼Œä¸€èˆ¬ä¸šåŠ¡ä¸éœ€è¦ä½¿ç”¨ï¼Œä¸»è¦ç”¨äºæ‰‹åŠ¨æ¢å¤groupã€æ•°æ®è¿ç§»ç­‰åœºæ™¯</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹ï¼šåˆ›å»ºgroup1æ¶ˆè´¹ç»„ï¼Œä»æœ€æ–°è®¢å•æ¶ˆæ¯å¼€å§‹æ¶ˆè´¹</span></span><br><span class="line">XGROUP CREATE order_stream group1 $ MKSTREAM</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">OK</span><br></pre></td></tr></table></figure><ol start="2"><li class="lvl-3"><p>æ¶ˆè´¹è€…æ‹‰å–æ¶ˆæ¯<code>XREADGROUP</code></p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">XREADGROUP GROUP group consumer</span><br><span class="line">           [COUNT count]</span><br><span class="line">           [BLOCK milliseconds]</span><br><span class="line">           [NOACK]</span><br><span class="line">           STREAMS key [key ...]</span><br><span class="line">                   <span class="built_in">id</span>  [<span class="built_in">id</span>  ...]</span><br><span class="line"><span class="comment"># å‚æ•°è§£é‡Š</span></span><br><span class="line"><span class="comment"># GROUP group consumer: æŒ‡å®šæ¶ˆè´¹è€…ç»„åï¼šgroupï¼Œæ¶ˆè´¹è€…åï¼šconsumer</span></span><br><span class="line"><span class="comment">#    åŒä¸€ä¸ª group ä¸‹ï¼Œä¸åŒ consumer ä¸ä¼šæ”¶åˆ°é‡å¤æ¶ˆæ¯</span></span><br><span class="line"><span class="comment"># [COUNT count] â€”â€” å•æ¬¡æœ€å¤šè¿”å›æ¡æ•°ï¼Œæ˜¯è½¯é™åˆ¶ï¼Œä¸æ˜¯ä¸¥æ ¼ä¿è¯</span></span><br><span class="line"><span class="comment"># [BLOCK milliseconds] â€”â€” é˜»å¡ç­‰å¾…æ–°æ¶ˆæ¯ï¼Œæœ€å¤šé˜»å¡ milliseconds æ¯«ç§’</span></span><br><span class="line"><span class="comment">#    BLOCK 0 â†’ æ°¸ä¹…é˜»å¡</span></span><br><span class="line"><span class="comment"># [NOACK] â€”â€” ä¸è¿›å…¥ Pendingï¼ˆâš ï¸ è°¨æ…ï¼‰</span></span><br><span class="line"><span class="comment">#    æ¶ˆæ¯ ä¸ä¼šè¿›å…¥ Pendingï¼Œä¸éœ€è¦ XACKï¼Œæ¶ˆè´¹åå³è®¤ä¸ºå®Œæˆ</span></span><br><span class="line"><span class="comment">#    é£é™©ï¼šæ¶ˆè´¹è€…å´©æºƒ â†’ æ¶ˆæ¯ç›´æ¥ä¸¢å¤±ï¼Œä¸å¯é‡æŠ•é€’</span></span><br><span class="line"><span class="comment"># STREAMS key [key ...]: æŒ‡å®šè¦è¯»å–çš„ Streamï¼ˆæ”¯æŒå¤šä¸ªï¼‰ï¼Œkey é¡ºåºéœ€ä¸åç»­ id é¡ºåºä¸€è‡´</span></span><br><span class="line"><span class="comment"># id [id ...] â€”â€” å†³å®šâ€œè¯»ä»€ä¹ˆâ€çš„å…³é”®</span></span><br><span class="line"><span class="comment">#    ä½¿ç”¨ &gt; â€”â€” è¯»å–â€œæ–°æ¶ˆæ¯â€ï¼ˆâœ… ç”Ÿäº§ç¯å¢ƒ 99% ä½¿ç”¨è¿™ç§æ–¹å¼ï¼‰ï¼Œä»æœªæŠ•é€’ç»™ä»»ä½• consumer çš„æ–°æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">#    ä½¿ç”¨ 0/å…·ä½“ID â€”â€” é‡è¯» Pendingï¼ˆè¡¥å¿ï¼‰ï¼Œè¯»å– å·²æŠ•é€’ä½†æœª ACK çš„æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">#    å¤š Stream åœºæ™¯: STREAMS stream1 stream2 &gt; &gt;ï¼Œæ¯ä¸ª stream å¿…é¡»æœ‰ä¸€ä¸ªå¯¹åº” id</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹ï¼šconsumerA ä»group1æ‹‰3æ¡æœªè¢«æ¶ˆè´¹çš„æ¶ˆæ¯ï¼Œé˜»å¡5ç§’ã€‚</span></span><br><span class="line">XREADGROUP GROUP group1 consumerA COUNT 3 BLOCK 5000 STREAMS order_stream &gt;</span><br><span class="line"><span class="comment">## æ­¤æ—¶åœ¨5ç§’å†…åˆ›å»ºæ–°çš„æ¶ˆæ¯ï¼Œå°±ä¼šæœ‰ç±»ä¼¼å¦‚ä¸‹è¾“å‡º</span></span><br><span class="line">1) 1) <span class="string">&quot;order_stream&quot;</span></span><br><span class="line">   2) 1) 1) <span class="string">&quot;1766215642763-0&quot;</span></span><br><span class="line">         2) 1) <span class="string">&quot;uid&quot;</span></span><br><span class="line">            2) <span class="string">&quot;1001&quot;</span></span><br><span class="line">            3) <span class="string">&quot;order_no&quot;</span></span><br><span class="line">            4) <span class="string">&quot;ORD20251220&quot;</span></span><br><span class="line">            5) <span class="string">&quot;price&quot;</span></span><br><span class="line">            6) <span class="string">&quot;299&quot;</span></span><br><span class="line">(1.50s)</span><br></pre></td></tr></table></figure><h3 id="3-æ¶ˆæ¯ç¡®è®¤ï¼ˆXACKï¼‰">3. æ¶ˆæ¯ç¡®è®¤ï¼ˆXACKï¼‰</h3><ul class="lvl-0"><li class="lvl-2"><p>æ¶ˆè´¹å®Œæˆåå¿…é¡»ç¡®è®¤ï¼Œå¦åˆ™ä¼šè¢«æ ‡è®°ä¸ºã€Œæœªç¡®è®¤æ¶ˆæ¯ã€</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># XACK key æ¶ˆè´¹ç»„å æ¶ˆæ¯ID1 æ¶ˆæ¯ID2 ...ã€‚</span></span><br><span class="line">XACK key group <span class="built_in">id</span> [<span class="built_in">id</span> ...]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹: ç¡®è®¤2æ¡æ¶ˆæ¯æ¶ˆè´¹å®Œæˆï¼ŒStream ä¼šåˆ é™¤è¯¥æ¶ˆæ¯çš„æœªç¡®è®¤æ ‡è®°</span></span><br><span class="line">XACK order_stream group1 1734567890000-0 1734567890001-0</span><br></pre></td></tr></table></figure><h3 id="4-æ¶ˆæ¯é‡è¯•">4. æ¶ˆæ¯é‡è¯•</h3><ul class="lvl-0"><li class="lvl-2"><p>æœªç¡®è®¤çš„æ¶ˆæ¯ï¼Œä¼šè¢«å­˜å…¥æ¶ˆè´¹ç»„çš„<code>ã€ŒPELï¼ˆPending Entries Listï¼‰ã€</code>ï¼Œå¯é€šè¿‡<code>XPENDING key æ¶ˆè´¹ç»„å</code>æŸ¥çœ‹ï¼Œæ”¯æŒ<code>XCLAIM</code>å°†<code>PEL</code>ä¸­çš„æ¶ˆæ¯è½¬ç§»ç»™å…¶ä»–æ¶ˆè´¹è€…å¤„ç†ï¼Œé¿å…å•ç‚¹æ•…éšœå¯¼è‡´æ¶ˆæ¯å †ç§¯ã€‚</p></li><li class="lvl-2"><p>XPENDINGï¼šæŸ¥çœ‹æœªè¢«ç¡®è®¤çš„æ¶ˆæ¯æƒ…å†µ</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">XPENDING key group</span><br><span class="line">        [[IDLE min-idle-time]</span><br><span class="line">         start end count</span><br><span class="line">         [consumer]]</span><br><span class="line"><span class="comment"># å‚æ•°è§£é‡Š</span></span><br><span class="line"><span class="comment"># key: Stream åç§°ï¼Œå¿…é¡»å­˜åœ¨</span></span><br><span class="line"><span class="comment"># group: æ¶ˆè´¹è€…ç»„åç§°ï¼Œå¿…é¡»å­˜åœ¨</span></span><br><span class="line"><span class="comment"># [IDLE min-idle-time]ï¼ˆRedis â‰¥ 6.2ï¼‰: ä»…è¿”å› ç©ºé—²æ—¶é—´ â‰¥ min-idle-timeï¼ˆæ¯«ç§’ï¼‰ çš„ Pending æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">#    min-idle-time(ç©ºé—²æ—¶é—´) = ä»ä¸Šæ¬¡æŠ•é€’ / claimåˆ°ç°åœ¨</span></span><br><span class="line"><span class="comment"># start end â€”â€” ID èŒƒå›´</span></span><br><span class="line"><span class="comment">#    -: æœ€å°ID</span></span><br><span class="line"><span class="comment">#    +: æœ€å¤§ID</span></span><br><span class="line"><span class="comment"># count â€”â€” è¿”å›æ¡æ•°ä¸Šé™</span></span><br><span class="line"><span class="comment"># [consumer]ï¼ˆå¯é€‰ï¼‰: åªæŸ¥çœ‹æŸä¸€ä¸ª consumer çš„ Pendingï¼Œä¸æŒ‡å®šåˆ™æŸ¥çœ‹ group å†…å…¨éƒ¨</span></span><br><span class="line"><span class="comment"># åªè¿”å› å…ƒæ•°æ®ï¼Œä¸è¿”å›æ¶ˆæ¯å†…å®¹</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹1: æŸ¥çœ‹æ˜¯å¦æœ‰æ¶ˆæ¯ç§¯å‹</span></span><br><span class="line">XPENDING order_stream group1</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 1      <span class="comment"># ç§¯å‹æ¶ˆæ¯æ•°ï¼Œæœªç¡®è®¤æ¶ˆæ¯æ•°é‡</span></span><br><span class="line">2) <span class="string">&quot;1766215642763-0&quot;</span> <span class="comment"># Pending ä¸­æœ€å° ID</span></span><br><span class="line">3) <span class="string">&quot;1766215642763-0&quot;</span> <span class="comment"># Pending ä¸­æœ€å¤§ ID</span></span><br><span class="line">4) 1) 1) <span class="string">&quot;consumerA&quot;</span> <span class="comment"># æŒ‰ consumer ç»Ÿè®¡çš„ Pending æ•°é‡</span></span><br><span class="line">      2) <span class="string">&quot;1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹2: æŸ¥æ‰¾ idle è¶…è¿‡ 1 åˆ†é’Ÿçš„æ¶ˆæ¯ï¼Œæœ€å¤šè¿”å›10æ¡</span></span><br><span class="line">XPENDING order_stream group1 IDLE 60000 - + 10</span><br><span class="line"><span class="comment">## è¾“å‡º</span></span><br><span class="line">1) 1) <span class="string">&quot;1766215642763-0&quot;</span> <span class="comment"># æ¶ˆæ¯ ID</span></span><br><span class="line">   2) <span class="string">&quot;consumerA&quot;</span>       <span class="comment"># å½“å‰æŒæœ‰è¯¥æ¶ˆæ¯çš„ consumer</span></span><br><span class="line">   3) (<span class="built_in">integer</span>) 255581  <span class="comment"># idle æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span></span><br><span class="line">   4) (<span class="built_in">integer</span>) 2       <span class="comment"># delivery countï¼ˆæŠ•é€’æ¬¡æ•°ï¼‰,è¯¥æ¶ˆæ¯è‡³å°‘è¢«æŠ•é€’è¿‡ 2 æ¬¡</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹3: åªæŸ¥çœ‹ consumerA çš„ Pendingï¼Œæœ€å¤šè¿”å›20æ¡</span></span><br><span class="line">XPENDING order_stream group1 - + 20 consumerA</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>XCLAIM: è½¬ç§»æŠ•é€’</p></li></ul><blockquote><p>å°†å·²ç»æŠ•é€’ä½†æœª ACKã€ä¸” idle è¶…è¿‡é˜ˆå€¼çš„ Pending æ¶ˆæ¯ï¼Œä»åŸ consumer æ‰‹ä¸­â€œæŠ¢å â€ç»™æ–°çš„ consumerï¼Œå¹¶é‡æ–°æŠ•é€’ã€‚<br>ä¸€æ—¦æŠ¢å æˆåŠŸï¼ŒåŸ consumer å°±ä¸åœ¨æ‹¥æœ‰è¯¥æ¶ˆæ¯çš„ Pending è®°å½•</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">XCLAIM key group consumer min-idle-time <span class="built_in">id</span> [<span class="built_in">id</span> ...]</span><br><span class="line">       [IDLE ms]</span><br><span class="line">       [TIME unix-time-milliseconds]</span><br><span class="line">       [RETRYCOUNT count]</span><br><span class="line">       [FORCE]</span><br><span class="line">       [JUSTID]</span><br><span class="line">       [LASTID lastid]</span><br><span class="line"><span class="comment"># å‚æ•°è§£é‡Š</span></span><br><span class="line"><span class="comment"># key: Stream Keyï¼Œå¿…é¡»å­˜åœ¨</span></span><br><span class="line"><span class="comment"># group: æ¶ˆè´¹è€…ç»„åç§°ï¼Œå¿…é¡»å­˜åœ¨</span></span><br><span class="line"><span class="comment"># consumer: æ–°çš„æ¶ˆè´¹è€…ï¼ŒæŠ¢å åçš„ Pending æ¶ˆæ¯å°†å½’å±è¯¥ consumer</span></span><br><span class="line"><span class="comment"># min-idle-time: ç©ºé—²æ—¶é—´ï¼Œåªæœ‰ idle â‰¥ min-idle-time çš„ Pending æ¶ˆæ¯æ‰å…è®¸è¢« claim</span></span><br><span class="line"><span class="comment"># id [id ...]: æŒ‡å®šè¦ claim çš„æ¶ˆæ¯ IDï¼ŒIDå¿…é¡»å­˜åœ¨</span></span><br><span class="line"><span class="comment"># [IDLE ms]: äººä¸ºè®¾ç½® idle æ—¶é—´ï¼Œè¦†ç›– Redis å†…éƒ¨è®¡ç®—çš„ idleï¼Œæ¯”å¦‚å¼ºåˆ¶åˆ¶é€ â€œå·²è¶…æ—¶â€çŠ¶æ€</span></span><br><span class="line"><span class="comment"># [TIME unix-time-milliseconds]: æ‰‹åŠ¨æŒ‡å®šâ€œæœ€åæŠ•é€’æ—¶é—´â€ï¼Œä¸ IDLE äºŒé€‰ä¸€ä½¿ç”¨ï¼Œæå°‘è§äºä¸šåŠ¡ä»£ç </span></span><br><span class="line"><span class="comment"># [RETRYCOUNT count]: æ‰‹åŠ¨è®¾ç½® delivery countï¼Œå®ç°â€œæœ€å¤šé‡è¯• N æ¬¡ï¼Œè¶…è¿‡è¿›æ­»ä¿¡é˜Ÿåˆ—â€</span></span><br><span class="line"><span class="comment"># [FORCE]: å¼ºåˆ¶ claim ä¸å­˜åœ¨äº Pending çš„æ¶ˆæ¯ï¼Œâš ï¸ é«˜é£é™©</span></span><br><span class="line"><span class="comment"># [JUSTID]: åªè¿”å› æ¶ˆæ¯ IDï¼Œä¸è¿”å›æ¶ˆæ¯ä½“ï¼ˆfield/valueï¼‰ï¼Œå‡å°‘ç½‘ç»œå¼€é”€</span></span><br><span class="line"><span class="comment"># [LASTID lastid]ï¼ˆRedis â‰¥ 7.0ï¼‰: æ›´æ–° consumer group çš„ last-delivered-idï¼Œå½±å“åç»­ XREADGROUP &gt; çš„è¡Œä¸º</span></span><br><span class="line"><span class="comment">#    âš ï¸ é«˜çº§ç‰¹æ€§ï¼Œä¸€èˆ¬ä¸å»ºè®®ä¸šåŠ¡ä»£ç ä½¿ç”¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¤ºä¾‹ï¼š</span></span><br><span class="line"><span class="comment"># 1ï¸âƒ£ æŠ¢å  idle è¶…è¿‡ 60s çš„æ¶ˆæ¯</span></span><br><span class="line">XCLAIM order_stream group1 consumerB 60000 1766215642763-0</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">1) 1) <span class="string">&quot;1766215642763-0&quot;</span></span><br><span class="line">   2) 1) <span class="string">&quot;uid&quot;</span></span><br><span class="line">      2) <span class="string">&quot;1001&quot;</span></span><br><span class="line">      3) <span class="string">&quot;order_no&quot;</span></span><br><span class="line">      4) <span class="string">&quot;ORD20251220&quot;</span></span><br><span class="line">      5) <span class="string">&quot;price&quot;</span></span><br><span class="line">      6) <span class="string">&quot;299&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2ï¸âƒ£ æŠ¢å å¹¶æ ‡è®°ä¸ºç¬¬ 3 æ¬¡é‡è¯•</span></span><br><span class="line">XCLAIM orders order-group consumerB 60000 1766215642763-0 RETRYCOUNT 3</span><br><span class="line"><span class="comment"># 3ï¸âƒ£ åªè¿”å› IDï¼ˆé…åˆæ‰¹å¤„ç†ï¼‰</span></span><br><span class="line">XCLAIM orders order-group consumerB 60000 1766215642763-0 JUSTID</span><br></pre></td></tr></table></figure><h2 id="é«˜çº§ç‰¹æ€§ï¼ˆç”Ÿäº§å¿…å¤‡ï¼‰">é«˜çº§ç‰¹æ€§ï¼ˆç”Ÿäº§å¿…å¤‡ï¼‰</h2><ol><li class="lvl-3"><p>æ¶ˆæ¯å›æº¯ä¸éå†</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># XRANGE key èµ·å§‹ID ç»“æŸID [COUNT æ¡æ•°]ï¼ˆæ­£å‘éå†ï¼‰</span></span><br><span class="line">XRANGE key start end [COUNT count]</span><br><span class="line"><span class="comment"># XREVRANGE key ç»“æŸID èµ·å§‹ID [COUNT æ¡æ•°]ï¼ˆåå‘éå†ï¼‰</span></span><br><span class="line">XREVRANGE key end start [COUNT count]</span><br><span class="line"><span class="comment"># ç¤ºä¾‹: 0-0:æœ€å°çš„æ¶ˆæ¯IDï¼Œç­‰åŒäº -ï¼Œ+:è¡¨ç¤ºæœ€æ–°æ¶ˆæ¯ï¼Œé€‚åˆæ•°æ®å¯¹è´¦ã€å†å²æ¶ˆæ¯æŸ¥è¯¢ã€‚</span></span><br><span class="line">XRANGE order_stream 0-0 + COUNT 10</span><br><span class="line">XRANGE order_stream - + COUNT 10</span><br></pre></td></tr></table></figure><ol start="2"><li class="lvl-3"><p>é˜Ÿåˆ—ä¿¡æ¯æŸ¥è¯¢</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥æ¶ˆæ¯æ€»æ•°</span></span><br><span class="line">XLEN key</span><br><span class="line"><span class="comment"># æŸ¥Streamå®Œæ•´å…ƒæ•°æ®ï¼ˆæœ€æ–°IDã€æ¶ˆè´¹ç»„æ•°é‡ã€æ¶ˆæ¯æ€»æ•°ç­‰ï¼‰</span></span><br><span class="line"></span><br><span class="line">XINFO STREAM key [FULL [COUNT count]]</span><br><span class="line"><span class="comment">## FULL: å®Œæ•´æ¨¡å¼</span></span><br><span class="line">    <span class="comment"># ğŸ‘‰ è¿”å›ï¼š</span></span><br><span class="line">    <span class="comment">#     Stream å…ƒä¿¡æ¯</span></span><br><span class="line">    <span class="comment">#     æ‰€æœ‰ Consumer Group</span></span><br><span class="line">    <span class="comment">#     æ¯ä¸ª Group çš„ Consumer</span></span><br><span class="line">    <span class="comment">#     Pending Entries Listï¼ˆPELï¼‰</span></span><br><span class="line">    <span class="comment">#     éƒ¨åˆ†å†å² entries</span></span><br><span class="line">    <span class="comment"># âš ï¸ å¼€é”€å¾ˆå¤§ï¼Œæ…ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚</span></span><br><span class="line"><span class="comment">## COUNT countï¼ˆFULL æ¨¡å¼çš„é™åˆ¶å‚æ•°ï¼‰</span></span><br><span class="line">    <span class="comment">#   XINFO STREAM key FULL COUNT 10: é™åˆ¶è¿”å›çš„entries æ•°é‡ä»¥åŠæ¯ä¸ª group / consumer çš„ PEL è®°å½•æ•°é‡</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥æ‰€æœ‰æ¶ˆè´¹ç»„ä¿¡æ¯</span></span><br><span class="line">XINFO GROUPS key</span><br><span class="line"><span class="comment"># æŸ¥è¯¥ç»„ä¸‹æ‰€æœ‰æ¶ˆè´¹è€…</span></span><br><span class="line">XINFO CONSUMERS key æ¶ˆè´¹ç»„å</span><br></pre></td></tr></table></figure><ol start="3"><li class="lvl-3"><p>æ¶ˆè´¹ç»„ç®¡ç†</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ é™¤æ¶ˆè´¹ç»„</span></span><br><span class="line">XGROUP DESTROY key æ¶ˆè´¹ç»„å</span><br><span class="line"><span class="comment"># åˆ é™¤æ¶ˆè´¹è€…</span></span><br><span class="line">XGROUP DELCONSUMER key æ¶ˆè´¹ç»„å æ¶ˆè´¹è€…å</span><br><span class="line"><span class="comment"># é‡ç½®æ¶ˆè´¹ç»„èµ·å§‹ID</span></span><br><span class="line">XGROUP SETID key æ¶ˆè´¹ç»„å æ–°ID</span><br></pre></td></tr></table></figure><ol start="4"><li class="lvl-3"><p>æƒ°æ€§åˆ é™¤ï¼šStream ä¸ä¼šä¸»åŠ¨åˆ é™¤å·²ç¡®è®¤çš„æ¶ˆæ¯ï¼Œä»…é MAXLENæ·˜æ±°ï¼Œè‹¥éœ€ä¸»åŠ¨æ¸…ç†å†å²æ¶ˆæ¯ï¼Œç›´æ¥ç”¨XADDçš„MAXLENå‚æ•°å³å¯ï¼Œæ— éœ€é¢å¤–å‘½ä»¤ã€‚</p></li></ol><h2 id="ç”Ÿäº§ç¯å¢ƒæ ¸å¿ƒç—›ç‚¹ä¸è§£å†³æ–¹æ¡ˆ">ç”Ÿäº§ç¯å¢ƒæ ¸å¿ƒç—›ç‚¹ä¸è§£å†³æ–¹æ¡ˆ</h2><ol><li class="lvl-3"><p>æ¶ˆæ¯ä¸¢å¤±ï¼š3é‡ä¿éšœ</p><ul class="lvl-2"><li class="lvl-6">å¼€å¯ Redis AOF æŒä¹…åŒ–ï¼ˆè®¾ä¸ºeverysecï¼Œå…¼é¡¾æ€§èƒ½ä¸å¯é æ€§ï¼‰</li><li class="lvl-6">ç”Ÿäº§è€…å†™å…¥åç¡®è®¤è¿”å›å€¼ï¼ˆç¡®ä¿å†™å…¥æˆåŠŸï¼‰</li><li class="lvl-6">æ¶ˆè´¹è€…æ¶ˆè´¹åå¿…é¡»<code>XACK</code>ç¡®è®¤ã€‚</li></ul></li><li class="lvl-3"><p>æ¶ˆæ¯å †ç§¯ï¼š2ç§å¤„ç†</p><ul class="lvl-2"><li class="lvl-6">â‘  å†™å…¥æ—¶ç”¨<code>MAXLEN</code>è®¾ç½®ä¸Šé™ï¼Œæ·˜æ±°æ—§æ¶ˆæ¯ï¼›</li><li class="lvl-6">â‘¡ æ¶ˆè´¹ç«¯æ‰©å®¹æ¶ˆè´¹è€…å®ä¾‹ï¼Œæ¶ˆè´¹ç»„ä¼šè‡ªåŠ¨å°†æœªæ¶ˆè´¹æ¶ˆæ¯åˆ†ç‰‡ç»™å¤šä¸ªæ¶ˆè´¹è€…ï¼Œå®ç°å¹¶è¡Œæ¶ˆè´¹ã€‚</li></ul></li><li class="lvl-3"><p>é‡å¤æ¶ˆè´¹</p><ul class="lvl-2"><li class="lvl-6">æ ¹æº: ç½‘ç»œæŠ–åŠ¨ï¼ˆæ¶ˆè´¹è€…ç¡®è®¤æ¶ˆæ¯å‰æ–­å¼€è¿æ¥ï¼Œæ¶ˆæ¯é‡å›PELï¼‰</li><li class="lvl-6">è§£å†³æ–¹æ¡ˆ: æ¶ˆæ¯å¹‚ç­‰æ€§ï¼ˆç”Ÿäº§è€…ç»™æ¶ˆæ¯åŠ å”¯ä¸€æ ‡è¯†ï¼Œæ¶ˆè´¹è€…æ ¹æ®å”¯ä¸€æ ‡è¯†å»é‡ï¼‰ã€‚</li></ul></li><li class="lvl-3"><p>é˜»å¡è¶…æ—¶ï¼šæ¶ˆè´¹ç«¯ç”¨BLOCKé˜»å¡æ‹‰å–ï¼Œè¶…æ—¶æ—¶é—´å»ºè®®è®¾ä¸º3-5ç§’ï¼Œé¿å…é¢‘ç¹ç©ºè½®è¯¢å ç”¨CPUï¼ŒåŒæ—¶ä¿è¯æ–°æ¶ˆæ¯çš„å“åº”é€Ÿåº¦ã€‚</p></li></ol><h2 id="å…¸å‹åº”ç”¨åœºæ™¯">å…¸å‹åº”ç”¨åœºæ™¯</h2><h3 id="åˆ†å¸ƒå¼ä¸šåŠ¡è§£è€¦ï¼ˆè®¢å•-åº“å­˜-æ”¯ä»˜-ç‰©æµè§£è€¦ï¼‰">åˆ†å¸ƒå¼ä¸šåŠ¡è§£è€¦ï¼ˆè®¢å•-åº“å­˜-æ”¯ä»˜-ç‰©æµè§£è€¦ï¼‰</h3><blockquote><p>æ ¸å¿ƒæ€è·¯ï¼šå• Stream å¯¹åº”æ ¸å¿ƒä¸šåŠ¡ï¼ˆè®¢å•ï¼‰ï¼Œåº“å­˜ã€æ”¯ä»˜ã€ç‰©æµå„åˆ›å»ºç‹¬ç«‹æ¶ˆè´¹ç»„ï¼Œå„è‡ªæ¶ˆè´¹äº’ä¸å¹²æ‰°ï¼Œå®ç°ä¸šåŠ¡è§£è€¦ã€‚</p></blockquote><ol><li class="lvl-3"><p>ç”Ÿäº§è€…ï¼ˆè®¢å•æœåŠ¡ï¼‰ï¼šå†™å…¥è®¢å•å®Œæˆæ¶ˆæ¯</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è‡ªåŠ¨ç”Ÿæˆæ¶ˆæ¯IDï¼Œå†™å…¥è®¢å•æ ¸å¿ƒä¿¡æ¯ï¼Œè®¾ç½®é˜Ÿåˆ—æœ€å¤§1ä¸‡æ¡æ¶ˆæ¯ï¼ˆè¿‘ä¼¼æ·˜æ±°ï¼‰</span></span><br><span class="line">XADD order_core_stream * MAXLEN ~ 10000 order_no ORD20251220001 uid 1001 amount 299 status created create_time 1734567890</span><br></pre></td></tr></table></figure><ol start="2"><li class="lvl-3"><p>åˆ›å»º3ä¸ªç‹¬ç«‹æ¶ˆè´¹ç»„ï¼ˆåº“å­˜/æ”¯ä»˜/ç‰©æµï¼‰</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åº“å­˜æ¶ˆè´¹ç»„ï¼šä»æœ€æ–°æ¶ˆæ¯å¼€å§‹æ¶ˆè´¹ï¼Œé˜Ÿåˆ—ä¸å­˜åœ¨åˆ™è‡ªåŠ¨åˆ›å»º</span></span><br><span class="line">XGROUP CREATE order_core_stream group_stock $ MKSTREAM</span><br><span class="line"><span class="comment"># æ”¯ä»˜æ¶ˆè´¹ç»„</span></span><br><span class="line">XGROUP CREATE order_core_stream group_pay $ MKSTREAM</span><br><span class="line"><span class="comment"># ç‰©æµæ¶ˆè´¹ç»„</span></span><br><span class="line">XGROUP CREATE order_core_stream group_logistics $ MKSTREAM</span><br></pre></td></tr></table></figure><ol start="3"><li class="lvl-3"><p>å„æ¶ˆè´¹ç»„æ¶ˆè´¹è€…æ‹‰å–+ç¡®è®¤æ¶ˆæ¯</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åº“å­˜æœåŠ¡æ¶ˆè´¹è€…ï¼ˆconsumer_stock1ï¼‰æ‹‰å–3æ¡æœªæ¶ˆè´¹æ¶ˆæ¯ï¼Œé˜»å¡5ç§’</span></span><br><span class="line">XREADGROUP GROUP group_stock consumer_stock1 COUNT 3 BLOCK 5000 STREAMS order_core_stream &gt;</span><br><span class="line"><span class="comment"># åº“å­˜å¤„ç†å®Œæˆåç¡®è®¤æ¶ˆæ¯ï¼ˆæ›¿æ¢ä¸ºå®é™…æ‹‰å–åˆ°çš„æ¶ˆæ¯IDï¼‰</span></span><br><span class="line">XACK order_core_stream group_stock 1734567890000-0 1734567890001-0</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ”¯ä»˜æœåŠ¡æ¶ˆè´¹è€…ï¼ˆconsumer_pay1ï¼‰åŒç†</span></span><br><span class="line">XREADGROUP GROUP group_pay consumer_pay1 COUNT 3 BLOCK 5000 STREAMS order_core_stream &gt;</span><br><span class="line">XACK order_core_stream group_pay 1734567890000-0 1734567890001-0</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç‰©æµæœåŠ¡æ¶ˆè´¹è€…ï¼ˆconsumer_log1ï¼‰åŒç†</span></span><br><span class="line">XREADGROUP GROUP group_logistics consumer_log1 COUNT 3 BLOCK 5000 STREAMS order_core_stream &gt;</span><br><span class="line">XACK order_core_stream group_logistics 1734567890000-0 1734567890001-0</span><br></pre></td></tr></table></figure><h3 id="å¼‚æ­¥ä»»åŠ¡å¤„ç†ï¼ˆç”¨æˆ·æ³¨å†Œ-é‚®ä»¶-çŸ­ä¿¡-ç§¯åˆ†å¼‚æ­¥æ‰§è¡Œï¼‰">å¼‚æ­¥ä»»åŠ¡å¤„ç†ï¼ˆç”¨æˆ·æ³¨å†Œ-é‚®ä»¶/çŸ­ä¿¡/ç§¯åˆ†å¼‚æ­¥æ‰§è¡Œï¼‰</h3><blockquote><p>æ ¸å¿ƒæ€è·¯ï¼šæ³¨å†Œæ¥å£åªè´Ÿè´£å†™å…¥ Stream æ¶ˆæ¯ï¼Œæ— éœ€ç­‰å¾…åç»­ä»»åŠ¡å®Œæˆï¼Œå•æ¶ˆè´¹ç»„å¤šæ¶ˆè´¹è€…æå‡å¼‚æ­¥ä»»åŠ¡å¤„ç†æ•ˆç‡ï¼Œæ ¸å¿ƒæ˜¯å¿«é€Ÿå“åº”å‰ç«¯ã€‚</p></blockquote><ol><li class="lvl-3"><p>ç”Ÿäº§è€…ï¼ˆæ³¨å†ŒæœåŠ¡ï¼‰ï¼šç”¨æˆ·æ³¨å†ŒæˆåŠŸåå†™å…¥æ¶ˆæ¯</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å†™å…¥ç”¨æˆ·æ³¨å†Œä¿¡æ¯ï¼ŒMAXLENé™åˆ¶5000æ¡ï¼Œé¿å…ç§¯å‹è¿‡å¤šæ— æ•ˆæ³¨å†Œæ¶ˆæ¯</span></span><br><span class="line">XADD user_register_stream * MAXLEN ~ 5000 uid 1001 username zhangsan phone 13800138000 email zs@xxx.com reg_time 1734567900</span><br></pre></td></tr></table></figure><ol start="2"><li class="lvl-3"><p>åˆ›å»ºå•ä¸ªæ¶ˆè´¹ç»„ï¼ˆç»Ÿä¸€å¤„ç†æ³¨å†Œåç»­ä»»åŠ¡ï¼‰</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XGROUP CREATE user_register_stream group_reg_task $ MKSTREAM</span><br></pre></td></tr></table></figure><ol start="3"><li class="lvl-3"><p>å¤šæ¶ˆè´¹è€…å¹¶è¡Œæ‹‰å–ï¼ˆé‚®ä»¶/çŸ­ä¿¡/ç§¯åˆ†å„1ä¸ªæ¶ˆè´¹è€…ï¼Œæˆ–å¤šå®ä¾‹æ‰©å®¹ï¼‰</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># çŸ­ä¿¡å‘é€æ¶ˆè´¹è€…ï¼ˆconsumer_smsï¼‰</span></span><br><span class="line">XREADGROUP GROUP group_reg_task consumer_sms COUNT 5 BLOCK 3000 STREAMS user_register_stream &gt;</span><br><span class="line">XACK user_register_stream group_reg_task æ¶ˆæ¯ID1 æ¶ˆæ¯ID2</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‚®ä»¶å‘é€æ¶ˆè´¹è€…ï¼ˆconsumer_emailï¼‰</span></span><br><span class="line">XREADGROUP GROUP group_reg_task consumer_email COUNT 5 BLOCK 3000 STREAMS user_register_stream &gt;</span><br><span class="line">XACK user_register_stream group_reg_task æ¶ˆæ¯ID1 æ¶ˆæ¯ID2</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç§¯åˆ†å‘æ”¾æ¶ˆè´¹è€…ï¼ˆconsumer_scoreï¼‰</span></span><br><span class="line">XREADGROUP GROUP group_reg_task consumer_score COUNT 5 BLOCK 3000 STREAMS user_register_stream &gt;</span><br><span class="line">XACK user_register_stream group_reg_task æ¶ˆæ¯ID1 æ¶ˆæ¯ID2</span><br></pre></td></tr></table></figure><h3 id="æ—¥å¿—æ”¶é›†ï¼ˆç³»ç»Ÿå®æ—¶æ—¥å¿—-åˆ†æ-å‘Šè­¦ï¼‰">æ—¥å¿—æ”¶é›†ï¼ˆç³»ç»Ÿå®æ—¶æ—¥å¿—-åˆ†æ/å‘Šè­¦ï¼‰</h3><blockquote><p>æ ¸å¿ƒæ€è·¯ï¼šå„ä¸šåŠ¡ç³»ç»Ÿå®æ—¶å†™å…¥æ—¥å¿—åˆ° Streamï¼Œå¤šæ¶ˆè´¹ç»„åˆ†åˆ«åšæ—¥å¿—åˆ†æã€å®æ—¶å‘Šè­¦ï¼Œå…¼é¡¾å®æ—¶æ€§ä¸æ•°æ®ç•™å­˜ï¼Œæ”¯æŒå†å²æ—¥å¿—å›æº¯ã€‚</p></blockquote><ol><li class="lvl-3"><p>ç”Ÿäº§è€…ï¼ˆå„ä¸šåŠ¡ç³»ç»Ÿï¼‰ï¼šå®æ—¶å†™å…¥ç³»ç»Ÿæ—¥å¿—ï¼ˆæŒ‰çº§åˆ«/ä¸šåŠ¡åˆ†ç±»ï¼Œè¿™é‡Œç»Ÿä¸€å†™å…¥æ€»æ—¥å¿—æµï¼‰</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å†™å…¥æ—¥å¿—ï¼šåŒ…å«ä¸šåŠ¡æ¨¡å—ã€æ—¥å¿—çº§åˆ«ã€å†…å®¹ã€æ—¶é—´ï¼Œæ— æ¶ˆæ¯æ•°é‡ä¸Šé™ï¼ˆæŒ‰å®é™…æœåŠ¡å™¨å†…å­˜è°ƒæ•´MAXLENï¼‰</span></span><br><span class="line">XADD sys_log_stream * module order_service level ERROR content <span class="string">&quot;åº“å­˜æ‰£å‡å¤±è´¥ï¼Œè®¢å•å·ORD20251220001&quot;</span> log_time 1734567910</span><br><span class="line">XADD sys_log_stream * module pay_service level INFO content <span class="string">&quot;æ”¯ä»˜æˆåŠŸï¼Œuid1001ï¼Œé‡‘é¢299&quot;</span> log_time 1734567912</span><br></pre></td></tr></table></figure><ol start="2"><li class="lvl-3"><p>åˆ›å»º2ä¸ªæ¶ˆè´¹ç»„ï¼ˆæ—¥å¿—åˆ†æ+å®æ—¶å‘Šè­¦ï¼‰</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ—¥å¿—åˆ†ææ¶ˆè´¹ç»„ï¼ˆç”¨äºç¦»çº¿ç»Ÿè®¡ã€æ•°æ®å½’æ¡£ï¼‰ï¼Œä»é˜Ÿåˆ—å¼€å¤´æ¶ˆè´¹ï¼ˆ0-0ï¼‰ï¼Œå…œåº•æ‰€æœ‰å†å²æ—¥å¿—</span></span><br><span class="line">XGROUP CREATE sys_log_stream group_log_analysis 0-0 MKSTREAM</span><br><span class="line"><span class="comment"># å®æ—¶å‘Šè­¦æ¶ˆè´¹ç»„ï¼ˆç”¨äºå®æ—¶æ•è·ERRORæ—¥å¿—å‘Šè­¦ï¼‰ï¼Œä»æœ€æ–°æ¶ˆæ¯æ¶ˆè´¹</span></span><br><span class="line">XGROUP CREATE sys_log_stream group_log_alert $ MKSTREAM</span><br></pre></td></tr></table></figure><ol start="3"><li class="lvl-3"><p>å¯¹åº”æ¶ˆè´¹è€…æ‹‰å–å¤„ç†</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ—¥å¿—åˆ†ææ¶ˆè´¹è€…ï¼ˆæ‰¹é‡æ‹‰å–ï¼Œéé˜»å¡ï¼Œé€‚åˆç¦»çº¿å¤„ç†ï¼‰</span></span><br><span class="line">XREADGROUP GROUP group_log_analysis consumer_analysis COUNT 100 STREAMS sys_log_stream &gt;</span><br><span class="line">XACK sys_log_stream group_log_analysis æ‰¹é‡æ¶ˆæ¯ID...</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‘Šè­¦æ¶ˆè´¹è€…ï¼ˆé˜»å¡æ‹‰å–ï¼Œå¿«é€Ÿå“åº”ï¼Œåªå¤„ç†ERRORçº§åˆ«æ—¥å¿—ï¼‰</span></span><br><span class="line">XREADGROUP GROUP group_log_alert consumer_alert BLOCK 0 STREAMS sys_log_stream &gt;  <span class="comment"># BLOCK 0 æ°¸ä¹…é˜»å¡ï¼Œæœ‰æ¶ˆæ¯ç«‹å³è¿”å›</span></span><br><span class="line">XACK sys_log_stream group_log_alert å‘Šè­¦æ¶ˆæ¯ID</span><br></pre></td></tr></table></figure><h3 id="é™æµå‰Šå³°ï¼ˆç§’æ€åœºæ™¯-è¯·æ±‚å‰Šå³°å¡«è°·ï¼‰">é™æµå‰Šå³°ï¼ˆç§’æ€åœºæ™¯-è¯·æ±‚å‰Šå³°å¡«è°·ï¼‰</h3><blockquote><p>æ ¸å¿ƒæ€è·¯ï¼šç§’æ€è¯·æ±‚é«˜å³°æ—¶ï¼Œå…ˆå†™å…¥ Stream åšç¼“å†²ï¼Œæ¶ˆè´¹ç«¯åŒ€é€Ÿæ‹‰å–ï¼ˆæ§åˆ¶æ¯ç§’å¤„ç†é‡ï¼‰ï¼Œé¿å…ä¸‹æ¸¸æ•°æ®åº“/ä¸šåŠ¡æœåŠ¡è¢«å‹å®ï¼Œæ ¸å¿ƒæ˜¯â€œæ…¢æ¶ˆè´¹ã€ç¨³å¤„ç†â€ã€‚</p></blockquote><ol><li class="lvl-3"><p>ç”Ÿäº§è€…ï¼ˆç§’æ€å…¥å£æœåŠ¡ï¼‰ï¼šæ¥æ”¶ç§’æ€è¯·æ±‚ï¼Œç›´æ¥å†™å…¥ Streamï¼Œå¿«é€Ÿè¿”å›â€œæ’é˜Ÿä¸­â€</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å†™å…¥ç§’æ€è¯·æ±‚ï¼Œè®¾ç½®MAXLEN 10000ï¼ˆé™åˆ¶æœ€å¤§æ’é˜Ÿæ•°ï¼Œè¶…è¿‡åˆ™æ‹’ç»ï¼Œé¿å…OOMï¼‰</span></span><br><span class="line">XADD seckill_stream * MAXLEN ~ 10000 seckill_id 101 uid 1001 request_time 1734568000</span><br></pre></td></tr></table></figure><ol start="2"><li class="lvl-3"><p>åˆ›å»ºæ¶ˆè´¹ç»„ï¼ˆå•æ¶ˆè´¹ç»„+å¤šæ¶ˆè´¹è€…ï¼Œæ§åˆ¶æ€»å¤„ç†é€Ÿç‡ï¼‰</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XGROUP CREATE seckill_stream group_seckill $ MKSTREAM</span><br></pre></td></tr></table></figure><ol start="3"><li class="lvl-3"><p>æ¶ˆè´¹ç«¯ï¼ˆåŒ€é€Ÿæ‹‰å–ï¼Œæ ¸å¿ƒæ˜¯æ§åˆ¶COUNTå’Œæ¶ˆè´¹é¢‘ç‡ï¼Œæ¯”å¦‚æ¯ç§’å¤„ç†100æ¡ï¼‰</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¶ˆè´¹è€…ï¼ˆå¤šå®ä¾‹éƒ¨ç½²ï¼Œæ€»å¤„ç†é‡=å•å®ä¾‹COUNTÃ—å®ä¾‹æ•°ï¼Œè¿™é‡Œå•å®ä¾‹æ¯æ¬¡æ‹‰10æ¡ï¼Œæ¯ç§’æ‹‰10æ¬¡ï¼Œå•å®ä¾‹æ¯ç§’å¤„ç†100æ¡ï¼‰</span></span><br><span class="line">XREADGROUP GROUP group_seckill consumer_seckill1 COUNT 10 BLOCK 100 STREAMS seckill_stream &gt;</span><br><span class="line"><span class="comment"># ä¸šåŠ¡å¤„ç†ï¼šæ‰£åº“å­˜ã€ç”Ÿæˆè®¢å•ï¼ˆæ ¸å¿ƒæ˜¯å¤„ç†é€»è¾‘åŒæ­¥æ‰§è¡Œï¼Œæ§åˆ¶é€Ÿç‡ï¼‰</span></span><br><span class="line">XACK seckill_stream group_seckill ç§’æ€è¯·æ±‚æ¶ˆæ¯ID...</span><br></pre></td></tr></table></figure><blockquote><p>å…³é”®ä¼˜åŒ–ï¼šæ¶ˆè´¹ç«¯é€šè¿‡å®šæ—¶ä»»åŠ¡+å›ºå®šCOUNTæ‹‰å–ï¼Œè€Œéæ— é™æ‹‰å–ï¼Œç²¾å‡†æ§åˆ¶å¤„ç†é€Ÿç‡ï¼Œå®ç°å‰Šå³°å¡«è°·ã€‚</p></blockquote><h2 id="ä¸å…¶ä»–-Redis-é˜Ÿåˆ—æ–¹æ¡ˆå¯¹æ¯”ï¼ˆæ ¸å¿ƒä¼˜åŠ¿ï¼‰">ä¸å…¶ä»– Redis é˜Ÿåˆ—æ–¹æ¡ˆå¯¹æ¯”ï¼ˆæ ¸å¿ƒä¼˜åŠ¿ï¼‰</h2><p>â€¢ å¯¹æ¯” List<br>- List æ˜¯ç®€å•çš„å…ˆè¿›å…ˆå‡ºï¼Œä¸æ”¯æŒå¤šæ’­ï¼ˆå¤šä¸ªæ¶ˆè´¹è€…ä¼šæŠ¢æ¶ˆæ¯ï¼‰ã€æ— æ¶ˆè´¹ç»„ã€æ— æ¶ˆæ¯ç¡®è®¤ï¼Œä»…é€‚åˆç®€å•ä¸€å¯¹ä¸€é˜Ÿåˆ—ï¼›<br>- Stream æ”¯æŒå¤šæ’­+æ¶ˆè´¹ç»„+ç¡®è®¤æœºåˆ¶ï¼Œé€‚åˆå¤æ‚åˆ†å¸ƒå¼åœºæ™¯ã€‚</p><table><thead><tr><th>å¯¹æ¯”é¡¹</th><th>Stream</th><th>List</th></tr></thead><tbody><tr><td>æ¶ˆè´¹è€…ç»„</td><td>âœ…</td><td>âŒ</td></tr><tr><td>ACK</td><td>âœ…</td><td>âŒ</td></tr><tr><td>é‡è¯•</td><td>âœ…</td><td>âŒ</td></tr><tr><td>é˜»å¡</td><td>âœ…</td><td>âœ…</td></tr><tr><td>é¡ºåºæ€§</td><td>å¼º</td><td>å¼º</td></tr></tbody></table><p>â€¢ å¯¹æ¯” Pub/Sub<br>- Pub/Sub æ— æŒä¹…åŒ–ï¼ŒRedis é‡å¯æˆ–æ¶ˆè´¹è€…ç¦»çº¿ä¼šä¸¢æ¶ˆæ¯ï¼›<br>- Pub/Sub æ— æ¶ˆè´¹ç»„ï¼Œæ¶ˆæ¯å‘å®Œå³ä¸¢ï¼Œä»…é€‚åˆå®æ—¶å¹¿æ’­ï¼ˆå¦‚èŠå¤©å®¤ï¼‰ï¼Œä¸é€‚åˆé‡è¦ä¸šåŠ¡ã€‚</p><h2 id="Stream-å‘½ä»¤">Stream å‘½ä»¤</h2><ul class="lvl-0"><li class="lvl-2"><p>SpringBoot çš„ <code>StringRedisTemplate.opsForStream()</code> ä¸­ Stream æ•°æ®ç±»å‹ çš„æ“ä½œæ–¹æ³•ä¸ Redis åŸç”Ÿå‘½ä»¤çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</p></li></ul><blockquote><p>æ³¨æ„è¿™é‡Œä¸ä¸€å®šè¦ç”¨ <code>StringRedisTemplate</code> æ¥æ“ä½œ Streamï¼Œä½†æ˜¯ç”¨ <code>StringRedisTemplate</code> å¯ä»¥ä¿è¯å¯è¯»æ€§ã€‚</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>æ ¸å¿ƒèƒ½åŠ›åˆ’åˆ†ï¼š</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">æ¶ˆæ¯å†™å…¥ï¼ˆXADDï¼‰</span><br><span class="line">æ¶ˆæ¯ç¡®è®¤ï¼ˆXACKï¼‰</span><br><span class="line">æ¶ˆæ¯è¯»å–ï¼ˆXRANGE / XREAD / XREADGROUPï¼‰</span><br><span class="line">Pending æ¶ˆæ¯ç®¡ç†ï¼ˆXPENDING / XCLAIMï¼‰</span><br><span class="line">æ¶ˆè´¹è€…ç»„ç®¡ç†ï¼ˆXGROUPï¼‰</span><br><span class="line">Stream å…ƒä¿¡æ¯ï¼ˆXINFOï¼‰</span><br><span class="line">Stream è£å‰ªä¸åˆ é™¤ï¼ˆXTRIM / XDELï¼‰</span><br><span class="line">å¯¹è±¡æ˜ å°„ï¼ˆMapRecord / ObjectRecordï¼‰</span><br></pre></td></tr></table></figure><h3 id="æ¶ˆæ¯å†™å…¥ï¼ˆXADDï¼‰">æ¶ˆæ¯å†™å…¥ï¼ˆXADDï¼‰</h3><ul class="lvl-0"><li class="lvl-2"><p>1ï¸âƒ£ åŸºç¡€å†™å…¥</p></li></ul><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³• <code>opsForStream().xxx()</code></th><th>Redis åŸå§‹å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>å†™å…¥ Map</td><td><code>add(K key, Map&lt;HK,HV&gt;)</code></td><td><code>XADD key * field value</code></td><td>è‡ªåŠ¨ç”Ÿæˆ ID</td></tr><tr><td>å†™å…¥ Record</td><td><code>add(Record&lt;K, ?&gt; record)</code></td><td><code>XADD</code></td><td>æ”¯æŒ ObjectRecord</td></tr><tr><td>å†™å…¥ MapRecord</td><td><code>add(MapRecord&lt;K,HK,HV&gt;)</code></td><td><code>XADD</code></td><td>Map å½¢å¼</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>2ï¸âƒ£ å¸¦å‚æ•°å†™å…¥ï¼ˆæ¨èï¼‰</p></li></ul><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>å†™å…¥ + é€‰é¡¹</td><td><code>add(record, XAddOptions)</code></td><td><code>XADD ...</code></td><td>æ”¯æŒ MAXLEN / NOMKSTREAM</td></tr><tr><td>Map + é€‰é¡¹</td><td><code>add(key, map, XAddOptions)</code></td><td><code>XADD</code></td><td>Redis â‰¥ 6</td></tr></tbody></table><h3 id="æ¶ˆæ¯ç¡®è®¤ï¼ˆXACKï¼‰">æ¶ˆæ¯ç¡®è®¤ï¼ˆXACKï¼‰</h3><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>ç¡®è®¤æ¶ˆæ¯</td><td><code>acknowledge(key, group, recordIdsâ€¦)</code></td><td><code>XACK</code></td><td>æ ‡è®°å·²æ¶ˆè´¹</td></tr><tr><td>Record ç¡®è®¤</td><td><code>acknowledge(group, record)</code></td><td><code>XACK</code></td><td>å¸¸ç”¨</td></tr></tbody></table><blockquote><p>âš ï¸ åªå¯¹ Consumer Group ç”Ÿæ•ˆ</p></blockquote><h3 id="æ¶ˆæ¯è¯»å–ï¼ˆæ— æ¶ˆè´¹è€…ç»„ï¼‰">æ¶ˆæ¯è¯»å–ï¼ˆæ— æ¶ˆè´¹è€…ç»„ï¼‰</h3><ul class="lvl-0"><li class="lvl-2"><p>1ï¸âƒ£ æŒ‰ Range è¯»å–ï¼ˆå†å²æ•°æ®ï¼‰</p></li></ul><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th></tr></thead><tbody><tr><td>æ­£åºè¯»å–</td><td><code>range(key, range)</code></td><td><code>XRANGE</code></td></tr><tr><td>é™åˆ¶æ¡æ•°</td><td><code>range(key, range, limit)</code></td><td><code>XRANGE</code></td></tr><tr><td>ååºè¯»å–</td><td><code>reverseRange(key, range)</code></td><td><code>XREVRANGE</code></td></tr><tr><td>ååº + limit</td><td><code>reverseRange(key, range, limit)</code></td><td><code>XREVRANGE</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>2ï¸âƒ£ å®æ—¶è¯»å–ï¼ˆXREADï¼‰</p></li></ul><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>è¯»å–</td><td><code>read(StreamOffsetâ€¦)</code></td><td><code>XREAD</code></td><td>ä¸æ”¯æŒ ACK</td></tr><tr><td>å¸¦å‚æ•°</td><td><code>read(options, offsetsâ€¦)</code></td><td><code>XREAD</code></td><td>BLOCK / COUNT</td></tr><tr><td>æ˜ å°„å¯¹è±¡</td><td><code>read(Class&lt;T&gt;, â€¦)</code></td><td><code>XREAD</code></td><td>è‡ªåŠ¨ååºåˆ—åŒ–</td></tr></tbody></table><h3 id="æ¶ˆè´¹è€…ç»„è¯»å–ï¼ˆXREADGROUPï¼‰">æ¶ˆè´¹è€…ç»„è¯»å–ï¼ˆXREADGROUPï¼‰</h3><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>ç»„å†…è¯»å–</td><td><code>read(Consumer, offsetsâ€¦)</code></td><td><code>XREADGROUP</code></td><td>MQ æ ¸å¿ƒ</td></tr><tr><td>å¸¦å‚æ•°</td><td><code>read(Consumer, options, offsetsâ€¦)</code></td><td><code>XREADGROUP</code></td><td>BLOCK</td></tr><tr><td>æ˜ å°„å¯¹è±¡</td><td><code>read(Class&lt;T&gt;, Consumer, â€¦)</code></td><td><code>XREADGROUP</code></td><td>â€”</td></tr></tbody></table><h3 id="Pending-æ¶ˆæ¯ç®¡ç†ï¼ˆXPENDING-XCLAIMï¼‰">Pending æ¶ˆæ¯ç®¡ç†ï¼ˆXPENDING / XCLAIMï¼‰</h3><ul class="lvl-0"><li class="lvl-2"><p>1ï¸âƒ£ Pending æŸ¥è¯¢</p></li></ul><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th></tr></thead><tbody><tr><td>Pending æ±‡æ€»</td><td><code>pending(key, group)</code></td><td><code>XPENDING</code></td></tr><tr><td>æŒ‡å®šæ¶ˆè´¹è€…</td><td><code>pending(key, consumer)</code></td><td><code>XPENDING</code></td></tr><tr><td>èŒƒå›´æŸ¥è¯¢</td><td><code>pending(key, group, range, count)</code></td><td><code>XPENDING</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>2ï¸âƒ£ æ¶ˆæ¯é‡æ–°åˆ†é…ï¼ˆXCLAIMï¼‰</p></li></ul><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>é‡æ–°åˆ†é…</td><td><code>claim(key, group, newOwner, minIdle, idsâ€¦)</code></td><td><code>XCLAIM</code></td><td>è¶…æ—¶æ¥ç®¡</td></tr><tr><td>é«˜çº§é…ç½®</td><td><code>claim(key, group, newOwner, XClaimOptions)</code></td><td><code>XCLAIM</code></td><td>force / retry</td></tr></tbody></table><h3 id="æ¶ˆè´¹è€…ç»„ç®¡ç†ï¼ˆXGROUPï¼‰">æ¶ˆè´¹è€…ç»„ç®¡ç†ï¼ˆXGROUPï¼‰</h3><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>åˆ›å»ºç»„</td><td><code>createGroup(key, group)</code></td><td><code>XGROUP CREATE</code></td><td>ä» <code>$</code> å¼€å§‹</td></tr><tr><td>æŒ‡å®š offset</td><td><code>createGroup(key, offset, group)</code></td><td><code>XGROUP CREATE</code></td><td>å¸¸ç”¨ <code>0-0</code></td></tr><tr><td>åˆ é™¤æ¶ˆè´¹è€…</td><td><code>deleteConsumer(key, consumer)</code></td><td><code>XGROUP DELCONSUMER</code></td><td></td></tr><tr><td>é”€æ¯ç»„</td><td><code>destroyGroup(key, group)</code></td><td><code>XGROUP DESTROY</code></td><td></td></tr></tbody></table><h3 id="Stream-å…ƒä¿¡æ¯ï¼ˆXINFOï¼‰">Stream å…ƒä¿¡æ¯ï¼ˆXINFOï¼‰</h3><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th></tr></thead><tbody><tr><td>Stream ä¿¡æ¯</td><td><code>info(key)</code></td><td><code>XINFO STREAM</code></td></tr><tr><td>ç»„ä¿¡æ¯</td><td><code>groups(key)</code></td><td><code>XINFO GROUPS</code></td></tr><tr><td>æ¶ˆè´¹è€…ä¿¡æ¯</td><td><code>consumers(key, group)</code></td><td><code>XINFO CONSUMERS</code></td></tr></tbody></table><h3 id="Stream-åˆ é™¤-è£å‰ª">Stream åˆ é™¤ / è£å‰ª</h3><ul class="lvl-0"><li class="lvl-2"><p>1ï¸âƒ£ åˆ é™¤æ¶ˆæ¯</p></li></ul><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th></tr></thead><tbody><tr><td>åˆ é™¤æ¶ˆæ¯</td><td><code>delete(key, recordIdsâ€¦)</code></td><td><code>XDEL</code></td></tr><tr><td>åˆ é™¤ Record</td><td><code>delete(record)</code></td><td><code>XDEL</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>2ï¸âƒ£ è£å‰ª Streamï¼ˆXTRIMï¼‰</p></li></ul><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>ç²¾ç¡®è£å‰ª</td><td><code>trim(key, count)</code></td><td><code>XTRIM</code></td><td></td></tr><tr><td>è¿‘ä¼¼è£å‰ª</td><td><code>trim(key, count, true)</code></td><td><code>XTRIM ~</code></td><td>æ€§èƒ½æ›´å¥½</td></tr></tbody></table><h3 id="å¯¹è±¡æ˜ å°„èƒ½åŠ›ï¼ˆéå¸¸é‡è¦ï¼‰">å¯¹è±¡æ˜ å°„èƒ½åŠ›ï¼ˆéå¸¸é‡è¦ï¼‰</h3><table><thead><tr><th>èƒ½åŠ›</th><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>Map â†’ Object</td><td><code>map(MapRecord, Class&lt;T&gt;)</code></td><td>è‡ªåŠ¨ååºåˆ—åŒ–</td></tr><tr><td>List æ˜ å°„</td><td><code>map(List&lt;MapRecord&gt;, Class&lt;T&gt;)</code></td><td></td></tr><tr><td>HashMapper</td><td><code>getHashMapper(Class&lt;T&gt;)</code></td><td>è‡ªå®šä¹‰æ˜ å°„</td></tr><tr><td>ååºåˆ—åŒ–</td><td><code>deserializeRecord(ByteRecord)</code></td><td>åº•å±‚èƒ½åŠ›</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡ä»‹ç» Redis Stream æ•°æ®ç±»å‹&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡åŸºäº&lt;code&gt;redis-7.4.7&lt;/code&gt;ï¼Œ&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Rediså®˜ç½‘ï¼š&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis å‘½ä»¤æ–‡æ¡£ï¼š&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis å‘½ä»¤åŠæ•°æ®ç±»å‹ -- Geo</title>
    <link href="https://blog.hanqunfeng.com/2025/12/19/redis7-datatype-09-geo/"/>
    <id>https://blog.hanqunfeng.com/2025/12/19/redis7-datatype-09-geo/</id>
    <published>2025-12-19T13:40:05.000Z</published>
    <updated>2025-12-20T05:57:13.739Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2">æœ¬æ–‡ä»‹ç» Redis Geo æ•°æ®ç±»å‹</li><li class="lvl-2">æœ¬æ–‡åŸºäº<code>redis-7.4.7</code>ï¼Œ<code>springboot-3.5.8</code></li><li class="lvl-2">Rediså®˜ç½‘ï¼š<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis å‘½ä»¤æ–‡æ¡£ï¼š<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li></ul><span id="more"></span><h2 id="Geo-æ ¸å¿ƒè¯¦è§£">Geo æ ¸å¿ƒè¯¦è§£</h2><ul class="lvl-0"><li class="lvl-2"><p>Redis Geo æ˜¯åŸºäºæœ‰åºé›†åˆï¼ˆ<code>zset</code>ï¼‰ å®ç°çš„åœ°ç†ç©ºé—´æ“ä½œåŠŸèƒ½ï¼Œåº•å±‚ç”¨<code>geohashç¼–ç </code>å­˜å‚¨<code>ç»çº¬åº¦</code>ï¼Œæ ¸å¿ƒæ”¯æŒ 6 ä¸ªåŸºç¡€æ“ä½œ + 2 ä¸ªæ‰©å±•æ“ä½œï¼Œå…¼é¡¾<code>ç²¾å‡†å­˜å‚¨</code>ã€<code>è·ç¦»è®¡ç®—</code>ã€<code>èŒƒå›´ç­›é€‰</code>ç­‰æ ¸å¿ƒéœ€æ±‚ï¼Œç›´æ¥å¯¹æ¥å®é™…åœºæ™¯ï¼ˆå¦‚é™„è¿‘é—¨åº—ã€åŒåŸå¥½å‹ï¼‰ã€‚</p></li><li class="lvl-2"><p>æœ‰æ•ˆç»åº¦(longitude)ä¸º <code>-180 ~ 180</code>ï¼Œæœ‰æ•ˆçº¬åº¦(latitude)ä¸º <code>-85.05112878 ~ 85.05112878</code>ã€‚</p></li><li class="lvl-2"><p>Redis å†…éƒ¨å®ç°ä¸­ï¼š</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GEO æ•°æ® â‰ˆ ZSET</span><br><span class="line">score = GeoHashï¼ˆ52 ä½bit â‰ˆ 11 ä¸ªå­—ç¬¦ï¼‰</span><br><span class="line">member = å®é™…æˆå‘˜å</span><br></pre></td></tr></table></figure><h2 id="Geohash-æ˜¯ä»€ä¹ˆ">Geohash æ˜¯ä»€ä¹ˆ?</h2><ul class="lvl-0"><li class="lvl-2"><p>Geohash æ˜¯ä¸€ç§å°†äºŒç»´åœ°ç†åæ ‡ï¼ˆç»åº¦ã€çº¬åº¦ï¼‰ç¼–ç ä¸ºä¸€ç»´å­—ç¬¦ä¸²æˆ–æ•´æ•°çš„ç©ºé—´ç´¢å¼•ç®—æ³•ï¼Œæ ¸å¿ƒç›®æ ‡æ˜¯ï¼š</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å°†ã€Œä½ç½®ã€æ˜ å°„ä¸ºã€Œå¯æ’åºçš„å€¼ã€</span><br><span class="line">ç›¸è¿‘çš„åœ°ç†ä½ç½® â†’ å‰ç¼€ç›¸åŒæˆ–æ¥è¿‘</span><br><span class="line">ä¾¿äº èŒƒå›´æŸ¥è¯¢ã€é‚»è¿‘æŸ¥è¯¢ã€ç´¢å¼•å­˜å‚¨</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ ¸å¿ƒæ€æƒ³</p></li></ul><blockquote><p>ä¸æ–­å¯¹ç»çº¬åº¦åŒºé—´è¿›è¡ŒäºŒåˆ†ï¼Œå¹¶äº¤å‰ç¼–ç <br>ç¼–ç é¡ºåºï¼šç»åº¦ â†’ çº¬åº¦ â†’ ç»åº¦ â†’ çº¬åº¦ â†’ â€¦</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">æ¯ä¸€æ­¥ï¼š</span><br><span class="line">    1.å–å½“å‰åŒºé—´çš„ä¸­ç‚¹</span><br><span class="line">    2.å¤§äºä¸­ç‚¹è®°ä¸º 1</span><br><span class="line">    3.å°äºä¸­ç‚¹è®°ä¸º 0</span><br><span class="line">    4.ç¼©å°åŒºé—´ï¼Œç»§ç»­ä¸‹ä¸€ä½</span><br><span class="line">æœ€ç»ˆå¾—åˆ°ä¸€ä¸ª bit åºåˆ—ã€‚</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>Redis å†…éƒ¨çš„ Geohash å­—ç¬¦ = <code>52bit</code>ï¼Œå³ ç»åº¦ <code>26 bit</code>ï¼Œçº¬åº¦ <code>26 bit</code></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">æ¯ä¸ªå­—ç¬¦ = 5 bit</span><br><span class="line">å†…éƒ¨ 52 bit â†’ æŒ‰ 5 bit åˆ†ç»„ â†’ 52 Ã· 5 = 10 ä½™ 2 bit</span><br><span class="line"></span><br><span class="line">Redis é»˜è®¤åœ¨è¾“å‡ºå­—ç¬¦ä¸²æ—¶ï¼š</span><br><span class="line">    ä¼šæŠŠ å‰©ä½™çš„ 2 bit å¡«å……æˆå®Œæ•´å­—ç¬¦ï¼Œå³æœ«å°¾è¡¥ä¸‰ä¸ª 0</span><br><span class="line">    å› æ­¤æœ€ç»ˆå¾—åˆ° 11 ä¸ª Base32 å­—ç¬¦</span><br></pre></td></tr></table></figure><h3 id="Geohash-è®¡ç®—è¿‡ç¨‹ç¤ºä¾‹">Geohash è®¡ç®—è¿‡ç¨‹ç¤ºä¾‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">longitude = 116.397128</span><br><span class="line">latitude  = 39.916527</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ä¸ºäº†ç®€åŒ–è®¡ç®—è¿‡ç¨‹ï¼Œæˆ‘ä»¬è¿™é‡Œå›ºå®šä¸€ä¸ªå¸¸ç”¨ç²¾åº¦ï¼š</p><ul class="lvl-2"><li class="lvl-6">ç²¾åº¦é€‰æ‹©ï¼š5 ä¸ª Geohash å­—ç¬¦ = 25 ä¸ª bit â‡’ ç»åº¦ 13 bitï¼Œçº¬åº¦ 12 bitï¼ˆå¥‡æ•°ä½ç»åº¦ï¼‰</li></ul></li><li class="lvl-2"><p>é€ä½è®¡ç®—ï¼ˆå…³é”®è¿‡ç¨‹ï¼‰<br>1ï¸âƒ£ ç»åº¦ bitï¼ˆ13 ä½ï¼‰</p></li></ul><table><thead><tr><th>ä½æ¬¡</th><th>åŒºé—´</th><th>mid</th><th>åˆ¤æ–­</th><th>bit</th></tr></thead><tbody><tr><td>1</td><td>[-180,180]</td><td>0</td><td>116 â‰¥ 0</td><td>1</td></tr><tr><td>2</td><td>[0,180]</td><td>90</td><td>116 â‰¥ 90</td><td>1</td></tr><tr><td>3</td><td>[90,180]</td><td>135</td><td>116 &lt; 135</td><td>0</td></tr><tr><td>4</td><td>[90,135]</td><td>112.5</td><td>116 â‰¥ 112.5</td><td>1</td></tr><tr><td>5</td><td>[112.5,135]</td><td>123.75</td><td>116 &lt; 123.75</td><td>0</td></tr><tr><td>6</td><td>[112.5,123.75]</td><td>118.125</td><td>116 &lt; 118.125</td><td>0</td></tr><tr><td>7</td><td>[112.5,118.125]</td><td>115.3125</td><td>116 â‰¥ 115.3125</td><td>1</td></tr><tr><td>8</td><td>[115.3125,118.125]</td><td>116.71875</td><td>116 &lt; 116.71875</td><td>0</td></tr><tr><td>9</td><td>[115.3125,116.71875]</td><td>116.015625</td><td>116 â‰¥ 116.015625</td><td>1</td></tr><tr><td>10</td><td>[116.015625,116.71875]</td><td>116.3671875</td><td>116 â‰¥ 116.3671875</td><td>1</td></tr><tr><td>11</td><td>[116.3671875,116.71875]</td><td>116.54296875</td><td>116 &lt; 116.54296875</td><td>0</td></tr><tr><td>12</td><td>[116.3671875,116.54296875]</td><td>116.455078125</td><td>116 &lt; 116.455078125</td><td>0</td></tr><tr><td>13</td><td>[116.3671875,116.455078125]</td><td>116.4111328125</td><td>116 &lt; 116.4111328125</td><td>0</td></tr></tbody></table><blockquote><p>ç»åº¦ bitï¼ˆ13 ä½ï¼‰ï¼š<code>1101001011000</code></p></blockquote><p>2ï¸âƒ£ çº¬åº¦ bitï¼ˆ12 ä½ï¼‰</p><table><thead><tr><th>ä½æ¬¡</th><th>åŒºé—´</th><th>mid</th><th>åˆ¤æ–­</th><th>bit</th></tr></thead><tbody><tr><td>1</td><td>[-90,90]</td><td>0</td><td>39 â‰¥ 0</td><td>1</td></tr><tr><td>2</td><td>[0,90]</td><td>45</td><td>39 &lt; 45</td><td>0</td></tr><tr><td>3</td><td>[0,45]</td><td>22.5</td><td>39 â‰¥ 22.5</td><td>1</td></tr><tr><td>4</td><td>[22.5,45]</td><td>33.75</td><td>39 â‰¥ 33.75</td><td>1</td></tr><tr><td>5</td><td>[33.75,45]</td><td>39.375</td><td>39 &lt; 39.375</td><td>0</td></tr><tr><td>6</td><td>[33.75,39.375]</td><td>36.5625</td><td>39 â‰¥ 36.5625</td><td>1</td></tr><tr><td>7</td><td>[36.5625,39.375]</td><td>37.96875</td><td>39 â‰¥ 37.96875</td><td>1</td></tr><tr><td>8</td><td>[37.96875,39.375]</td><td>38.671875</td><td>39 â‰¥ 38.671875</td><td>1</td></tr><tr><td>9</td><td>[38.671875,39.375]</td><td>39.0234375</td><td>39 &lt; 39.0234375</td><td>0</td></tr><tr><td>10</td><td>[38.671875,39.0234375]</td><td>38.84765625</td><td>39 â‰¥ 38.84765625</td><td>1</td></tr><tr><td>11</td><td>[38.84765625,39.0234375]</td><td>38.935546875</td><td>39 â‰¥ 38.935546875</td><td>1</td></tr><tr><td>12</td><td>[38.935546875,39.0234375]</td><td>38.9794921875</td><td>39 â‰¥ 38.9794921875</td><td>1</td></tr></tbody></table><blockquote><p>çº¬åº¦ bitï¼ˆ12 ä½ï¼‰ï¼š<code>101101110111</code></p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>äº¤å‰åˆå¹¶ï¼ˆæœ€ç»ˆ bit åºåˆ—ï¼‰</p></li></ul><blockquote><p>æŒ‰è§„åˆ™ï¼šç»åº¦ â†’ çº¬åº¦ â†’ ç»åº¦ â†’ çº¬åº¦ â€¦</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ç»åº¦: 1 1 0 1 0 0 1 0 1 1 0 0 0</span><br><span class="line">çº¬åº¦: 1 0 1 1 0 1 1 1 0 1 1 1</span><br><span class="line"></span><br><span class="line">äº¤å‰åå¾—åˆ° 25 bitï¼š11 10 01 11 00 01 11 01 10 11 01 01 01</span><br><span class="line">åˆå¹¶ä¸ºä¸€è¡Œï¼š1110011100011101101010101</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ¯ 5 bit â†’ 1 ä¸ª Base32 å­—ç¬¦</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»å·¦åˆ°å³ï¼Œæ¯ 5 ä½ä¸€ç»„ï¼š</span></span><br><span class="line">11100 | 11100 | 01110 | 11010 | 10101</span><br><span class="line"><span class="comment"># è½¬10è¿›åˆ¶</span></span><br><span class="line">28    | 28    | 14    | 26    | 21</span><br><span class="line"><span class="comment"># è½¬ Base32</span></span><br><span class="line">w     | w    | f    | u    | p</span><br><span class="line"><span class="comment"># æœ€ç»ˆç»“æœï¼š</span></span><br><span class="line">wwfup</span><br></pre></td></tr></table></figure><div class="tips"><p><em><strong>Geohash ä½¿ç”¨çš„ Base32 å­—ç¬¦é›†ï¼ˆå›ºå®šï¼Œä¸æ˜¯ RFC Base32ï¼‰ï¼š</strong></em></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Index:  0 1 2 3 4 5 6 7 8 9</span><br><span class="line">Char :  0 1 2 3 4 5 6 7 8 9</span><br><span class="line"></span><br><span class="line">Index: 10 11 12 13 14 15 16 17 18 19</span><br><span class="line">Char :  b  c  d  e  f  g  h  j  k  m</span><br><span class="line"></span><br><span class="line">Index: 20 21 22 23 24 25 26 27 28 29</span><br><span class="line">Char :  n  p  q  r  s  t  u  v  w  x</span><br><span class="line"></span><br><span class="line">Index: 30 31</span><br><span class="line">Char :  y  z</span><br></pre></td></tr></table></figure><ul class="lvl-1"><li class="lvl-2">Geohash Base32 å­—ç¬¦é›† ä¸ºä»€ä¹ˆç¼ºå°‘ <code>a, i, l, o</code><ul class="lvl-3"><li class="lvl-6">ä¸ºäº†é¿å…åœ¨è§†è§‰ä¸Šå¼•èµ·æ•°å­—æ··æ·†</li></ul>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a å®¹æ˜“å’Œ 4 æ··æ·†</span><br><span class="line">i å®¹æ˜“å’Œ 1 æ··æ·†</span><br><span class="line">l å®¹æ˜“å’Œ 1 æ··æ·†</span><br><span class="line">o å®¹æ˜“å’Œ 0 æ··æ·†</span><br></pre></td></tr></table></figure><ul class="lvl-3"><li class="lvl-6">å»æ‰ <code>a, i, l, o</code> ååˆšå¥½æ˜¯ 32 ä¸ªå­—ç¬¦ï¼Œå› ä¸º Geohash éœ€è¦ 2âµ = 32 ä¸ªå­—ç¬¦ å¯¹åº” 5 bit ç²¾åº¦</li></ul></li></ul></div><h2 id="Geo-æ ¸å¿ƒåŸºç¡€æ“ä½œï¼ˆå¿…ç”¨ï¼‰">Geo æ ¸å¿ƒåŸºç¡€æ“ä½œï¼ˆå¿…ç”¨ï¼‰</h2><h3 id="1-GEOADDï¼šæ·»åŠ åœ°ç†ä½ç½®åæ ‡ï¼ˆæ ¸å¿ƒå†™å…¥æ“ä½œï¼‰">1. GEOADDï¼šæ·»åŠ åœ°ç†ä½ç½®åæ ‡ï¼ˆæ ¸å¿ƒå†™å…¥æ“ä½œï¼‰</h3><p>â—¦ è¯­æ³•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GEOADD key [NX | XX] [CH] longitude latitude member [longitude latitude member ...]</span><br><span class="line"><span class="comment"># å‚æ•°è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment"># key: keyåç§°</span></span><br><span class="line"><span class="comment"># NXï¼šå¦‚æœå·²å­˜åœ¨ï¼Œåˆ™ä¸æ‰§è¡Œå†™å…¥æ“ä½œ</span></span><br><span class="line"><span class="comment"># XX: å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ‰§è¡Œå†™å…¥æ“ä½œï¼Œä¸ NX äº’æ–¥</span></span><br><span class="line"><span class="comment"># CH: ï¼ˆCHæ˜¯æ›´æ”¹çš„ç¼©å†™ï¼‰è¿”å›æ–°å¢å’Œä¿®æ”¹çš„æˆå‘˜æ•°é‡ï¼Œä¿®æ”¹ç»çº¬åº¦ä¹Ÿç®—ä¿®æ”¹ï¼Œå¦‚æœä¸åŠ CHï¼Œåˆ™åªè®¡ç®—æ–°å¢æˆå‘˜æ•°é‡</span></span><br><span class="line"><span class="comment"># longitude: ç»åº¦ (-180 ~ 180)</span></span><br><span class="line"><span class="comment"># latitude: çº¬åº¦ (-85.05112878 ~ 85.05112878)</span></span><br><span class="line"><span class="comment"># member: æˆå‘˜åç§°ï¼Œä½ç½®å”¯ä¸€æ ‡è¯†ï¼ˆå­—ç¬¦ä¸²ï¼‰</span></span><br><span class="line"><span class="comment"># è¿”å›å€¼ï¼š(ä¸å¸¦CH)æˆåŠŸæ–°å¢çš„ member æ•°é‡ï¼ˆå·²å­˜åœ¨ä¸ä¼šé‡å¤è®¡ç®—ï¼‰ï¼Œ(å¸¦CH)è¿”å›æ–°å¢å’Œä¿®æ”¹çš„æˆå‘˜æ•°é‡</span></span><br></pre></td></tr></table></figure><p>â—¦ ç¤ºä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç»™shopé›†åˆåŠ ç‹åºœäº•ã€è¥¿å•2ä¸ªé—¨åº—çš„ç»çº¬åº¦</span></span><br><span class="line">GEOADD shop 116.403963 39.915112 wangfujing 116.391248 39.906217 xidan</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br></pre></td></tr></table></figure><p>â—¦ å…³é”®ï¼šç»çº¬åº¦é¡ºåºä¸èƒ½åï¼Œå­˜å‚¨åä¼šè‡ªåŠ¨ç»™æ¯ä¸ªæˆå‘˜ç”Ÿæˆgeohashç¼–ç ã€‚</p><h3 id="2-GEOPOSï¼šè·å–æŒ‡å®šæˆå‘˜çš„ç»çº¬åº¦ï¼ˆç²¾å‡†æŸ¥è¯¢åæ ‡ï¼‰">2. GEOPOSï¼šè·å–æŒ‡å®šæˆå‘˜çš„ç»çº¬åº¦ï¼ˆç²¾å‡†æŸ¥è¯¢åæ ‡ï¼‰</h3><p>â—¦ è¯­æ³•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GEOPOS key [member [member ...]]</span><br></pre></td></tr></table></figure><p>â—¦ ç¤ºä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿”å›ç‹åºœäº•çš„ç»çº¬åº¦æ•°ç»„ [ç»åº¦, çº¬åº¦]</span></span><br><span class="line">GEOPOS shop wangfujing</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">1) 1) <span class="string">&quot;116.40396326780319214&quot;</span></span><br><span class="line">   2) <span class="string">&quot;39.91511209922290249&quot;</span></span><br></pre></td></tr></table></figure><p>â—¦ å…³é”®ï¼šè¿”å›ç»“æœä¸æŸ¥è¯¢æˆå‘˜é¡ºåºä¸€è‡´ï¼Œä¸å­˜åœ¨çš„æˆå‘˜è¿”å›nilï¼Œå¯æ‰¹é‡æŸ¥è¯¢æå‡æ•ˆç‡ã€‚</p><h3 id="3-GEODISTï¼šè®¡ç®—ä¸¤ä¸ªæˆå‘˜ä¹‹é—´çš„è·ç¦»ï¼ˆæ ¸å¿ƒè®¡ç®—æ“ä½œï¼‰">3. GEODISTï¼šè®¡ç®—ä¸¤ä¸ªæˆå‘˜ä¹‹é—´çš„è·ç¦»ï¼ˆæ ¸å¿ƒè®¡ç®—æ“ä½œï¼‰</h3><p>â—¦ è¯­æ³•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GEODIST key member1 member2 [M|KM|FT|MI]</span><br><span class="line"><span class="comment"># [M|KM|FT|MI] : è·ç¦»å•ä½</span></span><br><span class="line"><span class="comment"># M : ç±³ï¼Œé»˜è®¤</span></span><br><span class="line"><span class="comment"># KM : åƒç±³</span></span><br><span class="line"><span class="comment"># FT : è‹±å°º</span></span><br><span class="line"><span class="comment"># MI : è‹±é‡Œ</span></span><br></pre></td></tr></table></figure><p>â—¦ ç¤ºä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿”å›ç‹åºœäº•å’Œè¥¿å•ä¹‹é—´çš„è·ç¦»ï¼Œå•ä½ä¸ºç±³</span></span><br><span class="line">GEODIST shop wangfujing xidan</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line"><span class="string">&quot;1468.0611&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¡ç®—ç‹åºœäº•åˆ°è¥¿å•çš„è·ç¦»ï¼Œå•ä½åƒç±³</span></span><br><span class="line">GEODIST shop wangfujing xidan km</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line"><span class="string">&quot;1.4681&quot;</span></span><br></pre></td></tr></table></figure><p>â—¦ å…³é”®ï¼šè¿”å›æµ®ç‚¹å‹ç»“æœï¼Œæˆå‘˜ä¸å­˜åœ¨è¿”å›nilï¼Œæ”¯æŒè·¨åŒºåŸŸè·ç¦»è®¡ç®—ï¼ˆå¦‚ä¸åŒåŸå¸‚é—¨åº—ï¼‰ã€‚</p><h3 id="4-GEOHASHï¼šè·å–æŒ‡å®šæˆå‘˜çš„geohashç¼–ç ï¼ˆåº•å±‚ç¼–ç æŸ¥è¯¢ï¼‰">4. GEOHASHï¼šè·å–æŒ‡å®šæˆå‘˜çš„geohashç¼–ç ï¼ˆåº•å±‚ç¼–ç æŸ¥è¯¢ï¼‰</h3><p>â—¦ è¯­æ³•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GEOHASH key [member [member ...]]</span><br></pre></td></tr></table></figure><p>â—¦ ç¤ºä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿”å›ç‹åºœäº•çš„geohashå­—ç¬¦ä¸²ï¼Œå…±11ä½</span></span><br><span class="line">GEOHASH shop wangfujing</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">1) <span class="string">&quot;wx4g0f6f2u0&quot;</span></span><br></pre></td></tr></table></figure><p>â—¦ å…³é”®ï¼šgeohashç¼–ç è¶Šé•¿ç²¾åº¦è¶Šé«˜ï¼ŒRedisé»˜è®¤ç²¾åº¦è¶³å¤Ÿæ—¥å¸¸ä½¿ç”¨ï¼›ç¼–ç ç›¸åŒçš„æˆå‘˜ï¼Œåœ°ç†ä½ç½®æè¿‘ï¼Œå¯ç”¨äºå¿«é€Ÿåˆ¤è¿‘ã€‚</p><h3 id="5-GEORADIUSï¼šæŒ‰æŒ‡å®šç»çº¬åº¦ä¸ºä¸­å¿ƒï¼Œç­›é€‰æŒ‡å®šèŒƒå›´çš„æˆå‘˜ï¼ˆèŒƒå›´æŸ¥è¯¢1ï¼ŒæŒ‰ä¸­å¿ƒç‚¹åæ ‡ï¼‰">5. GEORADIUSï¼šæŒ‰æŒ‡å®šç»çº¬åº¦ä¸ºä¸­å¿ƒï¼Œç­›é€‰æŒ‡å®šèŒƒå›´çš„æˆå‘˜ï¼ˆèŒƒå›´æŸ¥è¯¢1ï¼ŒæŒ‰ä¸­å¿ƒç‚¹åæ ‡ï¼‰</h3><ul class="lvl-0"><li class="lvl-2"><p>å³å°†å¼ƒç”¨ï¼Œè¯·ä½¿ç”¨ <code>GEOSEARCH</code> / <code>GEOSEARCHSTORE</code> æ›¿ä»£<br>â—¦ è¯­æ³•ï¼š</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GEORADIUS key longitude latitude radius M|KM|FT|MI [WITHCOORD] [WITHDIST] [WITHHASH] [COUNT count [ANY]] [ASC|DESC] [STORE key|STOREDIST key]</span><br><span class="line"><span class="comment"># å‚æ•°è¯´æ˜</span></span><br><span class="line"><span class="comment"># key: keyåç§°</span></span><br><span class="line"><span class="comment"># longitude: ç»åº¦</span></span><br><span class="line"><span class="comment"># latitude: çº¬åº¦</span></span><br><span class="line"><span class="comment"># radius: åŠå¾„</span></span><br><span class="line"><span class="comment"># M|KM|FT|MI: å•ä½</span></span><br><span class="line"><span class="comment">## å¯é€‰å‚æ•°</span></span><br><span class="line"><span class="comment"># WITHCOORD: è¿”å›ç»çº¬åº¦</span></span><br><span class="line"><span class="comment"># WITHDIST: å¸¦è·ç¦»</span></span><br><span class="line"><span class="comment"># WITHHASH: å¸¦geohash</span></span><br><span class="line"><span class="comment"># COUNT count: é™åˆ¶è¿”å›æ•°é‡</span></span><br><span class="line"><span class="comment"># ANY: éšæœºè¿”å›æ•°é‡</span></span><br><span class="line"><span class="comment"># ASC/DESC: æŒ‰è·ç¦»æ­£/å€’åº</span></span><br><span class="line"><span class="comment"># STORE key: å­˜å‚¨ç»“æœåˆ°æŒ‡å®škey</span></span><br><span class="line"><span class="comment"># STOREDIST key: å­˜å‚¨ç»“æœåˆ°æŒ‡å®škeyï¼Œç»“æœä¸ºè·ç¦»</span></span><br></pre></td></tr></table></figure><p>â—¦ æ ¸å¿ƒå¯é€‰å‚æ•°ï¼šWITHDISTï¼ˆè¿”å›è·ç¦»ï¼‰ã€WITHCOORDï¼ˆè¿”å›ç»çº¬åº¦ï¼‰ã€WITHHASHï¼ˆè¿”å›geohashï¼‰ã€COUNT nï¼ˆé™åˆ¶è¿”å›æ•°é‡ï¼‰ã€ASC/DESCï¼ˆæŒ‰è·ç¦»æ­£/å€’åºï¼‰</p><p>â—¦ ç¤ºä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»¥å¤©å®‰é—¨é™„è¿‘ä¸ºä¸­å¿ƒï¼ŒæŸ¥5kmå†…10ä¸ªé—¨åº—ï¼ŒæŒ‰è·ç¦»ä»è¿‘åˆ°è¿œè¿”å›å¹¶å¸¦è·ç¦»</span></span><br><span class="line">GEORADIUS shop 116.397 39.91 5 km WITHDIST COUNT 10 ASC</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">1) 1) <span class="string">&quot;xidan&quot;</span></span><br><span class="line">   2) <span class="string">&quot;0.6463&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;wangfujing&quot;</span></span><br><span class="line">   2) <span class="string">&quot;0.8223&quot;</span></span><br></pre></td></tr></table></figure><h3 id="6-GEORADIUSBYMEMBERï¼šæŒ‰å·²æœ‰æˆå‘˜ä¸ºä¸­å¿ƒï¼Œç­›é€‰æŒ‡å®šèŒƒå›´çš„æˆå‘˜ï¼ˆèŒƒå›´æŸ¥è¯¢2ï¼ŒæŒ‰å·²æœ‰èŠ‚ç‚¹ï¼Œæ›´å¸¸ç”¨ï¼‰">6. GEORADIUSBYMEMBERï¼šæŒ‰å·²æœ‰æˆå‘˜ä¸ºä¸­å¿ƒï¼Œç­›é€‰æŒ‡å®šèŒƒå›´çš„æˆå‘˜ï¼ˆèŒƒå›´æŸ¥è¯¢2ï¼ŒæŒ‰å·²æœ‰èŠ‚ç‚¹ï¼Œæ›´å¸¸ç”¨ï¼‰</h3><ul class="lvl-0"><li class="lvl-2"><p>å³å°†å¼ƒç”¨ï¼Œè¯·ä½¿ç”¨ <code>GEOSEARCH</code> / <code>GEOSEARCHSTORE</code> æ›¿ä»£<br>â—¦ è¯­æ³•ï¼š</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GEORADIUSBYMEMBER key member radius M|KM|FT|MI [WITHCOORD] [WITHDIST] [WITHHASH] [COUNT count [ANY]] [ASC|DESC] [STORE key|STOREDIST key]</span><br><span class="line"><span class="comment"># è¯­æ³•è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment"># key: keyåç§°</span></span><br><span class="line"><span class="comment"># member: å·²æœ‰æˆå‘˜åç§°</span></span><br><span class="line"><span class="comment"># radius: åŠå¾„</span></span><br><span class="line"><span class="comment"># M|KM|FT|MI: å•ä½</span></span><br><span class="line"><span class="comment">## å¯é€‰å‚æ•°è¯´æ˜åŒ GEORADIUS</span></span><br></pre></td></tr></table></figure><p>â—¦ å¯é€‰å‚æ•°ä¸GEORADIUSä¸€è‡´ï¼Œåœºæ™¯æ›´è´´åˆå®é™…ï¼ˆå¦‚æŸ¥â€œæˆ‘é™„è¿‘â€çš„é—¨åº—ï¼Œå…ˆå­˜è‡ªå·±çš„åæ ‡ä¸ºæˆå‘˜ï¼Œå†ç”¨æ­¤å‘½ä»¤ï¼‰<br>â—¦ ç¤ºä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥ç‹åºœäº•3kmå†…çš„é—¨åº—ï¼ŒæŒ‰è·ç¦»æ’åº</span></span><br><span class="line">GEORADIUSBYMEMBER shop wangfujing 3 km WITHDIST ASC</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">1) 1) <span class="string">&quot;wangfujing&quot;</span></span><br><span class="line">   2) <span class="string">&quot;0.0000&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;xidan&quot;</span></span><br><span class="line">   2) <span class="string">&quot;1.4681&quot;</span></span><br></pre></td></tr></table></figure><h2 id="Geo-æ‰©å±•æ“ä½œï¼ˆå®æˆ˜å¸¸ç”¨ï¼‰">Geo æ‰©å±•æ“ä½œï¼ˆå®æˆ˜å¸¸ç”¨ï¼‰</h2><h3 id="1-GEOSEARCHï¼ˆRedis-6-2-æ–°å¢ï¼Œæ›¿ä»£-GEORADIUS-GEORADIUSBYMEMBERï¼‰">1. GEOSEARCHï¼ˆRedis 6.2+ æ–°å¢ï¼Œæ›¿ä»£ GEORADIUS/GEORADIUSBYMEMBERï¼‰</h3><p>â—¦ ä¼˜åŠ¿ï¼šåŠŸèƒ½æ›´å…¨ã€è¯­æ³•æ›´ç»Ÿä¸€ï¼Œæ”¯æŒä¸¤ç§æŸ¥è¯¢æ¨¡å¼ï¼Œæ˜¯æœªæ¥ä¸»æµç”¨æ³•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GEOSEARCH key &lt;FROMMEMBER member | FROMLONLAT longitude latitude&gt;</span><br><span class="line">  &lt;BYRADIUS radius &lt;M | KM | FT | MI&gt; | BYBOX width height &lt;M | KM | FT | MI&gt;&gt;</span><br><span class="line">  [ASC | DESC] [COUNT count [ANY]] [WITHCOORD] [WITHDIST] [WITHHASH]</span><br></pre></td></tr></table></figure><p>â—¦ è¯­æ³•1ï¼ˆæŒ‰åæ ‡ä¸­å¿ƒï¼‰ï¼š<code>GEOSEARCH key FROMLONLAT ç»åº¦ çº¬åº¦ BYRADIUS è·ç¦» å•ä½ [å¯é€‰å‚æ•°]</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥å¤©å®‰é—¨3kmå†…çš„é—¨åº—ï¼ŒæŒ‰è·ç¦»æ’åº</span></span><br><span class="line">GEOSEARCH shop FROMLONLAT 116.397 39.91 BYRADIUS 3 km WITHDIST WITHCOORD WITHHASH ASC COUNT 10</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">1) 1) <span class="string">&quot;xidan&quot;</span></span><br><span class="line">   2) <span class="string">&quot;0.6463&quot;</span></span><br><span class="line">   3) (<span class="built_in">integer</span>) 4069885362016563</span><br><span class="line">   4) 1) <span class="string">&quot;116.39124959707260132&quot;</span></span><br><span class="line">      2) <span class="string">&quot;39.90621776267477827&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;wangfujing&quot;</span></span><br><span class="line">   2) <span class="string">&quot;0.8223&quot;</span></span><br><span class="line">   3) (<span class="built_in">integer</span>) 4069885555089518</span><br><span class="line">   4) 1) <span class="string">&quot;116.40396326780319214&quot;</span></span><br><span class="line">      2) <span class="string">&quot;39.91511209922290249&quot;</span></span><br></pre></td></tr></table></figure><p>â—¦ è¯­æ³•2ï¼ˆæŒ‰æˆå‘˜ä¸­å¿ƒï¼‰ï¼š<code>GEOSEARCH key FROMMEMBER ä¸­å¿ƒæˆå‘˜ BYRADIUS è·ç¦» å•ä½ [å¯é€‰å‚æ•°]</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥ç‹åºœäº•3kmå†…çš„é—¨åº—ï¼ŒæŒ‰è·ç¦»æ’åº</span></span><br><span class="line">GEOSEARCH shop FROMMEMBER wangfujing BYRADIUS 3 km WITHDIST WITHCOORD WITHHASH ASC COUNT 10</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">1) 1) <span class="string">&quot;wangfujing&quot;</span></span><br><span class="line">   2) <span class="string">&quot;0.0000&quot;</span></span><br><span class="line">   3) (<span class="built_in">integer</span>) 4069885555089518</span><br><span class="line">   4) 1) <span class="string">&quot;116.40396326780319214&quot;</span></span><br><span class="line">      2) <span class="string">&quot;39.91511209922290249&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;xidan&quot;</span></span><br><span class="line">   2) <span class="string">&quot;1.4681&quot;</span></span><br><span class="line">   3) (<span class="built_in">integer</span>) 4069885362016563</span><br><span class="line">   4) 1) <span class="string">&quot;116.39124959707260132&quot;</span></span><br><span class="line">      2) <span class="string">&quot;39.90621776267477827&quot;</span></span><br></pre></td></tr></table></figure><p>â—¦ æ–°å¢ç‰¹æ€§ï¼šæ”¯æŒ <code>BYBOXï¼ˆæŒ‰çŸ©å½¢èŒƒå›´æŸ¥è¯¢ï¼‰</code>ï¼Œé€‚é…æ›´å¤šåœºæ™¯ï¼ˆå¦‚æŸ¥è¯¢æŸç‰‡åŒºå†…çš„é—¨åº—ï¼‰ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥ç‹åºœäº•2.0*2.0kmå†…çš„é—¨åº—ï¼ŒæŒ‰è·ç¦»æ’åºï¼Œè¿™é‡Œä»¥ ç‹åºœäº• ä¸ºçŸ©å½¢çš„ä¸­å¿ƒï¼ŒæŸ¥è¯¢2.0*2.0kmå†…çš„é—¨åº—</span></span><br><span class="line"><span class="comment"># è¥¿å•è·ç¦»ç‹åºœäº• 1.4681 kmï¼Œæ‰€ä»¥ä¸åœ¨ç»“æœä¸­</span></span><br><span class="line">GEOSEARCH shop FROMMEMBER wangfujing BYBOX 2.0 2.0 km WITHDIST WITHCOORD WITHHASH ASC COUNT 10</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">1) 1) <span class="string">&quot;wangfujing&quot;</span></span><br><span class="line">   2) <span class="string">&quot;0.0000&quot;</span></span><br><span class="line">   3) (<span class="built_in">integer</span>) 4069885555089518</span><br><span class="line">   4) 1) <span class="string">&quot;116.40396326780319214&quot;</span></span><br><span class="line">      2) <span class="string">&quot;39.91511209922290249&quot;</span></span><br></pre></td></tr></table></figure><h3 id="2-GEOSEARCHSTOREï¼ˆRedis-6-2-æ–°å¢ï¼‰">2. GEOSEARCHSTOREï¼ˆRedis 6.2+ æ–°å¢ï¼‰</h3><p>â—¦ ä½œç”¨ï¼šå°† GEOSEARCH çš„æŸ¥è¯¢ç»“æœï¼Œç›´æ¥å­˜å‚¨åˆ°æŒ‡å®šzsetä¸­ï¼Œæ–¹ä¾¿åç»­äºŒæ¬¡å¤„ç†ï¼ˆå¦‚åˆ†é¡µã€æ’åºï¼‰<br>â—¦ è¯­æ³•ï¼šGEOSEARCHSTORE ç›®æ ‡key æºkey æŸ¥è¯¢æ¡ä»¶ï¼ˆåŒGEOSEARCHï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GEOSEARCHSTORE destination <span class="built_in">source</span></span><br><span class="line">  &lt;FROMMEMBER member | FROMLONLAT longitude latitude&gt;</span><br><span class="line">  &lt;BYRADIUS radius &lt;M | KM | FT | MI&gt; | BYBOX width height &lt;M | KM | FT | MI&gt;&gt;</span><br><span class="line">  [ASC | DESC] [COUNT count [ANY]] [STOREDIST]</span><br></pre></td></tr></table></figure><p>â—¦ ç¤ºä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŠŠç‹åºœäº•3kmå†…çš„é—¨åº—ï¼Œå­˜åˆ°near_shopé›†åˆ</span></span><br><span class="line">GEOSEARCHSTORE near_shop shop FROMMEMBER wangfujing BYRADIUS 3 km</span><br></pre></td></tr></table></figure><h2 id="åº•å±‚æ ¸å¿ƒä¸å®æˆ˜æ³¨æ„äº‹é¡¹">åº•å±‚æ ¸å¿ƒä¸å®æˆ˜æ³¨æ„äº‹é¡¹</h2><ol><li class="lvl-3"><p>åº•å±‚æœ¬è´¨ï¼šæ‰€æœ‰Geoæ“ä½œçš„keyï¼Œæœ¬è´¨éƒ½æ˜¯zsetï¼Œå› æ­¤zsetçš„å‘½ä»¤ï¼ˆå¦‚ZREMã€ZSCOREï¼‰å¯ç›´æ¥ç”¨äºGeo keyï¼Œä¾‹å¦‚ ZREM shop xidan å¯åˆ é™¤è¥¿å•çš„åœ°ç†ä½ç½®ï¼ˆGeoæ— å•ç‹¬åˆ é™¤å‘½ä»¤ï¼Œä¾èµ–ZREMï¼‰ã€‚</p></li><li class="lvl-3"><p>ç²¾åº¦é™åˆ¶ï¼šç»çº¬åº¦æ”¯æŒå°æ•°ç‚¹åå¤šä½ï¼Œä½†Rediså†…éƒ¨ä¼šåšç²¾åº¦å–èˆï¼Œæ—¥å¸¸åœºæ™¯ï¼ˆå¦‚æ‰“è½¦ã€é—¨åº—ï¼‰å®Œå…¨å¤Ÿç”¨ï¼Œæ— éœ€é¢å¤–å¤„ç†ã€‚</p></li><li class="lvl-3"><p>æ€§èƒ½ä¼˜åŒ–ï¼šå¤§èŒƒå›´æŸ¥è¯¢ï¼ˆå¦‚100kmä»¥ä¸Šï¼‰å»ºè®®åŠ COUNTé™åˆ¶è¿”å›æ•°é‡ï¼›é«˜é¢‘æŸ¥è¯¢å¯å°†ç»“æœç¼“å­˜åˆ°æ™®é€škeyï¼Œå‡å°‘Geoè®¡ç®—å¼€é”€ã€‚</p></li><li class="lvl-3"><p>é€‚ç”¨åœºæ™¯ï¼šé™„è¿‘é—¨åº—ã€åŒåŸç¤¾äº¤ã€ç‰©æµå®šä½ï¼Œä¸é€‚ç”¨é«˜ç²¾åº¦åœºæ™¯ï¼ˆå¦‚å†›äº‹ã€æµ‹ç»˜ï¼‰ï¼Œæ­¤ç±»åœºæ™¯éœ€ç”¨ä¸“ä¸šGISç³»ç»Ÿã€‚</p></li></ol><h2 id="å…¸å‹å®æˆ˜åœºæ™¯ç¤ºä¾‹">å…¸å‹å®æˆ˜åœºæ™¯ç¤ºä¾‹</h2><ul class="lvl-0"><li class="lvl-2"><p>éœ€æ±‚ï¼šæ­å»ºâ€œé™„è¿‘é¤é¥®â€æŸ¥è¯¢åŠŸèƒ½ï¼Œæ”¯æŒæ·»åŠ é¤é¥®åæ ‡ã€æŸ¥è¯¢å½“å‰ä½ç½®3kmå†…é¤é¥®å¹¶æŒ‰è·ç¦»æ’åºã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. æ‰¹é‡æ·»åŠ é¤é¥®åæ ‡</span></span><br><span class="line">GEOADD restaurant 116.405 39.916 aaa 116.402 39.913 bbb 116.408 39.918 ccc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. æŸ¥å½“å‰ä½ç½®ï¼ˆ116.404,39.915ï¼‰3kmå†…é¤é¥®ï¼ˆå¸¦è·ç¦»ã€æ­£åºï¼‰</span></span><br><span class="line">GEOSEARCH restaurant FROMLONLAT 116.404 39.915 BYRADIUS 3 km WITHDIST ASC</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. åˆ é™¤æŸé¤é¥®</span></span><br><span class="line">ZREM restaurant aaa</span><br></pre></td></tr></table></figure><h2 id="Geo-å‘½ä»¤">Geo å‘½ä»¤</h2><ul class="lvl-0"><li class="lvl-2"><p>SpringBoot çš„ <code>StringRedisTemplate.opsForGeo()</code> ä¸­ Geo æ•°æ®ç±»å‹ çš„æ“ä½œæ–¹æ³•ä¸ Redis åŸç”Ÿå‘½ä»¤çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</p></li></ul><blockquote><p>æ³¨æ„è¿™é‡Œä¸€å®šè¦ç”¨ <code>StringRedisTemplate</code> æ¥æ“ä½œ Geo</p></blockquote><h3 id="å†™å…¥-åˆ é™¤ç±»æ“ä½œ">å†™å…¥ / åˆ é™¤ç±»æ“ä½œ</h3><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>æ·»åŠ å•ä¸ªåæ ‡</td><td><code>add(K key, Point point, M member)</code></td><td><code>GEOADD key longitude latitude member</code></td><td>è¿”å› <strong>æ–°å¢æˆå‘˜æ•°é‡</strong>ï¼ˆå·²å­˜åœ¨åˆ™è¿”å› 0ï¼‰</td></tr><tr><td>æ·»åŠ å•ä¸ªä½ç½®</td><td><code>add(K key, GeoLocation&lt;M&gt; location)</code></td><td><code>GEOADD key longitude latitude member</code></td><td><code>GeoLocation</code> å†…éƒ¨å°è£…äº† <code>Point + member</code></td></tr><tr><td>æ‰¹é‡æ·»åŠ </td><td><code>add(K key, Map&lt;M, Point&gt; map)</code></td><td><code>GEOADD key lon1 lat1 member1 [lon2 lat2 member2 ...]</code></td><td><strong>æ¨è</strong>ï¼Œä¸€æ¬¡ç½‘ç»œ IO</td></tr><tr><td>æ‰¹é‡æ·»åŠ </td><td><code>add(K key, Iterable&lt;GeoLocation&lt;M&gt;&gt; locations)</code></td><td><code>GEOADD key lon1 lat1 member1 [lon2 lat2 member2 ...]</code></td><td>ä¸ Map æ–¹å¼ç­‰ä»·</td></tr><tr><td>åˆ é™¤æˆå‘˜</td><td><code>remove(K key, M... members)</code></td><td><code>ZREM key member [member ...]</code></td><td>GEO æœ¬è´¨æ˜¯ <strong>Sorted Set</strong></td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Point</span> <span class="variable">point</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Point</span>(longitude, latitude);</span><br><span class="line">redisTemplate.opsForGeo().add(key, point, member);</span><br><span class="line"></span><br><span class="line">RedisGeoCommands.GeoLocation&lt;String&gt; geoLocation= <span class="keyword">new</span> <span class="title class_">RedisGeoCommands</span>.GeoLocation&lt;&gt;(member, point);</span><br><span class="line">redisTemplate.opsForGeo().add(key, geoLocation);</span><br></pre></td></tr></table></figure><h3 id="è·ç¦»-åæ ‡-å“ˆå¸ŒæŸ¥è¯¢">è·ç¦» / åæ ‡ / å“ˆå¸ŒæŸ¥è¯¢</h3><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>ä¸¤ç‚¹è·ç¦»</td><td><code>distance(K key, m1, m2)</code></td><td><code>GEODIST key m1 m2</code></td><td>é»˜è®¤å•ä½ç±³</td></tr><tr><td>æŒ‡å®šå•ä½è·ç¦»</td><td><code>distance(K key, m1, m2, metric)</code></td><td><code>GEODIST key m1 m2 unit</code></td><td>m / km / mi / ft</td></tr><tr><td>è·å– GeoHash</td><td><code>hash(K key, M... members)</code></td><td><code>GEOHASH key member</code></td><td>ç”¨äºè°ƒè¯•</td></tr><tr><td>è·å–åæ ‡</td><td><code>position(K key, M... members)</code></td><td><code>GEOPOS key member</code></td><td>lon / lat</td></tr></tbody></table><h3 id="åŠå¾„æŸ¥è¯¢ï¼ˆæ—§æ¥å£ï¼Œå·²ä¸æ¨èï¼‰">åŠå¾„æŸ¥è¯¢ï¼ˆæ—§æ¥å£ï¼Œå·²ä¸æ¨èï¼‰</h3><blockquote><p>Redis 6.2 èµ·ï¼Œå®˜æ–¹ä¸æ¨èç»§ç»­ä½¿ç”¨ GEORADIUS / GEORADIUSBYMEMBERï¼Œä½† Spring ä»ä¿ç•™æ¥å£ä»¥å…¼å®¹ã€‚</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>1ï¸âƒ£ åŸºäºåæ ‡ç‚¹</p></li></ul><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th></tr></thead><tbody><tr><td>åŠå¾„æŸ¥è¯¢</td><td><code>radius(K key, Circle within)</code></td><td><code>GEORADIUS key lon lat radius</code></td></tr><tr><td>åŠå¾„ + å‚æ•°</td><td><code>radius(K key, Circle within, args)</code></td><td><code>GEORADIUS</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>2ï¸âƒ£ åŸºäºæˆå‘˜</p></li></ul><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th></tr></thead><tbody><tr><td>åŠå¾„æŸ¥è¯¢</td><td><code>radius(K key, member, radius)</code></td><td><code>GEORADIUSBYMEMBER</code></td></tr><tr><td>æŒ‡å®šå•ä½</td><td><code>radius(K key, member, Distance)</code></td><td><code>GEORADIUSBYMEMBER</code></td></tr><tr><td>å¸¦å‚æ•°</td><td><code>radius(K key, member, Distance, args)</code></td><td><code>GEORADIUSBYMEMBER</code></td></tr></tbody></table><h3 id="æœç´¢æŸ¥è¯¢ï¼ˆæ¨èä½¿ç”¨-GEOSEARCHï¼‰">æœç´¢æŸ¥è¯¢ï¼ˆæ¨èä½¿ç”¨ GEOSEARCHï¼‰</h3><blockquote><p>æ›¿ä»£ GEORADIUS / GEORADIUSBYMEMBER</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>1ï¸âƒ£ æŒ‰åœ†å½¢èŒƒå›´æœç´¢</p></li></ul><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>åœ†å½¢æœç´¢</td><td><code>search(K key, Circle within)</code></td><td><code>GEOSEARCH</code></td><td>æ–°æ¨èæ¥å£</td></tr><tr><td>æŒ‡å®šå‚è€ƒç‚¹</td><td><code>search(K key, GeoReference, Distance)</code></td><td><code>GEOSEARCH</code></td><td>FROMMEMBER / FROMLONLAT</td></tr><tr><td>å¸¦å‚æ•°</td><td><code>search(K key, reference, radius, args)</code></td><td><code>GEOSEARCH</code></td><td>æ”¯æŒæ’åºã€limit</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>2ï¸âƒ£ æŒ‰çŸ©å½¢èŒƒå›´æœç´¢</p></li></ul><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th></tr></thead><tbody><tr><td>çŸ©å½¢æœç´¢</td><td><code>search(K key, reference, BoundingBox)</code></td><td><code>GEOSEARCH</code></td></tr><tr><td>å¸¦å‚æ•°</td><td><code>search(K key, reference, BoundingBox, args)</code></td><td><code>GEOSEARCH</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>é€šç”¨æœç´¢ï¼ˆåº•å±‚èƒ½åŠ›ï¼‰</p></li></ul><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th></tr></thead><tbody><tr><td>ä»»æ„ GeoShape</td><td><code>search(K key, reference, GeoShape, args)</code></td><td><code>GEOSEARCH</code></td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸºäºç»™å®šçš„åæ ‡æœç´¢</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">search</span><span class="params">(String key, <span class="type">double</span> longitude, <span class="type">double</span> latitude, <span class="type">double</span> radius)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸­å¿ƒç‚¹</span></span><br><span class="line">    <span class="type">Point</span> <span class="variable">point</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Point</span>(longitude, latitude);</span><br><span class="line">    <span class="comment">// åŠå¾„</span></span><br><span class="line">    <span class="type">Distance</span> <span class="variable">distance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Distance</span>(radius, RedisGeoCommands.DistanceUnit.METERS);</span><br><span class="line">    <span class="comment">// åˆ›å»ºåœ†å½¢</span></span><br><span class="line">    <span class="type">Circle</span> <span class="variable">circle</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Circle</span>(point, distance);</span><br><span class="line">    <span class="comment">// åˆ›å»ºåœ°ç†å‚è€ƒ</span></span><br><span class="line">    GeoReference&lt;String&gt; objectGeoReference = GeoReference.fromCircle(circle);</span><br><span class="line">    <span class="comment">// åˆ›å»ºåœ°ç†å½¢çŠ¶</span></span><br><span class="line">    <span class="type">GeoShape</span> <span class="variable">geoShape</span> <span class="operator">=</span> GeoShape.byRadius(distance);</span><br><span class="line">    <span class="comment">// åˆ›å»ºå‚æ•°</span></span><br><span class="line">    RedisGeoCommands.<span class="type">GeoRadiusCommandArgs</span> <span class="variable">args</span> <span class="operator">=</span> RedisGeoCommands.GeoRadiusCommandArgs.newGeoRadiusArgs()</span><br><span class="line">            .includeCoordinates() <span class="comment">// è¿”å›åæ ‡</span></span><br><span class="line">            .includeDistance() <span class="comment">// è¿”å›è·ç¦»</span></span><br><span class="line">            .sortAscending() <span class="comment">// æ’åº</span></span><br><span class="line">            .limit(<span class="number">10</span>); <span class="comment">// é™åˆ¶è¿”å›æ•°é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŸ¥è¯¢</span></span><br><span class="line">    <span class="keyword">final</span> GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; results = redisTemplate.opsForGeo().search(key, objectGeoReference, geoShape, args);</span><br><span class="line">    <span class="keyword">if</span> (results != <span class="literal">null</span>) &#123;</span><br><span class="line">        results.forEach(result -&gt; &#123;</span><br><span class="line">            <span class="comment">// è·å–æˆå‘˜åç§°</span></span><br><span class="line">            System.out.println(result.getContent().getName());</span><br><span class="line">            <span class="comment">// è·å–åæ ‡</span></span><br><span class="line">            System.out.println(result.getContent().getPoint());</span><br><span class="line">            <span class="comment">// è·å–è·ç¦»</span></span><br><span class="line">            System.out.println(result.getDistance());</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŸºäºæˆå‘˜çš„åæ ‡æœç´¢</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">search</span><span class="params">(String key, String member, <span class="type">double</span> radius)</span> &#123;</span><br><span class="line">    <span class="comment">// åŠå¾„</span></span><br><span class="line">    <span class="type">Distance</span> <span class="variable">distance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Distance</span>(radius, RedisGeoCommands.DistanceUnit.METERS);</span><br><span class="line">    <span class="comment">// åˆ›å»ºåœ°ç†å‚è€ƒ</span></span><br><span class="line">    GeoReference&lt;String&gt; objectGeoReference = GeoReference.fromMember(member);</span><br><span class="line">    <span class="comment">// åˆ›å»ºåœ°ç†å½¢çŠ¶</span></span><br><span class="line">    <span class="type">GeoShape</span> <span class="variable">geoShape</span> <span class="operator">=</span> GeoShape.byRadius(distance);</span><br><span class="line">    <span class="comment">// åˆ›å»ºå‚æ•°</span></span><br><span class="line">    RedisGeoCommands.<span class="type">GeoRadiusCommandArgs</span> <span class="variable">args</span> <span class="operator">=</span> RedisGeoCommands.GeoRadiusCommandArgs.newGeoRadiusArgs()</span><br><span class="line">            .includeCoordinates() <span class="comment">// è¿”å›åæ ‡</span></span><br><span class="line">            .includeDistance() <span class="comment">// è¿”å›è·ç¦»</span></span><br><span class="line">            .sortAscending() <span class="comment">// æ’åº</span></span><br><span class="line">            .limit(<span class="number">10</span>); <span class="comment">// é™åˆ¶è¿”å›æ•°é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŸ¥è¯¢</span></span><br><span class="line">    <span class="keyword">final</span> GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; results = redisTemplate.opsForGeo().search(key, objectGeoReference, geoShape, args);</span><br><span class="line">    <span class="keyword">if</span> (results != <span class="literal">null</span>) &#123;</span><br><span class="line">        results.forEach(result -&gt; &#123;</span><br><span class="line">            <span class="comment">// è·å–æˆå‘˜åç§°</span></span><br><span class="line">            System.out.println(result.getContent().getName());</span><br><span class="line">            <span class="comment">// è·å–åæ ‡</span></span><br><span class="line">            System.out.println(result.getContent().getPoint());</span><br><span class="line">            <span class="comment">// è·å–è·ç¦»</span></span><br><span class="line">            System.out.println(result.getDistance());</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="æœç´¢å¹¶å­˜å‚¨ï¼ˆGEOSEARCHSTOREï¼‰">æœç´¢å¹¶å­˜å‚¨ï¼ˆGEOSEARCHSTOREï¼‰</h3><blockquote><p>è¿™æ˜¯ æœç´¢ + å†™å…¥ çš„ç»„åˆæ“ä½œï¼Œç»“æœä¼šå†™å…¥æ–°çš„ ZSet</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>1ï¸âƒ£ åœ†å½¢èŒƒå›´å­˜å‚¨</p></li></ul><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th></tr></thead><tbody><tr><td>æœç´¢å¹¶å­˜å‚¨</td><td><code>searchAndStore(K key, destKey, Circle)</code></td><td><code>GEOSEARCHSTORE</code></td></tr><tr><td>æŒ‡å®šå‚è€ƒç‚¹</td><td><code>searchAndStore(K key, destKey, reference, radius)</code></td><td><code>GEOSEARCHSTORE</code></td></tr><tr><td>å¸¦å‚æ•°</td><td><code>searchAndStore(K key, destKey, reference, radius, args)</code></td><td><code>GEOSEARCHSTORE</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>2ï¸âƒ£ çŸ©å½¢èŒƒå›´å­˜å‚¨</p></li></ul><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th></tr></thead><tbody><tr><td>çŸ©å½¢å­˜å‚¨</td><td><code>searchAndStore(K key, destKey, reference, BoundingBox)</code></td><td><code>GEOSEARCHSTORE</code></td></tr><tr><td>å¸¦å‚æ•°</td><td><code>searchAndStore(K key, destKey, reference, BoundingBox, args)</code></td><td><code>GEOSEARCHSTORE</code></td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>3ï¸âƒ£ é€šç”¨ GeoShape å­˜å‚¨</p></li></ul><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th></tr></thead><tbody><tr><td>é€šç”¨å­˜å‚¨</td><td><code>searchAndStore(K key, destKey, reference, GeoShape, args)</code></td><td><code>GEOSEARCHSTORE</code></td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡ä»‹ç» Redis Geo æ•°æ®ç±»å‹&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡åŸºäº&lt;code&gt;redis-7.4.7&lt;/code&gt;ï¼Œ&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Rediså®˜ç½‘ï¼š&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis å‘½ä»¤æ–‡æ¡£ï¼š&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis å‘½ä»¤åŠæ•°æ®ç±»å‹ -- Hyperloglog</title>
    <link href="https://blog.hanqunfeng.com/2025/12/19/redis7-datatype-08-hyperloglog/"/>
    <id>https://blog.hanqunfeng.com/2025/12/19/redis7-datatype-08-hyperloglog/</id>
    <published>2025-12-19T13:30:05.000Z</published>
    <updated>2025-12-20T05:57:19.021Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2">æœ¬æ–‡ä»‹ç» Redis Hyperloglog æ•°æ®ç±»å‹</li><li class="lvl-2">æœ¬æ–‡åŸºäº<code>redis-7.4.7</code>ï¼Œ<code>springboot-3.5.8</code></li><li class="lvl-2">Rediså®˜ç½‘ï¼š<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis å‘½ä»¤æ–‡æ¡£ï¼š<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li></ul><span id="more"></span><h2 id="Hyperloglog-æ ¸å¿ƒè¯¦è§£">Hyperloglog æ ¸å¿ƒè¯¦è§£</h2><ul class="lvl-0"><li class="lvl-2"><p>Redis HyperLogLog æ˜¯ä¸“é—¨ç”¨äºåšåŸºæ•°ç»Ÿè®¡çš„é«˜çº§æ•°æ®ç±»å‹ï¼Œæ ¸å¿ƒä¼˜åŠ¿æ˜¯ç”¨æå°çš„å†…å­˜ï¼ˆå›ºå®šçº¦ <code>12KB</code>ï¼‰å°±èƒ½ç»Ÿè®¡æµ·é‡æ•°æ®çš„åŸºæ•°ï¼Œè¯¯å·®ç‡ä»… <code>0.81%</code>ï¼Œæ— éœ€å­˜å‚¨å…¨éƒ¨æ•°æ®æœ¬èº«ã€‚</p></li></ul><blockquote><p>åŸºæ•°ï¼šæŒ‡é›†åˆä¸­ä¸é‡å¤å…ƒç´ çš„æ•°é‡ï¼ˆæ¯”å¦‚ç»Ÿè®¡ UVï¼Œå°±æ˜¯ä¸é‡å¤è®¿å®¢çš„æ•°é‡ï¼‰ã€‚</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>Redis Hyperloglog å¹¶éç‹¬ç«‹æ•°æ®ç±»å‹ï¼Œè€Œæ˜¯åŸºäº String ç±»å‹çš„ä½æ“ä½œæ‰©å±•</p></li></ul><h2 id="æ ¸å¿ƒä½¿ç”¨æ–¹å¼ï¼ˆ3ä¸ªæ ¸å¿ƒå‘½ä»¤ï¼‰">æ ¸å¿ƒä½¿ç”¨æ–¹å¼ï¼ˆ3ä¸ªæ ¸å¿ƒå‘½ä»¤ï¼‰</h2><ul class="lvl-0"><li class="lvl-2"><p>HyperLogLog å‘½ä»¤æç®€ï¼Œåªæœ‰ 3 ä¸ªæ ¸å¿ƒæ“ä½œ</p></li></ul><h3 id="PFADD">PFADD</h3><ul class="lvl-0"><li class="lvl-2"><p>å‘ HyperLogLog ä¸­æ·»åŠ 1ä¸ªæˆ–å¤šä¸ªå…ƒç´ ï¼ŒæˆåŠŸæ·»åŠ ï¼ˆå…ƒç´ æœªå­˜åœ¨ï¼‰è¿”å›1ï¼Œå¦åˆ™è¿”å›0ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PFADD key [element [element ...]]</span><br></pre></td></tr></table></figure><h3 id="PFCOUNT">PFCOUNT</h3><ul class="lvl-0"><li class="lvl-2"><p>ç»Ÿè®¡å•ä¸ª/å¤šä¸ª HyperLogLog çš„åŸºæ•°ï¼ˆå»é‡æ€»æ•°ï¼‰ï¼Œå¤š key ä¼ å…¥æ—¶ä¼šè®¡ç®—æ‰€æœ‰ key çš„å¹¶é›†åŸºæ•°ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PFCOUNT key [key ...]</span><br></pre></td></tr></table></figure><h3 id="PFMERGE">PFMERGE</h3><ul class="lvl-0"><li class="lvl-2"><p>å°†å¤šä¸ªæº HyperLogLog åˆå¹¶ä¸º1ä¸ªç›®æ ‡ HyperLogLogï¼Œé€‚ç”¨äºè·¨ç»´åº¦æ±‡æ€»ç»Ÿè®¡ï¼ˆæ¯”å¦‚åˆå¹¶ä»Šæ—¥ã€æ˜¨æ—¥çš„ UV å¾—åˆ°ä¸¤æ—¥æ€» UVï¼‰ã€‚</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PFMERGE destkey [sourcekey [sourcekey ...]]</span><br></pre></td></tr></table></figure><h2 id="å®æ“ç¤ºä¾‹">å®æ“ç¤ºä¾‹</h2><h3 id="ç¤ºä¾‹1ï¼šå•-key-åŸºç¡€ç»Ÿè®¡ï¼ˆç»Ÿè®¡ç½‘ç«™-UVï¼‰">ç¤ºä¾‹1ï¼šå• key åŸºç¡€ç»Ÿè®¡ï¼ˆç»Ÿè®¡ç½‘ç«™ UVï¼‰</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. æ¨¡æ‹Ÿ3ä¸ªè®¿å®¢è®¿é—®ï¼Œå…¶ä¸­ç”¨æˆ·Aé‡å¤è®¿é—®</span></span><br><span class="line">127.0.0.1:6379&gt; PFADD uv:20251218 userA userB userC</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; PFADD uv:20251218 userA</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. ç»Ÿè®¡å½“æ—¥UVï¼ˆå»é‡åæ˜¯3ï¼Œå¿½ç•¥é‡å¤çš„userAï¼‰</span></span><br><span class="line">127.0.0.1:6379&gt; PFCOUNT uv:20251218</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br></pre></td></tr></table></figure><h3 id="ç¤ºä¾‹2ï¼š-å¤š-key-åˆå¹¶ä¸æ±‡æ€»ç»Ÿè®¡">ç¤ºä¾‹2ï¼š å¤š key åˆå¹¶ä¸æ±‡æ€»ç»Ÿè®¡</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. åˆ†åˆ«ç»Ÿè®¡12.17å’Œ12.18çš„UV</span></span><br><span class="line">127.0.0.1:6379&gt; PFADD uv:20251217 userA userD</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; PFADD uv:20251218 userA userB userC</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. åˆå¹¶ä¸¤æ—¥UVåˆ° uv:20251217_18</span></span><br><span class="line">127.0.0.1:6379&gt; PFMERGE uv:20251217_18 uv:20251217 uv:20251218</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. ç»Ÿè®¡ä¸¤æ—¥æ€»UVï¼ˆå¹¶é›†å»é‡ï¼Œç»“æœä¸º4ï¼šuserAã€Bã€Cã€Dï¼‰</span></span><br><span class="line">127.0.0.1:6379&gt; PFCOUNT uv:20251217_18</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br></pre></td></tr></table></figure><h2 id="æ ¸å¿ƒåº”ç”¨åœºæ™¯ï¼ˆç²¾å‡†è½åœ°åœºæ™¯ï¼‰">æ ¸å¿ƒåº”ç”¨åœºæ™¯ï¼ˆç²¾å‡†è½åœ°åœºæ™¯ï¼‰</h2><ul class="lvl-0"><li class="lvl-2"><p>HyperLogLog åªå…³æ³¨ <strong>â€œå»é‡æ•°é‡â€</strong>ï¼Œä¸å…³æ³¨â€œå…·ä½“å…ƒç´ æ˜¯è°â€ï¼Œé€‚åˆä»¥ä¸‹é«˜é¢‘åœºæ™¯ï¼Œä¹Ÿæ˜¯ä¼ä¸šçº§å¸¸ç”¨æ–¹æ¡ˆï¼š</p></li></ul><ol><li class="lvl-3"><p>ç½‘ç«™/APP UV ç»Ÿè®¡ï¼šæ›¿ä»£ä¼ ç»Ÿçš„ Set å­˜å‚¨ï¼ˆSet å­˜æµ·é‡ UV å†…å­˜å ç”¨æé«˜ï¼‰ï¼Œå• key ä»… 12KBï¼Œè½»æ¾ç»Ÿè®¡ç™¾ä¸‡/åƒä¸‡çº§ UVã€‚</p></li><li class="lvl-3"><p>ä¸šåŠ¡åœºæ™¯å»é‡è®¡æ•°ï¼šæ¯”å¦‚ç»Ÿè®¡å•æ—¥/å•æœˆçš„ç‹¬ç«‹æ”¯ä»˜ç”¨æˆ·æ•°ã€ç‹¬ç«‹ä¸‹å•ç”¨æˆ·æ•°ã€ç‹¬ç«‹ç‚¹å‡»å•†å“çš„ç”¨æˆ·æ•°ã€‚</p></li><li class="lvl-3"><p>æµ·é‡æ•°æ®å»é‡ç»Ÿè®¡ï¼šæ¯”å¦‚ç»Ÿè®¡æŸæ¥å£çš„ç‹¬ç«‹è°ƒç”¨ IP æ•°ã€æŸç›´æ’­é—´çš„ç‹¬ç«‹è§‚çœ‹äººæ•°ã€æŸå¹¿å‘Šçš„ç‹¬ç«‹æ›å…‰æ•°ã€‚</p></li><li class="lvl-3"><p>è·¨ç»´åº¦æ±‡æ€»ç»Ÿè®¡ï¼šæ¯”å¦‚åˆå¹¶ä¸åŒæ¸ é“ï¼ˆAPPã€å°ç¨‹åºã€H5ï¼‰çš„ç‹¬ç«‹è®¿å®¢æ•°ï¼Œå¾—åˆ°å…¨æ¸ é“æ€»è®¿å®¢æ•°ã€‚</p></li></ol><h2 id="å…³é”®æ³¨æ„äº‹é¡¹ï¼ˆé¿å‘é‡ç‚¹ï¼‰">å…³é”®æ³¨æ„äº‹é¡¹ï¼ˆé¿å‘é‡ç‚¹ï¼‰</h2><ol><li class="lvl-3"><p>ä¸å­˜å‚¨å…·ä½“å…ƒç´ ï¼Œä»…å­˜ç»Ÿè®¡ç»“æœï¼šæ— æ³•åƒ Set é‚£æ ·è·å–é›†åˆä¸­çš„å…·ä½“å…ƒç´ ï¼ˆæ¯”å¦‚æ— æ³•é€šè¿‡ HyperLogLog æŸ¥åˆ°å…·ä½“æ˜¯å“ªäº›ç”¨æˆ·è®¿é—®äº†ç½‘ç«™ï¼‰ï¼Œåªå…³å¿ƒâ€œæœ‰å¤šå°‘ä¸ªâ€ï¼Œä¸å…³å¿ƒâ€œæ˜¯è°â€ã€‚</p></li><li class="lvl-3"><p>è¯¯å·®ä¸å¯é¿å…ï¼Œå¯æ§ä¸å½±å“å¤§éƒ¨åˆ†åœºæ™¯ï¼šå›ºå®šè¯¯å·®ç‡ <code>0.81%</code>ï¼Œæ•°æ®é‡è¶Šå¤§è¯¯å·®è¶Šç¨³å®šï¼ŒUVã€ç‹¬ç«‹ç”¨æˆ·æ•°ç­‰åœºæ™¯å¯¹ç²¾åº¦è¦æ±‚ä¸é«˜ï¼Œå®Œå…¨å¤Ÿç”¨ï¼›è‹¥éœ€ 100% ç²¾å‡†ï¼ˆæ¯”å¦‚ç»Ÿè®¡æ ¸å¿ƒäº¤æ˜“ç”¨æˆ·æ•°ï¼‰ï¼Œéœ€ç”¨ Set æˆ– Hash å®ç°ã€‚</p></li><li class="lvl-3"><p>å†…å­˜å ç”¨å›ºå®šï¼Œä¸æ•°æ®é‡æ— å…³ï¼šæ— è®ºç»Ÿè®¡ 10 ä¸ªè¿˜æ˜¯ 1 äº¿ä¸ªå…ƒç´ ï¼Œå•ä¸ª HyperLogLog å ç”¨å†…å­˜çº¦ <code>12KB</code>ï¼Œè¿™æ˜¯å…¶æ ¸å¿ƒä¼˜åŠ¿ï¼Œä¹Ÿæ˜¯åŒºåˆ«äº Set çš„å…³é”®ã€‚</p></li><li class="lvl-3"><p>å…ƒç´ æ”¯æŒå­—ç¬¦ä¸²ç±»å‹ï¼šPFADD ä¼ å…¥çš„å…ƒç´ å¿…é¡»æ˜¯å­—ç¬¦ä¸²/å­—èŠ‚ç±»å‹ï¼Œä¸æ”¯æŒå…¶ä»–æ•°æ®ç±»å‹ï¼ˆå¦‚æ•°å­—ã€åˆ—è¡¨ç­‰ï¼Œéœ€æ‰‹åŠ¨è½¬ä¸ºå­—ç¬¦ä¸²ï¼‰ã€‚</p></li><li class="lvl-3"><p>è¿‡æœŸæ—¶é—´æ”¯æŒï¼šHyperLogLog æœ¬èº«ä¸è‡ªå¸¦è¿‡æœŸæœºåˆ¶ï¼Œä½†å¯é€šè¿‡ <code>EXPIRE key seconds</code> ç»™å…¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆæ¯”å¦‚ UV ç»Ÿè®¡æŒ‰æ—¥è¿‡æœŸï¼Œé¿å…å†…å­˜å †ç§¯ï¼‰ã€‚</p></li><li class="lvl-3"><p>PFADD å¹‚ç­‰æ€§ï¼šé‡å¤æ·»åŠ åŒä¸€å…ƒç´ ï¼Œä¸ä¼šæ”¹å˜åŸºæ•°ç»“æœï¼Œä¹Ÿä¸ä¼šé¢å¤–å ç”¨å†…å­˜ï¼Œå¯æ”¾å¿ƒé‡å¤è°ƒç”¨ã€‚</p></li></ol><h2 id="ä¸-Set-ç»Ÿè®¡åŸºæ•°çš„å¯¹æ¯”ï¼ˆé€‰å‹å‚è€ƒï¼‰">ä¸ Set ç»Ÿè®¡åŸºæ•°çš„å¯¹æ¯”ï¼ˆé€‰å‹å‚è€ƒï¼‰</h2><table><thead><tr><th>å¯¹æ¯”ç»´åº¦</th><th>HyperLogLog</th><th>Set</th></tr></thead><tbody><tr><td>æ•°æ®ç»“æ„ç±»å‹</td><td>åŸºæ•°ç»Ÿè®¡ç»“æ„</td><td>æ— åºé›†åˆ</td></tr><tr><td>å†…å­˜å ç”¨</td><td>å›ºå®šçº¦ <strong>12KB</strong>ï¼Œä¸æ•°æ®é‡æ— å…³</td><td>éšå…ƒç´ æ•°é‡çº¿æ€§å¢é•¿ï¼Œæµ·é‡æ•°æ®å†…å­˜å ç”¨æé«˜</td></tr><tr><td>ç»Ÿè®¡ç»“æœç²¾åº¦</td><td><strong>éç²¾å‡†</strong>ï¼Œæ ‡å‡†è¯¯å·®çº¦ <strong>0.81%</strong></td><td><strong>100% ç²¾å‡†</strong></td></tr><tr><td>æ˜¯å¦æ”¯æŒè·å–å…·ä½“å…ƒç´ </td><td>ä¸æ”¯æŒ</td><td>æ”¯æŒï¼ˆå¦‚ <code>SMEMBERS</code>ï¼‰</td></tr><tr><td>æ˜¯å¦æ”¯æŒå»é‡</td><td>æ”¯æŒï¼ˆåŸºæ•°å»é‡ï¼‰</td><td>æ”¯æŒï¼ˆå…ƒç´ çº§å»é‡ï¼‰</td></tr><tr><td>ç»Ÿè®¡æ€§èƒ½</td><td>æå¿«ï¼ˆå›ºå®šè®¡ç®—é€»è¾‘ï¼ŒO(1)ï¼‰</td><td>æ•°æ®é‡è¶Šå¤§ï¼Œç»Ÿè®¡ä¸éå†æˆæœ¬è¶Šé«˜</td></tr><tr><td>é€‚åˆæ•°æ®è§„æ¨¡</td><td>è¶…å¤§è§„æ¨¡ï¼ˆç™¾ä¸‡ / åƒä¸‡ / äº¿çº§ï¼‰</td><td>ä¸­å°è§„æ¨¡é›†åˆ</td></tr><tr><td>å¸¸è§ä½¿ç”¨åœºæ™¯</td><td>UV / DAU ç»Ÿè®¡ã€ç‹¬ç«‹ IP æ•°ã€è®¿é—®ç”¨æˆ·æ•°</td><td>å¥½å‹åˆ—è¡¨ã€æ ‡ç­¾é›†åˆã€å…³æ³¨åˆ—è¡¨</td></tr><tr><td>æ˜¯å¦å¯åšé›†åˆè¿ç®—</td><td>ä¸æ”¯æŒ</td><td>æ”¯æŒï¼ˆ<code>SUNION</code> / <code>SINTER</code> / <code>SDIFF</code>ï¼‰</td></tr><tr><td>æ˜¯å¦å¯åºåˆ—åŒ–/æŒä¹…åŒ–</td><td>å¯ï¼ˆRedis å†…éƒ¨ç»“æ„ï¼‰</td><td>å¯</td></tr><tr><td>é€‰å‹ç»“è®º</td><td><strong>ä½æˆæœ¬ + æµ·é‡æ•°æ® + å¯æ¥å—è¯¯å·®çš„åŸºæ•°ç»Ÿè®¡</strong></td><td><strong>ç²¾å‡†ç»Ÿè®¡ + éœ€è¦å…ƒç´ æ˜ç»†çš„åœºæ™¯</strong></td></tr></tbody></table><h2 id="HyperLogLog-å‘½ä»¤">HyperLogLog å‘½ä»¤</h2><ul class="lvl-0"><li class="lvl-2"><p>SpringBoot çš„ <code>StringRedisTemplate.opsForHyperLogLog()</code> ä¸­ HyperLogLog æ•°æ®ç±»å‹ çš„æ“ä½œæ–¹æ³•ä¸ Redis åŸç”Ÿå‘½ä»¤çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</p></li></ul><blockquote><p>æ³¨æ„è¿™é‡Œä¸€å®šè¦ç”¨ <code>StringRedisTemplate</code> æ¥æ“ä½œ HyperLogLog</p></blockquote><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th><th>å¤‡æ³¨ / ä½¿ç”¨å»ºè®®</th></tr></thead><tbody><tr><td>æ·»åŠ å…ƒç´ </td><td><code>Long add(K key, V... values)</code></td><td><code>PFADD key element [element ...]</code></td><td>è¿”å› 1 è¡¨ç¤º HLL ç»“æ„å‘ç”Ÿå˜åŒ–</td></tr><tr><td>è·å–åŸºæ•°ï¼ˆå»é‡æ•°ï¼‰</td><td><code>Long size(K... keys)</code></td><td><code>PFCOUNT key [key ...]</code></td><td>æ”¯æŒå¤š key åˆå¹¶ç»Ÿè®¡</td></tr><tr><td>åˆå¹¶ HLL</td><td><code>Long union(K destination, K... sourceKeys)</code></td><td><code>PFMERGE destkey sourcekey [sourcekey ...]</code></td><td>åˆå¹¶åå†™å…¥ destkey</td></tr><tr><td>åˆ é™¤ HLL</td><td><code>void delete(K key)</code></td><td><code>DEL key</code></td><td>ç›´æ¥åˆ é™¤æ•´ä¸ª HLL</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡ä»‹ç» Redis Hyperloglog æ•°æ®ç±»å‹&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡åŸºäº&lt;code&gt;redis-7.4.7&lt;/code&gt;ï¼Œ&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Rediså®˜ç½‘ï¼š&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis å‘½ä»¤æ–‡æ¡£ï¼š&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis å‘½ä»¤åŠæ•°æ®ç±»å‹ -- Bitfield</title>
    <link href="https://blog.hanqunfeng.com/2025/12/18/redis7-datatype-07-bitfield/"/>
    <id>https://blog.hanqunfeng.com/2025/12/18/redis7-datatype-07-bitfield/</id>
    <published>2025-12-18T13:30:06.000Z</published>
    <updated>2025-12-24T02:43:10.965Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2">æœ¬æ–‡ä»‹ç» Redis Bitfield æ•°æ®ç±»å‹</li><li class="lvl-2">æœ¬æ–‡åŸºäº<code>redis-7.4.7</code>ï¼Œ<code>springboot-3.5.8</code></li><li class="lvl-2">Rediså®˜ç½‘ï¼š<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis å‘½ä»¤æ–‡æ¡£ï¼š<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li></ul><span id="more"></span><h2 id="Bitfield-æ ¸å¿ƒè¯¦è§£">Bitfield æ ¸å¿ƒè¯¦è§£</h2><p>â€¢ BITFIELD æ˜¯ Redis ç”¨äºæŠŠä¸€ä¸ª å­—ç¬¦ä¸²å€¼è§†ä¸ºä¸€ä¸ªç”±äºŒè¿›åˆ¶â€œä½æ•°ç»„â€ç»„æˆçš„å­˜å‚¨åŒºï¼Œå¹¶å¯¹å…¶ä¸­ä»»æ„æŒ‡å®šä½ç½®çš„æ•´æ•°åŸŸè¿›è¡Œè¯»å–ã€å†™å…¥ã€è‡ªå¢ç­‰æ“ä½œçš„å‘½ä»¤ã€‚<br>â€¢ è¿™äº›æ•´æ•°åŸŸå¯ä»¥æ˜¯ä»»æ„ä½å®½ï¼ˆä¾‹å¦‚ 1 ä½ã€4 ä½ã€8 ä½ã€31 ä½ã€63 ä½ç­‰ï¼‰ï¼Œå¯æŒ‡å®šä¸ºæœ‰ç¬¦å·ï¼ˆsignedï¼‰æˆ–æ— ç¬¦å·ï¼ˆunsignedï¼‰ã€‚</p><h2 id="Bitfield-å‘½ä»¤">Bitfield å‘½ä»¤</h2><h3 id="1-BITFIELD-æ‰¹é‡æ“ä½œ">1. <code>BITFIELD</code> æ‰¹é‡æ“ä½œ</h3><p>â€¢ BITFIELD å‘½ä»¤æ”¯æŒåœ¨ä¸€æ¬¡è°ƒç”¨ä¸­æ‰§è¡Œå¤šä¸ªæ“ä½œï¼Œå¹¶å°†ç»“æœæŒ‰æ“ä½œé¡ºåºè¿”å›ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">BITFIELD key [GET encoding offset | [OVERFLOW &lt;WRAP | SAT | FAIL&gt;]</span><br><span class="line">  &lt;SET encoding offset value | INCRBY encoding offset increment&gt;</span><br><span class="line">  [GET encoding offset | [OVERFLOW &lt;WRAP | SAT | FAIL&gt;]</span><br><span class="line">  &lt;SET encoding offset value | INCRBY encoding offset increment&gt;</span><br><span class="line">  ...]]</span><br></pre></td></tr></table></figure><p>â€¢ å‚æ•°è¯´æ˜ï¼ˆæ ¸å¿ƒéƒ¨åˆ†ï¼‰</p><table><thead><tr><th>å‚æ•°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td><strong>key</strong></td><td>æ“ä½œçš„ Redis å­—ç¬¦ä¸²é”®</td></tr><tr><td><strong>GET encoding offset</strong></td><td>ä»æŒ‡å®šä½åç§»é‡è¯»å–ä¸€ä¸ªæ•´æ•°</td></tr><tr><td><strong>SET encoding offset value</strong></td><td>åœ¨æŒ‡å®šä½ç½®å†™å…¥æ•´æ•°</td></tr><tr><td><strong>INCRBY encoding offset increment</strong></td><td>åœ¨æŒ‡å®šä½ç½®å¯¹æ•´æ•°åšå¢é‡æ“ä½œ</td></tr><tr><td><strong>OVERFLOW WRAP/SAT/FAIL</strong></td><td>é…ç½®éšåçš„ç®—æ•°æ“ä½œæº¢å‡ºè¡Œä¸º</td></tr></tbody></table><p>â€¢ æ•°æ®ç±»å‹ï¼ˆencodingï¼‰:ç”¨äºæŒ‡å®šæ•´æ•°çš„ä½å®½å’Œç¬¦å·ç±»å‹</p><table><thead><tr><th>å‰ç¼€</th><th>å«ä¹‰</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td><code>u&lt;number&gt;</code></td><td>æ— ç¬¦å·æ•´æ•°ï¼ˆunsignedï¼‰ï¼Œå ä½ bits = number</td><td>u5 â€” 5 ä½æ— ç¬¦å·æ•´æ•°</td></tr><tr><td><code>i&lt;number&gt;</code></td><td>æœ‰ç¬¦å·æ•´æ•°ï¼ˆsignedï¼‰ï¼Œå ä½ bits = number</td><td>i10 â€” 10 ä½æœ‰ç¬¦å·æ•´æ•°</td></tr></tbody></table><p>â€¢ æº¢å‡ºï¼ˆOVERFLOWï¼‰:é»˜è®¤ç®—æ•°æ“ä½œä¸­å¯èƒ½å‘ç”Ÿæº¢å‡ºï¼ŒOVERFLOW å…è®¸ä½ æ§åˆ¶å¤„ç†ç­–ç•¥ã€‚æ³¨æ„ï¼Œè¿™éƒ¨åˆ†å¿…é¡»åœ¨åç»­çš„ SET/INCRBY æ“ä½œä¹‹å‰æŒ‡å®šã€‚</p><table><thead><tr><th>ç­–ç•¥</th><th>è¡Œä¸º</th></tr></thead><tbody><tr><td><strong>WRAP</strong></td><td>ç¯ç»•ï¼ˆé»˜è®¤ï¼‰æº¢å‡ºæŒ‰ç¯å½¢è®¡æ•°å¤„ç†</td></tr><tr><td><strong>SAT</strong></td><td>é¥±å’Œï¼Œåœ¨è¾¹ç•Œå€¼ä¿æŒæœ€å¤§/æœ€å°</td></tr><tr><td><strong>FAIL</strong></td><td>æº¢å‡ºæ—¶æ“ä½œå¤±è´¥å¹¶è¿”å›é”™è¯¯</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 4 ä½æ— ç¬¦å·æ•´æ•°åŠ  1 æ—¶ï¼Œå¦‚æœè¶…è¿‡ 15ï¼Œåˆ™ä¿æŒ 15ï¼ˆé¥±å’Œï¼‰ã€‚</span></span><br><span class="line">BITFIELD key OVERFLOW SAT INCRBY u4 0 1</span><br></pre></td></tr></table></figure><p>â€¢ è¿”å›å€¼: BITFIELD ä¼šä¸ºæ¯ä¸ªå­å‘½ä»¤è¿”å›ä¸€ä¸ªæ•´æ•°æ•°ç»„ï¼Œæ•°ç»„å„å…ƒç´ æŒ‰æ“ä½œé¡ºåºå¯¹åº”æ‰§è¡Œç»“æœ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BITFIELD mykey INCRBY i5 100 1 GET u4 0</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 1</span><br><span class="line">2) (<span class="built_in">integer</span>) 0</span><br></pre></td></tr></table></figure><h3 id="2-BITFIELD-RO-æ‰¹é‡åªè¯»">2. <code>BITFIELD_RO</code> æ‰¹é‡åªè¯»</h3><ul class="lvl-0"><li class="lvl-2"><p>Redis 6.0 æ–°å¢çš„åªè¯»ç‰ˆæœ¬ï¼Œç”¨äºæ‰¹é‡åªè¯»</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BITFIELD_RO key [GET encoding offset [GET encoding offset ...]]</span><br></pre></td></tr></table></figure><h2 id="ç»¼åˆç¤ºä¾‹">ç»¼åˆç¤ºä¾‹</h2><h3 id="ç¤ºä¾‹-1-è®¾ç½®å¹¶è¯»å–ç®€å•æ•´æ•°">ç¤ºä¾‹ 1. è®¾ç½®å¹¶è¯»å–ç®€å•æ•´æ•°</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; SET mykey <span class="string">&quot;&quot;</span> <span class="comment"># æ­¤æ—¶mykey çš„å€¼æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œé•¿åº¦ä¸º 0</span></span><br><span class="line"><span class="comment"># SET u4 0 7ï¼šåœ¨ key mykey åç§» 0 ä½ç½®è®¾ç½® 4 ä½æ— ç¬¦å·æ•´æ•°å€¼ä¸º 7ï¼Œå³å‰4ä½å˜æˆ 0111ï¼Œå› ä¸ºè‡³å°‘8bitï¼Œæ‰€ä»¥å®é™…å€¼æ˜¯ 01110000</span></span><br><span class="line"><span class="comment"># GET u4 0ï¼šè¯»å– key mykey åç§» 0 ä½çš„ 4 ä½æ— ç¬¦å·æ•´æ•°ï¼Œæ­¤æ—¶ mykey è™½ç„¶æ˜¯ 01110000ï¼Œä½†è¿™é‡ŒæŒ‡å®šåªè¯»å‰4ä½ï¼Œå³ 0111ï¼Œæ‰€ä»¥è½¬æ¢ä¸ºäºŒè¿›åˆ¶å°±æ˜¯ 7</span></span><br><span class="line">&gt; BITFIELD mykey SET u4 0 7 GET u4 0</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 0 <span class="comment"># setå‘½ä»¤çš„è¿”å›å€¼ï¼Œè¿™é‡Œè¿”å›setå‰çš„å€¼</span></span><br><span class="line">2) (<span class="built_in">integer</span>) 7 <span class="comment"># getå‘½ä»¤çš„è¿”å›å€¼</span></span><br><span class="line"><span class="comment"># è®¾ç½®æœ‰ç¬¦å·æ•´æ•°</span></span><br><span class="line">&gt; BITFIELD mykey SET i4 0 -2 GET i4 0</span><br><span class="line">1) (<span class="built_in">integer</span>) 7 <span class="comment"># è¿”å›setå‰çš„å€¼ï¼Œä¹‹å‰æ˜¯7ï¼Œå³ 0111ï¼Œsetåå˜ä¸º -2ï¼Œå³ 1110</span></span><br><span class="line">2) (<span class="built_in">integer</span>) -2 <span class="comment"># getå‘½ä»¤çš„è¿”å›å€¼</span></span><br></pre></td></tr></table></figure><div class="tips"><p><em><strong>è´Ÿæ•°çš„äºŒè¿›åˆ¶è¡¨ç¤º</strong></em></p><ul class="lvl-1"><li class="lvl-2">ä»¥ -2 ä¸ºä¾‹ï¼Œå…ˆå†™å‡º +2 çš„äºŒè¿›åˆ¶ï¼Œä»¥8ä½ä¸ºä¾‹ï¼Œå°±æ˜¯ <code>00000010</code>ï¼Œ4ä½å°±æ˜¯ <code>0010</code></li><li class="lvl-2">æŒ‰ä½å–åï¼ˆå¾—åˆ°åç ï¼‰ï¼Œä¾‹å¦‚ <code>00000010</code>ï¼ŒæŒ‰ä½å–åå°±æ˜¯ <code>11111101</code></li><li class="lvl-2">åŠ  1ï¼ˆå¾—åˆ°è¡¥ç ï¼‰ï¼Œ<code>11111101</code> + 1ï¼Œå¾—åˆ° <code>11111110</code>ï¼Œè¿™å°±æ˜¯ -2 çš„äºŒè¿›åˆ¶è¡¨ç¤º</li><li class="lvl-2">å¦‚æœæ˜¯4ä½ï¼Œåˆ™ -2 å°±æ˜¯ <code>1110</code></li></ul></div><h3 id="ç¤ºä¾‹-2-è‡ªå¢è®¡æ•°å™¨">ç¤ºä¾‹ 2. è‡ªå¢è®¡æ•°å™¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¦‚æœ counter ä¹‹å‰ä¸ºç©ºï¼Œåˆ™è§†ä¸º 0</span></span><br><span class="line"><span class="comment"># INCRBY u8 8 5ï¼šåœ¨ key counter çš„ç¬¬ 8 ä½ï¼ˆä¸‹ä¸€ä¸ªå­—èŠ‚å¼€å¤´å¤„ï¼‰ä¸ŠæŒ‰ 8 ä½ unsigned ç±»å‹è‡ªå¢ 5</span></span><br><span class="line"><span class="comment"># GET u8 8ï¼šè¯»å– key counter çš„ç¬¬ 8 ä½ï¼ˆä¸‹ä¸€ä¸ªå­—èŠ‚å¼€å¤´å¤„ï¼‰çš„ 8 ä½æ— ç¬¦å·æ•´æ•°ï¼Œè¿”å›è¿™ä¸ªæ•´æ•°çš„æ–°å€¼</span></span><br><span class="line">BITFIELD counter INCRBY u8 8 5 GET u8 8</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 5 <span class="comment"># INCRBY çš„è¿”å›å€¼ï¼Œè¿™é‡Œè¿”å›çš„æ˜¯å¢åŠ çš„å€¼ï¼Œè€Œä¸æ˜¯è®¡ç®—åçš„å€¼</span></span><br><span class="line">2) (<span class="built_in">integer</span>) 5</span><br></pre></td></tr></table></figure><h3 id="ç¤ºä¾‹-3-å¸¦æº¢å‡ºæ§åˆ¶çš„æ“ä½œ">ç¤ºä¾‹ 3. å¸¦æº¢å‡ºæ§åˆ¶çš„æ“ä½œ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># OVERFLOW SAT: è®¾ç½®æº¢å‡ºç­–ç•¥ä¸º SATï¼ˆé¥±å’Œï¼‰</span></span><br><span class="line"><span class="comment"># INCRBY u4 0 20: å¯¹ 4 ä½æ— ç¬¦å·æ•´æ•°ï¼ˆæœ€å¤§ 15ï¼‰åŠ  20ï¼Œæ­¤æ—¶è‚¯å®šä¼šæº¢å‡ºï¼Œç”±äºè¿‡ 15 ä¸Šé™ï¼Œç»“æœè¿”å› 15ï¼ˆé¥±å’Œï¼‰</span></span><br><span class="line"><span class="comment"># GET u4 0ï¼šè¯»å– 4 ä½æ— ç¬¦å·æ•´æ•°ï¼Œå³15</span></span><br><span class="line">BITFIELD limits OVERFLOW SAT INCRBY u4 0 20 GET u4 0</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 15</span><br><span class="line">2) (<span class="built_in">integer</span>) 15</span><br></pre></td></tr></table></figure><h3 id="ç¤ºä¾‹-4-æ‰¹é‡å¤šä¸ªæ“ä½œ">ç¤ºä¾‹ 4. æ‰¹é‡å¤šä¸ªæ“ä½œ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># GET u4 0 GET u4 4: ä¾æ¬¡è¯»å–å¤šä¸ªä¸åŒ bit åç§»é‡ä¸Šçš„å°æ•´æ•°</span></span><br><span class="line"><span class="comment"># SET u4 8 3 INCRBY i5 16 1: å†™å…¥ã€å¢é‡æ“ä½œå¯ä»¥æ··åˆå¤„ç†</span></span><br><span class="line"><span class="comment"># è¿”å›ç»“æœæ•°ç»„å¯¹åº”æ¯ä¸ªå­å‘½ä»¤é¡ºåºè¿”å›ç»“æœ</span></span><br><span class="line">BITFIELD events GET u4 0 GET u4 4 SET u4 8 3 INCRBY i5 16 1</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 0 <span class="comment"># eventsåŸå…ˆä¸ºç©ºï¼Œæ‰€ä»¥è¿™é‡Œè¿”å›0</span></span><br><span class="line">2) (<span class="built_in">integer</span>) 0 <span class="comment"># eventsåŸå…ˆä¸ºç©ºï¼Œæ‰€ä»¥è¿™é‡Œè¿”å›0</span></span><br><span class="line">3) (<span class="built_in">integer</span>) 0 <span class="comment"># eventsåŸå…ˆä¸ºç©ºï¼Œè¿™é‡Œè¿”å›åŸå…ˆçš„å€¼ï¼Œæ‰€ä»¥è¿˜æ˜¯0ï¼Œä½†æ­¤æ—¶å®é™…çš„å€¼æ˜¯ 0000000000110000</span></span><br><span class="line">4) (<span class="built_in">integer</span>) 1 <span class="comment"># è¿”å›å¢åŠ çš„å€¼ï¼Œå³ 1ï¼Œä½†æ­¤æ—¶å®é™…çš„å€¼æ˜¯ 000000000011000000001000ï¼Œå³å ç”¨äº†3ä¸ªå­—èŠ‚</span></span><br></pre></td></tr></table></figure><h2 id="SpringBoot-æ“ä½œ-BitField">SpringBoot æ“ä½œ BitField</h2><ul class="lvl-0"><li class="lvl-2"><p>SpringBoot çš„ <code>StringRedisTemplate.opsForValue()</code> ä¸­ BitField æ•°æ®ç±»å‹ çš„æ“ä½œæ–¹æ³•ä¸ Redis åŸç”Ÿå‘½ä»¤çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</p></li></ul><blockquote><p>æ³¨æ„è¿™é‡Œä¸€å®šè¦ç”¨ <code>StringRedisTemplate</code> æ¥æ“ä½œ BitField</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>ä½å­—æ®µè¯»/å†™/è‡ªå¢</p></li></ul><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>ä½å­—æ®µæ“ä½œï¼ˆè¯»/å†™/è‡ªå¢ï¼‰</td><td><code>bitField(K key, BitFieldSubCommands subCommands)</code></td><td><code>BITFIELD key ...</code></td><td>åŸå­æ‰§è¡Œå¤šä¸ªå­å‘½ä»¤</td></tr></tbody></table><ul class="lvl-0"><li class="lvl-2"><p>ç¤ºä¾‹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">BITFIELD limits</span><br><span class="line">    OVERFLOW SAT</span><br><span class="line">    SET u4 0 3</span><br><span class="line">    INCRBY u4 0 20</span><br><span class="line">    GET u4 0</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SET u4 0 3</span></span><br><span class="line">BitFieldSubCommands.<span class="type">BitFieldSet</span> <span class="variable">bitFieldSet</span> <span class="operator">=</span> BitFieldSubCommands.BitFieldSet.create(BitFieldSubCommands.BitFieldType.unsigned(<span class="number">4</span>), BitFieldSubCommands.Offset.offset(<span class="number">0</span>), <span class="number">3</span>);</span><br><span class="line"><span class="comment">// OVERFLOW SAT INCRBY u4 0 20</span></span><br><span class="line">BitFieldSubCommands.<span class="type">BitFieldIncrBy</span> <span class="variable">bitFieldIncrBy</span> <span class="operator">=</span> BitFieldSubCommands.BitFieldIncrBy.create(BitFieldSubCommands.BitFieldType.unsigned(<span class="number">4</span>), BitFieldSubCommands.Offset.offset(<span class="number">0</span>), <span class="number">20</span>, BitFieldSubCommands.BitFieldIncrBy.Overflow.SAT);</span><br><span class="line"><span class="comment">// GET u4 0</span></span><br><span class="line">BitFieldSubCommands.<span class="type">BitFieldGet</span> <span class="variable">bitFieldGet</span> <span class="operator">=</span> BitFieldSubCommands.BitFieldGet.create(BitFieldSubCommands.BitFieldType.unsigned(<span class="number">4</span>), BitFieldSubCommands.Offset.offset(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–ç»“æœï¼Œæ¯ä¸ªå­æ“ä½œè¿”å›ä¸€ä¸ªç»“æœ</span></span><br><span class="line">List&lt;Long&gt; limits = redisTemplate.opsForValue().bitField(<span class="string">&quot;limits&quot;</span>, BitFieldSubCommands.create(bitFieldSet, bitFieldIncrBy, bitFieldGet));</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡ä»‹ç» Redis Bitfield æ•°æ®ç±»å‹&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡åŸºäº&lt;code&gt;redis-7.4.7&lt;/code&gt;ï¼Œ&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Rediså®˜ç½‘ï¼š&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis å‘½ä»¤æ–‡æ¡£ï¼š&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis å‘½ä»¤åŠæ•°æ®ç±»å‹ -- Bitmap</title>
    <link href="https://blog.hanqunfeng.com/2025/12/18/redis7-datatype-07-bitmap/"/>
    <id>https://blog.hanqunfeng.com/2025/12/18/redis7-datatype-07-bitmap/</id>
    <published>2025-12-18T13:30:05.000Z</published>
    <updated>2025-12-24T02:40:40.484Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2">æœ¬æ–‡ä»‹ç» Redis Bitmap æ•°æ®ç±»å‹</li><li class="lvl-2">æœ¬æ–‡åŸºäº<code>redis-7.4.7</code>ï¼Œ<code>springboot-3.5.8</code></li><li class="lvl-2">Rediså®˜ç½‘ï¼š<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis å‘½ä»¤æ–‡æ¡£ï¼š<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li></ul><span id="more"></span><h2 id="Bitmap-æ ¸å¿ƒè¯¦è§£">Bitmap æ ¸å¿ƒè¯¦è§£</h2><ul class="lvl-0"><li class="lvl-2"><p>Redis Bitmap å¹¶éç‹¬ç«‹æ•°æ®ç±»å‹ï¼Œè€Œæ˜¯åŸºäº String ç±»å‹çš„ä½æ“ä½œæ‰©å±•</p></li><li class="lvl-2"><p>String åº•å±‚æ˜¯å­—èŠ‚æ•°ç»„ï¼ŒBitmap å°±æ˜¯å¯¹æ•°ç»„ä¸­å•ä¸ª bit åšè¯»å†™ï¼ˆbit åªæœ‰ 0/1 ä¸¤ä¸ªå€¼ï¼‰</p></li></ul><h2 id="Bitmap-å‘½ä»¤ä½¿ç”¨æ–¹å¼">Bitmap å‘½ä»¤ä½¿ç”¨æ–¹å¼</h2><ul class="lvl-0"><li class="lvl-2"><p>æ ¸å¿ƒå›´ç»•ã€Œä½è®¾ç½®ã€ä½æŸ¥è¯¢ã€ä½ç»Ÿè®¡ã€ä½è¿ç®—ã€å››ç±»å‘½ä»¤ï¼Œæ˜¯æ—¥å¸¸ä½¿ç”¨çš„åŸºç¡€</p></li></ul><h3 id="1-ä½è®¾ç½®ï¼šSETBIT-key-offset-value">1. ä½è®¾ç½®ï¼š<code>SETBIT key offset value</code></h3><ul class="lvl-0"><li class="lvl-2"><p>ç»™æŒ‡å®š key çš„ç¬¬ offset ä½è®¾ 0/1ï¼ˆoffset ä» 0 å¼€å§‹ï¼Œæ”¯æŒè¶…å¤§åç§»é‡ï¼ŒRedis ä¼šè‡ªåŠ¨æ‰©å®¹ï¼‰</p></li><li class="lvl-2"><p>offset ä»å·¦å¾€å³é€’å¢ï¼Œä»å·¦åˆ°å³ä¸º 0ã€1ã€2â€¦ï¼Œè‡³å°‘ç”³è¯· 8bit ç©ºé—´ï¼Œä¸è¶³ 8bit æ—¶ï¼Œä¼šè‡ªåŠ¨æ‰©å±•åˆ° 8bit å³ 1byte</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SETBIT bitkey 1 1 <span class="comment"># å®é™…çš„bitä¸º 01000000</span></span><br><span class="line">SETBIT bitkey 10 1 <span class="comment"># å®é™…çš„bitä¸º 0100000000100000</span></span><br><span class="line"><span class="comment"># æ“ä½œ String</span></span><br><span class="line">SET k1 v1 <span class="comment"># å®é™…çš„bitä¸º 0111011000110001</span></span><br><span class="line">SETBIT k1 1 0 <span class="comment"># å®é™…bitä¸º 0011011000110001</span></span><br><span class="line">GET k1 <span class="comment"># è¾“å‡º 61</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># bitmap å®é™…ä¸Šæ˜¯ string</span></span><br><span class="line">TYPE bitkey <span class="comment"># è¾“å‡º string</span></span><br></pre></td></tr></table></figure><h3 id="2-ä½æŸ¥è¯¢ï¼šGETBIT-key-offset">2. ä½æŸ¥è¯¢ï¼š<code>GETBIT key offset</code></h3><ul class="lvl-0"><li class="lvl-2"><p>æŸ¥è¯¢æŒ‡å®šåç§»é‡çš„ä½å€¼ï¼Œä¸å­˜åœ¨çš„ offset é»˜è®¤è¿”å› 0</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GETBIT bitkey 1</span><br><span class="line"><span class="comment"># è¾“å‡º</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br></pre></td></tr></table></figure><h3 id="3-ä½ç»Ÿè®¡ï¼šBITCOUNT-key-start-end">3. ä½ç»Ÿè®¡ï¼š<code>BITCOUNT key [start end]</code></h3><ul class="lvl-0"><li class="lvl-2"><p>ç»Ÿè®¡ key ä¸­å€¼ä¸º 1 çš„ bit æ€»æ•°ï¼Œå¯é€‰æŒ‰å­—èŠ‚èŒƒå›´ï¼ˆstart/end æ˜¯å­—èŠ‚ç´¢å¼•ï¼‰ç­›é€‰</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BITCOUNT bitkey</span><br><span class="line"><span class="comment"># ç­‰ä»·äº</span></span><br><span class="line">BITCOUNT bitkey 0 -1</span><br></pre></td></tr></table></figure><h3 id="4-ä½è¿ç®—ï¼šBITOP-op-destkey-key1-key2">4. ä½è¿ç®—ï¼š<code>BITOP op destkey key1 key2...</code></h3><ul class="lvl-0"><li class="lvl-2"><p>å¯¹å¤šä¸ª Bitmap åš ä¸ï¼ˆANDï¼‰ã€æˆ–ï¼ˆORï¼‰ã€å¼‚æˆ–ï¼ˆXORï¼‰ã€éï¼ˆNOTï¼‰è¿ç®—ï¼Œç»“æœå­˜å…¥ destkey</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†key1 ä¸ key2 åšæŒ‰ä½ä¸è¿ç®—ï¼Œç»“æœå­˜å…¥ destkey</span></span><br><span class="line">BITOP AND destkey key1 key2</span><br></pre></td></tr></table></figure><h3 id="5-ä½æŸ¥æ‰¾ï¼šBITPOS-key-value-start-end">5. ä½æŸ¥æ‰¾ï¼š<code>BITPOS key value [start end]</code></h3><ul class="lvl-0"><li class="lvl-2"><p>æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå€¼ä¸º 0/1 çš„ bit åç§»é‡ï¼Œå¿«é€Ÿå®šä½ç›®æ ‡ä½</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BITPOS bitkey 1</span><br><span class="line"><span class="comment"># ç­‰ä»·äº</span></span><br><span class="line">BITPOS bitkey 1 0 -1</span><br></pre></td></tr></table></figure><h2 id="æ ¸å¿ƒä½¿ç”¨åœºæ™¯-å®æ“ä¸¾ä¾‹ï¼ˆè´´åˆå¼€å‘å®æˆ˜ï¼‰">æ ¸å¿ƒä½¿ç”¨åœºæ™¯ + å®æ“ä¸¾ä¾‹ï¼ˆè´´åˆå¼€å‘å®æˆ˜ï¼‰</h2><ul class="lvl-0"><li class="lvl-2"><p>Bitmap çš„æ ¸å¿ƒä¼˜åŠ¿æ˜¯æè‡´çœå†…å­˜+é«˜æ•ˆç»Ÿè®¡ï¼ˆ1 ä¸ªå­—èŠ‚=8 ä¸ª bitï¼Œå­˜å‚¨ 1000 ä¸‡æ¡çŠ¶æ€ä»…éœ€çº¦ 1.2MBï¼‰ï¼Œä»¥ä¸‹æ˜¯é«˜é¢‘åœºæ™¯</p></li></ul><h3 id="åœºæ™¯1ï¼š-ç”¨æˆ·ç­¾åˆ°-æ‰“å¡ï¼ˆæœ€ç»å…¸åœºæ™¯ï¼‰">åœºæ™¯1ï¼š ç”¨æˆ·ç­¾åˆ°/æ‰“å¡ï¼ˆæœ€ç»å…¸åœºæ™¯ï¼‰</h3><p>â€¢ éœ€æ±‚ï¼šè®°å½•ç”¨æˆ·æ¯æ—¥ç­¾åˆ°çŠ¶æ€ï¼ŒæŸ¥è¯¢æŸç”¨æˆ·æŸå¤©æ˜¯å¦ç­¾åˆ°ã€ç»Ÿè®¡æŸç”¨æˆ·æœˆåº¦ç­¾åˆ°æ¬¡æ•°<br>â€¢ è®¾è®¡ï¼škey æ ¼å¼ <code>user:sign:uid:202512</code>ï¼ˆç”¨æˆ·2025å¹´12æœˆç­¾åˆ°ï¼‰ï¼Œoffset ä¸ºæ—¥æœŸï¼ˆ1å·=0ã€2å·=1â€¦31å·=30ï¼‰ï¼Œç­¾åˆ°è®¾ 1ã€æœªç­¾åˆ°é»˜è®¤ 0<br>â€¢ å®æ“å‘½ä»¤ï¼š</p><ol><li class="lvl-3"><p>12æœˆ1å·ç­¾åˆ°ï¼š<code>SETBIT user:sign:uid:202512 0 1</code></p></li><li class="lvl-3"><p>æŸ¥è¯¢12æœˆ1å·æ˜¯å¦ç­¾åˆ°ï¼š<code>GETBIT user:sign:uid:202512 0</code>ï¼ˆè¿”å›1=ç­¾åˆ°ï¼‰</p></li><li class="lvl-3"><p>ç»Ÿè®¡12æœˆæ€»ç­¾åˆ°æ¬¡æ•°ï¼š<code>BITCOUNT user:sign:uid:202512</code></p></li></ol><p>â€¢ ä¼˜åŠ¿ï¼š1ä¸ªç”¨æˆ·1ä¸ªæœˆç­¾åˆ°ä»…å  4 å­—èŠ‚ï¼ˆ31 bitï¼‰ï¼Œç™¾ä¸‡ç”¨æˆ·æœˆåº¦ç­¾åˆ°ä»…å çº¦ 3.9MBï¼Œè¿œè¶…æ•°æ®åº“å­˜å‚¨çš„æ€§ä»·æ¯”ã€‚</p><ul class="lvl-0"><li class="lvl-2"><p>åŠ£åŠ¿ï¼šè‹¥æƒ³æŸ¥è¯¢è¯¥ç”¨æˆ·æœ¬æœˆå†…éƒ½å“ªå¤©ç­¾åˆ°äº†ï¼Œå³è¦æŸ¥çœ‹bitmapå“ªäº›ä½ä¸º1ï¼Œåˆ™bitmapä¸æ”¯æŒè¿™ä¸ªå‘½ä»¤ï¼Œå¯ä»¥åœ¨ä¸šåŠ¡ç«¯å®ç°ã€‚å¦‚éœ€è¦ç²¾ç¡®æŸ¥è¯¢å’Œèšåˆç»Ÿè®¡åˆ™éœ€è¦åŒæ­¥æ•°æ®åˆ°å…³ç³»å‹æ•°æ®åº“ã€‚</p></li></ul><h3 id="åœºæ™¯2ï¼š-æ—¥æ´»-å‘¨æ´»-æœˆæ´»ï¼ˆDAU-WAU-MAUï¼‰ç»Ÿè®¡ï¼ˆé«˜å¹¶å‘åœºæ™¯é¦–é€‰ï¼‰">åœºæ™¯2ï¼š æ—¥æ´»/å‘¨æ´»/æœˆæ´»ï¼ˆDAU/WAU/MAUï¼‰ç»Ÿè®¡ï¼ˆé«˜å¹¶å‘åœºæ™¯é¦–é€‰ï¼‰</h3><p>â€¢ éœ€æ±‚ï¼šç»Ÿè®¡æ¯æ—¥è®¿é—®å¹³å°çš„ç”¨æˆ·æ•°ï¼Œå¿«é€Ÿè®¡ç®—å‘¨æ´»ï¼ˆ7å¤©å†…è‡³å°‘è®¿é—®1æ¬¡ï¼‰ã€æœˆæ´»ï¼Œå»é‡ç»Ÿè®¡<br>â€¢ è®¾è®¡ï¼šæŒ‰æ—¥æœŸå»º Bitmapï¼Œkey æ ¼å¼ <code>active:user:20251217</code>ï¼ˆå½“æ—¥æ´»è·ƒï¼‰ï¼Œoffset è®¾ä¸ºç”¨æˆ·å”¯ä¸€IDï¼ˆéœ€ç¡®ä¿IDæ˜¯è¿ç»­æˆ–å¯æ˜ å°„ä¸ºæ•°å­—ï¼Œé¿å…è¶…å¤§åç§»é‡ï¼‰ï¼Œç”¨æˆ·è®¿é—®åˆ™è®¾ 1<br>â€¢ å®æ“å‘½ä»¤ï¼š</p><ol><li class="lvl-3"><p>ç”¨æˆ·ID 10086 12æœˆ17æ—¥è®¿é—®ï¼š<code>SETBIT active:user:20251217 10086 1</code></p></li><li class="lvl-3"><p>ç»Ÿè®¡12æœˆ17æ—¥æ—¥æ´»ï¼š<code>BITCOUNT active:user:20251217</code></p></li><li class="lvl-3"><p>ç»Ÿè®¡12æœˆ15-17æ—¥3å¤©å†…æ´»è·ƒçš„ç”¨æˆ·æ•°ï¼š<code>BITOP OR active:user:20251215_17 active:user:20251215 active:user:20251216 active:user:20251217</code> â†’ å†æ‰§è¡Œ <code>BITCOUNT active:user:20251215_17</code></p></li><li class="lvl-3"><p>ç»Ÿè®¡12æœˆ15-17æ—¥æ¯å¤©éƒ½ç™»å½•çš„ç”¨æˆ·æ•°ï¼š<code>BITOP AND active:user:20251215_17 active:user:20251215 active:user:20251216 active:user:20251217</code> â†’ å†æ‰§è¡Œ <code>BITCOUNT active:user:20251215_17</code></p></li></ol><p>â€¢ ä¼˜åŠ¿ï¼šç™¾ä¸‡çº§ç”¨æˆ·æ—¥æ´»ç»Ÿè®¡ï¼Œå• Bitmap ä»…å çº¦ 125KBï¼Œä½è¿ç®—åˆå¹¶ç»Ÿè®¡é€Ÿåº¦æ¯«ç§’çº§ï¼Œè¿œå¿«äºæ•°æ®åº“ group by å»é‡ã€‚</p><ul class="lvl-0"><li class="lvl-2"><p>åŠ£åŠ¿ï¼šè‹¥æƒ³æŸ¥çœ‹æœ¬æœˆå†…å“ªäº›ç”¨æˆ·ç™»å½•è¿‡ï¼Œåˆ™éœ€è¦éå† Bitmap çš„æ‰€æœ‰ offset ä½ï¼Œæ•ˆç‡è¾ƒä½ã€‚å¦‚éœ€è¦ç²¾ç¡®æŸ¥è¯¢å’Œèšåˆç»Ÿè®¡åˆ™éœ€è¦åŒæ­¥æ•°æ®åˆ°å…³ç³»å‹æ•°æ®åº“ã€‚</p></li></ul><h3 id="åœºæ™¯3ï¼š-åŠŸèƒ½å¼€å…³-çŠ¶æ€æ ‡è®°ï¼ˆå¤šç»´åº¦è½»é‡æ ‡è®°ï¼‰">åœºæ™¯3ï¼š åŠŸèƒ½å¼€å…³/çŠ¶æ€æ ‡è®°ï¼ˆå¤šç»´åº¦è½»é‡æ ‡è®°ï¼‰</h3><p>â€¢ éœ€æ±‚ï¼šç»™ç”¨æˆ·æ ‡è®°å¤šç±»è½»é‡çŠ¶æ€ï¼ˆå¦‚æ˜¯å¦å¼€é€šä¼šå‘˜ã€æ˜¯å¦ç»‘å®šæ‰‹æœºã€æ˜¯å¦å‚ä¸æ´»åŠ¨ï¼‰ï¼Œæ— éœ€å•ç‹¬å­˜å¤šä¸ªkey<br>â€¢ è®¾è®¡ï¼š1ä¸ªkeyå¯¹åº”1ä¸ªç”¨æˆ·ï¼Œkey æ ¼å¼ <code>user:status:10086</code>ï¼Œä¸åŒ offset å¯¹åº”ä¸åŒçŠ¶æ€ï¼ˆoffset0=æ˜¯å¦ç»‘å®šæ‰‹æœºã€offset1=æ˜¯å¦ä¼šå‘˜ã€offset2=æ˜¯å¦å‚ä¸æ´»åŠ¨ï¼‰ï¼Œ1=æ˜¯ã€0=å¦<br>â€¢ å®æ“å‘½ä»¤ï¼š</p><ol><li class="lvl-3"><p>ç»™ç”¨æˆ·10086ç»‘å®šæ‰‹æœºï¼š<code>SETBIT user:status:10086 0 1</code></p></li><li class="lvl-3"><p>å¼€é€šä¼šå‘˜ï¼š<code>SETBIT user:status:10086 1 1</code></p></li><li class="lvl-3"><p>æŸ¥è¯¢æ˜¯å¦æ˜¯ä¼šå‘˜ï¼š<code>GETBIT user:status:10086 1</code></p></li></ol><p>â€¢ ä¼˜åŠ¿ï¼š1ä¸ªkeyæ‰¿è½½ç”¨æˆ·Nä¸ªçŠ¶æ€ï¼Œæ— éœ€ç»´æŠ¤å¤šä¸ª String/Hashï¼ŒæŸ¥è¯¢å’Œä¿®æ”¹å‡ä¸ºO(1)ï¼Œæç®€é«˜æ•ˆã€‚</p><ul class="lvl-0"><li class="lvl-2"><p>åŠ£åŠ¿ï¼šè‹¥æƒ³æŸ¥çœ‹ç”¨æˆ·æ‰€æœ‰çŠ¶æ€ï¼Œåˆ™éœ€è¦éå†æ‰€æœ‰ offset çš„ä½ï¼Œæ•ˆç‡è¾ƒä½ï¼Œå¦å¤–ç»Ÿè®¡å“ªäº›ç”¨æˆ·å¼€å¯äº†æŸä¸ªçŠ¶æ€ä¹Ÿæ¯”è¾ƒéº»çƒ¦ã€‚å¦‚éœ€è¦ç²¾ç¡®æŸ¥è¯¢å’Œèšåˆç»Ÿè®¡åˆ™éœ€è¦åŒæ­¥æ•°æ®åˆ°å…³ç³»å‹æ•°æ®åº“ã€‚</p></li></ul><h3 id="åœºæ™¯4ï¼š-å¸ƒéš†è¿‡æ»¤å™¨åº•å±‚å®ç°ï¼ˆæ ¸å¿ƒä¾èµ–Bitmapï¼‰">åœºæ™¯4ï¼š å¸ƒéš†è¿‡æ»¤å™¨åº•å±‚å®ç°ï¼ˆæ ¸å¿ƒä¾èµ–Bitmapï¼‰</h3><p>â€¢ éœ€æ±‚ï¼šå®ç°æµ·é‡æ•°æ®çš„å¿«é€Ÿå»é‡åˆ¤æ–­ï¼ˆå¦‚ç¼“å­˜ç©¿é€é˜²æŠ¤ã€æµ·é‡URLå»é‡ï¼‰ï¼Œå…è®¸æå°è¯¯åˆ¤ç‡ï¼Œä¸å…è®¸æ¼åˆ¤<br>â€¢ è®¾è®¡ï¼šç”¨1ä¸ªå¤§ Bitmap ä½œä¸ºåº•å±‚å­˜å‚¨ï¼Œé…åˆå¤šä¸ªå“ˆå¸Œå‡½æ•° â€”â€” æ•°æ®å­˜å…¥æ—¶ï¼Œé€šè¿‡å¤šä¸ªå“ˆå¸Œå‡½æ•°ç®—å‡ºå¤šä¸ª offsetï¼Œå°†å¯¹åº” bit è®¾ä¸º1ï¼›æŸ¥è¯¢æ—¶ï¼Œè‹¥æ‰€æœ‰å“ˆå¸Œå¯¹åº”çš„ offset éƒ½æ˜¯1ï¼Œåˆ™å¤§æ¦‚ç‡å­˜åœ¨ï¼Œå¦åˆ™ä¸€å®šä¸å­˜åœ¨<br>â€¢ å®æ“ï¼šRedis 7 å¯ç›´æ¥ç”¨ Bitmap æ‰‹åŠ¨å®ç°ï¼Œä¹Ÿå¯ç»“åˆ RedisBloom æ‰©å±•ï¼ˆæ›´æ˜“ç”¨ï¼‰ï¼Œæ ¸å¿ƒåŸç†æ˜¯ Bitmap çš„ä½è®¾ç½®ä¸æŸ¥è¯¢ã€‚<br>â€¢ ä¼˜åŠ¿ï¼šå­˜å‚¨1äº¿æ¡æ•°æ®ï¼Œè¯¯åˆ¤ç‡5%çš„å¸ƒéš†è¿‡æ»¤å™¨ï¼Œä»…éœ€çº¦ 12MB å†…å­˜ï¼ŒæŸ¥è¯¢é€Ÿåº¦æè‡´å¿«ã€‚</p><ul class="lvl-0"><li class="lvl-2"><p>åŠ£åŠ¿ï¼šå¸ƒéš†è¿‡æ»¤å™¨è™½ç„¶æœ‰æå°è¯¯åˆ¤ç‡ï¼Œä½†ä¸å…è®¸åˆ é™¤ã€‚</p></li></ul><h2 id="æ³¨æ„äº‹é¡¹ï¼ˆé¿å‘å…³é”®ï¼‰">æ³¨æ„äº‹é¡¹ï¼ˆé¿å‘å…³é”®ï¼‰</h2><ol><li class="lvl-3"><p>offset ä¸è¦æ— é™åˆ¶è¿‡å¤§ï¼šè™½ Redis æ”¯æŒè¶…å¤§ offsetï¼Œä½†è¿‡å¤§ï¼ˆå¦‚è¶…è¿‡10äº¿ï¼‰ä¼šå¯¼è‡´ Bitmap å ç”¨å†…å­˜éª¤å¢ï¼Œéœ€åˆç†è§„åˆ’ offset èŒƒå›´ï¼ˆå¦‚ç”¨æˆ·IDåšå“ˆå¸Œæ˜ å°„å‹ç¼©ï¼‰</p></li><li class="lvl-3"><p>é¿å…å• key è¿‡å¤§ï¼šå•ä¸ª Bitmap å»ºè®®æ§åˆ¶åœ¨1GBå†…ï¼ˆå¯¹åº”çº¦85äº¿ bitï¼‰ï¼Œè¿‡å¤§æ˜“å¯¼è‡´RedisæŒä¹…åŒ–/è¿ç§»è€—æ—¶è¿‡é•¿</p></li><li class="lvl-3"><p>æ³¨æ„ç¼–ç å…¼å®¹ï¼šBitmap åŸºäº Stringï¼ŒRedis ä¼šè‡ªåŠ¨ç”¨ RAW ç¼–ç å­˜å‚¨ï¼Œæ— éœ€æ‰‹åŠ¨è®¾ç½®</p></li></ol><h2 id="Bitmap-å‘½ä»¤">Bitmap å‘½ä»¤</h2><ul class="lvl-0"><li class="lvl-2"><p>SpringBoot çš„ <code>StringRedisTemplate.opsForValue()</code> ä¸­ Bitmap æ•°æ®ç±»å‹ çš„æ“ä½œæ–¹æ³•ä¸ Redis åŸç”Ÿå‘½ä»¤çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</p></li></ul><blockquote><p>æ³¨æ„è¿™é‡Œä¸€å®šè¦ç”¨ <code>StringRedisTemplate</code> æ¥æ“ä½œ Bitmap</p></blockquote><h3 id="å†™æ“ä½œï¼ˆä½ä¿®æ”¹ï¼‰">å†™æ“ä½œï¼ˆä½ä¿®æ”¹ï¼‰</h3><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>è®¾ç½®æŒ‡å®šåç§»é‡çš„ä½</td><td><code>setBit(K key, long offset, boolean value)</code></td><td><code>SETBIT key offset value</code></td><td>è¿”å›æ—§å€¼ï¼ˆ0 / 1ï¼‰ï¼Œoffset ä» 0 å¼€å§‹</td></tr></tbody></table><blockquote><p>offset è¡¨ç¤º ç¬¬å‡ ä½ï¼ˆbitï¼‰ï¼Œä¸æ˜¯å­—èŠ‚</p></blockquote><h3 id="è¯»æ“ä½œï¼ˆä½æŸ¥è¯¢ï¼‰">è¯»æ“ä½œï¼ˆä½æŸ¥è¯¢ï¼‰</h3><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>è·å–æŒ‡å®šåç§»é‡çš„ä½</td><td><code>getBit(K key, long offset)</code></td><td><code>GETBIT key offset</code></td><td>è¿”å› 0 / 1ï¼Œä¸ä¼šä¿®æ”¹æ•°æ®</td></tr></tbody></table><h3 id="Bitmap-å¸¸ç”¨ä½†-Spring-æœªç›´æ¥å°è£…çš„å‘½ä»¤">Bitmap å¸¸ç”¨ä½† Spring æœªç›´æ¥å°è£…çš„å‘½ä»¤</h3><ul class="lvl-0"><li class="lvl-2"><p>Spring Data Redis ä¸­é€šå¸¸é€šè¿‡ RedisCallback æˆ– execute è°ƒç”¨è¿™äº›å‘½ä»¤ã€‚</p></li></ul><table><thead><tr><th>Redis å‘½ä»¤</th><th>åŠŸèƒ½</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>BITCOUNT key [start end]</code></td><td>ç»Ÿè®¡ bit=1 çš„æ•°é‡</td><td>å¸¸ç”¨äºæ´»è·ƒç”¨æˆ·ç»Ÿè®¡</td></tr><tr><td><code>BITPOS key bit [start end]</code></td><td>æŸ¥æ‰¾ç¬¬ä¸€ä¸ª 0/1 çš„ä½ç½®</td><td>å¸¸ç”¨äºåˆ†é…ä½</td></tr><tr><td><code>BITOP AND/OR/XOR/NOT</code></td><td>ä½è¿ç®—</td><td>å¤š bitmap è®¡ç®—</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.bitmap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.CommonUtil;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Range;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisStringCommands;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisCallback;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BitmapUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">protected</span> StringRedisTemplate redisTemplate;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * BITCOUNT key [start end]</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * ç»Ÿè®¡ bit=1 çš„æ•°é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">bitCount</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.execute((RedisCallback&lt;Long&gt;) connection -&gt;</span><br><span class="line">                connection.stringCommands().bitCount(key.getBytes(StandardCharsets.UTF_8))</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">bitCount</span><span class="params">(String key, <span class="type">long</span> start, <span class="type">long</span> end)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.execute((RedisCallback&lt;Long&gt;) connection -&gt;</span><br><span class="line">                connection.stringCommands().bitCount(key.getBytes(), start, end)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * BITPOS key bit [start] [end]</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * bit = false â†’ æŸ¥æ‰¾ç¬¬ä¸€ä¸ª 0</span></span><br><span class="line"><span class="comment">     * bit = true â†’ æŸ¥æ‰¾ç¬¬ä¸€ä¸ª 1</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * è¿”å›å€¼æ˜¯ bit ç´¢å¼•ï¼ˆä¸æ˜¯ byteï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">bitPos</span><span class="params">(String key, <span class="type">boolean</span> bit)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.execute((RedisCallback&lt;Long&gt;) connection -&gt;</span><br><span class="line">                connection.stringCommands().bitPos(key.getBytes(), bit)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">bitPos</span><span class="params">(String key, <span class="type">boolean</span> bit, <span class="type">long</span> start, <span class="type">long</span> end)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.execute((RedisCallback&lt;Long&gt;) connection -&gt;</span><br><span class="line">                connection.stringCommands().bitPos(key.getBytes(), bit, Range.open(start, end))</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * BITOP operation destKey key [key ...]</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * operation: AND\OR\XOR\NOT</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * è¿ç®—ç»“æœä¿å­˜åœ¨ destKey ä¸­</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">bitOp</span><span class="params">(String destKey, RedisStringCommands.BitOperation operation, String... sourceKeys)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.execute((RedisCallback&lt;Long&gt;) connection -&gt; &#123;</span><br><span class="line">            <span class="type">byte</span>[][] keys = Arrays.stream(sourceKeys)</span><br><span class="line">                    .map(String::getBytes)</span><br><span class="line">                    .toArray(<span class="type">byte</span>[][]::<span class="keyword">new</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> connection.stringCommands().bitOp(</span><br><span class="line">                    operation,</span><br><span class="line">                    destKey.getBytes(),</span><br><span class="line">                    keys</span><br><span class="line">            );</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡ä»‹ç» Redis Bitmap æ•°æ®ç±»å‹&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡åŸºäº&lt;code&gt;redis-7.4.7&lt;/code&gt;ï¼Œ&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Rediså®˜ç½‘ï¼š&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis å‘½ä»¤æ–‡æ¡£ï¼š&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€ä¸ªåŸºäº Redis çš„å¯é‡å…¥åˆ†å¸ƒå¼é”çš„å®ç°</title>
    <link href="https://blog.hanqunfeng.com/2025/12/17/redis7-ReentrantLock/"/>
    <id>https://blog.hanqunfeng.com/2025/12/17/redis7-ReentrantLock/</id>
    <published>2025-12-17T13:30:05.000Z</published>
    <updated>2025-12-26T02:20:52.706Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2">æœ¬æ–‡ä»‹ç» ä¸€ä¸ªåŸºäº Redis çš„å¯é‡å…¥åˆ†å¸ƒå¼é”çš„å®ç°æ–¹æ¡ˆ</li><li class="lvl-2">æœ¬æ–‡åŸºäº<code>redis-7.4.7</code>ï¼Œ<code>springboot-3.5.8</code></li><li class="lvl-2">Rediså®˜ç½‘ï¼š<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis å‘½ä»¤æ–‡æ¡£ï¼š<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li><li class="lvl-2">æœ¬æ–‡ä»…ä¸ºå­¦ä¹ åŸç†ï¼Œç”Ÿäº§ç¯å¢ƒæ¨èä½¿ç”¨ <a href="https://redisson.pro/docs/data-and-services/locks-and-synchronizers/">Redisson åˆ†å¸ƒå¼é”</a> å§ã€‚</li></ul><span id="more"></span><h2 id="è®¾è®¡ç›®æ ‡ä¸å…³é”®çº¦æŸ">è®¾è®¡ç›®æ ‡ä¸å…³é”®çº¦æŸ</h2><h3 id="è®¾è®¡ç›®æ ‡">è®¾è®¡ç›®æ ‡</h3><ul class="lvl-0"><li class="lvl-2"><p>äº’æ–¥æ€§ï¼šåŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªæŒæœ‰è€…</p></li><li class="lvl-2"><p>å¯é‡å…¥ï¼šåŒä¸€çº¿ç¨‹ / è¯·æ±‚å¯å¤šæ¬¡åŠ é”</p></li><li class="lvl-2"><p>å®‰å…¨é‡Šæ”¾ï¼šåªèƒ½é‡Šæ”¾è‡ªå·±æŒæœ‰çš„é”</p></li><li class="lvl-2"><p>è‡ªåŠ¨è¿‡æœŸï¼šé˜²æ­¢æ­»é”</p></li><li class="lvl-2"><p>ç»­æœŸèƒ½åŠ›ï¼ˆWatch Dogï¼‰ï¼šä¸šåŠ¡æ—¶é—´ä¸ç¡®å®šæ—¶ä¾ç„¶å®‰å…¨</p></li><li class="lvl-2"><p>é«˜æ€§èƒ½ï¼šå• Redis Keyï¼ŒLua ä¿è¯åŸå­æ€§</p></li></ul><h3 id="æŠ€æœ¯é€‰å‹">æŠ€æœ¯é€‰å‹</h3><ul class="lvl-0"><li class="lvl-2"><p>Spring Boot</p></li><li class="lvl-2"><p>Spring Data Redisï¼ˆLettuceï¼‰</p></li><li class="lvl-2"><p>Redis Lua Script</p></li></ul><blockquote><p>Redis æ˜¯å”¯ä¸€ä¾èµ–ç»„ä»¶ï¼šRedis<br>Spring Boot ä½œä¸ºè¿è¡Œæ¡†æ¶ï¼šSpring Boot</p></blockquote><h3 id="é”çš„æ ¸å¿ƒæ•°æ®ç»“æ„è®¾è®¡ï¼ˆå…³é”®ï¼‰">é”çš„æ ¸å¿ƒæ•°æ®ç»“æ„è®¾è®¡ï¼ˆå…³é”®ï¼‰</h3><ul class="lvl-0"><li class="lvl-2"><p>Redis Key ç»“æ„(String)</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># lock:å‰ç¼€</span></span><br><span class="line">lock:order:123</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>Value ç»“æ„ï¼ˆHashï¼‰</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;uuid:threadId&quot;</span> : é‡å…¥æ¬¡æ•°</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>åŒä¸€çº¿ç¨‹é‡å…¥ â†’ count +1ï¼Œä¸åŒçº¿ç¨‹ â†’ æ‹’ç»</p></blockquote><ul class="lvl-0"><li class="lvl-2"><p>ä½¿ç”¨<code>StringRedisTemplate</code>ï¼Œå› å…¶åºåˆ—åŒ–å™¨æ˜¯<code>StringRedisSerializer</code>ï¼Œå¯ä»¥ä¿è¯ Lua è„šæœ¬èƒ½å¤Ÿæ­£å¸¸æ‰§è¡Œã€‚</p></li></ul><blockquote><p>åŸºäº Redis + Lua + HINCRBY çš„å¯é‡å…¥åˆ†å¸ƒå¼é”ï¼ŒHashValue åºåˆ—åŒ–å™¨ å¿…é¡»æ˜¯ StringRedisSerializer</p></blockquote><h3 id="Lua-è„šæœ¬ï¼ˆåŸå­æ€§ä¿éšœï¼‰">Lua è„šæœ¬ï¼ˆåŸå­æ€§ä¿éšœï¼‰</h3><ul class="lvl-0"><li class="lvl-2"><p>åŠ é”è„šæœ¬ï¼ˆæ”¯æŒå¯é‡å…¥ï¼‰</p></li></ul><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- KEYS[1] é”key</span></span><br><span class="line"><span class="comment">-- ARGV[1] ownerId (uuid:threadId)</span></span><br><span class="line"><span class="comment">-- ARGV[2] expireMillis</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;exists&#x27;</span>, KEYS[<span class="number">1</span>]) == <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    redis.call(<span class="string">&#x27;hset&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>], <span class="number">1</span>)</span><br><span class="line">    redis.call(<span class="string">&#x27;pexpire&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">2</span>])</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;hexists&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>]) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    redis.call(<span class="string">&#x27;hincrby&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>], <span class="number">1</span>)</span><br><span class="line">    redis.call(<span class="string">&#x27;pexpire&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">2</span>])</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>è§£é”è„šæœ¬ï¼ˆé˜²è¯¯åˆ ï¼‰</p></li></ul><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- KEYS[1] é”key</span></span><br><span class="line"><span class="comment">-- ARGV[1] ownerId</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (redis.call(<span class="string">&#x27;hexists&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>]) == <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> count = redis.call(<span class="string">&#x27;hincrby&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>], <span class="number">-1</span>)</span><br><span class="line"><span class="keyword">if</span> (count &gt; <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    redis.call(<span class="string">&#x27;hdel&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">if</span> (redis.call(<span class="string">&#x27;hlen&#x27;</span>, KEYS[<span class="number">1</span>]) == <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">        redis.call(<span class="string">&#x27;del&#x27;</span>, KEYS[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h2 id="Java-å®ç°ï¼ˆæ ¸å¿ƒä»£ç ï¼‰">Java å®ç°ï¼ˆæ ¸å¿ƒä»£ç ï¼‰</h2><ul class="lvl-0"><li class="lvl-2"><p>WatchDogï¼Œå®ç°é”è‡ªåŠ¨ç»­æœŸ</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.lock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisLockWatchDog</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * WatchDogçš„Luaè„šæœ¬</span></span><br><span class="line"><span class="comment">     * KEYS[1] é”key</span></span><br><span class="line"><span class="comment">     * ARGV[1] ownerId (uuid:threadId)</span></span><br><span class="line"><span class="comment">     * ARGV[2] expireMillis è¿‡æœŸæ—¶é—´</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment">     * æ‹¥æœ‰è€…æ˜¯å½“å‰çº¿ç¨‹å°±ç»­æœŸ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">WATCHDOG_SCRIPT</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            if (redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[1]) == 1) then</span></span><br><span class="line"><span class="string">                redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[2])</span></span><br><span class="line"><span class="string">                return 1</span></span><br><span class="line"><span class="string">            end</span></span><br><span class="line"><span class="string">            return 0</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å•çº¿ç¨‹è¶³å¤Ÿï¼ˆRedisson ä¹Ÿæ˜¯ï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ScheduledExecutorService</span> <span class="variable">scheduler</span> <span class="operator">=</span></span><br><span class="line">            Executors.newSingleThreadScheduledExecutor(r -&gt; &#123;</span><br><span class="line">                <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r);</span><br><span class="line">                t.setName(<span class="string">&quot;redis-lock-watch-dog&quot;</span>);</span><br><span class="line">                t.setDaemon(<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¯ä¸ª lockKey å¯¹åº”ä¸€ä¸ªç»­æœŸä»»åŠ¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ScheduledFuture&lt;?&gt;&gt; renewTasks = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisLockWatchDog</span><span class="params">(StringRedisTemplate redisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¯åŠ¨ç»­æœŸ</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lockKey     Redis é” key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ownerId     uuid:threadId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> leaseMillis é”è¿‡æœŸæ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startRenew</span><span class="params">(String lockKey, String ownerId, <span class="type">long</span> leaseMillis)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é˜²æ­¢é‡å¤å¯åŠ¨</span></span><br><span class="line">        <span class="keyword">if</span> (renewTasks.containsKey(lockKey)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é—´éš”å¤šä¹…ç»­æœŸä¸€æ¬¡</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">period</span> <span class="operator">=</span> leaseMillis / <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">        ScheduledFuture&lt;?&gt; future = scheduler.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                renew(lockKey, ownerId, leaseMillis);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// ç”Ÿäº§ç¯å¢ƒå»ºè®®æ¥æ—¥å¿—</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, period, period, TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">        renewTasks.put(lockKey, future);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å–æ¶ˆç»­æœŸ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stopRenew</span><span class="params">(String lockKey)</span> &#123;</span><br><span class="line">        ScheduledFuture&lt;?&gt; future = renewTasks.remove(lockKey);</span><br><span class="line">        <span class="keyword">if</span> (future != <span class="literal">null</span>) &#123;</span><br><span class="line">            future.cancel(<span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å®é™…ç»­æœŸé€»è¾‘</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">renew</span><span class="params">(String lockKey, String ownerId, <span class="type">long</span> leaseMillis)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">result</span> <span class="operator">=</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(WATCHDOG_SCRIPT, Boolean.class),</span><br><span class="line">                Collections.singletonList(lockKey),</span><br><span class="line">                ownerId,</span><br><span class="line">                String.valueOf(leaseMillis)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">            <span class="comment">// é”å·²ä¸å±äºå½“å‰çº¿ç¨‹ï¼Œåœæ­¢ Watch Dog</span></span><br><span class="line">            stopRenew(lockKey);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åº”ç”¨å…³é—­æ—¶é‡Šæ”¾èµ„æºï¼ˆå¯é€‰ï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> &#123;</span><br><span class="line">        scheduler.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>é”æ¥å£</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.lock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DistributedLock</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°è¯•è·å–é”</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key       é”çš„key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> waitTime  å°è¯•è·å–é”çš„æœ€å¤§ç­‰å¾…æ—¶é—´</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> leaseTime é”çš„è¿‡æœŸæ—¶é—´</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unit      æ—¶é—´å•ä½</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> trueè¡¨ç¤ºè·å–é”æˆåŠŸï¼Œfalseè¡¨ç¤ºè·å–é”å¤±è´¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String key, <span class="type">long</span> waitTime, <span class="type">long</span> leaseTime, TimeUnit unit)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°è¯•è·å–é”</span></span><br><span class="line"><span class="comment">     * ä¸ç­‰å¾…ç«‹å³è¿”å›</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key       é”çš„key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> leaseTime é”çš„è¿‡æœŸæ—¶é—´</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unit      æ—¶é—´å•ä½</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> trueè¡¨ç¤ºè·å–é”æˆåŠŸï¼Œfalseè¡¨ç¤ºè·å–é”å¤±è´¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String key, <span class="type">long</span> leaseTime, TimeUnit unit)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–é”</span></span><br><span class="line"><span class="comment">     * åªè¦è·å–åˆ°é”å°±è¿”å›ï¼Œå¦åˆ™ä¸€ç›´è‡ªæ—‹è·å–é”</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key é”çš„key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> leaseTime é”çš„è¿‡æœŸæ—¶é—´</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unit æ—¶é—´å•ä½</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> trueè¡¨ç¤ºè·å–é”æˆåŠŸï¼Œfalseè¡¨ç¤ºè·å–é”å¤±è´¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">lock</span><span class="params">(String key, <span class="type">long</span> leaseTime, TimeUnit unit)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é‡Šæ”¾é”</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key é”çš„key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(String key)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>é”å®ç°ç±»</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.lock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.LockSupport;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisReentrantLock</span> <span class="keyword">implements</span> <span class="title class_">DistributedLock</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é”çš„keyå‰ç¼€</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LOCK_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;lock:&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é”çš„Luaè„šæœ¬</span></span><br><span class="line"><span class="comment">     * KEYS[1] é”key</span></span><br><span class="line"><span class="comment">     * ARGV[1] ownerId (uuid:threadId)</span></span><br><span class="line"><span class="comment">     * ARGV[2] expireMillis è¿‡æœŸæ—¶é—´</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment">     * 1.key ä¸å­˜åœ¨æ—¶åˆ›å»ºé”</span></span><br><span class="line"><span class="comment">     * 2.key å­˜åœ¨æ—¶åˆ¤æ–­é”çš„æ‹¥æœ‰è€…æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LOCK_SCRIPT</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            if (redis.call(&#x27;exists&#x27;, KEYS[1]) == 0) then</span></span><br><span class="line"><span class="string">                redis.call(&#x27;hset&#x27;, KEYS[1], ARGV[1], 1)</span></span><br><span class="line"><span class="string">                redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[2])</span></span><br><span class="line"><span class="string">                return 1</span></span><br><span class="line"><span class="string">            end</span></span><br><span class="line"><span class="string">            if (redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[1]) == 1) then</span></span><br><span class="line"><span class="string">                redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[1], 1)</span></span><br><span class="line"><span class="string">                redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[2])</span></span><br><span class="line"><span class="string">                return 1</span></span><br><span class="line"><span class="string">            end</span></span><br><span class="line"><span class="string">            return 0</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é‡Šæ”¾é”çš„Luaè„šæœ¬</span></span><br><span class="line"><span class="comment">     * KEYS[1] é”key</span></span><br><span class="line"><span class="comment">     * ARGV[1] ownerId (uuid:threadId)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">UNLOCK_SCRIPT</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            if (redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[1]) == 0) then</span></span><br><span class="line"><span class="string">                return 0</span></span><br><span class="line"><span class="string">            end</span></span><br><span class="line"><span class="string">            local count = redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[1], -1)</span></span><br><span class="line"><span class="string">            if (count &gt; 0) then</span></span><br><span class="line"><span class="string">                return 1</span></span><br><span class="line"><span class="string">            else</span></span><br><span class="line"><span class="string">                redis.call(&#x27;hdel&#x27;, KEYS[1], ARGV[1])</span></span><br><span class="line"><span class="string">                if (redis.call(&#x27;hlen&#x27;, KEYS[1]) == 0) then</span></span><br><span class="line"><span class="string">                    redis.call(&#x27;del&#x27;, KEYS[1])</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string">                return 1</span></span><br><span class="line"><span class="string">            end</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate redisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisLockWatchDog watchDog;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisReentrantLock</span><span class="params">(StringRedisTemplate redisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">        watchDog = <span class="keyword">new</span> <span class="title class_">RedisLockWatchDog</span>(redisTemplate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–å½“å‰çº¿ç¨‹çš„ ownerId</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">ownerId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> uuid + <span class="string">&quot;:&quot;</span> + Thread.currentThread().getId();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String key, <span class="type">long</span> leaseTime, TimeUnit unit)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_PREFIX + key;</span><br><span class="line">        <span class="type">long</span> <span class="variable">expireMillis</span> <span class="operator">=</span> unit.toMillis(leaseTime);</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">success</span> <span class="operator">=</span> redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(LOCK_SCRIPT, Boolean.class),</span><br><span class="line">                Collections.singletonList(lockKey),</span><br><span class="line">                ownerId(),</span><br><span class="line">                String.valueOf(expireMillis)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (Boolean.TRUE.equals(success)) &#123;<span class="comment">//é˜²æ­¢NullPointerException</span></span><br><span class="line">            <span class="comment">// å¯åŠ¨ Watch Dogï¼ˆåªæœ‰åœ¨ leaseTime ä¸ç¡®å®šæ—¶ï¼‰</span></span><br><span class="line">            watchDog.startRenew(</span><br><span class="line">                    lockKey,</span><br><span class="line">                    ownerId(),</span><br><span class="line">                    expireMillis</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(String key, <span class="type">long</span> waitTime, <span class="type">long</span> leaseTime, TimeUnit unit)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">deadline</span> <span class="operator">=</span> System.currentTimeMillis() + unit.toMillis(waitTime);</span><br><span class="line">        <span class="comment">// ä½¿ç”¨å¸¦æ¡ä»¶çš„å¾ªç¯ï¼Œé¿å…é‡å¤èµ‹å€¼</span></span><br><span class="line">        <span class="keyword">while</span> (System.currentTimeMillis() &lt; deadline) &#123;</span><br><span class="line">            <span class="keyword">if</span> (tryLock(key, leaseTime, unit)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// è®©å½“å‰çº¿ç¨‹æŒ‚èµ·ï¼ˆé˜»å¡ï¼‰ï¼Œæœ€é•¿ä¸è¶…è¿‡æŒ‡å®šçš„çº³ç§’æ•°</span></span><br><span class="line">                <span class="comment">// åœ¨ç«äº‰å¤±è´¥åï¼Œè®©å‡º CPU ä¸€å°æ®µæ—¶é—´ï¼Œé¿å…å¿™ç­‰ï¼ŒåŒæ—¶æ§åˆ¶å¯¹ Redis çš„é‡è¯•é¢‘ç‡ã€‚</span></span><br><span class="line">                <span class="comment">// è¿™é‡Œ50æ¯«ç§’æ˜¯ç»éªŒå€¼ï¼Œå¯ä»¥æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´</span></span><br><span class="line">                LockSupport.parkNanos(TimeUnit.MILLISECONDS.toNanos(<span class="number">50</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lock</span><span class="params">(String key, <span class="type">long</span> leaseTime, TimeUnit unit)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ— é™å¾ªç¯ï¼Œè¯­ä¹‰æ›´æ¸…æ™°</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (tryLock(key, leaseTime, unit)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// è®©å½“å‰çº¿ç¨‹æŒ‚èµ·ï¼ˆé˜»å¡ï¼‰ï¼Œæœ€é•¿ä¸è¶…è¿‡æŒ‡å®šçš„çº³ç§’æ•°</span></span><br><span class="line">                <span class="comment">// åœ¨ç«äº‰å¤±è´¥åï¼Œè®©å‡º CPU ä¸€å°æ®µæ—¶é—´ï¼Œé¿å…å¿™ç­‰ï¼ŒåŒæ—¶æ§åˆ¶å¯¹ Redis çš„é‡è¯•é¢‘ç‡ã€‚</span></span><br><span class="line">                <span class="comment">// è¿™é‡Œ50æ¯«ç§’æ˜¯ç»éªŒå€¼ï¼Œå¯ä»¥æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´</span></span><br><span class="line">                LockSupport.parkNanos(TimeUnit.MILLISECONDS.toNanos(<span class="number">50</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> LOCK_PREFIX + key;</span><br><span class="line">        <span class="comment">// å…ˆåœç»­æœŸ</span></span><br><span class="line">        watchDog.stopRenew(lockKey);</span><br><span class="line">        <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">        redisTemplate.execute(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;(UNLOCK_SCRIPT, Long.class),</span><br><span class="line">                Collections.singletonList(lockKey),</span><br><span class="line">                ownerId()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æµ‹è¯•ç±»</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.lock.RedisReentrantLock;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LockTests</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RedisReentrantLock redisReentrantLock;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">lockKey</span> <span class="operator">=</span> <span class="string">&quot;order:123&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æµ‹è¯•è·å–é”</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">demo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (redisReentrantLock.tryLock(lockKey, <span class="number">5</span>, <span class="number">30</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">                doBusiness();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                redisReentrantLock.unlock(lockKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æµ‹è¯•å¯é‡å…¥é”</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doBusiness</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (redisReentrantLock.lock(lockKey, <span class="number">30</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;å¼€å§‹æ‰§è¡Œä¸šåŠ¡é€»è¾‘&quot;</span>);</span><br><span class="line">                    <span class="comment">// æ¨¡æ‹Ÿä¸šåŠ¡é€»è¾‘æ‰§è¡Œæ—¶é—´ï¼Œè¿™é‡Œè®¾ç½®200ç§’ï¼Œå°±æ˜¯ä¸ºäº†æµ‹è¯•é”çš„è‡ªåŠ¨ç»­æœŸåŠŸèƒ½</span></span><br><span class="line">                    TimeUnit.SECONDS.sleep(<span class="number">200</span>);</span><br><span class="line">                    System.out.println(<span class="string">&quot;ç»“æŸæ‰§è¡Œä¸šåŠ¡é€»è¾‘&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    redisReentrantLock.unlock(lockKey);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æµ‹è¯•å¤šçº¿ç¨‹åŒæ—¶è·å–é”</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">demoMultiThread</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">threadCount</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(threadCount);</span><br><span class="line">        <span class="type">AtomicInteger</span> <span class="variable">successCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; threadCount; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">threadId</span> <span class="operator">=</span> i;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// æ¯ä¸ªçº¿ç¨‹éƒ½å°è¯•è·å–åŒä¸€ä¸ªé”</span></span><br><span class="line">                    <span class="keyword">if</span> (redisReentrantLock.tryLock(lockKey, <span class="number">10</span>, <span class="number">30</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            successCount.incrementAndGet();</span><br><span class="line">                            System.out.println(<span class="string">&quot;çº¿ç¨‹ &quot;</span> + threadId + <span class="string">&quot; è·å–é”æˆåŠŸï¼Œå¼€å§‹æ‰§è¡Œä¸šåŠ¡&quot;</span>);</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// æ¨¡æ‹Ÿä¸šåŠ¡æ‰§è¡Œæ—¶é—´</span></span><br><span class="line">                            TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">                            System.out.println(<span class="string">&quot;çº¿ç¨‹ &quot;</span> + threadId + <span class="string">&quot; ä¸šåŠ¡æ‰§è¡Œå®Œæˆ&quot;</span>);</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            redisReentrantLock.unlock(lockKey);</span><br><span class="line">                            System.out.println(<span class="string">&quot;çº¿ç¨‹ &quot;</span> + threadId + <span class="string">&quot; é‡Šæ”¾é”&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;çº¿ç¨‹ &quot;</span> + threadId + <span class="string">&quot; è·å–é”å¤±è´¥&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    latch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç­‰å¾…æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œæˆ</span></span><br><span class="line">        latch.await();</span><br><span class="line">        System.out.println(<span class="string">&quot;æˆåŠŸè·å–é”çš„çº¿ç¨‹æ•°: &quot;</span> + successCount.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="SpringBoot-ä¸-Redisson-é›†æˆä¹‹é”çš„ä½¿ç”¨æ–¹æ³•">SpringBoot ä¸ Redisson é›†æˆä¹‹é”çš„ä½¿ç”¨æ–¹æ³•</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.52.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class="line">```java</span><br><span class="line"><span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;myLock&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¼ ç»Ÿé”å®šæ–¹å¼ï¼Œé˜»å¡ç­‰å¾…è·å–é”</span></span><br><span class="line"><span class="comment">// lock.lock();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æˆ–è€…ï¼Œè·å–é”å¹¶åœ¨10ç§’åè‡ªåŠ¨è§£é”</span></span><br><span class="line"><span class="comment">// lock.lock(10, TimeUnit.SECONDS);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æˆ–ç­‰ï¼Œå°è¯•åœ¨ 100 ç§’å†…è·å–é”ï¼Œè·å¾—ååœ¨ 10 ç§’åè‡ªåŠ¨è§£é”</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">res</span> <span class="operator">=</span> lock.tryLock(<span class="number">100</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line"><span class="keyword">if</span> (res) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è·å–é”æˆåŠŸ&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;å¼€å§‹æ‰§è¡Œä¸šåŠ¡é€»è¾‘&quot;</span>);</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡ä»‹ç» ä¸€ä¸ªåŸºäº Redis çš„å¯é‡å…¥åˆ†å¸ƒå¼é”çš„å®ç°æ–¹æ¡ˆ&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡åŸºäº&lt;code&gt;redis-7.4.7&lt;/code&gt;ï¼Œ&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Rediså®˜ç½‘ï¼š&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis å‘½ä»¤æ–‡æ¡£ï¼š&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡ä»…ä¸ºå­¦ä¹ åŸç†ï¼Œç”Ÿäº§ç¯å¢ƒæ¨èä½¿ç”¨ &lt;a href=&quot;https://redisson.pro/docs/data-and-services/locks-and-synchronizers/&quot;&gt;Redisson åˆ†å¸ƒå¼é”&lt;/a&gt; å§ã€‚&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis å‘½ä»¤åŠæ•°æ®ç±»å‹ -- ZSet</title>
    <link href="https://blog.hanqunfeng.com/2025/12/16/redis7-datatype-06-zset/"/>
    <id>https://blog.hanqunfeng.com/2025/12/16/redis7-datatype-06-zset/</id>
    <published>2025-12-16T13:40:05.000Z</published>
    <updated>2025-12-20T05:57:30.054Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ‘˜è¦">æ‘˜è¦</h2><ul class="lvl-0"><li class="lvl-2">æœ¬æ–‡ä»‹ç» Redis ZSet æ•°æ®ç±»å‹</li><li class="lvl-2">æœ¬æ–‡åŸºäº<code>redis-7.4.7</code>ï¼Œ<code>springboot-3.5.8</code></li><li class="lvl-2">Rediså®˜ç½‘ï¼š<a href="https://redis.io/">https://redis.io/</a></li><li class="lvl-2">Redis å‘½ä»¤æ–‡æ¡£ï¼š<a href="https://redis.io/docs/latest/commands/">https://redis.io/docs/latest/commands/</a></li></ul><span id="more"></span><h2 id="ZSet-æ ¸å¿ƒè¯¦è§£">ZSet æ ¸å¿ƒè¯¦è§£</h2><ul class="lvl-0"><li class="lvl-2"><p>Redis ZSet æ˜¯ä¸€ç§ å¸¦æƒé‡çš„æœ‰åºé›†åˆï¼Œæœ¬è´¨ç»“æ„ä¸ºï¼š</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">key -&gt; &#123; member -&gt; score &#125;</span><br><span class="line"><span class="comment"># è¯´æ˜</span></span><br><span class="line">memberï¼šå”¯ä¸€ï¼Œä¸å¯é‡å¤ï¼ˆStringï¼ŒäºŒè¿›åˆ¶å®‰å…¨ï¼‰</span><br><span class="line">scoreï¼šdouble ç±»å‹ï¼Œç”¨äºæ’åº</span><br><span class="line">é›†åˆæŒ‰ score ä»å°åˆ°å¤§ æ’åº</span><br><span class="line">score ç›¸åŒåˆ™æŒ‰ member çš„å­—å…¸åº(Lex)æ’åº</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ZSet = Setï¼ˆå»é‡ï¼‰ + æ’åºèƒ½åŠ›</p></li><li class="lvl-2"><p>ZSet çš„æ ¸å¿ƒç‰¹æ€§</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">å…ƒç´ å”¯ä¸€</span><br><span class="line">å¤©ç„¶æœ‰åº</span><br><span class="line">æ”¯æŒèŒƒå›´æŸ¥è¯¢</span><br><span class="line">æ”¯æŒæ’åï¼ˆrankï¼‰</span><br><span class="line">æ”¯æŒæŒ‰ score å¢é‡æ›´æ–°</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>Redis ZSet çš„ç†è®ºæœ€å¤§é•¿åº¦ä¸º 2^32 - 1 = 4294967295ï¼Œä½†å®é™…ä¸šåŠ¡ä¸­ï¼Œå…ƒç´ æ•°é‡ â‰¥ 10,000 å°±ç®— BigKey äº†ã€‚</p></li><li class="lvl-2"><p>Redis ZSet æ˜¯å®ç°æ’è¡Œæ¦œã€å»¶è¿Ÿé˜Ÿåˆ—å’Œæœ‰åºç»Ÿè®¡çš„é¦–é€‰æ•°æ®ç»“æ„ï¼Œåœ¨â€œé¡ºåº + å»é‡ + æŸ¥è¯¢æ•ˆç‡â€ä¹‹é—´å–å¾—äº†æä½³å¹³è¡¡ã€‚</p></li><li class="lvl-2"><p>ZSet çš„åº”ç”¨åœºæ™¯</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Zseté›†åˆæ“ä½œå®ç°æ–°é—»ç‚¹å‡»æ’è¡Œæ¦œ</span></span><br><span class="line">1ï¼‰ç‚¹å‡»æ–°é—»</span><br><span class="line">ZINCRBY hotNews:20251201 1 news1 <span class="comment"># ç‚¹å‡»ä¸€æ¬¡åˆ†æ•° +1</span></span><br><span class="line">2ï¼‰å±•ç¤ºå½“æ—¥ç‚¹å‡»æ’è¡Œå‰å</span><br><span class="line">ZREVRANGE hotNews:20251201 0 9 WITHSCORES <span class="comment"># å€’åº</span></span><br><span class="line">3ï¼‰ä¸ƒæ—¥æœç´¢æ¦œå•è®¡ç®—</span><br><span class="line">ZUNIONSTORE hotNews:20251201-20251207 7 hotNews:20251201 ...çœç•¥... hotNews:20251207 <span class="comment"># åˆå¹¶</span></span><br><span class="line">4ï¼‰å±•ç¤ºä¸ƒæ—¥æ’è¡Œå‰å</span><br><span class="line">ZREVRANGE hotNews:20251201-20251207 0 9 WITHSCORES</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç”Ÿäº§ç¯å¢ƒå»ºè®®</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ZSet é€‚åˆ æ’åº + æŸ¥è¯¢</span><br><span class="line">score è®¾è®¡è¦ç¨³å®šã€å¯æ‰©å±•</span><br><span class="line">å®šæœŸè£å‰ªï¼ˆZREMRANGEBYRANK / ZREMRANGEBYSCOREï¼‰</span><br><span class="line">å¤§ ZSet é¿å…å…¨é‡éå†</span><br><span class="line">åˆ é™¤å¤§ ZSet ä½¿ç”¨ UNLINK</span><br></pre></td></tr></table></figure><h2 id="ZSet-å‘½ä»¤">ZSet å‘½ä»¤</h2><ul class="lvl-0"><li class="lvl-2"><p>SpringBoot çš„ <code>RedisTemplate&lt;K,V&gt;.opsForZSet()</code> ä¸­ ZSet æ•°æ®ç±»å‹ çš„æ“ä½œæ–¹æ³•ä¸ Redis åŸç”Ÿå‘½ä»¤çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</p></li></ul><h3 id="åŸºç¡€å†™å…¥-åˆ é™¤-è®¡æ•°">åŸºç¡€å†™å…¥ / åˆ é™¤ / è®¡æ•°</h3><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th><th>å‘½ä»¤å¤‡æ³¨ / æ¨èæ›¿ä»£</th></tr></thead><tbody><tr><td>æ·»åŠ å…ƒç´ ï¼ˆå« scoreï¼‰</td><td><code>Boolean add(K key, V value, double score)</code></td><td><code>ZADD key score member</code></td><td>æ–°å¢è¿”å› <code>true</code></td></tr><tr><td>æ·»åŠ å…ƒç´ ï¼ˆä»…ä¸å­˜åœ¨æ—¶ï¼‰</td><td><code>Boolean addIfAbsent(K key, V value, double score)</code></td><td><code>ZADD key NX score member</code></td><td>Redis â‰¥ 3.0</td></tr><tr><td>æ‰¹é‡æ·»åŠ </td><td><code>Long add(K key, Set&lt;TypedTuple&lt;V&gt;&gt; tuples)</code></td><td><code>ZADD key score member [score member ...]</code></td><td>è¿”å›æ–°å¢æ•°é‡</td></tr><tr><td>æ‰¹é‡æ·»åŠ ï¼ˆä»…ä¸å­˜åœ¨ï¼‰</td><td><code>Long addIfAbsent(K key, Set&lt;TypedTuple&lt;V&gt;&gt; tuples)</code></td><td><code>ZADD key NX ...</code></td><td>â€”</td></tr><tr><td>åˆ é™¤æˆå‘˜</td><td><code>Long remove(K key, Object... values)</code></td><td><code>ZREM key member [member ...]</code></td><td>è¿”å›åˆ é™¤æ•°é‡</td></tr><tr><td>é€’å¢ score</td><td><code>Double incrementScore(K key, V value, double delta)</code></td><td><code>ZINCRBY key delta member</code></td><td>â€”</td></tr><tr><td>è·å–é›†åˆå¤§å°</td><td><code>Long size(K key)</code></td><td><code>ZCARD key</code></td><td>â€”</td></tr><tr><td>è·å–é›†åˆå¤§å°ï¼ˆåŒä¹‰ï¼‰</td><td><code>Long zCard(K key)</code></td><td><code>ZCARD key</code></td><td>API åˆ«å</td></tr></tbody></table><h3 id="éšæœºè®¿é—®">éšæœºè®¿é—®</h3><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th><th>å‘½ä»¤å¤‡æ³¨</th></tr></thead><tbody><tr><td>éšæœºè·å–æˆå‘˜</td><td><code>V randomMember(K key)</code></td><td><code>ZRANDMEMBER key</code></td><td>ä¸è¿”å› score</td></tr><tr><td>éšæœºè·å–ä¸é‡å¤æˆå‘˜</td><td><code>Set&lt;V&gt; distinctRandomMembers(K key, long count)</code></td><td><code>ZRANDMEMBER key count</code></td><td>count &gt; 0</td></tr><tr><td>éšæœºè·å–å¯é‡å¤æˆå‘˜</td><td><code>List&lt;V&gt; randomMembers(K key, long count)</code></td><td><code>ZRANDMEMBER key -count</code></td><td>count &lt; 0</td></tr><tr><td>éšæœºè·å–æˆå‘˜åŠ score</td><td><code>TypedTuple&lt;V&gt; randomMemberWithScore(K key)</code></td><td><code>ZRANDMEMBER key WITHSCORES</code></td><td>Redis â‰¥ 6.2</td></tr><tr><td>éšæœºè·å–ä¸é‡å¤æˆå‘˜åŠ score</td><td><code>Set&lt;TypedTuple&lt;V&gt;&gt; distinctRandomMembersWithScore(K key, long count)</code></td><td><code>ZRANDMEMBER key count WITHSCORES</code></td><td>â€”</td></tr><tr><td>éšæœºè·å–å¯é‡å¤æˆå‘˜åŠ score</td><td><code>List&lt;TypedTuple&lt;V&gt;&gt; randomMembersWithScore(K key, long count)</code></td><td><code>ZRANDMEMBER key -count WITHSCORES</code></td><td>â€”</td></tr></tbody></table><h3 id="æ’å-score-æŸ¥è¯¢">æ’å / score æŸ¥è¯¢</h3><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>è·å–æ­£åºæ’å</td><td><code>Long rank(K key, Object o)</code></td><td><code>ZRANK key member</code></td><td>ä» 0 å¼€å§‹</td></tr><tr><td>è·å–å€’åºæ’å</td><td><code>Long reverseRank(K key, Object o)</code></td><td><code>ZREVRANK key member</code></td><td>ä» 0 å¼€å§‹</td></tr><tr><td>è·å– score</td><td><code>Double score(K key, Object o)</code></td><td><code>ZSCORE key member</code></td><td>â€”</td></tr><tr><td>æ‰¹é‡è·å– score</td><td><code>List&lt;Double&gt; score(K key, Object... o)</code></td><td><code>ZMScore key member [member ...]</code></td><td>Redis â‰¥ 6.2</td></tr><tr><td>score åŒºé—´è®¡æ•°</td><td><code>Long count(K key, double min, double max)</code></td><td><code>ZCOUNT key min max</code></td><td>â€”</td></tr></tbody></table><h3 id="åŒºé—´æŸ¥è¯¢ï¼ˆrank-scoreï¼‰">åŒºé—´æŸ¥è¯¢ï¼ˆrank / scoreï¼‰</h3><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>æŒ‰ rank æŸ¥è¯¢</td><td><code>Set&lt;V&gt; range(K key, long start, long end)</code></td><td><code>ZRANGE key start end</code></td><td>æ­£åº<br>rank = å…ƒç´ åœ¨ ZSet ä¸­æŒ‰ score æ’åºåçš„ä¸‹æ ‡ä½ç½®ï¼ˆä» 0 å¼€å§‹ï¼‰</td></tr><tr><td>æŒ‰ rank æŸ¥è¯¢ï¼ˆå« scoreï¼‰</td><td><code>Set&lt;TypedTuple&lt;V&gt;&gt; rangeWithScores(K key, long start, long end)</code></td><td><code>ZRANGE key start end WITHSCORES</code></td><td>â€”</td></tr><tr><td>æŒ‰ score æŸ¥è¯¢</td><td><code>Set&lt;V&gt; rangeByScore(K key, double min, double max)</code></td><td><code>ZRANGEBYSCORE key min max</code></td><td>â€”</td></tr><tr><td>æŒ‰ score æŸ¥è¯¢ï¼ˆå« scoreï¼‰</td><td><code>Set&lt;TypedTuple&lt;V&gt;&gt; rangeByScoreWithScores(K key, double min, double max)</code></td><td><code>ZRANGEBYSCORE key min max WITHSCORES</code></td><td>â€”</td></tr><tr><td>score åˆ†é¡µ</td><td><code>Set&lt;V&gt; rangeByScore(K key, double min, double max, long offset, long count)</code></td><td><code>ZRANGEBYSCORE key min max LIMIT offset count</code></td><td>â€”</td></tr><tr><td>score åˆ†é¡µï¼ˆå« scoreï¼‰</td><td><code>Set&lt;TypedTuple&lt;V&gt;&gt; rangeByScoreWithScores(K key, double min, double max, long offset, long count)</code></td><td><code>ZRANGEBYSCORE key min max WITHSCORES LIMIT offset count</code></td><td>æŒ‰ score å‡åºåˆ†é¡µï¼Œè¿”å› member + score</td></tr><tr><td>å€’åº rank æŸ¥è¯¢</td><td><code>Set&lt;V&gt; reverseRange(K key, long start, long end)</code></td><td><code>ZREVRANGE key start end</code></td><td>æŒ‰ rank å€’åºï¼ˆé«˜ â†’ ä½ï¼‰</td></tr><tr><td>å€’åº rankï¼ˆå« scoreï¼‰</td><td><code>Set&lt;TypedTuple&lt;V&gt;&gt; reverseRangeWithScores(K key, long start, long end)</code></td><td><code>ZREVRANGE key start end WITHSCORES</code></td><td>å€’åº rankï¼Œè¿”å› score</td></tr><tr><td>å€’åº score æŸ¥è¯¢</td><td><code>Set&lt;V&gt; reverseRangeByScore(K key, double min, double max)</code></td><td><code>ZREVRANGEBYSCORE key max min</code></td><td>æ³¨æ„ï¼š<strong>max åœ¨å‰ï¼Œmin åœ¨å</strong></td></tr><tr><td>å€’åº scoreï¼ˆå« scoreï¼‰</td><td><code>Set&lt;TypedTuple&lt;V&gt;&gt; reverseRangeByScoreWithScores(K key, double min, double max)</code></td><td><code>ZREVRANGEBYSCORE key max min WITHSCORES</code></td><td>å€’åº scoreï¼Œè¿”å› score</td></tr></tbody></table><h3 id="å¼¹å‡ºå…ƒç´ ï¼ˆé˜Ÿåˆ—-TopN-åœºæ™¯ï¼‰">å¼¹å‡ºå…ƒç´ ï¼ˆé˜Ÿåˆ— / TopN åœºæ™¯ï¼‰</h3><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>å¼¹å‡ºæœ€å° score</td><td><code>TypedTuple&lt;V&gt; popMin(K key)</code></td><td><code>ZPOPMIN key</code></td><td>â€”</td></tr><tr><td>æ‰¹é‡å¼¹å‡ºæœ€å° score</td><td><code>Set&lt;TypedTuple&lt;V&gt;&gt; popMin(K key, long count)</code></td><td><code>ZPOPMIN key count</code></td><td>â€”</td></tr><tr><td>é˜»å¡å¼¹å‡ºæœ€å° score</td><td><code>TypedTuple&lt;V&gt; popMin(K key, timeout)</code></td><td><code>BZPOPMIN key timeout</code></td><td>â€”</td></tr><tr><td>å¼¹å‡ºæœ€å¤§ score</td><td><code>TypedTuple&lt;V&gt; popMax(K key)</code></td><td><code>ZPOPMAX key</code></td><td>â€”</td></tr><tr><td>æ‰¹é‡å¼¹å‡ºæœ€å¤§ score</td><td><code>Set&lt;TypedTuple&lt;V&gt;&gt; popMax(K key, long count)</code></td><td><code>ZPOPMAX key count</code></td><td>â€”</td></tr><tr><td>é˜»å¡å¼¹å‡ºæœ€å¤§ score</td><td><code>TypedTuple&lt;V&gt; popMax(K key, timeout)</code></td><td><code>BZPOPMAX key timeout</code></td><td>â€”</td></tr></tbody></table><h3 id="åŒºé—´åˆ é™¤">åŒºé—´åˆ é™¤</h3><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤ï¼ˆå®Œæ•´ï¼‰</th></tr></thead><tbody><tr><td>æŒ‰ rank åˆ é™¤</td><td><code>Long removeRange(K key, long start, long end)</code></td><td><code>ZREMRANGEBYRANK key start end</code></td></tr><tr><td>æŒ‰ score åˆ é™¤</td><td><code>Long removeRangeByScore(K key, double min, double max)</code></td><td><code>ZREMRANGEBYSCORE key min max</code></td></tr><tr><td>æŒ‰ lex åˆ é™¤</td><td><code>Long removeRangeByLex(K key, Range&lt;String&gt; range)</code></td><td><code>ZREMRANGEBYLEX key min max</code></td></tr></tbody></table><h3 id="é›†åˆè¿ç®—ï¼ˆZSet-ç‰¹æœ‰ï¼‰">é›†åˆè¿ç®—ï¼ˆZSet ç‰¹æœ‰ï¼‰</h3><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤ï¼ˆå®Œæ•´ï¼‰</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>å·®é›†</td><td><code>Set&lt;V&gt; difference(K key, Collection&lt;K&gt; otherKeys)</code></td><td><code>ZDIFF numkeys key [otherKey ...]</code></td><td>Redis â‰¥ 6.2</td></tr><tr><td>å·®é›†ï¼ˆå« scoreï¼‰</td><td><code>Set&lt;TypedTuple&lt;V&gt;&gt; differenceWithScores(K key, Collection&lt;K&gt; otherKeys)</code></td><td><code>ZDIFF numkeys key [otherKey ...] WITHSCORES</code></td><td>Redis â‰¥ 6.2</td></tr><tr><td>å·®é›†å¹¶å­˜å‚¨</td><td><code>Long differenceAndStore(K key, Collection&lt;K&gt; otherKeys, K destKey)</code></td><td><code>ZDIFFSTORE destination numkeys key [otherKey ...]</code></td><td>Redis â‰¥ 6.2</td></tr><tr><td>äº¤é›†</td><td><code>Set&lt;V&gt; intersect(K key, Collection&lt;K&gt; otherKeys)</code></td><td><code>ZINTER numkeys key [otherKey ...]</code></td><td>Redis â‰¥ 6.2</td></tr><tr><td>äº¤é›†ï¼ˆå« scoreï¼‰</td><td><code>Set&lt;TypedTuple&lt;V&gt;&gt; intersectWithScores(K key, Collection&lt;K&gt; otherKeys)</code></td><td><code>ZINTER numkeys key [otherKey ...] WITHSCORES</code></td><td>Redis â‰¥ 6.2</td></tr><tr><td>å¹¶é›†</td><td><code>Set&lt;V&gt; union(K key, Collection&lt;K&gt; otherKeys)</code></td><td><code>ZUNION numkeys key [otherKey ...]</code></td><td>Redis â‰¥ 6.2</td></tr><tr><td>å¹¶é›†ï¼ˆå« scoreï¼‰</td><td><code>Set&lt;TypedTuple&lt;V&gt;&gt; unionWithScores(K key, Collection&lt;K&gt; otherKeys)</code></td><td><code>ZUNION numkeys key [otherKey ...] WITHSCORES</code></td><td>Redis â‰¥ 6.2</td></tr><tr><td>äº¤é›†å¹¶å­˜å‚¨</td><td><code>Long intersectAndStore(K key, Collection&lt;K&gt; otherKeys, K destKey)</code></td><td><code>ZINTERSTORE destination numkeys key [key ...]</code></td><td></td></tr><tr><td>å¹¶é›†å¹¶å­˜å‚¨</td><td><code>Long unionAndStore(K key, Collection&lt;K&gt; otherKeys, K destKey)</code></td><td><code>ZUNIONSTORE destination numkeys key [key ...]</code></td><td></td></tr></tbody></table><h3 id="Lexï¼ˆå­—å…¸åºï¼Œä»…-score-ç›¸åŒï¼‰">Lexï¼ˆå­—å…¸åºï¼Œä»… score ç›¸åŒï¼‰</h3><blockquote><p>Lex = Lexicographical Orderï¼ˆå­—å…¸åºï¼‰,Lex æ’åºæ˜¯æŒ‰ member çš„å­—ç¬¦ä¸²å­—å…¸åºæ’åºï¼Œè€Œä¸æ˜¯æŒ‰ scoreã€‚<br>åªæœ‰å½“ ZSet ä¸­æ‰€æœ‰å…ƒç´ çš„ score ç›¸åŒæ—¶ï¼ŒLex æ’åºæ‰æœ‰æ„ä¹‰<br>å¦‚æœ score ä¸åŒï¼ŒRedis æ–‡æ¡£æ˜ç¡®è¯´æ˜ï¼šç»“æœä¸å¯é¢„æµ‹</p></blockquote><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤ï¼ˆå®Œæ•´ï¼‰</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>æŒ‰ lex æŸ¥è¯¢</td><td><code>Set&lt;V&gt; rangeByLex(...)</code></td><td><code>ZRANGEBYLEX key min max [LIMIT offset count]</code></td><td>score å¿…é¡»ç›¸åŒ</td></tr><tr><td>å€’åº lex æŸ¥è¯¢</td><td><code>Set&lt;V&gt; reverseRangeByLex(...)</code></td><td><code>ZREVRANGEBYLEX key max min [LIMIT offset count]</code></td><td>â€”</td></tr><tr><td>lex èŒƒå›´å­˜å‚¨</td><td><code>Long rangeAndStoreByLex(...)</code></td><td><code>ZRANGEBYLEX key min max [LIMIT offset count] â†’ ZADD destKey</code></td><td>Spring å°è£…</td></tr><tr><td>score èŒƒå›´å­˜å‚¨</td><td><code>Long rangeAndStoreByScore(...)</code></td><td><code>ZRANGEBYSCORE key min max [WITHSCORES] â†’ ZADD destKey</code></td><td>Spring å°è£…</td></tr></tbody></table><blockquote><p>Lex èŒƒå›´å†™æ³•è§„åˆ™</p></blockquote><table><thead><tr><th>å†™æ³•</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td><code>[a</code></td><td>â‰¥ aï¼ˆåŒ…å«ï¼‰</td></tr><tr><td><code>(a</code></td><td>&gt; aï¼ˆä¸åŒ…å«ï¼‰</td></tr><tr><td><code>[z</code></td><td>â‰¤ z</td></tr><tr><td><code>+</code></td><td>æ­£æ— ç©·</td></tr><tr><td><code>-</code></td><td>è´Ÿæ— ç©·</td></tr></tbody></table><blockquote><p>ç¤ºä¾‹</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># a â‰¤ member &lt; d</span></span><br><span class="line">ZRANGEBYLEX my:zset [a (d</span><br></pre></td></tr></table></figure><h3 id="éå†">éå†</h3><table><thead><tr><th>æ–¹æ³•åŠŸèƒ½</th><th>æ–¹æ³•</th><th>Redis åŸå§‹å‘½ä»¤ï¼ˆå®Œæ•´ï¼‰</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>æ¸¸æ ‡æ‰«æ</td><td><code>Cursor&lt;TypedTuple&lt;V&gt;&gt; scan(K key, ScanOptions options)</code></td><td><code>ZSCAN key cursor [MATCH pattern] [COUNT count]</code></td><td>æ¨èæ›¿ä»£å…¨é‡æŸ¥è¯¢</td></tr></tbody></table>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ‘˜è¦&quot;&gt;æ‘˜è¦&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡ä»‹ç» Redis ZSet æ•°æ®ç±»å‹&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;æœ¬æ–‡åŸºäº&lt;code&gt;redis-7.4.7&lt;/code&gt;ï¼Œ&lt;code&gt;springboot-3.5.8&lt;/code&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Rediså®˜ç½‘ï¼š&lt;a href=&quot;https://redis.io/&quot;&gt;https://redis.io/&lt;/a&gt;&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;Redis å‘½ä»¤æ–‡æ¡£ï¼š&lt;a href=&quot;https://redis.io/docs/latest/commands/&quot;&gt;https://redis.io/docs/latest/commands/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    <category term="æŠ€æœ¯" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/"/>
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/categories/%E6%8A%80%E6%9C%AF/redis/"/>
    
    
    <category term="redis" scheme="https://blog.hanqunfeng.com/tags/redis/"/>
    
  </entry>
  
</feed>
